<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>linux on Cylon&#39;s Collection</title>
    <link>https://www.oomkill.com/tags/linux/</link>
    <description>Recent content in linux on Cylon&#39;s Collection</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>zh-cn</language>
    <lastBuildDate>Sat, 29 Jun 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://www.oomkill.com/tags/linux/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Debianç½‘ç»œé…ç½®</title>
      <link>https://www.oomkill.com/2024/06/debian-network-configration/</link>
      <pubDate>Sat, 29 Jun 2024 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2024/06/debian-network-configration/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="è®¾ç½®ä¸€ä¸ªç½‘ç»œæ¥å£">è®¾ç½®ä¸€ä¸ªç½‘ç»œæ¥å£</h2>
<p>debian ä¸­ç½‘ç»œæ¥å£çš„é…ç½®æ–‡ä»¶æ˜¯åœ¨ <em><strong>/etc/network/interfaces</strong></em>ï¼Œå¯ä»¥è®¾ç½® â€œé™æ€åœ°å€â€ æˆ– â€œDHCPâ€</p>
<pre><code class="language-conf">cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
auto ens33
iface lo inet loopback

# The primary network interface
allow-hotplug ens33
iface ens33 inet static
address 10.0.0.14
netmast 255.255.255.0
gateway 10.0.0.2
root@debian-template:~# cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
# ç½‘ç»œæ¥å£è‡ªåŠ¨å¯åŠ¨
auto lo
auto ens33
# ä½¿ç”¨dhcpé…ç½®ç½‘ç»œæ¥å£
iface eth0 inet dhcp
iface lo inet loopback

# The primary network interface
allow-hotplug ens33
# ä½¿ç”¨é™æ€åœ°å€é…ç½®ç½‘ç»œæ¥å£
iface ens33 inet static
    address 10.0.0.14
    netmast 255.255.255.0
    gateway 10.0.0.2
</code></pre>
<p>Enjoy ğŸ‘ğŸ‘</p>
<h2 id="reference">Reference</h2>
<p><a href="https://wiki.debian.org/NetworkConfiguration" target="_blank"
   rel="noopener nofollow noreferrer" >NetworkConfiguration</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>å®‰è£…Debian12 (Bookworm) Step-by-Step</title>
      <link>https://www.oomkill.com/2024/06/debian12-install-tutorial-step-by-step/</link>
      <pubDate>Sat, 29 Jun 2024 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2024/06/debian12-install-tutorial-step-by-step/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="preparation">Preparation</h2>
<p>debian12 å‡ ä¹å¯ä»¥ä½¿ç”¨ä»»ä½•æ—§çš„è®¡ç®—æœºç¡¬ä»¶ï¼Œå› ä¸ºæœ€å°å®‰è£…çš„è¦æ±‚éå¸¸ä½ã€‚ä»¥ä¸‹æ˜¯æœ€ä½è¦æ±‚å’Œæ¨èè¦æ±‚ï¼š</p>
<table>
<thead>
<tr>
<th>æœ€ä½è¦æ±‚</th>
<th>æ¨èè¦æ±‚</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­˜å‚¨ï¼š10 Gigabytes<br>å†…å­˜ï¼š512 Megabytes<br>CPU: 1 GigaHertz</td>
<td>å­˜å‚¨ï¼š10 Gigabytes<br/>å†…å­˜ï¼š2 Gigabytes<br/>CPU: 1 GigaHertz or more</td>
</tr>
</tbody>
</table>
<h3 id="å¦‚ä½•é€‰æ‹©ä¸‹è½½å®‰è£…åŒ…">å¦‚ä½•é€‰æ‹©ä¸‹è½½å®‰è£…åŒ…</h3>
<ul>
<li><a href="https://www.debian.org/CD/http-ftp/#stable" target="_blank"
   rel="noopener nofollow noreferrer" >offical mirror</a></li>
<li><a href="https://developer.aliyun.com/mirror/debian" target="_blank"
   rel="noopener nofollow noreferrer" >aliyun mirror</a></li>
</ul>
<p>å®˜ç½‘æä¾›äº†å®‰è£…åŒ…çš„ä¸‹è½½ï¼Œå…¶ä¸­CDæ˜¯ç½‘ç»œå®‰è£…ï¼ŒDVDæ˜¯ç¦»çº¿å®‰è£…</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802174122790.png" alt="image-20220802174122790" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">debianå®˜æ–¹ä¸‹è½½é¡µé¢</center>
<blockquote>
<p>Notesï¼šCDå®‰è£…åŒ…å¾ˆå°ï¼Œä¸‹è½½ä¸‹æ¥æ˜¯ <code>debian-11.4.0-amd64-netinst.iso</code> å¦‚åæ‰€ç¤ºï¼Œè¿™æ˜¯ä¸€ä¸ªç½‘ç»œå®‰è£…åŒ…ï¼Œæ‰€ä»¥æ¨èä¸‹è½½DVDéƒ¨åˆ†ï¼Œå¯ä»¥è¾¾åˆ°ç¦»çº¿å®‰è£…çš„æ•ˆæœ</p>
<p>æˆªè‡³æ–‡ç« ç¼–å†™æ—¥æœŸï¼Œdebian-12.5.0-amd64-DVD-1.iso å¤§å°æ˜¯ 3.7G</p>
<p>Debian12 EOLï¼š<strong>June 30th, 2028</strong></p>
</blockquote>
<h2 id="å®‰è£…æ­¥éª¤">å®‰è£…æ­¥éª¤</h2>
<p>åœ¨ç•Œé¢ä¸­é€‰æ‹©â€œInstallâ€ï¼Œå®‰è£…å°†å¼€å§‹ã€‚å¦‚æœå›¾å½¢åŒ–å®‰è£…å¯ä»¥é€‰æ‹©â€œGraphical installâ€ï¼Œè¿™é‡Œé€‰æ‹©â€œInstallâ€ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20240629210929051.png" alt="image-20240629210929051" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æ¬¢è¿é¡µé¢</center>
<p>å®Œæˆåï¼Œç³»ç»Ÿå°†æç¤ºé€‰æ‹©å®‰è£…æ—¶çš„â€œè¯­è¨€â€ã€‚é€‰æ‹©å–œæ¬¢çš„è¯­è¨€ï¼Œç„¶åæŒ‰â€œEnterâ€ã€‚è¿™é‡Œé€‰æ‹©è‹±æ–‡</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124137343.png" alt="image-20220802124137343" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©è¯­è¨€é¡µé¢</center>
<p>è¿™å°†æ˜¯æ¥ä¸‹æ¥å®‰è£…æ­¥éª¤</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124701368.png" alt="image-20220802124701368" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®‰è£…æ­¥éª¤æ¦‚è¿°</center>
<h3 id="é€‰æ‹©ä½ç½®ä¸é”®ç›˜å¸ƒå±€">é€‰æ‹©ä½ç½®ä¸é”®ç›˜å¸ƒå±€</h3>
<p>é€‰æ‹©åœ°åŒºï¼Œè¿™é‡Œé€‰æ‹©ç¾å›½</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20240629211110796.png" alt="image-20240629211110796" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©åŒºåŸŸ</center>
<p>ä¸‹é¢éƒ¨ç½²æ—¶é€‰æ‹©é”®ç›˜å¸ƒå±€ï¼šä¸­å›½å¤§é™†ä½¿ç”¨çš„é”®ç›˜å¸ƒå±€æ˜¯ç¾å›½-è‹±è¯­ï¼Œä¸è¦é€‰æ‹©è‹±å›½-è‹±è¯­ä¹‹ç±»ï¼Œå¸ƒå±€æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¼šå­˜åœ¨æŒ‰é”®è¾“å‡ºçš„ç»“æœä¼šä¸åŒ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124219600.png" alt="image-20220802124219600" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©é”®ç›˜å¸ƒå±€</center>
<p>å®Œæˆä¸Šè¿°æ“ä½œåï¼Œå°†å¼€å§‹åŠ è½½é•œåƒã€‚ç­‰å¾…æ‰«æå®Œæˆã€‚ã€‚ã€‚ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124450675.png" alt="image-20220802124450675" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ç­‰å¾…æ‰«æç»„ä»¶</center>
<h3 id="è®¾ç½®ä¸»æœºåå’ŒåŸŸå">è®¾ç½®ä¸»æœºåå’ŒåŸŸå</h3>
<p>è¿™æ­¥éª¤ä¸­å°†é…ç½®ä¸€ä¸ªâ€œä¸»æœºåâ€ã€‚ä¸ä¸€ä¸ªâ€œåŸŸâ€åç§°ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124523526.png" alt="image-20220802124523526" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®ä¸»æœºå</center>
<p>â€œåŸŸâ€ å¯ä»¥é€‰æ‹©ç•™ç©ºç¡®å®š</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124552521.png" alt="image-20220802124552521" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®åŸŸ</center>
<p>å®Œæˆä¸Šè¿°æ“ä½œåï¼Œå®‰è£…ç¨‹åºå°†æç¤ºéœ€è¦è®¾ç½® root å¯†ç ã€‚è¾“å…¥æ‚¨çš„ root å¯†ç ï¼Œç„¶ååœ¨é‡æ–°è¾“å…¥ä»¥è¿›è¡ŒéªŒè¯åç»§ç»­ã€‚</p>
<blockquote>
<p><strong>Tips</strong>: è¿™é‡Œå»ºè®®è®¾ç½®å¯†ç ï¼Œä¸è®¾ç½®å¯†ç ä¼šå¯¼è‡´å®‰è£…å®Œæˆåæ— æ³•è¿›å…¥ root ç”¨æˆ·**ï¼Œ**è¿™æ ·å°±éœ€è¦æ ¹æ®å…ˆç™»å½•æ™®é€šç”¨æˆ·ï¼Œç„¶åé€šè¿‡ sudoåˆ‡æ¢è¿‡å»ã€‚</p>
</blockquote>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20240629211449365.png" alt="image-20240629211449365" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">è®¾ç½®Rootå¯†ç </center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124732048.png" alt="image-20220802124732048" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">è®¾ç½®Rootå¯†ç  - äºŒæ¬¡ç¡®è®¤</center>
<h3 id="è®¾ç½®érootç”¨æˆ·åè´¦æˆ·å’Œå¯†ç ">è®¾ç½®éROOTç”¨æˆ·åã€è´¦æˆ·å’Œå¯†ç </h3>
<p>ä¸‹ä¸€æ­¥åˆ›å»ºä¸€ä¸ªéROOTç”¨æˆ·ï¼Œè¿™ä¸ªæ­¥éª¤æ˜¯å¿…é¡»çš„ï¼Œå¹¶ä¸ºè¿™ä¸ªæ–°åˆ›å»ºçš„å¸æˆ·åˆ†é…ä¸€ä¸ªå¯†ç ã€‚ä»¥ä¸‹æˆªå›¾å°†æè¿°å°†å¦‚ä½•å®Œæˆæ­¤æ“ä½œã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124814435.png" alt="image-20220802124814435" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®æ™®é€šç”¨æˆ·</center>
<p>ä¸ºè¿™ä¸ªç”¨æˆ·é…ç½®å¯†ç </p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124841150.png" alt="image-20220802124841150" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ä¸ºæ™®é€šç”¨æˆ·é…ç½®å¯†ç </center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124905092.png" alt="image-20220802124905092" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ä¸ºæ™®é€šç”¨æˆ·é…ç½®å¯†ç â€”â€”äºŒæ¬¡ç¡®è®¤</center>
<h3 id="è®¾ç½®æ—¶é’Ÿæ—¶åŒº">è®¾ç½®æ—¶é’Ÿæ—¶åŒº</h3>
<p>å½“ä¸‹é¢è¿›åº¦æ¡å®Œæˆåï¼Œåˆ™ä¼šè¿›å…¥è®¾ç½®æ—¶åŒºçš„ç•Œé¢</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20240629211712907.png" alt="image-20240629211712907" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ä»äº’è”ç½‘è®¾ç½®ç½‘ç»œæ—¶é—´æœåŠ¡</center>
<p>Eastern ç¾ä¸œæ—¶é—´</p>
<p>Central åŒ—ç¾ä¸­éƒ¨</p>
<p>Mountain åŒ—ç¾å±±åŒºæ—¶åŒº</p>
<p>Pacific å¤ªå¹³æ´‹æ—¶åŒº</p>
<p>Alaska é˜¿æ‹‰æ–¯åŠ å¤ä»¤æ—¶é—´</p>
<p>Hawaii å¤å¨å¤·æ—¶åŒº</p>
<p>Arizona äºåˆ©æ¡‘æ—¶åŒº</p>
<p>East Indiana å°ç¬¬å®‰çº³æ—¶åŒº</p>
<p>Samoa è¨æ‘©äºšæ—¶é—´</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124936969.png" alt="image-20220802124936969" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®æ—¶åŒº</center>
<h3 id="å¯¹ç£ç›˜åˆ†åŒº">å¯¹ç£ç›˜åˆ†åŒº</h3>
<p>æ­¤æ­¥éª¤ç£ç›˜è¿›è¡Œåˆ†åŒºã€‚è¿™é‡Œé€‰æ‹© â€œæ‰‹åŠ¨â€ é€‰é¡¹</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125018955.png" alt="image-20220802125018955" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©åˆ†åŒºæ¨¡å¼</center>
<p>é€‰æ‹©æ‰‹åŠ¨è¿›è¡Œåˆ’åˆ†ä¸ºæ‰€éœ€çš„åˆ†åŒºã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125033249.png" alt="image-20220802125033249" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©ç¡¬ç›˜</center>
<p>åˆ›å»ºæ–°çš„åˆ†åŒºè¡¨</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125051231.png" alt="image-20220802125051231" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åˆ›å»ºåˆ†åŒºè¡¨</center>
<p>é€‰æ‹©ç©ºé—²çš„ç©ºé—´è¿›è¡Œåˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125208239.png" alt="image-20220802125208239" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©ç©ºé—²ç©ºé—´</center>
<p>åˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125220023.png" alt="image-20220802125220023" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒº</center>
<p>ä¸º/bootåˆ’åˆ†åˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802170825990.png" alt="image-20220802170825990" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ä¸º/bootåˆ†åŒºåˆ†é…ç©ºé—´</center>
<p>æŒ‚è½½ç‚¹é€‰æ‹© boot</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20240629212607957.png" alt="image-20240629212607957" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©æŒ‚è½½ç‚¹</center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802170914699.png" alt="image-20220802170914699" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æœ€ç»ˆåˆ’åˆ†çš„åˆ†åŒº</center>
<p>è¿™é‡Œé€‰Noå°±è¡Œï¼Œæç¤ºæ˜¯æŒ‡ä¸ä½¿ç”¨swapåˆ†åŒºï¼ŒNoå°±æ˜¯ç»§ç»­ï¼ŒYeså°†è¿”å›åˆ†åŒºé¡µé¢</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171300600.png" alt="image-20220802171300600" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å¯¹äºswapåˆ†åŒºçš„æç¤º</center>
<p>åˆ›å»ºæ–°åˆ†åŒºéœ€è¦æ ¼å¼åŒ–ï¼Œå½“å‰çš„åˆ†åŒºå°†ä¼šè¢«åˆ é™¤ï¼Œå¦‚æœæ˜¯æ–°ç£ç›˜é€‰æ‹©Yesæ ¼å¼åŒ–åˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171406223.png" alt="image-20220802171406223" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ç¡®è®¤æ ¼å¼åŒ–ï¼Œè¿›è¡Œåˆ†åŒº</center>
<h3 id="base-systemå®‰è£…">Base Systemå®‰è£…</h3>
<p>è¿™é‡Œç­‰å¾…å®‰è£…åŸºç¡€ç³»ç»Ÿ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171427005.png" alt="image-20220802171427005" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ç¡®è®¤æ ¼å¼åŒ–ï¼Œè¿›è¡Œåˆ†åŒº</center>
<p>å‡ åˆ†é’Ÿåï¼Œ å®‰è£…åä¼šå¼¹å‡ºä¸€ä¸ªç•Œé¢ï¼Œè¿™é‡Œä¼šæ‰«æå…¶ä»–çš„åª’ä»‹ (media)ï¼Œè¿™é‡Œå› ä¸ºæ²¡æœ‰ï¼Œé€‰æ‹©Noå°±è¡Œã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171719092.png" alt="image-20220802171719092" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æ‰«æå…¶ä»–åª’ä»‹</center>
<p>åŒ…ç®¡ç†é•œåƒé…ç½®ï¼Œè¿™é‡Œé€‰æ‹© â€œNoâ€ ä»¥åŠ å¿«å®‰è£…é€Ÿåº¦</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/cylonchau/imgbed/img/image-20240629212955366.png" alt="image-20240629212955366" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åŒ…ç®¡ç†æç¤º</center>
<h3 id="ç¦»çº¿å®‰è£…">ç¦»çº¿å®‰è£…</h3>
<p>ä¼šæ‰«æå®‰è£…çš„åª’ä»‹ï¼Œè¿™é‡Œä¹Ÿæœ‰æç¤ºï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„åª’ä»‹ï¼Œå¯ä»¥è·³è¿‡è¯¥æ­¥éª¤</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802175852901.png" alt="image-20220802175852901" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æ‰«æå…¶ä»–åª’ä»‹</center>
<p>é…ç½®ç½‘ç»œé•œåƒï¼Œå»ºè®®é…ç½®ä¸‹ï¼Œå¦‚æœä¸éœ€è¦Noå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180008399.png" alt="image-20220802180008399" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<blockquote>
<p>Tips: å¦‚æœé€‰æ‹© â€œNoâ€ , é‚£ä¹ˆå®‰è£…å®Œåï¼Œæ˜¯æ²¡æœ‰aptåŒ…ç®¡ç†çš„ä»“åº“é…ç½®çš„ï¼Œéœ€è¦è‡ªè¡Œä¿®æ”¹ /etc/apt/sources.list æ–‡ä»¶</p>
</blockquote>
<center class="podsc">é…ç½®ç½‘ç»œé•œåƒ</center>
<blockquote>
<p>å¦‚æœä¸Šé¢é€‰æ‹©äº† â€œNoâ€ ä¸‹é¢é…ç½®é•œåƒåœ°å€éƒ¨åˆ†åˆ™ä¸ä¼šå‡ºç°ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ° â€œæ ¹æ®è¦æ±‚è°ƒæ•´å®‰è£…â€ çš„æ­¥éª¤</p>
</blockquote>
<p>æ¥ä¸‹æ¥ä¼šå¼¹å‡ºä¸€ä¸ªç•Œé¢ï¼Œè¯·é€‰æ‹© â€œDebiané•œåƒå›½å®¶â€ ã€‚è¿™ä¸ªæ˜¯é…ç½®é•œåƒåœ°å€çš„ï¼Œé€‰æ‹©è‡ªå·±çš„å›½å®¶å’Œé•œåƒç«™å³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171823823.png" alt="image-20220802171823823" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©é•œåƒå›½å®¶</center>
<p>è¿™é‡Œé€‰æ‹©çš„æ˜¯ä¸­å›½å’Œä¸­ç§‘å¤§é•œåƒ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171903846.png" alt="image-20220802171903846" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©é•œåƒåœ°å€</center>
<p>é…ç½®HTTPä»£ç†ï¼Œä¸é€‰æ‹©è·³è¿‡</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171929992.png" alt="image-20220802171929992" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®httpä»£ç†</center>
<p>å¦‚æœé€‰æ‹©ç½‘ç»œå®‰è£…ï¼Œåˆ°è¿™æ­¥éª¤æ—¶å®‰è£…ç¨‹åºç°åœ¨å°†åœ¨é€‰æ‹©ç›¸å…³çš„ã€‚é¦–å…ˆï¼Œé€‰æ‹©ç¦»æ‚¨æ‰€åœ¨å›½å®¶æœ€è¿‘çš„ä½ç½®ã€‚Debian é•œåƒä½ç½®å’ŒåŸŸåæ£€ç´¢å‰©ä½™çš„æ–‡ä»¶</p>
<p>è¿™é‡Œæç¤ºæœ‰ä¸€ä¸ªåŒ¿åè°ƒæŸ¥ï¼Œè¿™é‡Œé€‰Noå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180137667.png" alt="image-20220802180137667" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åŒ¿åè°ƒæŸ¥</center>
<h3 id="æ ¹æ®è¦æ±‚è°ƒæ•´å®‰è£…">æ ¹æ®è¦æ±‚è°ƒæ•´å®‰è£…</h3>
<p>åœ¨æ£€ç´¢è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå°†æç¤ºéœ€è¦è‡ªè¡Œé€‰æ‹©ä»¥ä¸‹é¢„å®šä¹‰è½¯ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚æœ€å°åŒ–å®‰è£…ä»…é€‰æ‹©åŸºç¡€ç³»ç»Ÿä¸SSHå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180225093.png" alt="image-20220802180225093" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®‰è£…ç»„ä»¶é€‰æ‹©</center>
<p>æ¥ä¸‹æ¥ç­‰å¾…å®‰è£…å³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180343919.png" alt="image-20220802180343919" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®‰è£…è¿‡ç¨‹</center>
<blockquote>
<p>Notesï¼šé€‰æ‹©äº†DVD ISOå°†ç¦»çº¿å®Œæˆå®‰è£…ï¼Œå¦‚æœä½¿ç”¨äº†CD ISOï¼Œå°†ä»äº’è”ç½‘ä¸Šæ£€ç´¢åŒ…å¹¶å®‰è£…ï¼Œè¿™ä¸ªæ—¶é—´å°†å¾ˆé•¿ã€‚</p>
</blockquote>
<p>å…¶ä¸­ä¼šæç¤ºä¸€ä¸ªå¼•å¯¼æŒ‰ç« ï¼Œç›´æ¥Yeså³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180753937.png" alt="image-20220802180753937" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>åˆ°äº†è¿™é‡Œå³å°†å®‰è£…å®Œæˆ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180829194.png" alt="image-20220802180829194" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åˆ°äº†è¿™é‡Œå³å°†å®‰è£…å®Œæˆ</center>
<h3 id="å®Œæˆdebian12æœ€å°åŒ–å®‰è£…">å®ŒæˆDebian12æœ€å°åŒ–å®‰è£…</h3>
<p>çœ‹åˆ°åˆ°è¿™é‡Œå·²ç»å®Œæˆäº†å®‰è£…ï¼ŒæŒ‰â€œContinueâ€ç»§ç»­é‡å¯åå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180902242.png" alt="image-20220802180902242" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®Œæˆå®‰è£…</center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180923668.png" alt="image-20220802180923668" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">çœ‹åˆ°ç³»ç»Ÿçš„å¼•å¯¼ç•Œé¢</center>
<p>Enjoy ğŸ‘ğŸ‘</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>Unixå½’æ¡£æ¨¡å¼ Unix ar - æ·±å…¥å‰–æä¸æ„å»ºdebåŒ…</title>
      <link>https://www.oomkill.com/2023/03/deb-package/</link>
      <pubDate>Wed, 29 Mar 2023 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2023/03/deb-package/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="deb-æ¦‚è¿°">deb æ¦‚è¿°</h2>
<p>debåŒ…ï¼ˆ.debï¼‰æ˜¯ Debian å’ŒåŸºäº Debianè¡ç”Ÿæ“ä½œç³»ç»Ÿï¼ˆå¦‚Ubuntuï¼‰ä¸­ä½¿ç”¨çš„ä¸€ç§è½¯ä»¶åŒ…çš„æ ¼å¼ã€‚debæ˜¯ä¸€ç§åŸºäº Unix ar <sup><a href="#3">[3]</a></sup> (<em><strong>Unix archiver</strong></em>) çš„å½’æ¡£æ–‡ä»¶ã€‚å…¶ä¸­åŒ…å«äºŒè¿›åˆ¶æ–‡ä»¶ã€é…ç½®æ–‡ä»¶å’Œå…¶ä»–è½¯ä»¶æ‰€éœ€çš„èµ„æºã€‚debåŒ…å¯ç”¨äºå®‰è£…ã€å‡çº§å’Œå¸è½½è½¯ä»¶åŒ…ã€‚é€šå¸¸ï¼ŒDebianæ“ä½œç³»ç»Ÿçš„ç”¨æˆ·ä½¿ç”¨aptï¼ˆAdvanced Package  Toolï¼‰ç­‰è½¯ä»¶åŒ…ç®¡ç†å™¨å·¥å…·æ¥ç®¡ç†debåŒ…ã€‚é€šè¿‡è¿™äº›å·¥å…·ï¼Œç”¨æˆ·å¯ä»¥è½»æ¾ä¸‹è½½ã€å®‰è£…å’Œç®¡ç†è½¯ä»¶åŒ…ï¼Œè€Œæ— éœ€æ‰‹åŠ¨ç¼–è¯‘ã€å®‰è£…å’Œè§£å†³è½¯ä»¶åŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
<h3 id="deb-vs-rpm">deb VS rpm</h3>
<ul>
<li>åŒ…çš„å½’æ¡£æ ¼å¼ä¸åŒï¼šdebæ˜¯åŸºäº ar çš„å½’æ¡£æ¨¡å¼ï¼Œè€ŒRPMæ˜¯åŸºäº cpio çš„å½’æ¡£æ¨¡å¼</li>
<li>åŒ…çš„ç»“æ„ä¸åŒï¼šdebåŒ…è¦æ±‚å¿…é¡»åŒ…å«ä¸€ä¸ª <code>DEBIAN</code> ç›®å½•ï¼›è€ŒRPMä¸éœ€è¦ä»¥æ¥é¢å¤–çš„ç›®å½•ç»“æ„</li>
<li>åŒ…çš„ä¾èµ–æœºåˆ¶ä¸åŒï¼š
<ol>
<li>Debä½¿ç”¨epochï¼Œè€ŒRPMä½¿ç”¨build  numberï¼šåœ¨Debä¸­ï¼Œepochæ˜¯ä¸€ä¸ªå¯é€‰çš„å­—æ®µï¼Œå®ƒå…è®¸å‘ˆç°åŸºå‡†æ—¥æœŸä¹‹å‰çš„å…ˆå‰ç‰ˆæœ¬ã€‚è€Œåœ¨RPMä¸­ï¼Œbuild  numberè¡¨ç¤ºè½¯ä»¶åŒ…ç¼–è¯‘çš„æ¬¡æ•°ã€‚å› æ­¤ï¼Œåœ¨Debä¸­ï¼Œä¸ºäº†è§£å†³ç‰ˆæœ¬æ§åˆ¶é—®é¢˜ï¼Œepochæ˜¯éå¸¸é‡è¦çš„ï¼Œè€Œåœ¨RPMä¸­ï¼Œåˆ™æ›´å…³æ³¨build  numberã€‚</li>
<li>Debä½¿ç”¨é€†å‘ä¾èµ–å…³ç³»ï¼Œè€ŒRPMä½¿ç”¨ä¾èµ–å…³ç³»ï¼šåœ¨Debä¸­ï¼Œä¾èµ–é¡¹æ˜¯ä»åŒ…æœ¬èº«å‘å¤–æ‰©å±•ï¼Œåœ¨è§£å†³ä¾èµ–é—®é¢˜æ—¶å¯ä»¥é€šè¿‡é€†å‘ä¾èµ–å…³ç³»è¿›è¡Œã€‚è€Œåœ¨RPMä¸­ï¼Œåˆ™æ›´å–œæ¬¢ä½¿ç”¨ä¾èµ–å…³ç³»ç›´æ¥æŒ‡å‘å…¶ä»–åŒ…ã€‚</li>
<li>Debå…è®¸ä»£ç†è½¯ä»¶åŒ…ï¼Œè€ŒRPMåˆ™ä¸å…è®¸ä»£ç†è½¯ä»¶åŒ…ï¼šDebä¸­ï¼Œè½¯ä»¶åŒ…å¯ä»¥ä½¿ç”¨å¦ä¸€ç§è½¯ä»¶åŒ…çš„ä»£ç†æ¥æä¾›åŠŸèƒ½ã€‚åœ¨RPMä¸­ï¼Œè½¯ä»¶åŒ…éœ€è¦ç›´æ¥å¼•ç”¨ç›¸å…³çš„è½¯ä»¶åŒ…ã€‚è¿™æ„å‘³ç€åœ¨Debä¸­ï¼Œå¯¹äºç‰ˆæœ¬æ§åˆ¶ï¼Œå¯ä»¥ç”¨å¦ä¸€ç§ä»£ç†è½¯ä»¶åŒ…æ¥è§£å†³é—®é¢˜ï¼Œè€Œåœ¨RPMä¸­å¿…é¡»ç›´æ¥å¼•ç”¨åŒ…ã€‚</li>
<li>Debå…è®¸å¤šé‡ä¾èµ–å…³ç³»ï¼ŒRPMåˆ™ä¸å…è®¸ï¼šDebå…è®¸ä½¿ç”¨å¤šä¸ªä¾èµ–é¡¹åˆ—è¡¨ï¼Œä»¥ä¾¿åŒ…ä¸ä¸åŒç‰ˆæœ¬çš„åº“å…¼å®¹ã€‚åœ¨RPMä¸­ï¼Œéœ€è¦åœ¨æ¯ä¸ªåŒ…ä¸­å®šä¹‰ä¾èµ–é¡¹å’Œå…¶ç‰ˆæœ¬ï¼Œä¸èƒ½ä½¿ç”¨å¤šé‡ä¾èµ–ã€‚</li>
</ol>
</li>
</ul>
<h2 id="debåŒ…çš„åˆ†æ">debåŒ…çš„åˆ†æ</h2>
<h3 id="debåŒ…çš„ç»“æ„">debåŒ…çš„ç»“æ„</h3>
<p>deb æœ€é‡è¦çš„æ˜¯ <strong>æ§åˆ¶æ–‡ä»¶</strong> <code>Control</code> ï¼Œè¯¥æ–‡ä»¶è®°å½•äº†debåŒ…ä¸å…¶å®‰è£…çš„ç¨‹åºçš„ä¿¡æ¯ã€‚</p>
<p>åœ¨debåŒ…å†…éƒ¨åŒ…å«ä¸€ç»„æ¨¡æ‹Ÿ Linux æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚ <code>/usr</code>, <code>/usr/bin</code>, <code>/opt</code>ç­‰ç­‰ã€‚  æ”¾ç½®åœ¨å…¶ä¸­ä¸€ä¸ªç›®å½•ä¸­çš„æ–‡ä»¶å°†åœ¨å®‰è£…æœŸé—´å¤åˆ¶åˆ°å®é™…æ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›¸åŒä½ç½®ã€‚  å› æ­¤ï¼Œä¾‹å¦‚å°†äºŒè¿›åˆ¶æ–‡ä»¶æ”¾å…¥ <code>&lt;.deb&gt;/usr/local/bin/binaryfile</code> å°†è¢«å®‰è£…åˆ°  <code>/usr/local/bin/binaryfile</code>.</p>
<p>å¯¹äºdeb åŒ…çš„å‘½åæ˜¯éµå¾ªç€ä¸€ä¸ªç‰¹å®šçš„æ ¼å¼ï¼š</p>
<pre><code>&lt;name&gt;_&lt;version&gt;-&lt;revision&gt;_&lt;architecture&gt;.deb
</code></pre>
<ul>
<li><code>&lt;name&gt;</code> æ„å»ºçš„debåŒ…åç§°ï¼Œå¦‚nginx</li>
<li><code>&lt;version&gt;</code> ç¨‹åºçš„ç‰ˆæœ¬å· ï¼Œå¦‚1.20</li>
<li><code>&lt;revision&gt;</code> å½“å‰ deb åŒ…çš„ç‰ˆæœ¬å·</li>
<li><code>&lt;architecture&gt;</code> è¡¨ç¤ºæ„å»ºå‡ºçš„åŒ…çš„æ“ä½œç³»ç»Ÿæ¶æ„ï¼Œå¦‚ï¼Œamd64ã€i386</li>
</ul>
<p>å¦‚æœä½ æ„å»ºä¸€ä¸ªnginx-1.20çš„armæ“ä½œç³»ç»Ÿä¸‹çš„ï¼Œé‚£ä¹ˆdebåŒ…åæ ¼å¼åˆ™ä¸º <code>nginx_1.20-1_arm64.deb</code></p>
<h3 id="controlæ–‡ä»¶-supa-id22asup">controlæ–‡ä»¶ <sup><a id="2">[2]</a></sup></h3>
<p>Debè½¯ä»¶åŒ…ï¼ˆ.debæ–‡ä»¶ï¼‰ä¸­çš„ æ§åˆ¶æ–‡ä»¶ (<em><strong>control</strong></em>) åŒ…å«æœ‰å…³è½¯ä»¶åŒ…çš„ <font color="#f8070d" size=3>æºç å…ƒæ•°æ®</font> å’Œ <font color="#f8070d" size=3>äºŒè¿›åˆ¶å…ƒæ•°æ®Â </font>ï¼Œç”¨äºæè¿°ä¾‹å¦‚è½¯ä»¶åŒ…çš„åç§°ã€ç‰ˆæœ¬ã€æè¿°ã€ä½œè€…ã€è®¸å¯è¯å’Œä¾èµ–å…³ç³»ç­‰ä¿¡æ¯ã€‚åœ¨åˆ›å»ºå’Œæ‰“åŒ…Debè½¯ä»¶åŒ…æ—¶ï¼Œå¿…é¡»åˆ›å»ºå’Œç¼–è¾‘controlæ–‡ä»¶ä»¥åŒ…å«å…³äºè½¯ä»¶åŒ…çš„æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚</p>
<p>æ§åˆ¶æ–‡ä»¶ (<em><strong>control</strong></em>) ç”±ä¸€ä¸ªæˆ–å¤šèŠ‚ç»„æˆï¼Œå„èŠ‚ä¹‹é—´ç”¨ç©ºè¡Œåˆ†éš”ã€‚è§£æå™¨å¯ä»¥æ¥å—ä»…ç”±ç©ºæ ¼å’Œåˆ¶è¡¨ç¬¦ç»„æˆçš„è¡Œä½œä¸ºèŠ‚åˆ†éš”ç¬¦ï¼Œä½†æ§åˆ¶æ–‡ä»¶åº”è¯¥ä½¿ç”¨ç©ºè¡Œã€‚ä¸€äº›æ§åˆ¶æ–‡ä»¶åªå…è®¸ä¸€ä¸ªèŠ‚ï¼›å…¶ä»–äººå…è®¸å¤šä¸ªï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªèŠ‚é€šå¸¸æŒ‡çš„æ˜¯ä¸åŒçš„åŒ…ï¼Œæ§åˆ¶æ–‡ä»¶ä¸­èŠ‚çš„é¡ºåºå¾ˆé‡è¦ã€‚</p>
<p>è€Œ Control æ–‡ä»¶å­˜åœ¨ä¸¤ç§ï¼Œä¸€ç§ä¸º <font color="#f8070d" size=3>æºä»£ç åŒ…æ§åˆ¶æ–‡ä»¶</font> (<em><strong>Source package control files</strong></em>)ï¼Œè¿™ç§ç±»å‹çš„æ§åˆ¶æ–‡ä»¶ä¸»è¦ç”¨äºå®šä¹‰æºä»£ç åœ¨æ„å»ºæ—¶çš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚éœ€è¦æ„å»ºä¸€ä¸ªnginx.debï¼Œé‚£ä¹ˆæºä»£ç æ§åˆ¶æ–‡ä»¶å°±æ˜¯ç”¨äºæè¿°ä¸‹è½½ä¸‹æ¥çš„æºä»£ç ç›¸å…³çš„æ•°æ®ï¼Œè¿™ç§æ–‡ä»¶è¢«æ”¾ç½®åœ¨ç›®å½• <code>debian/control</code>ï¼›</p>
<p>å¦ä¸€ç§ä¸º<font color="#f8070d" size=3>äºŒè¿›åˆ¶åŒ…æ§åˆ¶æ–‡ä»¶</font> (<em><strong>Binary package control files</strong></em>)ï¼Œè¿™éƒ¨åˆ†æ˜¯æ§åˆ¶åœ¨nginxç¼–è¯‘ååˆ¶ä½œæˆdebåŒ…çš„æ§åˆ¶æ–‡ä»¶ï¼Œè¿™ç§æ§åˆ¶æ–‡ä»¶è¢«æ”¾ç½®åœ¨  <code>DEBIAN/control</code>ã€‚</p>
<p>å¦å¤–è¿˜å­˜åœ¨ä¸€ç§ <font color="#f8070d" size=3>æºä»£ç æ§åˆ¶æ–‡ä»¶</font> ( <em><strong>Debian source control files</strong></em> ) ï¼ŒåŒ…å«å®Œæ•´çš„æºä»£ç å’Œè½¯ä»¶åŒ…å…ƒæ•°æ®ä¿¡æ¯ã€‚å®ƒä»¬é€šå¸¸å­˜å‚¨åœ¨è½¯ä»¶åŒ…çš„æºä»£ç å­˜å‚¨åº“ä¸­ï¼Œä¾›å¼€å‘äººå‘˜å’Œç»´æŠ¤äººå‘˜ä½¿ç”¨ã€‚åŒ…å«åœ¨æºä»£ç æ§åˆ¶æ–‡ä»¶ä¸­çš„ä¿¡æ¯åŒ…æ‹¬è½¯ä»¶åŒ…åç§°ã€ç‰ˆæœ¬ã€ç»´æŠ¤äººå‘˜ã€è®¸å¯è¯ã€ä¾èµ–å…³ç³»ã€æ„å»ºå’Œå®‰è£…æŒ‡ä»¤é›†ç­‰ã€‚</p>
<p>ä¾‹å¦‚ä¸‹é¢ä¸º <code>control</code> æ–‡ä»¶å¸¸è§çš„å­—æ®µç±»å‹ï¼š</p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Package</td>
<td>&lt;è½¯ä»¶åŒ…çš„åç§°&gt;</td>
</tr>
<tr>
<td>Priority</td>
<td>&lt;è½¯ä»¶åŒ…çš„ä¼˜å…ˆçº§&gt;</td>
</tr>
<tr>
<td>Section</td>
<td>&lt;è½¯ä»¶åŒ…çš„åˆ†ç±»&gt;</td>
</tr>
<tr>
<td>Version</td>
<td>&lt;è½¯ä»¶åŒ…çš„ç‰ˆæœ¬&gt;</td>
</tr>
<tr>
<td>Depends</td>
<td>&lt;è½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»&gt;</td>
</tr>
<tr>
<td>Architecture</td>
<td>&lt;è½¯ä»¶åŒ…çš„ä½“ç³»ç»“æ„&gt;</td>
</tr>
<tr>
<td>Maintainer</td>
<td>&lt;è½¯ä»¶åŒ…çš„ç»´æŠ¤è€…&gt;</td>
</tr>
<tr>
<td>Description</td>
<td>&lt;è½¯ä»¶åŒ…çš„æè¿°&gt;</td>
</tr>
<tr>
<td>Rules-Requires-Root <sup><a id="1">[1]</a></sup></td>
<td>Rules-Requires-Rootæ˜¯Debianè½¯ä»¶åŒ…ä¸­ä¸€ä¸ªå¯é€‰çš„æ§åˆ¶æ–‡ä»¶ï¼Œå®šä¹‰äº†è½¯ä»¶åŒ…åœ¨å®‰è£…å’Œè¿è¡Œæ—¶æ˜¯å¦éœ€è¦è¶…çº§ç”¨æˆ·æƒé™ï¼›No/Yes</td>
</tr>
<tr>
<td>Standards-Version:</td>
<td>debåŒ… æ§åˆ¶æ–‡ä»¶ ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œç”¨äºæŒ‡å®šè½¯ä»¶åŒ…æ‰€éµå¾ªçš„æ ‡å‡†å’Œè§„èŒƒçš„ç‰ˆæœ¬å·ã€‚è¯¥å­—æ®µçš„å€¼åº”è¯¥æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œä¾‹å¦‚ï¼šâ€œ3.9.8â€,  â€œ2.3.0.0â€</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­ï¼Œä¸Šé¢ç»™å‡ºçš„é€šå¸¸æ˜¯å¿…é¡»æŒ‡å®šçš„å­—æ®µï¼Œå¦‚ä¸€ä¸ªcontrol æ–‡ä»¶å¿…é¡»åŒ…å« <code>Package</code> ã€<code>Priority</code>ã€<code>Section</code>ã€<code>Version</code>ã€<code>Architecture</code>ã€<code>Maintainer</code> å’Œ<code>Description</code> ã€‚ç”±äºç­‰ debè½¯ä»¶åŒ…é€šå¸¸éƒ½å®‰è£…åœ¨ç³»ç»Ÿä¸Šï¼Œåœ¨ control æ–‡ä»¶ä¸­æŒ‡å®šè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»éå¸¸é‡è¦ã€‚è¿™å¯é€šè¿‡Dependså­—æ®µå®Œæˆã€‚</p>
<p>ä¾‹å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ª control æ–‡ä»¶çš„ç¤ºä¾‹</p>
<pre><code class="language-conf"># æºä»£ç æ§åˆ¶æ–‡ä»¶
Source: nginx
Maintainer: root &lt;root@debian-template&gt;
Section: comm
Priority: optional
Homepage: https://nginx.org

# äºŒè¿›åˆ¶æ§åˆ¶æ–‡ä»¶
Package: nginx
Version: 1.22.1
Architecture: amd64
Standards-Version: 1.0.0
Build-Depends: debhelper-compat (= 13)
Description: Nginx HTTP server Nginx (&quot;engine x&quot;) is a web server created by Igor Sysoev. It is known for its high performance, stability, and low resource consumption.
</code></pre>
<h3 id="rulesæ–‡ä»¶-supa-id55asup">rulesæ–‡ä»¶ <sup><a id="5">[5]</a></sup></h3>
<h4 id="rulesæ–‡ä»¶çš„è§„èŒƒ">rulesæ–‡ä»¶çš„è§„èŒƒ</h4>
<p>rulesæ–‡ä»¶åœ¨debä¸­è¢«æˆä¸º ä¸»è¦æ„å»ºè„šæœ¬ (<em><strong>Main building script</strong></em>)ï¼Œè¿™ä¸ªæ–‡ä»¶å¿…é¡»æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„Makefileã€‚å®ƒåŒ…å«äº†ç‰¹å®šäºåŒ…çš„æºä»£ç ï¼ˆå¦‚æœéœ€è¦ï¼‰å’Œæ„å»ºä¸€ä¸ªæˆ–å¤šä¸ªäºŒè¿›åˆ¶åŒ…çš„æŒ‡ä»¤ã€‚</p>
<p>debian/rulesæ–‡ä»¶ å¿…é¡»ä»¥ <code>#!/usr/bin/make  -f</code> å¼€å¤´ï¼Œè¿™ä¸ªå£°æ˜æ˜¯ä¸ºäº†é€šè¿‡è°ƒç”¨å…¶åç§°è€Œä¸æ˜¯æ˜¾å¼è°ƒç”¨makeæ¥è°ƒç”¨å®ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨ <code>make -f debian/rules  args...</code> æˆ– <code>./debian/rules args...</code> å¿…é¡»äº§ç”Ÿç›¸åŒçš„è¡Œä¸ºã€‚</p>
<p>åœ¨æ²¡æœ‰ä½¿ç”¨å…¶ä»–æ–¹æ³•çš„å……åˆ†ç†ç”±çš„æƒ…å†µä¸‹ï¼Œå®ç°Debianè½¯ä»¶åŒ…æ„å»ºè¿‡ç¨‹çš„æ¨èæ–¹å¼æ˜¯ä½¿ç”¨dhå·¥å…·ã€‚è¿™åŒ…æ‹¬debian/rulesæ„å»ºè„šæœ¬çš„å†…å®¹ã€‚dhæ˜¯Debianä¸­æœ€å¸¸è§çš„å°è£…è¾…åŠ©å·¥å…·ã€‚ä½¿ç”¨å®ƒé€šå¸¸å¯ä»¥èŠ‚çœéµå®ˆæœ¬æ–‡æ¡£ä¸­è§„åˆ™çš„å·¥ä½œï¼Œå› ä¸ºdhå°†è‡ªåŠ¨å®ç°è®¸å¤šè§„åˆ™è€Œæ— éœ€æ˜ç¡®çš„æŒ‡ç¤ºã€‚</p>
<p>rules æ–‡ä»¶å†…ç½®äº†ä¸€äº›é˜¶æ®µï¼Œè¿™æ ‡å¿—ç€æ•´ä¸ªæºç åŒ…æ„å»ºçš„è¿‡ç¨‹ï¼›å¦‚ debian/rules å¿…é¡»ç”±ï¼šcleanã€binaryã€binary-archã€binary-indepã€buildã€build-arch å’Œ build-indepï¼Œå¦‚æœé€šè¿‡ <code>dpkg-buildpackage</code> æ„å»ºæ—¶ï¼Œè¿™äº›é˜¶æ®µåˆ™æ˜¯è°ƒç”¨çš„é˜¶æ®µã€‚</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç”±äºäº¤äº’å¼ debian/rules è„šæœ¬æ— æ³•è‡ªåŠ¨ç¼–è¯‘è¯¥è½¯ä»¶åŒ…ï¼Œä¹Ÿä½¿å…¶ä»–äººéš¾ä»¥å¤åˆ¶ç›¸åŒçš„äºŒè¿›åˆ¶è½¯ä»¶åŒ…ï¼Œå› æ­¤æ‰€æœ‰å¿…éœ€çš„é˜¶æ®µéƒ½å¿…é¡»æ˜¯éäº¤äº’å¼çš„ã€‚å®ƒè¿˜éµå¾ªè¿™äº›é˜¶æ®µæ‰€ä¾èµ–çš„ä»»ä½•é˜¶æ®µä¹Ÿå¿…é¡»æ˜¯éäº¤äº’å¼çš„ã€‚</p>
<h4 id="rulesæ–‡ä»¶çš„æ„å»ºè¿‡ç¨‹">rulesæ–‡ä»¶çš„æ„å»ºè¿‡ç¨‹</h4>
<p>é€šä¿—æ¥è¯´ï¼Œrulesæ–‡ä»¶æ˜¯ä¸€ä¸ªå°†æºç åŒ…è½¬æ¢ä¸ºäºŒè¿›åˆ¶åŒ…çš„ä¸€ä¸ªæ„å»ºæ¨¡å¼ï¼Œé¦–å…ˆï¼ŒbinareyäºŒè¿›åˆ¶åŒ…å†™å…¥è§£å‹åçš„æºç åŒ…çš„çˆ¶ç›®å½•ã€‚å…¶æ¬¡ï¼Œæ‰€éœ€çš„ç›®æ ‡å¯ä»¥å†™å…¥ /tmpã€/var/tmp å’Œ TMPDIR ç¯å¢ƒå˜é‡æŒ‡å®šçš„ç›®å½•ï¼Œä½†ä¸å¾—ä¾èµ–äºå…¶ä¸­ä»»ä½•ä¸€ä¸ªçš„å†…å®¹ã€‚</p>
<p>è¿™ä¸ªé™åˆ¶æ—¨åœ¨é˜²æ­¢æºä»£ç åŒ…æ„å»ºåˆ›å»ºå’Œä¾èµ–äºå…¶å¤–éƒ¨çŠ¶æ€ï¼Œä»è€Œå½±å“å¤šä¸ªç‹¬ç«‹çš„é‡å»ºè¿‡ç¨‹ã€‚ç‰¹åˆ«åœ°ï¼Œæ‰€éœ€çš„ç›®æ ‡ä¸èƒ½å°è¯•å†™å…¥ HOME ç›®å½•ã€‚</p>
<p>rulesæ–‡ä»¶çš„è¿‡ç¨‹ï¼Œä¹Ÿæ˜¯é˜¶æ®µï¼š</p>
<ul>
<li><em><strong>build</strong></em> (required)ï¼šè¯¥é˜¶æ®µåº”è¯¥æ‰§è¡Œè½¯ä»¶åŒ…çš„æ‰€æœ‰é…ç½®å’Œç¼–è¯‘æ“ä½œï¼Œä¾‹å¦‚ makeï¼Œè¿™ä¸ªé˜¶æ®µæ‰§è¡Œå‰ï¼Œä¼šå…ˆè¿è¡Œ <code>clean</code> é˜¶æ®µ</li>
<li><em><strong>build-indep</strong></em> å’Œ <em><strong>build-arch</strong></em> (required)
<ul>
<li>build-arch (required)ï¼šè¯¥é˜¶æ®µå¿…é¡»æ‰§è¡Œç”Ÿæˆæ‰€æœ‰ä¸æ¶æ„ï¼ˆ<em><strong>architecture</strong></em>ï¼‰æœ‰å…³çš„äºŒè¿›åˆ¶åŒ…ï¼Œä¾‹å¦‚ make intall å¥½çš„ x86 çš„äºŒè¿›åˆ¶æ–‡ä»¶</li>
<li>build-indep (required)ï¼š è¯¥é˜¶æ®µæ‰§è¡Œç”Ÿæˆæ‰€æœ‰ä¸ æ¶æ„ï¼ˆ<em><strong>architecture</strong></em>ï¼‰æ— å…³çš„äºŒè¿›åˆ¶åŒ…æ“ä½œï¼Œæ‰€éœ€çš„æ‰€æœ‰é…ç½®å’Œç¼–è¯‘æ“ä½œã€‚build é˜¶æ®µåº”è¯¥ä¾èµ–äºè¿™äº›é˜¶æ®µï¼Œæˆ–è€…é‡‡å–ä¸è°ƒç”¨è¿™äº›é˜¶æ®µç›¸åŒçš„æ“ä½œï¼Œ</li>
<li><code>build-arch</code> å’Œ <code>build-indep</code> ä¸èƒ½æ‰§è¡Œä»»ä½•å¯èƒ½éœ€è¦ root æƒé™çš„æ“ä½œã€‚</li>
<li>é€šä¿—æ¥è®²ï¼Œè¿™ä¸¤ä¸ªé˜¶æ®µä¼šè¢«ç”¨äºæ“ä½œæ„å»ºå®Œçš„äº‹æƒ…ï¼Œå¯¹äºrpmbuildï¼Œè¿™é‡Œæ“ä½œå°±æ˜¯%filesçš„æ“ä½œäº†ã€‚</li>
</ul>
</li>
<li><em><strong>binary</strong></em> (required), <em><strong>binary-arch</strong></em> (required), <em><strong>binary-indep</strong></em> (required)ï¼š
<ul>
<li><em><strong>binary</strong></em>ï¼šè¯¥é˜¶æ®µå¿…é¡»æ˜¯ç”¨æˆ·ä»æ­¤æºä»£ç åŒ…ç”ŸæˆäºŒè¿›åˆ¶åŒ…æ‰€éœ€çš„å…¨éƒ¨å†…å®¹ã€‚å®ƒåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šbinary-archç”¨äºç”Ÿæˆç‰¹å®šæ¶æ„çš„äºŒè¿›åˆ¶åŒ…ï¼Œbinary-indepç”¨äºç”Ÿæˆå…¶ä»–ç±»å‹çš„äºŒè¿›åˆ¶åŒ…</li>
<li><em><strong>binary-*</strong></em> é˜¶æ®µéƒ½åº”è¯¥ä¾èµ–äº build é˜¶æ®µæˆ–é€‚å½“çš„ build-arch æˆ– build-indep é˜¶æ®µï¼Œä»¥ä¾¿åœ¨æ²¡æœ‰æ„å»ºè¯¥è½¯ä»¶åŒ…æ—¶æ„å»ºå®ƒã€‚ç„¶åä½¿ç”¨ dpkg-gencontrol åˆ›å»ºå…¶æ§åˆ¶æ–‡ä»¶ä»¥åŠ<code>dpkg-deb</code> æ„å»ºæˆä¸€ä¸ªäºŒè¿›åˆ¶åŒ…ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨é¡¶çº§ç›®å½•çš„çˆ¶ç›®å½•ä¸­ï¼ˆå³ä½ æ‰§è¡Œæ„å»ºçš„ç›®å½•çš„ä¸Šçº§ï¼‰ï¼Œä»¥åˆ›å»ºç›¸åº”çš„äºŒè¿›åˆ¶åŒ…ã€‚</li>
<li><em><strong>binary-arch</strong></em> å’Œ <em><strong>binary-indep</strong></em> ä¸¤ä¸ªé˜¶æ®µå¿…é¡»è¦å­˜åœ¨ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªé˜¶æ®µæ— äº‹å¯åšï¼ˆå¦‚æœæºä»£ç ä»…ç”Ÿæˆå•ä¸ªäºŒè¿›åˆ¶åŒ…ï¼Œæ— è®ºæ˜¯å¦æ¶æ„ç›¸å…³ï¼Œå§‹ç»ˆæ˜¯å¦‚æ­¤ï¼‰ï¼Œå®ƒä»å¿…é¡»å­˜åœ¨å¹¶å§‹ç»ˆæˆåŠŸã€‚</li>
<li>æ ¹æ®Rules-Requires-Rootå­—æ®µçš„å€¼çš„é…ç½®ï¼Œbinaryé˜¶æ®µå¯èƒ½éœ€è¦ä½œä¸ºrootç”¨æˆ·è°ƒç”¨ã€‚</li>
</ul>
</li>
<li><em><strong>clean</strong></em> (required)ï¼šè¯¥é˜¶æ®µå°†æ’¤æ¶ˆ <em><strong>build</strong></em> å’Œ <em><strong>binary</strong></em> é˜¶æ®µå¯èƒ½äº§ç”Ÿçš„æ‰€æœ‰æ•ˆæœï¼Œé™¤äº†å®ƒåº”è¯¥ä¿ç•™åœ¨ä¸Šæ¬¡è¿è¡Œ <em><strong>binary</strong></em>  é˜¶æ®µæ—¶åœ¨çˆ¶ç›®å½•ä¸­åˆ›å»ºçš„ä»»ä½•è¾“å‡ºæ–‡ä»¶ã€‚</li>
<li><em><strong>patch</strong></em> (optional)ï¼šæ­¤é˜¶æ®µæ‰§è¡Œæ‰€éœ€çš„ä»»ä½•å…¶ä»–æ“ä½œï¼Œä»¥ä½¿æºä»£ç åŒ…å‡†å¤‡å¥½è¿›è¡Œç¼–è¾‘ï¼ˆè§£åŒ…å…¶ä»–ä¸Šæ¸¸å½’æ¡£æ–‡ä»¶ã€åº”ç”¨è¡¥ä¸ç­‰ï¼‰</li>
</ul>
<p>è¿™äº›é˜¶æ®µæ‰§è¡Œæ„å»ºçš„å·¥ä½œç›®å½•ï¼Œä¸debåŒ…çš„å·¥ä½œç›®å½•ä¸åŒï¼Œä»–çš„å·¥ä½œç›®å½•ä¸ºå½“å‰ç›®å½•ä½œä¸ºåŒ…çš„æ ¹ç›®å½•æ¥ä½¿ç”¨ï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„æ¶æ„çš„è§‰å¾—ä¸º dpkg-architecture å‘½ä»¤å†³å®šçš„ï¼Œåœ¨ä¸åŒæ¶æ„æœºå™¨ä¸Šæ„å»ºåˆ™ä¸ºä¸åŒçš„æ¶æ„çš„åŒ…</p>
<h3 id="å·¥ä½œç›®å½•">å·¥ä½œç›®å½•</h3>
<p>åœ¨æ„å»ºdebè½¯ä»¶åŒ…ï¼ˆ.debæ–‡ä»¶ï¼‰æ—¶ï¼Œé€šå¸¸éœ€è¦å°†è½¯ä»¶åŒ…çš„æ–‡ä»¶å’Œç›®å½•å®‰æ’åœ¨ç‰¹å®šçš„æ–‡ä»¶ç›®å½•ä¸­ï¼Œè¿™ä¸ªç‰¹å®šç›®å½•å°±æ˜¯æ‰“åŒ…æ—¶çš„å·¥ä½œç›®å½•ï¼Œé€šè¿‡ä¸Šé¢çš„è§£é‡Šï¼Œå·²çŸ¥ï¼ŒdebåŒ…åˆ†ä¸ºä¸¤ç§ <font color="#f8070d" size=3>æºä»£ç åŒ…</font> å’Œ <font color="#f8070d" size=3>äºŒè¿›åˆ¶åŒ…</font>ï¼Œè€Œä¸¤ä¸­ç±»å‹çš„å·¥ä½œç›®å½•ä¸ç›¸åŒã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªæºç è½¯ä»¶åŒ…ï¼Œå‡è®¾ä¸ºè¦ä¸ºä¸€ä¸ªnginxåˆ¶ä½œ debåŒ…ï¼Œé‚£ä¹ˆä»–çš„å·¥ä½œç›®å½•åˆ™ä¸º debianï¼Œè€Œcontrol æ–‡ä»¶ å’Œ rule æ–‡ä»¶åˆ™æ˜¯å¿…é¡»çš„ï¼Œ<font color="#f8070d" size=3>å°åŒ…çš„å†…å®¹ç›®å½•</font> åˆ™ä¸ºæ§åˆ¶æ–‡ä»¶ä¸­ <code>Package</code> é…ç½®çš„åå­—ï¼Œè¿™é‡Œé…ç½®çš„ä¸º nginxï¼Œé‚£ä¹ˆè¿™ä¸ªdebåŒ…å°åŒ…æ—¶å¯»æ‰¾çš„å†…å®¹åˆ™ä¸º <code>debian/nginx</code></p>
<p>åœ¨ä¾‹å¦‚ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªäºŒè¿›åˆ¶è½¯ä»¶åŒ…ï¼Œé‚£ä¹ˆä»–çš„å·¥ä½œç›®å½•ä¸º<code> DEBIAN</code>ï¼Œcontrolæ–‡ä»¶ä¸ changelog åˆ™æ˜¯å¿…é¡»çš„ï¼Œè€Œ<font color="#f8070d" size=3>å°åŒ…çš„å†…å®¹ç›®å½•</font> å½“å‰ç›®å½•ï¼Œä¹Ÿå°±æ˜¯ <code> DEBIAN</code>ï¼Œåˆ¶ä½œæ—¶çš„æ§åˆ¶æ–‡ä»¶è¿™äº›ä¸ä¼šè¢«å°å…¥åŒ…ä¸­</p>
<p><strong>é‚£ä¹ˆå®Œæ•´çš„åˆ¶ä½œæµç¨‹ä¸º</strong>ï¼š</p>
<ul>
<li>åœ¨æºä»£ç ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºnginxçš„å­ç›®å½• <code>mkdir debian</code></li>
<li>åœ¨nginxç›®å½•ä¸‹åˆ›å»ºåä¸º <code>DEBIAN</code> çš„å­ç›®å½•ï¼ŒåŒ…å« <code>control</code> æ–‡ä»¶ï¼Œåœ¨<code>DEBIAN</code>ç›®å½•ä¸­åŒ…å«<code>control</code>æ–‡ä»¶æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå®ƒæ˜¯è½¯ä»¶åŒ…å…ƒæ•°æ®çš„ä¸­å¿ƒå­˜å‚¨åº“ã€‚</li>
<li>ä¾‹å¦‚æˆ‘ä»¬ç¼–è¯‘å®Œçš„å†…å®¹ï¼Œnginx çš„é…ç½®æ–‡ä»¶åœ¨ /etc/ä¸‹ï¼Œé‚£ä¹ˆè¿™ä¸ª etc åˆ™åœ¨ nginx å­ç›®å½•ä¸‹</li>
<li>åœ¨å·¥ä½œç›®å½•ä¸‹åˆ›å»º rules æ–‡ä»¶ï¼Œè¿™é‡Œé¢å†™æ˜äº†æ„å»ºçš„å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
<ul>
<li><code>build</code>ï¼šè¿™ä¸ªéƒ¨åˆ†ç”¨äºæ‰§è¡Œç¼–è¯‘å’Œæ„å»ºè½¯ä»¶çš„å‘½ä»¤ã€‚</li>
<li><code>clean</code>ï¼šè¿™ä¸ªéƒ¨åˆ†ç”¨äºæ¸…é™¤ç¼–è¯‘è¾“å‡ºï¼Œä»¥ä¾¿ä½ å¯ä»¥é‡æ–°æ„å»ºè½¯ä»¶åŒ…ã€‚</li>
<li><code>install</code>ï¼šè¿™ä¸ªéƒ¨åˆ†æŒ‡å®šäº†å¦‚ä½•å°†è½¯ä»¶å®‰è£…åˆ°ç›®æ ‡ç³»ç»Ÿä¸­ã€‚</li>
<li><code>binary</code>ï¼šè¿™ä¸ªéƒ¨åˆ†ç”¨äºåœ¨ Debian è½¯ä»¶åŒ…ä¸­æ‰“åŒ…äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</li>
</ul>
</li>
<li>å…¶ä¸­è¯¥ç»“æ„ä¸­è¿˜åŒ…å«ä¸€äº›é’©å­è„šæœ¬æ–‡ä»¶ <code>debian/p*</code> è€Œè¿™ä¸ª  <code>p*</code>  æ–‡ä»¶çš„å‘½åæ˜¯å›ºå®šçš„ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„ <code>p*</code> æ–‡ä»¶åï¼š
<ul>
<li><code>debian/package.install</code>ï¼šå®šä¹‰è½¯ä»¶åŒ…ä¸­éœ€è¦å®‰è£…çš„æ–‡ä»¶å’Œç›®å½•ã€‚</li>
<li><code>debian/package.manpages</code>ï¼šå°†è½¯ä»¶åŒ…ä¸­çš„ man é¡µé¢æ·»åŠ åˆ° man æ‰‹å†Œä¸­ã€‚</li>
<li><code>debian/package.docs</code>ï¼šå°†è½¯ä»¶åŒ…ä¸­çš„æ–‡æ¡£æ·»åŠ åˆ°ç³»ç»Ÿä¸Šçš„ <code>/usr/share/doc</code> ç›®å½•ã€‚</li>
<li><code>debian/package.preinst</code>ï¼šåœ¨è½¯ä»¶åŒ…å®‰è£…å‰æ‰§è¡Œçš„è„šæœ¬ã€‚</li>
<li><code>debian/package.postinst</code>ï¼šåœ¨è½¯ä»¶åŒ…å®‰è£…åæ‰§è¡Œçš„è„šæœ¬ã€‚</li>
<li><code>debian/package.prerm</code>ï¼šåœ¨è½¯ä»¶åŒ…å¸è½½å‰æ‰§è¡Œçš„è„šæœ¬ã€‚</li>
<li><code>debian/package.postrm</code>ï¼šåœ¨è½¯ä»¶åŒ…å¸è½½åæ‰§è¡Œçš„è„šæœ¬ã€‚</li>
</ul>
</li>
</ul>
<h2 id="å®æˆ˜ä»0æ„å»ºä¸€ä¸ª-deb-åŒ…">å®æˆ˜ï¼šä»0æ„å»ºä¸€ä¸ª deb åŒ…</h2>
<h3 id="å‡†å¤‡æ¡ä»¶">å‡†å¤‡æ¡ä»¶</h3>
<p>ä¸Šé¢ä»‹ç»çš„ä¸ºdebåŒ…çš„ä¸€äº›åŸºç¡€ï¼Œä½œä¸ºå®æˆ˜çš„ä¸€äº›ç†è®ºçŸ¥è¯†ï¼Œä¸‹é¢å°†ä»¥nginxä¸ºä»£è¡¨å°†å…¶åˆ¶ä½œä¸ºdebåŒ…ï¼›é€šè¿‡å‰é¢çŸ¥è¯†äº†è§£åˆ°ï¼ŒdebåŒ…åˆ†ä¸º <font color="#f8070d" size=3>æºä»£ç åŒ…</font> å’Œ <font color="#f8070d" size=3>äºŒè¿›åˆ¶åŒ…</font>ï¼Œé‚£ä¹ˆnginxæ˜æ˜¾ä¸ºæºä»£ç åŒ…ï¼Œæˆ‘ä»¬å°±éœ€è¦æŒ‰ç…§ æºä»£ç åŒ… =ã€‹äºŒè¿›åˆ¶åŒ… è¿™ç§é¡ºåºä¾æ¬¡å®šä¹‰ï¼Œè€Œ debian æä¾›äº†ä¸€ç³»åˆ—çš„å‘½ä»¤å¯ä»¥å¸®åŠ©ç”Ÿæˆè¿™äº›æ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦æ”¹å†™å…·ä½“çš„é€»è¾‘å°±å¯ä»¥å®ŒæˆåŒ…çš„åˆ¶ä½œï¼Œå¦‚ <code>dh_make</code> , <code>dh_install</code> ç­‰å‘½ä»¤ã€‚</p>
<p>å¯¹äº deb åŒ…çš„æ ‡å‡†ï¼Œdebian å®˜æ–¹æœ‰ä¸€äº›åˆ—çš„æ•™ç¨‹ï¼Œç§°ä¸º <em><strong>Debian Policy Manual</strong></em> <sup><a id="4">[4]</a></sup>  ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ‰‹å†Œï¼Œæ•´ä¸ªdebåŒ…ä¸­æ‰€éœ€çš„ä¸€äº›ç†è®ºçŸ¥è¯†ï¼Œæ§åˆ¶æ–‡ä»¶ï¼Œç»´æŠ¤è„šæœ¬ï¼ŒåŒ…é—´çš„ä¾èµ–å…³ç³»ï¼Œå…±äº«åº“ç­‰è¿›è¡Œè¯¦ç»†çš„è¯´æ˜</p>
<h3 id="dhå·¥å…·">dhå·¥å…·</h3>
<p>dh <sup><a id="6">[6]</a></sup>ï¼ˆDebhelperï¼‰å·¥å…·æ˜¯Debianä¸­è‡ªå¸¦çš„ä¸€ä¸ªæ„å»ºdebåŒ…çš„å·¥å…·é›†ã€‚dhå·¥å…·åŒ…å«äº†ä¸€ç³»åˆ—çš„è„šæœ¬ï¼Œç”¨äºä»æ‰“åŒ…çš„æºä»£ç ä¸­è‡ªåŠ¨åŒ–ç”Ÿæˆdebianç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚è¿™äº›è„šæœ¬æ˜¯ <code>debian/rules</code> æ–‡ä»¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä»¬è´Ÿè´£å¤„ç†è¯¸å¦‚æ„å»ºã€å®‰è£…ã€æ‰“åŒ…ã€åˆ é™¤ç­‰ä»»åŠ¡ã€‚</p>
<p>dhå·¥å…·åŒ…æ‹¬å¤šä¸ªå‘½ä»¤åŠå…¶é€‰é¡¹ï¼Œæ›´å¤šçš„ dh å·¥å…·å¯ä»¥å‚è€ƒå®˜æ–¹</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>dh_make</td>
<td>åˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„åœ¨debåŒ…æ‰“åŒ…æ—¶çš„å·¥ä½œæ¡†æ¶</td>
</tr>
<tr>
<td>dh_auto_configure</td>
<td>è‡ªåŠ¨è¿è¡Œ <code>configure</code> è„šæœ¬ä»¥ç”Ÿæˆ <code>Makefile</code></td>
</tr>
<tr>
<td>dh_install</td>
<td>å°†æ–‡ä»¶å¤åˆ¶åˆ°æ­£ç¡®çš„debåŒ…çš„æ„å»ºç›®å½•ä¸­ï¼Œä¸€äº›å¸¸è§é€‰é¡¹ï¼š<br><code>-s</code> æˆ– <code>--sourcedir=</code>: æŒ‡å®šæºä»£ç ç›®å½•ï¼›<br><code>-X</code> æˆ– <code>--exclude</code>: æ’é™¤åœ¨å®‰è£…ä¸­ä¸å¿…è¦çš„æ–‡ä»¶ï¼›<br><code>-n</code> æˆ– <code>--noscripts</code>: åœ¨å®‰è£…è½¯ä»¶åŒ…æ—¶ä¸è¿è¡Œè„šæœ¬ï¼›<br><code>-Z</code>: è¡¨ç¤ºå®‰è£…çš„æ–‡ä»¶ä¸è¦åœ¨è§„åˆ™ä¸­æ³¨å†Œï¼›</td>
</tr>
<tr>
<td>dh_builddeb</td>
<td>ä»¥ <code>.deb</code> æ–‡ä»¶æ ¼å¼æ„å»ºè½¯ä»¶åŒ…</td>
</tr>
<tr>
<td>dh_clean</td>
<td>æ¸…ç†debianç›®å½•å’Œç”Ÿæˆçš„æ–‡ä»¶ï¼Œä»¥ç¡®ä¿å®ƒä»¬ä¸ä¼šåœ¨æ„å»ºæ—¶å¯¹ç»“æœé€ æˆå½±å“ã€‚</td>
</tr>
<tr>
<td>dh_gencontrol</td>
<td>ç”Ÿäº§å’Œå®‰è£…controlæ–‡ä»¶</td>
</tr>
<tr>
<td>dh_installsystemd</td>
<td>å®‰è£…systemdå•å…ƒæ–‡ä»¶</td>
</tr>
</tbody>
</table>
<h4 id="dh_make">dh_make</h4>
<p><code>dh_make</code> å‘½ä»¤æ˜¯ä¸€ä¸ªç”¨äºå¿«é€Ÿåˆ›å»º deb åŒ…çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å®ƒå¯ä»¥æ ¹æ®ç”¨æˆ·æä¾›çš„åŸºæœ¬ä¿¡æ¯å’Œè½¯ä»¶åŒ…æºä»£ç è‡ªåŠ¨åˆ›å»º deb åŒ…çš„åŸºç¡€ç»“æ„ï¼ŒåŒ…æ‹¬ <code>debian/</code> ç›®å½•å’Œç›¸å…³æ–‡ä»¶ï¼Œå¦‚ <code>control</code>ã€<code>rules</code> ä»¥åŠ <code>changelog</code> ç­‰æ–‡ä»¶ã€‚DH è¡¨ç¤º Debian åŒ…å« debhelper å»ºè®®çš„ç›®å½•å’Œæ–‡ä»¶ç»“æ„ã€‚</p>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>dh_make</code> å‘½ä»¤æ˜¯äº¤äº’å¼çš„ï¼Œå®ƒä¼šæç¤ºä½ è¾“å…¥ä¸€äº›å¿…è¦çš„è½¯ä»¶åŒ…ä¿¡æ¯ï¼Œå¦‚è½¯ä»¶åŒ…åç§°ã€ç‰ˆæœ¬å·ã€ä½œè€…ã€è½¯ä»¶è®¸å¯è¯ç­‰ã€‚å¦‚æœä½ æƒ³éäº¤äº’æ–¹å¼è¿è¡Œ <code>dh_make</code> å‘½ä»¤ï¼Œå¹¶æŒ‡å®šè½¯ä»¶åŒ…ä¿¡æ¯ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ <code>-s</code> é€‰é¡¹ã€‚</p>
<pre><code class="language-bash">$ dh_make -s --createorig -f ../{some_package-1.2.3}.tar.gz -p {some_package_1.2.3-1}.deb
</code></pre>
<p>åœ¨ä¸Šè¿°å‘½ä»¤ä¸­ï¼Œ<code>-s</code> é€‰é¡¹è¡¨ç¤ºä»¥éäº¤äº’æ–¹å¼è¿è¡Œ <code>dh_make</code> å‘½ä»¤ï¼Œå¹¶å°†è½¯ä»¶åŒ…çš„åŸºæœ¬ä¿¡æ¯ä½œä¸ºå‚æ•°æŒ‡å®šã€‚<code>--createorig</code> é€‰é¡¹è¡¨ç¤ºæˆ‘ä»¬æƒ³è¦åˆ›å»ºä¸€ä¸ªåŸå§‹çš„æºä»£ç åŒ…ï¼Œ<code>-f</code> é€‰é¡¹æŒ‡å®šè½¯ä»¶åŒ…æºä»£ç çš„æ–‡ä»¶åå’Œè·¯å¾„ï¼Œ<code>-p</code> é€‰é¡¹æŒ‡å®šè¦åˆ›å»ºçš„ Debian è½¯ä»¶åŒ…çš„åç§°å’Œç‰ˆæœ¬å·ã€‚</p>
<p>è€Œä¸Šè¿°å‘½ä»¤ä¼šæç¤ºè¾“å…¥ä¸€äº›åŸºæœ¬çš„è¯¦ç»†ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨ <code>debian/control</code> æ§åˆ¶æ–‡ä»¶ä¸­ä¸ºè½¯ä»¶åŒ…è®¾ç½®å…ƒæ•°æ®ã€‚dh_make ä¼šè¯¢é—®è¾“å…¥è½¯ä»¶åŒ…çš„åç§°ã€ç‰ˆæœ¬ã€æè¿°ã€ç»„ä»¶ã€ç»´æŠ¤äººå‘˜ç­‰ä¿¡æ¯ï¼Œæ˜¯å¦ä»¥è¿™äº›å‚æ•°ä½œä¸ºæ„å»ºï¼Œå¦‚æœä¸éœ€è¦è¿™éƒ¨ç¡®è®¤å¯ä»¥ä½¿ç”¨ <code>-y</code> é»˜è®¤åŒæ„</p>
<p>ä¸‹é¢æ˜¯é€šè¿‡ <code>dh_make</code> æ„å»ºå‡ºçš„åœ¨æ„å»ºdebåŒ…çš„å·¥ä½œç›®å½•ï¼Œè¿™ç§æ–¹å¼ä¸‹å¯ä»¥å¾ˆæ˜äº†çš„ç†è§£debåŒ…çš„ç»“æ„</p>
<pre><code class="language-bash">$ tree debian/
debian/
â”œâ”€â”€ changelog
â”œâ”€â”€ control
â”œâ”€â”€ copyright
â”œâ”€â”€ manpage.1.ex
â”œâ”€â”€ manpage.sgml.ex
â”œâ”€â”€ manpage.xml.ex
â”œâ”€â”€ nginx.cron.d.ex
â”œâ”€â”€ nginx.doc-base.EX
â”œâ”€â”€ nginx-docs.docs
â”œâ”€â”€ postinst.ex
â”œâ”€â”€ postrm.ex
â”œâ”€â”€ preinst.ex
â”œâ”€â”€ prerm.ex
â”œâ”€â”€ README.Debian
â”œâ”€â”€ README.source
â”œâ”€â”€ rules
â”œâ”€â”€ salsa-ci.yml.ex
â”œâ”€â”€ source
â”‚Â Â  â””â”€â”€ format
â””â”€â”€ watch.ex
</code></pre>
<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªæºç åŒ…çš„å‰ææ¡ä»¶çš„æ„å»ºï¼Œåªéœ€è¦ç¨å¾®ä¿®æ”¹æ§åˆ¶æ–‡ä»¶å³å¯ï¼Œè¿›è¡Œåç»­çš„äºŒè¿›åˆ¶åŒ…çš„æ„å»ºã€‚</p>
<p>è¿™é‡Œæœ€ç»ˆçš„ æ§åˆ¶æ–‡ä»¶ å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-conf"># æºä»£ç æ§åˆ¶æ–‡ä»¶
Source: nginx
Maintainer: root &lt;root@debian-template&gt;
Section: comm
Priority: optional
Homepage: https://nginx.org

# äºŒè¿›åˆ¶æ§åˆ¶æ–‡ä»¶
Package: nginx-d
Version: 1.22.1
Architecture: amd64
Standards-Version: 1.0.0
Build-Depends: debhelper-compat (= 13)
Description: Nginx HTTP server Nginx (&quot;engine x&quot;) is a web server created by Igor Sysoev. It is known for its high performance, stability, and low resource consumption.
</code></pre>
<h3 id="å‡†å¤‡rulesæ–‡ä»¶">å‡†å¤‡rulesæ–‡ä»¶</h3>
<p>é€šè¿‡ä¸Šé¢çš„rulesæ–‡ä»¶éƒ¨åˆ†ä»‹ç»ï¼Œäº†è§£åˆ° rules æ–‡ä»¶å°±æ˜¯ä¸€ä¸ª Makefileï¼Œå¹¶ä¸”åŒ…å«ä¸‰ä¸ªé˜¶æ®µ</p>
<ul>
<li>
<p><strong>clean</strong> &ndash; åˆ é™¤æ‰€æœ‰buildä¸binaryé˜¶æ®µäº§ç”Ÿçš„å†…å®¹</p>
</li>
<li>
<p><strong>build</strong> &ndash; ç¼–è¯‘ä¸æ„å»ºçš„æ­¥éª¤</p>
</li>
<li>
<p><strong>binary</strong> &ndash; binaryé˜¶æ®µå°†åˆ›å»ºdebåŒ…çš„rootç›®å½•ï¼Œè¿™ä¸ªç›®å½•è¢«åŒ…å«åœ¨ <code>debian</code> ç›®å½•ä¸‹ï¼Œè€Œç›®å½•ååˆ™ä¸º control æ–‡ä»¶ä¸­é…ç½®çš„ <code>Package</code> åå­—ï¼Œå³ <code>debian/&lt;source package name&gt;</code></p>
</li>
</ul>
<p>è¿™äº›é˜¶æ®µéƒ½é€šè¿‡ <code>dpkg-buildpackage</code> åœ¨æ„å»ºæ—¶è¢«æ‰§è¡Œï¼Œä¸€ä¸ªrulesæ–‡ä»¶çš„æ¨¡æ¿å¦‚ä¸‹</p>
<pre><code class="language-makefile">#!/usr/bin/make -f

clean:
	@# Do nothing

build:
	@# Do nothing

binary:
	@# Do nothing
	dh_gencontrol
	dh_builddeb
</code></pre>
<p>é‚£è¿™ä¸ª nginx çš„ rules æ–‡ä»¶åˆ™ä¸ºä¸‹è¿°æ‰€ç¤ºï¼š</p>
<pre><code class="language-make">#!/usr/bin/make -f

# åˆ—å‡ºæ‚¨è¦ç·¨è­¯çš„æª”æ¡ˆå’Œç›®éŒ„
export DH_VERBOSE=1

PACKAGE=nginx
UPSTREAM_VERSION=1.22.1

# è¨­ç½®æ‰“åŒ…çš„åƒæ•¸
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

export BUILDDIR_WORK = $(CURDIR)/debian/$(PACKAGE)

export BUILDDIR=$(CURDIR)/debian/tmp

# å®šç¾©å»ºç«‹ç›®éŒ„ï¼Œå®ƒæœƒåœ¨${CURDIR}/debian/$PACKAGEä¸‹å‰µå»º
debian/$PACKAGE::

%:

# buildé˜¶æ®µï¼Œå°†å®Œæˆè½¯ä»¶çš„ç¼–è¯‘
build: 
	tar zxf nginx-$(UPSTREAM_VERSION).tar.gz
	# é…ç½® Nginx ä»¥ä½¿ç”¨å¿…è¦çš„æ¨¡å¡Šå’Œåƒæ•¸
	cd nginx-$(UPSTREAM_VERSION) &amp;&amp; \
	    ./configure \
	    --conf-path=/etc/nginx/nginx.conf \
	    --pid-path=/var/run/nginx \
	    --sbin-path=/usr/sbin/nginx \
	    --http-log-path=/var/log/nginx/error.log \
	    --error-log-path=/var/log/nginx/access.log \
	    --http-client-body-temp-path=/etc/nginx/ \
		--http-proxy-temp-path=/var/run/nginx/ \
		--http-fastcgi-temp-path=/var/run/nginx/ \
		--http-uwsgi-temp-path=/var/run/nginx/ \
		--http-scgi-temp-path=/var/run/nginx/ \
		--pid-path=/var/run/nginx/nginx.pid \
        --with-http_ssl_module \
		--without-http_gzip_module 
	
	cd nginx-$(UPSTREAM_VERSION) &amp;&amp; make
	# è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå³ prefix ä¸ DESTDIR ä¸è¦åŒæ—¶å†™ï¼Œmake install è¢«å®‰è£…åœ¨å“ªé‡Œ
	# å¦‚æœé…ç½®äº†prefix é‚£ä¹ˆåˆ™è¢«å®‰è£…åœ¨ prefix/DESTDIR å˜æˆäº†åŒé‡ç›®å½•
	# è¿™é‡Œä¸é…ç½® prefix åªé…ç½®DESTDIRåˆ™ä¼šè¢«å®‰è£…åœ¨ deb åŒ…åœ¨æ„å»ºæ—¶çš„å·¥ä½œç›®å½•ï¼Œè¿™é‡Œåˆ¶å®šäº†$(BUILDDIR)
	# å°†è¢«æ”¾ç½®åœ¨ $(BUILDDIR)
	cd nginx-$(UPSTREAM_VERSION) &amp;&amp; make install DESTDIR=$(BUILDDIR)

	# æ¸…ç†
	rm -rf nginx-$(UPSTREAM_VERSION)

clean:
	rm -rf nginx-$(UPSTREAM_VERSION)
	rm -rf $(BUILDDIR)
	rm -rf $(BUILDDIR_WORK)

build-indep:
	# æ„å»ºå‰æµ‹è¯•ç›®å½•
	dh_testdir

build-arch:
	dh_testdir

binary-indep:
	dh_testdir
	
	# æµ‹è¯•æ˜¯å¦æœ‰rootæƒé™
	dh_testroot
	
	# åœ¨ binary é˜¶æ®µä¸­ï¼Œæ‰§è¡Œçš„å®‰è£…æ“ä½œï¼Œåˆ›å»º /etc/nginxç›®å½•
	# è¿™äº›å‘½ä»¤æ‰§è¡Œçš„æ˜¯ install -d
	# ä¸ºä»€ä¹ˆä½¿ç”¨ dh tool è€Œä¸ç”¨installï¼Œå› ä¸ºdh toolæ˜¯rules fileçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯ä»–é»˜è®¤çš„å·¥ä½œç›®å½•æ˜¯
	# æ„å»ºdebåŒ…çš„å·¥ä½œç›®å½•ï¼Œè¿™é‡Œå¿…é¡»æ˜¯ç›¸å¯¹ç›®å½•
	# è€Œå¯¹äºç¬¬ä¸€ä¸ªçš„ &quot;/&quot; ä¸ æœ€åä¸€ä¸ª &quot;/&quot; éƒ½ä¸è¦å†™ï¼Œä¼šè¢«è‡ªåŠ¨é™¤è™«ä¸Š
	dh_installdirs etc/nginx
	dh_installdirs var/log/nginx
	dh_installdirs var/run/nginx
	dh_install etc/nginx/* etc/nginx
	dh_install usr/sbin/* usr/sbin
	
	# è¿™é‡Œåˆ›å»ºäº†äºŒè¿›åˆ¶åŒ…çš„ç›®å½•ç»“æ„
	install -d $(BUILDDIR_WORK)/DEBIAN
	
	# dh_gencontrolå¯ä»¥æ ¹æ®æºç åŒ…çš„é…ç½®æ¥ç”ŸæˆäºŒè¿›åˆ¶åŒ…çš„controlæ–‡ä»¶
	# åº•å±‚å°è£…çš„æ˜¯ dh_gencontrol -O --file --package=nginx ä¸ºäºŒè¿›åˆ¶åŒ…ç”Ÿæˆ
	dh_gencontrol -O --file --package=$(PACKAGE)
	
	# dh_installchangelogs å¯ä»¥æ ¹æ®æºç åŒ…ä¸­çš„changelogæ¥ç”ŸæˆäºŒè¿›åˆ¶åŒ…çš„changelog
	# changelog å’Œ control fileæ˜¯äºŒè¿›åˆ¶åŒ…å¿…é¡»çš„æ–‡ä»¶
	# dh_gencontrol -O --file --package=nginx
	# åº•å±‚æ‰§è¡Œçš„ä¸ºåœ¨ deb åŒ…æ ¹ç›®å½•çš„/usr/share/doc/nginx ä¸­ç”Ÿæˆchangelog
	# dh_installchangelogs
	#    install -d debian/nginx/usr/share/doc/nginx
	#    install -p -m0644 debian/changelog debian/nginx/usr/share/doc/nginx/changelog.Debian
	dh_installchangelogs
	
	# è¿™é‡Œå°†ä¿®å¤é“¾æ¥è·¯å¾„åŠå‹ç¼©ï¼Œå¦‚æœä½ çš„ä¸€äº›è½¯è¿æ¥éœ€è¦ä¿®å¤æ—¶å¯ä»¥ä½¿ç”¨
	dh_compress


binary: binary-indep
	# dh_builddebå‘½ä»¤å°†ä¼šæ„å»ºä¸€ä¸ªäºŒè¿›åˆ¶åŒ…
	# dh_builddebå°è£…çš„æ—¶dpkg-debå‘½ä»¤
	#   dpkg-deb --build debian/nginx ..
	dh_builddeb

.PHONY: clean binary-indep binary-arch binary install build
</code></pre>
<h3 id="æ‰§è¡Œæ„å»º">æ‰§è¡Œæ„å»º</h3>
<p>é€šè¿‡æ‰§è¡Œ <code>dpkg-buildpackage -b</code> æ¥æ„å»ºäºŒè¿›åˆ¶æºç åŒ…</p>
<pre><code class="language-log">	install -d debian/nginx/usr/sbin
	cp --reflink=auto -a debian/tmp/usr/sbin/nginx debian/nginx/usr/sbin/
install -d /root/nginx/debian/nginx/DEBIAN
dh_gencontrol -O --file --package=nginx
	dpkg-gencontrol -pnginx -ldebian/changelog -Tdebian/nginx.substvars -Pdebian/nginx
dpkg-gencontrol: warning: unknown information field 'Version' in input data in package's section of control info file
dpkg-gencontrol: warning: unknown information field 'Standards-Version' in input data in package's section of control info file
	chmod 0644 -- debian/nginx/DEBIAN/control
	chown 0:0 -- debian/nginx/DEBIAN/control
dh_installchangelogs
	install -d debian/nginx/usr/share/doc/nginx
	install -p -m0644 debian/changelog debian/nginx/usr/share/doc/nginx/changelog.Debian
dh_compress
	cd debian/nginx
	chmod a-x usr/share/doc/nginx/changelog.Debian
	gzip -9nf usr/share/doc/nginx/changelog.Debian
	cd '/root/nginx'
dh_builddeb
	dpkg-deb --build debian/nginx ..
dpkg-deb: building package 'nginx' in '../nginx_1.22.1-1_amd64.deb'.
 dpkg-genbuildinfo --build=binary
 dpkg-genchanges --build=binary &gt;../nginx_1.22.1-1_amd64.changes
dpkg-genchanges: warning: unknown information field 'Version' in input data in package's section of control info file
dpkg-genchanges: warning: unknown information field 'Standards-Version' in input data in package's section of control info file
dpkg-genchanges: warning: unknown information field 'Build-Depends' in input data in package's section of control info file
dpkg-genchanges: info: binary-only upload (no source code included)
 dpkg-source --after-build .
dpkg-source: warning: unknown information field 'Version' in input data in package's section of control info file
dpkg-source: warning: unknown information field 'Standards-Version' in input data in package's section of control info file
dpkg-source: warning: unknown information field 'Build-Depends' in input data in package's section of control info file
dpkg-buildpackage: info: binary-only upload (no source included)
</code></pre>
<p>æ„å»ºå®Œæˆåï¼Œç”Ÿæˆçš„debåŒ…åœ¨å½“å‰æ‰§è¡Œå‘½ä»¤çš„çˆ¶ç›®å½•ä¸­ï¼Œè€Œç”Ÿæˆçš„æ–‡ä»¶åéµå®ˆäº† <code>&lt;name&gt;_&lt;version&gt;-&lt;revision&gt;_&lt;architecture&gt;.deb</code> è¿™ç§æ ¼å¼</p>
<pre><code class="language-bash">$ dpkg -c ../nginx_1.22.1-1_amd64.deb
./
./etc/
./etc/nginx/
./etc/nginx/fastcgi.conf
./etc/nginx/fastcgi.conf.default
./etc/nginx/fastcgi_params
./etc/nginx/fastcgi_params.default
./etc/nginx/koi-utf
./etc/nginx/koi-win
./etc/nginx/mime.types
./etc/nginx/mime.types.default
./etc/nginx/nginx.conf
./etc/nginx/nginx.conf.default
./etc/nginx/scgi_params
./etc/nginx/scgi_params.default
./etc/nginx/uwsgi_params
./etc/nginx/uwsgi_params.default
./etc/nginx/win-utf
./usr/
./usr/sbin/
./usr/sbin/nginx
./usr/share/
./usr/share/doc/
./usr/share/doc/nginx/
./usr/share/doc/nginx/changelog.Debian.gz
./var/
./var/log/
./var/log/nginx/
./var/run/
./var/run/nginx/
</code></pre>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="no-upstream-tarball-found">no upstream tarball found</h3>
<pre><code>dpkg-source: error: can't build with source format '3.0 (quilt)': no upstream tarball found at ../nginx_1.22.1.orig.tar.{bz2,gz,lzma,xz}
dpkg-buildpackage: error: dpkg-source -b . subprocess returned exit status 2
</code></pre>
<p>è§£å†³ï¼šéœ€è¦å’Œä½ çš„æ„å»ºç›®å½• ä¸ºä¸Šçº§å³ <code>debian</code> çš„ä¸Šçº§</p>
<h3 id="non-native-package-version-does-not-contain-a-revision">non-native package version does not contain a revision</h3>
<pre><code>dpkg-source: error: can't build with source format '3.0 (quilt)': non-native package version does not contain a revision
</code></pre>
<p>è§£å†³ï¼šåœ¨changelogä¸­å®šä¹‰æ­£ç¡®çš„ä¿®è®¢å·</p>
<p>Debian è½¯ä»¶åŒ…ç‰ˆæœ¬å·ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼šMajor.Minor.Revisionï¼Œå®ƒä»¬é€šå¸¸å®šä¹‰åœ¨è½¯ä»¶åŒ…çš„ debian/changelog æ–‡ä»¶ä¸­ã€‚</p>
<p>åœ¨ debian/changelog æ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªè½¯ä»¶åŒ…ç‰ˆæœ¬éƒ½ä¼šè®°å½•ä¸‹æ¥ï¼ŒåŒ…æ‹¬è½¯ä»¶åŒ…çš„ç‰ˆæœ¬å·ã€æ„å»ºæ—¥æœŸå’Œæ„å»ºè€…çš„å§“åå’Œç”µå­é‚®ä»¶ç­‰ä¿¡æ¯ï¼Œå½¢æˆä¸€ä¸ªæ—¶é—´çº¿ã€‚æ¯ä¸ª Debian è½¯ä»¶åŒ…ç‰ˆæœ¬å·åº”è¯¥éµå¾ª X.Y.Z-r (æˆ– X.Y.Z~rN) çš„æ ¼å¼ï¼Œå…¶ä¸­ X.Y.Z æ˜¯è½¯ä»¶åŒ…çš„ç‰ˆæœ¬å·ï¼Œr (æˆ– N) æ˜¯è½¯ä»¶åŒ…çš„ä¿®è®¢å·ã€‚</p>
<p>ç”¨äºç‰ˆæœ¬å·çš„changelogæ–‡ä»¶é€šå¸¸ä½äºè½¯ä»¶åŒ…æºä»£ç çš„ debian/ ç›®å½•ä¸­ã€‚æ‚¨å¯ä»¥æ‰“å¼€ debian/changelog æ–‡ä»¶ï¼Œæ‰¾åˆ°æœ€è¿‘çš„æ¡ç›®ï¼Œå°†å…¶ä¸­çš„ç‰ˆæœ¬å·ä¸­çš„ä¿®è®¢å·ä¿®æ”¹ä¸ºæ‰€éœ€çš„å€¼ï¼Œå¹¶ä¿å­˜æ–‡ä»¶ã€‚åœ¨å¯¹ Debian è½¯ä»¶åŒ…è¿›è¡Œé‡æ–°æ‰“åŒ…ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ›´æ–°äº† debian/changelog æ–‡ä»¶ï¼Œä»¥ä¾¿åæ˜ æ–°ç‰ˆæœ¬å·çš„ä¿®æ”¹ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æ‚¨æ›´æ”¹ debian/changelog æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·æ—¶ï¼Œè¯·ç¡®ä¿æ›´æ–° debian/control æ–‡ä»¶ä¸­çš„è½¯ä»¶åŒ…ç‰ˆæœ¬ä¾èµ–ä¿¡æ¯ï¼Œä»¥ä¾¿ä¸æ–°çš„è½¯ä»¶åŒ…ç‰ˆæœ¬å·åŒ¹é…ã€‚ è¿™æ˜¯ä¸ºäº†ç¡®ä¿è½¯ä»¶åŒ…ä¾èµ–å…³ç³»ä¸å®é™…çš„è½¯ä»¶åŒ…ç‰ˆæœ¬ç›¸åŒ¹é…ï¼Œé¿å…åœ¨å®‰è£…å’Œä½¿ç”¨è½¯ä»¶åŒ…æ—¶å‡ºç°é—®é¢˜ã€‚</p>
<h3 id="is-not-a-valid-version">is not a valid version</h3>
<pre><code>dpkg-genchanges: error:  is not a valid version
</code></pre>
<p>è§£å†³ï¼šè¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºåˆ¶å®šäº† -v é‡å†™äº† version é…ç½®ï¼Œè€Œæ²¡æœ‰æŒ‡å®šå…·ä½“çš„ç‰ˆæœ¬å·</p>
<h3 id="yes-is-invalid-use-binary-targets-instead">&ldquo;yes&rdquo; is invalid; use &ldquo;binary-targets&rdquo; instead</h3>
<pre><code class="language-bash">dpkg-buildpackage: error: Rules-Requires-Root field keyword &quot;yes&quot; is invalid; use &quot;binary-targets&quot; instead
</code></pre>
<p>è§£å†³ï¼šcontrol æ–‡ä»¶çš„ <code>Rules-Requires-Root</code> æ²¡æœ‰yesé€‰é¡¹ <sup><a id="8">[8]</a></sup></p>
<h3 id="compatibility-levels-before-5-are-no-longer-supported-level-1-requested">Compatibility levels before 5 are no longer supported (level 1 requested)</h3>
<pre><code class="language-bash">dh: error: Compatibility levels before 5 are no longer supported (level 1 requested)
</code></pre>
<p>è¿™ä¸ªé”™è¯¯æç¤ºæ˜¯ç”±äº Debian Policy ä» 3.9.0 å¼€å§‹ä¸å†æ”¯æŒ compat level 4 ä»¥åŠæ›´ä½çº§åˆ«çš„è®¾ç½®ï¼Œéœ€è¦ä½¿ç”¨ç¬¦åˆ Debian Policy 3.9.0 æˆ–æ›´é«˜ç‰ˆæœ¬çš„è§„èŒƒå®šä¹‰åŒ…ã€‚</p>
<p>å¦‚æœæ‚¨åœ¨ <code>debian/control</code> æ–‡ä»¶ä¸­è®¾ç½®äº† compatibility level è¾ƒä½çš„ç‰ˆæœ¬ï¼ˆå¦‚ 3, 4ï¼‰ï¼Œåˆ™ä¼šé‡åˆ°è¿™ä¸ªé”™è¯¯ã€‚æ‚¨éœ€è¦å°†è¿™ä¸ª compatibility level æå‡è‡³ 5 æˆ–ä»¥ä¸Šç‰ˆæœ¬ï¼Œå³åœ¨ <code>debian/control</code> æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹è®¾ç½®ï¼š</p>
<h3 id="unwanted-binary-file-debiandebiandeb">unwanted binary file: debian/debian.deb</h3>
<pre><code class="language-bash">dpkg-source: error: unwanted binary file: debian/debian.deb
dpkg-source: error: detected 1 unwanted binary file (add it in debian/source/include-binaries to allow its inclusion).
dpkg-buildpackage: error: dpkg-source -b . subprocess returned exit status 255
</code></pre>
<p>è§£å†³ï¼šåˆ é™¤ä¸Šçº§ç›®å½•ä¸­å¤šä½™æ–‡ä»¶å³å¯</p>
<h3 id="cannot-represent-change-to-xauthority-binary-file-contents-changed">cannot represent change to .Xauthority: binary file contents changed</h3>
<pre><code class="language-bash">dpkg-source: error: cannot represent change to .Xauthority: binary file contents changed
dpkg-source: error: add .Xauthority in debian/source/include-binaries if you want to store the modified binary in the debian tarball
dpkg-source: error: unrepresentable changes to source
</code></pre>
<p>è§£å†³ï¼šè¿™æ˜¯å› ä¸ºæˆ‘ç›´æ¥åœ¨å®¶ç›®å½•æ“ä½œçš„ï¼Œå®¶ç›®å½•å­˜åœ¨ä¸€äº›å…¶ä»–æ–‡ä»¶ï¼Œå¦‚å®¶ç›®å½•ä¸‹çš„éšè—æ–‡ä»¶</p>
<h2 id="reference">Reference</h2>
<p><sup id="1">[1]</sup> <a href="https://www.debian.org/doc/debian-policy/ch-controlfields.html#rules-requires-root" target="_blank"
   rel="noopener nofollow noreferrer" ><em>rules-requires-root</em></a></p>
<p><sup id="2">[2]</sup> <a href="https://www.debian.org/doc/debian-policy/ch-controlfields.html" target="_blank"
   rel="noopener nofollow noreferrer" ><em>Control files and their fields</em></a></p>
<p><sup id="3">[3]</sup> <a href="https://zh.wikipedia.org/wiki/Ar_%28Unix%29" target="_blank"
   rel="noopener nofollow noreferrer" ><em>ar (Unix)</em></a></p>
<p><sup id="4">[4]</sup> <a href="https://www.debian.org/doc/debian-policy/index.html" target="_blank"
   rel="noopener nofollow noreferrer" ><em>Debian Policy Manual</em></a></p>
<p><sup id="5">[5]</sup> <a href="https://www.debian.org/doc/debian-policy/ch-source.html#main-building-script-debian-rules" target="_blank"
   rel="noopener nofollow noreferrer" ><em>Main building script</em></a></p>
<p><sup id="6">[6]</sup> <a href="https://man7.org/linux/man-pages/man7/debhelper.7.html" target="_blank"
   rel="noopener nofollow noreferrer" ><em>debhelper(7)</em></a></p>
<p><sup id="7">[7]</sup> <a href="https://github.com/FooBarWidget/debian-packaging-for-the-modern-developer/blob/master/tutorial-2/README.md#debianrules" target="_blank"
   rel="noopener nofollow noreferrer" ><em>Tutorial 2: building a binary package using dpkg-buildpackage</em></a></p>
<p><sup id="8">[8]</sup> <a href="https://www.debian.org/doc/debian-policy/ch-controlfields.html#rules-requires-root" target="_blank"
   rel="noopener nofollow noreferrer" ><em>5.6.31. Rules-Requires-Root</em></a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>é•¿æœŸæ€»ç»“ - Linuxæ€§èƒ½åˆ†æå‘½ä»¤</title>
      <link>https://www.oomkill.com/2022/12/performance-command/</link>
      <pubDate>Mon, 12 Dec 2022 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2022/12/performance-command/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="perf-supa-href11asup">perf <sup><a href="#1">[1]</a></sup></h2>
<p><em><strong>perf</strong></em> æ˜¯åŸºäºå†…æ ¸å­ç³»ç»Ÿçš„Linuxçš„æ€§èƒ½è®¡æ•°å™¨ï¼Œä¹Ÿè¢«ç§°ä¸º <em><strong>perf_events</strong></em>ï¼Œå®ƒæä¾›äº†ä¸ºæ‰€æœ‰äº‹ä»¶è¿›è¡Œæ€§èƒ½åˆ†æçš„æ¡†æ¶ï¼Œ<em><strong>perf</strong></em> ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>å†…æ ¸ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨äºæä¾›å¯¹è¿™äº›æ€§èƒ½æ•°æ®çš„è®¿é—®</li>
<li>ç”¨æˆ·ç©ºé—´å·¥å…·ï¼Œç”¨äºæä¾›æ”¶é›†ï¼Œæ˜¾ç¤ºåˆ†æè¿™äº›æ€§èƒ½æ•°æ®çš„ç”¨æˆ·ç©ºé—´ç¨‹åº</li>
</ul>
<p>ç”±äº perf æ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œä½†è¦æƒ³ä½¿ç”¨ perf è¿˜éœ€è¦å®‰è£…å¦å¤–ä¸€éƒ¨åˆ†ï¼Œé€šå¸¸æƒ…å†µä¸‹å®‰è£…çš„ç‰ˆæœ¬æ˜¯Linuxå†…æ ¸ç‰ˆæœ¬ï¼Œå¦‚æ“ä½œç³»ç»Ÿå†…æ ¸ç‰ˆæœ¬ä¸º 5.10 é‚£ä¹ˆå®‰è£… linux-tool ååˆ™ä¸º 5.10</p>
<pre><code class="language-bash">$ apt-get install linux-perf

$ perf --version
perf version 5.10.149
</code></pre>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian: <code>linux-perf | linux-tools</code>  ï¼›<code>apt-get install linux-perf</code></li>
<li>CentOS/Fedora:  <code>perf </code> ï¼›<code>yum install -y perf</code></li>
</ul>
<h3 id="list---åˆ—å‡ºå¯ç”¨äº‹ä»¶æè¿°ç¬¦">list - åˆ—å‡ºå¯ç”¨äº‹ä»¶æè¿°ç¬¦</h3>
<p>ä½¿ç”¨ perf å­å‘½ä»¤ <code>list</code>  å¯ä»¥åˆ—å‡ºæ‰€æœ‰çš„ perf å¯æµ‹é‡äº‹ä»¶</p>
<pre><code class="language-bash">perf list

List of pre-defined events (to be used in -e):

  branch-instructions OR branches                    [Hardware event]
  branch-misses                                      [Hardware event]
  cache-misses                                       [Hardware event]
  cache-references                                   [Hardware event]
  cpu-cycles OR cycles                               [Hardware event]
  instructions                                       [Hardware event]
  stalled-cycles-backend OR idle-cycles-backend      [Hardware event]
  stalled-cycles-frontend OR idle-cycles-frontend    [Hardware event]

  alignment-faults                                   [Software event]
  bpf-output                                         [Software event]
  context-switches OR cs                             [Software event]
  cpu-clock                                          [Software event]
  cpu-migrations OR migrations                       [Software event]
  dummy                                              [Software event]
  emulation-faults                                   [Software event]
  major-faults                                       [Software event]
  minor-faults                                       [Software event]
  page-faults OR faults                              [Software event]
  task-clock                                         [Software event]

  duration_time                                      [Tool event]

  L1-dcache-load-misses                              [Hardware cache event]
  L1-dcache-loads                                    [Hardware cache event]
  L1-dcache-prefetches                               [Hardware cache event]
  L1-icache-load-misses                              [Hardware cache event]
  L1-icache-loads                                    [Hardware cache event]
  branch-load-misses                                 [Hardware cache event]
  branch-loads                                       [Hardware cache event]
  dTLB-load-misses                                   [Hardware cache event]
  dTLB-loads                                         [Hardware cache event]
  iTLB-load-misses                                   [Hardware cache event]
  iTLB-loads                                         [Hardware cache event]
</code></pre>
<p>list å­å‘½ä»¤åè¿˜å¯ä»¥åŠ è¿‡æ»¤å™¨ä»¥æŸ¥çœ‹å¯¹åº”ç±»å‹çš„äº‹ä»¶ï¼Œç¤ºä¾‹ï¼š</p>
<pre><code class="language-bash"># åˆ—å‡ºTCPç›¸å…³äº‹ä»¶
$ perf list tcp

List of pre-defined events (to be used in -e):


  syscalls:sys_enter_getcpu                          [Tracepoint event]
  syscalls:sys_exit_getcpu                           [Tracepoint event]
  tcp:tcp_destroy_sock                               [Tracepoint event]
  tcp:tcp_probe                                      [Tracepoint event]
  tcp:tcp_rcv_space_adjust                           [Tracepoint event]
  tcp:tcp_receive_reset                              [Tracepoint event]
  tcp:tcp_retransmit_skb                             [Tracepoint event]
  tcp:tcp_retransmit_synack                          [Tracepoint event]
  tcp:tcp_send_reset                                 [Tracepoint event]

# åˆ—å‡ºbpfç›¸å…³äº‹ä»¶
$ perf list bpf

List of pre-defined events (to be used in -e):

  bpf-output                                         [Software event]


  bpf_test_run:bpf_test_finish                       [Tracepoint event]
  bpf_trace:bpf_trace_printk                         [Tracepoint event]
  syscalls:sys_enter_bpf                             [Tracepoint event]
  syscalls:sys_exit_bpf                              [Tracepoint event]

# åˆ—å‡ºç¡¬ä»¶ç›¸å…³äº‹ä»¶
$ perf list hardware

List of pre-defined events (to be used in -e):

  branch-instructions OR branches                    [Hardware event]
  branch-misses                                      [Hardware event]
  cache-misses                                       [Hardware event]
  cache-references                                   [Hardware event]
  cpu-cycles OR cycles                               [Hardware event]
  instructions                                       [Hardware event]
  stalled-cycles-backend OR idle-cycles-backend      [Hardware event]
  stalled-cycles-frontend OR idle-cycles-frontend    [Hardware event]
</code></pre>
<h3 id="top---æŸ¥çœ‹ç³»ç»Ÿå®æ—¶ä¿¡æ¯">top - æŸ¥çœ‹ç³»ç»Ÿå®æ—¶ä¿¡æ¯</h3>
<p>perf çš„ topå­å‘½ä»¤å¯ä»¥æŸ¥çœ‹CPUçš„å®æ—¶ä¿¡æ¯</p>
<pre><code class="language-bash">$ perf top
  23.69%  [kernel]          [k] mpt_put_msg_frame
  14.27%  [kernel]          [k] read_tsc
  13.34%  [kernel]          [k] asm_sysvec_apic_timer_interrupt
  11.72%  [kernel]          [k] vmware_sched_clock
   5.79%  perf_5.10         [.] 0x00000000002901f4
   5.11%  [kernel]          [k] delay_tsc
   4.87%  [kernel]          [k] native_read_msr
   4.57%  perf_5.10         [.] 0x0000000000284c2d
   3.13%  perf_5.10         [.] 0x0000000000284c1a
   3.09%  [kernel]          [k] native_write_msr
   2.07%  [kernel]          [k] s_show
   1.99%  [kernel]          [k] mpt_interrupt
   1.82%  perf_5.10         [.] 0x0000000000284d46
   1.69%  [kernel]          [k] asm_sysvec_call_function_single
   0.86%  [kernel]          [k] __es_tree_search.isra.0
   0.83%  [kernel]          [k] security_task_free
   0.78%  [vdso]            [.] 0x0000000000000698
   0.38%  perf_5.10         [.] 0x0000000000284d57
</code></pre>
<p>ä¸Šé¢çš„ä¿¡æ¯çš„å±•ç¤ºç±»ä¼¼äº <code>top</code> å‘½ä»¤ï¼Œä»å·¦å³åˆ°ä¿¡æ¯ä¸ºï¼š</p>
<ul>
<li>ç¬¬ä¸€åˆ—ï¼šä¸CPUä½¿ç”¨ç‡ç™¾åˆ†æ¯”å ç”¨çš„ç›¸å…³å‡½æ•°</li>
<li>ç¬¬äºŒåˆ—ï¼šé‚£ä¸ªåº“æˆ–è€…è¿›ç¨‹ä½¿ç”¨çš„è¿™ä¸ªå‡½æ•°</li>
<li>ç¬¬ä¸‰åˆ—ï¼š<strong>[k]</strong> è¡¨ç¤ºå†…æ ¸ç©ºé—´ï¼Œ <strong>[.]</strong> è¡¨ç¤ºç”¨æˆ·ç©ºé—´</li>
<li>ç¬¬å››åˆ—ï¼šç¬¦å·æˆ–å‡½æ•°çš„åç§°</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ <code>perf top</code> ç›‘æ§çš„æ˜¯æ‰€æœ‰CPUï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å­é€‰é¡¹ï¼Œä¾‹å¦‚ä¸‹è¡¨ï¼ˆä¸€äº›å¸¸ç”¨çš„å‘½ä»¤å‚æ•°ï¼‰</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>describe</th>
</tr>
</thead>
<tbody>
<tr>
<td>-a</td>
<td>ç›‘æ§æ‰€æœ‰CPUåŒ…å«ç©ºé—²å€¼</td>
</tr>
<tr>
<td>-c</td>
<td>æ”¶é›†</td>
</tr>
<tr>
<td>-C</td>
<td>æ”¶é›†æŒ‡å®šCPUçš„æ ·æœ¬ï¼Œåæ¥CPUæ ¸å¿ƒç¼–å·</td>
</tr>
<tr>
<td>-d</td>
<td>åæ¥æ•°å­—ï¼Œå°†å»¶è¿Ÿå‡ ç§’åˆ·æ–°</td>
</tr>
<tr>
<td>-e</td>
<td>æŒ‡å®šç‰¹æ®Šçš„äº‹ä»¶ï¼Œäº‹ä»¶é€šè¿‡ <code>perf list</code> æŸ¥çœ‹</td>
</tr>
<tr>
<td>-F</td>
<td>æ§åˆ¶é‡‡æ ·çš„é¢‘ç‡</td>
</tr>
<tr>
<td>-p</td>
<td>æŒ‡å®šPIDçš„è¿›ç¨‹çš„äº‹ä»¶ä¿¡æ¯</td>
</tr>
<tr>
<td>-g</td>
<td>å¯ç”¨ æ˜¾ç¤ºè°ƒç”¨å›¾è®°å½•</td>
</tr>
<tr>
<td>-i</td>
<td>ä¸ç»§æ‰¿æ¨¡å¼ï¼Œå­ä»»åŠ¡å°†ä¸ç»§æ‰¿è®¡æ•°å™¨</td>
</tr>
<tr>
<td>-t</td>
<td>æŒ‡å®šçº¿ç¨‹IDçš„äº‹ä»¶ä¿¡æ¯</td>
</tr>
<tr>
<td>-u</td>
<td>æŒ‡å®šuserçš„äº‹ä»¶ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<p>æ›´å¤šé€‰é¡¹å¯ä»¥ä½¿ç”¨ <code>perf top -h</code></p>
<h3 id="stat---cpuç›¸å…³ç»Ÿè®¡">stat - CPUç›¸å…³ç»Ÿè®¡</h3>
<p>ä½¿ç”¨ perf å­å‘½ä»¤ <code>stat</code>  å¯ä»¥å¯¹æŒ‡å®šå‘½ä»¤çš„CPUæ€§èƒ½ç»Ÿè®¡</p>
<pre><code class="language-bash">perf stat &lt;commond&gt;
</code></pre>
<p><strong>æŸ¥çœ‹æŒ‡å®šå‘½ä»¤çš„CPUè®¡æ•°å™¨ç»Ÿè®¡ä¿¡æ¯</strong></p>
<pre><code class="language-bash">perf stat &lt;command&gt;
# å¦‚æœéœ€è¦æ›´è¯¦ç»†ä¿¡æ¯å¯ä»¥è·Ÿ -d é€‰é¡¹
perf stat -d &lt;command&gt;
</code></pre>
<p>ç¤ºä¾‹</p>
<pre><code class="language-bash">$ perf stat curl baidu.com

 Performance counter stats for 'curl baidu.com':

             31.09 msec task-clock                #    0.012 CPUs utilized          
                27      context-switches          #    0.868 K/sec                  
                 1      cpu-migrations            #    0.032 K/sec                  
               577      page-faults               #    0.019 M/sec                  
        41,691,320      cycles                    #    1.341 GHz                      (17.63%)
                 0      stalled-cycles-frontend                                     
                 0      stalled-cycles-backend    #    0.00% backend cycles idle    
                 0      instructions              #    0.00  insn per cycle           (82.37%)
     &lt;not counted&gt;      branches                                                      (0.00%)
     &lt;not counted&gt;      branch-misses                                                 (0.00%)

       2.646439514 seconds time elapsed

       0.026403000 seconds user
       0.013201000 seconds sys


Some events weren't counted. Try disabling the NMI watchdog:
	echo 0 &gt; /proc/sys/kernel/nmi_watchdog
	perf stat ...
	echo 1 &gt; /proc/sys/kernel/nmi_watchdog
</code></pre>
<p><strong>æŸ¥çœ‹æŒ‡å®šPIDçš„CPUè®¡æ•°å™¨ç»Ÿè®¡ä¿¡æ¯</strong></p>
<p>ç»Ÿè®¡å‘½ä»¤å°†ä¼šç›´åˆ° ctrl - c ç»“æŸ</p>
<pre><code class="language-bash">perf stat -p &lt;PID&gt; 
</code></pre>
<p>ç¤ºä¾‹ï¼šä¾‹å¦‚ç»Ÿè®¡ä¸€ä¸ªè¿›ç¨‹çš„CPUä½¿ç”¨æƒ…å†µ</p>
<pre><code class="language-bash">perf stat -p 477
^C
 Performance counter stats for process id '477':

            146.96 msec task-clock                #    0.034 CPUs utilized          
                88      context-switches          #    0.599 K/sec                  
                 8      cpu-migrations            #    0.054 K/sec                  
             4,991      page-faults               #    0.034 M/sec                  
       153,052,247      cycles                    #    1.041 GHz                      (36.77%)
                 0      stalled-cycles-frontend                                       (50.31%)
                 0      stalled-cycles-backend    #    0.00% backend cycles idle      (57.94%)
                 0      instructions              #    0.00  insn per cycle           (63.23%)
                 0      branches                  #    0.000 K/sec                    (49.69%)
                 0      branch-misses             #    0.00% of all branches          (42.06%)

       4.336415211 seconds time elapsed
</code></pre>
<p><strong>åªç»Ÿè®¡ç¼“å­˜ä¿¡æ¯</strong></p>
<pre><code class="language-bash">perf stat -e LLC-loads,LLC-load-misses,LLC-stores,LLC-prefetches
</code></pre>
<ul>
<li>LLC <em><strong>last-level cache</strong></em> æ˜¯æŒ‡å†…å­˜åˆ†å±‚ç»“æ„ä¸­ä¸»å†…å­˜ä¹‹å‰çš„æœ€åä¸€çº§</li>
<li>LLC-loadsï¼šå‘½ä¸­çš„æŒ‡æ ‡</li>
<li>LLC-load-missesï¼šæœªå‘½ä¸­æŒ‡æ ‡ï¼Œæ˜¾ç¤ºè¿™ä¸ªå‘¨æœŸå†…å°šæœªå¤„ç†çš„æ¯”ç‡</li>
<li>LLC-stores</li>
<li>LLC-prefetchesï¼šäº‹ä»¶å‘ç”Ÿåœ¨çš„ L2 ç¡¬ä»¶é¢„å–ä¸­</li>
</ul>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="language-bash"># ä½¿ç”¨åŸå§‹ PMC è®¡æ•°å™¨ï¼Œä¾‹å¦‚ï¼Œè®¡ç®—æœªæš‚åœçš„æ ¸å¿ƒå‘¨æœŸï¼š 

# ä½¿ç”¨åŸå§‹PMCè®¡æ•°å™¨ï¼Œä¾‹å¦‚ï¼Œè®¡æ•°æœªæ”¹å˜çš„æ ¸å¿ƒå‘¨æœŸ:
perf stat -e r003c -a sleep 5 

# ç»Ÿè®¡ç³»ç»ŸèŒƒå›´å†…æ¯ç§’çš„ç³»ç»Ÿè°ƒç”¨ï¼š 
perf stat -e cycles -e cpu/event=0x0e,umask=0x01,inv,cmask=0x01/ -a sleep 5 

# ç»Ÿè®¡ç³»ç»ŸèŒƒå›´å†…æ¯ç§’çš„ç³»ç»Ÿè°ƒç”¨ï¼š
perf stat -e raw_syscalls:sys_enter -I 1000 -a 

# æŒ‰ç±»å‹è®¡ç®—æŒ‡å®šPIDçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç›´åˆ°Ctrl-Cç»“æŸ
perf stat -e 'syscalls:sys_enter_*' -p &lt;PID&gt; 

# æŒ‰ç±»å‹ç»Ÿè®¡æ•´ä¸ªç³»ç»ŸèŒƒå›´å†…çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒæŒç»­ 5 ç§’ï¼š 
perf stat -e 'syscalls:sys_enter_*' -a sleep 5 

# æŒ‰ç±»å‹è®¡æ•°æ•´ä¸ªç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ï¼ŒæŒç»­5ç§’:
perf stat -e 'syscalls:sys_enter_*' -a sleep 5

# è®°å½•æŒ‡å®šPIDè¿›ç¨‹çš„è°ƒåº¦å™¨äº‹ä»¶ç›´åˆ°Ctrl-Cç»“æŸ
perf stat -e 'sched:*' -p PID

# è®°å½•æŒ‡å®šPIDè¿›ç¨‹çš„è°ƒåº¦å™¨äº‹ä»¶ï¼ŒæŒç»­10s
perf stat -e 'sched:*' -p PID sleep 10

# è®°å½•æ•´ä¸ªç³»ç»Ÿå†…çš„ext4äº‹ä»¶ï¼ŒæŒç»­10s
perf stat -e 'ext4:*' -a sleep 10

# ç»Ÿè®¡æ•´ä¸ªç³»ç»Ÿçš„å—è®¾å¤‡ I/O äº‹ä»¶ï¼ŒæŒç»­10s
perf stat -e 'block:*' -a sleep 10

# ç»Ÿè®¡æ‰€æœ‰ vmscan äº‹ä»¶ï¼Œæ¯ç§’æ‰“å°ä¸€ä»½æŠ¥å‘Šï¼š
perf stat -e 'vmscan:*' -a -I 1000
</code></pre>
<h3 id="record---å°†cpuäº‹ä»¶è®°å½•åˆ°æ–‡ä»¶">record - å°†CPUäº‹ä»¶è®°å½•åˆ°æ–‡ä»¶</h3>
<p><strong>å¯¼å‡ºäº‹ä»¶è®°å½•åˆ°æ–‡ä»¶</strong></p>
<p>perfçš„å­å‘½ä»¤ <code>record</code> æ˜¯å¯ä»¥å°†äº‹ä»¶è®°å½•åˆ° perf.dataï¼Œä¾‹å¦‚è¦CPUå‘¨æœŸäº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨recordå­å‘½ä»¤å¹¶é€šè¿‡ tag <code>-e</code> æ¥æŒ‡å®šäº‹ä»¶åç§°</p>
<pre><code class="language-bash"># é€šè¿‡perf list å¯ä»¥çœ‹å‡º CPUå‘¨æœŸäº‹ä»¶ä¸º cpu-cycles OR cycles
perf record -e cycles sleep 10
</code></pre>
<p><strong>é€šè¿‡æŸ¥çœ‹æ–‡ä»¶çš„è®°å½•</strong></p>
<p>ç»“æœå°†ä¿å­˜åˆ° perf.data æ–‡ä»¶ä¸­ï¼Œå¦‚æœéœ€è¦æŸ¥çœ‹ perf.data éœ€è¦ä½¿ç”¨å­å‘½ä»¤ <code>report</code> æŸ¥çœ‹ï¼Œreport å­å‘½ä»¤é»˜è®¤æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹çš„ perf.data æ–‡ä»¶ï¼Œå¦‚æœéœ€è¦æŒ‡å®šç‰¹å®šç›®å½•çš„éœ€è¦ä½¿ç”¨tag <code>-i</code></p>
<pre><code class="language-bash">perf report -i ./perf.data
</code></pre>
<p><strong>ä¿®æ”¹æ ·æœ¬æ–‡ä»¶è¾“å‡ºçš„ç»“æœæ ¼å¼</strong></p>
<p>report å­å‘½ä»¤ä¹Ÿå¯ä»¥æ”¹å˜è¦æ˜¾ç¤ºçš„ç»“æœæ ·å¼ï¼Œä¾‹å¦‚æƒ³è¾“å‡ºä¸ºæ ‡å‡†è¾“å‡ºï¼Œå¯ä»¥ä½¿ç”¨ <code>--stdio</code></p>
<pre><code class="language-bash">$ perf report --stdio
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 18  of event 'cycles'
# Event count (approx.): 440
#
# Overhead  Command  Shared Object      Symbol              
# ........  .......  .................  ....................
#
    90.91%  sleep    [kernel.kallsyms]  [k] native_write_msr
     9.09%  perf_5.  [kernel.kallsyms]  [k] native_write_msr


#
# (Tip: Order by the overhead of source file name and line number: perf report -s srcline)
#
</code></pre>
<p>å¦‚æœæƒ³æ˜¾ç¤ºäº‹ä»¶çš„ç¼–å·ä»¥åŠå¯¹ç‰¹å®šåˆ—æ’åºå¯ä»¥ä½¿ç”¨ä¸‹é¢åŸŸå</p>
<pre><code class="language-bash">$ perf report -n --sort comm,symbol --stdio
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 18  of event 'cycles'
# Event count (approx.): 440
#
# Overhead       Samples  Command  Symbol                IPC   [IPC Coverage]
# ........  ............  .......  ....................  ....................
#
    90.91%             9  sleep    [k] native_write_msr  -      -            
     9.09%             9  perf_5.  [k] native_write_msr  -      -            


#
# (Tip: Show current config key-value pairs: perf config --list)
#
</code></pre>
<h3 id="script---traceåšäº†ä»€ä¹ˆ">script - traceåšäº†ä»€ä¹ˆ</h3>
<p>perf å­å‘½ä»¤ script å¯ä»¥trace perf.data ä¸­æ‰€æœ‰çš„äº‹ä»¶ï¼›ä¾‹å¦‚ä¸Šé¢çš„ perf.data æœ€ç»ˆä¸¤ä¸ªäº‹ä»¶å±•å¼€ä¸º</p>
<p>perf script å­å‘½ä»¤ä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªåæœŸå¤„ç†æ•°æ®çš„ä¸€ä¸ªå‘½ä»¤</p>
<pre><code class="language-bash">$ perf script 
       perf_5.10  2730 28762.537401:          1 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.537540:          1 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.537670:          1 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.537798:          2 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.537901:          3 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.538003:          4 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.538105:          6 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.538207:          9 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
       perf_5.10  2730 28762.538320:         13 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.542839:         26 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.543041:         26 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.543233:         26 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.543421:         30 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.543558:         35 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.543683:         41 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.543806:         53 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.543929:         70 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
           sleep  2730 28772.544065:         93 cycles:  ffffffffbd46b466 native_write_msr+0x6 ([kernel.kallsyms])
</code></pre>
<p>è¾“å‡ºæ˜¾ç¤ºæ–‡ä»¶çš„å¤´ä¿¡æ¯ï¼Œä¾‹å¦‚è·Ÿè¸ªä½•æ—¶å¼€å§‹ã€æŒç»­äº†å¤šé•¿æ—¶é—´ã€CPUä¿¡æ¯ä»¥åŠè·å–æ•°æ®çš„å‘½ä»¤ã€‚ äº‹ä»¶åˆ—è¡¨åœ¨å¤´ä¿¡æ¯ä¹‹åã€‚</p>
<p><strong>æ˜¾ç¤ºtraceçš„å¤´ä¿¡æ¯</strong></p>
<p>ä½¿ç”¨tag <code>--header</code> å¯ä»¥æ˜¾ç¤ºæ–‡ä»¶çš„å¤´ä¿¡æ¯ï¼Œä¾‹å¦‚è·Ÿä½•æ—¶å¼€å§‹traceã€æŒç»­çš„äº‹ä»¶ã€CPUä¿¡æ¯ä»¥åŠè·å–æ•°æ®çš„å‘½ä»¤ã€‚ äº‹ä»¶åˆ—è¡¨åœ¨å¤´ä¿¡æ¯ä¹‹åã€‚äº‹ä»¶å¤´ä¿¡æ¯æ˜¯ç”± <code># ========</code> åŒ…å«è‘—çš„ä¿¡æ¯</p>
<pre><code class="language-bash"># ========
# captured on    : Tue Dec  6 04:44:38 2022
# header version : 1
# data offset    : 256
# data size      : 11528
# feat offset    : 11784
# hostname : debian-template
# os release : 5.10.0-16-amd64
# perf version : 5.10.149
# arch : x86_64
# nrcpus online : 2
# nrcpus avail : 2
# cpudesc : AMD Ryzen 7 5800U with Radeon Graphics
# cpuid : AuthenticAMD,25,80,0
# total memory : 1996352 kB
# cmdline : /usr/bin/perf_5.10 record -e cycles sleep 10 
# event : name = cycles, , id = { 471, 472 }, size = 120, { sample_period, sample_freq } = 2250, sample_type = IP|TID|TIME|PERIOD, read_forma&gt;
# CPU_TOPOLOGY info available, use -I to display
# NUMA_TOPOLOGY info available, use -I to display
# pmu mappings: software = 1, power = 9, uprobe = 7, cpu = 4, breakpoint = 5, tracepoint = 2, kprobe = 6, msr = 8
# CACHE info available, use -I to display
# time of first sample : 28762.537401
# time of last sample : 28772.544065
# sample duration :  10006.663 ms
# MEM_TOPOLOGY info available, use -I to display
# bpf_prog_info 3: bpf_prog_47dd357395126b0c addr 0xffffffffc00eb59c size 309
# bpf_prog_info 4: bpf_prog_6deef7357e7b4530 addr 0xffffffffc00f2168 size 54
# bpf_prog_info 5: bpf_prog_6deef7357e7b4530 addr 0xffffffffc00f40e0 size 54
# bpf_prog_info 6: bpf_prog_b73cbcf8b8c71a5b addr 0xffffffffc02591c8 size 307
# bpf_prog_info 7: bpf_prog_6deef7357e7b4530 addr 0xffffffffc025b584 size 54
# bpf_prog_info 8: bpf_prog_6deef7357e7b4530 addr 0xffffffffc025db10 size 54
# bpf_prog_info 9: bpf_prog_ee0e253c78993a24 addr 0xffffffffc0534640 size 255
# bpf_prog_info 10: bpf_prog_ce28cc67158d681f addr 0xffffffffc04947f0 size 447
# bpf_prog_info 11: bpf_prog_6deef7357e7b4530 addr 0xffffffffc052fe4c size 54
# bpf_prog_info 12: bpf_prog_6deef7357e7b4530 addr 0xffffffffc0531224 size 54
# cpu pmu capabilities: max_precise=0
# missing features: TRACING_DATA BRANCH_STACK GROUP_DESC AUXTRACE STAT CLOCKID DIR_FORMAT COMPRESSED CLOCK_DATA 
# ========
</code></pre>
<p><strong>å¯¼å‡º16è¿›åˆ¶çš„åŸç”Ÿæ•°æ®</strong></p>
<p>å¯¼å‡ºåŸç”Ÿæ•°æ®æ˜¯ASIICæ ¼å¼äº‹ä»¶ä¿¡æ¯</p>
<pre><code class="language-bash">$ perf script -D
0x100 [0x50]: event: 1
.
. ... raw event: size 80 bytes
.  0000:  01 00 00 00 01 00 50 00 ff ff ff ff 00 00 00 00  ......P.........
.  0010:  00 00 40 bd ff ff ff ff f7 1d c0 00 00 00 00 00  ..@.............
.  0020:  00 00 40 bd ff ff ff ff 5b 6b 65 72 6e 65 6c 2e  ..@.....[kernel.
.  0030:  6b 61 6c 6c 73 79 6d 73 5d 5f 74 65 78 74 00 00  kallsyms]_text..
.  0040:  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

0 0x100 [0x50]: PERF_RECORD_MMAP -1/0: [0xffffffffbd400000(0xc01df7) @ 0xffffffffbd400000]: x [kernel.kallsyms]_text

0x150 [0x78]: event: 1
.
. ... raw event: size 120 bytes
.  0000:  01 00 00 00 01 00 78 00 ff ff ff ff 00 00 00 00  ......x.........
.  0010:  00 10 0a c0 ff ff ff ff 00 00 04 00 00 00 00 00  ................
.  0020:  00 00 00 00 00 00 00 00 2f 6c 69 62 2f 6d 6f 64  ......../lib/mod
.  0030:  75 6c 65 73 2f 35 2e 31 30 2e 30 2d 31 36 2d 61  ules/5.10.0-16-a
.  0040:  6d 64 36 34 2f 6b 65 72 6e 65 6c 2f 64 72 69 76  md64/kernel/driv
.  0050:  65 72 73 2f 73 63 73 69 2f 73 63 73 69 5f 6d 6f  ers/scsi/scsi_mo
.  0060:  64 2e 6b 6f 00 00 00 00 00 00 00 00 00 00 00 00  d.ko............
.  0070:  00 00 00 00 00 00 00 00
</code></pre>
<h3 id="trace---æ›´é«˜æ€§èƒ½çš„straceçš„æ›¿ä»£å“">trace - æ›´é«˜æ€§èƒ½çš„straceçš„æ›¿ä»£å“</h3>
<p>traceæ˜¯linux 3.7 å¢åŠ çš„åŠŸèƒ½ï¼Œå¯ä»¥ç”¨ä½œstraceå‘½ä»¤çš„æ›¿ä»£å“ï¼Œå› ä¸ºä¸éœ€è¦ç”¨æˆ·-å†…æ ¸ç©ºé—´åˆ‡æ¢ï¼Œæ‰€ä»¥æ€§èƒ½å°†æ›´å¿«</p>
<pre><code class="language-bash"> perf trace &lt;command&gt;
</code></pre>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨tag <code>-e</code> æ¥æŒ‡å®šä»…å¯¹æŒ‡å®šäº‹ä»¶trace</p>
<pre><code class="language-bash">perf trace -e read,write &lt;command&gt;
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å¯¹åº”äº‹ä»¶å°†åªæœ‰ read ä¸ write</p>
<pre><code class="language-bash">$ perf trace -e read,write ls
     0.000 (1					 nginx-1.22.0		       nginx_1.22.0.orig.tar.gz		 perf.data
1.c					 nginx_1.22.0-1.debian.tar.xz  nginx-1.22.0.tar.gz		 perf.data.old
deb-multimedia-keyring_2016.8.1_all.deb  nginx_1.22.0-1.dsc	       paping_1.5.5_x86-64_linux.tar.gz
 0.058 ms): ls/3126 read(fd: 3, buf: 0x7ffcd2548068, count: 832)                          = 832
     0.132 ( 0.034 ms): ls/3126 read(fd: 3, buf: 0x7ffcd2548048, count: 832)                          = 832
     0.232 ( 0.033 ms): ls/3126 read(fd: 3, buf: 0x7ffcd2548028, count: 832)                          = 832
     0.324 ( 0.032 ms): ls/3126 read(fd: 3, buf: 0x7ffcd2548008, count: 832)                          = 832
     0.416 ( 0.032 ms): ls/3126 read(fd: 3, buf: 0x7ffcd2547fc8, count: 832)                          = 832
     0.828 ( 0.048 ms): ls/3126 read(fd: 3, buf: 0x55c4bb555500, count: 1024)                         = 361
     0.907 ( 0.028 ms): ls/3126 read(fd: 3, buf: 0x55c4bb555500, count: 1024)                         = 0
     1.127 ( 0.060 ms): ls/3126 write(fd: 1, buf: 0x55c4bb555500, count: 65)                          = 65
     1.219 ( 0.385 ms): ls/3126 write(fd: 1, buf: 0x55c4bb555500, count: 75)                          = 75
     1.638 ( 0.049 ms): ls/3126 write(fd: 1, buf: 0x55c4bb555500, count: 100)                         = 100
</code></pre>
<h3 id="probe---åŠ¨æ€è¿½è¸ª">probe - åŠ¨æ€è¿½è¸ª</h3>
<p>perf probeå­å‘½ä»¤æ˜¯å¯ä»¥åŠ¨æ€çš„åœ¨linuxå†…æ ¸ä¸­è‡ªå®šä¹‰è¿½è¸ªäº‹ä»¶ï¼ˆè¿½è¸ªç‚¹ï¼‰ï¼Œè¿½è¸ªç‚¹çš„è¿è¡Œæ—¶å¯ä»¥åœ¨è¢«æ”¾ç½®ä»»ä½•ä»»ä½•åœ°æ–¹ï¼Œå¹¶ä¸”æ¯æ¬¡é€šè¿‡è¯¥è¿½è¸ªç‚¹æ—¶ï¼Œéƒ½å¯ä»¥è®°å½•å…¶å€¼ã€‚</p>
<p><strong>å¦‚ä½•ä½¿ç”¨ perf probe</strong>ï¼Ÿ</p>
<p><strong>æŸ¥çœ‹å¯æ¢æµ‹çš„å‡½æ•°</strong></p>
<p><code>perf probe -F</code> å¯ä»¥æ‰¾åˆ°å¯ç”¨çš„è¿½è¸ªç‚¹ï¼Œå¦‚æœæ¨¡ç³ŠæŸ¥æ‰¾å¯ä»¥ä½¿ç”¨filter</p>
<pre><code class="language-bash">perf probe -F -â€“filter dev*xmit*
</code></pre>
<p><strong>probeå‚æ•°</strong></p>
<table>
<thead>
<tr>
<th>Option</th>
<th>describe</th>
</tr>
</thead>
<tbody>
<tr>
<td>-L</td>
<td>æ˜¾ç¤ºæºä»£ç </td>
</tr>
<tr>
<td>-x</td>
<td>å¯æ‰§è¡Œæ–‡ä»¶çš„åç§°æˆ–è·¯å¾„</td>
</tr>
<tr>
<td>-l</td>
<td>åˆ—å‡ºæ‰€æœ‰probeæ¢æµ‹äº‹ä»¶</td>
</tr>
<tr>
<td>-k</td>
<td>æŒ‡å®švmlinuxæ–‡ä»¶</td>
</tr>
<tr>
<td>-a</td>
<td>**`&lt;[EVENT=]FUNC[@SRC][+OFF</td>
</tr>
<tr>
<td></td>
<td>EVENT äº‹ä»¶åç§°</td>
</tr>
<tr>
<td></td>
<td>FUNC  å‡½æ•°å</td>
</tr>
<tr>
<td></td>
<td>+OFF  å‡½æ•°å…¥å£çš„åç§»é‡</td>
</tr>
<tr>
<td></td>
<td>%return æ¢é’ˆä½ç½®ä¸ºå‡½æ•°è¿”å›å¤„</td>
</tr>
<tr>
<td></td>
<td>SRC  æºä»£ç è·¯å¾„</td>
</tr>
<tr>
<td></td>
<td>RL  ç›¸å¯¹å‡½æ•°å…¥å£å¤„çš„è¡Œå·</td>
</tr>
<tr>
<td></td>
<td>AL  åœ¨æ–‡ä»¶å†…çš„ç»å¯¹è¡Œå·</td>
</tr>
<tr>
<td></td>
<td>ARG:    æ¢æµ‹å‚æ•°ï¼ˆå±€éƒ¨å˜é‡å æˆ– <code>kprobe-tracer</code> å‚æ•°æ ¼å¼ã€‚</td>
</tr>
</tbody>
</table>
<pre><code>perf probe -x tst --add 'out=func%return $retval'
perf record -g -e probe_tst:out -aR ./tst
</code></pre>
<p><strong>ä¸€äº›ä½¿ç”¨ç¤ºä¾‹</strong></p>
<pre><code class="language-bash"># æ·»åŠ ä¸€ä¸ªè¿½è¸ªç‚¹åˆ°linuxå†…æ ¸å‡½æ•°tcp_sendmsg()è‡³å…¥å£
perf probe --add tcp_sendmsg

# åˆ é™¤linuxå†…æ ¸tcp_sendmsg()å‡½æ•°ä¸Šçš„è¿½è¸ªç‚¹
perf probe -d tcp_sendmsg

# åˆ—å‡ºç°æœ‰çš„è¿½è¸ªç‚¹
perf probe -l

# æ·»åŠ ä¸€ä¸ªè¿½è¸ªç‚¹åˆ°linuxå†…æ ¸å‡½æ•°tcp_sendmsg()è¿”å›éƒ¨åˆ†
perf probe 'tcp_sendmsg%return'
</code></pre>
<h4 id="é€šè¿‡probeæ£€æµ‹å†…æ ¸å‡½æ•°">é€šè¿‡probeæ£€æµ‹å†…æ ¸å‡½æ•°</h4>
<p><strong>probeä½¿ç”¨ç¤ºä¾‹è¯´æ˜</strong></p>
<ul>
<li>å†…æ ¸å‡½æ•°ï¼š<strong>tcp_sendmsg()</strong></li>
</ul>
<p>åœ¨å†…æ ¸å‡½æ•°ä¸Š tcp_sendmsg æ·»åŠ ä¸€ä¸ªäº‹ä»¶</p>
<pre><code class="language-bash">perf probe --add tcp_sendmsg
</code></pre>
<p>æ­¤æ—¶ä¼šå­˜åœ¨ä¸€ä¸ªè¿½è¸ªç‚¹ï¼Œé€šè¿‡ <code>perf probe -l</code> å¯ä»¥æŸ¥çœ‹</p>
<p>traceæ­¤è¿½è¸ªç‚¹5sï¼Œè®°å½•å †æ ˆä¿¡æ¯</p>
<pre><code class="language-bash">perf record -e probe:tcp_sendmsg -a -g -- sleep 5 
</code></pre>
<p>é€šè¿‡ report å­å‘½ä»¤å¯ä»¥æŸ¥çœ‹å¯¹åº”ä¿¡æ¯</p>
<pre><code class="language-bash">$ perf report --stdio  -i perf.data
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 13  of event 'probe:tcp_sendmsg'
# Event count (approx.): 13
#
# Children      Self  Command  Shared Object     Symbol                            
# ........  ........  .......  ................  ..................................
#
   100.00%   100.00%  sshd     [kernel.vmlinux]  [k] tcp_sendmsg
            |          
            |--92.31%--0
            |          getnetbyaddr_r@@GLIBC_2.2.5
            |          entry_SYSCALL_64_after_hwframe
            |          do_syscall_64
            |          ksys_write
            |          vfs_write
            |          new_sync_write
            |          sock_write_iter
            |          sock_sendmsg
            |          tcp_sendmsg
            |          
             --7.69%--0x1b81475c085
                       getnetbyaddr_r@@GLIBC_2.2.5
                       entry_SYSCALL_64_after_hwframe
                       do_syscall_64
                       ksys_write
                       vfs_write
                       new_sync_write
                       sock_write_iter
                       sock_sendmsg
                       tcp_sendmsg

   100.00%     0.00%  sshd     libc-2.31.so      [.] getnetbyaddr_r@@GLIBC_2.2.5
            |
            ---getnetbyaddr_r@@GLIBC_2.2.5
               entry_SYSCALL_64_after_hwframe

</code></pre>
<p>åˆ é™¤å¯¹åº”è·Ÿè¸ªç‚¹</p>
<pre><code class="language-bash">perf probe -d &lt;probe_name&gt;
</code></pre>
<p><strong>ä¹Ÿå¯ä»¥é€šè¿‡å†…æ ¸å‡½æ•°çš„å˜é‡è¿›è¡Œæ£€æŸ¥</strong></p>
<p>æŸ¥çœ‹å†…æ ¸å‡½æ•°å‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°å­˜åœ¨ä¸‰ä¸ªå‚æ•° <code>size</code> intç±»å‹, <code>msg</code> ç»“æ„ä½“æŒ‡é’ˆï¼Œ<code>sk</code> ç»“æ„ä½“æŒ‡é’ˆ</p>
<pre><code class="language-bash">$ perf probe -V tcp_sendmsg 
Available variables at tcp_sendmsg
        @&lt;tcp_sendmsg+0&gt;
                size_t  size
                struct msghdr*  msg
                struct sock*    sk
</code></pre>
<p>ä½¿ç”¨ <code>size</code> å˜é‡ä½œä¸º <code>tcp_sendmsg</code> æ¢æµ‹ç‚¹çš„æ¢æµ‹å™¨</p>
<pre><code class="language-bash">perf probe --add 'tcp_sendmsg size'
</code></pre>
<h4 id="é€šè¿‡probeæ£€æµ‹ç”¨æˆ·ç©ºé—´ç¨‹åº-supa-href22asup">é€šè¿‡probeæ£€æµ‹ç”¨æˆ·ç©ºé—´ç¨‹åº <sup><a href="#2">[2]</a></sup></h4>
<p>å‡†å¤‡ä¸€æ®µä»£ç ï¼Œå³æ¯æ¬¡å¾ªç¯ï¼Œæ‰“å°è¯¥å€¼å¹¶æ‰“å°è¯¥å€¼+5</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

int func(int xxx)
{
    int zzz = xxx;

    printf(&quot;zzz: %d\n&quot;, zzz);
    return zzz+5;
}
int main(int argc, char* argv[])
{
    int i=0;
    for( i=0; i&lt;10; i++)
        printf(&quot;yyy: %d\n&quot;, func(argc + i));

    return 0;
}
</code></pre>
<p>è¿™é‡Œä½¿ç”¨ç¯å¢ƒä¸º debian11ï¼Œå†…æ ¸ 5.10ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ–°å†…æ ¸ä¸­ç‰ˆæœ¬ä¸­ä¼ å‚çš„å‘½ä»¤ä¸è€å†…æ ¸æœ‰å°‘è®¸å·®åˆ«</p>
<p>è¿è¡Œç¼–è¯‘åçš„ç¨‹åºå¯ä»¥çœ‹åˆ°ç»“æœ</p>
<pre><code class="language-bash">$ gcc -g -o tst tst.c &amp;&amp; ./tst
zzz: 1
yyy: 6
zzz: 2
yyy: 7
zzz: 3
yyy: 8
zzz: 4
yyy: 9
zzz: 5
yyy: 10
zzz: 6
yyy: 11
zzz: 7
yyy: 12
zzz: 8
yyy: 13
zzz: 9
yyy: 14
zzz: 10
yyy: 15
</code></pre>
<p>è¿™é‡Œç¼–è¯‘æ—¶ä½¿ç”¨äº† <code>-g</code> é€‰é¡¹ï¼Œ<code>-g</code> æ˜¯ä¸€ä¸ªç¼–è¯‘é€‰é¡¹ï¼Œå³åœ¨æºä»£ç ç¼–è¯‘çš„è¿‡ç¨‹ä¸­èµ·ä½œç”¨ï¼Œè®©gccæŠŠæ›´å¤šè°ƒè¯•ä¿¡æ¯ï¼ˆä¹Ÿå°±åŒ…æ‹¬ç¬¦å·ä¿¡æ¯ï¼‰æ”¶é›†èµ·æ¥å¹¶å°†å­˜æ”¾åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶</p>
<p>æ¥ä¸‹æ¥ä¸ºç¨‹åºåˆ›å»ºä¸€ä¸ªè¿½è¸ªäº‹ä»¶ï¼Œ</p>
<pre><code class="language-bash">perf probe -x tst --add 'out=func%return $retval'
# æ ¼å¼å°†ä¸¥æ ¼éµå¾ª &lt;[EVENT=]FUNC[@SRC][+OFF|%return|:RL|;PT]|SRC:AL|SRC;PT [[NAME=]ARG ...]&gt;
# out=func%return %retval
# EVENT=FUNC%return ARG
# EVENT æ¢æµ‹äº‹ä»¶å
# FUNC  å‡½æ•°å
# %return åœ¨å‡½æ•°returnå¤„æ”¾ç½®æ¢é’ˆ
# ARG å‚æ•°
</code></pre>
<p>æ­¤æ—¶å¯ä»¥æ‰§è¡Œè¿™ä¸ªç¨‹åºï¼Œè®©probeå¯ä»¥è¿½è¸ªåˆ°æ•°æ®</p>
<pre><code class="language-bash">$ perf record -g -e probe_tst:out__return -aR ./tst
Lowering default frequency rate to 2750.
Please consider tweaking /proc/sys/kernel/perf_event_max_sample_rate.
zzz: 1
yyy: 6
zzz: 2
yyy: 7
zzz: 3
yyy: 8
zzz: 4
yyy: 9
zzz: 5
yyy: 10
zzz: 6
yyy: 11
zzz: 7
yyy: 12
zzz: 8
yyy: 13
zzz: 9
yyy: 14
zzz: 10
yyy: 15
[ perf record: Woken up 1 times to write data ]
[ perf record: Captured and wrote 0.163 MB perf.data (10 samples) ]
</code></pre>
<p>æ‰§è¡Œçš„ç»“æœä¿å­˜åœ¨ <code>perf.data</code> ä¸­</p>
<pre><code class="language-bash">$ perf report --stdio
# To display the perf.data header info, please use --header/--header-only options.
#
#
# Total Lost Samples: 0
#
# Samples: 10  of event 'probe_tst:out__return'
# Event count (approx.): 10
#
# Children      Self  Command  Shared Object     Symbol                
# ........  ........  .......  ................  ......................
#
   100.00%   100.00%  tst      tst               [.] main
            |
            ---0x5541d68949564100
               cancel_handler
               main

   100.00%     0.00%  tst      [unknown]         [.] 0x5541d68949564100
            |
            ---0x5541d68949564100
               cancel_handler
               main

   100.00%     0.00%  tst      libc-2.31.so      [.] cancel_handler
            |
            ---cancel_handler
               main
</code></pre>
<p>ä½¿ç”¨ <code>script</code> å­å‘½ä»¤æŸ¥çœ‹è¿™ä¸ªç¨‹åºçš„traceè®°å½•ï¼Œå¯ä»¥çœ‹åˆ°</p>
<pre><code class="language-bash">perf script 
tst  2272 [000] 28276.947273: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0x6
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947282: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0x7
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947288: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0x8
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947294: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0x9
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947300: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0xa
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947306: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0xb
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947311: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0xc
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947317: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0xd
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947322: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0xe # 14
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])

tst  2272 [000] 28276.947328: probe_tst:out__return: (55dc41f11135 &lt;- 55dc41f11192) arg1=0xf # 15
            55dc41f11192 main+0x2e (/root/tst)
            7f67337bed0a cancel_handler+0x3a (/usr/lib/x86_64-linux-gnu/libc-2.31.so)
        5541d68949564100 [unknown] ([unknown])
</code></pre>
<p>å¯ä»¥é€šè¿‡ä¸Šé¢çœ‹åˆ°ï¼Œè¿™é‡Œåˆ¶ä½œçš„æ¢é’ˆåœ¨ç”¨æˆ·ç©ºé—´ç¨‹åº tst.func å‡½æ•°ä¸­ï¼Œå½“ä»–è¿”å›æ—¶ï¼Œè®°å½•äº†è¦è¿”å›çš„å€¼ä½œä¸ºarg1ï¼Œä¹Ÿå°±æ˜¯æ¯è¡Œè¿”å›çš„ <code>0xf</code> è¿™ç±»16è¿›åˆ¶å€¼ï¼Œä¹Ÿå¯ä»¥çœ‹åˆ°æ¯æ¬¡å‘½ä¸­è¯¥æ¢é’ˆçš„éƒ¨åˆ†</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<h4 id="uhhuh-nmi-received-for-unknown-reason">Uhhuh. NMI received for unknown reason</h4>
<pre><code class="language-bash">Message from syslogd@phab1 at Dec 26 19:16:16 ...
kernel:Uhhuh. NMI received for unknown reason 30 on CPU 0.

Message from syslogd@phab1 at Dec 26 19:16:16 ...
kernel:Do you have a strange power saving mode enabled?

Message from syslogd@phab1 at Dec 26 19:16:16 ...
kernel:Dazed and confused, but trying to continue
</code></pre>
<p>ä¸Šè¿°é—®é¢˜é€šå¸¸å‘ç”Ÿäºè™šæ‹ŸåŒ–ç¯å¢ƒ</p>
<p>Solve solution: disable c-state in bios</p>
<h4 id="failed-to-find-the-path-for-kernel-invalid-elf-file">Failed to find the path for kernel: Invalid ELF file</h4>
<pre><code class="language-bash">Failed to find the path for kernel: Invalid ELF file
  Error: Failed to show vars.
</code></pre>
<p>è¿™ä¸ªé”™è¯¯é€šå¸¸ä½¿ç”¨ <code>perf probe -V</code> æ—¶å‡ºç°ï¼Œè¿™é‡Œéœ€è¦å†…æ ¸æ”¯æŒ <em><strong>debug symbols</strong></em>ï¼Œå³ä½¿ç”¨å…¬å¼€å‘è¡Œç‰ˆéœ€è¦å®‰è£…å¯¹åº”å†…æ ¸åŒ…</p>
<ul>
<li>RHEL/CentOSï¼šå®‰è£… <code>kernel-debuginfo-common</code> ä¸ <code>kernel-debuginfo package</code></li>
<li>Debian/Ubuntuï¼šå®‰è£… <code>linux-image-&lt;kernel_version&gt;-amd64-dbg</code> debianä¸‹ä¿æŒéœ€è¦è‡³å°‘5Gç©ºé—´ <sup><a href="#3">[3]</a></sup></li>
</ul>
<h4 id="failed-to-find-source-file-path">Failed to find source file path</h4>
<pre><code class="language-bash">$ perf probe -L tcp_sendmsg
Failed to find source file path.
  Error: Failed to show lines.
</code></pre>
<p>æ€è·¯ï¼šå¯ä»¥é€šè¿‡ <code>strace</code> å‘½ä»¤çœ‹çœ‹ä¸ºä»€ä¹ˆæŠ¥é”™</p>
<p>åŸå› ï¼š<code>perf probe -L</code> å°†æ˜¾ç¤ºå¯¹åº”å†…æ ¸æ¢æµ‹ç‚¹çš„æºä»£ç ï¼Œæ­¤æ—¶perfä¼šå¯»æ‰¾æ„å»ºçš„å†…æ ¸ç›®å½•ï¼Œè€Œæ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆä¾›åº”å•†å¯¹äºç³»ç»Ÿéƒ½æ˜¯é€šè¿‡åŒ…ç®¡ç†ï¼ŒåŒ…æ‹¬å†…æ ¸ï¼Œå¹¶æœªæä¾›è¿™äº›æºç ï¼Œæ­¤çŠ¶æ€ä¸ºæ­£ç¡®çš„ï¼Œå¦‚æœéè¦è§£å†³ï¼Œå¯ä»¥è‡ªè¡Œç¼–è¯‘å†…æ ¸ã€‚</p>
<h2 id="dmesg">dmesg</h2>
<p><em><strong>dmesg</strong></em> æ˜¯æ¥è‡ªå†…æ ¸çš„ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œè€Œé€šè¿‡ <em><strong>dmesg</strong></em> å‘½ä»¤å¯ä»¥çœ‹åˆ°æ¥è‡ªè¯¥ç¼“å†²åŒºçš„æ¶ˆæ¯ï¼Œè€Œè¯¥æ¶ˆæ¯ä¹Ÿè¢«ç§°ä¸º â€<em><strong>driver message</strong></em>â€œ æˆ– â€<em><strong>display message</strong></em>â€œ</p>
<h3 id="ç¤ºä¾‹1å¯¹dmesgè¾“å‡ºç€è‰²">ç¤ºä¾‹1ï¼šå¯¹dmesgè¾“å‡ºç€è‰²</h3>
<pre><code class="language-bash">$ dmesg -L
</code></pre>
<h3 id="ç¤ºä¾‹2dmesgè¾“å‡ºæ¶ˆæ¯å¢åŠ æ—¶é—´">ç¤ºä¾‹2ï¼šdmesgè¾“å‡ºæ¶ˆæ¯å¢åŠ æ—¶é—´</h3>
<pre><code class="language-bash">$ dmesg -T
</code></pre>
<h3 id="ç¤ºä¾‹3è¿‡æ»¤ç›¸å…³çº§åˆ«ä¿¡æ¯">ç¤ºä¾‹3ï¼šè¿‡æ»¤ç›¸å…³çº§åˆ«ä¿¡æ¯</h3>
<p>å¯ä»¥é€šè¿‡ <code>--level</code> æ¥è¿›è¡Œè¿‡æ»¤å‡ºä¸åŒçº§åˆ«çš„æ—¥å¿—ï¼Œå¯ç”¨çº§åˆ«æœ‰</p>
<ul>
<li>emerg,</li>
<li>alert,</li>
<li>crit,</li>
<li>err,</li>
<li>warn,</li>
<li>notice,</li>
<li>info</li>
<li>debug</li>
</ul>
<pre><code class="language-bash">$ dmesg --level=err

$ dmesg --level=warn
</code></pre>
<h3 id="ç¤ºä¾‹4è¿‡æ»¤ç›¸å…³äº‹ä»¶ä¿¡æ¯">ç¤ºä¾‹4ï¼šè¿‡æ»¤ç›¸å…³äº‹ä»¶ä¿¡æ¯</h3>
<p>dmesg å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®š <code>--facility</code> æ¥æŒ‡å®šå¯¹åº”äº‹ä»¶çš„æ—¥å¿—ï¼Œå¯ç”¨çš„è®¾æ–½æœ‰ï¼š</p>
<ul>
<li>kern</li>
<li>user</li>
<li>mail</li>
<li>daemon</li>
<li>auth</li>
<li>lpr</li>
<li>news</li>
</ul>
<pre><code class="language-bash">$  dmesg --facility=daemon
[    1.793879] systemd[1]: Inserted module 'autofs4'
[    1.807871] systemd[1]: systemd 247.3-7 running in system mode. (+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +ZSTD +SECCOMP +BLKID +ELFUTILS +KMOD +IDN2 -IDN +PCRE2 default-hierarchy=unified)
[    1.807925] systemd[1]: Detected virtualization vmware.
[    1.807927] systemd[1]: Detected architecture x86-64.
[    1.808612] systemd[1]: Set hostname to &lt;debian-template&gt;.
[    1.881058] systemd[1]: Queued start job for default target Graphical Interface.
[    1.882132] systemd[1]: Created slice system-getty.slice.
[    1.882337] systemd[1]: Created slice system-modprobe.slice.
[    1.882724] systemd[1]: Created slice system-systemd\x2dfsck.slice.
[    1.882869] systemd[1]: Created slice User and Session Slice.
[    1.882902] systemd[1]: Started Dispatch Password Requests to Console Directory Watch.
[    1.882920] systemd[1]: Started Forward Password Requests to Wall Directory Watch.
[    1.883019] systemd[1]: Set up automount Arbitrary Executable File Formats File System Automount Point.
[    1.883036] systemd[1]: Reached target Local Encrypted Volumes.
[    1.883049] systemd[1]: Reached target Paths.
[    1.883054] systemd[1]: Reached target Remote File Systems.
[    1.883058] systemd[1]: Reached target Slices.
[    1.883080] systemd[1]: Reached target Swap.
[    1.883152] systemd[1]: Listening on Syslog Socket.
[    1.883193] systemd[1]: Listening on fsck to fsckd communication Socket.
[    1.883218] systemd[1]: Listening on initctl Compatibility Named Pipe.
[    1.883285] systemd[1]: Listening on Journal Audit Socket.
[    1.883322] systemd[1]: Listening on Journal Socket (/dev/log).
[    1.883364] systemd[1]: Listening on Journal Socket.
[    1.883422] systemd[1]: Listening on udev Control Socket.
[    1.883456] systemd[1]: Listening on udev Kernel Socket.
[    1.883961] systemd[1]: Mounting Huge Pages File System...
</code></pre>
<h3 id="ç¤ºä¾‹5å®æ—¶æ‰“å°dmesgæ—¥å¿—">ç¤ºä¾‹5ï¼šå®æ—¶æ‰“å°dmesgæ—¥å¿—</h3>
<pre><code class="language-bash">$ dmesg --follow
</code></pre>
<h3 id="ç¤ºä¾‹6æ˜¾ç¤ºdmesgåŸç”Ÿä¿¡æ¯">ç¤ºä¾‹6ï¼šæ˜¾ç¤ºdmesgåŸç”Ÿä¿¡æ¯</h3>
<pre><code class="language-bash">$ dmesg -r
</code></pre>
<h3 id="ç¤ºä¾‹7dmesgä¿¡æ¯é‡å®šå‘åˆ°syslog">ç¤ºä¾‹7ï¼šdmesgä¿¡æ¯é‡å®šå‘åˆ°syslog</h3>
<p>dmesgæœ¬èº«åªæ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´å‘½ä»¤ï¼Œè€Œ â€<em><strong>driver message</strong></em>â€œ æ˜¯å†…å­˜ä¸­ä¸€ä¸ªç¼“å†²å™¨ï¼Œåœ¨Linuxæ ‡è¯†ä¸º <code>/dev/kmsg</code>ï¼Œè€Œè¿™ä¸ªç¼“å†²åŒºæ˜¯å­˜åœ¨ä¸å†…å­˜ä¸­ï¼Œå¦‚æœéœ€è¦å°†å…¶é‡å®šå‘åˆ°syslogï¼Œå¯ä»¥é€šè¿‡å‚æ•° <code>-S</code> å®ç°ï¼Œ<code>-s</code> åˆ™æ˜¯è®¾ç½®è¿™ä¸ªç¯å½¢bufferçš„å¤§å°</p>
<h3 id="ç¤ºä¾‹8è¿‡æ»¤ç¡¬ä»¶è®¾å¤‡ç›¸å…³ä¿¡æ¯">ç¤ºä¾‹8ï¼šè¿‡æ»¤ç¡¬ä»¶è®¾å¤‡ç›¸å…³ä¿¡æ¯</h3>
<pre><code class="language-bash"># usbè®¾å¤‡
$ dmesg | grep -i usb
# è¿˜å¯ä»¥é€šè¿‡grepæŸ¥çœ‹å…¶å®ƒç¡¬ä»¶è®¾å¤‡ç›¸å…³ä¿¡æ¯
$ dmesg | grep -i dma
$ dmesg | grep -i scsi
$ dmesg | grep -i acpi
$ dmesg | grep -i memory
$ dmesg | grep -i tty
$ dmesg | grep sda
</code></pre>
<h3 id="ç¤ºä¾‹9æ¸…ç©ºbuffer">ç¤ºä¾‹9ï¼šæ¸…ç©ºbuffer</h3>
<pre><code class="language-bash"># ç›´æ¥æ¸…ç©º
dmesg -C
# è¯»å–å¹¶æ¸…ç©º
dmesg -c
</code></pre>
<h2 id="vmstat">vmstat</h2>
<p>vmstat å‘½ä»¤æ˜¯Linuxè™šæ‹Ÿå†…å­˜ç»Ÿè®¡ä¿¡æ¯çš„å‘½ä»¤ï¼Œå¸¦æ¥çš„æ˜¯ä¸è¿›ç¨‹æœ‰å…³çš„ä¿¡æ¯ï¼Œå¦‚processes, memory, paging, block IO</p>
<p><strong>æ²¡æœ‰ä»»ä½•å‚æ•°çš„vmstat</strong></p>
<pre><code class="language-bash">$ vmstat 
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 1246808  24308 507656    0    0     5     0   60  130  0  0 100  0  0
</code></pre>
<p>vmstatè¾“å‡ºåŒ…å«çš„å­—æ®µ</p>
<ul>
<li>Procs â€“ r: ç­‰å¾…è¿è¡Œçš„æ•°é‡</li>
<li>Procs â€“ b: å¿™ç¢Œè¿›ç¨‹çš„æ•°é‡</li>
<li>Memory â€“ swpd: å·²ä½¿ç”¨çš„è™šæ‹Ÿå†…å­˜</li>
<li>Memory â€“ free: ç©ºé—²çš„è™šæ‹Ÿå†…å­˜</li>
<li>Memory â€“ buff: ç”¨ä½œbufferçš„å†…å­˜</li>
<li>Memory â€“ cache: ç”¨ä½œcacheçš„å†…å­˜</li>
<li>Swap â€“ si: ä»ç£ç›˜äº¤æ¢è‡³å†…å­˜ (for every second)</li>
<li>Swap â€“ so: å†…å­˜äº¤æ¢åˆ°ç£ç›˜ (for every second)</li>
<li>IO â€“ bi (<em>Blocks in</em>). i.e ä»è®¾å¤‡æ¥å—åˆ°çš„å—(for every second)</li>
<li>IO â€“ bo (<em>Blocks out</em>). i.e å‘é€åˆ°è®¾å¤‡çš„å— (for every second)</li>
<li>System â€“ in (<em>Interrupts per second</em>) æ¯ç§’çš„ä¸­æ–­</li>
<li>System â€“ cs (<em>Context switches</em>) ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>CPU â€“ us, sy, id, wa, st: CPU user time, system time, idle time, wait time</li>
</ul>
<h3 id="ç¤ºä¾‹1æ˜¾ç¤ºæ´»åŠ¨å’Œéæ´»åŠ¨å†…å­˜">ç¤ºä¾‹1ï¼šæ˜¾ç¤ºæ´»åŠ¨å’Œéæ´»åŠ¨å†…å­˜</h3>
<pre><code class="language-bash">$ vmstat -a
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free  inact active   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 1247060 294352 314540    0    0     5     0   60  130  0  0 100  0  0
</code></pre>
<h3 id="ç¤ºä¾‹2æ˜¾ç¤ºå¯åŠ¨ç³»ç»Ÿåæ‰€æœ‰forkç³»ç»Ÿè°ƒç”¨">ç¤ºä¾‹2ï¼šæ˜¾ç¤ºå¯åŠ¨ç³»ç»Ÿåæ‰€æœ‰forkç³»ç»Ÿè°ƒç”¨</h3>
<p>æ˜¾ç¤ºæ‰€æœ‰ forkã€vfork å’Œ clone ç³»ç»Ÿè°ƒç”¨è®¡æ•°</p>
<pre><code class="language-bash">$ vmstat -f
         2889 forks
</code></pre>
<h3 id="ç¤ºä¾‹3åŠ¨æ€å±•ç¤º">ç¤ºä¾‹3ï¼šåŠ¨æ€å±•ç¤º</h3>
<p>å±•ç¤ºç»“æœå°†ä»¥ x ç§’åˆ·æ–°ï¼Œç›´åˆ° crtl - c é€€å‡º</p>
<pre><code class="language-bash">$ vmstat 2
</code></pre>
<p>ä¹Ÿå¯ä»¥æ¥ä¿©ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯åˆ·æ–°æ—¶é—´ï¼Œä¸€ä¸ªæ˜¯åˆ·æ–°å¤šå°‘æ¬¡ï¼Œä¾‹å¦‚ï¼Œ2ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œä¸€å…±åˆ·æ–°10æ¬¡ï¼Œå®Œæˆåé€€å‡ºå‘½ä»¤</p>
<pre><code class="language-bash">$ vmstat 2 10
</code></pre>
<h3 id="ç¤ºä¾‹4æ‰“å°æ—¶é—´">ç¤ºä¾‹4ï¼šæ‰“å°æ—¶é—´</h3>
<pre><code class="language-bash">$ vmstat -t 1 2
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- -----timestamp-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st                 PST
 1  0      0 1247424  24396 507656    0    0     5     0   60  130  0  0 100  0  0 2022-12-10 08:10:03
 1  0      0 1247416  24396 507656    0    0     0     8  130  277  0  0 100  0  0 2022-12-10 08:10:04
</code></pre>
<h3 id="ç¤ºä¾‹5æ˜¾ç¤ºslabç›¸å…³ä¿¡æ¯">ç¤ºä¾‹5ï¼šæ˜¾ç¤ºslabç›¸å…³ä¿¡æ¯</h3>
<p>slabæ˜¯ä¸€ç§å†…å­˜ç®¡ç†æœºåˆ¶ï¼Œç›®çš„æ˜¯ä¸ºäº†æ›´æœ‰æ•ˆçš„åˆ†é…å†…å­˜å¯¹è±¡</p>
<pre><code class="language-bash">vmstat -m
Cache                       Num  Total   Size  Pages
nf_conntrack                102    102    320     51
ovl_inode                    94     94    688     47
ext4_groupinfo_1k           120    120    136     60
fuse_request                  0      0    152     53
fuse_inode                    0      0    832     39
ext4_groupinfo_4k           112    112    144     56
ext4_fc_dentry_update         0      0     80     51
ext4_inode_cache          13554  13554   1184     27
ext4_system_zone            204    204     40    102
ext4_io_end                 128    128     64     64
ext4_extent_status         3060   3060     40    102
jbd2_journal_handle         146    146     56     73
...
</code></pre>
<h3 id="åœºæ™¯6è¾“å‡ºæ ¼å¼ä¸ºè¡¨æ ¼å½¢å¼">åœºæ™¯6ï¼šè¾“å‡ºæ ¼å¼ä¸ºè¡¨æ ¼å½¢å¼</h3>
<pre><code class="language-bash">$ vmstat -s
      1996352 K total memory
       216852 K used memory
       314636 K active memory
       294352 K inactive memory
      1247416 K free memory
        24428 K buffer memory
       507656 K swap cache
            0 K total swap
            0 K used swap
            0 K free swap
         3635 non-nice user cpu ticks
            2 nice user cpu ticks
         8204 system cpu ticks
      9759423 idle cpu ticks
          310 IO-wait cpu ticks
            0 IRQ cpu ticks
          320 softirq cpu ticks
            0 stolen cpu ticks
       498371 pages paged in
        45598 pages paged out
            0 pages swapped in
            0 pages swapped out
      5866212 interrupts
     12709713 CPU context switches
   1670639441 boot time
         2922 forks
</code></pre>
<h3 id="åœºæ™¯7ç£ç›˜ç›¸å…³ä¿¡æ¯">åœºæ™¯7ï¼šç£ç›˜ç›¸å…³ä¿¡æ¯</h3>
<pre><code class="language-bash">$ vmstat -d 1 20
disk- ------------reads------------ ------------writes----------- -----IO------
       total merged sectors      ms  total merged sectors      ms    cur    sec
sda     7835   2737  996742    2134   5719   2598   91620    6219      0      9
sda     7835   2737  996742    2134   5747   2598   91908    6230      0      9
</code></pre>
<h3 id="åœºæ™¯8è¾“å‡ºæ ¼å¼å¢åŠ å®½åº¦">åœºæ™¯8ï¼šè¾“å‡ºæ ¼å¼å¢åŠ å®½åº¦</h3>
<pre><code class="language-bash">vmstat -w 1 3
--procs-- -----------------------memory---------------------- ---swap-- -----io---- -system-- --------cpu--------
   r    b         swpd         free         buff        cache   si   so    bi    bo   in   cs  us  sy  id  wa  st
   0    0            0      1247440        24468       507656    0    0     5     0   60  130   0   0 100   0   0
   0    0            0      1247440        24468       507656    0    0     0     0  135  265   0   0 100   0   0
   0    0            0      1247440        24468       507656    0    0     0     0  126  262   0   0 100   0   0
</code></pre>
<h3 id="åœºæ™¯9è¾“å‡ºå•ä½æ ¼å¼åŒ–">åœºæ™¯9ï¼šè¾“å‡ºå•ä½æ ¼å¼åŒ–</h3>
<pre><code class="language-bash">vmstat -S k
vmstat: -S requires k, K, m or M (default is KiB)
</code></pre>
<h2 id="mpstat">mpstat</h2>
<p>mpstatæ˜¯ç»Ÿè®¡CPUç›¸å…³ä¿¡æ¯çš„å‘½ä»¤</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install sysstat -y</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y sysstat</code></li>
</ul>
<pre><code class="language-bash">$ mpstat

08:22:07 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
08:22:07 AM  all    0.04    0.00    0.09    0.00    0.00    0.00    0.00    0.00    0.00   99.87
</code></pre>
<p>çœ‹æ‡‚ mpstat è¾“å‡ºç»“æœ</p>
<ul>
<li><strong>CPU</strong>ï¼šå¤„ç†å™¨ç¼–å·. allä¸ºæ‰€æœ‰CPUåœ¨ä¸€æ®µæ—¶é—´å†…çš„å¹³å‡ç»Ÿè®¡ä¿¡æ¯.</li>
<li><strong>%usr</strong>ï¼šåœ¨ç”¨æˆ·çº§åˆ«ï¼ˆåº”ç”¨ç¨‹åºï¼‰æ‰§è¡Œæ—¶çš„CPUå¹³å‡ä½¿ç”¨ç‡ã€‚</li>
<li><strong>%nice</strong>ï¼šå…·æœ‰è‰¯å¥½çº§åˆ«çš„ç”¨æˆ·çº§åˆ«ï¼ˆåº”ç”¨ç¨‹åºï¼‰æ‰§è¡Œæ—¶çš„CPUå¹³å‡ä½¿ç”¨ç‡ã€‚</li>
<li><strong>%sys</strong>ï¼šæ˜¾ç¤ºåœ¨å†…æ ¸çº§åˆ«æ‰§è¡Œæ—¶å‘ç”Ÿçš„CPUä½¿ç”¨ç‡ã€‚ è¿™é‡Œä¸åŒ…æ‹¬è€—æ—¶çš„ç¡¬/è½¯ä¸­æ–­æœåŠ¡</li>
<li><strong>%iowait</strong>ï¼šCPU æˆ– CPU å¤„äºç©ºé—²çŠ¶æ€æœŸé—´ç³»ç»Ÿæœ‰æœªå®Œæˆçš„ç£ç›˜ I/O è¯·æ±‚ã€‚</li>
<li><strong>%irq</strong>ï¼šä¸€ä¸ªæˆ–å¤šä¸ª CPU åœ¨ä¸­æ–­æ—¶ï¼Œç¡¬ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´çš„ç™¾åˆ†æ¯”ã€‚</li>
<li><strong>%soft</strong>ï¼š ä¸€ä¸ªæˆ–å¤šä¸ªCPUç”¨äºä¸­æ–­æ—¶ï¼Œè½¯ä¸­æ–­æ‰€èŠ±è´¹çš„æ—¶é—´ç™¾åˆ†æ¯”ã€‚</li>
<li><strong>%steal</strong>ï¼š ä¸€ä¸ªæˆ–å¤šä¸ªè™šæ‹ŸCPUå½“åœ¨è™šæ‹Ÿæœºç®¡ç†å™¨æœåŠ¡ä¸å¦ä¸€ä¸ªè™šæ‹Ÿå¤„ç†å™¨æ—¶éè‡ªæ„¿ç­‰å¾…æ—¶é—´æ‰€èŠ±è´¹çš„ç™¾åˆ†æ¯”</li>
<li><strong>%guest</strong>ï¼šä¸€ä¸ªæˆ–å¤šä¸ªCPUåœ¨è¿è¡Œä¸€ä¸ªè™šæ‹Ÿå¤„ç†å™¨ä½¿ç”¨æ—¶é—´çš„ç™¾åˆ†æ¯”</li>
<li><strong>%idle</strong> : ä¸€ä¸ªæˆ–å¤šä¸ªCPUå¤„äºidleçŠ¶æ€ï¼Œå¹¶ä¸”ç³»ç»Ÿæ²¡æœ‰å°šæœªå®Œæˆçš„ç£ç›˜ I/O è¯·æ±‚</li>
</ul>
<pre><code class="language-bash"># æ˜¾ç¤ºæ‰€æœ‰ä¿¡æ¯
mpstat -A

# æŒ‰ç…§ç‹¬ç«‹æ ¸å¿ƒå±•ç¤º
mpstat -P ALL

# ä½¿ç”¨ç¼–å·æŒ‡å®šå•ç‹¬çš„CPUç¼–å·
mpstat -P 1

# ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºåˆ·æ–°æ—¶é—´ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºåˆ·æ–°æ¬¡æ•°
mpstat 2 10

# CPUåˆ©ç”¨ç‡
mpstat -u %usr

# CPUä¸­æ–­ä¿¡æ¯
mpstat -I { SUM | CPU | SCPU | ALL }
</code></pre>
<h2 id="pidstat">pidstat</h2>
<p><em><strong>pidstat</strong></em> æ˜¯ <em><strong>sysstat</strong></em> åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ç»Ÿè®¡å•ä¸ªè¿›ç¨‹å¹¶ç”ŸæˆæŠ¥å‘Šã€‚ç”¨ä»¥é€šè¿‡ PID æ¥è¯„ä¼°èµ„æºçš„ä½¿ç”¨ç‡</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install sysstat -y</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y sysstat</code></li>
</ul>
<pre><code class="language-bash"># æ˜¾ç¤ºæ‰€æœ‰è¿›ç¨‹
pidstat -p ALL

# æŸ¥çœ‹ç‰¹å®šè¿›ç¨‹
pidstat -p 514

# æ ¹æ®è¿›ç¨‹åç§°æ¥æŸ¥çœ‹
pidstat -C &quot;mysql&quot;

# æŒ‡å®šå®æ—¶åˆ·æ–°
pidstat -p 23493 1

# æ˜¾ç¤ºæŒ‡å®šè¿›ç¨‹çš„I/Oç»Ÿè®¡ä¿¡æ¯
pidstat -p &lt;pid&gt; -d

# æ˜¾ç¤ºæŒ‡å®šè¿›ç¨‹çš„æ´»åŠ¨åˆ†é¡µç»Ÿè®¡ä¿¡æ¯
pidstat -p &lt;pid&gt; -r

# æ˜¾ç¤ºç»“æœæ—¶åŠ ä¸Šè¿›ç¨‹ç¨‹åºæ‰€åœ¨è·¯å¾„ã€å‚æ•°ç­‰ä¿¡æ¯
pidstat -C java -l

# ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºåˆ·æ–°æ—¶é—´ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºåˆ·æ–°æ¬¡æ•°
pidstat 2 5

# æ˜¾ç¤ºè¿›ç¨‹çš„å­è¿›ç¨‹ä¿¡æ¯
# -T: CHILD, or TASKS, or ALL.
pidstat -p 1 -T CHILD

# æ˜¾ç¤ºä¸ºä¾èµ–è¿›ç¨‹æ ‘æ ¼å¼
pidstat -t -C &quot;ssh&quot;

# å±•ç¤ºä¸€ä¸ªæ°´å¹³çº¿ä¸Šçš„æ€§èƒ½
# option â€œrâ€  page faults and memory utilization
# option â€œdâ€  I/O statistics
# option â€œuâ€  CPU utilization
# å±•ç¤ºç»“æœå°†æŒ‰ç…§ r d u ä¾æ¬¡è¾“å‡º
pidstat -rud
</code></pre>
<h2 id="iostat">iostat</h2>
<p><em><strong>iostat</strong></em> æ˜¯ <em><strong>sysstat</strong></em> åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤æ¥ç»Ÿè®¡CPUä½¿ç”¨ç‡, I/O, ï¼ˆè®¾å¤‡ï¼Œåˆ†åŒºï¼‰, ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿç­‰</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install sysstat -y</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y sysstat</code></li>
</ul>
<p><strong>iostatå‘½ä»¤å‚æ•°</strong></p>
<ul>
<li><strong>-c</strong>: æ˜¾ç¤ºCPUä½¿ç”¨ç‡</li>
<li><strong>-d</strong>: æ˜¾ç¤ºè®¾å¤‡ä½¿ç”¨ç‡</li>
<li><strong>-k</strong>: ä»¥kbä¸ºå•ä½ç»Ÿè®¡ï¼ˆæ¯ç§’ï¼‰</li>
<li><strong>-m</strong>: ä»¥mbä¸ºå•ä½ç»Ÿè®¡ï¼ˆæ¯ç§’ï¼‰</li>
<li><strong>-x</strong>: å±•ç¤ºä¸€äº›æ‰©å±•çš„ç»Ÿè®¡æ–‡ä»¶</li>
</ul>
<p>iostatç»“æœä¸ºä¸¤éƒ¨åˆ†ï¼Œavg-cpu ä¸ Deviceï¼Œå‡æ˜¯æŒ‡è‡ªå¼€æœºä»¥æ¥çš„ç»Ÿè®¡</p>
<p>avg-cpuéƒ¨åˆ†ï¼š</p>
<ul>
<li><strong>%user</strong>ï¼šåœ¨ç”¨æˆ·çº§åˆ«ï¼ˆåº”ç”¨ç¨‹åºï¼‰æ‰§è¡Œæ—¶çš„CPUå¹³å‡ä½¿ç”¨ç‡ã€‚</li>
<li><strong>%nice</strong>ï¼šå…·æœ‰è‰¯å¥½çº§åˆ«çš„<strong>ç”¨æˆ·</strong>çº§åˆ«ï¼ˆåº”ç”¨ç¨‹åºï¼‰æ‰§è¡Œæ—¶çš„CPUå¹³å‡ä½¿ç”¨ç‡ã€‚</li>
<li><strong>%system</strong>ï¼šæ˜¾ç¤ºåœ¨<strong>å†…æ ¸</strong>çº§åˆ«æ‰§è¡Œæ—¶å‘ç”Ÿçš„CPUä½¿ç”¨ç‡ã€‚ è¿™é‡Œä¸åŒ…æ‹¬è€—æ—¶çš„ç¡¬/è½¯ä¸­æ–­æœåŠ¡</li>
<li><strong>%iowait</strong>ï¼šCPU æˆ– CPU å¤„äºç©ºé—²çŠ¶æ€æœŸé—´ç³»ç»Ÿæœ‰æœªå®Œæˆçš„ç£ç›˜ I/O è¯·æ±‚ã€‚</li>
<li><strong>%steal</strong>ï¼š ä¸€ä¸ªæˆ–å¤šä¸ªè™šæ‹ŸCPUå½“åœ¨è™šæ‹Ÿæœºç®¡ç†å™¨æœåŠ¡ä¸å¦ä¸€ä¸ªè™šæ‹Ÿå¤„ç†å™¨æ—¶éè‡ªæ„¿ç­‰å¾…æ—¶é—´æ‰€èŠ±è´¹çš„ç™¾åˆ†æ¯”</li>
<li><strong>%idle</strong> : ä¸€ä¸ªæˆ–å¤šä¸ªCPUå¤„äºidleçŠ¶æ€ï¼Œå¹¶ä¸”ç³»ç»Ÿæ²¡æœ‰å°šæœªå®Œæˆçš„ç£ç›˜ I/O è¯·æ±‚</li>
</ul>
<p>Deviceéƒ¨åˆ†ï¼š</p>
<ul>
<li><strong>tps</strong> - è¡¨ç¤ºæ¯ç§’å‘é€ç»™è®¾å¤‡çš„ä¼ è¾“æ¬¡æ•°ã€‚</li>
<li><strong>Blk_read/s (kB_read/s, MB_read/s)</strong> - è¡¨ç¤ºæ¯ç§’ä»è®¾å¤‡è¯»å–çš„æ•°æ®é‡ï¼Œä»¥å—ï¼ˆKBã€MBï¼‰è¡¨ç¤ºã€‚</li>
<li><strong>Blk_wrtn/s (kB_read/s, MB_read/s)</strong> - è¡¨ç¤ºæ¯ç§’å†™å…¥è®¾å¤‡çš„æ•°æ®é‡ï¼Œä»¥å—ï¼ˆKBã€MBï¼‰è¡¨ç¤ºã€‚</li>
<li><strong>Blk_read (kB_read, MB_read)</strong> - è¯»å–å—æ€»æ•°ï¼ˆKBã€MBï¼‰</li>
<li><strong>Blk_wrtn (kB_read, MB_read)</strong>- å†™å…¥å—æ€»æ•°ï¼ˆKBã€MBï¼‰</li>
</ul>
<pre><code class="language-bash">$ iostat
Linux 5.10.0-16-amd64 (debian-template) 	12/11/2022 	_x86_64_	(2 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           0.04    0.00    0.09    0.00    0.00   99.87

Device             tps    kB_read/s    kB_wrtn/s    kB_dscd/s    kB_read    kB_wrtn    kB_dscd
sda               0.26         8.22         1.88         0.00     578135     131934          0
</code></pre>
<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p>
<pre><code class="language-bash"># æ˜¾ç¤ºCPUä½¿ç”¨ç‡
iostat -c

# æ˜¾ç¤ºCPUä½¿ç”¨ç‡ æŒ‰ç…§å‘¨æœŸåˆ·æ–° sec
iostat -c N

# è®¾å¤‡ä½¿ç”¨ç‡
iostat -d

# ä»¥äººç±»å¯è¯»æ–¹å¼å±•ç¤º
iostat -h

# æ˜¾ç¤ºä¸€äº›æ‰©å±•é€‰é¡¹
iostat -x

# ä»¥kbä¸ºå•ä½å±•ç¤º
iostat -k

# ä»¥mbä¸ºå•ä½å±•ç¤º
iostat -m

# æ˜¾ç¤ºè®¾å¤‡ä¸åˆ†åŒºçš„ä½¿ç”¨ç‡
iostat -p

# æ˜¾ç¤ºæŒ‡å®šè®¾å¤‡çš„ä½¿ç”¨ç‡
iostat -p &lt;device_name&gt;

# å¿½ç•¥éæ´»è·ƒè®¾å¤‡
iostat -z
</code></pre>
<h2 id="htop">htop</h2>
<p>htopå¯ä»¥ç†è§£ä¸ºlinuxä¸­çš„ä¸windowsä»»åŠ¡ç®¡ç†å™¨ç›¸åŒçš„äº§å“ï¼Œä¸topä¸åŒçš„æ˜¯ï¼Œhtopæ˜¯ä¸€ä¸ªæ”¯æŒäº¤äº’å¼çš„topå‘½ä»¤</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install htop -y</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y htop</code></li>
</ul>
<h3 id="cpuå’Œå†…å­˜ä½¿ç”¨çŠ¶æ€">CPUå’Œå†…å­˜ä½¿ç”¨çŠ¶æ€</h3>
<p>htopä¸Šéƒ¨å±å¹•ï¼Œä¸ºCPUå’Œå­˜å‚¨ä½¿ç”¨è¯¦æƒ…</p>
<h3 id="æ˜¾ç¤ºçš„é¢œè‰²">æ˜¾ç¤ºçš„é¢œè‰²</h3>
<p><strong>é»˜è®¤æ¨¡å¼</strong></p>
<ul>
<li>è“è‰²ï¼šä½ä¼˜å…ˆçº§è¿›ç¨‹ï¼ˆnice&gt; 0ï¼‰</li>
<li>ç»¿è‰²ï¼šæ­£å¸¸ï¼ˆç”¨æˆ·ï¼‰æµç¨‹</li>
<li>çº¢è‰²ï¼šå†…æ ¸æ—¶é—´ï¼ˆå†…æ ¸ï¼Œiowaitï¼Œirqs &hellip;ï¼‰</li>
<li>æ©™è‰²ï¼šæœ‰æ•ˆæ—¶é—´ï¼ˆçªƒå–æ—¶é—´+è®¿å®¢æ—¶é—´ï¼‰</li>
</ul>
<p><strong>è¯¦ç»†æ¨¡å¼</strong></p>
<ul>
<li>è“è‰²ï¼šä½ä¼˜å…ˆçº§çº¿ç¨‹ï¼ˆnice&gt; 0ï¼‰</li>
<li>ç»¿è‰²ï¼šæ­£å¸¸ï¼ˆç”¨æˆ·ï¼‰æµç¨‹</li>
<li>çº¢è‰²ï¼šç³»ç»Ÿè¿›ç¨‹</li>
<li>æ©™è‰²ï¼šIRQæ—¶é—´</li>
<li>æ´‹çº¢è‰²ï¼šIRQæ—¶é—´è¾ƒæ…¢</li>
<li>ç°è‰²ï¼šIOç­‰å¾…æ—¶é—´</li>
<li>é’è‰²ï¼šå·æ—¶é—´</li>
<li>é’è‰²ï¼šè®¿å®¢æ—¶é—´</li>
</ul>
<p><strong>å†…å­˜è®¡é‡</strong>å™¨æ›´ç®€å•ï¼š</p>
<ul>
<li>ç»¿è‰²ï¼šå·²ç”¨å†…å­˜é¡µ</li>
<li>è“è‰²ï¼šç¼“å†²é¡µ</li>
<li>æ©™è‰²ï¼šç¼“å­˜é¡µé¢</li>
</ul>
<blockquote>
<p>å¯ä»¥é€šè¿‡f1æŸ¥çœ‹å¸®åŠ©å¯¹äºé¢œè‰²çš„è¯´æ˜</p>
</blockquote>
<h2 id="ldd">ldd</h2>
<h2 id="sar">sar</h2>
<p>sar <strong>S</strong>ystem <strong>A</strong>ctivity <strong>R</strong>eportçš„ç®€å†™ï¼Œå¯ä»¥ç”¨äºæ”¶é›†ã€æŠ¥å‘Šæˆ–ä¿å­˜ç³»ç»Ÿæ´»åŠ¨çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¦‚ Linux ç³»ç»Ÿä¸­çš„ CPU åˆ©ç”¨ç‡ã€å†…å­˜ä½¿ç”¨æƒ…å†µã€I/O è®¾å¤‡ä½¿ç”¨æƒ…å†µã€‚ sar å‘½ä»¤æ˜¾ç¤ºè‡ªç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„å¹³å‡ç»Ÿè®¡ä¿¡æ¯ã€‚å®ƒåœ¨è¾“å‡ºä¸­ç”ŸæˆæŠ¥å‘Šï¼Œä¹Ÿå¯ä»¥ä¿å­˜åœ¨æ–‡ä»¶ä¸­ã€‚</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install sysstat -y</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y sysstat</code></li>
</ul>
<blockquote>
<p>Notesï¼šsaræ˜¯æœåŠ¡ï¼Œéœ€è¦å¼€å¯æ”¶é›†æ‰å¯ä»¥æŸ¥è¯¢åˆ°ï¼Œé…ç½® <code>/etc/default/sysstat </code> ä¿®æ”¹ä¸º <code>ENABLED=&quot;false&quot;</code> ç„¶åé‡å¯æœåŠ¡ <code>systemctl restart sysstat.service</code></p>
</blockquote>
<p>sarè¯­æ³•</p>
<pre><code class="language-bash">$ sar [option] [interval] [count]
</code></pre>
<p>æ›´å¤šå¯ä»¥å‚è€ƒ <sup><a href="#5">[5]</a></sup></p>
<h2 id="ioping">ioping</h2>
<p>iopingæ˜¯ä¸€æ¬¾ç£ç›˜å»¶è¿Ÿç›‘æ§å·¥å…·</p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install -y ioping</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y ioping</code></li>
</ul>
<table>
<thead>
<tr>
<th>Option</th>
<th>describe</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>-c</strong> <em>count</em></td>
<td>pingçš„æ¬¡æ•°</td>
</tr>
<tr>
<td><strong>-i</strong> <em>interval</em></td>
<td>æ¯æ¬¡è¯·æ±‚çš„é—´éš”</td>
</tr>
<tr>
<td><strong>-t</strong> <em>time</em></td>
<td>æœ€å¤§æœ‰æ•ˆçš„è¯·æ±‚äº‹ä»¶ï¼Œå¤ªæ…¢çš„è¯·æ±‚å°†è¢«å¿½ç•¥</td>
</tr>
<tr>
<td><strong>-s</strong> <em>size</em></td>
<td>è¯·æ±‚å¤§å°</td>
</tr>
<tr>
<td><strong>-S</strong> <em>wsize</em></td>
<td></td>
</tr>
<tr>
<td><strong>-o</strong> <em>offset</em></td>
<td>åœ¨ file/device å¼€å§‹çš„åç§»é‡</td>
</tr>
<tr>
<td><strong>-w</strong> <em>deadline</em></td>
<td>åœ¨å¤šå°‘æ—¶é—´ååœæ­¢</td>
</tr>
<tr>
<td><strong>-p</strong> <em>period</em></td>
<td>æ‰“å°æ¯ç§’è¯·æ±‚çš„åŸç”Ÿç»Ÿè®¡æ•°æ®</td>
</tr>
<tr>
<td><strong>-A</strong></td>
<td>ä½¿ç”¨å¼‚æ­¥IO (syscalls <strong><a href="https://www.systutorials.com/docs/linux/man/2-io_submit/" target="_blank"
   rel="noopener nofollow noreferrer" >io_submit</a></strong>(2), <strong><a href="https://www.systutorials.com/docs/linux/man/2-io_submit/" target="_blank"
   rel="noopener nofollow noreferrer" >io_submit</a></strong>(2),</td>
</tr>
<tr>
<td><strong>-B</strong></td>
<td>æ‰¹é‡æ¨¡å¼ï¼Œä»¥å®‰é™çš„åŸå§‹æ•°æ®æ–¹å¼ç»Ÿè®¡æœ€ç»ˆçš„æ•°æ®</td>
</tr>
<tr>
<td><strong>-C</strong></td>
<td>ä½¿ç”¨ cached I/O åœ¨posix_fadvise(2)è¯»å–ä¹‹å‰ å’Œå†™å…¥ fdatasync(2)ä¹‹åï¼Œæ¥æŠ‘åˆ¶ç¼“å­˜å¤±æ•ˆã€‚</td>
</tr>
<tr>
<td><strong>-D</strong></td>
<td>ä½¿ç”¨direct I/O (<strong>O_DIRECT</strong> in <strong><a href="https://www.systutorials.com/docs/linux/man/2-open/" target="_blank"
   rel="noopener nofollow noreferrer" >open</a></strong>(2)).</td>
</tr>
<tr>
<td><strong>-L</strong></td>
<td>ä½¿ç”¨åºåˆ—æ“ä½œè€Œä¸æ˜¯éšæœºæ“ä½œï¼Œè¿™ç›¸å½“äºè®¾ç½®äº†é»˜è®¤å¤§å°ï¼Œä¾‹å¦‚ <code>-s 256k</code> ä¸è¿™ä¸ªæ˜¯ç›¸åŒçš„</td>
</tr>
<tr>
<td><strong>-R</strong></td>
<td>ç£ç›˜æŸ¥æ‰¾é€Ÿåº¦æµ‹è¯•ï¼Œè¿™ä¸ªé€‰é¡¹å°†ä»¥äººç±»å¯è¯»æ¨¡å¼è¾“å‡ºæ¯ä¸ªè¯·æ±‚<br>è®¾ç½®é»˜è®¤é—´éš”ä¸º0, -i=0<br/>åœæ­¢æµ‹é‡å°†åœ¨3ç§’ååœæ­¢ -w=3<br/>è®¾ç½®å·¥ä½œé›†å¤§å°ä¸º64m -S=64m</td>
</tr>
<tr>
<td><strong>-W</strong></td>
<td>å†™è€Œä¸æ˜¯è¯»ã€‚ç›®å½•ç›®æ ‡å®‰å…¨ã€‚å†™å…¥ I/O ä¸ºä¸æ”¯æŒæˆ–åœ¨æŸç§çº§åˆ«ç¼“å­˜éç¼“å­˜è¯»å–ä»è€Œæä¾›æ›´å¯é çš„ç»“æœã€‚å¯¹äºfile/deviceæ¥è¯´æ˜¯<em>å±é™©çš„</em>ï¼šè¿™å°†ä¼šç²‰ç¢æ•°æ®ã€‚</td>
</tr>
<tr>
<td><strong>-Y</strong></td>
<td>ä½¿ç”¨åŒæ­¥IO (<strong>O_SYNC</strong> in <strong><a href="https://www.systutorials.com/docs/linux/man/2-open/" target="_blank"
   rel="noopener nofollow noreferrer" >open</a></strong>(2)).</td>
</tr>
<tr>
<td><strong>-y</strong></td>
<td>ä½¿ç”¨æ•°æ®åŒæ­¥IO  (<strong>O_DSYNC</strong> in <strong><a href="https://www.systutorials.com/docs/linux/man/2-open/" target="_blank"
   rel="noopener nofollow noreferrer" >open</a></strong>(2)).</td>
</tr>
<tr>
<td><strong>-k</strong></td>
<td>é‡ç”¨ä¸´æ—¶å·¥ä½œç›®å½•æ–‡ä»¶ &ldquo;ioping.tmp&rdquo; ï¼ˆä»…å¯¹äºç›®æ ‡ç›®å½•ç”Ÿæ•ˆï¼‰</td>
</tr>
<tr>
<td><strong>-q</strong></td>
<td>Suppress periodical human-readable output.</td>
</tr>
</tbody>
</table>
<p>ä½¿ç”¨ç¤ºä¾‹</p>
<p>RAW STATISTICS</p>
<pre><code class="language-bash">$ ioping -p 100 -c 200 -i 0 -q .
100 16282962 6141 25155128 130599 162830 328499 37909 101 17115660
</code></pre>
<p>ä¸Šé¢è¾“å‡ºçš„ç»“æœæ„æ€ä¸ºï¼š</p>
<ul>
<li>ç»Ÿè®¡è¯·æ±‚çš„è®¡æ•°</li>
<li>è¿è¡Œæ—¶é—´ <strong>usec</strong> å¾®ç§’</li>
<li>æ¯ç§’è¯·æ±‚ (iops)</li>
<li>ä¼ è¾“é€Ÿç‡ (bytes/sec)</li>
<li>æœ€å°è¯·æ±‚æ—¶é—´ (usec)</li>
<li>å¹³å‡è¯·æ±‚æ—¶é—´ (usec)</li>
<li>æœ€å¤§è¯·æ±‚æ—¶é—´ (usec)</li>
<li>è¯·æ±‚æ—¶é—´åå·® (usec)</li>
<li>æ€»è¯·æ±‚ ï¼ˆåŒ…å«å¾ˆæ…¢å’Œå¾ˆå¿«çš„ï¼‰</li>
<li>æ€»å…±è¿è¡Œæ—¶é—´ (usec)</li>
</ul>
<pre><code class="language-bash"># ä½¿ç”¨é»˜è®¤å€¼å’Œå½“å‰ç›®å½• æµ‹è¯•ç£ç›˜ I/O å»¶è¿Ÿï¼Œctrl - c ä¸­æ–­ã€‚
ioping .

# æµ‹é‡/tmpè®¾å¤‡çš„å»¶è¿Ÿï¼Œæ€»è®¡ä½¿ç”¨10ä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚1MB
ioping -c 10 -s 1M /tmp

# æµ‹é‡ è®¾å¤‡  /dev/sda çš„æŸ¥æ‰¾é€Ÿåº¦
ioping -R /dev/sda

# æµ‹è¯•è®¾å¤‡ç£ç›˜åºåˆ—é€Ÿåº¦
ioping -RL /dev/sda

# è·å–ç£ç›˜åºåˆ—çš„é€Ÿåº¦ï¼ˆæ¯ç§’å¤šå°‘å­—èŠ‚ï¼‰
ioping -RLB . | awk '{print $4}'
</code></pre>
<h2 id="vnstat">vnstat</h2>
<p>vnstatæ˜¯ Linux ä¸­ç”¨äºç›‘æ§ç½‘ç»œå‚æ•°çš„å‘½ä»¤ï¼Œé€šå¸¸æŸ¥çœ‹å¸¦å®½æ¶ˆè€—æˆ–ä¸€äº›æµå…¥æˆ–æµå‡ºçš„æµé‡ï¼Œä¸ç½‘ç»œæ¥å£ä¸Šçš„æµé‡ã€‚</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install -y vnstat</code></li>
<li>RHEL/CentOS/Fedoraï¼šepel <code>yum install -y vnstat</code></li>
</ul>
<p>vnstatæ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œå¦‚æœéœ€è¦è®°å½•éœ€è¦å¯åŠ¨è¿™ä¸ªæœåŠ¡æ‰å¯ä»¥ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„å‘½ä»¤</p>
<pre><code class="language-bash"># ä»¥å°æ—¶æ˜¾ç¤ºæµé‡
vnstat -h

# ä»¥å¤©æ˜¾ç¤ºæµé‡
vnstat -d

# ä»¥æœˆä¸ºå•ä½å±•ç¤º
vnstat -m

# è®¡ç®—æ¥å£å¤šé•¿æ—¶é—´å†…çš„æµé‡ï¼ˆè¿™ä¸ªæ˜¯å®æ—¶çš„ï¼Œå¯ä»¥ä¸ç”¨å¯åŠ¨æœåŠ¡ï¼‰
vnstat -tr 10 # 10 sec

# æŒ‡å®šä¸€ä¸ªæ¥å£
vnstat -i eth0

# æŒ‡å®šè¾“å‡ºæ ¼å¼
vnstat --json
vnstat --xml
</code></pre>
<h2 id="ifstat">ifstat</h2>
<p>ifstatæ˜¯Linuxä¸‹ç½‘ç»œæ¥å£ç»Ÿè®¡çš„å‘½ä»¤</p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install -y ifstat</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y ifstat</code></li>
</ul>
<pre><code class="language-bash"># æŒ‡å®šæ¥å£å
ifstat eth0

# æŸ¥çœ‹å…¨éƒ¨æ¥å£
ifstat -a

# æ¸…é™¤ç½‘ç»œæ¥å£çš„æ•°æ®
ifstat -z &lt;interface_name&gt;

# å±•ç¤ºxç§’å†…ç½‘ç»œæ•°æ®çš„å¹³å‡å€¼
ifstat -t 10
</code></pre>
<h2 id="iptraf">iptraf</h2>
<p>iptrafæ˜¯Linux ä¸­äº¤äº’å¼çš„ç½‘ç»œç›‘æ§å‘½ä»¤ï¼Œé€šè¿‡äº¤äº’å¼å®ç°å±•ç¤º</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install -y iptraf-ng</code></li>
<li>RHEL/CentOS/Fedoraï¼š<code>yum install -y iptraf-ng</code></li>
</ul>
<h2 id="iftop">iftop</h2>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install -y iftop</code></li>
<li>RHEL/CentOS/Fedoraï¼šepel <code>yum install -y iftop</code></li>
</ul>
<pre><code class="language-bash"># æŒ‡å®šç«¯å£çš„å¸¦å®½ç»Ÿè®¡
iftop -i enp0s8

# éšè—é¡¶éƒ¨çš„æµé‡åˆ»åº¦æ 
iftop -b

# ä¸ä½¿ç”¨åŸŸåè§£æ
iftop -n -i enp0s8

# ç›´æ¥è¾“å‡ºä¸ºæ–‡å­—ï¼Œè€Œä¸æ˜¯äº¤äº’å¼
iftop -t

# æ˜¾ç¤ºæŒ‡å®šå­ç½‘çš„æµé‡
iftop -F 192.168.2.0/24

# æ ¹æ®source addræ’åº
iftop -o source

# æ ¹æ®destnation addræ’åº
iftop -o destination

# æ˜¾ç¤ºä½¿ç”¨çš„å¸¦å®½
iftop -B -i enp0s8
</code></pre>
<h2 id="arpwatch">arpwatch</h2>
<p>arpwatchæ˜¯Linuxä¸Šç”¨äºç›‘è§†ARPè®°å½•çš„</p>
<p><strong>å„ç³»ç»Ÿä¸‹çš„åŒ…åä¸å®‰è£…</strong></p>
<ul>
<li>Ubuntu/Debian/Mintï¼š<code>apt install -y arpwatch</code></li>
<li>RHEL/CentOS/Fedoraï¼šepel <code>yum install -y arpwatch</code></li>
</ul>
<table>
<thead>
<tr>
<th>Option</th>
<th>describe</th>
</tr>
</thead>
<tbody>
<tr>
<td>-d</td>
<td>debugæ¨¡å¼</td>
</tr>
<tr>
<td>-f</td>
<td>è®¾ç½®ç”¨äºå­˜å‚¨ ethernet/ip address çš„æ–‡ä»¶ï¼Œé»˜è®¤åœ¨  /var/arpwatch/arp.dat</td>
</tr>
<tr>
<td>-i</td>
<td>æŒ‡å®šé»˜è®¤æ¥å£</td>
</tr>
<tr>
<td>-n</td>
<td>æŒ‡å®šæœ¬åœ°ç½‘ç»œ</td>
</tr>
<tr>
<td>-u</td>
<td>æŒ‡å®šç”¨æˆ·æˆ–ç”¨æˆ·ç»„</td>
</tr>
<tr>
<td>-Q</td>
<td>The  flags prevents arpwatch from sending reports by mail</td>
</tr>
<tr>
<td>-z</td>
<td>è®¾ç½®å¿½ç•¥çš„ IPèŒƒå›´ï¼ŒIPå’Œæ©ç ç”¨ &ldquo;/&rdquo; åŒ–ä¸ºï¼Œå¦‚ <code>-z 192.168.10.0/255.255.255.0</code></td>
</tr>
</tbody>
</table>
<pre><code class="language-bash"># æŒ‡å®šä¸€ä¸ªæ¥å£ï¼Œå‘½ä»¤å¹¶æ²¡æœ‰è¾“å‡ºï¼Œå½“æœ‰æ–°IPæˆ–MACè¢«æ”¹å˜æ—¶ï¼Œä¼šä¿å­˜åˆ°/var/log/messages
arpwatch -i eth0
</code></pre>
<h2 id="reference">Reference</h2>
<blockquote>
<p><sup id="1">[1]</sup> <a href="https://www.brendangregg.com/perf.html" target="_blank"
   rel="noopener nofollow noreferrer" ><em><strong>perf Examples</strong></em></a></p>
<p><sup id="2">[2]</sup> <a href="http://notes.secretsauce.net/notes/2015/01/28_user-space-introspection-with-linux-perf.html" target="_blank"
   rel="noopener nofollow noreferrer" ><em><strong>User-space introspection with Linux perf</strong></em></a></p>
<p><sup id="3">[3]</sup> <a href="https://drgn.readthedocs.io/en/latest/getting_debugging_symbols.html" target="_blank"
   rel="noopener nofollow noreferrer" ><em><strong>Getting Debugging Symbols</strong></em></a></p>
<p><sup id="4">[4]</sup> <a href="http://oliveryang.net/2016/07/linux-perf-tools-tips/" target="_blank"
   rel="noopener nofollow noreferrer" ><em><strong>Linux Perf Tools Tips</strong></em></a></p>
<p><sup id="5">[5]</sup> <a href="https://www.golinuxcloud.com/sar-command-in-linux/" target="_blank"
   rel="noopener nofollow noreferrer" ><em><strong>20 sar command examples in Linux</strong></em></a></p>
<p><sup id="6">[6]</sup> <a href="https://www.linuxfordevices.com/tutorials/linux/htop-command-in-linux" target="_blank"
   rel="noopener nofollow noreferrer" ><em><strong>A Guide to the htop command in Linux</strong></em></a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>debian11æ›´æ–°å†…æ ¸ç‰ˆæœ¬</title>
      <link>https://www.oomkill.com/2022/12/debian-update-kernel/</link>
      <pubDate>Sun, 11 Dec 2022 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2022/12/debian-update-kernel/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>æœç´¢linux å†…æ ¸ image</p>
<pre><code class="language-bash">apt-cache search linux-image
</code></pre>
<p>ç„¶åå®‰è£…å¯¹åº”image</p>
<pre><code class="language-bash">sudo apt install linux-image-&lt;flavour&gt;
</code></pre>
<p>å®‰è£…å®Œæˆåå¯ä»¥çœ‹åˆ°å¯¹åº”çš„image</p>
<pre><code class="language-bash">$ dpkg -l|grep linux-image
ri  linux-image-5.10.0-16-amd64      5.10.127-2                     amd64        Linux 5.10 for 64-bit PCs (signed)
ii  linux-image-5.10.0-16-amd64-dbg  5.10.127-2                     amd64        Debug symbols for linux-image-5.10.0-16-amd64
ii  linux-image-amd64                5.10.127-2                     amd64        Linux for 64-bit PCs (meta-package)
</code></pre>
<p>å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥çœ‹æ‹¥æœ‰çš„å†…æ ¸å¯åŠ¨é¡¹</p>
<pre><code class="language-bash">grep -e &quot;menuentry &quot; -e submenu -e linux /boot/grub/grub.cfg
</code></pre>
<p>éœ€è¦ä¿®æ”¹è‡³æ–°å†…æ ¸å¯ä»¥ä¿®æ”¹ <code>/etc/default/grub</code> ä¸‹çš„ <code>GRUB_DEFAULT=</code></p>
<p>è¿™é‡Œè¦å¡«çš„å€¼ä¸ºä¸Šé¢å‘½ä»¤æŸ¥è¯¢å‡ºçš„ï¼Œä¾‹å¦‚ <code>menuentry 'Debian GNU/Linux, with Linux 5.10.0-16-amd64'</code></p>
<pre><code class="language-bash">GRUB_DEFAULT=&quot;1&gt;Debian GNU/Linux, with Linux 5.10.0-12-amd64&quot;
</code></pre>
<p>ç„¶åæ‰§è¡Œ <code>update-grub</code></p>
<h2 id="reference">Reference</h2>
<p><a href="https://wiki.debian.org/HowToUpgradeKernel" target="_blank"
   rel="noopener nofollow noreferrer" >HowToUpgradeKernel</a></p>
<p><a href="https://unix.stackexchange.com/questions/694323/how-to-set-default-kernel-in-debian" target="_blank"
   rel="noopener nofollow noreferrer" >How to set default kernel in Debian?</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ipsetæ€§èƒ½æµ‹è¯•</title>
      <link>https://www.oomkill.com/2022/11/ipset-preformance/</link>
      <pubDate>Fri, 04 Nov 2022 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2022/11/ipset-preformance/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="æµ‹è¯•æ–¹æ³•">æµ‹è¯•æ–¹æ³•</h2>
<p>åŸºäºä½¿ç”¨åœºæ™¯ï¼Œæœ€åâ½£æˆçš„è§„åˆ™ä¼šæ˜¯æŒ‰ç…§ ip æˆ–è€… <code>ip:port</code> æ¥è¿›è¡Œè¿‡æ»¤ï¼Œæµ‹è¯•æ—¶å°†ä½¿ç”¨10ä¸‡æ¡ <code>iptables</code> è§„åˆ™æ¥æ¨¡æ‹Ÿå¯¹æ€§èƒ½çš„å‹åŠ›ï¼›ä¸ºäº†æœ€å¤§åŒ–æµ‹è¯•å‹åŠ›æƒ…å†µï¼Œ10ä¸‡æ¡ <code>iptables</code> è§„åˆ™å°†éƒ½æ˜¯==ä¸ä¼šåŒ¹é…==æœºæˆ¿æµé‡ï¼Œé€šä¿—æ¥è®²ï¼Œå°±æ˜¯é“¾å¼åŒ¹é…ä¼šè¿›è¡Œæ‰€æœ‰åŒ¹é…å¹¶æœ€åä»¥æ— åŒ¹é…å‘Šç»ˆã€‚</p>
<p>ç½‘ç»œè´Ÿè½½çš„æ¨¡æ‹Ÿå°†ä½¿ç”¨åŒæœºæˆ¿ <code>scp</code> æ¥æ¨¡æ‹Ÿï¼Œå¹¶æŒ‰ç…§ä¸‹è¿°æ¡ä»¶è¿›è¡ŒåŒ¹é…ï¼š</p>
<ul>
<li>æŸ¥çœ‹æ­£å¸¸çš„æ‹·è´é€Ÿåº¦ï¼Œcpuè´Ÿè½½ç­‰</li>
<li>æˆ‘ä»¬å»ºâ½´10ä¸‡æ¡çš„æ™®é€š <code>iptables</code> è§„åˆ™ï¼ŒæŸ¥çœ‹è§„åˆ™å»ºç«‹é€Ÿåº¦ï¼Œæ‹·è´é€Ÿåº¦ï¼ŒCPUè´Ÿè½½ï¼ŒCPUä¸»è¦è€—æ—¶æ“ä½œç­‰</li>
<li>æˆ‘ä»¬å»ºâ½´10ä¸‡çš„ <code>ipset</code> ï¼Œå¹¶æŠŠæ™®é€šçš„ <code>iptables</code> è§„åˆ™è½¬ä¸ºç»“åˆ <code>ipset</code> çš„è§„åˆ™ï¼ŒæŸ¥çœ‹è§„åˆ™å»ºç«‹é€Ÿåº¦ï¼Œæ‹·è´é€Ÿåº¦ï¼ŒCPUè´Ÿè½½ï¼ŒCPUä¸»è¦è€—æ—¶ç­‰ã€‚</li>
</ul>
<h2 id="å®éªŒå¼€å§‹">å®éªŒå¼€å§‹</h2>
<p><strong>æ­¥éª¤ä¸€</strong>ï¼šåœ¨åŒæœºæˆ¿çš„â¼€ä¸ªæœºå™¨æ„é€ â¼€ä¸ªå¤§æ–‡ä»¶</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104233138861.png" alt="image-20221104233138861" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>åŒæœºæˆ¿æ‹·è´</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104233643372.png" alt="image-20221104233643372" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>è§‚å¯Ÿç½‘å¡é€Ÿåº¦ï¼ŒCPUï¼Œç³»ç»Ÿä¸»è¦è€—æ—¶æ“ä½œçš„ç­‰ï¼Œæ­¤åœºæ™¯å°†åœ¨<code>iptables</code> è§„åˆ™ä¸ºç©ºçš„æƒ…å†µä¸‹è¿›è¡Œè§‚å¯Ÿ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104234017089.png" alt="image-20221104234017089" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104234322789.png" alt="image-20221104234322789" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ä½¿ç”¨ <code>sar</code> è§‚æµ‹ç½‘å¡é€Ÿåº¦</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104233834434.png" alt="image-20221104233834434" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ä½¿ç”¨ <code>top</code> è§‚å¯ŸCPUè´Ÿè½½</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104234452841.png" alt="image-20221104234452841" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ä½¿ç”¨ <code>perf top -G</code> è§‚å¯ŸCPUå ç”¨</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104234724668.png" alt="image-20221104234724668" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><strong>æ­¥éª¤äºŒ</strong>ï¼šåˆ›å»º10ä¸‡æ¡iptablesï¼Œè§‚å¯Ÿâ½¹å¡é€Ÿåº¦ã€cpuã€ç³»ç»Ÿä¸»è¦è€—æ—¶æ“ä½œçš„ç­‰ï¼Œä¼šå‘ç°cpuåˆ©â½¤ç‡â¼¤éƒ¨åˆ†è¢«iptå â½¤ï¼Œæ‹·â»‰é€Ÿåº¦ä¸‹é™åˆ°ä¸åˆ°â¼—åˆ†ä¹‹â¼€</p>
<pre><code class="language-bash">#!/bin/bash

echo *filter
for ((i=1;i&lt;=$1;i++))
do
	echo -I INPUT -S $i -j ACCEPT
done
echo COMMIT
</code></pre>
<p>æ‰§è¡Œè„šæœ¬</p>
<pre><code class="language-bash">$ time ./mkrule.sh 100000 | sudo iptables-restore
</code></pre>
<p>è§‚å¯Ÿæ·»åŠ è§„åˆ™åçš„â½¹å¡é€Ÿåº¦ï¼ŒCPUï¼Œç³»ç»Ÿä¸»è¦è€—æ—¶æ“ä½œçš„ç­‰</p>
<p>ä½¿ç”¨ <code>sar</code> è§‚æµ‹ç½‘å¡é€Ÿåº¦</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104235306056.png" alt="image-20221104235306056" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ä½¿ç”¨ <code>top</code> è§‚å¯ŸCPUè´Ÿè½½</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104235441887.png" alt="image-20221104235441887" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ä½¿ç”¨ <code>perf top -G</code> è§‚å¯ŸCPUå ç”¨</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221104235624488.png" alt="image-20221104235624488" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><strong>æ­¥éª¤ä¸‰</strong>ï¼šä½¿ç”¨ipsetæ›¿æ¢iptables</p>
<p>æ­¤æ—¶æ”¹ä¸ºä½¿â½¤ <code>ipset</code> â½…å¼è§‚å¯Ÿç½‘å¡å¡é€Ÿåº¦ï¼ŒCPUï¼Œç³»ç»Ÿä¸»è¦è€—æ—¶æ“ä½œçš„ç­‰ï¼Œä¼šå‘ç°è·Ÿæ²¡æœ‰è§„åˆ™æ²¡æœ‰æ˜æ˜¾å˜åŒ–ã€‚ipsetçš„å†…å­˜é‡ä¸åˆ°2Mã€‚åˆæ­¥ä¼°è®¡å†…å­˜ä½¿â½¤é‡ = $hashsize \times 16 + å­˜â¼Šæ•° \times (4ï½32ä¹‹é—´)$</p>
<pre><code class="language-bash">#!/bin/bash

#ipset create whitelist hash:ip maxelem 1000000 -exist
#ipset flush whitelist
echo ' creae whitelist hash:ip family inet hashsize 65536 maxelem 100000000'

for ((i=1;i&lt;=$1;i++))
do	
	#ipset add whitelist $i
	echo add whitelist $i
done
# iptables -I INPUT -m set --match-set whitelisti src -j ACCEPT
</code></pre>
<p>æ‰§è¡Œè„šæœ¬</p>
<pre><code class="language-bash">$ time ./mkset.sh 100000 | sudo ipset restore
$ sudo iptables -Ln
$ sudo iptables -I INPUT -m set --match-set whitelisti src -j ACCEPT
</code></pre>
<p>è§‚å¯Ÿæ·»åŠ è§„åˆ™åçš„â½¹å¡é€Ÿåº¦ï¼ŒCPUï¼Œç³»ç»Ÿä¸»è¦è€—æ—¶æ“ä½œçš„ç­‰</p>
<p>ä½¿ç”¨ <code>sar</code> è§‚æµ‹ç½‘å¡é€Ÿåº¦</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221105000318616.png" alt="image-20221105000318616" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ä½¿ç”¨ <code>top</code> è§‚å¯ŸCPUè´Ÿè½½</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221105000454342.png" alt="image-20221105000454342" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ä½¿ç”¨ <code>perf top -G</code> è§‚å¯ŸCPUå ç”¨</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221105000630330.png" alt="image-20221105000630330" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<pre><code class="language-bash">$ sudo ipset list | head
Name: whitelist
Type: hash:ip
Header: family inet hashsize 65536 maxelem 100000000
Size in memory: 1891208
References: 1
</code></pre>
<p>æ€»ç»“ï¼šipsetå¯¹äºCPUå’Œå†…å­˜çš„å½±å“å¾ˆå°ï¼Œåœ¨å¤§é‡è§„åˆ™åœºæ™¯ä¸‹ç¬¦åˆé¢„æœŸ</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>å®‰è£…Debian11 (bullseye) Step-by-Step</title>
      <link>https://www.oomkill.com/2022/05/debian11-install-tutorial/</link>
      <pubDate>Wed, 25 May 2022 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2022/05/debian11-install-tutorial/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="preparation">Preparation</h2>
<p>debian11å‡ ä¹å¯ä»¥ä½¿ç”¨ä»»ä½•æ—§çš„è®¡ç®—æœºç¡¬ä»¶ï¼Œå› ä¸ºæœ€å°å®‰è£…çš„è¦æ±‚éå¸¸ä½ã€‚ä»¥ä¸‹æ˜¯æœ€ä½è¦æ±‚å’Œæ¨èè¦æ±‚ï¼š</p>
<table>
<thead>
<tr>
<th>æœ€ä½è¦æ±‚</th>
<th>æ¨èè¦æ±‚</th>
</tr>
</thead>
<tbody>
<tr>
<td>å­˜å‚¨ï¼š10 Gigabytes<br>å†…å­˜ï¼š512 Megabytes<br>CPU: 1 GigaHertz</td>
<td>å­˜å‚¨ï¼š10 Gigabytes<br/>å†…å­˜ï¼š2 Gigabytes<br/>CPU: 1 GigaHertz or more</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Debian11 EOLï¼š<strong>August 31st, 2026</strong></p>
</blockquote>
<h3 id="å¦‚ä½•é€‰æ‹©ä¸‹è½½å®‰è£…åŒ…">å¦‚ä½•é€‰æ‹©ä¸‹è½½å®‰è£…åŒ…</h3>
<ul>
<li><a href="https://www.debian.org/CD/http-ftp/#stable" target="_blank"
   rel="noopener nofollow noreferrer" >offical mirror</a></li>
<li><a href="https://developer.aliyun.com/mirror/debian" target="_blank"
   rel="noopener nofollow noreferrer" >aliyun mirror</a></li>
</ul>
<p>å®˜ç½‘æä¾›äº†å®‰è£…åŒ…çš„ä¸‹è½½ï¼Œå…¶ä¸­CDæ˜¯ç½‘ç»œå®‰è£…ï¼ŒDVDæ˜¯ç¦»çº¿å®‰è£…</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802174122790.png" alt="image-20220802174122790" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">debianå®˜æ–¹ä¸‹è½½é¡µé¢</center>
<blockquote>
<p>Notesï¼šCDå®‰è£…åŒ…å¾ˆå°ï¼Œä¸‹è½½ä¸‹æ¥æ˜¯ <code>debian-11.4.0-amd64-netinst.iso</code> å¦‚åæ‰€ç¤ºï¼Œè¿™æ˜¯ä¸€ä¸ªç½‘ç»œå®‰è£…åŒ…ï¼Œæ‰€ä»¥æ¨èä¸‹è½½DVDéƒ¨åˆ†ï¼Œå¯ä»¥è¾¾åˆ°ç¦»çº¿å®‰è£…çš„æ•ˆæœ</p>
</blockquote>
<h2 id="å®‰è£…æ­¥éª¤">å®‰è£…æ­¥éª¤</h2>
<p>åœ¨ç•Œé¢ä¸­é€‰æ‹©â€œInstallâ€ï¼Œå®‰è£…å°†å¼€å§‹ã€‚å¦‚æœå›¾å½¢åŒ–å®‰è£…å¯ä»¥é€‰æ‹©â€œGraphical installâ€ï¼Œè¿™é‡Œé€‰æ‹©â€œInstallâ€ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124054641.png" alt="image-20220802124054641" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æ¬¢è¿é¡µé¢</center>
<p>å®Œæˆåï¼Œç³»ç»Ÿå°†æç¤ºé€‰æ‹©å®‰è£…æ—¶çš„â€œè¯­è¨€â€ã€‚é€‰æ‹©å–œæ¬¢çš„è¯­è¨€ï¼Œç„¶åæŒ‰â€œEnterâ€ã€‚è¿™é‡Œé€‰æ‹©è‹±æ–‡</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124137343.png" alt="image-20220802124137343" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©è¯­è¨€é¡µé¢</center>
<p>è¿™å°†æ˜¯æ¥ä¸‹æ¥å®‰è£…æ­¥éª¤</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124701368.png" alt="image-20220802124701368" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®‰è£…æ­¥éª¤æ¦‚è¿°</center>
<h3 id="é€‰æ‹©ä½ç½®ä¸é”®ç›˜å¸ƒå±€">é€‰æ‹©ä½ç½®ä¸é”®ç›˜å¸ƒå±€</h3>
<p>é€‰æ‹©åŒºåŸŸ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124200648.png" alt="image-20220802124200648" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©åŒºåŸŸ</center>
<p>ä¸‹é¢éƒ¨ç½²æ—¶é€‰æ‹©é”®ç›˜å¸ƒå±€ï¼šä¸­å›½å¤§é™†ä½¿ç”¨çš„é”®ç›˜å¸ƒå±€æ˜¯ç¾å›½-è‹±è¯­ï¼Œä¸è¦é€‰æ‹©è‹±å›½-è‹±è¯­ä¹‹ç±»ï¼Œå¸ƒå±€æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¼šå­˜åœ¨æŒ‰é”®è¾“å‡ºçš„ç»“æœä¼šä¸åŒ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124219600.png" alt="image-20220802124219600" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©é”®ç›˜å¸ƒå±€</center>
<p>å®Œæˆä¸Šè¿°æ“ä½œåï¼Œå°†å¼€å§‹åŠ è½½é•œåƒã€‚ç­‰å¾…æ‰«æå®Œæˆã€‚ã€‚ã€‚ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124450675.png" alt="image-20220802124450675" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ç­‰å¾…æ‰«æç»„ä»¶</center>
<h3 id="è®¾ç½®ä¸»æœºåå’ŒåŸŸå">è®¾ç½®ä¸»æœºåå’ŒåŸŸå</h3>
<p>è¿™æ­¥éª¤ä¸­å°†é…ç½®ä¸€ä¸ªâ€œä¸»æœºåâ€ã€‚ä¸ä¸€ä¸ªâ€œåŸŸâ€åç§°ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124523526.png" alt="image-20220802124523526" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®ä¸»æœºå</center>
<p>â€œåŸŸâ€ å¯ä»¥é€‰æ‹©ç•™ç©ºç¡®å®š</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124552521.png" alt="image-20220802124552521" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®åŸŸ</center>
<p>å®Œæˆä¸Šè¿°æ“ä½œåï¼Œå®‰è£…ç¨‹åºå°†æç¤ºéœ€è¦è®¾ç½® root å¯†ç ã€‚è¾“å…¥æ‚¨çš„ root å¯†ç ï¼Œç„¶ååœ¨é‡æ–°è¾“å…¥ä»¥è¿›è¡ŒéªŒè¯åç»§ç»­ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124732048.png" alt="image-20220802124732048" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">è®¾ç½®Rootå¯†ç </center>
<h3 id="è®¾ç½®érootç”¨æˆ·åè´¦æˆ·å’Œå¯†ç ">è®¾ç½®éROOTç”¨æˆ·åã€è´¦æˆ·å’Œå¯†ç </h3>
<p>ä¸‹ä¸€æ­¥åˆ›å»ºä¸€ä¸ªéROOTç”¨æˆ·ï¼Œè¿™ä¸ªæ­¥éª¤æ˜¯å¿…é¡»çš„ï¼Œå¹¶ä¸ºè¿™ä¸ªæ–°åˆ›å»ºçš„å¸æˆ·åˆ†é…ä¸€ä¸ªå¯†ç ã€‚ä»¥ä¸‹æˆªå›¾å°†æè¿°å°†å¦‚ä½•å®Œæˆæ­¤æ“ä½œã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124814435.png" alt="image-20220802124814435" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®æ™®é€šç”¨æˆ·</center>
<p>ä¸ºè¿™ä¸ªç”¨æˆ·é…ç½®å¯†ç </p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124841150.png" alt="image-20220802124841150" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ä¸ºæ™®é€šç”¨æˆ·é…ç½®å¯†ç </center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124905092.png" alt="image-20220802124905092" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ä¸ºæ™®é€šç”¨æˆ·é…ç½®å¯†ç â€”â€”äºŒæ¬¡ç¡®è®¤</center>
<h3 id="è®¾ç½®æ—¶é’Ÿæ—¶åŒº">è®¾ç½®æ—¶é’Ÿæ—¶åŒº</h3>
<p>Eastern ç¾ä¸œæ—¶é—´</p>
<p>Central åŒ—ç¾ä¸­éƒ¨</p>
<p>Mountain åŒ—ç¾å±±åŒºæ—¶åŒº</p>
<p>Pacific å¤ªå¹³æ´‹æ—¶åŒº</p>
<p>Alaska é˜¿æ‹‰æ–¯åŠ å¤ä»¤æ—¶é—´</p>
<p>Hawaii å¤å¨å¤·æ—¶åŒº</p>
<p>Arizona äºåˆ©æ¡‘æ—¶åŒº</p>
<p>East Indiana å°ç¬¬å®‰çº³æ—¶åŒº</p>
<p>Samoa è¨æ‘©äºšæ—¶é—´</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802124936969.png" alt="image-20220802124936969" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®æ—¶åŒº</center>
<h3 id="å¯¹ç£ç›˜åˆ†åŒº">å¯¹ç£ç›˜åˆ†åŒº</h3>
<p>æ­¤æ­¥éª¤ç£ç›˜è¿›è¡Œåˆ†åŒºã€‚è¿™é‡Œé€‰æ‹©â€œæ‰‹åŠ¨â€é€‰é¡¹</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125018955.png" alt="image-20220802125018955" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©åˆ†åŒºæ¨¡å¼</center>
<p>é€‰æ‹©æ‰‹åŠ¨è¿›è¡Œåˆ’åˆ†ä¸ºæ‰€éœ€çš„åˆ†åŒºã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125033249.png" alt="image-20220802125033249" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©ç¡¬ç›˜</center>
<p>åˆ›å»ºæ–°çš„åˆ†åŒºè¡¨</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125051231.png" alt="image-20220802125051231" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åˆ›å»ºåˆ†åŒºè¡¨</center>
<p>é€‰æ‹©ç©ºé—²çš„ç©ºé—´è¿›è¡Œåˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125208239.png" alt="image-20220802125208239" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©ç©ºé—²ç©ºé—´</center>
<p>åˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802125220023.png" alt="image-20220802125220023" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åˆ›å»ºä¸€ä¸ªæ–°åˆ†åŒº</center>
<p>ä¸º/bootåˆ’åˆ†åˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802170825990.png" alt="image-20220802170825990" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ä¸º/bootåˆ’åˆ†åˆ†åŒº</center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802170914699.png" alt="image-20220802170914699" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æœ€ç»ˆåˆ’åˆ†çš„åˆ†åŒº</center>
<p>è¿™é‡Œé€‰Noå°±è¡Œï¼Œæç¤ºæ˜¯æŒ‡ä¸ä½¿ç”¨swapåˆ†åŒºï¼ŒNoå°±æ˜¯ç»§ç»­ï¼ŒYeså°†è¿”å›åˆ†åŒºé¡µé¢</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171300600.png" alt="image-20220802171300600" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å¯¹äºswapåˆ†åŒºçš„æç¤º</center>
<p>åˆ›å»ºæ–°åˆ†åŒºéœ€è¦æ ¼å¼åŒ–ï¼Œå½“å‰çš„åˆ†åŒºå°†ä¼šè¢«åˆ é™¤ï¼Œå¦‚æœæ˜¯æ–°ç£ç›˜é€‰æ‹©Yesæ ¼å¼åŒ–åˆ†åŒº</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171406223.png" alt="image-20220802171406223" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ç¡®è®¤æ ¼å¼åŒ–ï¼Œè¿›è¡Œåˆ†åŒº</center>
<h3 id="base-systemå®‰è£…">Base Systemå®‰è£…</h3>
<p>è¿™é‡Œç­‰å¾…å®‰è£…åŸºç¡€ç³»ç»Ÿ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171427005.png" alt="image-20220802171427005" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">ç¡®è®¤æ ¼å¼åŒ–ï¼Œè¿›è¡Œåˆ†åŒº</center>
<p>å‡ åˆ†é’Ÿåï¼Œ å®‰è£…åä¼šå¼¹å‡ºä¸€ä¸ªç•Œé¢ï¼Œè¿™é‡Œä¼šæ‰«æå…¶ä»–çš„mediaï¼Œè¿™é‡Œå› ä¸ºæ²¡æœ‰ï¼Œé€‰æ‹©Noå°±è¡Œã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171719092.png" alt="image-20220802171719092" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æ‰«æå…¶ä»–åª’ä»‹</center>
<h3 id="ç¦»çº¿å®‰è£…">ç¦»çº¿å®‰è£…</h3>
<p>ä¼šæ‰«æå®‰è£…çš„åª’ä»‹ï¼Œè¿™é‡Œä¹Ÿæœ‰æç¤ºï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„åª’ä»‹ï¼Œå¯ä»¥è·³è¿‡è¯¥æ­¥éª¤</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802175852901.png" alt="image-20220802175852901" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">æ‰«æå…¶ä»–åª’ä»‹</center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802175829172.png" alt="image-20220802175829172" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>é…ç½®ç½‘ç»œé•œåƒï¼Œå»ºè®®é…ç½®ä¸‹ï¼Œå¦‚æœä¸éœ€è¦Noå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180008399.png" alt="image-20220802180008399" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®ç½‘ç»œé•œåƒ</center>
<p>æ¥ä¸‹æ¥ä¼šå¼¹å‡ºä¸€ä¸ªç•Œé¢ï¼Œè¯·é€‰æ‹©â€œDebiané•œåƒå›½å®¶â€ã€‚è¿™ä¸ªæ˜¯é…ç½®é•œåƒåœ°å€çš„ï¼Œé€‰æ‹©è‡ªå·±çš„å›½å®¶å’Œé•œåƒç«™å³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171823823.png" alt="image-20220802171823823" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©é•œåƒå›½å®¶</center>
<p>è¿™é‡Œé€‰æ‹©çš„æ˜¯ä¸­å›½å’Œä¸­ç§‘å¤§é•œåƒ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171903846.png" alt="image-20220802171903846" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é€‰æ‹©é•œåƒåœ°å€</center>
<p>é…ç½®HTTPä»£ç†ï¼Œä¸é€‰æ‹©è·³è¿‡</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802171929992.png" alt="image-20220802171929992" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">é…ç½®httpä»£ç†</center>
<p>å¦‚æœé€‰æ‹©ç½‘ç»œå®‰è£…ï¼Œåˆ°è¿™æ­¥éª¤æ—¶å®‰è£…ç¨‹åºç°åœ¨å°†åœ¨é€‰æ‹©ç›¸å…³çš„ã€‚é¦–å…ˆï¼Œé€‰æ‹©ç¦»æ‚¨æ‰€åœ¨å›½å®¶æœ€è¿‘çš„ä½ç½®ã€‚Debian é•œåƒä½ç½®å’ŒåŸŸåæ£€ç´¢å‰©ä½™çš„æ–‡ä»¶</p>
<p>è¿™é‡Œæç¤ºæœ‰ä¸€ä¸ªåŒ¿åè°ƒæŸ¥ï¼Œè¿™é‡Œé€‰Noå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180137667.png" alt="image-20220802180137667" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åŒ¿åè°ƒæŸ¥</center>
<h3 id="æ ¹æ®è¦æ±‚è°ƒæ•´å®‰è£…">æ ¹æ®è¦æ±‚è°ƒæ•´å®‰è£…</h3>
<p>åœ¨æ£€ç´¢è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿå°†æç¤ºéœ€è¦è‡ªè¡Œé€‰æ‹©ä»¥ä¸‹é¢„å®šä¹‰è½¯ä»¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚æœ€å°åŒ–å®‰è£…ä»…é€‰æ‹©åŸºç¡€ç³»ç»Ÿä¸SSHå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180225093.png" alt="image-20220802180225093" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®‰è£…ç»„ä»¶é€‰æ‹©</center>
<p>æ¥ä¸‹æ¥ç­‰å¾…å®‰è£…å³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180343919.png" alt="image-20220802180343919" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®‰è£…è¿‡ç¨‹</center>
<blockquote>
<p>Notesï¼šé€‰æ‹©äº†DVD ISOå°†ç¦»çº¿å®Œæˆå®‰è£…ï¼Œå¦‚æœä½¿ç”¨äº†CD ISOï¼Œå°†ä»äº’è”ç½‘ä¸Šæ£€ç´¢åŒ…å¹¶å®‰è£…ï¼Œè¿™ä¸ªæ—¶é—´å°†å¾ˆé•¿ã€‚</p>
</blockquote>
<p>å…¶ä¸­ä¼šæç¤ºä¸€ä¸ªå¼•å¯¼æŒ‰ç« ï¼Œç›´æ¥Yeså³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180753937.png" alt="image-20220802180753937" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>åˆ°äº†è¿™é‡Œå³å°†å®‰è£…å®Œæˆ</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180829194.png" alt="image-20220802180829194" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">åˆ°äº†è¿™é‡Œå³å°†å®‰è£…å®Œæˆ</center>
<h3 id="å®Œæˆdebian11æœ€å°åŒ–å®‰è£…">å®ŒæˆDebian11æœ€å°åŒ–å®‰è£…</h3>
<p>çœ‹åˆ°åˆ°è¿™é‡Œå·²ç»å®Œæˆäº†å®‰è£…ï¼ŒæŒ‰â€œContinueâ€ç»§ç»­é‡å¯åå³å¯</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180902242.png" alt="image-20220802180902242" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">å®Œæˆå®‰è£…</center>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20220802180923668.png" alt="image-20220802180923668" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center class="podsc">çœ‹åˆ°ç³»ç»Ÿçš„å¼•å¯¼ç•Œé¢</center>
<p>Enjoy ğŸ‘ğŸ‘</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>å¦‚ä½•å°†systemdæœåŠ¡çš„è¾“å‡ºé‡å®šå‘åˆ°æŒ‡å®šæ–‡ä»¶</title>
      <link>https://www.oomkill.com/2020/11/systemd-output/</link>
      <pubDate>Fri, 13 Nov 2020 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2020/11/systemd-output/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>ã€€ã€€æœ‰ä¸€ç§æ›´ä¼˜é›…çš„æ–¹æ³•å¯ä»¥è§£å†³systemdè¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶è€Œé<code>/var/log/message</code>ï¼Œéœ€è¦ä½¿ç”¨systemdå‚æ•°ä¸rsyslogè¿‡æ»¤å™¨ã€‚å¹¶æŒ‡ç¤ºsyslogè¿‡æ»¤å™¨æŒ‰ç¨‹åºåç§°æ‹†åˆ†å…¶è¾“å‡ºã€‚</p>
<h2 id="systemdæ‰€éœ€å‚æ•°ä¸º">systemdæ‰€éœ€å‚æ•°ä¸º</h2>
<ul>
<li><strong><code>SyslogIdentifier</code></strong>ï¼š<em>required</em>ï¼Œè®¾ç½®æ—¥å¿—æ ‡è¯†ç¬¦(å‘é€æ—¥å¿—æ¶ˆæ¯æ—¶åŠ åœ¨è¡Œé¦–çš„å­—ç¬¦ä¸²)(&ldquo;syslog tag&rdquo;)ã€‚ é»˜è®¤å€¼æ˜¯è¿›ç¨‹çš„åç§°ã€‚æ­¤é€‰é¡¹ä»…åœ¨ StandardOutput= æˆ– StandardError= çš„å€¼åŒ…å« journal(+console), syslog(+console), kmsg(+console) ä¹‹ä¸€æ—¶æ‰æœ‰æ„ä¹‰ï¼Œ å¹¶ä¸”ä»…é€‚ç”¨äºè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºæˆ–æ ‡å‡†é”™è¯¯çš„æ—¥å¿—æ¶ˆæ¯ã€‚</li>
<li><strong><code>StandardOutput</code></strong>ï¼š<em>required</em>ï¼Œè®¾ç½®è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º(STDOUT)ã€‚ å¯è®¾ä¸º inherit, null, tty, journal, syslog, kmsg, journal+console, syslog+console, kmsg+console, file:path, append:path, socket, fd:name ä¹‹ä¸€ã€‚</li>
<li><strong><code>StandardError</code></strong>ï¼šè®¾ç½®è¿›ç¨‹çš„æ ‡å‡†é”™è¯¯(STDERR)ã€‚ å–å€¼èŒƒå›´åŠå«ä¹‰ä¸ StandardOutput= ç›¸åŒã€‚ä½†æœ‰å¦‚ä¸‹ä¾‹å¤–ï¼š (1) inherit è¡¨ç¤ºä½¿ç”¨ StandardOutput= çš„å€¼ã€‚ (2) fd:name çš„é»˜è®¤æ–‡ä»¶æè¿°ç¬¦åç§°ä¸º &ldquo;stderr&rdquo;</li>
</ul>
<h2 id="rsyslogè¿‡æ»¤å™¨è®¾ç½®">rsyslogè¿‡æ»¤å™¨è®¾ç½®</h2>
<p>ã€€ã€€ä½¿ç”¨rsyslogæ¡ä»¶é€‰æ‹©å™¨ã€‚å¦‚æœä¸æ”¹å˜rsyslogç›®å‰å·¥ä½œæ¨¡å¼ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ“ä½œï¼š</p>
<ol>
<li>
<p><strong>æ–°å»º<code>/etc/rsyslog.d/xx.conf</code>æ–‡ä»¶</strong>ã€‚</p>
</li>
<li>
<p><strong>åœ¨æ–°å»ºæ–‡ä»¶å†…å†™å…¥å†…å®¹å¦‚ä¸‹</strong></p>
</li>
</ol>
<p>å•ä¸€æ¡ä»¶å¤„ç†ã€‚</p>
<pre><code class="language-conf">if $programname == 'programname' then /var/log/programname.log
# åœæ­¢å¾€å…¶ä»–æ–‡ä»¶å†…å†™å…¥ï¼Œå¦‚æœä¸åŠ æ­¤å¥ï¼Œä¼šç»§ç»­å¾€/var/log/messageå†™å…¥ã€‚
if $programname == 'programname' then stop  
</code></pre>
<p>å¤šæ¡ä»¶å¤„ç†</p>
<p>ã€€ã€€ä¼šæ ¹æ®ä¸åŒåº”ç”¨åç§°å°†ä¸åŒçš„è¾“å‡ºæ—¥å¿—é‡å®šå‘åˆ°ä¸åŒçš„æ–‡ä»¶å†…ã€‚</p>
<pre><code class="language-conf">if ($programname == 'apiserver') then {
   action(type=&quot;omfile&quot; file=&quot;/var/log/apiserver.log&quot;)
   stop
} else if ($programname == 'scheduler') then {
   action(type=&quot;omfile&quot; file=&quot;/var/log/scheduler.log&quot;)
   stop
} else if ($programname == 'controller-manager') then {
   action(type=&quot;omfile&quot; file=&quot;/var/log/controller-manager.log&quot;)
   stop
} else if ($programname == 'etcd') then {
   action(type=&quot;omfile&quot; file=&quot;/var/log/etcd.log&quot;)
   stop
}
</code></pre>
<ol start="3">
<li>
<p><strong>æ£€æŸ¥è¯­æ³•æ˜¯å¦æ­£ç¡®</strong> <code>rsyslogd -N1 -f file_name.conf</code></p>
</li>
<li>
<p><strong>é‡æ–°å¯åŠ¨rsyslog</strong></p>
</li>
</ol>
<p>ã€€ã€€å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œåº”ç”¨çš„ <code>stdout</code> <code>stderr</code>è¢«é‡å®šå‘åˆ°å¯¹åº”çš„æ—¥å¿—æ–‡ä»¶å†…äº†ï¼Œè€Œé<code>/var/log/message</code>ï¼Œå¹¶ä¸”ä»ç„¶å¯ä»¥é€šè¿‡é€šè¿‡<code>journalctl</code>è·å¾—å¯¹åº”çš„<code>stdout</code> <code>stderr</code> ï¼ˆsystemdå‚æ•°æœºåˆ¶ï¼‰ã€‚</p>
<blockquote>
<p><strong>reference</strong></p>
<p><a href="http://www.jinbuguo.com/systemd/systemd.exec.html#StandardOutput=" target="_blank"
   rel="noopener nofollow noreferrer" >systemd</a></p>
<p><a href="https://rsyslog-mm.readthedocs.io/en/v7.4_stable/config/conditionals.html" target="_blank"
   rel="noopener nofollow noreferrer" >rsyslog-conditional</a></p>
<p><a href="https://stackoverflow.com/questions/44772640/redirecting-specific-logs-from-systemd-service-to-a-separate-file-doesnt-work" target="_blank"
   rel="noopener nofollow noreferrer" >rsyslog</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>centosé…ç½®</title>
      <link>https://www.oomkill.com/2020/09/centos-configration/</link>
      <pubDate>Thu, 17 Sep 2020 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2020/09/centos-configration/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="centos7--centos8-è®¾ç½®ç»ˆç«¯å±å¹•åˆ†è¾¨ç‡">CentOS7 / CentOS8 è®¾ç½®ç»ˆç«¯å±å¹•åˆ†è¾¨ç‡</h2>
<h3 id="centos7">Centos7</h3>
<p>ä¿®æ”¹æ–‡ä»¶ <code>/boot/grub2/grub.cfg</code></p>
<p>æœç´¢ <code>linux16</code></p>
<pre><code class="language-conf">vmlinuz-3.10.0-123.el7.x86_64 root=UUID=881ac4e6-4a55-47b1-b864-555de7051763 ro 
rd.lvm.lv=centos/swap vconsole.font=latarcyrheb-sun16 rd.lvm.lv=centos/root crashkernel=auto vconsole.keymap=us rhgb quiet LANG=en_US.UTF-8
</code></pre>
<p>æ·»åŠ å¦‚ä¸‹,???å…·ä½“çœ‹ä¸‹è¡¨</p>
<pre><code>vga=0x???

vga=0x340
</code></pre>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/1380340-20200917113910028-1954088030.png" alt="" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h3 id="centos-8">CentOS 8</h3>
<p>CentOS8 ä½¿ç”¨äº† blsgcfgæ¥è§£ææ–‡ä»¶ç”Ÿæˆèœå•é¡¹ã€‚èœå•é¡¹é…ç½®æ–‡ä»¶åœ¨<code>/boot/loader/entries/</code>ä¸‹ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶è¡¨ç¤ºä¸€ä¸ªå¯åŠ¨é¡¹ã€‚</p>
<p>è¿™é‡Œéœ€è¦ä¿®æ”¹å¯åŠ¨é¡¹çš„å‚æ•°ï¼Œè¿™é‡Œä¿®æ”¹<code>options</code>ï¼Œå®é™…ä¸Šæ˜¯ä¿®æ”¹äº† <code>/boot/grub2/grubenv</code>å¯¹åº”çš„å€¼ã€‚</p>
<pre><code>options $kernelopts $tuned_params
</code></pre>
<p>å¯ä»¥ç›´æ¥ä¿®æ”¹<code>/etc/sysconfig/grub</code>ä¸­çš„<code>GRUB_CMDLINE_LINUX</code>å€¼åå¢åŠ =åŠ <code>vga=0x???</code> ï¼ˆå¯¹ç…§åˆ†è¾¨ç‡è¡¨ä¿®æ”¹???ï¼‰ã€‚</p>
<p>ä¿®æ”¹å®Œæˆåæ‰§è¡Œ <code>grub2-mkconfig -o /boot/grub2/grub.cfg</code> é‡å¯å³ä¿®æ”¹äº†<code>/boot/grub2/grubenv</code>å¯¹åº”çš„å€¼ã€‚</p>
<h2 id="centos7-å¯åŠ¨å¼•å¯¼é¡ºåº">centos7 å¯åŠ¨å¼•å¯¼é¡ºåº</h2>
<ol>
<li>æŸ¥çœ‹é»˜è®¤å¯åŠ¨é¡¹ <code>grub2-editenv list</code></li>
<li>æŸ¥çœ‹å¯åŠ¨é¡¹åˆ—è¡¨ <code>awk -F\' '$1==&quot;menuentry &quot; {print $2}' /etc/grub2.cfg</code></li>
<li>è®¾ç½®é»˜è®¤å¼•å¯¼ <code>grub2-set-default 'Windows 10' </code></li>
<li>è®¾ç½®é»˜è®¤å¯åŠ¨é¡¹ <code>grub2-set-default 2</code> éœ€è¦æŒ‰ç…§å¯åŠ¨é¡¹åˆ—è¡¨é¡ºåº</li>
<li>é‡æ–°ç”Ÿæˆgrub2.cfg <code> grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</code></li>
<li>ä¿®æ”¹å¯¹åº”é…ç½® <code>cat /etc/default/grub</code></li>
</ol>
<h2 id="centos7-ç²¾ç®€å¼€æœºè‡ªå¯åŠ¨">centos7 ç²¾ç®€å¼€æœºè‡ªå¯åŠ¨</h2>
<p>centos7 ç²¾ç®€å¼€æœºè‡ªå¯åŠ¨</p>
<p>ntsysv rsyslog crond sshd network</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/1380340-20190208145546642-1078238986.png" alt="img" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>namedä¸»ä»éƒ¨ç½²</title>
      <link>https://www.oomkill.com/2020/02/dns/</link>
      <pubDate>Mon, 17 Feb 2020 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2020/02/dns/</guid>
      <description></description>
      <content:encoded><![CDATA[<pre><code class="language-conf">//
// named.conf
//
// Provided by Red Hat bind package to configure the ISC BIND named(8) DNS
// server as a caching only nameserver (as a localhost DNS resolver only).
//
// See /usr/share/doc/bind*/sample/ for example named configuration files.
//
// See the BIND Administrator's Reference Manual (ARM) for details about the
// configuration located in /usr/share/doc/bind-{version}/Bv9ARM.html

options {
	listen-on port 53 { any; };
//	listen-on-v6 port 53 { ::1; };
	directory 	&quot;/data/named&quot;;
	dump-file 	&quot;/data/named/data/cache_dump.db&quot;;
	statistics-file &quot;/data/named/data/named_stats.txt&quot;;
	memstatistics-file &quot;/data/named/data/named_mem_stats.txt&quot;;
	recursing-file  &quot;/data/named/data/named.recursing&quot;;
	secroots-file   &quot;/data/named/data/named.secroots&quot;;
	allow-query     { any; };
	allow-query-cache { any; };
	/* 
	 - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
	 - If you are building a RECURSIVE (caching) DNS server, you need to enable 
	   recursion. 
	 - If your recursive DNS server has a public IP address, you MUST enable access 
	   control to limit queries to your legitimate users. Failing to do so will
	   cause your server to become part of large scale DNS amplification 
	   attacks. Implementing BCP38 within your network would greatly
	   reduce such attack surface 
	*/
	recursion yes;

	dnssec-enable no;
	dnssec-validation no;

	/* Path to ISC DLV key */
	bindkeys-file &quot;/etc/named.root.key&quot;;

	managed-keys-directory &quot;/data/named/dynamic&quot;;

	pid-file &quot;/run/named/named.pid&quot;;
	session-keyfile &quot;/run/named/session.key&quot;;
};
statistics-channels {

       inet 127.0.0.1 port 53 allow { 127.0.0.1; };

};

logging {
        channel default_debug {
                file &quot;/data/logs/named/named.run&quot;;
                severity dynamic;
        };
	channel warning {
          file &quot;/data/logs/named/named.log&quot; versions 100 size10m;
          severity warning;
          print-category yes;
          print-severity yes;
          print-time yes;
         };
         channel query {
           file &quot;/data/logs/named/query.log&quot; versions 100 size 10m;
           severity info;
           print-category yes;
           print-severity yes;
           print-time yes;
         };
         category default { warning; };
         category queries { query; };
};

zone &quot;.&quot; IN {
	type hint;
	file &quot;named.ca&quot;;
};

key &quot;rndc-key&quot; {
    algorithm hmac-md5;
    secret &quot;R+pzomztOItyduEqVF2gjA==&quot;;
};

include &quot;/etc/named.rfc1912.zones&quot;;
include &quot;/etc/named.root.key&quot;;
</code></pre>
<pre><code class="language-conf">zone &quot;tvbshare.com&quot; IN {
	type master;
	file &quot;tvbshare.com.zone&quot;;
	allow-transfer { 10.11.17.90; 10.11.17.89; };
        allow-update { 10.11.17.89; };
};

zone &quot;r_tvbshare_prod.service.tvbshare&quot; IN {
	type forward;
        forwarders { 10.11.11.5;  10.11.11.6; };
         forward only;
};

zone &quot;w_tvbshare_prod.service.tvbshare&quot; IN {
        type forward;
        forwarders { 10.11.11.4; };
        forward only;
};

</code></pre>
<p>slave</p>
<pre><code class="language-conf">zone &quot;tvbshare.com&quot; IN {
	type slave;
	masters { 10.11.17.89; };
	masterfile-format text;
	file &quot;slaves/tvbshare.com.zone&quot;;
};

zone &quot;r_tvbshare_prod.service.tvbshare&quot; IN {
        type forward;
        forwarders { 10.11.11.5;  10.11.11.6; };
         forward only;
};

zone &quot;w_tvbshare_prod.service.tvbshare&quot; IN {
        type forward;
        forwarders { 10.11.11.4; };
        forward only;
};

</code></pre>
<p><a href="http://www.361way.com/bind-master-slave/4811.html" target="_blank"
   rel="noopener nofollow noreferrer" >http://www.361way.com/bind-master-slave/4811.html</a></p>
<p><a href="https://www.cnblogs.com/fuhai0815/p/8459670.html" target="_blank"
   rel="noopener nofollow noreferrer" >https://www.cnblogs.com/fuhai0815/p/8459670.html</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ç†è§£ldap - ä»€ä¹ˆæ˜¯ldap</title>
      <link>https://www.oomkill.com/2019/08/ch1-understanding-ldap/</link>
      <pubDate>Fri, 23 Aug 2019 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2019/08/ch1-understanding-ldap/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯ç›®å½•æœåŠ¡">ä»€ä¹ˆæ˜¯ç›®å½•æœåŠ¡ï¼Ÿ</h2>
<p>==ç›®å½•æ˜¯ä¸€ç±»ä¸ºäº†æµè§ˆå’Œæœç´¢æ•°æ®è€Œè®¾è®¡çš„ç‰¹æ®Šçš„æ•°æ®åº“==ï¼Œä¾‹å¦‚ï¼šä¸ºäººæ‰€ç†ŸçŸ¥çš„å¾®è½¯å…¬
å¸çš„æ´»åŠ¨ç›®å½•ï¼ˆactive directoryï¼‰å°±æ˜¯ç›®å½•æ•°æ®åº“çš„ä¸€ç§ï¼Œç›®å½•æœåŠ¡æ˜¯æŒ‰ç…§==æ ‘çŠ¶å½¢å¼==å­˜å‚¨ä¿¡æ¯çš„ï¼Œç›®å½•åŒ…å«åŸºäºå±æ€§çš„æè¿°æ€§ä¿¡æ¯ï¼Œå¹¶ä¸”æ”¯æŒé«˜çº§çš„è¿‡æ»¤åŠŸèƒ½ã€‚</p>
<ul>
<li><a href="http://www.openldap.org/doc/admin24/intro.html" target="_blank"
   rel="noopener nofollow noreferrer" >http://www.openldap.org/doc/admin24/intro.html</a></li>
</ul>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œç›®å½•ä¸æ”¯æŒå¤§å¤šæ•°äº‹åŠ¡å‹æ•°æ®åº“æ‰€æ”¯æŒçš„<strong>é«˜ååé‡</strong>å’Œå¤æ‚çš„æ›´æ–°æ“ä½œã€‚ç›®å½•è¿›è¡Œæ›´æ–°æ“ä½œï¼Œå¯ä»¥è¯´æ˜¯è¦ä¹ˆå…¨éƒ¨ï¼Œè¦ä¹ˆéƒ½ä¸çš„åŸå­æ“ä½œã€‚ç›®å½•æœåŠ¡é€‚åˆçš„ä¸šåŠ¡åº”ç”¨åœ¨äºæä¾›å¤§é‡çš„<strong>æŸ¥è¯¢å’Œæœç´¢</strong>æ“ä½œï¼Œè€Œä¸æ˜¯å¤§é‡çš„å†™å…¥æ“ä½œã€‚Ldapå¯ä»¥è¯´æ˜¯æ´»åŠ¨ç›®å½•åœ¨linuxç³»ç»Ÿä¸Šçš„ä¸€ä¸ªå¼€æºå®ç°ã€‚</p>
<p>ä¸ºäº†ä¿è¯ç›®å½•æ•°æ®çš„å¯ç”¨æ€§å’Œå¯é æ€§ï¼Œåœ¨ç¡®ä¿ä½¿ç”¨ç›®å½•æœåŠ¡æä¾›å¿«é€ŸæŸ¥è¯¢å’Œæœç´¢æ“ä½œçš„åŒæ—¶ï¼Œç›®å½•æœåŠ¡è¿˜æä¾›äº†==ä¸»ä»æœåŠ¡å™¨åŒæ­¥ç›®å½•æ•°æ®ä¿¡æ¯çš„èƒ½åŠ›==ï¼Œè¿™ç›¸å½“äºä¼ ç»Ÿçš„MySQLæ•°æ®åº“çš„ä¸»ä»åŒæ­¥åŠŸèƒ½ä¸€æ ·ï¼Œå¯ä»¥æœ€å¤§é™åº¦çš„ç¡®ä¿åŸºäºç›®å½•ä¸šåŠ¡çš„æœåŠ¡æŒç»­å¯ç”¨æ€§ä¸æä¾›å¹¶å‘æŸ¥è¯¢èƒ½åŠ›ï¼Œå¾®è½¯å…¬å¸çš„æ´»åŠ¨ç›®å½•ï¼ˆactive directoryï¼‰å°±æœ‰ä¸»åŸŸå’Œå¤‡ä»½åŸŸçš„è¯´æ³•ã€‚</p>
<p>å¹¿ä¹‰çš„ç›®å½•æœåŠ¡æ¦‚å¿µï¼Œå¯ä»¥ç”¨å¤šç§ä¸åŒçš„æ–¹å¼æ¥æä¾›ç›®å½•æœåŠ¡ã€‚ä¸åŒçš„ç›®å½•æ‰€å…è®¸å­˜å‚¨çš„ä¿¡æ¯æ˜¯ä¸åŒçš„ï¼Œåœ¨ä¿¡æ¯å¦‚ä½•è¢«å¼•ç”¨ã€æŸ¥è¯¢ã€æ›´æ–°ä»¥åŠé˜²æ­¢æœªç»æˆæƒçš„è®¿é—®ç­‰é—®é¢˜ä¸Šï¼Œä¸åŒçš„ç›®å½•æœåŠ¡çš„å¤„ç†æ–¹å¼ä¹Ÿæœ‰è¯¸å¤šçš„ä¸åŒã€‚</p>
<p>ä¾‹å¦‚ï¼šä¸€äº›ç›®å½•æœåŠ¡æ˜¯æœ¬åœ°çš„ï¼Œåªæä¾›å—é™çš„æœåŠ¡ï¼ˆæ¯”å¦‚ï¼Œå•æœºä¸Šçš„fingeræœåŠ¡ï¼‰ã€‚å¦ä¸€äº›æœåŠ¡æ˜¯å¤§èŒƒå›´çš„ï¼ˆglobalï¼‰ï¼Œæä¾›å¹¿é˜”å¾—å¤šçš„æœåŠ¡ï¼ˆæ¯”å¦‚é¢å‘æ•´ä¸ªå› ç‰¹ç½‘ï¼‰ï¼Œå¤§èŒƒå›´çš„æœåŠ¡é€šå¸¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æ•°æ®æ˜¯åˆ†å¸ƒåœ¨å¤šå°æœºå™¨ä¸Šçš„ï¼Œè¿™äº›æœºå™¨ä¸€èµ·æ¥æä¾›ç›®å½•æœåŠ¡ï¼Œå…¸å‹çš„å¤§èŒƒå›´æœåŠ¡å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„åç§°ç©ºé—´ï¼ˆnamespaceï¼‰æ¥ç»™å‡ºä¸€ä¸ªç›¸åŒçš„æ•°æ®è§†å›¾ï¼ˆdata viewï¼‰ï¼Œè€Œä¸ç®¡ä½ ç›¸å¯¹äºæ•°æ®æ‰€åœ¨çš„ä½ç½®ã€‚DNSæ˜¯ä¸€ä¸ªå…¸å‹çš„å¤§èŒƒå›´åˆ†å¸ƒå¼ç›®å½•æœåŠ¡çš„ä¾‹å­ã€‚</p>
<ul>
<li><a href="http://www.openldap.org/faq/data/cache/595.html" target="_blank"
   rel="noopener nofollow noreferrer" >http://www.openldap.org/faq/data/cache/595.html</a></li>
</ul>
<h2 id="ä»€ä¹ˆæ˜¯ldap">ä»€ä¹ˆæ˜¯ldapï¼Ÿ</h2>
<p>ç›®å½•æœåŠ¡æœ‰ä¸¤ä¸ªå›½é™…æ ‡å‡†ï¼Œåˆ†åˆ«æ˜¯<code>X.500</code>å’Œ<code>LDAP</code>ã€‚X.500æ˜¯ITUå®šä¹‰çš„ç›®å½•æ ‡å‡†ï¼Œè€ŒLDAPæ˜¯åŸºäºTCP/IPçš„ç›®å½•è®¿é—®åè®®ï¼Œæ˜¯Intemetä¸Šç›®å½•æœåŠ¡çš„é€šç”¨è®¿é—®åè®®ã€‚</p>
<p>LDAPæ˜¯ <code>Lightweight Directory Access Protocol</code>ï¼ˆè½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼‰çš„ç¼©å†™ã€‚æ­£å¦‚å®ƒçš„åå­—æ‰€è¡¨æ˜çš„é‚£æ ·ï¼Œå®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ç›®å½•è®¿é—®åè®®ï¼Œç‰¹æŒ‡åŸºäºX.500çš„ç›®å½•è®¿é—®åè®®çš„ç®€åŒ–ç‰ˆæœ¬ã€‚LDAPè¿è¡Œåœ¨ <code>TCP/IP</code> æˆ–è€…å…¶ä»–çš„é¢å‘è¿æ¥çš„ä¼ è¾“æœåŠ¡ä¹‹ä¸Šã€‚LDAPå®Œæ•´çš„æŠ€æœ¯è§„èŒƒç”±RFC2251â€œThe Lightweight Directory Access Protocolï¼ˆv3ï¼‰â€å’Œå…¶ä»–å‡ ä¸ªåœ¨RFC3377ä¸­å®šä¹‰çš„æ–‡æ¡£ç»„æˆã€‚</p>
<ul>
<li>LDAPæ˜¯è½»é‡ç›®å½•è®¿é—®åè®®ï¼ˆLielhtweiglht Directory Access Protocolï¼‰çš„ç¼©å†™ã€‚</li>
<li>LDAPæ ‡å‡†å®é™…ä¸Šæ˜¯åœ¨X.500æ ‡å‡†åŸºç¡€ä¸Šäº§ç”Ÿçš„ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ã€‚</li>
</ul>
<h2 id="ä»€ä¹ˆæ˜¯x500">ä»€ä¹ˆæ˜¯X.500ï¼Ÿ</h2>
<p>X.500ç”±ITU-Tå’ŒISOå®šä¹‰ï¼Œå®ƒå®é™…ä¸Šä¸æ˜¯ä¸€ä¸ªåè®®ï¼Œè€Œæ˜¯ç”±ä¸€ä¸ª==åè®®æ—==ç»„æˆï¼ŒåŒ…æ‹¬äº†ä»X.501åˆ°X.525ç­‰ä¸€ç³»åˆ—éå¸¸å®Œæ•´çš„ç›®å½•æœåŠ¡åè®®ã€‚</p>
<p>ä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼ŒLDAPæ˜¯ä¸€ä¸ªåˆ°X.500ç›®å½•æœåŠ¡çš„ç›®å½•è®¿é—®åè®®ï¼ŒX.500æ˜¯ä¸€ä¸ªOSIç›®å½•æœåŠ¡ã€‚æœ€åˆï¼ŒLDAPå®¢æˆ·ç«¯é€šè¿‡ç½‘å…³è®¿é—®X.500ç›®å½•æœåŠ¡ã€‚ç½‘å…³åœ¨å®¢æˆ·ç«¯å’Œç½‘å…³ä¹‹é—´è¿è¡ŒLDAPï¼Œè€ŒX.500ç›®å½•è®¿é—®åè®®ï¼ˆDirectory Access Protocolï¼ŒDAPï¼‰ï¼Œä½äºè¿™ä¸ªç½‘å…³å’ŒX.500æœåŠ¡å™¨ä¹‹é—´ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/8778" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>LDAPæ˜¯ä¸€ä¸ªé‡é‡çº§çš„åè®®ï¼Œåœ¨æ•´ä¸ªOSIåè®®æ ˆä¸Šè¿›è¡Œæ“ä½œï¼Œè€Œä¸”éœ€è¦å ç”¨å¤§é‡çš„è®¡ç®—èµ„æºã€‚è€ŒLDAPè¢«è®¾è®¡ä¸ºåœ¨TCP/IPå±‚ä¸Šæ“ä½œï¼Œä»¥å°å¾—å¤šçš„ä»£ä»·å®ç°äº†å¤§å¤šæ•°LDAPçš„åŠŸèƒ½ã€‚</p>
<p>è™½ç„¶LDAPä»æ—§å¯ä»¥é€šè¿‡ç½‘å…³è®¿é—®X.500ç›®å½•æœåŠ¡å™¨ï¼Œä½†æ˜¯ç°åœ¨é€šå¸¸éƒ½æ˜¯åœ¨X.500æœåŠ¡å™¨ä¸Šç›´æ¥å®ç°LDAPã€‚</p>
<p>å•ç‹¬çš„LDAPå®ˆæŠ¤ç¨‹åºopenldap slapdï¼Œå¯ä»¥è¢«çœ‹åšæ˜¯ä¸€ä¸ªè½»é‡çº§çš„X.500ç›®å½•æœåŠ¡å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ²¡æœ‰å®ç°X.500å®Œæ•´çš„DAPåè®®ã€‚ä½œä¸ºä¸€ä¸ªè½»é‡çº§çš„ç›®å½•æœåŠ¡å™¨ï¼Œslapdå®ç°çš„ä»…ä»…æ˜¯X.500æ¨¡å‹çš„ä¸€ä¸ªå­é›†ã€‚</p>
<p>LDAPä¸­çš„å¸¸ç”¨åè¯ç¼©å†™åŠå«ä¹‰ã€‚</p>
<p>LDAPåŸºæœ¬æ¦‚å¿µä¸­çš„å¸¸ç”¨åè¯ç¼©å†™åŠå«ä¹‰</p>
<table>
<thead>
<tr>
<th>å…³Â é”®å­—</th>
<th>Â Â è‹±æ–‡å…¨ç§°</th>
<th>å«Â ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>dc</td>
<td>Domain Component</td>
<td>åŸåçš„éƒ¨åˆ†ï¼Œå…¶æ ¼å¼æ˜¯å°†å®Œæ•´çš„åŸååˆ†æˆå‡ éƒ¨åˆ†ï¼Œå¦‚åŸŸåä¸ºexaple.comå˜æˆ<code>dc=exaple,dc=com</code></td>
</tr>
<tr>
<td>uid</td>
<td>User Id</td>
<td>ç”¨æˆ·IDï¼Œå¦‚ â€œoldboyâ€ã€‚</td>
</tr>
<tr>
<td>ou</td>
<td>Organization Unit</td>
<td>ç»„ç»‡å•ä½ï¼Œç±»ä¼¼äºLimuxæ–‡ä»¶ç³»ç»Ÿä¸­çš„å­ç›®å½•ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œç»„ç»‡å•ä½å¯ä»¥åŒ…å«å…¶ä»–å„ç§å¯¹è±¡ï¼ˆåŒ…æ‹¬å…¶ä»–ç»„ç»‡å•å…ƒï¼‰ï¼Œå¦‚â€œtechï¼Œrongjunfengï¼Œbinggeâ€</td>
</tr>
<tr>
<td>cn</td>
<td>Common Name</td>
<td>å…¬å…±åç§°ï¼Œå¦‚ â€œThowas Johanssonâ€</td>
</tr>
<tr>
<td>sn</td>
<td>Surnase</td>
<td>å§“ï¼Œå¦‚ â€œJohanssonâ€</td>
</tr>
<tr>
<td>dn</td>
<td>Distinguished Name</td>
<td>å”¯ä¸€è¾¨åˆ«åï¼Œç±»ä¼¼äºLinuxæ–‡ä»¶ç³»ç»Ÿä¸­çš„ç»å¯¹è·¯å¾„ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åç§°ï¼Œå¦‚<code>uid=tos,ou=market,dc=example,dc=com</code>ï¼Œåœ¨ä¸€ä¸ªç›®å½•æ ‘ä¸­ æ€»æ˜¯å”¯ä¸€çš„ã€‚</td>
</tr>
<tr>
<td>rdn</td>
<td>Relative  dn</td>
<td>ç›¸å¯¹è¾¨åˆ«åï¼Œç±»ä¼¼äºæ–‡ä»¶ç³»ç»Ÿä¸­çš„ç›¸å¯¹è·¯å¾„ï¼Œå®ƒæ˜¯ä¸ç›®å½•æ ‘ç»“æ„æ— å…³çš„éƒ¨åˆ†ï¼Œå¦‚<code>uid=tom</code>æˆ–<code>cn=Thoeas Johansscn</code>ã€‚</td>
</tr>
<tr>
<td>c</td>
<td>Country</td>
<td>å›½å®¶ï¼Œå¦‚â€œCNâ€æˆ–â€œUSâ€ç­‰</td>
</tr>
<tr>
<td>o</td>
<td>organizatione</td>
<td>ç»„ç»‡åï¼Œå¦‚â€œExampleï¼ŒInc.â€ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="ldapç›®å½•æœåŠ¡çš„ç‰¹ç‚¹">LDAPç›®å½•æœåŠ¡çš„ç‰¹ç‚¹</h2>
<p>LDAPï¼ˆopenldapï¼‰ç›®å½•æœåŠ¡å…·æœ‰ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<ul>
<li>LDAPæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ã€æ ‡å‡†çš„åè®®ï¼Œè¿‘å‡ å¹´æ¥å¾—åˆ°äº†ä¸šç•Œå¹¿æ³›çš„è®¤å¯ã€‚</li>
<li>LDAPçš„ç»“æ„ç”¨æ ‘å‹ç»“æ„æ¥è¡¨ç¤ºï¼Œè€Œä¸æ˜¯ç”¨è¡¨æ ¼ã€‚å› æ­¤ä¸ç”¨SQLè¯­å¥ç»´æŠ¤äº†ã€‚</li>
<li>LDAPæä¾›äº†é™æ€æ•°æ®çš„å¿«é€ŸæŸ¥è¯¢æ–¹å¼ï¼Œä½†åœ¨æ›´æ–°æ•°æ®æ–¹é¢å¹¶ä¸æ“…é•¿ã€‚</li>
<li>LDAPæœåŠ¡å¯ä»¥ä½¿ç”¨åŸºäºâ€œæ¨â€æˆ–â€œæ‹‰â€çš„å¤åˆ¶ä¿¡æ¯æŠ€æœ¯ï¼Œç”¨ç®€å•çš„æˆ–åŸºäºå®‰å…¨è¯ä¹¦çš„å®‰å…¨è®¤è¯ï¼Œå¤åˆ¶éƒ¨åˆ†æˆ–å…¨éƒ¨æ•°æ®ï¼Œæ—¢ä¿è¯äº†æ•°æ®çš„å®‰å…¨æ€§ï¼Œåˆæé«˜äº†æ•°æ®çš„è®¿é—®æ•ˆç‡ï¼š</li>
<li>LDAPæ˜¯ä¸€ä¸ªå®‰å…¨çš„åè®®ï¼ŒLDAPv3æ”¯æŒSASLï¼ˆSimple Authentication and Security Layerï¼‰ã€SSLï¼ˆSecure Socket Layerï¼‰å’ŒTLSï¼ˆTransport Layer Securityï¼‰ï¼Œä½¿ç”¨è®¤è¯æ¥ç¡®ä¿äº‹åŠ¡çš„å®‰å…¨ï¼Œå¦å¤–ï¼ŒLDAPæä¾›äº†ä¸åŒå±‚æ¬¡çš„è®¿é—®æ§åˆ¶ï¼Œä»¥é™åˆ¶ä¸åŒç”¨æˆ·çš„è®¿é—®æƒé™ã€‚</li>
<li>LDAPæ”¯æŒå¼‚ç±»æ•°æ®å­˜å‚¨ï¼ŒLDAPå­˜å‚¨çš„æ•°æ®å¯ä»¥æ˜¯æ–‡æœ¬èµ„æ–™ã€äºŒè¿›åˆ¶å›¾ç‰‡ç­‰ã€‚</li>
<li>Client/Server æ¨¡å‹ï¼šServerç«¯ç”¨äºå­˜å‚¨æ ‘ï¼ŒClientç«¯æä¾›æ“ä½œç›®å½•ä¿¡æ¯æ ‘çš„å·¥å…·ï¼Œé€šè¿‡è¿™äº›å·¥å…·ï¼Œå¯ä»¥å°†æ•°æ®åº“çš„å†…å®¹ä»¥æ–‡æœ¬æ ¼å¼ï¼ˆLDAPæ•°æ®äº¤æ¢æ ¼å¼ï¼ŒLDIFï¼‰å‘ˆç°åœ¨æˆ‘ä»¬çš„é¢å‰ã€‚</li>
<li>LDAPæ˜¯ä¸€ç§å¼€æ”¾Internet æ ‡å‡†ï¼ŒLDAPåè®®æ˜¯è·¨å¹³å°çš„çš„Interentåè®®ï¼Œå®ƒæ˜¯åŸºäºX.500æ ‡å‡†çš„ï¼Œä¸X.500ä¸åŒï¼ŒLDAPæ”¯æŒTCP/IPï¼ˆå³å¯ä»¥åˆ†å¸ƒå¼éƒ¨ç½²ï¼‰ã€‚</li>
</ul>
<h2 id="ldapçš„ç›®å½•ç»“æ„">LDAPçš„ç›®å½•ç»“æ„</h2>
<p>LDAPç›®å½•æœåŠ¡æ˜¯é€šè¿‡ç›®å½•æ•°æ®åº“æ¥å­˜å‚¨ç½‘ç»œä¿¡æ¯æ¥æä¾›ç›®å½•æœåŠ¡çš„ã€‚ä¸ºäº†æ–¹ä¾¿ç”¨æˆ·è¿…é€ŸæŸ¥æ‰¾å’Œå®šä½ä¿¡æ¯ï¼Œç›®å½•æ•°æ®åº“æ˜¯ä»¥ç›®å½•ä¿¡æ¯æ ‘ï¼ˆDirectory Infornation Treeï¼Œç¼©å†™ä¸ºDITï¼‰ä¸ºå­˜å‚¨æ–¹å¼çš„æ ‘å‹å­˜å‚¨ç»“æ„ï¼Œç›®å½•ä¿¡æ¯æ ‘åŠå…¶ç›¸å…³æ¦‚å¿µæ„æˆäº†LDAPåè®®çš„ä¿¡æ¯æ¨¡å‹ã€‚</p>
<ul>
<li>åœ¨LDAPä¸­ï¼Œç›®å½•æ˜¯æŒ‰ç…§æ ‘å‹ç»“æ„ç»„ç»‡ä¸€ä¸€ç›®å½•ä¿¡æ¯æ ‘ï¼ˆDirectory Information Treeç®€å†™DITï¼‰ï¼ŒDITæ˜¯ä¸€ä¸ªä¸»è¦è¿›è¡Œè¯»æ“ä½œçš„æ•°æ®åº“ã€‚</li>
<li>DITç”±æ¡ç›®ï¼ˆEntryï¼‰ç»„æˆï¼Œæ¡ç›®ç›¸å½“äºå…³ç³»æ•°æ®åº“ä¸­çš„è¡¨çš„è®°å½•ï¼š</li>
</ul>
<p>æ¡ç›®æ˜¯å…·æœ‰åˆ†è¾¨åDNï¼ˆDistinguished Nameï¼‰çš„å±æ€§-å€¼å¯¹ï¼ˆAttribute-valueï¼Œç®€ç§°AVï¼‰
çš„é›†åˆã€‚</p>
<p>åœ¨UNIXæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæœ€é¡¹å±‚æ˜¯æ ¹ç›®å½•ï¼ˆrootï¼‰ï¼ŒLDAPç›®å½•é€šå¸¸ä¹Ÿç”¨ROOTåšæ ¹ï¼Œé€šå¸¸ç§°ä¸º<code>BaseDN</code>ã€‚</p>
<p>å› ä¸ºå†å²ï¼ˆX.500ï¼‰çš„åŸå› ï¼ŒLDAPç›®å½•ç”¨OUï¼ˆOrganization Unitï¼‰ä»é€»è¾‘ä¸ŠæŠŠæ•°æ®åˆ†å¼€æ¥ã€‚Ouä¹Ÿæ˜¯ä¸€ç§æ¡ç›®&ndash;==å®¹å™¨æ¡ç›®==ã€‚Ouä¸‹é¢å³æ˜¯çœŸæ­£çš„ç”¨æˆ·æ¡ç›®ã€‚</p>
<blockquote>
<p><strong>ä»€ä¹ˆæ˜¯dn?</strong></p>
</blockquote>
<p>DNï¼ŒDistinguished Nameï¼Œå³åˆ†è¾¨åã€‚</p>
<p>åœ¨LDAPä¸­ï¼Œä¸€ä¸ªæ¡ç›®çš„åˆ†è¾¨åå«åšâ€œDNâ€ï¼ŒDNæ˜¯è¯¥æ¡ç›®åœ¨æ•´ä¸ªæ ‘ä¸­çš„å”¯ä¸€åç§°æ ‡è¯†ï¼ŒDNç›¸å½“äºå…³ç³»æ•°æ®å¸­è¡¨ä¸­çš„å…³é”®å­—ï¼ˆPrimary Keyï¼‰ï¼›å®ƒæ˜¯ä¸€ä¸ªè¯†åˆ«å±æ€§ï¼Œé€šå¸¸ç”¨äºæ£€ç´¢ã€‚</p>
<blockquote>
<p><strong>DNçš„ä¸¤ç§è®¾ç½®</strong></p>
</blockquote>
<p>åŸºäºcnï¼ˆå§“åï¼‰ï¼Œ<code>cn=test,ou=auth,dc=cylon,dc=org</code>ï¼Œæœ€å¸¸è§çš„cnæ˜¯ä» <code>/etc/group</code> è½¬æ¥çš„æ¡ç›®ã€‚.</p>
<p>åŸºäºuidï¼ˆUser IDï¼‰ï¼Œ<code>uid=test,ou=auth,dc=cylon,dc=org</code> æœ€å¸¸è§çš„uidæ˜¯ <code>/etc/passwd</code> è½¬æ¥çš„æ¡ç›®ã€‚</p>
<blockquote>
<p><strong>Base DN</strong></p>
</blockquote>
<p>LDAPç›®å½•æ ‘çš„æœ€é¡¶éƒ¨å°±æ˜¯æ ¹ï¼Œä¹Ÿå°±æ˜¯Base DN.</p>
<blockquote>
<p><strong>LDIFæ ¼å¼</strong></p>
</blockquote>
<p>LDIFæ ¼å¼æ˜¯ç”¨äºLDAPæ•°æ®å¯¼å…¥ã€å¯¼å‡ºçš„æ ¼å¼ã€‚LDIFæ˜¯LDAPæ•°æ®åº“ä¿¡æ¯çš„ä¸€ç§æ–‡æœ¬æ ¼å¼ã€‚BDBã€‚</p>
<blockquote>
<p><strong>ä»€ä¹ˆæ ·çš„ä¿¡æ¯å¯ä»¥å­˜å‚¨åœ¨ç›®å½•å½“ä¸­ï¼Ÿ</strong></p>
</blockquote>
<p>LDAPçš„ä¿¡æ¯æ¨¡å‹æ˜¯åŸºäºæ¡ç›®çš„ï¼ˆentryï¼‰ã€‚ä¸€ä¸ªæ¡ç›®å°±æ˜¯ä¸€äº›å…·æœ‰å…¨å±€å”¯ä¸€çš„æ ‡è¯†åï¼ˆDistinguished Nameï¼Œç®€å†™åš==DN==ï¼‰çš„å±æ€§çš„é›†åˆã€‚DNç”¨äºæ— äºŒä¹‰æ€§çš„æŒ‡ä»£ä¸€ä¸ªå”¯ä¸€çš„æ¡ç›®ï¼Œæ¡ç›®çš„æ¯ä¸€ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªç±»å‹ï¼ˆtypeï¼‰ï¼Œä¸€ä¸ªæˆ–è€…å¤šä¸ªå€¼ï¼ˆvalueï¼‰ï¼Œç±»å‹ï¼ˆtypeï¼‰å¾€å¾€æ˜¯ç‰¹å®šå­—ç¬¦ä¸²çš„ç®€å†™ï¼Œæ¯”å¦‚ç”¨ <code>cn</code> æŒ‡ä»£ <code>commpn name</code>ï¼Œæˆ–è€… <code>mail</code> æŒ‡ä»£ç”µå­é‚®ä»¶åœ°å€ã€‚å€¼ï¼ˆvalueï¼‰çš„è¯­æ³•ä¾èµ–äºç±»å‹ï¼ˆtypeï¼‰ï¼Œæ¯”å¦‚ï¼Œç±»å‹ä¸ºcnçš„å±æ€§å¯èƒ½åŒ…å«å€¼Babs Jensenã€‚
ç±»å‹ä¸ºmailçš„å±æ€§å¯èƒ½åŒ…å«å€¼ <code>babs@example.com</code> ã€‚ç±»å‹ä¸ºjpegPhotoçš„å±æ€§å¯èƒ½åŒ…å«äºŒè¿›åˆ¶æ ¼å¼çš„JPEGå›¾è±¡ã€‚</p>
<p>ä¸‹é¢æ˜¯LDAPä¸­æ¡ç›®ä¿¡æ¯çš„ä¾‹å­ï¼›å°±ç›¸å½“äºæ•°æ®åº“è¡¨ä¸­çš„ä¸¤è¡Œè®°å½•ï¼š</p>
<p>LDAPå…è®¸ä½ é€šè¿‡ä½¿ç”¨ä¸€ç§å«åš <code>objectClass</code>çš„ç‰¹æ®Šå±æ€§æ¥æ§åˆ¶å“ªäº›å±æ€§æ˜¯æ¡ç›®æ‰€å¿…é¡»çš„ï¼Œå“ªäº›å±æ€§æ˜¯æ¡ç›®å¯é€‰çš„ï¼Œ<code>objectClass</code> å±æ€§çš„å€¼æ˜¯ç”±æ¡ç›®æ‰€å¿…é¡»éµä»çš„æ–¹æ¡ˆï¼ˆschemaï¼‰
æ¥å»ºä¹‰çš„ã€‚</p>
<p>é€šè¿‡ä¸‹é¢å‘½ä»¤å¯ä»¥å–å‡ºä¸Šé¢çš„å†…å®¹ã€‚</p>
<pre><code class="language-sh">ldapsearch -LLL -w oldboy -x -H ldap://10.0.0.20 -D &quot;cn=admin,dc=cylon,dc=org&quot; -b &quot;dc=cylon,dc=org&quot; uid=&quot;*&quot;
</code></pre>
<p>ä¿¡æ¯åœ¨ç›®å½•ä¸­æ˜¯å¦‚ä½•ç»„ç»‡çš„ï¼Ÿ</p>
<p>åœ¨LDAPä¸­ï¼Œæ¡ç›®æ˜¯æŒ‰æ ‘çŠ¶çš„å±‚æ¬¡ç»“æ„ç»„ç»‡çš„ï¼Œä¼ ç»Ÿä¸Šï¼Œè¿™ä¸ªç»“æ„å¾€å¾€æ˜¯åœ°ç†ç•Œé™æˆ–è€…ç»„ç»‡ç•Œé™çš„åæ˜ ã€‚ä»£è¡¨å›½å®¶çš„æ¡ç›®ä½äºæ•´ä¸ªç›®å½•æ ‘çš„é¡¶å±‚ã€‚ä¹‹ä¸‹çš„æ¡ç›®åˆ™ä»£è¡¨å„ä¸ªå·ä»¥åŠå›½å®¶æ€§çš„ç»„ç»‡ï¼Œå†ä¸‹é¢çš„æ¡ç›®åˆ™ä»£è¡¨ç€ç»„ç»‡å•ä½ã€ä¸ªäººæ‰“å°æœºã€æ–‡ä»¶ï¼Œæˆ–è€…ä½ æ‰€èƒ½æƒ³åˆ°çš„å…¶ä»–ä¸œè¥¿ï¼Œå›¾1.1æ˜¾ç¤ºäº†æŒ‰ç…§ä¼ ç»Ÿå‘½åæ–¹å¼ç»„ç»‡çš„LDAPç›®å½•ä¿¡æ¯æ ‘ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/intro_tree.png" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center>å›¾1.1ï¼šLDAPç›®å½•æ ‘ï¼ˆä¼ ç»Ÿå‘½åæ–¹å¼ï¼‰</center>
<p>ç›®å½•æ ‘ä¹Ÿå¯ä»¥æŒ‰ç…§å› ç‰¹ç½‘åŸŸåç»“æ„ç»„ç»‡ã€‚å› ä¸ºå®ƒå…è®¸æŒ‰ç…§DNSå¯¹ç›®å½•æœåŠ¡è¿›è¡Œå®šä½ï¼Œè¿™ç§å‘½åæ–¹å¼æ­£å˜å¾—è¶Šæ¥è¶Šå—æ¬¢è¿ã€‚å›¾1.2æ˜¾ç¤ºäº†æŒ‰ç…§åŸŸåè¿›è¡Œç»„ç»‡çš„ä¸€ä¸ªLDAPç›®å½•æ ‘çš„ä¾‹å­ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/intro_dctree.png" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ul>
<li><a href="http://www.openldap.org/doc/admin24/intro.html" target="_blank"
   rel="noopener nofollow noreferrer" >http://www.openldap.org/doc/admin24/intro.html</a></li>
</ul>
<p>root -&gt; é¡¶çº§åŸŸ -&gt; äºŒçº§ -&gt; ou -&gt; uid</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567525992883.png" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center>å›¾1-2ï¼šLDAPç›®å½•æ ‘ï¼ˆåŸŸåå‘½åæ–¹å¼ï¼‰</center>
<p>ä¾‹ï¼š<code>dn:cn=testlb,ou=People,ou=accounts,dc=cylon,dc=org</code></p>
<p>å¦å¤–ï¼ŒLDAPå…è®¸ä½ é€šè¿‡ä½¿ç”¨ä¸€ç§å«åšobjectClassçš„ç‰¹æ®Šå±æ€§æ¥æ§åˆ¶å“ªäº›å±æ€§æ˜¯æ¡ç›®æ‰€å¿…é¡»çš„ï¼Œå“ªäº›å±æ€§æ˜¯æ¡ç›®å¯é€‰çš„ã€‚objectClasså±æ€§çš„å€¼æ˜¯ç”±æ¡ç›®æ‰€å¿…é¡»éµä»çš„æ–¹æ¡ˆ
ï¼ˆschemaï¼‰æ¥å®šä¹‰çš„ã€‚.</p>
<p>ï¼ˆ3ï¼‰ä¿¡æ¯æ˜¯å¦‚ä½•æ¢°å¼•ç”¨çš„ï¼Ÿ</p>
<p>ä¸€ä¸ªæ¡ç›®æ˜¯é€šè¿‡å®ƒçš„æ ‡è¯†åæ¥å¼•ç”¨çš„ã€‚è€Œæ ‡è¯†åæ˜¯ç”±ç›¸å¯¹æ ‡è¯†åï¼ˆRelative Distinguished Nameæˆ–è€…RDNï¼‰å’Œå®ƒçš„çˆ¶æ¡ç›®åè¿åœ¨ä¸€èµ·æ„æˆçš„ã€‚æ¯”å¦‚ï¼Œåœ¨å› ç‰¹ç½‘å‘½åçš„ä¾‹å­ä¸­ï¼ŒBarbara Jensenæ¡ç›®æœ‰ç›¸å¯¹æ ‡è¯†å <code>uid=babs</code> å’Œæ ‡è¯†åä¸ºï¼š<code>uid=babs,ou=People,de=example,dc=com</code> ã€‚</p>
<h3 id="ldifæ•°æ®æ–‡ä»¶ä»‹ç»">LDIFæ•°æ®æ–‡ä»¶ä»‹ç»</h3>
<p>ç›®å½•æ•°æ®æ–‡ä»¶å†…å®¹è®²è§£</p>
<p>LDIFï¼ˆLDAP Data Interchangep-omatï¼‰è½»é‡çº§ç›®å½•äº¤æ¢æ ¼å¼ï¼‰ä¸€ç§ASCIIæ–‡ä»¶æ ¼å¼ï¼Œç”¨æ¥äº¤æ¢æ•°æ®å¹¶ä½¿å¾—åœ¨LDAPæœåŠ¡å™¨é—´äº¤æ¢æ•°æ®æˆä¸ºå¯èƒ½ã€‚</p>
<p>LDIFæ–‡ä»¶æœ€å¸¸ç”¨çš„åŠŸèƒ½å°±æ˜¯å‘ç›®å½•å¯¼å…¥æˆ–ä¿®æ”¹ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯çš„æ ¼å¼éœ€è¦æŒ‰ç…§LDAPä¸­æ¶æ„ï¼ˆschemaï¼‰æ ¼å¼ç»„ç»‡ï¼Œå¦‚æœä¸ç¬¦åˆå…¶è¦æ±‚çš„æ ¼å¼å°±ä¼šå‡ºç°é”™è¯¯ã€‚</p>
<p>LDIFæ–‡ä»¶çš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li>é€šè¿‡ç©ºè¡Œæ¥åˆ†å‰²ä¸€ä¸ªæ¡ç›®æˆ–å®šä¹‰ã€‚</li>
<li>ä»¥<code>#</code>å¼€å§‹çš„è¡Œä¸ºæ³¨é‡Šã€‚</li>
<li>æ‰€æœ‰å±æ€§çš„èµ‹å€¼æ–¹æ³•ä¸ºï¼š<code>&quot;å±æ€§: å±æ€§å€¼&quot;</code> ä¾‹å¦‚ï¼Œdn:<code>dn=cylon,dc=org</code></li>
<li>å±æ€§å¯ä»¥è¢«é‡å¤èµ‹å€¼ã€‚ä¾‹å¦‚objectclasså°±å¯ä»¥æœ‰å¤šä¸ªï¼Œæ¯ä¸ªå±æ€§ç‹¬ç«‹ä¸€è¡Œã€‚</li>
<li>æ¯è¡Œçš„ç»“å°¾ä¸å…è®¸æœ‰ç©ºæ ¼ã€‚</li>
</ul>
<p>åœ¨LDAPçš„æ¯æ¡è®°å½•ä¸­å¿…é¡»åŒ…å«ä¸€ä¸ªobjectclasså±æ€§ï¼Œä¸”å…¶éœ€è¦èµ‹å­è‡³å°‘ä¸€ä¸ªå€¼ã€‚objectclasså±æ€§æœ‰ç­‰çº§ä¹‹åˆ†ï¼Œå±æ€§ç›¸å½“äºå˜é‡ï¼Œå®ƒå¯ä»¥è¢«è‡ªå®šä¹‰èµ‹å€¼ï¼Œå€¼ä¸èƒ½ç›¸åŒã€‚</p>
<p>ç›®å½•æ•°æ®å±•ç°çš„æ ‘å½¢ç»“æ„åœ†ã€‚ä»¥ä¸Šldifæ•°æ®æ–‡ä»¶è¡¨ç°ä¸ªå†…å®¹ä¸ºå¦‚ä¸‹æ ‘å½¢ç»“æ„ï¼šldap C/Så·¥å…·å‘ˆç°çš„ã€‚</p>
<h2 id="ldapæ˜¯æƒ³æ ·å·¥ä½œçš„">LDAPæ˜¯æƒ³æ ·å·¥ä½œçš„ï¼Ÿ</h2>
<p>LDAPç›®å½•æœåŠ¡æ˜¯åŸºäº C/Sæ¨¡å¼çš„ã€‚ä¸€ä¸ªæˆ–è€…å¤šä¸ªLDAPæœåŠ¡å™¨åŒ…å«ç€ç»„æˆæ•´ä¸ªç›®å½•ä¿¡æ¯æ ‘ï¼ˆDITï¼‰çš„æ•°æ®ï¼Œå®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨å¹¶ä¸”å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼ˆrequestï¼‰ï¼Œç„¶åæœåŠ¡å™¨è¦ä¹ˆä»¥ä¸€ä¸ªå›ç­”ï¼ˆanswerï¼‰å­ä»¥å›åº”ï¼Œè¦ä¹ˆç»™å‡ºä¸€ä¸ªæŒ‡é’ˆï¼Œå®¢æˆ·å¯ä»¥é€šè¿‡æ­¤æŒ‡é’ˆè·å–åˆ°æ‰€éœ€çš„æ•°æ®ï¼ˆé€šå¸¸ï¼Œè¯¥æŒ‡é’ˆæ˜¯æŒ‡å‘å¦ä¸€ä¸ªLDAPæœåŠ¡å™¨ï¼‰ï¼Œæ— è®ºå®¢æˆ·ç«¯è¿åˆ°å“ªä¸ªLDAPæœåŠ¡å™¨ï¼Œå®ƒçœ‹åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªç›®å½•è§†å›¾ï¼ˆviewï¼‰.è¿™æ˜¯LDAPè¿™ç±»å…¨å±€ç›®å½•æœåŠ¡çš„ä¸€ä¸ªé‡è¦ç‰¹å¾ã€‚</p>
<h2 id="ldapçš„å‡ ä¸ªé‡è¦é…ç½®æ¨¡å¼">LDAPçš„å‡ ä¸ªé‡è¦é…ç½®æ¨¡å¼</h2>
<p>LDAPæœåŠ¡çš„å‡ ä¸ªé‡è¦åŠŸèƒ½ï¼š</p>
<ul>
<li>â˜…â˜…â˜…åŸºæœ¬çš„ç›®å½•æŸ¥è¯¢æœåŠ¡ã€‚</li>
<li>ç›®å½•æŸ¥è¯¢ä»£ç†æœåŠ¡ã€‚</li>
<li>å¼‚æœºå¤åˆ¶æ•°æ®ï¼ˆå³ä¸»ä»åŒæ­¥ï¼‰ã€‚</li>
</ul>
<h3 id="æœ¬åœ°åŸºæœ¬çš„ç›®å½•æŸ¥è¯¢æœåŠ¡">æœ¬åœ°åŸºæœ¬çš„ç›®å½•æŸ¥è¯¢æœåŠ¡</h3>
<p>åœ¨è¿™ç§é…ç½®æ¨¡å¼ä¸‹ï¼Œä½ çš„slapdåªä¸ºä½ çš„æœ¬åœ°åŸŸæä¾›ç›®å½•æœåŠ¡ã€‚å®ƒä¸ä¼šä»¥ä»»ä½•æ–¹å¼ä¸åˆ«çš„ç›®å½•æœåŠ¡å™¨äº¤äº’ã€‚è¿™ç§é…ç½®æ¨¡å¼å¦‚å›¾1æ‰€ç¤ºã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567525992658.png" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center>æœ¬åœ°é…ç½®æ¨¡å¼</center>
<h3 id="å¸¦æœ‰æŒ‡é’ˆreferralsçš„æœ¬åœ°ç›®å½•æœåŠ¡">å¸¦æœ‰æŒ‡é’ˆï¼ˆReferralsï¼‰çš„æœ¬åœ°ç›®å½•æœåŠ¡ã€‚</h3>
<p>å³ç›®å½•æŸ¥è¯¢ä»£ç†æœåŠ¡ï¼Œç±»ä¼¼DNSçš„è½¬å‘æœåŠ¡å™¨ã€‚</p>
<p>åœ¨è¿™ç§é…ç½®æ¨¡å¼ä¸‹ï¼Œä½ ä¸ºä½ çš„æœ¬åœ°åŸŸè¿è¡Œä¸€ä¸ªLDAPæœåŠ¡å™¨ï¼Œå¹¶ä¸”å°†å®ƒé…ç½®æˆä¸ºå½“å®¢æˆ·çš„è¯·æ±‚è¶…å‡ºä½ çš„æœ¬åœ°åŸŸçš„å¤„ç†èƒ½åŠ›çš„æ—¶å€™èƒ½å¤Ÿè¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå…·å¤‡å¤„ç†å®¢æˆ·è¯·æ±‚èƒ½åŠ›çš„æ›´é«˜çº§çš„æœåŠ¡å™¨çš„åœ°å€ã€‚ä½ å¯ä»¥è‡ªå·±è¿è¡Œè¿™ä¸€æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«äººå·²æä¾›ç»™ä½ çš„ä¸€ä¸ªã€‚è¿™ç§é…ç½®æ¨¡å¼å¦‚å›¾2æ‰€ç¤ºã€‚ï¼š</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567525992983.png" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>å¦‚æœä½ æƒ³è¿è¡Œæœ¬åœ°ç›®å½•æœåŠ¡å¹¶ä¸”å‚ä¸å…¨å±çš„ç›®å½•ï¼Œé‚£ä¹ˆè¿è¡Œè¿™ç§æ¨¡å¼ã€‚ä¾‹å¦‚ï¼šopenldapä½œä¸ºå¾®è½¯æ´»åŠ¨ç›®å½•çš„ä»£ç†æŸ¥è¯¢æœåŠ¡ã€‚</p>
<pre><code>referral &lt;URI&gt;
</code></pre>
<p>è¯¥æŒ‡ä»¤æŒ‡å®šäº†ä¸€ä¸ªæŒ‡é’ˆï¼Œå½“æœåŠ¡å™¨çš„slapdæ‰¾ä¸åˆ°ä¸€ä¸ªæœ¬åœ°çš„æ•°æ®åº“æ¥å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒæŠŠè¯¥æŒ‡é’ˆå›ä¼ ç»™å®¢æˆ·ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code>referral ldap://root.openldap.org
</code></pre>
<p>è¿™å°†æŠŠéæœ¬åœ°çš„è¯·æ±‚â€œæ¨â€åˆ°OpenLDAPçš„æ ¹æœåŠ¡å™¨ä¸Šã€‚â€œèªæ˜çš„â€ LDAPå®¢æˆ·ä¼šå‘åé¦ˆå›æ¥çš„æŒ‡é’ˆæ‰€æŒ‡çš„æœåŠ¡å™¨é‡æ–°å‘å‡ºè¯·æ±‚ã€‚ä½†æ˜¯å¾—æ³¨æ„å¤§å¤šæ•°å®¢æˆ·ä»…ä»…çŸ¥é“æ€ä¹ˆæ ·å¤„ç†ç®€å•çš„LDAPçš„URLï¼Œå…¶ä¸­åŒ…å«ä¸»æœºéƒ¨åˆ†å’Œå¯é€‰çš„DNéƒ¨åˆ†ã€‚</p>
<h3 id="åŒå¤šå¤åˆ¶çš„ç›®å½•æœåŠ¡">åŒå¤šå¤åˆ¶çš„ç›®å½•æœåŠ¡ã€‚</h3>
<p>slarpdå®ˆæŠ¤ç¨‹åºæ˜¯ç”¨æ¥å°†ä¸»slapdä¸Šçš„æ”¹å˜ä¼ æ’­åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªä»å±çš„slapdä¸Šã€‚ä¸€ä¸ªmaster-slave ç±»å‹çš„é…ç½®ç¤ºä¾‹å¦‚å›¾3æ‰€ç¤ºã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/9100" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>è¿™ç§é…ç½®æ¨¡å¼å¯ä»¥å’Œå‰é¢çš„ä¸¤ç§é…ç½®æ¨¡å¼ä¹‹ä¸€åˆèµ·æ¥ä½¿ç”¨ï¼Œåœ¨å‰é¢çš„ä¸¤ç§æƒ…å†µä¸­ï¼Œå•ç‹¬çš„slapdä¸èƒ½æä¾›è¶³å¤Ÿçš„å¯ç”¨æ€§å’Œå¯é æ€§ã€‚</p>
<h3 id="ç®€å•æ˜“ç”¨çš„åŒæ­¥å¤åˆ¶ç›®å½•æ–¹æ¡ˆ">ç®€å•æ˜“ç”¨çš„åŒæ­¥å¤åˆ¶ç›®å½•æ–¹æ¡ˆã€‚</h3>
<p>åˆ©ç”¨inotify+ldapå®¢æˆ·ç«¯å‘½ä»¤æ–¹æ¡ˆï¼Œæˆ–è€…é€šè¿‡å®šæ—¶ä»»åŠ¡åŠ ä¸Šldapå®¢æˆ·ç«¯å‘½ä»¤æ–¹æ¡ˆï¼ä¸¾MYSQLåŒæ­¥çš„ä¾‹å­è¯´æ˜ï¼</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567525992939.png" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h3 id="åˆ†å¸ƒå¼çš„ç›®å½•æœåŠ¡">åˆ†å¸ƒå¼çš„ç›®å½•æœåŠ¡ã€‚</h3>
<p>åœ¨è¿™ç§é…ç½®æ¨¡å¼ä¸‹ï¼Œæœ¬åœ°çš„æœåŠ¡è¢«åˆ†åˆ¶æˆä¸ºå¤šä¸ªæ›´å°çš„æœåŠ¡ï¼Œæ¯ä¸€ä¸ªéƒ½å¯èƒ½è¢«å¤åˆ¶ï¼Œå¹¶ä¸”é€šè¿‡ä¸Šçº§ï¼ˆsuperiorï¼‰æˆ–è€…ä¸‹çº§ï¼ˆsubordinateï¼‰æŒ‡é’ˆï¼ˆreferralï¼‰ç²˜åˆèµ·æ¥ã€‚åœ¨å®é™…å·¥ä½œä¸­ï¼Œä½¿ç”¨ä¸»ä»åŒæ­¥é›†ç¾¤æ¯”è¾ƒå¤šä¸€äº›ï¼Œè·¨æœºæˆ¿å°±æ˜¯é€šè¿‡openvpnåŒæ­¥ã€‚</p>
<p>ldapä¼ä¸šæ¶æ„é€»è¾‘å›¾æ¡ˆä¾‹ï¼šldap+haproxy/nginx/hearbeaté›†ç¾¤é«˜å¯ç”¨ï¼ŒéªŒè¯çš„æ—¶å€™ä¸è·¨æœºæˆ¿ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567525993061.png" alt="image" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h2 id="ldapæœåŠ¡çš„åº”ç”¨é¢†åŸŸ">LDAPæœåŠ¡çš„åº”ç”¨é¢†åŸŸ</h2>
<p>LDAPç›®å½•æœåŠ¡ï¼Œé€‚åˆé‚£äº›éœ€è¦ä»ä¸åŒçš„åœ°ç‚¹è¯»å–ä¿¡æ¯ï¼Œä½†æ˜¯ä¸éœ€è¦ç»å¸¸æ›´æ–°çš„ä¸šåŠ¡ä¿¡æ¯æœ€ä¸ºæœ‰ç”¨ã€‚</p>
<p>LDAPçš„åº”ç”¨ä¸»è¦æ¶‰åŠä»¥ä¸‹å‡ ç§ç±»å‹ã€‚I</p>
<ul>
<li>ä¿¡æ¯å®‰å…¨ç±»ï¼šæ•°å­—è¯ä¹¦ç®¡ç†ã€æˆæƒç®¡ç†ã€å•ç‚¹ç™»å½•ã€‚</li>
<li>ç§‘å­¦è®¡ç®—ç±»ï¼šDCEï¼ˆDistributed Computing Environmentï¼Œåˆ†å¸ƒå¼è®¡ç®—ç¯å¢ƒï¼‰ã€UDDIï¼ˆUniversal Descriptionï¼ŒDiscovery and Integrationï¼Œç»Ÿä¸€æè¿°ã€å‘ç°å’Œé›†æˆåè®®ï¼‰ã€‚</li>
<li>ç½‘ç»œèµ„æºç®¡ç†ç±»ï¼šMAILç³»ç»Ÿã€DNSç³»ç»Ÿã€ç½‘ç»œç”¨æˆ·ç®¡ç†ã€ç”µè¯å·ç ç°¿ã€‚</li>
<li>ç”µå­æ”¿åŠ¡èµ„æºç®¡ç†ç±»ï¼šå†…ç½‘ç»„ç»‡ä¿¡æ¯æœåŠ¡ã€ç”µå­æ”¿åŠ¡ç›®å½•ä½“ç³»ã€äººå£åŸºç¡€åº“ã€æ³•äººåŸºç¡€åº“ã€‚</li>
</ul>
<p>åœ¨å·¥ä½œä¸­ï¼Œå¸¸ç”¨ldapä½œä¸º<strong>å…¬å¸å…¥èŒåçš„æ‰€æœ‰å‘˜å·¥è´¦å·ç­‰çš„åŸºç¡€ä¿¡æ¯åº“</strong>ï¼Œä¾‹å¦‚ï¼šé‚®ä»¶è´¦å·ï¼Œç”µè„‘ç™»é™†è´¦å·ã€åŠå…¬å¹³å°è´¦å·ã€å…±äº«æœåŠ¡è´¦å·ã€SVNè´¦å·ã€VPNè´¦å·ã€æœåŠ¡å™¨çš„è´¦å·ï¼Œæ— çº¿ç½‘ç™»é™†è´¦å·ç­‰çš„å…¬å…±è´¦å·ç™»é™†ä¿¡æ¯åº“ã€‚å¯ä»¥ç†è§£ä¸ºä¼ä¸šçš„æ´»åŠ¨ç›®å½•ä¸€æ ·ï¼Œå¦å¤–ï¼ŒLDAPä¹Ÿå¯ä»¥å’Œå¾®è½¯æ´»åŠ¨ç›®å½•æ‰“é€šã€‚</p>
<p>ç”»ä¸€ä¸ªå†…ç½‘ADåŸŸï¼Œå’Œæœºæˆ¿çš„LDAPæœåŠ¡æ‰“é€šçš„æ¶æ„å›¾ï¼</p>
<h2 id="ldapæœåŠ¡çš„å¸¸è§å¼€æºäº§å“">LDAPæœåŠ¡çš„å¸¸è§å¼€æºäº§å“</h2>
<p>Openldapæ˜¯LDAPæœ€å¥½çš„å¼€æºå®ç°ï¼Œåœ¨å…¶Openldapè®¸å¯è¯ä¸‹å‘è¡Œï¼Œå¹¶ä¸”å·²ç»è¢«åŒ…å«åœ¨ä¼—å¤šæµè¡Œçš„linuxå‘è¡Œç‰ˆä¸­</p>
<p>å®˜æ–¹ç½‘ç«™ä¸º <a href="http://www.openldap.org" target="_blank"
   rel="noopener nofollow noreferrer" >openldap.org</a></p>
<p>å®˜æ–¹manæ‰‹å†Œ <a href="http://www.openldap.org/software/man.cgi" target="_blank"
   rel="noopener nofollow noreferrer" >http://www.openldap.org/software/man.cgi</a></p>
<h2 id="openldap-ui">openldap UI</h2>
<p>ldapçš„å®¢æˆ·ç«¯ç®¡ç†æ¥å£æœ‰å¾ˆå¤šï¼Œæœ‰b/sç»“æ„çš„webçš„ï¼Œä¹Ÿæœ‰c/sç»“æ„çš„ï¼Œæˆ‘ä»¬ä»¥b/sç»“æ„çš„ <code>ldap-account-manager-3.7.tar.gz</code> è½¯ä»¶ä¸ºä¾‹è¿›è¡Œè®²è§£</p>
<ul>
<li>B/S æ¶æ„çš„ <a href="https://www.ldap-account-manager.org/lamcms/" target="_blank"
   rel="noopener nofollow noreferrer" >LDAP Account Manager</a></li>
<li>C/S æ¶æ„çš„ <a href="http://www.ldapadmin.org/index.html" target="_blank"
   rel="noopener nofollow noreferrer" >LDAP Admin</a></li>
</ul>
<h3 id="ldap-account-manager">LDAP Account Manager</h3>
<p>LAMæ˜¯phpæœåŠ¡éœ€è¦å®‰è£…lampç¯å¢ƒ</p>
<pre><code class="language-bash">yum install -y\
	nginx \
	php \
	php-ldap \
	php-gd \
	php-fpm

rpm -qa \
	nginx \
	php \
	php-ldap \
	php-gd \
	php-fpm
</code></pre>
<h3 id="ä¸‹è½½è§£å‹é…ç½®ldapå®¢æˆ·ç«¯è½¯ä»¶">ä¸‹è½½è§£å‹é…ç½®ldapå®¢æˆ·ç«¯è½¯ä»¶</h3>
<p>ä¸‹è½½åœ°å€ï¼šhttps://www.ldap-account-manager.org/lamcms/releases</p>
<pre><code>cp config.cfg_sample config.cfg
cp lam.conf_sample lam.conf

sed -i 's@cn=Manager@cn=admin@g' lam.conf
sed -i 's@dc=my-domain@dc=cylon@g' lam.conf
sed -i 's@dc=com@dc=org@g' lam.conf

diff lam.conf_sample lam.conf
</code></pre>
<hr>
<blockquote>
<p><strong>æç¤º</strong>ï¼š æ­¤å¤„æ”¹çš„åœ°æ–¹å¾ˆå¤š</p>
</blockquote>
<hr>
<h3 id="é…ç½®nginx">é…ç½®nginx</h3>
<pre><code>chown nginx.nginx /var/www/html/ldap -R 
</code></pre>
<pre><code>worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  localhost;
        location / {
            root   /var/www/html;
            index  index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
		
		location ~ \.php$ {
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
		}
    }
}
</code></pre>
<h3 id="lamä½¿ç”¨">LAMä½¿ç”¨</h3>
<p><strong>æ­¥éª¤1</strong>ï¼šæ‰“å¼€æµè§ˆå™¨æˆ–è€…åœ¨å‰é¢çš„è®¿é—®åŸºç¡€ä¸Šåˆ·æ–°ï¼šhttp:/10.0.0.20/ldapï¼Œæ­£å¸¸ä¼šå‡ºç°ç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527251834.png" alt="image" style="zoom: 80%;" />
<p><strong>æ­¥éª¤2</strong>ï¼šç‚¹å‡»å³ä¸Šè§’çš„â€œLAMconfigurationâ€é“¾æ¥è¿›è¡Œé…ç½®ã€‚</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221023180610798.png" alt="image-20221023180610798" style="zoom:67%;" />
<p><strong>æ­¥éª¤3</strong>ï¼šç‚¹å‡»ä¸Šå›¾ä¸­çš„ â€œEdit general settingsâ€ é“¾æ¥è¿›è¡Œé…ç½®</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527251647.png" alt="image" style="zoom:67%;" />
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527251610.png" alt="image"  />
<p>ç”±äºç³»ç»Ÿçš„å¯†ç ä¸ºå­—æ¯ â€œlamâ€ï¼Œå¤ªç®€å•äº†ï¼Œæˆ‘ä»¬å…ˆæŠŠå¯†ç æ”¹æ‰ï¼Œå…¶ä»–çš„é…ç½®ï¼Œæˆ‘ä»¬æ ¹æ®éœ€æ±‚ä»¥åå¯ä»¥å†æ”¹ï¼Œæ³¨æ„ï¼šè¿™é‡Œæ˜¯ç³»ç»Ÿè®¾ç½®çš„æƒé™å¯†ç ï¼Œéé¡µé¢ä¸Šç™»å½•çš„å¯†ç ã€‚</p>
<p><strong>æ­¥éª¤5</strong>ï¼šä¸Šæ–‡ç‚¹OKåå°±ä¼šåˆ°é‡æ–°ç™»å½•çš„ç•Œé¢è¿›è¡Œç™»å½•ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527251845.png" alt="image" style="zoom:80%;" />
<hr>
<blockquote>
<p><strong>æç¤º</strong>ï¼š</p>
<p>è¯·ç‰¢è®°ï¼Œè¿™æ˜¯ ==ldapç®¡ç†å‘˜ç”¨æˆ·adminåŠå¯†ç ==ï¼Œéå‰é¢è®¾ç½®çš„ç³»ç»Ÿå†…éƒ¨é…ç½®å¯†ç ï¼Œldap ç®¡ç†å‘˜ç”¨æˆ·adminåŠå¯†ç æ˜¯åœ¨é…ç½®openldapä¸­ç”Ÿæˆçš„</p>
</blockquote>
<hr>
<p><strong>æ­¥éª¤6</strong>ï¼šåˆå§‹åŒ–ldapæ•°æ®åº“çš„åŸŸã€‚</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527251713.png" alt="image" style="zoom:80%;" />
<p><strong>æ­¥éª¤7</strong>ï¼šå‘½ä»¤æŸ¥çœ‹ä¸‹åˆšæ‰çš„æ“ä½œå¸®æˆ‘ä»¬å»ºç«‹äº†ä»€ä¹ˆï¼Ÿã€‚</p>
<pre><code>$ ldapsearch -LLL -w 123 -x -H ldap://10.0.0.20 -D &quot;cn=admin,dc=cylon,dc=org&quot; -b &quot;dc=cylon,dc=org&quot; &quot;(uid=chau)&quot; 
dn: uid=chau,ou=People,dc=cylon,dc=org
objectClass: posixAccount
objectClass: inetOrgPerson
objectClass: organizationalPerson
objectClass: person
homeDirectory: /home/chau
loginShell: /bin/bash
cn: cylon chau
uidNumber: 10006
gidNumber: 10000
userPassword:: e1NTSEF9c0YzZzBSbnFBU1NoWEVBWEFSS1lPdG41WjZRR1pxNCs=
sn: chau
givenName: cylon
uid: chau
</code></pre>
<p><strong>æ­¥éª¤8</strong>ï¼šç»§ç»­æ·»åŠ ldapè´¦å·å’Œç»„ã€‚</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527251790.png" alt="image" style="zoom:80%;" />
<pre><code>dn: cn=tech,ou=group,dc=cylon,dc=org
objectClass: posixGroup
description:: 5oqA5pyv6Y0o
gidNumber: 10001
cn: tech
</code></pre>
<p>æ·»åŠ ç”¨æˆ·</p>
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527251960.png" alt="image" style="zoom:80%;" />
<img src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/clipboard-1567527252022.png" alt="image" style="zoom:80%;" />
<pre><code>$ ldapsearch -LLL -w 123 -x -H ldap://10.0.0.20 -D &quot;cn=admin,dc=cylon,dc=org&quot; -b &quot;dc=cylon,dc=org&quot; &quot;(uid=cylon)&quot;
dn: uid=cylon,ou=People,dc=cylon,dc=org
objectClass: posixAccount
objectClass: inetOrgPerson
objectClass: organizationalPerson
objectClass: person
homeDirectory: /home/chau
loginShell: /bin/bash
cn: cylon chau
uidNumber: 10006
userPassword:: e1NTSEF9c0YzZzBSbnFBU1NoWEVBWEFSS1lPdG41WjZRR1pxNCs=
sn: chau
givenName: cylon
uid: cylon
gidNumber: 10001
</code></pre>
<p>é€šè¿‡webæ¥å£ç®¡ç†ldapçš„é…ç½®å®Œæˆï¼ä¹Ÿå·²ç»åˆå§‹åŒ–äº†ç”¨æˆ·ç»„åŠç”¨æˆ·</p>
<h3 id="phpldapadmin">phpldapadmin</h3>
<pre><code class="language-sh">yum install -y \
    php \
    php-fpm \
    php-ldap \
    php-gd \
    php-mbstring \
    php-pear \
    php-bcmath \
    php-xml \
    phpldapadmin \
    nginx
</code></pre>
<pre><code class="language-nginx">worker_processes  1;
events {
    worker_connections  1024;
}
http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       80;
        server_name  localhost;
        root   /usr/share/phpldapadmin/htdocs;
        location / {
            index  index.html index.htm index.php;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        location ~ \.php$ {
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            include        fastcgi_params;
        }
    }
}
</code></pre>
]]></content:encoded>
    </item>
    
    <item>
      <title>Unixå½’æ¡£æ¨¡å¼ cpio - æ·±å…¥å‰–æä¸æ„å»ºrpmåŒ…</title>
      <link>https://www.oomkill.com/2018/09/rpm-package/</link>
      <pubDate>Sat, 15 Sep 2018 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2018/09/rpm-package/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="rpmæ¦‚è¿°">RPMæ¦‚è¿°</h2>
<p>RPM (<em><strong>Red Hat Package Manager</strong></em>)ï¼Œå‡ ä¹æ‰€æœ‰çš„ Linux å‘è¡Œç‰ˆæœ¬éƒ½ä½¿ç”¨è¿™ç§å½¢å¼çš„è½¯ä»¶åŒ…ç®¡ç†å®‰è£…ã€æ›´æ–°å’Œå¸è½½è½¯ä»¶ã€‚å¯¹äºæœ€ç»ˆç”¨æˆ·æ¥è¯´ï¼Œä½¿ç”¨RPMæ‰€æä¾›çš„åŠŸèƒ½æ¥ç»´æŠ¤ç³»ç»Ÿæ˜¯æ¯”è¾ƒå®¹æ˜“å’Œè½»æ¾çš„ã€‚å®‰è£…ã€å¸è½½å’Œå‡çº§RPMè½¯ä»¶åŒ…åªéœ€ä¸€æ¡å‘½ä»¤å°±å¯ä»¥æå®šã€‚RPMç»´æŠ¤äº†ä¸€ä¸ªæ‰€æœ‰å·²å®‰è£…çš„è½¯ä»¶åŒ…å’Œæ–‡ä»¶çš„æ•°æ®åº“ï¼Œå¯ä»¥è®©ç”¨æˆ·è¿›è¡ŒæŸ¥è¯¢å’ŒéªŒè¯å·¥ä½œã€‚åœ¨è½¯ä»¶åŒ…å‡çº§è¿‡ç¨‹ä¸­ï¼ŒRPMä¼šå¯¹é…ç½®æ–‡ä»¶è¿›è¡Œç‰¹åˆ«å¤„ç†ï¼Œç»å¯¹ä¸ä¼šä¸¢å¤±ä»¥å¾€çš„å®šåˆ¶ä¿¡æ¯ã€‚å¯¹äºç¨‹åºå‘˜RPMå¯ä»¥è®©æˆ‘ä»¬è¿åŒè½¯ä»¶çš„æºä»£ç æ‰“åŒ…æˆæºä»£ç å’ŒäºŒè¿›åˆ¶è½¯ä»¶åŒ…ä¾›æœ€ç»ˆç”¨æˆ·ä½¿ç”¨ã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€åˆ¶ä½œä¸€ä¸ªRPMåŒ…åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤</p>
<ul>
<li>è®¡åˆ’ä½ æƒ³è¦å»ºç«‹ä»€ä¹ˆ</li>
<li>æ”¶é›†è½¯ä»¶åŒ…</li>
<li>æ ¹æ®éœ€è¦ä¿®è¡¥è½¯ä»¶</li>
<li>è®¡åˆ’å‡çº§æ—§æœ‰çš„åŒ…</li>
<li>åˆ›å»ºå¯é‡ç°çš„è½¯ä»¶æ„å»º</li>
<li>æ¦‚è¿°ä»»ä½•ä¾èµ–å…³ç³»</li>
<li>æ„å»ºrpm</li>
<li>æµ‹è¯•rpmï¼ˆèƒ½å¦å®‰è£…ã€å‡çº§ï¼‰</li>
</ul>
<p>RPM capability èƒ½åŠ›
è¿è¡Œæˆ–å®‰è£…éœ€è¦ä¾èµ–äºå…¶ä»–çš„RPMåŒ…æœ¬èº«æˆ–æ‰€æä¾›çš„æ–‡ä»¶ä¸ºåŸºç¡€çš„ç°è±¡è¢«ç§°ä¹‹ä¸ºä¾èµ–å…³ç³»ã€‚ä½†åœ¨åˆ¶ä½œRPMåŒ…æ—¶ï¼Œä¾èµ–å…³ç³»æœ‰ä¸¤ç±»<code>ç¼–è¯‘ä¾èµ–</code>ä¸<code>å®‰è£…ä¾èµ–</code>ã€‚</p>
<ul>
<li>è‡ªèº«åå­—æ‰€åŒ…å«çš„æ„ä¹‰</li>
<li>å®ƒæä¾›çš„æ–‡ä»¶ä¹Ÿæœ‰å¯èƒ½è¢«å…¶ä»–è½¯ä»¶æ‰€ä¾èµ–ï¼Œæ–‡ä»¶æœ¬èº«ä¹Ÿèƒ½è¯†åˆ«æˆä¸€ç§èƒ½åŠ›</li>
</ul>
<p>ç¼–è¯‘ä¾èµ–å’Œå®‰è£…ä¾èµ–</p>
<p>æ¯ä¸€ä¸ªRPMåŒ…éƒ½æä¾›ä¸€ç§èƒ½å¤Ÿå®Œæˆä»»åŠ¡çš„åŠŸèƒ½ï¼Œæ­¤ç§èƒ½åŠ›å¾ˆå¯èƒ½è¢«å…¶ä»–RPMæ‰€ä¾èµ–ï¼Œæ­¤èƒ½åŠ›å¤§å¤šæ•°æƒ…å†µä¸‹å’ŒRPMåå­—æ˜¯ç›¸åŒçš„ã€‚</p>
<p>åˆ¶ä½œRPMåŒ…çš„çº²è¦æœ‰å¦‚ä¸‹å››éƒ¨</p>
<ul>
<li>è®¾å®šRPMåŒ…åˆ¶ä½œçš„ç›®å½•ç»“æ„ï¼ˆåˆ¶ä½œè½¦é—´ï¼‰</li>
<li>å°†åŸææ–™ï¼ˆæºç åŒ…ã€é…ç½®æ–‡ä»¶ã€è¡¥ä¸åŒ…ï¼‰æ”¾ç½®è§„åˆ’å¥½çš„ç›®å½•å½“ä¸­ã€‚</li>
<li>åˆ›å»ºspecæ–‡ä»¶ï¼ŒæŒ‡æŒ¥å¦‚ä½•ä½¿ç”¨åŸææ–™å°†å…¶åˆ¶ä½œæˆrpmåŒ…ã€‚</li>
<li>ç¼–è¯‘æºä»£ç ç”ŸæˆrpmåŒ…</li>
</ul>
<p>åœ¨ä¸€ä¸ªç‰¹å®šçš„ç›®å½•ä¸­æä¾›å¦‚ä¸‹5ä¸ªå­ç›®å½• redhatä¸Šé»˜è®¤åœ¨<code>/usr/src/reahat </code></p>
<ul>
<li><code>BUILD</code> æºä»£ç è§£å‹ä»¥åæ”¾ç½®çš„ä½ç½®ï¼Œä»…éœ€æä¾›ç›®å½•ã€‚</li>
<li><code>RPMS</code>  æ”¾ç½®åˆ¶ä½œå®Œæˆåçš„RPMåŒ…</li>
<li><code>SOURCES</code> åŸææ–™æ”¾ç½®ç›®å½•ï¼ˆé…ç½®æ–‡ä»¶ã€æºç åŒ…ã€è¡¥ä¸åŒ…ï¼‰</li>
<li><code>SPECS</code> æ”¾ç½®specæ–‡ä»¶ï¼ˆçº²é¢†æ€§æ–‡ä»¶ï¼‰çš„ã€‚</li>
<li><code>SRPMS</code> SRC rpmåŒ…å­˜æ”¾ä½ç½®</li>
</ul>
<h2 id="rpmä¼˜ç¼ºç‚¹">RPMä¼˜ç¼ºç‚¹</h2>
<p>ä¼˜ç‚¹ï¼š</p>
<ol>
<li>é›†ä¸­ç®¡ç†ï¼šRPMå¯ä»¥é›†ä¸­ç®¡ç†å®‰è£…ã€å‡çº§å’Œåˆ é™¤è½¯ä»¶åŒ…ï¼Œä¿è¯ç³»ç»Ÿçš„å¹²å‡€å’Œç¨³å®šã€‚</li>
<li>ç²¾ç¡®æ§åˆ¶ï¼šRPMæä¾›è¯¦ç»†çš„è½¯ä»¶åŒ…ä¿¡æ¯ï¼Œå¯ä»¥å¯¹è½¯ä»¶åŒ…çš„å®‰è£…è·¯å¾„ã€ä¾èµ–å…³ç³»ã€ç‰ˆæœ¬ç­‰è¿›è¡Œç²¾ç¡®æ§åˆ¶ï¼Œä½¿å¾—è½¯ä»¶å®‰è£…æ›´åŠ çµæ´»ä¾¿æ·ã€‚</li>
<li>ç®€å•æ˜“ç”¨ï¼šRPMæä¾›äº†ä¸€å¥—å®Œæ•´çš„å‘½ä»¤è¡Œå·¥å…·å’Œå›¾å½¢åŒ–ç®¡ç†å·¥å…·ï¼Œå¯¹äºæ™®é€šç”¨æˆ·æ¥è¯´ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</li>
<li>æ›´æ–°æœºåˆ¶ï¼šRPMå¯ä»¥æ ¹æ®ç”¨æˆ·éœ€è¦è¿›è¡Œæ›´æ–°ï¼ŒåŒ…æ‹¬å®‰å…¨æ›´æ–°ã€åŠŸèƒ½æ›´æ–°å’Œä¿®å¤é”™è¯¯ç­‰ï¼Œå¯ä»¥æ›´å¥½åœ°ä¿è¯ç³»ç»Ÿå®‰å…¨ä¸ç¨³å®šæ€§ã€‚</li>
</ol>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>ä¾èµ–ç®¡ç†ï¼šRPMè™½ç„¶å¯ä»¥ç®¡ç†è½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»ï¼Œä½†å…¶è§£å†³ä¾èµ–çš„æ–¹å¼å®¹æ˜“å‡ºç°é—®é¢˜ï¼Œå¯èƒ½ä¼šå‡ºç°æŸäº›è½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»æ— æ³•è§£å†³çš„æƒ…å†µã€‚</li>
<li>æ›´æ–°é€Ÿåº¦ï¼šç”±äºéœ€è¦å¯¹è½¯ä»¶åŒ…è¿›è¡Œä¾èµ–æ£€æŸ¥ç­‰æ“ä½œï¼Œå‡çº§è½¯ä»¶åŒ…å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œç‰¹åˆ«æ˜¯å½“è½¯ä»¶åŒ…ä¾èµ–æ¯”è¾ƒå¤æ‚æ—¶ã€‚</li>
<li>å­˜åœ¨é—®é¢˜ï¼šæœ‰æ—¶å€™ä½¿ç”¨RPMå®‰è£…çš„è½¯ä»¶åŒ…å‡ºç°é—®é¢˜ï¼Œéœ€è¦æ‰‹åŠ¨å¸è½½å¹¶é‡æ–°å®‰è£…ï¼Œè¿™ä¼šå¯¼è‡´ä¸€äº›æ— æ³•é¢„æµ‹çš„éº»çƒ¦ã€‚</li>
<li>å…¼å®¹æ€§ï¼šRPMé‡‡ç”¨äº†ç‰¹å®šçš„è½¯ä»¶åŒ…ç®¡ç†æ ‡å‡†ï¼Œè¦æ±‚å®‰è£…çš„è½¯ä»¶åŒ…å¿…é¡»ç¬¦åˆè¿™äº›æ ‡å‡†ã€‚å› æ­¤ï¼ŒRPMå¯èƒ½ä¸å¤ªé€‚ç”¨äºå…¶ä»–Linuxç³»ç»Ÿæˆ–è‡ªå®šä¹‰çš„è½¯ä»¶åŒ…æ ¼å¼ã€‚</li>
</ol>
<h2 id="specæ–‡ä»¶">SPECæ–‡ä»¶</h2>
<p>åˆ¶ä½œRPMè½¯ä»¶åŒ…çš„å…³é”®åœ¨äºç¼–å†™SPECè½¯ä»¶åŒ…æè¿°æ–‡ä»¶ã€‚è¦æƒ³åˆ¶ä½œä¸€ä¸ªrpmè½¯ä»¶åŒ…å°±å¿…é¡»å†™ä¸€ä¸ªè½¯ä»¶åŒ…æè¿°æ–‡ä»¶ï¼ˆSPECï¼‰ã€‚è¿™ä¸ªæ–‡ä»¶ä¸­åŒ…å«äº†è½¯ä»¶åŒ…çš„è¯¸å¤šä¿¡æ¯ï¼Œå¦‚è½¯ä»¶åŒ…çš„åå­—ã€ç‰ˆæœ¬ã€ç±»åˆ«ã€è¯´æ˜æ‘˜è¦ã€åˆ›å»ºæ—¶è¦æ‰§è¡Œä»€ä¹ˆæŒ‡ä»¤ã€å®‰è£…æ—¶è¦æ‰§è¡Œä»€ä¹ˆæ“ä½œã€ä»¥åŠè½¯ä»¶åŒ…æ‰€è¦åŒ…å«çš„æ–‡ä»¶åˆ—è¡¨ç­‰ç­‰ã€‚</p>
<p><strong>SPECæ–‡ä»¶é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†</strong>ï¼š</p>
<ol>
<li>
<p>å¤´æ–‡ä»¶ï¼šåŒ…æ‹¬è½¯ä»¶åŒ…çš„åç§°ã€ç‰ˆæœ¬ã€å‘å¸ƒå·ã€æˆæƒç­‰ä¿¡æ¯ã€‚</p>
</li>
<li>
<p>%descriptionï¼šåŒ…æ‹¬è½¯ä»¶åŒ…çš„æè¿°ã€ä¾èµ–å…³ç³»ã€æ„å»ºç¯å¢ƒç­‰ä¿¡æ¯ã€‚</p>
</li>
<li>
<p>%prepï¼šæŒ‡å®šæºä»£ç çš„æ¥æºå’Œå¦‚ä½•è§£å‹ç¼©åŠå‡†å¤‡æºä»£ç ã€‚</p>
</li>
<li>
<p>%buildï¼šæŒ‡å®šå¦‚ä½•ç¼–è¯‘æºä»£ç ã€‚</p>
</li>
<li>
<p>%installï¼šæŒ‡å®šå¦‚ä½•å®‰è£…ç¼–è¯‘å¥½çš„è½¯ä»¶åŒ…ã€‚</p>
</li>
<li>
<p>%checkï¼šæŒ‡å®šæµ‹è¯•æºä»£ç çš„ç‰¹å®šéƒ¨åˆ†ï¼Œé€šå¸¸æ˜¯ç”¨æ¥è¿è¡Œå•å…ƒæµ‹è¯•ã€‚</p>
</li>
<li>
<p>%cleanï¼šæŒ‡å®šæ¸…é™¤æ„å»ºè¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•çš„æ–¹æ³•ã€‚</p>
</li>
<li>
<p>%filesï¼šæŒ‡å®šå“ªäº›æ–‡ä»¶åº”è¯¥åŒ…æ‹¬åœ¨æœ€ç»ˆçš„RPMæ–‡ä»¶ä¸­ã€‚</p>
</li>
<li>
<p>%changelogï¼šè®°å½•è½¯ä»¶åŒ…çš„å˜æ›´å†å²ã€‚</p>
</li>
</ol>
<h3 id="specæ–‡ä»¶ä¸­å¸¸ç”¨çš„å®å˜é‡">SPECæ–‡ä»¶ä¸­å¸¸ç”¨çš„å®å˜é‡</h3>
<table>
<thead>
<tr>
<th>å®å˜é‡</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>%{name}</td>
<td>è½¯ä»¶åŒ…çš„åç§°ï¼Œå¦‚ myappã€‚</td>
</tr>
<tr>
<td>%{version}</td>
<td>è½¯ä»¶åŒ…çš„ç‰ˆæœ¬å·ï¼Œå¦‚ 1.0.0ã€‚</td>
</tr>
<tr>
<td>%{release}</td>
<td>è½¯ä»¶åŒ…çš„å‘å¸ƒå·ï¼Œå¦‚ 1ã€‚</td>
</tr>
<tr>
<td>%{buildroot}</td>
<td>RPM æ„å»ºè¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ ¹ç›®å½•ç›®ï¼Œæ¨¡æ‹ŸçœŸå®çš„rootfsã€‚</td>
</tr>
<tr>
<td>%{_bindir}</td>
<td>ç³»ç»Ÿå®‰è£…äºŒè¿›åˆ¶ç¨‹åºçš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ /usr/binã€‚</td>
</tr>
<tr>
<td>%{_docdir}</td>
<td>man dbus æŸ¥çœ‹å¸®åŠ©çš„æ–‡æ¡£çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ /usr/share/doc</td>
</tr>
<tr>
<td>%{_datadir}</td>
<td>ç³»ç»Ÿå®‰è£…æ•°æ®æ–‡ä»¶çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ /usr/shareã€‚</td>
</tr>
<tr>
<td>%{_includedir}</td>
<td>ç³»ç»Ÿå®‰è£…å¤´æ–‡ä»¶çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ /usr/includeã€‚</td>
</tr>
<tr>
<td>%{_libdir}</td>
<td>ç³»ç»Ÿå®‰è£…åº“æ–‡ä»¶çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ /usr/libï¼Œ64ä½ä¸º /usr/lib64</td>
</tr>
<tr>
<td>%{_datarootdir}</td>
<td>ç³»ç»Ÿå®‰è£…æ•°æ®çš„æ ¹ç›®å½•ï¼Œé€šå¸¸æ˜¯ /usr/shareã€‚</td>
</tr>
<tr>
<td>%{_prefix}</td>
<td>è½¯ä»¶çš„å®‰è£…è·¯å¾„å‰ç¼€ï¼Œé€šå¸¸æ˜¯ /usrã€‚</td>
</tr>
<tr>
<td>%{_sysconfdir}</td>
<td>ç³»ç»Ÿé…ç½®æ–‡ä»¶çš„ç›®å½•ï¼Œé€šå¸¸æ˜¯ /etcã€‚</td>
</tr>
<tr>
<td>%{_var}</td>
<td>ç³»ç»Ÿçš„/varç›®å½•è·¯å¾„</td>
</tr>
</tbody>
</table>
<p>é€šå¸¸æƒ…å†µä¸‹åœ¨å°è£…åŒ…æ—¶ä½¿ç”¨è¿™äº›å®å˜é‡ï¼Œå°è£…å¯¹åº”ç›®å½•ä¸‹çš„å†…å®¹è€Œä¸ç”¨è€ƒè™‘æ¯ç§ Linux ç³»ç»Ÿçš„è·¯å¾„å·®å¼‚ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>%{_bindir}</code> æ¥æŒ‡å®šå®‰è£…è½¯ä»¶çš„äºŒè¿›åˆ¶ç¨‹åºæ‰€åœ¨ç›®å½•ï¼Œè€Œä¸éœ€è¦è€ƒè™‘ä¸åŒç³»ç»Ÿä¸­äºŒè¿›åˆ¶ç¨‹åºç›®å½•çš„å…·ä½“è·¯å¾„ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿è½¯ä»¶åœ¨ä¸åŒç³»ç»Ÿä¸­èƒ½å¤Ÿæ­£ç¡®å®‰è£…å’Œè¿è¡Œã€‚</p>
<h3 id="specå‚æ•°è§£é‡Š">SPECå‚æ•°è§£é‡Š</h3>
<h4 id="æ–‡ä»¶å¤´éƒ¨åˆ†">æ–‡ä»¶å¤´éƒ¨åˆ†</h4>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯¦è§£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Name</td>
<td>è½¯ä»¶çš„åç§°ï¼Œ<font color="#f8070d" size=3>æ„æˆRPMæ–‡ä»¶çš„æ–‡ä»¶åæ„æˆä¹‹ä¸€</font></td>
</tr>
<tr>
<td>Version</td>
<td>è½¯ä»¶çš„ç‰ˆæœ¬å·ï¼Œ<font color="#f8070d" size=3>æ„æˆRPMæ–‡ä»¶çš„æ–‡ä»¶åæ„æˆä¹‹ä¸€</font></td>
</tr>
<tr>
<td>Release</td>
<td>è¯¥ç‰ˆæœ¬æ‰“åŒ…çš„æ¬¡æ•°è¯´æ˜ï¼Œ<font color="#f8070d" size=3>æ„æˆRPMæ–‡ä»¶çš„æ–‡ä»¶åæ„æˆä¹‹ä¸€</font></td>
</tr>
<tr>
<td>Group</td>
<td>è½¯ä»¶å¼€å‘å›¢ä½“åç§°</td>
</tr>
<tr>
<td>Source</td>
<td>è½¯ä»¶çš„æ¥æºï¼Œå¯ä»¥æ˜¯URlæˆ–è€…æ–‡ä»¶ã€‚å¯ä»¥æœ‰å¤šä¸ªï¼Œå¦‚ï¼š<br>Source: php-5.3.29.tar.gz<br>Source1:php.ini<br>Source2:php-fpm</td>
</tr>
<tr>
<td>Patch</td>
<td>ä½œä¸ºè½¯ä»¶çš„è¡¥ä¸ã€‚</td>
</tr>
<tr>
<td>BuildRoot</td>
<td>è®¾ç½®ç¼–è¯‘æ—¶ï¼Œä¸´æ—¶å­˜æ”¾ä¸­é—´æ–‡ä»¶çš„è·¯å¾„ã€‚</td>
</tr>
<tr>
<td>License</td>
<td>è½¯ä»¶æˆæƒæ¨¡å¼ã€‚ä¸€èˆ¬ä½¿ç”¨GPLã€‚</td>
</tr>
<tr>
<td>Requires</td>
<td>è¿™ä¸ªè½¯ä»¶çš„ä¾èµ–ç¨‹åºã€‚</td>
</tr>
</tbody>
</table>
<h4 id="description">description</h4>
<p>è½¯ä»¶çš„å°–ç«¯è¯´æ˜ã€‚<font style="background:#fee904;" size=2>è¿™ä¸ªæ˜¯å¿…é¡»çš„</font>ã€‚<code>rpm -qi software name</code>æ˜¾ç¤ºçš„åŸºç¡€è¯´æ˜ã€‚</p>
<h4 id="prep">prep</h4>
<p>prepareçš„ç®€å†™ï¼Œæ­¤æ®µçš„æ„æ€ä¸ºï¼Œå°šæœªè¿›è¡Œè®¾ç½®æˆ–å®‰è£…ä¹‹å‰ï¼Œä½ è¦ç¼–è¯‘å®Œæˆçš„PRMå¸®ä½ äº‹å…ˆåšçš„äº‹æƒ…ã€‚ä¸€èˆ¬æƒ…å†µæœ‰å¦‚ä¸‹äº‹é¡¹ï¼š</p>
<ol>
<li>è¿›è¡Œè½¯ä»¶çš„è¡¥ä¸ç›¸å…³å·¥ä½œã€‚</li>
<li>å¯»æ‰¾è½¯ä»¶éœ€è¦çš„ç›®å½•æ˜¯å¦å­˜åœ¨ã€‚</li>
<li>äº‹å…ˆåˆ›å»ºè½¯ä»¶æ‰€éœ€è¦çš„ç›®å½•ï¼Œæˆ–äº‹å…ˆè¿›è¡Œçš„ä»»åŠ¡ã€‚</li>
<li>å¤‡ä»½å¯èƒ½ä¼šæ›¿æ¢çš„æ–‡ä»¶ã€‚</li>
</ol>
<pre><code class="language-bash">id nginx || useradd nginx -s /sbin/nologin -M
%setup -q
</code></pre>
<h4 id="setup">setup</h4>
<p>æ­¤é€‰é¡¹ç±»ä¼¼äºè§£å‹ä¹‹ç±»çš„å·¥ä½œï¼Œå¸¸ç”¨é€‰é¡¹å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>%setup</td>
<td>ä¸åŠ ä»»ä½•é€‰é¡¹ï¼Œä»…å°†è½¯ä»¶åŒ…æ‰“å¼€ã€‚</td>
</tr>
<tr>
<td>%setup -n newdir</td>
<td>å°†è½¯ä»¶åŒ…è§£å‹åœ¨newdirç›®å½•ã€‚</td>
</tr>
<tr>
<td>%setup -c</td>
<td>è§£å‹ç¼©ä¹‹å‰å…ˆäº§ç”Ÿç›®å½•ã€‚</td>
</tr>
<tr>
<td>%setup -b num</td>
<td>å°†ç¬¬numä¸ªsourceæ–‡ä»¶è§£å‹ç¼©ã€‚</td>
</tr>
<tr>
<td>%setup -T</td>
<td>ä¸ä½¿ç”¨defaultçš„è§£å‹ç¼©æ“ä½œã€‚</td>
</tr>
<tr>
<td>%setup -T -b 0</td>
<td>å°†ç¬¬0ä¸ªæºä»£ç æ–‡ä»¶è§£å‹ç¼©ã€‚</td>
</tr>
<tr>
<td>%setup -c -n newdir</td>
<td>æŒ‡å®šç›®å½•åç§°newdirï¼Œå¹¶åœ¨æ­¤ç›®å½•äº§ç”Ÿrpmå¥—ä»¶ã€‚</td>
</tr>
<tr>
<td>%setup -q</td>
<td>æå–æºç åˆ° BUILD ç›®å½•; -q æŒ‡ä¸æ˜¾ç¤ºè¾“å‡ºï¼ˆquietlyï¼‰</td>
</tr>
</tbody>
</table>
<h4 id="build-æ„å»ºåŒºåŸŸ">build æ„å»ºåŒºåŸŸ</h4>
<p>æ‰€è¦æ‰§è¡Œçš„å‘½ä»¤ä¸ºç”Ÿæˆè½¯ä»¶åŒ…æœåŠ¡ï¼Œå¦‚configureã€makeç­‰æ“ä½œã€‚</p>
<pre><code class="language-bash">./configure
make -j 4
</code></pre>
<h4 id="install-å®‰è£…åŒºåŸŸ">install å®‰è£…åŒºåŸŸ</h4>
<p>å…¶ä¸­çš„å‘½ä»¤åœ¨å®‰è£…è½¯ä»¶åŒ…æ—¶å°†æ‰§è¡Œï¼Œå¦‚make installå‘½ä»¤ã€‚åœ¨specæ–‡ä»¶ä¸­çš„make installåé¢åŠ ä¸Š<code>DESTDIR=%{buildroot}</code>
DESTDIRæ˜¯Makefileæ–‡ä»¶ä¸­å®šä¹‰çš„ä¸€ä¸ªå®‰è£…è·¯å¾„çš„å˜é‡ï¼Œæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼Œ<font style="background:#fee904;" size=2> ä¾‹å¦‚mysqlå’Œnginxçš„æ˜¯DESTDIR</font>ï¼Œè€Œ<font style="background:#02fa3c;" size=2>phpçš„æ˜¯INSTALL_ROOT</font>ã€‚</p>
<pre><code class="language-bash">%install
make INSTALL_ROOT=%{buildroot} install  #&lt;==php
make install DESTDIR=%{buildroot} #&lt;==nginx
</code></pre>
<h4 id="files-æ‰“åŒ…æ–‡ä»¶åŒºåŸŸ">files æ‰“åŒ…æ–‡ä»¶åŒºåŸŸ</h4>
<p>å®šä¹‰å“ªäº›æ–‡ä»¶å°†è¢«æ‰“åŒ…å…¥RPMä¸­ï¼Œåˆ†ä¸ºä¸‰ç±»&ndash;è¯´æ˜æ–‡æ¡£ï¼ˆdocï¼‰ï¼Œé…ç½®æ–‡ä»¶ï¼ˆconfigï¼‰åŠæ‰§è¡Œç¨‹åºï¼Œè¿˜å¯å®šä¹‰æ–‡ä»¶å­˜å–æƒé™ï¼Œæ‹¥æœ‰è€…åŠç»„åˆ«ã€‚</p>
<ul>
<li><code>%defattr (-,root,root)</code> æŒ‡å®šåŒ…è£…æ–‡ä»¶çš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯(mode,owner,group)ï¼Œ<code>-</code> è¡¨ç¤ºé»˜è®¤å€¼ï¼Œå¯¹æ–‡æœ¬æ–‡ä»¶æ˜¯0644ï¼Œå¯æ‰§è¡Œæ–‡ä»¶æ˜¯0755</li>
<li>%exclude åˆ—å‡ºä¸æƒ³æ‰“åŒ…åˆ°rpmä¸­çš„æ–‡ä»¶ã€‚</li>
<li>%dir æ¥æŒ‡å®šç©ºç›®å½•</li>
<li>%config  é…ç½®æ–‡ä»¶</li>
<li>%doc æ–‡æ¡£</li>
</ul>
<pre><code class="language-bash">%files
%defattr(-,root,root,-)
/usr/share/php-5.3.29/*
</code></pre>
<hr>
<p><font color=#0215cd size=3> <strong>æ³¨ï¼šè¿™é‡Œæ˜¯åœ¨è™šæ‹Ÿæ ¹ç›®å½•ä¸‹è¿›è¡Œï¼Œåƒä¸‡ä¸è¦å†™ç»å¯¹è·¯å¾„ï¼Œè€Œåº”ç”¨å®æˆ–å˜é‡è¡¨ç¤ºç›¸å¯¹è·¯å¾„ã€‚</strong></font></p>
<hr>
<h4 id="changelog-ä¿®æ”¹æ—¥å¿—åŒºåŸŸ">changelog ä¿®æ”¹æ—¥å¿—åŒºåŸŸ</h4>
<p>è¯­æ³•ï¼šç¬¬ä¸€è¡Œæ˜¯ï¼š<code>* æ˜ŸæœŸ æœˆ æ—¥ å¹´ ä¿®æ”¹äºº ç”µå­ä¿¡ç®±</code>ï¼›å…¶ä¸­ï¼šæ˜ŸæœŸã€æœˆä»½å‡ç”¨è‹±æ–‡å½¢å¼çš„å‰3ä¸ªå­—æ¯ï¼Œç”¨ä¸­æ–‡ä¼šæŠ¥é”™ã€‚
æ¥ä¸‹æ¥çš„è¡Œå†™çš„æ˜¯ä¿®æ”¹äº†ä»€ä¹ˆåœ°æ–¹ï¼Œ<font color="#f8070d" size=2><strong>ä¸€èˆ¬ä»¥&quot; - &ldquo;å·å¼€å§‹ï¼Œå¯å†™å¤šè¡Œã€‚</strong></font></p>
<pre><code class="language-bash">* Tue Dec 29 1998 lc &lt;lc.com@gmail.com&gt;
- minimum spec and patches changes for openssl
- modified for openssl sources
</code></pre>
<p>é™„å½•ï¼š</p>
<ol>
<li><strong>12ä¸ªæœˆç®€å†™</strong></li>
</ol>
<table>
<thead>
<tr>
<th>å…¨ç§°</th>
<th>ç®€å†™</th>
</tr>
</thead>
<tbody>
<tr>
<td>January</td>
<td>Jan</td>
</tr>
<tr>
<td>February</td>
<td>Feb</td>
</tr>
<tr>
<td>March</td>
<td>Ma</td>
</tr>
<tr>
<td>April</td>
<td>Apr</td>
</tr>
<tr>
<td>May</td>
<td>-</td>
</tr>
<tr>
<td>June</td>
<td>-</td>
</tr>
<tr>
<td>July</td>
<td>-</td>
</tr>
<tr>
<td>August</td>
<td>Aug</td>
</tr>
<tr>
<td>September</td>
<td>Sept</td>
</tr>
<tr>
<td>October</td>
<td>Oct</td>
</tr>
<tr>
<td>November</td>
<td>Nov</td>
</tr>
<tr>
<td>December</td>
<td>Dec</td>
</tr>
</tbody>
</table>
<ol start="2">
<li><strong>ä¸€æ˜ŸæœŸ7æ—¥ç®€å†™</strong></li>
</ol>
<table>
<thead>
<tr>
<th>å…¨ç§°</th>
<th>ç®€å†™</th>
</tr>
</thead>
<tbody>
<tr>
<td>Monday</td>
<td>Mon</td>
</tr>
<tr>
<td>Tuesday</td>
<td>Tues</td>
</tr>
<tr>
<td>Wednesday</td>
<td>Wed</td>
</tr>
<tr>
<td>Thurday</td>
<td>Thur</td>
</tr>
<tr>
<td>Friday</td>
<td>Fri</td>
</tr>
<tr>
<td>Saturday</td>
<td>Sat</td>
</tr>
<tr>
<td>Sunday</td>
<td>Sun</td>
</tr>
</tbody>
</table>
<h4 id="clean-æ¸…ç†åŒºåŸŸ">clean æ¸…ç†åŒºåŸŸ</h4>
<p>ç”¨æ¥æ¸…ç† build åçš„ä¸´æ—¶æ–‡ä»¶,ä¸»è¦æ˜¯æ€•è¿™äº›æ—§çš„æ–‡ä»¶å½±å“ä»¥åç¼–è¯‘ã€‚ä¸»è¦æ˜¯è¦åˆ é™¤ $RPM_BUILD_ROOT å’Œè¿è¡Œ make clean ã€‚</p>
<h4 id="d-bus0-scriptlets">D-Bus0 Scriptlets</h4>
<p>è¿™äº›é€‰é¡¹å¯ä»¥è®©ä½ åŠ¨æ€çš„ä½¿ç”¨ shell è„šæœ¬æ¥æ§åˆ¶å®‰è£…å’Œåˆ é™¤ï¼Œ</p>
<ul>
<li>%pre    rpmå®‰è£…å‰æ‰§è¡Œçš„è„šæœ¬</li>
<li>%post   rpmå®‰è£…åæ‰§è¡Œçš„è„šæœ¬</li>
<li>%preun  rpmå¸è½½å‰æ‰§è¡Œçš„è„šæœ¬</li>
<li>%postun rpmå¸è½½åæ‰§è¡Œçš„è„šæœ¬</li>
</ul>
<hr>
<p>%preun åœ¨å‡çº§çš„æ—¶å€™ä¼šæ‰§è¡Œï¼Œ %postunåœ¨å‡çº§rpmåŒ…çš„æ—¶å€™ä¸ä¼šæ‰§è¡Œ</p>
<hr>
<pre><code class="language-bash">rpm -q --scripts packagename # æŸ¥çœ‹è„šæœ¬çš„ä¿¡æ¯  SERVER_BIN_DIR	 CLIENT_BIN_DIR
</code></pre>
<h3 id="ç¤ºä¾‹nginxspec">ç¤ºä¾‹nginx.spec</h3>
<pre><code class="language-bash">Name: nginx
Version: 1.13.9
Release: 1%{?dist}
Summary: nginx
Group: nginx
License: GPL
URL: http://dangjian.chinamoblie.com
Packager: nginx
Vendor: nginx
Source0: nginx-1.13.9.tar.gz
Source1: nginx.service
Requires: openssl-devel,pcre-devel
BuildRoot: %{_tmppath}/%{name}-%{version}-buildroot
%description 
nginx

%prep
id nginx || useradd nginx -s /sbin/nologin -M
%setup -q
chmod +x ./configure

%build
./configure --prefix=/usr/share/nginx \
--sbin-path=/usr/sbin/nginx \
--with-stream \
--conf-path=/etc/nginx/nginx.conf \
--error-log-path=/data/nginx/log/error.log \
--pid-path=/data/nginx/run/nginx.pid \
--lock-path=/data/nginx/lock/nginx.lock \
--user=nginx --group=nginx \
--with-http_ssl_module \
--with-http_stub_status_module \
--with-http_flv_module \
--with-http_gzip_static_module \
--http-log-path=/data/nginx/log/access.log --http-client-body-temp-path=/data/nginx/tmp/client/ \
--http-proxy-temp-path=/data/nginx/tmp/proxy/ \
--http-fastcgi-temp-path=/data/nginx/tmp/fcgi/ \
--http-scgi-temp-path=/data/nginx/tmp/scgi \
--http-uwsgi-temp-path=/data/nginx/tmp/uwsgi

make

%install
make install DESTDIR=$RPM_BUILD_ROOT
%{__install} -p -D %{SOURCE1} %{buildroot}/usr/lib/systemd/system/nginx.service
%{__mkdir_p} /data/nginx/tmp/{client,uwsgi,scgi,fcgi,proxy}

%files
%defattr(-,root,root,-)
%attr(0644,root,root) /usr/share/nginx/*
%attr(0755,root,root) /usr/sbin/nginx
%attr(0644,root,root) /etc/nginx/*
%attr(0744,nginx,nginx) /data/nginx/*
%attr(0744,root,root) /usr/lib/systemd/system/nginx.service

%clean
rm -rf $RPM_BUILD_DIR/%{name}-%{version}

%pre
id nginx || useradd nginx -s /sbin/nologin -M

%preun
systemctl stop nginx

%postun
rm -fr /data/nginx/
userdel nginx

%changelog
* Sun Aug 24 2015 LC 1.15-1
- package libiconv-1.15
</code></pre>
<h2 id="rpmbuild">rpmbuild</h2>
<p>rpmbuild æ˜¯ç”¨äºæ„å»º RPM åŒ…çš„å·¥å…·ã€‚RPM æ˜¯ä¸€ç§è½¯ä»¶åŒ…ç®¡ç†æ ¼å¼ï¼Œå®ƒå¯ä»¥ç®€åŒ–è½¯ä»¶çš„åˆ†å‘ï¼Œä½¿å…¶åœ¨ä¸åŒçš„ Linux ç³»ç»Ÿä¸Šæ˜“äºå®‰è£…å’Œä½¿ç”¨ã€‚rpmbuild å·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºè¿™æ ·çš„ RPM åŒ…ã€‚</p>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-ba</td>
<td>æ—¢ç”Ÿæˆsrc.rpmåˆç”ŸæˆäºŒè¿›åˆ¶rpm</td>
</tr>
<tr>
<td>-bs</td>
<td>åªç”Ÿæˆsrcçš„rpm</td>
</tr>
<tr>
<td>-bb</td>
<td>åªç”ŸäºŒè¿›åˆ¶çš„rpm</td>
</tr>
<tr>
<td>-bp</td>
<td>æ‰§è¡Œåˆ°pre</td>
</tr>
<tr>
<td>-bc</td>
<td>æ‰§è¡Œåˆ° buildæ®µ</td>
</tr>
<tr>
<td>-bi</td>
<td>æ‰§è¡Œinstallæ®µ</td>
</tr>
<tr>
<td>-bl</td>
<td>æ£€æµ‹æœ‰æ–‡ä»¶æ²¡åŒ…å«</td>
</tr>
</tbody>
</table>
<h3 id="rpmbuild-å®‰è£…">rpmbuild å®‰è£…</h3>
<p>rpmåŒ…å¹¶ä¸ä»…ä»…é™åˆ¶äº Fedora/Redhat ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨å…¶ä»–çš„å‘è¡Œç‰ˆä¸­</p>
<p>å¯¹äº CentOSï¼š</p>
<pre><code class="language-bash">sudo yum install -y rpm-build redhat-rpm-config rpmdevtools
</code></pre>
<p>å¯¹äº Fedoraï¼š</p>
<pre><code class="language-bash">sudo dnf install -y rpm-build redhat-rpm-config rpmdevtools
</code></pre>
<p>å¯¹äº Ubuntuï¼š</p>
<pre><code class="language-bash">sudo apt install -y rpm
</code></pre>
<p>æŸ¥çœ‹é»˜è®¤å®</p>
<pre><code class="language-bash"> rpmbuild --showrc
</code></pre>
<h3 id="åˆ›å»º-rpm-æ„å»ºç›®å½•">åˆ›å»º RPM æ„å»ºç›®å½•</h3>
<p>è¦å¼€å§‹æ„å»º RPM åŒ…ï¼Œæ‚¨éœ€è¦å…ˆåˆ›å»º RPM æ„å»ºç›®å½•å’Œç›¸å…³æ–‡ä»¶ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»º RPM æ„å»ºç›®å½•å’Œå¿…è¦çš„å­ç›®å½•ï¼š</p>
<pre><code class="language-bash">cd ~
mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
</code></pre>
<p>ä¸Šè¿°å‘½ä»¤åˆ›å»ºäº† 5 ä¸ªå­ç›®å½•ï¼š</p>
<ul>
<li>BUILD: æ„å»º RPM åŒ…æ‰€éœ€çš„æºç å’ŒäºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ã€‚</li>
<li>RPMS: äºŒè¿›åˆ¶ RPM åŒ…ä¿å­˜çš„ç›®å½•ã€‚</li>
<li>SOURCES: å­˜å‚¨è½¯ä»¶åŒ…çš„æºä»£ç ï¼Œrpmbuild æ ¹æ®è¯¥ä»£ç åˆ›å»º RPM åŒ…ã€‚</li>
<li>SPECS: INCLUDE metadata and build instructions files for creating RPM files</li>
<li>SRPMS: ç”¨äºå­˜å‚¨æº RPM åŒ…çš„ç›®å½•ã€‚</li>
</ul>
<h2 id="rpmbuildç¤ºä¾‹å¦‚ä½•ä½¿ç”¨rpmbuildåˆ¶ä½œphp-rpmåŒ…">rpmbuildç¤ºä¾‹ï¼šå¦‚ä½•ä½¿ç”¨rpmbuildåˆ¶ä½œphp rpmåŒ…</h2>
<pre><code class="language-sh">mkdir -pv ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
</code></pre>
<p>phpæœ‰ä¸€ä¸ªä¾èµ–åº“ï¼Œåœ¨yumæºäºepelæºä¸­éƒ½æ²¡æœ‰éœ€è¦è‡ªå·±æ‰“åŒ…<code>libiconv</code></p>
<blockquote>
<p><strong>ç¼–å†™  libiconv çš„specæ–‡ä»¶</strong></p>
</blockquote>
<pre><code class="language-bash">%define __os_install_post %{nil}
%define debug_package %{nil}
Name: libiconv
Version: 1.15
Release: 1%{?dist}
Summary: liconv
Group: liconv
License: GPL
URL: http://www.test.net
Packager: test
Vendor: test
Source0: libiconv-1.15.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-buildroot
%description 
iconv

%prep
%setup -q

%build
./configure --prefix=/usr/share/libiconv-1.15 \

make

%install
make install DESTDIR=%{buildroot}


%files
%defattr(-,root,root,-)
%attr(0655,root,root) /usr/share/libiconv-1.15/*
%attr(0755,root,root) /usr/share/libiconv-1.15/bin/*


%clean
rm -rf $RPM_BUILD_DIR/%{name}-%{version}

%post
ln -sv /usr/share/libiconv-1.15/ /usr/share/libiconv

%changelog
* Sun Aug 24 2015 LC 1.15-1
- package libiconv-1.15

</code></pre>
<h3 id="æ‰“åŒ…libiconvé‡åˆ°çš„é”™è¯¯">æ‰“åŒ…libiconvé‡åˆ°çš„é”™è¯¯</h3>
<pre><code class="language-bash">Binary file /root/rpmbuild/BUILDROOT/libiconv-1.15.el7.centos.x86_64/usr/share/libiconv-1.15/bin/iconv matches
Found '/root/rpmbuild/BUILDROOT/libiconv-1.15-1.el7.centos.x86_64' in installed files; aborting
error: Bad exit status from /var/tmp/rpm-tmp.6AgqPk (%install)


RPM build errors:
    Bad exit status from /var/tmp/rpm-tmp.6AgqPk (%install)
</code></pre>
<p><strong>é—®é¢˜åŸå› </strong>ï¼š</p>
<p>åœ¨rpmæ„å»ºè¿‡ç¨‹ä¸­ï¼Œåœ¨ï¼…installé˜¶æ®µç»“æŸæ—¶ï¼Œè¿è¡Œ <code>/usr/lib/rpm/check-buildroot</code>è„šæœ¬ä»¥æ£€æŸ¥æ„å»ºæ ¹ç›®å½•ä¸­çš„æ–‡ä»¶ã€‚æ­¤è„šæœ¬æ‰«ææ„å»ºæ ¹ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼Œä»¥è·å–<code>${RPM_BUILD_ROOT}</code>è·¯å¾„çš„ä»»ä½•å¼•ç”¨ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´libiconvå·²ç»ç¼–è¯‘å®Œæˆã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„ã€‚æ‰€ä»¥ä¸éœ€è¦ä»–æ£€æŸ¥æ„å»ºæ ¹ç›®å½•ã€‚</p>
<p><strong>è§£å†³æ–¹æ³•</strong>ï¼šé€šè¿‡æŠ¥é”™ä¿¡æ¯å¯ä»¥å¾—åˆ°å¦‚ä¸‹æç¤º</p>
<pre><code class="language-bash">RPM build errors:
    Bad exit status from /var/tmp/rpm-tmp.6AgqPk (%install)
</code></pre>
<p>æ ¹æ®ä¿å­˜ä¿¡æ¯æŸ¥çœ‹æ–‡ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ã€‚<code>/var/tmp/rpm-tmp.6AgqPk</code>ï¼Œå¹¶å‘ç°è„šæœ¬åœ¨æ‰§è¡Œåˆ°<code>/usr/lib/rpm/check-buildroot</code>æ—¶åœæ­¢äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œè¿™ä¸ªè„šæœ¬æ£€æŸ¥æ„å»ºæ ¹ç›®å½•æ—¶<code>$?</code>ä¸ä¸º0</p>
<pre><code class="language-bash">cd 'libiconv-1.15'

make install DESTDIR=/root/rpmbuild/BUILDROOT/libiconv-1.15-1.el7.centos.x86_64

    /usr/lib/rpm/check-buildroot
</code></pre>
<p>æŸ¥çœ‹<code>/usr/lib/rpm/check-buildroot</code>è„šæœ¬ï¼Œå‘ç°åªæœ‰æ­¤æ®µæ£€æŸ¥æ‰<code>$?</code>è¿”å›çš„æ˜¯1ã€‚</p>
<pre><code class="language-bash">test -s &quot;$tmp&quot; &amp;&amp; {
    cat &quot;$tmp&quot;
    echo &quot;Found '$RPM_BUILD_ROOT' in installed files; aborting&quot;
    exit 1
} || :  
</code></pre>
<p>ç”±äºå‹æ ¹ä¸çŸ¥é“ <code>$tmp</code> åœ¨å“ªé‡Œä¼ å…¥çš„ã€‚åˆå‹æ ¹å¯ä»¥ä¸æ£€æŸ¥æ„å»ºæ ¹ç›®å½•çš„ã€‚ç›´æ¥åœ¨ <code>/usr/lib/rpm/check-buildroot</code> è„šæœ¬æœ€å‰é¢åŠ ä¸Š <code>exit 0</code> è®©æ„å»ºRPMåŒ…æ—¶è·³è¿‡æ­¤æ­¥éª¤ã€‚ä¹‹åæˆåŠŸå®Œæˆrpmæ„å»ºã€‚</p>
<p><strong>å‚è€ƒæ–‡æ¡£</strong>ï¼š
<a href="http://pktechpage.blogspot.com/2015/09/found-rpmbuildroot-in-installed-files.html" target="_blank"
   rel="noopener nofollow noreferrer" >pk&rsquo;s Tech Page: Found &lsquo;${RPM_BUILD_ROOT}&rsquo; in installed files; aborting</a></p>
<p><a href="https://stackoverflow.com/questions/35511053/what-does-usr-lib-rpm-check-buildroot-do" target="_blank"
   rel="noopener nofollow noreferrer" >c++ - What does /usr/lib/rpm/check-buildroot do? - Stack Overflow</a></p>
<h3 id="ç¼–å†™specæ–‡ä»¶">ç¼–å†™specæ–‡ä»¶</h3>
<pre><code class="language-bash">Name: php
Version: 7.1.17
Release: 1%{?dist}
Summary: php
Group: php
License: GPL
URL: http://php.org
Packager: php
Vendor: php
Source0: php-7.1.17.tar.bz2
Source1: php.ini
BuildRoot: %{_tmppath}/%{name}-%{version}-buildroot
Requires: libiconv,zlib-devel,libxml2-devel,libjpeg-devel,libjpeg-turbo-devel,freetype-devel,libpng-devel,gd-devel,curl-devel,libxslt-devel,bzip2-devel,gmp-devel,readline-devel,mcrypt,mhash,libmcrypt-devel
%description 
php

%prep
id nginx || useradd nginx -s /sbin/nologin -M
%setup -q

%build
./configure \
--prefix=/usr/share/php-7.1.17 \
--with-config-file-path=/etc/php/ \
--exec-prefix=/usr \
--bindir=/usr/bin \
--sbindir=/usr/sbin \
--mandir=/usr/share/man \
--sysconfdir=/etc/php/ \
--with-mysqli=mysqlnd \
--with-iconv-dir=/usr/share/libiconv \
--with-jpeg-dir \
--with-png-dir \
--with-zlib-dir \
--with-libxml-dir \
--enable-xml \
--disable-rpath \
--enable-safe-mode \
--enable-bcmath \
--enable-shmop \
--enable-sysvsem \
--enable-inline-optimization \
--with-curl \
--enable-mbregex \
--enable-fpm \
--enable-mbstring \
--with-mcrypt \
--with-gd \
--enable-gd-native-ttf \
--with-openssl \
--with-mhash \
--enable-pcntl \
--enable-sockets \
--with-xmlrpc \
--enable-zip \
--enable-soap \
--enable-short-tags \
--enable-zend-multibyte \
--enable-static \
--with-xsl \
--with-fpm-user=nginx \
--with-fpm-group=nginx 

make -j 4

%install
rm -rf %{buildroot}
make INSTALL_ROOT=%{buildroot} install
%{__install} -p -D %{SOURCE1} %{buildroot}/etc/php/php.ini

%files
%defattr(-,root,root,-)
/usr/share/php-7.1.17/*
%attr(0744,root,root) /usr/bin/*
%attr(0744,root,root) /usr/sbin/*
/usr/share/man/*
/etc/php/*


%pre
id nginx || useradd nginx -s /sbin/nologin -M

%post
cp /etc/php/php-fpm.conf.default /etc/php/php-fpm.conf
cp /etc/php/php-fpm.d/www.conf.default /etc/php/php-fpm.d/www.conf

%postun
userdel nginx

%changelog
* Sun Aug 10 2018 lc zhoushilong
- package php-7.1.71
</code></pre>
<h3 id="æ„å»ºphp-rpmåŒ…é‡åˆ°çš„é—®é¢˜">æ„å»ºPHP RPMåŒ…é‡åˆ°çš„é—®é¢˜</h3>
<pre><code class="language-bash">RPM build errors:
    bogus date in %changelog: Sun Aug 10 2018 lc zhoushilong
    Explicit %attr() mode not applicaple to symlink: /root/rpmbuild/BUILDROOT/php-7.1.17-1.el7.centos.x86_64/usr/bin/phar
    Installed (but unpackaged) file(s) found:
   /.channels/.alias/pear.txt
   /.channels/.alias/pecl.txt
   /.channels/.alias/phpdocs.txt
   /.channels/__uri.reg
   /.channels/doc.php.net.reg
   /.channels/pear.php.net.reg
   /.channels/pecl.php.net.reg
   /.depdb
   /.depdblock
   /.filemap
   /.lock
</code></pre>
<p><strong>è§£å†³æ–¹æ³•å¦‚ä¸‹</strong>ï¼š</p>
<blockquote>
<p><strong>æ–¹æ³•1</strong>ï¼šç”Ÿæˆçš„rpmåŒ…é‡Œæœ‰å‰é¢åœ¨%filesé‡Œæ·»åŠ çš„è¿™ä¸ªæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p>
</blockquote>
<pre><code class="language-bash">/usr/local/php/.channels
</code></pre>
<blockquote>
<p><strong>æ–¹æ³•2</strong>ï¼šä¸‹é¢æ˜¯ç›´æ¥åˆ é™¤çš„è§£å†³åŠæ³•ï¼Œå®è·µOKï¼ˆè§†å…·ä½“æƒ…å†µæ˜¯åˆ é™¤è¿˜æ˜¯æ·»åŠ é€‰ä¸€ä¸ªå³å¯ï¼‰</p>
</blockquote>
<pre><code class="language-bash">rm -rf %{buildroot}/{.channels,.depdb,.depdblock,.filemap,.lock} 
</code></pre>
<blockquote>
<p><strong>æ–¹æ³•ä¸‰</strong>ï¼š <code>/usr/lib/rpm/macros</code> ä¿®æ”¹å®</p>
</blockquote>
<pre><code class="language-bash"># æ„å»ºæ ¹ç›®å½•ä¸­çš„æœªæ‰“åŒ…æ–‡ä»¶æ˜¯å¦åº”ç»ˆæ­¢æ„å»ºï¼Ÿ
%_unpackaged_files_terminate_build 1 # æŠŠ1æ”¹ä¸º0åªè­¦å‘Š

%__check_files   %{_rpmconfigdir}/check-files %{buildroot} # è¿™ä¸€è¡Œï¼ŒæŠŠè¿™ä¸€è¡Œæ³¨é‡Šæ‰ï¼Œç„¶åé‡æ–°ç¼–è¯‘
</code></pre>
<p><strong><code>%__check_files</code>è¯´æ˜</strong>ï¼š</p>
<blockquote>
<p>Build configuration macros. Script gets packaged file list on input and buildroot as first parameter. Returns list of unpackaged files, i.e. files in $RPM_BUILD_ROOT not packaged. Note: Disable (by commenting out) for legacy compatibility.</p>
</blockquote>
<p>æ„å»ºé…ç½®å®ã€‚ è„šæœ¬åœ¨è¾“å…¥å’Œbuildrootä¸Šè·å–æ‰“åŒ…æ–‡ä»¶åˆ—è¡¨ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚ è¿”å›æœªæ‰“åŒ…æ–‡ä»¶çš„åˆ—è¡¨ï¼Œå³ $ RPM_BUILD_ROOT ä¸­æœªæ‰“åŒ…çš„æ–‡ä»¶ã€‚ æ³¨æ„ï¼šç¦ç”¨ï¼ˆé€šè¿‡æ³¨é‡Šæ‰ï¼‰æ—§ç‰ˆå…¼å®¹æ€§ã€‚</p>
<h3 id="æ‰“åŒ…æŠ¥é”™">æ‰“åŒ…æŠ¥é”™</h3>
<pre><code class="language-sh">+ '%{__debug_install_post}'
/var/tmp/rpm-tmp.o0N7t4: line 45: fg: no job control
error: Bad exit status from /var/tmp/rpm-tmp.o0N7t4 (%install)


RPM build errors:
    bogus date in %changelog: Sun Aug 24 2018 YB 1.14.2
    Bad exit status from /var/tmp/rpm-tmp.o0N7t4 (%install)
</code></pre>
<p>è§£å†³ï¼šä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¦ç”¨check-buildroot</p>
<pre><code>%define __arch_install_post %{nil}
%define __os_install_post %{nil}
</code></pre>
<p>å…³é—­è°ƒè¯•ä¿¡æ¯ï¼š</p>
<pre><code>%global debug_package %{nil}
</code></pre>
<h2 id="å‚è€ƒç½‘å€">å‚è€ƒç½‘å€</h2>
<blockquote>
<p><a href="https://phpor.net/blog/post/5670" target="_blank"
   rel="noopener nofollow noreferrer" >rpmbuild ä¹‹ /usr/lib/rpm/check-buildroot</a></p>
<p><a href="https://stackoverflow.com/questions/47838041/rpmbuild-how-to-disable-check-buildroot" target="_blank"
   rel="noopener nofollow noreferrer" >rpmbuild - how to disable check-buildroot?</a></p>
<p><a href="http://jackxiang.com/post/8633/" target="_blank"
   rel="noopener nofollow noreferrer" >[å®è·µOK]rpmbuildæŠ¥error: Installed (but unpackaged) file(s) foundçš„è§£å†³åŠæ³•</a></p>
<p><a href="http://www.nongzusa.com/blog/2014/10/14/rpmbuild-da-bao-rpmshi-zhan/" target="_blank"
   rel="noopener nofollow noreferrer" >rpmbuild æ‰“åŒ…rpmå®æˆ˜</a></p>
<p><a href="http://www.jinbuguo.com/redhat/rpmbuild.html" target="_blank"
   rel="noopener nofollow noreferrer" >rpmbuild ä¸­æ–‡æ‰‹å†Œ</a></p>
<p><a href="https://docs.fedoraproject.org/en-US/quick-docs/creating-rpm-packages/index.html" target="_blank"
   rel="noopener nofollow noreferrer" >Creating RPM packages :: Fedora Docs Site</a></p>
<p><a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.25files_.E5.9F.BA.E7.A1.80" target="_blank"
   rel="noopener nofollow noreferrer" >How to create an RPM package/zh-cn - Fedora Project Wiki</a></p>
<p><a href="https://fedoraproject.org/wiki/Packaging:Guidelines?rd=Packaging/Guidelines" target="_blank"
   rel="noopener nofollow noreferrer" >Fedora Packaging Guidelines - Fedora Project Wiki</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>SSHå®¢æˆ·ç«¯åº”ç”¨åœºæ™¯</title>
      <link>https://www.oomkill.com/2018/05/ssh-client-application/</link>
      <pubDate>Fri, 18 May 2018 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2018/05/ssh-client-application/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="sshå‘½ä»¤è¯¦è§£">SSHå‘½ä»¤è¯¦è§£</h2>
<table>
<thead>
<tr>
<th style="text-align:center">å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-1Â </td>
<td>å¼ºåˆ¶ä½¿ç”¨sshåè®®ç‰ˆæœ¬1ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-2</td>
<td>å¼ºåˆ¶ä½¿ç”¨sshåè®®ç‰ˆæœ¬2ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-4</td>
<td>å¼ºåˆ¶ä½¿ç”¨IPv4åœ°å€ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-6</td>
<td>å¼ºåˆ¶ä½¿ç”¨IPv6åœ°å€ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-A</td>
<td>å¼€å¯è®¤è¯ä»£ç†è¿æ¥è½¬å‘åŠŸèƒ½ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-a</td>
<td>å…³é—­è®¤è¯ä»£ç†è¿æ¥è½¬å‘åŠŸèƒ½ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-b</td>
<td>ä½¿ç”¨æœ¬æœºæŒ‡å®šåœ°å€ä½œä¸ºå¯¹åº”è¿æ¥çš„æºipåœ°å€ï¼›</td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#f8070d" size=3>-C</font></strong></td>
<td>è¯·æ±‚å‹ç¼©æ‰€æœ‰æ•°æ®ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-F</td>
<td>æŒ‡å®šsshæŒ‡ä»¤çš„é…ç½®æ–‡ä»¶ï¼›</td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#f8070d" size=3>-f</font></strong></td>
<td>åå°æ‰§è¡ŒsshæŒ‡ä»¤ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-g</td>
<td>å…è®¸è¿œç¨‹ä¸»æœºè¿æ¥ä¸»æœºçš„è½¬å‘ç«¯å£ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-i</td>
<td>æŒ‡å®šèº«ä»½æ–‡ä»¶ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-l</td>
<td>æŒ‡å®šè¿æ¥è¿œç¨‹æœåŠ¡å™¨ç™»å½•ç”¨æˆ·åï¼›</td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#f8070d" size=3>-N</font></strong></td>
<td>ä¸æ‰§è¡Œè¿œç¨‹æŒ‡ä»¤ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-o</td>
<td>æŒ‡å®šé…ç½®é€‰é¡¹ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-p</td>
<td>æŒ‡å®šè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„ç«¯å£ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-q</td>
<td>é™é»˜æ¨¡å¼ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-X</td>
<td>å¼€å¯X11è½¬å‘åŠŸèƒ½ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-x</td>
<td>å…³é—­X11è½¬å‘åŠŸèƒ½ï¼›</td>
</tr>
<tr>
<td style="text-align:center">-y</td>
<td>å¼€å¯ä¿¡ä»»X11è½¬å‘åŠŸèƒ½ã€‚</td>
</tr>
<tr>
<td style="text-align:center"><strong><font color="#f8070d" size=3>-D</font></strong></td>
<td>æŒ‡å®šæœ¬åœ° â€œåŠ¨æ€â€ åº”ç”¨ç¨‹åºçº§ç«¯å£è½¬å‘ã€‚è¿™é€šè¿‡åˆ†é…å¥—æ¥å­—æ¥ä¾¦å¬æœ¬åœ°ç«¯å£ï¼Œå¯é€‰åœ°ç»‘å®šåˆ°æŒ‡å®šçš„bind_addressã€‚åªè¦ä¸æ­¤ç«¯å£å»ºç«‹è¿æ¥ï¼Œå°±ä¼šé€šè¿‡å®‰å…¨é€šé“è½¬å‘è¿æ¥ï¼Œç„¶åä½¿ç”¨åº”ç”¨ç¨‹åºåè®®ç¡®å®šä»è¿œç¨‹è®¡ç®—æœºè¿æ¥çš„ä½ç½®ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="sshç«¯å£è½¬å‘å®æˆ˜">SSHç«¯å£è½¬å‘å®æˆ˜</h2>
<h3 id="æ¦‚è¿°">æ¦‚è¿°</h3>
<p>åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œç½‘ç»œé˜²ç«å¢™ä¼šé˜»ç¢ä½ è¿›è¡ŒæŸäº›å¿…è¦çš„ç½‘ç»œä¼ è¾“ã€‚å…¬å¸çš„å®‰å…¨ç­–ç•¥å¯èƒ½ä¸å…è®¸ä½ æŠŠSSHå¯†é’¥å­˜å‚¨åœ¨æŸäº›ä¸»æœºä¸Šã€‚æˆ–è€…ï¼Œä½ ä¹Ÿå¯èƒ½éœ€è¦åœ¨åŸæœ¬å®‰å…¨çš„ç¯å¢ƒä¸­è¿è¡Œä¸€äº›ä¸å®‰å…¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºã€‚</p>
<p>SSHæä¾›äº†ä¸€ä¸ªé‡è¦åŠŸèƒ½ï¼Œç§°ä¸ºè½¬å‘<font color="#f8070d" size=3><code>forwarding</code></font>æˆ–è€…ç§°ä¸ºéš§é“ä¼ è¾“<font color="#f8070d" size=3><code>tunneling</code></font>ï¼Œå®ƒèƒ½å¤Ÿå°†å…¶ä»– TCP ç«¯å£çš„ç½‘ç»œæ•°æ®é€šè¿‡ SSH é“¾æ¥æ¥è½¬å‘ï¼Œå¹¶ä¸”è‡ªåŠ¨æä¾›äº†ç›¸åº”çš„åŠ å¯†åŠè§£å¯†æœåŠ¡ã€‚è¿™ä¸€è¿‡ç¨‹æœ‰æ—¶ä¹Ÿè¢«å«åš<font color="#f8070d" size=3><code>tunneling</code></font>ï¼Œè¿™æ˜¯å› ä¸º SSH ä¸ºå…¶ä»– TCP é“¾æ¥æä¾›äº†ä¸€ä¸ªå®‰å…¨çš„é€šé“æ¥è¿›è¡Œä¼ è¾“è€Œå¾—åã€‚</p>
<p><strong>SSHç«¯å£è½¬å‘ä¸»è¦ç”¨æ¥è§£å†³å¦‚ä¸‹ä¸¤æ–¹é¢é—®é¢˜ï¼š</strong></p>
<ol>
<li>çªç ´é˜²ç«å¢™çš„é™åˆ¶å®Œæˆæ— æ³•å»ºç«‹çš„ TCP è¿æ¥ã€‚</li>
<li>åŠ å¯† Client ç«¯è‡³ Server ç«¯ä¹‹é—´çš„é€šè®¯æ•°æ®ã€‚</li>
</ol>
<h3 id="å¼€å¯sshçš„ç«¯å£è½¬å‘åŠŸèƒ½">å¼€å¯sshçš„ç«¯å£è½¬å‘åŠŸèƒ½</h3>
<p>sshç«¯å£è½¬å‘åŠŸèƒ½é»˜è®¤æ˜¯æ‰“å¼€çš„ã€‚å¦‚éœ€ä¿®æ”¹çš„è¯ï¼Œä¿®æ”¹åéœ€è¦é‡å¯sshdæœåŠ¡æ‰ä¼šç”Ÿæ•ˆã€‚</p>
<pre><code class="language-bash">AllowTcpForwarding yes
</code></pre>
<h3 id="å¸¸ç”¨sshè½¬å‘ç±»å‹">å¸¸ç”¨SSHè½¬å‘ç±»å‹</h3>
<p>åœ¨sshè¿æ¥çš„åŸºç¡€ä¸Šï¼ŒæŒ‡å®š<code>ssh client</code>æˆ–<code>ssh server</code>çš„æŸä¸ªç«¯å£ä½œä¸ºæºåœ°å€ï¼Œæ‰€æœ‰å‘è‡³è¯¥ç«¯å£çš„æ•°æ®åŒ…éƒ½ä¼šé€è¿‡sshè¿æ¥è¢«è½¬å‘å‡ºå»ï¼›è‡³äºè½¬å‘çš„ç›®æ ‡åœ°å€ï¼Œç›®æ ‡åœ°å€æ—¢å¯ä»¥æŒ‡å®šï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œå¦‚æœæŒ‡å®šäº†ç›®æ ‡åœ°å€ï¼Œç§°ä¸ºå®šå‘è½¬å‘ï¼Œå¦‚æœä¸æŒ‡å®šç›®æ ‡åœ°å€åˆ™ç§°ä¸ºåŠ¨æ€è½¬å‘ï¼š</p>
<p><strong>å®šå‘è½¬å‘</strong></p>
<p>å®šå‘è½¬å‘æŠŠæ•°æ®åŒ…è½¬å‘åˆ°æŒ‡å®šçš„ç›®æ ‡åœ°å€ã€‚ç›®æ ‡åœ°å€ä¸é™å®šæ˜¯ssh client æˆ– ssh serverï¼Œæ—¢å¯ä»¥æ˜¯äºŒè€…ä¹‹ä¸€ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒè€…ä»¥å¤–çš„å…¶ä»–æœºå™¨ã€‚</p>
<p><strong>åŠ¨æ€è½¬å‘</strong></p>
<p>åŠ¨æ€è½¬å‘ä¸æŒ‡å®šç›®æ ‡åœ°å€ï¼Œæ•°æ®åŒ…è½¬å‘çš„ç›®çš„åœ°æ˜¯åŠ¨æ€å†³å®šçš„ã€‚</p>
<h4 id="æœ¬åœ°ç«¯å£è½¬å‘">æœ¬åœ°ç«¯å£è½¬å‘</h4>
<p>æœ¬åœ°è½¬å‘ä¸­çš„æœ¬åœ°æ˜¯æŒ‡å°†æœ¬åœ°çš„æŸä¸ªç«¯å£(1024-65535)é€šè¿‡SSHéš§é“è½¬å‘è‡³å…¶ä»–ä¸»æœºçš„å¥—æ¥å­—ï¼Œè¿™æ ·å½“æˆ‘ä»¬çš„ç¨‹åºè¿æ¥æœ¬åœ°çš„è¿™ä¸ªç«¯å£æ—¶ï¼Œå…¶å®é—´æ¥è¿ä¸Šäº†å…¶ä»–ä¸»æœºçš„æŸä¸ªç«¯å£ï¼Œå½“æˆ‘ä»¬å‘æ•°æ®åŒ…åˆ°è¿™ä¸ªç«¯å£æ—¶æ•°æ®åŒ…å°±è‡ªåŠ¨è½¬å‘åˆ°äº†é‚£ä¸ªè¿œç¨‹ç«¯å£ä¸Šäº†</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20200730182255288.png" alt="image-20200730182255288" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<blockquote>
<p><strong>è¯­æ³•</strong></p>
</blockquote>
<pre><code class="language-sh">ssh -L [bind_address:]port:host:port ssh_host
</code></pre>
<pre><code class="language-sh">ssh -fNC -L 3333:100.109.9.249:22 111.44.246.139
</code></pre>
<blockquote>
<p><strong>å‘½ä»¤è¯´æ˜</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>bind_address</td>
<td>è¡¨ç¤ºå®¢æˆ·ç«¯ä¸»æœºçš„ipï¼Œè¿™æ˜¯é’ˆå¯¹ç³»ç»Ÿæœ‰å¤šå—ç½‘å¡ï¼Œä¸æŒ‡å®šé»˜è®¤æ˜¯127.0.0.1</td>
</tr>
<tr>
<td>port</td>
<td>æœ¬åœ°ä¸»æœºæŒ‡å®šç›‘å¬çš„ç«¯å£</td>
</tr>
<tr>
<td>host</td>
<td>è¿œç¨‹ä¸»æœºçš„ip</td>
</tr>
<tr>
<td>hostport</td>
<td>æŒ‡å®šè¿œç¨‹ä¸»æœºçš„ç«¯å£ï¼Œå¦‚æœè¿œç¨‹ä¸»æœºæ˜¯HTTPï¼Œå°±æ˜¯80ï¼ŒFTPï¼ˆ21ï¼‰ã€‚</td>
</tr>
<tr>
<td>ssh_host</td>
<td>è¿œç¨‹ä¸»æœºçš„ipï¼Œä¹Ÿå¯ä»¥æ˜¯èƒ½å¤Ÿè®¿é—®åˆ°è¿œç¨‹ä¸»æœºçš„å¦ä¸€ä¸ªip</td>
</tr>
</tbody>
</table>
<p><font color="#f8070d" size=3><code>-L</code></font>è¡¨æ˜æ˜¯æœ¬åœ°è½¬å‘ï¼Œæ­¤æ—¶<font color="#f8070d" size=2><code>TCPå®¢æˆ·ç«¯</code></font>ä¸<font color="#f8070d" size=2><code>SSHå®¢æˆ·ç«¯</code></font>åŒåœ¨æœ¬åœ°ä¸»æœºä¸Šã€‚åé¢æ¥ç€ä¸‰ä¸ªå€¼ï¼Œç”±å†’å·åˆ†å¼€ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼šéœ€è¦ç›‘å¬çš„æœ¬åœ°ç«¯å£ï¼Œè¿œç¨‹ä¸»æœºåæˆ–IPåœ°å€ï¼ŒåŠè¿œç¨‹çš„è½¬å‘ç›®æ ‡ç«¯å£å·ã€‚</p>
<h4 id="è¿œç¨‹ç«¯å£è½¬å‘">è¿œç¨‹ç«¯å£è½¬å‘</h4>
<p>è¿œç¨‹è½¬å‘å’Œæœ¬åœ°å¾ˆç›¸ä¼¼ï¼ŒåŸç†ä¹Ÿå·®ä¸å¤šï¼Œä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œæœ¬åœ°è½¬å‘æ˜¯åœ¨æœ¬åœ°ä¸»æœºæŒ‡å®šçš„ä¸€ä¸ªç«¯å£ï¼Œè€Œè¿œç¨‹è½¬å‘æ˜¯ç”±SSHæœåŠ¡å™¨ç»ç”±SSHå®¢æˆ·ç«¯è½¬å‘ï¼Œè¿æ¥è‡³ç›®æ ‡æœåŠ¡å™¨ä¸Šã€‚æœ¬è´¨ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºéœ€è¦è½¬å‘çš„ç«¯å£æ˜¯åœ¨è¿œç¨‹ä¸»æœºä¸Šè¿˜æ˜¯åœ¨æœ¬åœ°ä¸»æœºä¸Š</p>
<p>ç°åœ¨SSHå°±å¯ä»¥æŠŠè¿æ¥ä»ï¼ˆ39.104.112.253:80ï¼‰è½¬å‘åˆ°ï¼ˆ10.0.0.10:85ï¼‰ã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20200730182352895.png" alt="image-20200730182352895" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<blockquote>
<p><strong>è¯­æ³•</strong></p>
</blockquote>
<pre><code class="language-sh">ssh -R [bind_ip]:bind_port:host_ip:host_port sshserver
</code></pre>
<blockquote>
<p><strong>å‚æ•°è¯´æ˜</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-R</td>
<td>è¡¨ç¤ºè¿œç¨‹è½¬å‘ã€‚</td>
</tr>
<tr>
<td>bind_ip</td>
<td>è¡¨ç¤ºç»‘å®šçš„è¿œç¨‹ä¸»æœºiP</td>
</tr>
<tr>
<td>bind_port</td>
<td>è¿œç¨‹ä¸»æœºç›‘å¬ç«¯å£</td>
</tr>
<tr>
<td>host_ip</td>
<td>è¢«è®¿é—®çš„ä¸»æœºIP</td>
</tr>
<tr>
<td>host_port</td>
<td>è¢«è®¿é—®ä¸»æœºçš„ç«¯å£</td>
</tr>
<tr>
<td>sshserver</td>
<td>ä½¿ç”¨sshclientå»ºç«‹éš§é“çš„sshserver</td>
</tr>
</tbody>
</table>
<h4 id="åŠ¨æ€ç«¯å£è½¬å‘">åŠ¨æ€ç«¯å£è½¬å‘</h4>
<p>å®šå‘è½¬å‘ï¼ˆåŒ…æ‹¬æœ¬åœ°è½¬å‘å’Œè¿œç¨‹è½¬å‘ï¼‰çš„å±€é™æ€§æ˜¯å¿…é¡»æŒ‡å®šæŸä¸ªç›®æ ‡åœ°å€ï¼Œå¦‚æœéœ€è¦å€ŸåŠ©ä¸€å°ä¸­é—´æœåŠ¡å™¨è®¿é—®å¾ˆå¤šç›®æ ‡åœ°å€ï¼Œä¸€ä¸ªä¸€ä¸ªåœ°å®šå‘è½¬å‘æ˜¾ç„¶ä¸æ˜¯å¥½åŠæ³•ï¼Œè¿™æ—¶å°±è¦ç”¨çš„æ˜¯sshåŠ¨æ€ç«¯å£è½¬å‘ï¼Œå®ƒç›¸å½“äºå»ºç«‹ä¸€ä¸ªSOCKSæœåŠ¡å™¨ã€‚å„ç§åº”ç”¨ç»ç”±SSHå®¢æˆ·ç«¯è½¬å‘ï¼Œç»è¿‡SSHæœåŠ¡å™¨ï¼Œåˆ°è¾¾ç›®æ ‡æœåŠ¡å™¨ï¼Œä¸å›ºå®šç«¯å£ã€‚</p>
<blockquote>
<p><strong>è¯­æ³•</strong></p>
</blockquote>
<pre><code class="language-sh">ssh -fN -D [ssh client port] ssh server
</code></pre>
<blockquote>
<p><strong>å‚æ•°è¯´æ˜</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-D</td>
<td>åŠ¨æ€è½¬å‘</td>
</tr>
<tr>
<td>-f</td>
<td>åå°æ‰§è¡Œ</td>
</tr>
<tr>
<td>-N</td>
<td>ä¸æ‰§è¡Œä»»ä½•å‘½ä»¤</td>
</tr>
<tr>
<td>ssh client port</td>
<td>ç›‘å¬çš„ç«¯å£</td>
</tr>
<tr>
<td>ssh server</td>
<td>å½“ä½œsock5ä»£ç†æœåŠ¡å™¨(127.0.0.1)</td>
</tr>
</tbody>
</table>
<h2 id="sshç«¯å£è½¬å‘å®æˆ˜-1">SSHç«¯å£è½¬å‘å®æˆ˜</h2>
<h3 id="å®éªŒ1æœ¬åœ°ç«¯å£è½¬å‘åº”ç”¨">å®éªŒ1ï¼šæœ¬åœ°ç«¯å£è½¬å‘åº”ç”¨</h3>
<h4 id="å®éªŒç¯å¢ƒ">å®éªŒç¯å¢ƒ</h4>
<table>
<thead>
<tr>
<th>ä¸»æœº</th>
<th>å…¬ç½‘IP</th>
<th>å†…ç½‘IP</th>
<th>åœ°ä½</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td>39.104.116.253</td>
<td>172.24.104.10</td>
<td>client</td>
</tr>
<tr>
<td>node02</td>
<td>112.35.76.212</td>
<td>172.16.16.18</td>
<td>mysql server</td>
</tr>
</tbody>
</table>
<p>å®ç°åœ¨ç”Ÿäº§å†…ç½‘é‡Œæœ‰ä¸€å°mysqlæœåŠ¡å™¨ï¼ˆmysql Serverï¼‰ï¼Œä½†æ˜¯é™åˆ¶äº†åªæœ‰æœ¬æœºä¸Šéƒ¨ç½²çš„åº”ç”¨æ‰èƒ½ç›´æ¥è¿æ¥æ­¤ mysqlæœåŠ¡å™¨ã€‚ç°åœ¨æˆ‘ä»¬æƒ³ä¸´æ—¶ä»æœ¬åœ°æœºå™¨ï¼ˆmysql Clientï¼‰ç›´æ¥è¿æ¥åˆ°è¿™ä¸ªmysqlæœåŠ¡å™¨ï¼Œåªéœ€è¦åœ¨mysql Clientä¸Šè¿ç”¨æœ¬åœ°ç«¯å£è½¬å‘ã€‚</p>
<h4 id="æŸ¥çœ‹node01ç³»ç»ŸçŠ¶æ€">æŸ¥çœ‹node01ç³»ç»ŸçŠ¶æ€</h4>
<pre><code class="language-sh">$ ps -ef|grep mysql
root     21764 21724  0 23:15 pts/0    00:00:00 grep --color=auto mysql

$ ss -lnt
State      Recv-Q    Send-Q           Local Address:Port        Peer Address:Port              
LISTEN     0         128              *:22                      *:*    
</code></pre>
<p>æŸ¥çœ‹node02ç³»ç»ŸçŠ¶æ€</p>
<pre><code class="language-sh">$ ps -ef|grep mysql
mysql    2042     1   0 Aug30 ?      /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid
root     18250 18194  0 23:15 pts/0  grep --color=auto mysql
</code></pre>
<p>åœ¨ä¸»æœºAä¸Šæ‰§è¡Œå‘½ä»¤ï¼š<strong><font color="#f8070d" size=3><code>ssh -Nf -L *:7000:127.0.0.1:3306 112.35.76.212</code></font></strong></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨é€‰æ‹©ç«¯å£å·æ—¶è¦æ³¨æ„éç®¡ç†å‘˜å¸å·æ˜¯æ— æƒç»‘å®š 1-1023 ç«¯å£çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬æ˜¯é€‰ç”¨ä¸€ä¸ª 1024-65535 ä¹‹é—´çš„å¹¶ä¸”å°šæœªä½¿ç”¨çš„ç«¯å£å·å³å¯ã€‚</p>
<pre><code class="language-sh">$ ss -lnt
State      Recv-Q Send-Q          Local Address:Port          Peer Address:Port              
LISTEN     0      128              *:22                        *:*                  
LISTEN     0      128              *:7000                      *:*                  
LISTEN     0      128             :::7000                     :::*                  
</code></pre>
<p>å¯ä»¥å‘ç°ï¼Œnode01çš„7000ç«¯å£å·²è¢«ç›‘å¬äº†ï¼Œæ˜¯è¢«sshï¼ˆsshå°±æ˜¯å®¢æœç«¯ï¼‰ç›‘å¬çš„ï¼Œå’Œnode02å»ºç«‹äº†ä¸€ä¸ªSSHéš§é“ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“node01å’Œnode02æ˜¯å¯ä»¥é€šä¿¡çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸»æœºAçš„ç«¯å£è®¿é—®æ—¶ï¼Œå…¶å®å°±æ˜¯é—´æ¥ç”¨ä¸»æœºBåœ¨è®¿é—®ã€‚å¯ä»¥çœ‹åˆ°å¯ä»¥æ­£å¸¸ç™»é™†mysqlã€‚</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/babde631.gif" alt="" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<hr>
<p><font color="#0215cd" size=2>æ³¨ï¼šmysqlç»è¿‡è½¬å‘å®é™…ç™»é™†mysqlçš„ç”¨æˆ·ç»„æˆçš„ipä¸ºsshserverç™»é™†çš„ipã€‚è€Œä¸æ˜¯sshclientçš„ip</font></p>
<hr>
<h3 id="å®éªŒ2è¿œç¨‹ç«¯å£è½¬å‘åº”ç”¨">å®éªŒ2ï¼šè¿œç¨‹ç«¯å£è½¬å‘åº”ç”¨</h3>
<p>å†…ç½‘é€šè¿‡è·¯ç”±å™¨ï¼ˆSNATï¼‰å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œè€Œå¤–ç½‘æ˜¯æ— æ³•è®¿é—®åˆ°å†…ç½‘çš„ï¼Œæˆ‘ä»¬åˆ©ç”¨sshæ¥å®ç°è®¿é—®å†…ç½‘ï¼Œè¦æ­å»ºè¿™ç§ç¯å¢ƒï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯VMwareçš„NATæ¨¡å¼ï¼Œæˆ‘å°†node03è®¾ç½®NATæ¨¡å¼ã€‚</p>
<table>
<thead>
<tr>
<th>ä¸»æœº</th>
<th>å…¬ç½‘IP</th>
<th>å†…ç½‘IP</th>
<th>åœ°ä½</th>
</tr>
</thead>
<tbody>
<tr>
<td>node01</td>
<td>112.35.26.104</td>
<td>172.24.104.10</td>
<td>sshserver</td>
</tr>
<tr>
<td>node02</td>
<td>112.35.76.212</td>
<td>172.16.16.18</td>
<td>sshclient</td>
</tr>
<tr>
<td>node03</td>
<td></td>
<td>172.16.16.11</td>
<td>mysql</td>
</tr>
<tr>
<td>node04</td>
<td></td>
<td></td>
<td>å®¢æˆ·ç«¯</td>
</tr>
</tbody>
</table>
<p>åœ¨node02æ‰§è¡Œå‘½ä»¤ï¼š<code>ssh -Nf -R *:7706:172.16.16.11:3306 112.35.26.104</code>ï¼Œsshclientä¸sshserverå»ºç«‹éš§é“è¿æ¥ã€‚</p>
<pre><code class="language-sh">$ netstat -nt|grep 104
tcp        0      0 172.16.16.18:50676      112.35.26.104:22        ESTABLISHED
</code></pre>
<p>sshserverä¸Šå¯è§åˆ°ç›‘å¬çš„ç«¯å£ã€‚</p>
<pre><code class="language-sh">$ ss -lnt|grep 7706
LISTEN     0      128         127.0.0.1:7706              *:*     
LISTEN     0      128               ::1:7706             :::*     
</code></pre>
<p>ç™»é™†ç¯å¢ƒè¿›è¡Œæµ‹è¯•</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/13acf536.gif" alt="" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>ç¿»å¢™å‘½ä»¤ <code>ssh -TfnN -D {Port} {User}@{Host}</code></p>
<pre><code>ssh -TfnN -D 7070 root@195.133.11.43
</code></pre>
]]></content:encoded>
    </item>
    
    <item>
      <title>åŒæ­¥å·¥å…·rsyncä½¿ç”¨æŒ‡å—</title>
      <link>https://www.oomkill.com/2017/05/rsync/</link>
      <pubDate>Sun, 07 May 2017 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2017/05/rsync/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="overview">Overview</h2>
<p>å®˜æ–¹ç½‘ç«™ï¼šhttps://www.samba.org/ftp/rsync/rsync.html</p>
<p>rsyncç‰¹æ€§</p>
<ul>
<li>
<p>rsyncç±»ä¼¼äºscpçš„åŠŸèƒ½</p>
</li>
<li>
<p>rsyncè¿˜å¯ä»¥åœ¨æœ¬åœ°çš„ä¸åŒåˆ†åŒºå’Œç›®å½•ä¹‹é—´è¿›è¡Œå…¨é‡åŠå¢é‡çš„å¤åˆ¶æ•°æ®ï¼Œç±»ä¼¼cpåˆä¼˜äºcp</p>
</li>
<li>
<p>rsyncå¯ä»¥å®ç°æ–‡ä»¶çš„åˆ é™¤</p>
</li>
</ul>
<p>ä¸€ä¸ªrsyncç›¸å½“äº scp cp rmï¼Œä½†æ˜¯è¿˜ä¼˜äºä»–ä»¬æ¯ä¸€ä¸ª</p>
<ul>
<li>æ”¯æŒæ‹·è´ç‰¹æ®Šæ–‡ä»¶å¦‚é“¾æ¥æ–‡ä»¶ï¼Œè®¾å¤‡ç­‰</li>
<li>å¯ä»¥æœ‰æ’é™¤æŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•çš„æƒé™ã€æ—¶é—´ã€è½¯ç¡¬é“¾æ¥ã€å±ä¸»ã€ç»„æ‰€æœ‰å±æ€§å‡ä¸æ”¹å˜-p</li>
<li>å¯ä»¥æœ‰æ’é™¤æŒ‡å®šæ–‡ä»¶æˆ–ç›®å½•çš„åŠŸèƒ½ï¼Œç›¸å½“äºæ‰“åŒ…å‘½ä»¤tarçš„æ’é™¤åŠŸèƒ½</li>
<li>å¯ä»¥å®ç°å¢é‡åŒæ­¥ï¼Œå³åªåŒæ­¥å‘ç”Ÿå˜åŒ–çš„æ•°æ®ï¼Œå› æ­¤æ•°æ®ä¼ è¾“æ•ˆç‡å¾ˆé«˜tarã€‚</li>
<li>å¯ä»¥ä½¿ç”¨rcp rsh sshç­‰æ–¹å¼æ¥é…åˆä¼ è¾“æ–‡ä»¶ï¼ˆrsyncæœ¬èº«ä¸å¯¹æ•°æ®åŠ å¯†ï¼‰</li>
<li>å¯ä»¥é€šè¿‡socketï¼ˆè¿›ç¨‹æ–¹å¼ï¼‰ä¼ è¾“æ–‡ä»¶å’Œæ•°æ®</li>
<li>æ”¯æŒåŒ¿åçš„æˆ–è®¤è¯ï¼ˆæ— é¡»ç³»ç»Ÿç”¨æˆ·ï¼‰çš„è¿›ç¨‹æ¨¡å¼ä¼ è¾“ï¼Œå¯å®ç°æ–¹ä¾¿å®‰å…¨çš„è¿›è¡Œæ•°æ®å¤‡ä»½åŠé•œåƒ</li>
</ul>
<h2 id="å®‰è£…rsync">å®‰è£…rsync</h2>
<h3 id="linuxä¸Šå®‰è£…rsync">linuxä¸Šå®‰è£…rsync</h3>
<table>
<thead>
<tr>
<th>Platform</th>
<th>Command</th>
</tr>
</thead>
<tbody>
<tr>
<td>Debian/Ubuntu &amp; Mint</td>
<td>sudo apt-get install rsync</td>
</tr>
<tr>
<td>Arch Linux</td>
<td>pacman -S rsync</td>
</tr>
<tr>
<td>Gentoo</td>
<td>emerge sys-apps/rsync</td>
</tr>
<tr>
<td>Fedora/CentOS/RHEL and Rocky Linux/AlmaLinux</td>
<td>sudo yum install rsync</td>
</tr>
<tr>
<td>openSUSE</td>
<td>sudo zypper install rsync</td>
</tr>
</tbody>
</table>
<h3 id="windowså®‰è£…rsync">windowså®‰è£…rsync</h3>
<p>å®˜ç½‘ä¸‹è½½cwRsyncçš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è½¯ä»¶ï¼ŒcwRsyncå®˜ç½‘ä¸ºï¼šwww.itefix.net/cwrsync</p>
<blockquote>
<p>Notesï¼šç”±äºä¼Ÿå¤§çš„ peopleâ€˜s leader president xi ç½‘ç«™å·²ç»æ— æ³•ä¸­å›½åœ°åŒºè®¿é—®ï¼ˆ<a href="https://tcp.ping.pe/www.itefix.net:443" target="_blank"
   rel="noopener nofollow noreferrer" >ç‚¹å‡»æµ‹è¯•</a>ï¼‰ï¼Œä¼Ÿå¤§çš„ä¿„ç½—æ–¯å› ä¸ºä¿„ä¹Œæˆ˜äº‰ï¼Œä¹Ÿä¸å¯¹ä¿„ç½—æ–¯è®¿é—®äº†ï¼ˆä¿„ä¹Œæˆ˜äº‰å¼€å§‹åï¼Œè¥¿æ–¹å¤§é‡å­¦æœ¯ç½‘ç«™ç¦æ­¢äº†ä¿„ç½—æ–¯åœ°åŒºçš„è®¿é—®ï¼‰</p>
</blockquote>
<p>æ‰€ä»¥ç›®å‰åªèƒ½ä¸‹è½½åˆ°ä¸€äº›é•œåƒç«™ä¸Š4.xç‰ˆæœ¬ï¼Œæˆªæ­¢åˆ°2022å¹´11æœˆçš„6.2.7ç›¸å·®å¾ˆå¤šï¼Œwindowså®¢æˆ·ç«¯ç‰ˆæœ¬å¯ä»¥é€šè¿‡<code>chocolate</code> å®‰è£…</p>
<h3 id="rsyncä½¿ç”¨è¯´æ˜">rsyncä½¿ç”¨è¯´æ˜</h3>
<p>rsyncå‘½ä»¤è¯­æ³•</p>
<table>
<thead>
<tr>
<th>é€‰é¡¹</th>
<th>æ³¨é‡Šè¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>rsync</td>
<td>rsyncåŒæ­¥å‘½ä»¤</td>
</tr>
<tr>
<td>option</td>
<td>ä¸ºåŒæ­¥æ—¶çš„é€‰é¡¹å‚æ•°</td>
</tr>
<tr>
<td>src</td>
<td>ä¸ºæºï¼ŒåŠå¾…æ‹·è´çš„åˆ†åŒºã€æ–‡ä»¶æˆ–ç›®å½•ç­‰</td>
</tr>
<tr>
<td>dest</td>
<td>ä¸ºç›®æ ‡åˆ†åŒºã€æ–‡ä»¶æˆ–ç›®å½•ç­‰</td>
</tr>
</tbody>
</table>
<p>rsyncå‚æ•°è¯´æ˜</p>
<table>
<thead>
<tr>
<th>å‚æ•°é€‰é¡¹</th>
<th>æ³¨é‡Šè¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-v &ndash;verbose</td>
<td>è¯¦ç»†æ¨¡å¼è¾“å‡ºï¼Œä¼ è¾“æ—¶çš„è¿›åº¦ä¿¡æ¯</td>
</tr>
<tr>
<td>-z &ndash;compress</td>
<td>ä¼ è¾“æ—¶è¿›è¡Œå‹ç¼©ä»¥æé«˜ä¼ è¾“æ•ˆç‡ï¼Œ<code>--compress-level=NUM</code> å¯æŒ‰çº§åˆ«å‹ç¼©</td>
</tr>
<tr>
<td>-a &ndash;archive</td>
<td>å½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºä»¥é€’å½’æ–¹å¼ä¼ è¾“æ–‡ä»¶ï¼Œå¹¶ä¿æŒæ‰€æœ‰æ–‡ä»¶å±æ€§ï¼Œç­‰äº-rtopgDl</td>
</tr>
<tr>
<td>r &ndash;recursive</td>
<td>å¯¹å­ç›®å½•è¿›è¡Œé€’å½’æ¨¡å¼ï¼Œå³ç›®å½•ä¸‹çš„æ‰€æœ‰ç›®å½•éƒ½åŒæ ·ä¼ è¾“</td>
</tr>
<tr>
<td>t &ndash;times</td>
<td>ä¿æŒæ–‡ä»¶æ—¶é—´ä¿¡æ¯</td>
</tr>
<tr>
<td>o &ndash;owner</td>
<td>ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯</td>
</tr>
<tr>
<td>p &ndash;perms</td>
<td>ä¿æŒæ–‡ä»¶æƒé™</td>
</tr>
<tr>
<td>g &ndash;group</td>
<td>ä¿æŒæ–‡ä»¶å±ä¸»ä¿¡æ¯</td>
</tr>
<tr>
<td>P &ndash;progress</td>
<td>æ˜¾ç¤ºåŒæ­¥çš„è¿‡ç¨‹åŠä¼ è¾“æ—¶çš„è¿›åº¦ç­‰ä¿¡æ¯</td>
</tr>
<tr>
<td>D &ndash;devices</td>
<td>çˆ†å‡ºè®¾å¤‡æ–‡ä»¶ä¿¡æ¯</td>
</tr>
<tr>
<td>l &ndash;links</td>
<td>ä¿ç•™è½¯è¿æ¥</td>
</tr>
<tr>
<td>-e &ndash;rsh=<strong>COMMAND</strong></td>
<td>ä½¿ç”¨çš„ä¿¡é“åè®®ï¼Œåˆ¶å®šæ›¿ä»£rshçš„shellç¨‹åºï¼Œä¾‹å¦‚ssh</td>
</tr>
<tr>
<td>-exclude=<strong>PATTERN</strong></td>
<td>åˆ¶å®šæ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶æ¨¡å¼</td>
</tr>
<tr>
<td>&ndash;bwlimit=<strong>RATE</strong></td>
<td>é™åˆ¶socket I/Oå¸¦å®½</td>
</tr>
<tr>
<td>&ndash;password-file=<strong>PATH</strong></td>
<td>æŒ‡å®šå¯†ç æ–‡ä»¶ï¼Œå¯é¿å…å¤šæ¬¡è¾“å…¥å¯†ç </td>
</tr>
<tr>
<td>&ndash;delete</td>
<td>å¦‚æœæœåŠ¡å™¨ç«¯ä¸ºç©ºï¼Œè€Œå®¢æˆ·ç«¯æœ‰æ–‡ä»¶ï¼ŒåŠ ä¸Šè¿™ä¸ªå‚æ•°å°±ä¼šåˆ é™¤å®¢æˆ·ç«¯ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼Œç›¸å½“äºrm</td>
</tr>
<tr>
<td>&ndash;exclude</td>
<td>æ’é™¤å•/å¤šä¸ªæ–‡ä»¶</td>
</tr>
<tr>
<td>&ndash;timeout=<strong>ç§’</strong></td>
<td>è¶…æ—¶å‚æ•°</td>
</tr>
<tr>
<td>&ndash;port</td>
<td>æŒ‡å®šç«¯å£</td>
</tr>
<tr>
<td>-R &ndash;relative</td>
<td>ä½¿ç”¨ç›¸å¯¹è·¯å¾„ä¿¡æ¯</td>
</tr>
<tr>
<td>-u &ndash;update</td>
<td>ä»…ä»…è¿›è¡Œæ›´æ–°ï¼Œä¹Ÿå°±æ˜¯è·³è¿‡æ‰€æœ‰å·²ç»å­˜åœ¨äºDSTï¼Œå¹¶ä¸”æ–‡ä»¶æ—¶é—´æ™šäºè¦å¤‡ä»½çš„æ–‡ä»¶ã€‚(ä¸è¦†ç›–æ›´æ–°çš„æ–‡ä»¶)</td>
</tr>
</tbody>
</table>
<h3 id="rsyncé…ç½®æ–‡ä»¶è¯´æ˜">rsyncé…ç½®æ–‡ä»¶è¯´æ˜</h3>
<pre><code class="language-conf"># æ¯ä¸€ä¸ªç¨‹åºçš„è¿›ç¨‹éƒ½è¦ä¾èµ–ä¸€ä¸ªç”¨æˆ·ï¼Œé»˜è®¤ä¸ºnobodyï¼Œç»™é»˜è®¤ä¸ºrsync
uid = rsync
gid = rsync
# é˜²æ­¢å‡ºç°å®‰å…¨é—®é¢˜çš„ï¼Œä¸€èˆ¬ä¸ºå±€åŸŸç½‘
use chroot = no
# æœ‰å¤šå°‘ä¸ªå®¢æˆ·ç«¯å¯ä»¥è¿æ¥æœåŠ¡å™¨ åŒæ—¶è¿æ¥çš„å®¢æˆ·ç«¯
max connections = 200
# å®¢æˆ·ç«¯è¿æ¥å¤šå°‘æ—¶é—´è¶…æ—¶ï¼ˆå¦‚è¿æ¥äº†ä¸ç©¿æ•°æ®ï¼Œå¤šå°‘æ—¶é—´è¸¢æ‰ï¼‰
timeout = 300
# linuxä¸­æ¯ä¸ªè¿›ç¨‹éƒ½å¯¹åº”ä¸€ä¸ªè¿›ç¨‹å·pid ï¼Œpidæ‰€åœ¨çš„æ–‡ä»¶å°±æ˜¯pidfileï¼Œå°†æ¥å¤„ç†è¿›ç¨‹çš„æ—¶å€™ä¸ç”¨å†æ‰¾äº†ï¼Œç›´æ¥æ€pidæ–‡ä»¶å°±è¡Œ
pid file = /var/run/rsyncd.pid
# rsync åœ¨ä¼ è¾“æ•°æ®æ—¶ï¼ŒåŒæ–¹éƒ½åœ¨ç©¿å¯èƒ½å‡ºé”™ï¼Œåœ¨ä¸€ä¸ªç”¨æˆ·æ”¹çš„æ—¶å€™ï¼Œå…¶ä»–ç”¨æˆ·ä¸èƒ½æ”¹
lock file = /var/run/rsync.lock
# æ—¥å¿—ï¼Œå‡ºé”™
log file = /var/log/rsyncd.log
# æ¨¡å— ç›¸å½“äºnfså…±äº«çš„ç›®å½• å¯ä»¥ç†è§£ä¸ºnfsçš„
[oldboy]
path = /oldboy/
# åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­é‡åˆ°é”™è¯¯è‡ªåŠ¨å¿½ç•¥
ignore errors
# å¯è¯»å¯å†™ 
read only = false
# å…ä¸å…è®¸ä½ åˆ—è¡¨ falseä¸å…è®¸
list = false
# å…è®¸çš„ä¸»æœº
hosts allow = 10.0.0.0/24
# æ‹’ç» rsyncæ”¯æŒè™šæ‹Ÿç”¨æˆ·ï¼Œä¸æ˜¯ç³»ç»Ÿç”¨æˆ·ï¼Œè¿™
hosts deny = 0.0.0.0/32
# ä¼ è¾“æ—¶éªŒè¯çš„ç”¨æˆ·
auth users = rsync_backup
# ç”¨æˆ·å¯¹åº”çš„å¯†ç æ–‡ä»¶ï¼Œå¦‚æœæŒ‡å®šå¯†ç æ–‡ä»¶ï¼Œå°±å¾—æ¥å›è¾“å…¥å¯†ç ï¼Œåœ¨å†…ç½‘ä¸­ä¸éœ€è¦é‡å¤è¾“å…¥å¯†ç ï¼Œå°±å°†å¯†ç å†™å…¥æ–‡ä»¶
secrets file = /etc/rsync.password
</code></pre>
<h2 id="rsyncçš„å·¥ä½œæ¨¡å¼">rsyncçš„å·¥ä½œæ¨¡å¼</h2>
<p>rsyncæä¾›äº†ä¸‰ç§åŒæ­¥æ¨¡å¼ï¼š</p>
<ul>
<li>Rsync over SSH</li>
<li>Rsync Daemon</li>
<li>Local</li>
</ul>
<h2 id="local">Local</h2>
<p>rsyncå¦‚æœä¸ä½¿ç”¨è¿œç¨‹æ¨¡å¼ç±»ä¼¼äºcpå‘½ä»¤ï¼Œä¾‹å¦‚</p>
<ul>
<li><code>rsync /etc/hosts /opt/</code> ==  <code>cp /etc/hosts/ /opt/</code></li>
</ul>
<hr>
<p>æ³¨ï¼šç›®å½•ç»“å°¾åŠ  <code>/</code> ä¸ä¸åŠ  <code>/</code> çš„åŒºåˆ«ï¼Œä¸åŠ æ–œçº¿è¡¨ç¤ºç›®å½•ä»¥åŠç›®å½•é‡Œé¢çš„ä¸œè¥¿ï¼ŒåŠ æ–œçº¿è¡¨ç¤ºç›®å½•é‡Œé¢çš„ä¸œè¥¿</p>
<hr>
<h3 id="rsyncä½œä¸ºdamonæ¨¡å¼è¿è¡Œ">rsyncä½œä¸ºdamonæ¨¡å¼è¿è¡Œ</h3>
<p>å¦‚æœä¸»æœºæ²¡æœ‰è¿è¡Œ SSHæœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ <code>rsync --daemon</code> é…ç½®å¹¶ä½œä¸ºå®ˆæŠ¤è¿›ç¨‹è¿è¡Œã€‚è¿™ç§åœºæ™¯ä¸‹ <code>rsync</code> ç›‘å¬ç«¯å£ 873 ä»¥è·å–æ¥è‡ªå…¶ä»–ä½¿ç”¨ <code>rsync client</code> çš„åŒæ­¥ï¼Œè¿™ç§æ¨¡å¼ä¸‹æ•°æ®æ˜¯æœªåŠ å¯†çš„ã€‚</p>
<h4 id="é…ç½®daemonç«¯">é…ç½®daemonç«¯</h4>
<p><strong>é…ç½®rsync daemonä½ç½®æ–‡ä»¶</strong></p>
<p>rsync damonæ¨¡å¼é…ç½®æ–‡ä»¶é»˜è®¤åœ¨ <code>/etc/rsyncd.conf</code> å¦‚æœæ²¡æœ‰å¯ä»¥è‡ªè¡Œåˆ›å»º</p>
<pre><code class="language-conf">lock file = /var/run/rsync.lock
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid

[documents]
    path = /home/juan/Documents
    comment = The documents folder of Juan
    uid = juan
    gid = juan
    read only = no
    list = yes
    auth users = rsyncclient
    secrets file = /etc/rsyncd.secrets
    hosts allow = 192.168.1.0/255.255.255.0
</code></pre>
<p>rsyncdé…ç½®æ–‡ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ<strong>å…¨å±€å‚æ•°</strong>ä¸<strong>æ¨¡å—</strong>ã€‚</p>
<ul>
<li><code>lock file</code> æ˜¯ <code>rsync</code> ç”¨äºå¤„ç†æœ€å¤§è¿æ¥æ•°çš„æ–‡ä»¶</li>
<li><code>log file</code> æ˜¯ <code>rsync</code> åŒæ­¥æ—¶çš„æ—¥å¿—ï¼›æ±‡é›†è·¯å¼€å§‹è¿è¡Œçš„æ—¶é—´, å…¶ä»–å®¢æˆ·ç«¯è¿æ¥çš„æ—¶é—´ä¸ä»»ä½•é”™è¯¯</li>
<li><code>pid file</code> æ˜¯ <code>rsync</code> è®°å½•äº†è¿›ç¨‹IDï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶æ¥killè¿›ç¨‹</li>
</ul>
<p>åœ¨å…¨å±€å‚æ•°ä¹‹åï¼Œ<code>[]</code> ä¸­çš„æ˜¯æ¨¡å—éƒ¨åˆ†ï¼Œä»£è¡¨çš„æ˜¯è¦åŒæ­¥çš„ä¸€ä¸ªç›®å½•ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯è¦å…±äº«çš„æ–‡ä»¶å¤¹</p>
<ul>
<li><code>[name]</code> åˆ†é…ç»™æ¨¡å—çš„åç§°ï¼Œæ¯ä¸ªæ¨¡å—ä»£è¡¨ä¸€ä¸ªç›®å½•ï¼Œä¸èƒ½åŒ…å«æ–œæ æˆ–å³æ–¹æ‹¬å·</li>
<li><code>path</code> åŒæ­¥çš„æ–‡ä»¶å¤¹çš„è·¯å¾„</li>
<li><code>comment</code> å½“å®¢æˆ·ç«¯è·å–æ‰€æœ‰å¯ç”¨æ¨¡å—çš„æ—¶ï¼Œè·å–å‡ºçš„åˆ—è¡¨å†…æ¨¡å—åç§°æ—è¾¹çš„æ³¨é‡Š</li>
<li><code>uid</code> å½“ rsyncå®ˆæŠ¤è¿›ç¨‹ä»¥root èº«ä»½è¿è¡Œæ—¶ï¼Œå¯ä»¥æŒ‡å®šä»¥å“ªä¸ªç”¨æˆ·æ‹¥æœ‰æ–‡ä»¶çš„æƒé™</li>
<li><code>gid</code> åŒä¸Š</li>
<li><code>read only</code> å†³å®šrsync å®¢æˆ·ç«¯æ˜¯å¦å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œé»˜è®¤æ‰€æœ‰æ¨¡å—ä¸º true</li>
<li><code>list</code> å…è®¸å®¢æˆ·ç«¯è¯·æ±‚å¯ç”¨æ¨¡å—åˆ—è¡¨ï¼Œfalse ä¸ºä»åˆ—è¡¨ä¸­éšè—æ¨¡å—ã€‚</li>
<li><code>auth users</code> å…è®¸è®¿é—®è¯¥æ¨¡å—å†…å®¹çš„ç”¨æˆ·åˆ—è¡¨ï¼Œç”¨æˆ·ä»¥é€—å·åˆ†éš”ã€‚ç”¨æˆ·ä¸éœ€è¦å­˜åœ¨äºç³»ç»Ÿä¸­ï¼Œä»–ä»¬ç”±å¯†é’¥æ–‡ä»¶å®šä¹‰</li>
<li><code>secrets file</code> å®šä¹‰åŒ…å«rsyncåŒæ­¥æ—¶ç”¨æˆ·çš„ç”¨æˆ·åå’Œå¯†ç çš„æ–‡ä»¶</li>
<li><code>hosts allow</code> å…è®¸è¿æ¥åˆ°rsync daemonçš„ç½‘æ®µï¼Œé»˜è®¤å…è®¸æ‰€æœ‰ä¸»æœºè¿æ¥</li>
</ul>
<p><strong>åˆ›å»ºrsyncç”¨æˆ·</strong></p>
<pre><code class="language-bash">$ useradd rsync -s /sbin/nologin -M
</code></pre>
<p><strong>ä¿®æ”¹å…±äº«çš„ç›®å½•çš„æ‰€å±æƒé™</strong></p>
<pre><code class="language-bash">$ chown -R rsync.rsync /data  
</code></pre>
<p><strong>åˆ›å»ºå¯†ç æ–‡ä»¶</strong></p>
<p>è¯¥æ–‡ä»¶ä¸­ï¼Œæ¯è¡Œä»£è¡¨ä¸€ä¸ªrsyncç”¨æˆ·ï¼Œè´¦å·å’Œå¯†ç ç”¨å†’å·åˆ†éš”</p>
<pre><code class="language-bash">$ echo &quot;rsync_backup:111111&quot;&gt; /etc/rsync.password
# å› å¯†ç å¯è¯»ï¼Œæ‰€ä»¥è¦é™ä½æƒé™
$ chmod 600 /etc/rsync.password
</code></pre>
<p>æœ€åï¼Œæ›´æ”¹æ­¤æ–‡ä»¶çš„æƒé™ï¼Œä½¿å…¶ä¸èƒ½è¢«å…¶ä»–ç”¨æˆ·è¯»å–æˆ–ä¿®æ”¹ã€‚å¦‚æœæ­¤æ–‡ä»¶çš„æƒé™è®¾ç½®ä¸æ­£ç¡®ï¼Œ<code>rsync</code> ä¼šæŠ¥é”™</p>
<pre><code class="language-bash">sudo chmod 600 /etc/rsyncd.secrets
</code></pre>
<p><strong>å¯åŠ¨ rsync daemon</strong></p>
<p>ç›´æ¥ä½¿ç”¨ <code>--daemon</code> å¯åŠ¨å³å¯</p>
<pre><code class="language-bash">sudo rsync --daemon
</code></pre>
<h4 id="ä½¿ç”¨rsyncè¿æ¥daemonä¸€ç«¯">ä½¿ç”¨rsyncè¿æ¥daemonä¸€ç«¯</h4>
<p>ä½¿ç”¨ <code>rsync</code> å‘½ä»¤è¿æ¥ rsync daemonæ—¶ï¼Œä¸å¯ä»¥åƒä½¿ç”¨ SSH æ—¶é‚£æ ·ä½¿ç”¨å†’å·ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åŒå†’å· â€::â€œï¼Œåè·Ÿæ¨¡å—åï¼Œä»¥åŠåŒæ­¥çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚</p>
<pre><code class="language-bash">rsync -rtv user@host::module/source/ destination/
</code></pre>
<p>å¦ä¸€ç§æ–¹æ³•æ˜¯å¢åŠ  <code>rsync://</code> åè®®ï¼Œä¾‹å¦‚</p>
<pre><code class="language-bash">rsync -rtv rsync://user@host/module/source/ destination/
</code></pre>
<p>å¦‚æœä¸æƒ³è¾“å…¥å¯†ç å¯ä»¥æŒ‡å®šå‚æ•° <code>--password-file=</code> æä¾›å¯†ç æ–‡ä»¶ï¼Œå¯†ç æ–‡ä»¶å°±æ˜¯åˆ›å»ºçš„secret fileï¼Œä¾‹å¦‚</p>
<pre><code class="language-bash">$ rsync -avz rsync_backup@192.168.59.121::data \
	/test \
	--password-file=/etc/rsync.password 
</code></pre>
<p>ä½¿ç”¨rsyncå‘½ä»¤æ¨ä¸æ‹‰</p>
<ul>
<li>
<p>Pull <code>rsync [OPTION...] [USER@]HOST::SRC... [DEST]</code></p>
<pre><code class="language-bash">rsync -avz rsync_backup@192.168.59.121::data /test/ --password-file=/etc/rsync.password
</code></pre>
</li>
<li>
<p>Push <code>rsync [OPTION...] SRC... [USER@]HOST::DEST</code> || <code> rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST</code></p>
<pre><code class="language-bash">rsync -avz /test/ rsync://rsync_backup@192.168.59.121/data/  --password-file=/etc/rsync.password
</code></pre>
</li>
</ul>
<h3 id="rsync-over-ssh">Rsync Over SSH</h3>
<p>é™¤äº†daemonæ¨¡å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨sshæ¨¡å¼è¿›è¡Œä¼ è¾“ï¼Œä¾‹å¦‚ä½¿ç”¨Over SSHå‘½ä»¤</p>
<ul>
<li>Push  <code>rsync [OPTION]... -e ssh [SRC]... [USER@]HOST:DEST</code></li>
<li>Pull  <code>rsync [OPTION]... -e ssh [USER@]HOST:SRC... [DEST]</code></li>
</ul>
<p>è¾ƒæ–°ç‰ˆæœ¬çš„ rsync  SSH ä¸ºé»˜è®¤ï¼Œå¯ä»¥çœç•¥è¯¥<code>-e ssh</code>é€‰é¡¹ï¼Œä½† over ssh ä¸ over daemonçš„åŒºåˆ«è¿˜æ˜¯ ä¸€ä¸ªå†’å·ä¸ä¸¤ä¸ªå†’å·</p>
<h2 id="rsyncä½¿ç”¨å®ä¾‹">rsyncä½¿ç”¨å®ä¾‹</h2>
<h3 id="over-ssh">Over SSH</h3>
<ul>
<li>Pull    <code>rsync -avz -e 'ssh -p &lt;port&gt;' &lt;user&gt;@&lt;host&gt;:/&lt;remote_dir&gt; /&lt;local_dir&gt;</code></li>
<li>Push  <code>rsync -avz -e 'ssh -p &lt;port&gt;' /&lt;local_dir&gt; &lt;user&gt;@&lt;host&gt;:/&lt;remote_dir&gt; </code></li>
</ul>
<h3 id="local-to-remote">Local to Remote</h3>
<ul>
<li>Push  <code>rsync -avzh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;</code></li>
<li>Pull    <code>rsync -avzh &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt; &lt;local_dir&gt;</code></li>
</ul>
<h3 id="æ˜¾ç¤ºè¿›åº¦æ¡">æ˜¾ç¤ºè¿›åº¦æ¡</h3>
<ul>
<li><code>rsync -avzhe ssh --progress &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;</code></li>
</ul>
<h3 id="include-and-exclude">Include and exclude</h3>
<p>æ’é™¤å’ŒåŒ…å«å¯ä»¥ä½¿ç”¨æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¾‹å¦‚</p>
<ul>
<li>åŒ…å«Rå¼€å¤´æ–‡ä»¶ï¼š <code>rsync -avze  --include 'R*' &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt; &lt;local_dir&gt;</code></li>
<li>æ’é™¤æ‰€æœ‰æ–‡ä»¶ï¼š <code>rsync -avze  --exclude '*' &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt; &lt;local_dir&gt;</code></li>
<li>ä»…ä¸Šä¼ Rå¼€å¤´çš„æ–‡ä»¶ï¼š<code>rsync -avze ssh --include 'R*' --exclude '*' &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt; &lt;local_dir&gt;</code></li>
<li><code>--exclude-from</code> æ˜¯åŒæ­¥æ—¶æ’é™¤æ–‡ä»¶ä¸­æŒ‡å®šçš„æ–‡ä»¶</li>
</ul>
<h3 id="å·²å­˜åœ¨æ–‡ä»¶çš„å¤„ç†ç­–ç•¥">å·²å­˜åœ¨æ–‡ä»¶çš„å¤„ç†ç­–ç•¥</h3>
<p>å¦‚æœæƒ³ä¿è¯ <code>&lt;Src&gt;</code> ä¸ <code>&lt;DST&gt;</code>  ä¿æŒä¸€è‡´å¯ä»¥ä½¿ç”¨ <code>--delete</code> æ¥åˆ é™¤ <code>&lt;Src&gt;</code> ç°æœ‰æ–‡ä»¶æˆ–ç›®å½•ï¼ˆåªå­˜åœ¨äºç›®æ ‡ç›®å½•ä¸å­˜åœ¨äºæºç›®æ ‡çš„æ–‡ä»¶ï¼‰</p>
<pre><code class="language-bash">rsync -avz --delete &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt; &lt;local_dir&gt;
</code></pre>
<p>å½“åœ¨åˆ é™¤æˆ–æ›´æ–°ç›®æ ‡ç›®å½•å·²ç»å­˜åœ¨çš„æ–‡ä»¶æ—¶ï¼Œä¸æƒ³åˆ é™¤è€Œæƒ³å¤‡ä»½ï¼Œå¯ä»¥æŒ‡å®šå‚æ•° <code>-b</code>, <code>--backup</code></p>
<h3 id="é™åˆ¶ä¼ è¾“æ–‡ä»¶å¤§å°">é™åˆ¶ä¼ è¾“æ–‡ä»¶å¤§å°</h3>
<p>å¯ä»¥ä½¿ç”¨ â€œ <strong>-â€“max-size</strong> â€ é€‰é¡¹æŒ‡å®šè¦ä¼ è¾“æˆ–åŒæ­¥çš„<strong>æœ€å¤§æ–‡ä»¶å¤§å°</strong>ã€‚ä¾‹å¦‚é™åˆ¶æœ€å¤§ä¸º200k</p>
<pre><code class="language-bash">rsync -avzhe ssh --max-size='200k' &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;
</code></pre>
<h3 id="åŒæ­¥æˆåŠŸåè‡ªåŠ¨åˆ é™¤æºæ–‡ä»¶">åŒæ­¥æˆåŠŸåè‡ªåŠ¨åˆ é™¤æºæ–‡ä»¶</h3>
<p>åˆ é™¤å‘é€æ–¹çš„æ–‡ä»¶ï¼šå¦‚æœä¸æƒ³å°†å¤‡ä»½çš„æœ¬åœ°å‰¯æœ¬ä¿ç•™åœ¨æœåŠ¡å™¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å‚æ•° â€œ <strong>&ndash;remove-source-files</strong> â€ æ¥è‡ªåŠ¨åˆ é™¤ <code>&lt;src&gt;</code> çš„æ–‡ä»¶å—ï¼Œä¸€èˆ¬ç”¨äºPushåœºæ™¯ä¸­ã€‚</p>
<pre><code class="language-bash">rsync --remove-source-files -zvh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;
</code></pre>
<h3 id="dry-run">dry run</h3>
<p>ä¸kubectlä¸€æ ·ï¼Œrsyncä¹Ÿæ”¯æŒ <code>--dry-run</code> ï¼Œè¯¥é€‰é¡¹ä¸ä¼šå¯¹æ–‡ä»¶è¿›è¡Œæ›´æ”¹ä½†ä¼šæ˜¾ç¤ºå‘½ä»¤çš„è¾“å‡ºï¼Œå¯ä»¥ä¸ <code>-v</code> å‚æ•°é…åˆï¼Œè¿™æ ·å°±å¯ä»¥çœ‹åˆ°å“ªäº›å†…å®¹ä¼šè¢«åŒæ­¥</p>
<pre><code class="language-bash">rsync --dry-run --remove-source-files -zvh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;
</code></pre>
<h3 id="é™åˆ¶ä¼ è¾“æ—¶å¸¦å®½">é™åˆ¶ä¼ è¾“æ—¶å¸¦å®½</h3>
<p>ä¼ è¾“æ—¶ï¼Œå¯ä»¥ä½¿ç”¨é€‰é¡¹ â€œ <strong>&ndash;bwlimit</strong> â€ é€‰é¡¹é™åˆ¶<strong>I/O</strong>å¸¦å®½ï¼ˆé»˜è®¤å•ä½KBï¼‰ï¼Œä¾‹å¦‚</p>
<pre><code class="language-bash">rsync --bwlimit=100 -avzhe ssh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;
</code></pre>
<h3 id="å¿½ç•¥å­˜åœ¨">å¿½ç•¥å­˜åœ¨</h3>
<p>å¦‚æœç›®æ ‡ç›®å½•ä¸­å·²ç»è¯¥æ–‡ä»¶ï¼Œåˆ™å¿½ç•¥ï¼Œä¾‹å¦‚</p>
<pre><code class="language-bash">rsync --ignore-existing -zvh &lt;local_dir&gt; &lt;system_user&gt;@&lt;host&gt;:&lt;remote_dir&gt;
</code></pre>
<h3 id="åŒæ­¥ç­–ç•¥">åŒæ­¥ç­–ç•¥</h3>
<p>é»˜è®¤rsync åªæ£€æŸ¥æ–‡ä»¶çš„å¤§å°å’Œæœ€åä¿®æ”¹æ—¥æœŸæ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–ï¼Œå°±é‡æ–°ä¼ è¾“ï¼›å‚æ•° <code>-c</code>ï¼Œ<code>--checksum</code> å¯ä»¥æ”¹å˜<code>rsync</code> çš„æ ¡éªŒæ–¹å¼ï¼Œä¼šé€šè¿‡åˆ¤æ–­æ–‡ä»¶å†…å®¹çš„æ ¡éªŒå’Œï¼Œå†³å®šæ˜¯å¦é‡æ–°ä¼ è¾“ã€‚</p>
<p>å‚æ•° <code>--size-only</code> å¯ä»¥ä½¿rsyncåªåŒæ­¥å¤§å°æœ‰å˜åŒ–çš„æ–‡ä»¶ï¼Œä¸è€ƒè™‘æ–‡ä»¶ä¿®æ”¹æ—¶é—´çš„å·®å¼‚ã€‚</p>
<h2 id="troubleshooting">troubleshooting</h2>
<pre><code>rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6]
</code></pre>
<p>é—®é¢˜åŸå› ï¼šæœåŠ¡å™¨ç«¯ç›®å½•ä¸å­˜åœ¨ã€‚</p>
<p>è§£å†³ï¼šåœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºç›®å½•å³å¯è§£å†³</p>
<p>æ—¥å¿—ï¼š<code>2017/05/07 08:02:16 [2852] rsync: chdir /data1 failed:No such file or directory (2)</code></p>
<hr>
<pre><code>rsync: failed to set times on &quot;.&quot; (in data1): Operation not permitted (1)
</code></pre>
<p>é—®é¢˜åŸå› ï¼šæœåŠ¡å™¨ç«¯æ¨¡å—ç›®å½•æƒé™ä¸å¯¹</p>
<p>è§£å†³æ–¹æ³•ï¼šå°†æœåŠ¡å™¨æ¨¡å—ç›®å½•æƒé™æ›´æ”¹ä¸ºrsyncd.confä¸­çš„uidä¸gid</p>
<p>æ—¥å¿—ï¼š<code>2017/05/07 08:07:49 [2862] rsync: mkstemp &quot;.paichu.log.yOhm5e&quot; (in data1) failed: Permission denied</code></p>
<hr>
<pre><code>rsync: failed to connect to 192.168.59.121: No route to host (113)
rsync error: error in socket IO (code 10) at clientserver.c(124) [sender=3.0.6]
</code></pre>
<p>é—®é¢˜åŸå› ï¼šé˜²ç«å¢™å¤„äºå¼€å¯çŠ¶æ€</p>
<p>è§£å†³æ–¹æ³•ï¼šå…³é—­é˜²ç«å¢™ <code>/etc/init.d/iptables stop</code></p>
<hr>
<pre><code>@ERROR: auth failed on module data1

rsync error: error starting client-server protocol (code 5) at main.c(1503) [sender=3.0.6]
</code></pre>
<p>é”™è¯¯åŸå› ï¼š</p>
<ul>
<li>é…ç½®æ–‡ä»¶è¯­æ³•é”™è¯¯</li>
<li>å¯†ç ä¸ç”¨æˆ·åé”™è¯¯</li>
<li>å¯†ç æ–‡ä»¶æƒé™è¿‡å¤§</li>
</ul>
<p>è§£å†³æ–¹æ³•ï¼šæŸ¥çœ‹æ—¥å¿—ï¼ŒæŸ¥æ‰¾å…·ä½“é—®é¢˜</p>
<p>æ—¥å¿—æ–‡ä»¶ï¼š<code>secrets file must not be other-acessible (see strict modes option)</code></p>
<hr>
<pre><code>rsync: failed to connect to 192.168.59.121: Connection refused (111)
rsync error: error in socket IO (code 10) at clientserver.c(124) [receiver=3.0.6]
</code></pre>
<p>åŸå› ï¼šrsyncæœåŠ¡æ²¡å¼€å¯</p>
<hr>
<pre><code>*** Skipping any contents from this failed directory ***

sent 485 bytes  received 14 bytes  332.67 bytes/sec
total size is 45994  speedup is 92.17
rsync error: some files/attrs were not transferred (see previous errors) (code 23) at main.c(1039) [sender=3.0.6]
</code></pre>
<p>åŸå› ï¼šæœåŠ¡å™¨åŒæ­¥ç›®å½•æƒé™ä¸å¤Ÿæˆ–æ‰€å±ç»„</p>
<p>è§£å†³ chown rsync:rsync</p>
<hr>
<p>åŸå› ï¼šç£ç›˜cacheå¯¼è‡´æ‹·è´é€Ÿåº¦é€æ¸ä¸‹é™  <sup id="keywords"><a href="#1">[1]</a></sup></p>
<p>rsyncæ‹·è´æ•°æ®è¿‡ç¨‹ä¸­å‘ç°ä¸€ä¸ªç°è±¡ï¼šå¼€å§‹æ‹·è´çš„æ—¶å€™é€Ÿåº¦å¾ˆå¿«ï¼Œæ¯ç§’æœ‰40MBå·¦å³ï¼Œä½†æ‹·è´å‡ ååˆ†é’Ÿä¹‹åå°±é™åˆ°10MBå·¦å³äº†ï¼Œä¸¤è¾¹æœºå™¨éƒ½æ²¡æœ‰è·‘ä»€ä¹ˆåº”ç”¨ï¼Œç½‘ç»œç”¨netcatæµ‹ä¹Ÿæ²¡æœ‰é—®é¢˜</p>
<p>ç„¶åæˆ‘è§‚å¯Ÿåˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯ä¸¤è¾¹çš„ <code>free</code> å‘½ä»¤éƒ½æ˜¾ç¤ºå‡ºå†…å­˜å ç”¨å¾ˆé«˜ï¼Œå¹¶ä¸”æ˜¯<code>buffered/cache</code>ä¸€æ å¾ˆé«˜ï¼Œå› ä¸ºè¿™ä¸ªç¼“å­˜æ˜¯å¯ä»¥æ‰‹å·¥é‡Šæ”¾çš„</p>
<pre><code class="language-bash">sync; echo 3 &gt; /proc/sys/vm/drop_caches
ssh root@new-repos 'sh -c &quot;sync; echo 3 &gt; /proc/sys/vm/drop_caches&quot;'
</code></pre>
<p>è¡¥å……è¯´æ˜</p>
<ul>
<li>linuxæ“ä½œç³»ç»Ÿä¼šå°†æ–‡ä»¶ç³»ç»Ÿçš„å†…å®¹ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿åé¢ç”¨åˆ°æ—¶åŠ é€Ÿï¼Œä½†åœ¨æ•°æ®è¿ç§»åœºæ™¯ä¸‹ï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰â€œåé¢ç”¨åˆ°æ—¶â€è¿™ä¸ªåœºæ™¯ï¼Œè¿™ä¸ªç¼“å­˜åè€Œç¢äº‹ï¼ˆTODO: ä¸ºä»€ä¹ˆå¯¼è‡´ç½‘ç»œioä¸‹é™ï¼‰</li>
<li>å¯¹äºæœ¬æœºå†…å¤§é‡æ‹·è´æ–‡ä»¶ï¼Œæœ‰äººæä¾›äº†ä¸€ä¸ª <a href="https://github.com/Feh/nocache" target="_blank"
   rel="noopener nofollow noreferrer" >nocacheå‘½ä»¤</a>  <a href="Debian/Ubuntu">Debian/Ubuntu </a>å·²ç»æ”¶å½•äº†è¿™ä¸ªå·¥å…·ã€‚å®ƒçš„åŠŸèƒ½æ˜¯ä¸´æ—¶ç¦ç”¨cacheï¼Œç”¨æ³•æ˜¯å°†è¦æ‰§è¡Œçš„å‘½ä»¤ç”¨ <code>nocache</code> åŒ…ä½ï¼Œæ¯”å¦‚: <code>nocache cp -a ~/ /mnt/backup/home-$(hostname)</code>ï¼Œä½†rsyncä¼šä½¿ç”¨ç½‘ç»œé€šè®¯ï¼Œæ‰€ä»¥<code>nocache rsync</code> å¯¹è¿œç«¯æ²¡æœ‰ä½œç”¨ï¼ˆ *Note however, that rsync uses sockets, so if you try a nocache rsync, only the local process will be intercepted.ï¼‰</li>
<li>ä¹Ÿæœ‰äººåœ¨å¤šå¹´ä»¥å‰ç»™rsyncæäº¤äº†ä¸€ä¸ª<a href="https://bugzilla.samba.org/show_bug.cgi?id=9560" target="_blank"
   rel="noopener nofollow noreferrer" >è¡¥ä¸</a>ï¼Œå¢åŠ äº† <code>--drop-cache</code> é€‰é¡¹ï¼Œä½†é—æ†¾çš„æ˜¯æ²¡è¢«æ¥çº³ï¼Œè¯´æ˜¯è¿‡äº linux-specificï¼Œå¼€å‘äººå‘˜çš„æ„è§ï¼ˆ<a href="https://bugzilla.samba.org/show_bug.cgi?id=9560#c3" target="_blank"
   rel="noopener nofollow noreferrer" >è§comment 3</a> ï¼‰æ˜¯æ”¹ç”¨<code>nocache</code>: <code>nocache rsync -aiv --rsync-path='nocache rsync' some-host:/src/ /dest/</code>.  P.S. nocacheå·¥å…·çš„ä¸»é¡µæœ€ååœ¨<a href="https://github.com/Feh/nocache#acknowledgements" target="_blank"
   rel="noopener nofollow noreferrer" >acknowledgementséƒ¨åˆ†</a> è¯´ï¼Œå…¶å®å®ƒæ˜¯è¡ç”Ÿè‡ªrsyncçš„è¿™ä¸ªè¡¥ä¸çš„ã€‚</li>
</ul>
<hr>
<h2 id="reference">Reference</h2>
<blockquote>
<p><sup id="1">[1]</sup> <a href="https://www.cnblogs.com/bamanzi/p/rsync-gotchas.html" target="_blank"
   rel="noopener nofollow noreferrer" >rsyncç”¨äºæ•°æ®è¿ç§»/å¤‡ä»½çš„å‡ ä¸ªç»†èŠ‚</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>ä½¿ç”¨fpmåˆ¶ä½œrpmåŒ…ä¸æ­å»ºæœ¬åœ°yumæº</title>
      <link>https://www.oomkill.com/2016/12/fpm/</link>
      <pubDate>Fri, 16 Dec 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/12/fpm/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="rpmä¸fpm">rpmä¸fpm</h2>
<h3 id="è½¯ä»¶çš„å®‰è£…æ–¹å¼">è½¯ä»¶çš„å®‰è£…æ–¹å¼</h3>
<ul>
<li><strong>ç¼–è¯‘å®‰è£…</strong>ï¼šä¼˜ç‚¹æ˜¯å¯ä»¥å®šåˆ¶åŒ–å®‰è£…ç›®å½•ã€æŒ‰éœ€å¼€å¯åŠŸèƒ½ç­‰ï¼Œç¼ºç‚¹æ˜¯éœ€è¦æŸ¥æ‰¾å¹¶å®éªŒå‡ºé€‚åˆçš„ç¼–è¯‘å‚æ•°ï¼Œè¯¸å¦‚MySQLä¹‹ç±»çš„è½¯ä»¶ç¼–è¯‘è€—æ—¶è¿‡é•¿</li>
<li><strong>yumå®‰è£…</strong>ï¼šä¼˜ç‚¹æ˜¯å…¨è‡ªåŠ¨åŒ–å®‰è£…ï¼Œä¸éœ€è¦ä¸ºä¾èµ–é—®é¢˜å‘æ„ï¼Œç¼ºç‚¹æ˜¯è‡ªä¸»æ€§å¤ªå·®ï¼Œè½¯ä»¶çš„åŠŸèƒ½ã€å­˜æ”¾ä½ç½®éƒ½å·²ç»å›ºå®šå¥½äº†ï¼Œä¸æ˜“å˜æ›´ã€‚</li>
<li><strong>ç¼–è¯‘æºç </strong>ï¼šæ ¹æ®è‡ªå·±çš„éœ€æ±‚åšæˆ RMPåŒ… ==&gt; æ­å»ºyumä»“åº“ ==&gt; yumå®‰è£…ã€‚ç»“åˆå‰ä¸¤è€…çš„ä¼˜ç‚¹ï¼Œæš‚æœªå‘ç°ä»€ä¹ˆç¼ºç‚¹ã€‚å¯èƒ½çš„ç¼ºç‚¹å°±æ˜¯RPMåŒ…çš„é€šç”¨æ€§å·®ï¼Œä¸€èˆ¬äººä¸ä¼šå®šåˆ¶RPMåŒ…ã€‚</li>
</ul>
<h3 id="rpmæ¦‚è¿°">RPMæ¦‚è¿°</h3>
<p>RPMå…¨ç§°æ˜¯Red Hat Package Manager(RedHatåŒ…ç®¡ç†å™¨)ã€‚å‡ ä¹æ‰€æœ‰çš„Linuxå‘å‹ç‰ˆæœ¬éƒ½ä½¿ç”¨è¿™ç§å½¢å¼çš„è½¯ä»¶åŒ…ç®¡ç†å®‰è£…ã€æ›´æ–°å’Œå¸è½½è½¯ä»¶ã€‚</p>
<p>rpmå‘½ä»¤æœ‰5ç§åŸºæœ¬åŠŸèƒ½ï¼ˆä¸åŒ…æ‹¬åˆ›å»ºè½¯ä»¶åŒ…ï¼‰ï¼šå®‰è£…ã€å¸è½½ã€å‡çº§ã€æŸ¥è¯¢å’ŒéªŒè¯ã€‚</p>
<p>å…³äºrpmå‘½ä»¤çš„ä½¿ç”¨å¯ä»¥ç”¨rpm &ndash;helpæ¥è·å¾—</p>
<h3 id="rpmbuild">rpmbuild</h3>
<p>rpmbuildæ˜¯reahatç³»çš„åŸå£°æ‰“åŒ…å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤çš„ä½¿ç”¨éš¾ç‚¹ä¸»è¦åœ¨äºspecæ–‡ä»¶ç¼–å†™ï¼Œä¸€ä¸ªç±»ä¼¼äºkickstartçš„ks.cfgæ–‡ä»¶ã€‚</p>
<p>ä½œä¸ºä¸€ä¸ªä½¿ç”¨å·¥å…·ï¼Œç§ç§ç¹çï¼Œåœ¨æ²¡æœ‰æ›¿ä»£å“æ—¶è¿˜èƒ½å­˜æ´»ã€‚å½“æœ‰äº†å…¶ä»–ç®€æ˜“å·¥å…·æ—¶ï¼Œä»–å°±åˆ°äº†å®Œè›‹çš„æ—¶å€™</p>
<h3 id="fpm">fpm</h3>
<p><a href="https://github.com/jordansissel/fpm" target="_blank"
   rel="noopener nofollow noreferrer" >fpm</a> æ˜¯å°†ä¸€ç§ç±»å‹çš„åŒ…è½¬æ¢æˆå¦ä¸€ç§ç±»å‹</p>
<p>æ”¯æŒçš„æºç±»å‹åŒ…</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>dir</td>
<td>å°†ç›®å½•æ‰“åŒ…æˆæ‰€éœ€è¦çš„ç±»å‹ï¼Œå¯ä»¥ç”¨äºæºç ç¼–è¯‘å®‰è£…çš„è½¯ä»¶åŒ…</td>
</tr>
<tr>
<td>rpm</td>
<td>å¯¹rpmè¿›è¡Œè½¬æ¢</td>
</tr>
<tr>
<td>gem</td>
<td>å¯¹rubygemåŒ…è¿›è¡Œè½¬æ¢</td>
</tr>
<tr>
<td>python</td>
<td>å°†pythonæ¨¡å—æ‰“åŒ…æˆç›¸å¯¹åº”çš„ç±»å‹</td>
</tr>
<tr>
<td>æ”¯æŒç›®æ ‡ç±»å‹åŒ…</td>
<td></td>
</tr>
<tr>
<td>rpm</td>
<td>è½¬æ¢ä¸ºrpmåŒ…</td>
</tr>
<tr>
<td>deb</td>
<td>è½¬æ¢ä¸ºdebåŒ…</td>
</tr>
<tr>
<td>solaris</td>
<td>è£…ç¯å«solarisåŒ…</td>
</tr>
<tr>
<td>puppet</td>
<td>è½¬æ¢ä¸ºpuppetæ¨¡å—</td>
</tr>
</tbody>
</table>
<h2 id="fpmå®‰è£…">fpmå®‰è£…</h2>
<p>fpmæ˜¯rubyå†™çš„ï¼Œå› æ­¤ç³»ç»Ÿç¯å¢ƒéœ€è¦rubyï¼Œè€Œä¸”rubyç‰ˆæœ¬å·å¤§äºbshardsè¿è¡Œçš„ç‰ˆæœ¬ã€‚</p>
<h3 id="yumå®‰è£…rubyæ¨¡å—">yumå®‰è£…rubyæ¨¡å—</h3>
<pre><code class="language-bash">yum install ruby rubygems ruby-devel -y
</code></pre>
<p>æŸ¥çœ‹rubyçš„ç‰ˆæœ¬</p>
<pre><code class="language-bash">$ rpm -qa|grep ruby
ruby-libs-1.8.7.374-4.el6_6.x86_64
rubygems-1.3.7-5.el6.noarch
ruby-1.8.7.374-4.el6_6.x86_64
ruby-rdoc-1.8.7.374-4.el6_6.x86_64
ruby-devel-1.8.7.374-4.el6_6.x86_64
ruby-irb-1.8.7.374-4.el6_6.x86_64
</code></pre>
<h3 id="æ›¿æ¢gemæº">æ›¿æ¢gemæº</h3>
<p>rubyä¸­å›½é•œåƒï¼šhttps://ruby-china.org/</p>
<pre><code class="language-bash">gem source -a http://gems.ruby-china.org
</code></pre>
<ul>
<li>-r remove xx åˆ é™¤ä¸€ä¸ªgemæºåˆ—è¡¨</li>
<li>-l list gemæºåˆ—è¡¨</li>
</ul>
<h3 id="å®‰è£…é”™è¯¯">å®‰è£…é”™è¯¯</h3>
<p>æ­¤é—®é¢˜æç¤º rubyçš„ç‰ˆæœ¬è‡³å°‘è¦æ±‚ä¸º1.9.3ï¼Œåœ¨æˆ‘ä»¬yumå®‰è£…çš„rubyä¸º1.8.7</p>
<pre><code class="language-bash">$ gem install fpm
Building native extensions.  This could take a while...
Building native extensions.  This could take a while...
ERROR:  Error installing fpm:
        ruby-xz requires Ruby version &gt;= 1.9.3.
</code></pre>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<ol>
<li>
<p>å‡çº§rubyç‰ˆæœ¬</p>
</li>
<li>
<p>å®‰è£…ä½ç‰ˆæœ¬fpm</p>
</li>
</ol>
<p><code>ERROR:  Could not find a valid gem 'fpm' (&gt;= 0) in any repository</code></p>
<p>åŸå› ï¼šgemæºå¤±æ•ˆï¼Œæ›¿æ¢gemæºå³å¯</p>
<pre><code class="language-bash">ERROR:  Could not find a valid gem 'fpm' (&gt;= 0) in any repository
</code></pre>
<h3 id="å‡çº§ruby">å‡çº§ruby</h3>
<ol>
<li>ä¸‹è½½rvm</li>
</ol>
<pre><code class="language-bash">gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
curl -sSL https://get.rvm.io | bash -s stable
# å¦‚æœä¸Šé¢çš„è¿æ¥å¤±è´¥ï¼Œå¯ä»¥å°è¯•: 
curl -L https://raw.githubusercontent.com/wayneeseguin/rvm/master/binscripts/rvm-installer | bash -s stable
</code></pre>
<p>rvmä¼šä¸‹è½½å®‰è£…åˆ°/usr/local/rvmä¸‹</p>
<ol start="2">
<li>åˆ—å‡ºå·²çŸ¥çš„rubyç‰ˆæœ¬</li>
</ol>
<pre><code class="language-bash">$ /usr/local/rvm/bin/rvm list known
# MRI Rubies
[ruby-]1.8.6[-p420]
[ruby-]1.8.7[-head]$  security released on head
[ruby-]1.9.1[-p431]
[ruby-]1.9.2[-p330]
[ruby-]1.9.3[-p551]
...
[ruby-]2.3[.3]
[ruby-]2.4[.0]
ruby-head
...
# IronRuby
ironruby[-1.1.3]
ironruby-head
</code></pre>
<ol start="3">
<li>æŒ‰ç…§æç¤ºå®‰è£…ruby1.9.3</li>
</ol>
<pre><code class="language-bash">/usr/local/rvm/bin/rvm install ruby-1.9.3
</code></pre>
<ol start="4">
<li>å°†å®‰è£…çš„rubyåˆ‡æ¢ä¸ºé»˜è®¤</li>
</ol>
<p>å¦‚æœæƒ³è®¾ç½®ä¸ºé»˜è®¤ç‰ˆæœ¬ï¼Œè¿™æ ·ä¸€æ¥ä»¥åæ–°æ‰“å¼€çš„æ§åˆ¶å°é»˜è®¤çš„ Ruby å°±æ˜¯è¿™ä¸ªç‰ˆæœ¬</p>
<p><strong>é”™è¯¯ï¼šRVM is not a function</strong></p>
<pre><code class="language-bash">$ /usr/local/rvm/bin/rvm use 1.9.3 --default
RVM is not a function, selecting rubies with 'rvm use ...' will not work.

You need to change your terminal emulator preferences to allow login shell.
Sometimes it is required to use `/bin/bash --login` as the command.
Please visit https://rvm.io/integration/gnome-terminal/ for an example.
</code></pre>
<p>åŸå› ï¼šéœ€è¦æ·»åŠ åˆ°ç³»ç»Ÿå˜é‡</p>
<pre><code class="language-bash">[[ -s &quot;$HOME/.rvm/scripts/rvm&quot; ]] &amp;&amp; . &quot;$HOME/.rvm/scripts/rvm&quot; 
source /etc/profile 
</code></pre>
<h3 id="å®‰è£…ä½ç‰ˆæœ¬fpm">å®‰è£…ä½ç‰ˆæœ¬fpm</h3>
<p>æŒ‡å®šç‰ˆæœ¬å®‰è£…</p>
<pre><code class="language-bash">gem install fpm -v 1.4
</code></pre>
<p>æŸ¥çœ‹å®‰è£…å®Œçš„fpmç‰ˆæœ¬å·</p>
<pre><code class="language-bash">$ fpm --version
1.4.0
</code></pre>
<p>å¸è½½ä¸€ä¸ªå®‰è£…ç‰ˆæœ¬</p>
<pre><code class="language-bash">rvm remove 1.9.2
</code></pre>
<p><a href="https://www.ruby-lang.org/zh_cn/downloads/" target="_blank"
   rel="noopener nofollow noreferrer" >https://www.ruby-lang.org/zh_cn/downloads/</a></p>
<p>ç¼–è¯‘å®‰è£…ruby</p>
<p>å‚è€ƒèµ„æ–™ï¼š</p>
<ul>
<li>
<p><a href="https://rubygems.org/pages/download" target="_blank"
   rel="noopener nofollow noreferrer" >Download RubyGems</a></p>
</li>
<li>
<p><a href="http://ritto.blog.51cto.com/427838/737824" target="_blank"
   rel="noopener nofollow noreferrer" >rubyçš„å‡çº§è¿‡ç¨‹</a></p>
</li>
<li>
<p><a href="https://ruby-china.org/wiki/install_ruby_guide" target="_blank"
   rel="noopener nofollow noreferrer" >å¦‚ä½•å¿«é€Ÿæ­£ç¡®çš„å®‰è£… Ruby, Rails è¿è¡Œç¯å¢ƒ</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/Ray-liang/p/5012637.html" target="_blank"
   rel="noopener nofollow noreferrer" >RVM è§£å†³ Ruby çš„ç‰ˆæœ¬é—®é¢˜ </a></p>
</li>
</ul>
<h2 id="fpmä½¿ç”¨">fpmä½¿ç”¨</h2>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-s</td>
<td>æŒ‡å®šæºç±»å‹</td>
</tr>
<tr>
<td>-t</td>
<td>æŒ‡å®šç›®æ ‡ç±»å‹ï¼Œå³æƒ³è¦åˆ¶ä½œä¸ºä»€ä¹ˆåŒ…</td>
</tr>
<tr>
<td>-n</td>
<td>æŒ‡å®šåŒ…çš„åå­—</td>
</tr>
<tr>
<td>-v</td>
<td>æŒ‡å®šåŒ…çš„ç‰ˆæœ¬å·</td>
</tr>
<tr>
<td>-C</td>
<td>æŒ‡å®šæ‰“åŒ…çš„ç›¸å¯¹è·¯å¾„</td>
</tr>
<tr>
<td>-d</td>
<td>æŒ‡å®šä¾èµ–äºå“ªäº›åŒ…</td>
</tr>
<tr>
<td>-f</td>
<td>ç¬¬äºŒæ¬¡åŒ…æ—¶ç›®å½•ä¸‹å¦‚æœæœ‰åŒåå®‰è£…åŒ…å­˜åœ¨ï¼Œåˆ™è¦†ç›–å®ƒ</td>
</tr>
<tr>
<td>-p</td>
<td>è¾“å‡ºçš„å®‰è£…åŒ…çš„ç›®å½•ï¼Œä¸æƒ³æ”¾åœ¨å½“å‰ç›®å½•ä¸‹å°±éœ€è¦æŒ‡å®š</td>
</tr>
<tr>
<td>&ndash;post-install</td>
<td>è½¯ä»¶åŒ…å®‰è£…å®Œæˆä¹‹åæ‰€è¦è¿è¡Œçš„è„šæœ¬ï¼›åŒ&ndash;offer-install</td>
</tr>
<tr>
<td>&ndash;pre-install</td>
<td>è½¯ä»¶åŒ…å®‰è£…å®Œæˆä¹‹å‰æ‰€è¦è¿è¡Œçš„è„šæœ¬ï¼›åŒ&ndash;before-install</td>
</tr>
<tr>
<td>&ndash;post-uninstall</td>
<td>è½¯ä»¶åŒ…å¸è½½å®Œæˆä¹‹åæ‰€è¦è¿è¡Œçš„è„šæœ¬ï¼›åŒ&ndash;offer-remove</td>
</tr>
<tr>
<td>&ndash;pre-uninstall</td>
<td>è½¯ä»¶åŒ…å¸è½½å®Œæˆä¹‹å‰æ‰€è¦è¿è¡Œçš„è„šæœ¬ï¼›åŒâ€”before-remove</td>
</tr>
</tbody>
</table>
<h3 id="yumå®‰è£…æ˜¯å¦‚ä½•è§£å†³ä¾èµ–é—®é¢˜çš„">yumå®‰è£…æ˜¯å¦‚ä½•è§£å†³ä¾èµ–é—®é¢˜çš„ï¼Ÿ</h3>
<p>åœ¨ä½¿ç”¨yumå®‰è£…è½¯ä»¶Aæ—¶ï¼Œyumä¼šåœ¨ä¸‹è½½å®ŒAçš„rpmåŒ…åï¼Œå¯¹è¯¥rpmåŒ…è¿›è¡Œæ£€æŸ¥ï¼ˆrpmåŒ…ä¼šç»™å‡ºå®‰è£…è¯¥rpmåŒ…æ‰€ä¾èµ–çš„åŸºç¡€åº“å’Œè½¯ä»¶ï¼‰ã€‚å¦‚æœæ£€æŸ¥å‡ºAçš„å®‰è£…è¿˜è¦ä¾èµ–è½¯ä»¶Bï¼Œé‚£ä¹ˆæ­¤æ—¶yumå°±ä¼šè‡ªåŠ¨ä¸‹è½½å¹¶å®‰è£…Bã€‚Bå®‰è£…å®Œæ¯•åï¼Œå°±ä¼šç»§ç»­å®‰è£…Aã€‚å¦‚æœæ˜¯å†…ç½‘yumæºçš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠBæ”¾åœ¨å†…ç½‘yumæºå³å¯ã€‚å¦‚æœæ£€æŸ¥å‡ºAçš„å®‰è£…ä¸éœ€è¦å…¶ä»–è½¯ä»¶çš„æ”¯æŒï¼Œé‚£ä¹ˆyumä¼šè‡ªåŠ¨å®‰è£…Aã€‚å› æ­¤ä½¿ç”¨rpm -dæ·»åŠ ä¾èµ–å…³ç³»</p>
<h3 id="æ‰“åŒ…fpm">æ‰“åŒ…fpm</h3>
<pre><code class="language-bash">fpm -s dir -t rpm -n sphinx -v 5.5.54 -d 'libaio-devel,ncurses-devel' --post-install /app/mysql.sh /app/mysql
</code></pre>
<p>ç›¸å¯¹è·¯å¾„é—®é¢˜</p>
<p>ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ‰“åŒ…ï¼Œä¼šç›´æ¥ä¿å­˜ä¸º/ç›®å½•ã€‚è¿™æ ·å°±ä¸ä¼šæ˜¯æˆ‘ä»¬æŒ‡å®šçš„ç›®å½•äº†ã€‚</p>
<pre><code class="language-bash">$ rpm -pql sphinx-1.0-1.x86_64.rpm       
/bin/indexer
/bin/indextool
/bin/searchd
...
/var/data/test1stemmed.spp
/var/data/test1stemmed.sps
/var/log
</code></pre>
<p>åˆ¶å®šä¾èµ–åŒ…</p>
<pre><code class="language-bash">fpm -d 'libaio-devel,ncurses-devel'
</code></pre>
<p>åœ¨å®‰è£…æ—¶å°±ä¼šæ£€æµ‹ä¾èµ–åŒ…ï¼Œå¦‚æ— æ­¤åŒ…å°±æŠ¥é”™</p>
<pre><code class="language-bash">$ rpm -ivh mysql-5.5.54-1.x86_64.rpm 
error: Failed dependencies:
        libaio-devel is needed by mysql-5.5.54-1.x86_64
        ncurses-devel is needed by mysql-5.5.54-1.x86_64
</code></pre>
<p>å®‰è£…å®ŒæˆåæŒ‡å®šè¦æ‰§è¡Œçš„è„šæœ¬</p>
<pre><code class="language-bash">fpm --post-install 'mysql.sh'
</code></pre>
<p>æœ¬åœ°æ¨¡æ‹Ÿyumå®‰è£…è‡ªå·±æ‰“åŒ…çš„è½¯ä»¶</p>
<pre><code class="language-bash">$ yum localinstall mysql-5.5.54-1.x86_64.rpm 
å·²åŠ è½½æ’ä»¶ï¼šfastestmirror, security
è®¾ç½®æœ¬åœ°å®‰è£…è¿›ç¨‹
è¯Šæ–­ mysql-5.5.54-1.x86_64.rpm: mysql-5.5.54-1.x86_64
mysql-5.5.54-1.x86_64.rpm å°†è¢«å®‰è£…
....
....
Non-fatal POSTIN scriptlet failure in rpm package mysql-5.5.54-1.x86_64
useradd: user 'mysql' already exists # å®‰è£…åæ‰§è¡Œè„šæœ¬ä¸­åˆ›å»ºçš„ç”¨æˆ·ï¼Œå› å·²åˆ›å»ºç”¨æˆ·ï¼Œæ•…æç¤º
warning: %post(mysql-5.5.54-1.x86_64) scriptlet failed, exit status 9

å·²å®‰è£…:
  mysql.x86_64 0:5.5.54-1                                                                                       

ä½œä¸ºä¾èµ–è¢«å®‰è£…:
libaio-devel.x86_64 0:0.3.107-10.el6   ncurses-devel.x86_64 0:5.7-4.20090207.el6                

ä½œä¸ºä¾èµ–è¢«å‡çº§:
ncurses-base.x86_64 0:5.7-4.20090207.el6  ncurses-libs.x86_64 0:5.7-4.20090207.el6
</code></pre>
<p>åˆå§‹åŒ–åå¯åŠ¨MySQLå¹¶ç™»é™†</p>
<pre><code class="language-bash">$ /etc/init.d/mysqld start
Starting MySQL.. SUCCESS! 
$ bin/mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 1
..
mysql&gt; 
</code></pre>
<h3 id="æ‰“åŒ…é”™è¯¯">æ‰“åŒ…é”™è¯¯</h3>
<p>åŸå› æœªçŸ¥</p>
<p>è§£å†³æ–¹æ³•ï¼šå¯èƒ½æ˜¯æ‰“åŒ…æ—¶ä¼šäº§ç”Ÿå¤§é‡çš„ç¼“å­˜ï¼Œå¯¼è‡´ç©ºé—´ä¸å¤Ÿï¼Œåˆ é™¤ä¸€äº›æ–‡ä»¶åé—®é¢˜å†æ²¡å‡ºç°è¿‡</p>
<pre><code class="language-bash">$ fpm -s dir -t rpm -n mysqld -v 5.5.54 -f --post-install /app/m.in.sh --post-uninstall /app/un.m.sh /app/mariadb-5.5.54/
Process failed: rpmbuild failed (exit code 1). Full command was:[&quot;rpmbuild&quot;, &quot;-bb&quot;, &quot;--define&quot;, &quot;buildroot /tmp/package-rpm-build-2570d4ce573d6b34f9153009975231fe511bee89c64018c2c7e219355d61/BUILD&quot;, &quot;--define&quot;, &quot;_topdir /tmp/package-rpm-build-2570d4ce573d6b34f9153009975231fe511bee89c64018c2c7e219355d61&quot;, &quot;--define&quot;, &quot;_sourcedir /tmp/package-rpm-build-2570d4ce573d6b34f9153009975231fe511bee89c64018c2c7e219355d61&quot;, &quot;--define&quot;, &quot;_rpmdir /tmp/package-rpm-build-2570d4ce573d6b34f9153009975231fe511bee89c64018c2c7e219355d61/RPMS&quot;, &quot;--define&quot;, &quot;_tmppath /tmp&quot;, &quot;/tmp/package-rpm-build-2570d4ce573d6b34f9153009975231fe511bee89c64018c2c7e219355d61/SPECS/mysqld.spec&quot;] {:level=&gt;:error}
</code></pre>
<h2 id="yum">YUM</h2>
<h3 id="ä»€ä¹ˆæ˜¯yum">ä»€ä¹ˆæ˜¯yum</h3>
<p>yumä¸»è¦ç”¨äºè‡ªåŠ¨å®‰è£…ã€å‡çº§rpmè½¯ä»¶åŒ…ï¼Œä»–èƒ½è‡ªåŠ¨æŸ¥æ‰¾å¹¶è§£å†³rpmåŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚è¦æˆåŠŸçš„ä½¿ç”¨yumå·¥å…·å®‰è£…æ›´æ–°è½¯ä»¶æˆ–ç³»ç»Ÿï¼Œå°±éœ€è¦æœ‰ä¸€ä¸ªåŒ…å«å„ç§rpmè½¯ä»¶åŒ…çš„repositoryï¼ˆè½¯ä»¶ä»“åº“ï¼‰ï¼Œè¿™ä¸ªè½¯ä»¶ä»“åº“æˆ‘ä»¬ä¹ æƒ¯ç§°ä¸ºyumæºï¼Œç½‘ç»œä¸Šæœ‰å¤§é‡çš„yumæºï¼Œä½†ç”±äºæ”¶åˆ°ç½‘ç»œç¯å¢ƒçš„é™åˆ¶ï¼Œå¯¼è‡´è½¯ä»¶å®‰è£…è€—æ—¶è¿‡é•¿ç”šè‡³å¤±è´¥ã€‚ç‰¹åˆ«æ˜¯å½“æœ‰å¤§é‡æœåŠ¡å™¨å¤§é‡è½¯ä»¶åŒ…éœ€è¦å®‰è£…æ—¶ï¼Œç¼“æ…¢çš„è¿›åº¦æ¡ä»¤äººéš¾ä»¥å¿å—ã€‚å› æ­¤æˆ‘ä»¬åœ¨ä¼˜åŒ–ç³»ç»Ÿæ—¶ï¼Œéƒ½ä¼šæ›´æ¢å›½å†…çš„æºã€‚</p>
<p>ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œæœ¬åœ°yumæºæœåŠ¡å™¨æœ€å¤§ä¼˜ç‚¹æ˜¯å±€åŸŸç½‘çš„å¿«é€Ÿç½‘ç»œè¿æ¥å’Œç¨³å®šæ€§ã€‚æœ‰äº†å±€åŸŸç½‘ä¸­çš„yumæºæœåŠ¡å™¨ï¼Œå³ä½¿åœ¨internetè¿æ¥ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–yumå®¢æˆ·ç«¯çš„è½¯ä»¶å®‰è£…å’Œå‡çº§</p>
<h3 id="åˆ›å»ºyumæº">åˆ›å»ºyumæº</h3>
<p>ä¸Šä¼ rpmåŒ…åˆ°æ­¤ç›®å½•ï¼Œæ­¤ç›®å½•ä¸‹é¢è¿˜å¯ä»¥åŒ…æ‹¬æ–‡ä»¶å¤¹</p>
<pre><code class="language-bash">mkdir -p /tools/yum/centos6/x86_64
</code></pre>
<p>yumä¸‹è½½çš„æ–‡ä»¶ç¼“å­˜åœ¨</p>
<pre><code class="language-bash">/var/cache/yum/x86_64/6/base/
</code></pre>
<h3 id="å®‰è£…createrepoå·¥å…·">å®‰è£…createrepoå·¥å…·</h3>
<pre><code class="language-bash">yum install -y createrepo
</code></pre>
<p>åˆå§‹åŒ–repodataç´¢å¼•æ–‡ä»¶</p>
<pre><code class="language-bash">$ createrepo -pdo /tools/yum/centos6/x86_64/ /tools/yum/centos6/x86_64/
Spawning worker 0 with 4 pkgs
Workers Finished
Gathering worker results

Saving Primary metadata
Saving file lists metadata
Saving other metadata
Generating sqlite DBs
Sqlite DBs complete

$ cd /tools/yum/centos6/x86_64/

$ ls
libaio-devel-0.3.107-10.el6.i686.rpm
libaio-devel-0.3.107-10.el6.x86_64.rpm
ncurses-devel-5.7-4.20090207.el6.i686.rpm
ncurses-devel-5.7-4.20090207.el6.x86_64.rpm
repodata

$ ls repodata/.
1453d96f9216e7c230abfe7921a2fd1dd11541568934832306342c89ad04ff1d-other.sqlite.bz2
2475630f1247fc6ac2b822541d6ad71ed83d733792c7d52de580fdebd3abda2c-filelists.sqlite.bz2
9e22eb60f06501a3f4399dc3c2d3e3858567804e7ab352679fa650b93d279fb9-other.xml.gz
c3ee9c8d8508c55c77f3f058f056bdd617587ee5a906f22bc9a512bc8b950ded-filelists.xml.gz
d9d57f7733cb42831001e915ddd51bb126b67c26bca64bf6c7e7390eed9a54d9-primary.sqlite.bz2
e9616244b93c46350e33dc04d4cb442e49ae375b7400a262bd72e8ba90a1f4a8-primary.xml.gz
repomd.xml
</code></pre>
<h3 id="æä¾›yumæœåŠ¡">æä¾›yumæœåŠ¡</h3>
<p>å¯ä»¥ç”¨apacheæˆ–nginxæä¾›webæœåŠ¡ï¼Œä½†ç”¨Pythonçš„httpæ¨¡å—æ›´ç®€å•ï¼Œé€‚ç”¨äºå†…ç½‘ç¯å¢ƒã€‚CentOS 6æœ€å°åŒ–å®‰è£…åè‡ªå¸¦pythonã€‚</p>
<ol>
<li>åˆ©ç”¨pythonçš„httpæ¨¡å—æä¾›æœåŠ¡</li>
</ol>
<pre><code class="language-bash">python -m SimpleHTTPServer 80 &amp;&gt;/dev/null
# æä¾›æœåŠ¡çš„ç›®å½•æ˜¯æ‰§è¡Œå‘½ä»¤æ—¶çš„ç›®å½•
</code></pre>
<ol start="2">
<li>åˆ©ç”¨nginxæä¾›yumæºæœåŠ¡</li>
</ol>
<pre><code class="language-bash">location / {
    root   /tools;
    index  index.html index.htm;
	autoindex on; # å½“æ‰¾ä¸åˆ°é¦–é¡µæ–‡ä»¶æ—¶ï¼Œä¼šå±•ç¤ºç›®å½•ç»“æ„ï¼Œè¿™ä¸ªåŠŸèƒ½ä¸€èˆ¬ä¸è¦ç”¨é™¤éæœ‰éœ€æ±‚ã€‚
# å¦‚æ²¡æœ‰æ­¤é€‰é¡¹ï¼Œä¼šæŠ¥403
}
</code></pre>
<h3 id="æ·»åŠ æ–°çš„rpmåŒ…">æ·»åŠ æ–°çš„rpmåŒ…</h3>
<pre><code class="language-bash"># åªä¸‹è½½è½¯ä»¶ä¸å®‰è£…
yumdownlocaler pcre-devel openssl-devel
</code></pre>
<p>æ¯å½“è¯¥ç›®å½•æ–°å¢è½¯ä»¶åŒ…éœ€è¦æ›´æ–°æº</p>
<pre><code class="language-bash">createrepo --update /tools
</code></pre>
<h3 id="æœ¬åœ°å®¢æˆ·ç«¯é…ç½®">æœ¬åœ°å®¢æˆ·ç«¯é…ç½®</h3>
<pre><code class="language-conf">/etc/yum.repos.d/test.repo
[test]
name=Server
baseurl=http://192.168.2.110
enable=1
gpgchek=0
</code></pre>
<p>ä½¿ç”¨é…ç½®çš„è‡ªå®šä¹‰çš„æºå®‰è£…PHP</p>
<pre><code class="language-bash">yum --enablerepo=test --disablerepo=base,extras,updates install php
# --enbalerepoä½¿ç”¨çš„æº
# --disablerepoç¦ç”¨æº
</code></pre>
<h3 id="yumå‘½ä»¤">yumå‘½ä»¤</h3>
<table>
<thead>
<tr>
<th>é€‰é¡¹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>install</td>
<td>å®‰è£…è½¯ä»¶åŒ… yum install httpd</td>
</tr>
<tr>
<td>list</td>
<td>åˆ—å‡ºyumä»“åº“å†…æ–‡ä»¶ yum list httpdï¼Œå¯æœç´¢å¸¦åç§°çš„ç‰¹å®šè½¯ä»¶åŒ…</td>
</tr>
<tr>
<td>search</td>
<td>ä¸æ€¥çš„è½¯ä»¶æŠ¥çš„ç¡®åˆ‡åç§°ï¼Œå¯ä»¥ä½¿ç”¨searchå‡½æ•°ï¼Œæœç´¢ä¸æŒ‡å®šè½¯ä»¶åŒ…çš„åç§°ç›¸åŒ¹é…çš„æ‰€æœ‰å¯ç”¨è½¯ä»¶åŒ…yum search httpd</td>
</tr>
<tr>
<td>provides</td>
<td>æŸ¥æ‰¾æŸä¸ªç‰¹å®šæ–‡ä»¶å±äºå“ªä¸ªè½¯ä»¶åŒ…ã€‚yum provides /app/apache/confi/http.conf</td>
</tr>
<tr>
<td>grouplist</td>
<td>åˆ—å‡ºæ‰€æœ‰å¯ç”¨ç¾¤ç»„</td>
</tr>
<tr>
<td>groupinstall</td>
<td>å®‰è£…ç¾¤ç»„è½¯ä»¶åŒ…yum groupinstall develment-tools</td>
</tr>
<tr>
<td>repolist</td>
<td>åˆ—å‡ºå¯ç”¨çš„è½¯ä»¶åº“</td>
</tr>
<tr>
<td>repolist all</td>
<td>åˆ—å‡ºæ‰€æœ‰è½¯ä»¶åº“ï¼ŒåŒ…æ‹¬ç¦ç”¨çš„ä¹Ÿåˆ—å‡º</td>
</tr>
<tr>
<td>&ndash;enablerepo</td>
<td>å®‰è£…æ¥è‡ªç‰¹å®šè½¯ä»¶åº“çš„è½¯ä»¶åŒ…</td>
</tr>
<tr>
<td>&ndash;disablerepo</td>
<td>ä¸å®‰è£…æ¥è‡ªæŒ‡å®šè½¯ä»¶åº“çš„è½¯ä»¶åŒ…yum &ndash;enablerepo=test &ndash;disablerepo=base,extras&hellip; install httpd</td>
</tr>
<tr>
<td>chean all</td>
<td>æ¸…ç†yumç¼“å­˜å†…å®¹</td>
</tr>
<tr>
<td>history</td>
<td>æŸ¥çœ‹yumå†å²è®°å½•</td>
</tr>
</tbody>
</table>
<h2 id="yumæº">yumæº</h2>
<p>Yumæºåˆ†ä¸ºä¸‰å¤§ç±»ï¼š</p>
<ul>
<li>Baseï¼šå°±æ˜¯ä½ ä¸‹è½½çš„å…‰ç›˜é•œåƒé‡Œé¢çš„DVD1</li>
<li>Extraï¼šå°±æ˜¯ä½ ä¸‹è½½å…‰ç›˜é•œåƒçš„DVD2</li>
<li>Epelï¼šå±äºé¢å¤–çš„ï¼Œå¾—åˆ°Epelå®˜æ–¹è·å–</li>
</ul>
<p>å°†å…‰ç›˜æŒ‚è½½åˆ°ç³»ç»Ÿä¸Šï¼Œä½ ä¼šå‘ç°é‡Œé¢æœ‰ä¸ªpackagesç›®å½•ï¼Œé‡Œé¢å…¨æ˜¯rpmåŒ…</p>
<pre><code class="language-bash">$ ls
CentOS_BuildTag  
images                    
...          
Packages                  
RPM-GPG-KEY-CentOS-Security-6

$ ll|wc -l
4186
</code></pre>
<h3 id="é…ç½®yumæº">é…ç½®yumæº</h3>
<p>æ‰¾ä¸€ä¸ªé•œåƒç«™ç‚¹ï¼Œå›½å†…å¸¸ç”¨é•œåƒç«™ç‚¹</p>
<ul>
<li>
<p><a href="http://mirrors.aliyun.com" target="_blank"
   rel="noopener nofollow noreferrer" >http://mirrors.aliyun.com</a></p>
</li>
<li>
<p><a href="http://mirrors.163.com" target="_blank"
   rel="noopener nofollow noreferrer" >http://mirrors.163.com</a></p>
</li>
</ul>
<p>ç³»ç»Ÿyumæºè·¯å¾„ï¼Œæ‰§è¡Œyumæ—¶ï¼Œå®ƒåªä¼šè¯»å–yum.repo.dä¸‹è¿™ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ä»¥.repoç»“å°¾çš„æ–‡ä»¶ã€‚</p>
<pre><code class="language-bash">$ ls /etc/yum.repos.d/
CentOS-Base.repo       
CentOS-fasttrack.repo  
CentOS-Vault.repo  
CentOS-Debuginfo.repo  
CentOS-Media.repo      
epel.repo
</code></pre>
<p>repoæ–‡ä»¶çš„å†™å…¥æ˜¯æœ‰å…¶ç‰¹æ®Šæ ¼å¼çš„ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-bash">[aaa]
name=aaa
baseurl=http://192.168.2.110
enable=1
gpgchek=0
[bbb]
name=bbb
baseurl=http://192.168.2.110
enable=1
gpgchek=0
[ccc]
name=ccc
baseurl=http://192.168.2.110
enable=1
gpgchek=0
</code></pre>
<p>æ‰€è°“çš„è‡ªå·±é…ç½®Yumä»“åº“å°±æ˜¯æŠŠç½‘ä¸Šé‚£äº›ç¨‹åºåŒ…å…¨ä¸‹è½½ä¸‹æ¥ï¼Œåœ¨æœ¬åœ°(å†…ç½‘)æä¾›Yumã€‚é™¤äº†epelæä¾›çš„æ‰€æœ‰åŒ…å¤–ï¼Œè¿˜æœ‰é•œåƒå…‰ç›˜DVD1,DVD2ï¼</p>
<h2 id="yumæœåŠ¡é…ç½®æ–‡ä»¶">yumæœåŠ¡é…ç½®æ–‡ä»¶</h2>
<p>é…ç½®æ–‡ä»¶åˆ†ä¸ºä¸¤éƒ¨åˆ†mainå’Œrepository</p>
<p>é…ç½®æœ¬åœ°yumæº</p>
<p>ç¦ç”¨é»˜è®¤çš„yumç½‘ç»œæºï¼Œå°†yumç½‘ç»œæºé…ç½®æ–‡ä»¶æ”¹åä¸ºCentOS-Base.repo.bakï¼Œå¦åˆ™ä¼šç°åœ¨ç½‘ç»œæºä¸­å¯»æ‰¾é€‚åˆçš„åŒ…ï¼Œæ”¹åä¹‹åç›´æ¥ä»æœ¬åœ°æºè¯»å–ã€‚ä¹Ÿå¯ä»¥å‘ä¸Šé¢ä¸€æ ·è‡ªå·±å†™ä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<h3 id="å…¨å±€é…ç½®æ–‡ä»¶">å…¨å±€é…ç½®æ–‡ä»¶</h3>
<p>mainéƒ¨åˆ†å®šä¹‰äº†å…¨å±€é…ç½®é€‰é¡¹ï¼Œæ•´ä¸ªyumé…ç½®æ–‡ä»¶åº”è¯¥åªæœ‰ä¸€ä¸ªmainï¼Œ/etc/yum.conf</p>
<pre><code class="language-conf"># /etc/yum.conf
[main]
# cachedirï¼šyumç¼“å­˜çš„ç›®å½•ï¼Œyumåœ¨æ­¤å­˜å‚¨ä¸‹è½½çš„rpmåŒ…å’Œæ•°æ®åº“ï¼Œä¸€èˆ¬æ˜¯/var/cache/yum/$basearch/$releaseverã€‚
cachedir=/var/cache/yum/$basearch/$releasever
# è®¾ç½® keepcache=1ï¼Œyum åœ¨æˆåŠŸå®‰è£…è½¯ä»¶åŒ…ä¹‹åä¿ç•™ç¼“å­˜çš„å¤´æ–‡ä»¶ (headers) å’Œè½¯ä»¶åŒ…ã€‚é»˜è®¤å€¼ä¸º keepcache=0 ä¸ä¿å­˜
keepcache=[1 or 0]
# debuglevelï¼šé™¤é”™çº§åˆ«ï¼Œ0â”€â”€10,é»˜è®¤æ˜¯2 è²Œä¼¼åªè®°å½•å®‰è£…å’Œåˆ é™¤è®°å½•
debuglevel=2
logfile=/var/log/yum.log
# pkgpolicyï¼š åŒ…çš„ç­–ç•¥ã€‚ä¸€å…±æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œnewestå’Œlastï¼Œè¿™ä¸ªä½œç”¨æ˜¯å¦‚æœä½ è®¾ç½®äº†å¤šä¸ªrepositoryï¼Œè€ŒåŒä¸€è½¯ä»¶åœ¨ä¸åŒçš„repositoryä¸­åŒæ—¶å­˜ åœ¨ï¼Œyumåº”è¯¥å®‰è£…å“ªä¸€ä¸ªï¼Œå¦‚æœæ˜¯newestï¼Œåˆ™yumä¼šå®‰è£…æœ€æ–°çš„é‚£ä¸ªç‰ˆæœ¬ã€‚å¦‚æœæ˜¯lastï¼Œåˆ™yumä¼šå°†æœåŠ¡å™¨idä»¥å­—æ¯è¡¨æ’åºï¼Œå¹¶é€‰æ‹©æœ€åçš„é‚£ä¸ª æœåŠ¡å™¨ä¸Šçš„è½¯ä»¶å®‰è£…ã€‚ä¸€èˆ¬éƒ½æ˜¯é€‰newestã€‚
pkgpolicy=newest
# æŒ‡å®šä¸€ä¸ªè½¯ä»¶åŒ…ï¼Œyumä¼šæ ¹æ®è¿™ä¸ªåŒ…åˆ¤æ–­ä½ çš„å‘è¡Œç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯RedHat-releaseï¼Œä¹Ÿå¯ä»¥æ˜¯å®‰è£…çš„ä»»ä½•é’ˆå¯¹è‡ªå·±å‘è¡Œç‰ˆçš„rpmåŒ…
distroverpkg=CentOS-release
# tolerentï¼Œä¹Ÿæœ‰1å’Œ0ä¸¤ä¸ªé€‰é¡¹ï¼Œè¡¨ç¤ºyumæ˜¯å¦å®¹å¿å‘½ä»¤è¡Œå‘ç”Ÿä¸è½¯ä»¶åŒ…æœ‰å…³çš„é”™è¯¯ï¼Œæ¯”å¦‚ä½ è¦å®‰è£…1,2,3ä¸‰ä¸ªåŒ…ï¼Œè€Œå…¶ä¸­3æ­¤å‰å·²ç»å®‰è£…äº†ï¼Œå¦‚æœä½ è®¾ä¸º1,åˆ™yumä¸ä¼šå‡ºç°é”™è¯¯ä¿¡æ¯ã€‚é»˜è®¤æ˜¯0ã€‚
tolerant=1
# exactarchï¼Œæœ‰ä¸¤ä¸ªé€‰é¡¹1å’Œ0,ä»£è¡¨æ˜¯å¦åªå‡çº§å’Œä½ å®‰è£…è½¯ä»¶åŒ…cpuä½“ç³»ä¸€è‡´çš„åŒ…ï¼Œå¦‚æœè®¾ä¸º1ï¼Œåˆ™å¦‚ä½ å®‰è£…äº†ä¸€ä¸ªi386çš„rpmï¼Œåˆ™yumä¸ä¼šç”¨1686çš„åŒ…æ¥å‡çº§ã€‚
exactarch=1
# retriesï¼Œç½‘ç»œè¿æ¥å‘ç”Ÿé”™è¯¯åçš„é‡è¯•æ¬¡æ•°ï¼Œå¦‚æœè®¾ä¸º0ï¼Œåˆ™ä¼šæ— é™é‡è¯•ã€‚
retries=20
obsoletes=1
# gpgchkeck= æœ‰1å’Œ0ä¸¤ä¸ªé€‰æ‹©ï¼Œåˆ†åˆ«ä»£è¡¨æ˜¯å¦æ˜¯å¦è¿›è¡Œgpgæ ¡éªŒï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸€é¡¹ï¼Œé»˜è®¤æ˜¯æ£€æŸ¥çš„ã€‚
gpgcheck=1
# è¯¥é€‰é¡¹ç”¨æˆ·æŒ‡å®š .repo æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚.repo æ–‡ä»¶åŒ…å«è½¯ä»¶ä»“åº“çš„ä¿¡æ¯ (ä½œç”¨ä¸ /etc/yum.conf æ–‡ä»¶ä¸­çš„ [repository] ç‰‡æ®µç›¸åŒ)ã€‚
reposdir=[åŒ…å« .repo æ–‡ä»¶çš„ç›®å½•çš„ç»å¯¹è·¯å¾„] # é»˜è®¤æ˜¯ /etc/yum.repos.d/ ä½ä¸‹çš„ xx.repoåç¼€æ–‡ä»¶
# exclude æ’é™¤æŸäº›è½¯ä»¶åœ¨å‡çº§åå•ä¹‹å¤–ï¼Œå¯ä»¥ç”¨é€šé…ç¬¦ï¼Œåˆ—è¡¨ä¸­å„ä¸ªé¡¹ç›®è¦ç”¨ç©ºæ ¼éš”å¼€ï¼Œè¿™ä¸ªå¯¹äºå®‰è£…äº†è¯¸å¦‚ç¾åŒ–åŒ…ï¼Œä¸­æ–‡è¡¥ä¸çš„æœ‹å‹ç‰¹åˆ«æœ‰ç”¨ã€‚
exclude=xxx
</code></pre>
<h3 id="ç¬¬äºŒéƒ¨åˆ†repoitory">ç¬¬äºŒéƒ¨åˆ†repoitory</h3>
<p>repoitoryéƒ¨åˆ†å®šä¹‰äº†æ¯ä¸ªæº/æœåŠ¡å™¨çš„å…·ä½“é…ç½®ï¼Œå¯ä»¥æœ‰ä¸€åˆ°å¤šä¸ªï¼Œä½äº/etc/yum.repos.d/ç›®å½•ä¸‹çš„å„æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå­—æ®µå…¶å®ä¹Ÿå¯ä»¥åœ¨yum.confé‡Œé¢ç›´æ¥é…ç½®</p>
<p>repoæ–‡ä»¶çš„æ ¼å¼</p>
<pre><code class="language-bash"># serveridç”¨äºåŒºåˆ«å„ä¸ªä¸åŒçš„repositoryï¼Œå¿…é¡»æœ‰ä¸€ä¸ªç‹¬ä¸€æ— äºŒçš„åç§°ã€‚ é‡å¤äº†å‰é¢è¦†ç›–åé¢--è¿˜æ˜¯åè¿‡æ¥å‘¢ï¼Ÿï¼Ÿï¼Ÿç”¨enabled æµ‹è¯•æ˜¯åé¢è¦†ç›–å‰é¢
[serverid]
# nameæ˜¯å¯¹repositoryçš„æè¿°ï¼Œæ”¯æŒåƒ$releasever $basearchè¿™æ ·çš„å˜é‡; name=Fedora Core $releasever - $basearch - Released Updates
name=Some name for this server
# baseurlæ˜¯æœåŠ¡å™¨è®¾ç½®ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œåªæœ‰è®¾ç½®æ­£ç¡®ï¼Œæ‰èƒ½ä»ä¸Šé¢è·å–è½¯ä»¶ã€‚å®ƒçš„æ ¼å¼æ˜¯ï¼š
# å…¶ä¸­urlæ”¯æŒçš„åè®®æœ‰ http:// ftp:// file://ä¸‰ç§ã€‚baseurlåå¯ä»¥è·Ÿå¤šä¸ªurlï¼Œä½ å¯ä»¥è‡ªå·±æ”¹ä¸ºé€Ÿåº¦æ¯”è¾ƒå¿«çš„é•œåƒç«™ï¼Œä½†baseurlåªèƒ½æœ‰ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½åƒå¦‚ä¸‹æ ¼å¼ï¼š
baseurl=url://server1/path/to/repository/
baseurl=url://server2/path/to/repository/
baseurl=url://server3/path/to/repository/
å…¶ä¸­urlæŒ‡å‘çš„ç›®å½•å¿…é¡»æ˜¯è¿™ä¸ªrepository headerç›®å½•çš„ä¸Šä¸€çº§ï¼Œå®ƒä¹Ÿæ”¯æŒ$releasever $basearchè¿™æ ·çš„å˜é‡ã€‚
baseurl=url://path/to/repository/
baseurl=url://server1/path/to/repository/
url://server2/path/to/repository/
url://server3/path/to/repository/
# è¿™ä¸€è¡Œæ˜¯æŒ‡å®šä¸€ä¸ªé•œåƒæœåŠ¡å™¨çš„åœ°å€åˆ—è¡¨ï¼Œé€šå¸¸æ˜¯å¼€å¯çš„ï¼Œæœ¬ä¾‹ä¸­åŠ äº†æ³¨é‡Šç¬¦å·ç¦ç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥è¯•è¯•ï¼Œå°†$releaseverå’Œ$basearchæ›¿æ¢æˆè‡ªå·±å¯¹åº”çš„ç‰ˆæœ¬å’Œæ¶æ„ï¼Œä¾‹å¦‚10å’Œi386ï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°ä¸€é•¿ä¸²é•œå¯ç”¨çš„é•œåƒæœåŠ¡å™¨åœ°å€åˆ—è¡¨ã€‚
mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=fedora-$releasever&amp;arch=$basearch
urlä¹‹åå¯ä»¥åŠ ä¸Šå¤šä¸ªé€‰é¡¹ï¼Œå¦‚gpgcheckã€excludeã€failovermethodç­‰ï¼Œæ¯”å¦‚ï¼š
# å…¶ä¸­gpgcheckï¼Œexcludeçš„å«ä¹‰å’Œ[main]éƒ¨åˆ†ç›¸åŒï¼Œä½†åªå¯¹æ­¤æœåŠ¡å™¨èµ·ä½œç”¨
gpgcheck=1
exclude=gaim
# failovermethode æœ‰ä¸¤ä¸ªé€‰é¡¹roundrobinå’Œpriorityï¼Œæ„æ€åˆ†åˆ«æ˜¯æœ‰å¤šä¸ªurlå¯ä¾›é€‰æ‹©æ—¶ï¼Œyumé€‰æ‹©çš„æ¬¡åºï¼Œroundrobinæ˜¯éšæœºé€‰æ‹©ï¼Œå¦‚æœè¿æ¥å¤± è´¥åˆ™ä½¿ç”¨ä¸‹ä¸€ä¸ªï¼Œä¾æ¬¡å¾ªç¯ï¼Œpriorityåˆ™æ ¹æ®urlçš„æ¬¡åºä»ç¬¬ä¸€ä¸ªå¼€å§‹ã€‚å¦‚æœä¸æŒ‡æ˜ï¼Œé»˜è®¤æ˜¯roundrobinã€‚
failovermethod=priority
# å½“æŸä¸ªè½¯ä»¶ä»“åº“è¢«é…ç½®æˆ enabled=0 æ—¶ï¼Œyum åœ¨å®‰è£…æˆ–å‡çº§è½¯ä»¶åŒ…æ—¶ä¸ä¼šå°†è¯¥ä»“åº“åšä¸ºè½¯ä»¶åŒ…æä¾›æºã€‚ä½¿ç”¨è¿™ä¸ªé€‰é¡¹ï¼Œå¯ä»¥å¯ç”¨æˆ–ç¦ç”¨è½¯ä»¶ä»“åº“ã€‚
# é€šè¿‡ yum çš„ --enablerepo=[repo_name] å’Œ --disablerepo=[repo_name] é€‰é¡¹ï¼Œæˆ–è€…é€šè¿‡ PackageKit çš„&quot;æ·»åŠ /åˆ é™¤è½¯ä»¶&quot;å·¥å…·ï¼Œä¹Ÿèƒ½å¤Ÿæ–¹ä¾¿åœ°å¯ç”¨å’Œç¦ç”¨æŒ‡å®šçš„è½¯ä»¶ä»“åº“
enabled=[1 or 0]
</code></pre>
<p>å˜é‡</p>
<pre><code class="language-conf">$releaseverï¼Œå‘è¡Œç‰ˆçš„ç‰ˆæœ¬ï¼Œä»[main]éƒ¨åˆ†çš„distroverpkgè·å–ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ ¹æ®redhat-releaseåŒ…è¿›è¡Œåˆ¤æ–­ã€‚
$archï¼Œcpuä½“ç³»ï¼Œå¦‚i686,athlonç­‰
$basearchï¼Œcpuçš„åŸºæœ¬ä½“ç³»ç»„ï¼Œå¦‚i686å’ŒathlonåŒå±i386ï¼Œalphaå’Œalphaev6åŒå±alphaã€‚
</code></pre>
]]></content:encoded>
    </item>
    
    <item>
      <title>ch1 iptablesä»‹ç»</title>
      <link>https://www.oomkill.com/2016/10/ch1-iptables-introduction/</link>
      <pubDate>Sat, 22 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/10/ch1-iptables-introduction/</guid>
      <description></description>
      <content:encoded><![CDATA[<h3 id="1-é˜²ç«å¢™å®æˆ˜">1 é˜²ç«å¢™å®æˆ˜</h3>
<p><strong>å…³é—­ä¸¤é¡¹åŠŸèƒ½</strong>ï¼š</p>
<ol>
<li>selinuxï¼ˆç”Ÿäº§ä¸­ä¹Ÿæ˜¯å…³é—­çš„ï¼‰ï¼Œidså…¥ä¾µæ£€æµ‹ï¼ŒMD5æŒ‡çº¹å°†ã€‚ç³»ç»Ÿæ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶å…¨éƒ¨åšæŒ‡çº¹è¯†åˆ«ï¼Œå°†æŒ‡çº¹ç•™ä¸‹ï¼Œå°†æ¥å‡ºé—®é¢˜ï¼Œä¸€çœ‹å°±çŸ¥é“é‚£ä¸ªæ–‡ä»¶è¢«æ”¹è¿‡ã€‚</li>
<li>Â iptablesï¼ˆç”Ÿäº§ä¸­çœ‹æƒ…å†µï¼Œå†…ç½‘å…³é—­ï¼Œå¤–ç½‘æ‰“å¼€ï¼‰ï¼Œå¤§å¹¶å‘çš„æƒ…å†µï¼Œä¸èƒ½å¼€iptablesï¼Œå½±å“æ€§èƒ½ã€‚
ä½¿ç”¨é˜²ç«å¢™å°±ä¸å¦‚ä¸ä½¿ç”¨é˜²ç«å¢™ï¼Œä¸ä½¿ç”¨é˜²ç«å¢™çš„å‰ææ˜¯ä¸ç»™å¤–ç½‘ipï¼Œå·¥ä½œä¸­è¦å°‘ç»™å¤–ç½‘æœåŠ¡å™¨ipï¼Œè¿™æ ·é˜²ç«å¢™ä½¿ç”¨ç‡è¾ƒä½ï¼Œé˜²ç«å¢™ä½¿ç”¨ä¹Ÿå¾ˆæ¶ˆè€—èµ„æº</li>
</ol>
<p><strong>å®‰å…¨ä¼˜åŒ–</strong>ï¼š</p>
<ol>
<li>å°½å¯èƒ½ä¸ç»™æœåŠ¡å™¨é…ç½®å¤–ç½‘IPã€‚å¯ä»¥é€šè¿‡ä»£ç†è½¬å‘æˆ–è€…é€šè¿‡é˜²ç«å¢™æ˜ å°„ã€‚</li>
<li>å¹¶å‘ä¸æ˜¯ç‰¹åˆ«å¤§æƒ…å†µå†å¤–ç½‘IPçš„ç¯å¢ƒï¼Œè¦å¼€å¯iptablesé˜²ç«å¢™</li>
</ol>
<p><a href="http://edu.51cto.com/course/course_id-772.html" target="_blank"
   rel="noopener nofollow noreferrer" >http://edu.51cto.com/course/course_id-772.html</a></p>
<p><strong>å­¦å¥½iptablesåŸºç¡€</strong>ï¼š</p>
<ol>
<li>Â OSI7å±‚æ¨¡å‹ä»¥åŠä¸åŒå±‚å¯¹åº”é‚£äº›åè®®ï¼Ÿ</li>
<li>Â TCP/IPä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æ–­å¼€çš„è¿‡ç¨‹ï¼ŒTCP HEADERã€‚</li>
<li>Â å¸¸ç”¨çš„æœåŠ¡ç«¯å£è¦äº†å¦‚æŒ‡æŒã€‚</li>
</ol>
<h4 id="11-iptablesé˜²ç«å¢™ç®€ä»‹">1.1 iptablesé˜²ç«å¢™ç®€ä»‹</h4>
<p>Netfilter/iptables(ä»¥ä¸‹ç®€ç§°iptables)æ˜¯unix/linuxè‡ªå¸¦çš„ä¸€æ¬¾ä¼˜ç§€ä¸”å¼€æ”¾æºä»£ç çš„å®Œå…¨è‡ªç”±çš„åŸºäºåŒ…è¿‡æ»¤çš„é˜²ç«å¢™å·¥å…·ï¼Œå®ƒçš„åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œä½¿ç”¨éå¸¸çµæ´»ï¼Œå¯ä»¥å¯¹æµå…¥å’Œæµå‡ºçš„æœåŠ¡å™¨æ•°æ®åŒ…è¿›è¡Œå¾ˆç²¾ç»†çš„æ§åˆ¶ã€‚ç‰¹åˆ«æ˜¯ä»–å¯ä»¥åœ¨ä¸€å°éå¸¸ä½çš„ç¡¬ä»¶é…ç½®ä¸‹è·‘çš„éå¸¸å¥½ï¼ˆèµ›æ‰¬500MHZ 64Må†…å­˜çš„æƒ…å†µéƒ¨ç½²ç½‘å…³é˜²ç«å¢™ï¼‰æä¾›400äººçš„ä¸Šç½‘æœåŠ¡å››å·==ä¸é€Šè‰²ä¼ä¸šçº§ä¸“ä¸šè·¯ç”±å™¨é˜²ç«å¢™==ã€‚iptables+zebra+squid</p>
<p>iptablesæ˜¯linux2.4åŠ2.6å†…æ ¸ä¸­é›†æˆçš„æœåŠ¡ã€‚å…¶åŠŸèƒ½ä¸å®‰å…¨æ€§æ¯”å…¶è€ä¸€è¾ˆipwadin ipchainså¼ºå¤§çš„å¤šï¼ˆé•¿æ±Ÿæ°´åæµªæ¨å‰æµªï¼‰ï¼Œiptablesä¸»è¦å·¥ä½œåœ¨OSIä¸ƒå±‚çš„äºŒã€ä¸‰ã€å››å±‚ï¼Œå¦‚æœé‡æ–°ç¼–è¯‘å†…æ ¸ï¼Œiptablesä¹Ÿå¯ä»¥æ”¯æŒ7å±‚æ§åˆ¶ï¼ˆsquidä»£ç†+iptablesï¼‰ã€‚</p>
<h4 id="12-iptablesåè¯å’Œæœ¯è¯­">1.2 iptablesåè¯å’Œæœ¯è¯­</h4>
<p>å®¹å™¨ï¼šåŒ…å«æˆ–è€…è¯´å±äºå…³ç³»</p>
<p><strong>ä»€ä¹ˆæ˜¯å®¹å™¨ï¼Ÿ</strong></p>
<p>â€‹	åœ¨iptablesé‡Œï¼Œå°±æ˜¯ç”¨è€æè¿°è¿™ç§åŒ…å«æˆ–è€…è¯´å±äºçš„å…³ç³»</p>
<p><strong>ä»€ä¹ˆæ˜¯Netfilter/iptables?</strong></p>
<p>â€‹	Netfilteræ˜¯è¡¨ï¼ˆtablesï¼‰çš„å®¹å™¨</p>
<p><strong>ä»€ä¹ˆæ˜¯è¡¨ï¼ˆtablesï¼‰ï¼Ÿ</strong></p>
<p>â€‹	è¡¨æ˜¯é“¾çš„å®¹å™¨ï¼Œæ‰€æœ‰çš„é“¾ï¼ˆchainsï¼‰éƒ½å±äºå…¶å¯¹åº”çš„è¡¨ã€‚</p>
<p><strong>ä»€ä¹ˆæ˜¯é“¾ï¼ˆchainsï¼‰ï¼Ÿ</strong></p>
<p>â€‹	é“¾ï¼ˆchainsï¼‰æ˜¯è§„åˆ™çš„å®¹å™¨</p>
<p><strong>ä»€ä¹ˆæ˜¯è§„åˆ™ï¼ˆpolicyï¼‰</strong></p>
<p>â€‹	iptablesä¸€ç³»åˆ—è¿‡æ»¤ä¿¡æ¯çš„è§„èŒƒå’Œå…·ä½“æ–¹æ³•æ¡æ¬¾</p>
<center><b>iptablesæŠ½è±¡å’Œå®é™…æ¯”å–»å¯¹æ¯”è¡¨</b></center>
| Netfilter | tables     | chains       | policy               |
| --------- | ---------- | ------------ | -------------------- |
| ä¸€æ ‹æ¥¼    | æ¥¼é‡Œçš„æˆ¿å­ | æˆ¿å­é‡Œçš„æŸœå­ | æŸœå­é‡Œè¡£æœçš„æ‘†æ”¾è§„åˆ™ |
<h4 id="13-iptableså·¥ä½œæµç¨‹">1.3 iptableså·¥ä½œæµç¨‹</h4>
<p>iptablesæ˜¯é‡‡ç”¨æ•°æ®åŒ…è¿‡æ»¤æœºåˆ¶å·¥ä½œçš„ï¼Œæ‰€ä»¥ä»–ä¼šå¯¹è¯·æ±‚çš„æ•°æ®åŒ…åŒ…å¤´æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶æ ¹æ®æˆ‘ä»¬é¢„å…ˆè®¾å®šçš„è§„åˆ™è¿›è¡ŒåŒ¹é…æ¥å†³å®šæ˜¯å¦å¯ä»¥è¿›å…¥ä¸»æœºã€‚</p>
<p>æ•°æ®åŒ…çš„æµå‘æ˜¯ä»å·¦å‘å³çš„!</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20200728221029808.png" alt="image-20200728221029808" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><strong>iptableså·¥ä½œå°ç»“</strong>ï¼š</p>
<pre><code>é˜²ç«å¢™æ˜¯ä¸€å±‚å±‚è¿‡æ»¤çš„ã€‚å®é™…æ˜¯æŒ‰ç…§é…ç½®è§„åˆ™çš„é¡ºåºä»ä¸Šåˆ°ä¸‹ï¼Œä»å‰åˆ°åè¿›è¡Œè¿‡æ»¤çš„ã€‚
å¦‚æœåŒ¹é…ä¸Šè§„åˆ™ï¼Œå³æ˜ç¡®è¡¨æ˜æ˜¯é˜»æ­¢è¿˜æ˜¯é€šè¿‡ï¼Œæ­¤æ—¶æ•°æ®åŒ…å°±ä¸åœ¨å‘ä¸‹åŒ¹é…æ–°è§„åˆ™äº†ã€‚
å¦‚æœæ‰€æœ‰è§„åˆ™ä¸­æ²¡æœ‰æ˜ç¡®è¡¨æ˜æ˜¯é˜»æ­¢è¿˜æ˜¯é€šè¿‡è¿™ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰åŒ¹é…ä¸Šè§„åˆ™ï¼Œå‘ä¸‹è¿›è¡ŒåŒ¹é…ï¼ŒçŸ¥é“åŒ¹é…é»˜è®¤è§„åˆ™å¾—åˆ°æ˜ç¡®çš„é˜»æ­¢è¿˜æ˜¯é€šè¿‡ã€‚
é˜²ç«å¢™çš„é»˜è®¤è§„åˆ™æ˜¯å¯¹åº”é“¾çš„æ‰€æœ‰çš„è§„åˆ™æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œçš„ã€‚
</code></pre>
<hr>
<p><strong>æç¤º</strong>ï¼š</p>
<p>iptablesé˜²ç«å¢™è§„åˆ™çš„æ‰§è¡Œé¡ºåºé»˜è®¤ä»å‰åˆ°åï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰ä¾æ¬¡æ‰§è¡Œï¼Œé‡åˆ°åŒ¹é…çš„è§„åˆ™å°±ä¸åœ¨ç»§ç»­å‘ä¸‹æ£€æŸ¥ï¼Œåªæœ‰é‡åˆ°ä¸åŒ¹é…çš„è§„åˆ™æ‰ä¼šç»§ç»­å‘ä¸‹è¿›è¡ŒåŒ¹é…ã€‚</p>
<hr>
<p>é‡ç‚¹ï¼š<font color="#f8070d" size=2>åŒ¹é…ä¸Šäº†æ‹’ç»è§„åˆ™ä¹Ÿæ˜¯åŒ¹é…</font>ï¼Œè¿™ç‚¹è¦å¤šæ³¨æ„ã€‚</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --dport 3306 -j DROP
iptables -A INPUT -p tcp --dport 3306 -j ACCEPT

$ iptables -nL
Chain INPUT (policy ACCEPT) 
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:3306 
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:3306 

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
REJECT     all  --  0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited 

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination   
</code></pre>
<p>æ­¤æ—¶ ``telnet10.0.0.148 3306<code>æ˜¯ä¸é€šçš„ï¼ŒåŸå› å°±æ˜¯telnetè¯·æ±‚å·²åŒ¹é…ä¸Šäº†æ‹’ç»è§„åˆ™</code>iptables -A INPUT -p tcp &ndash;dport 3306 -j DROP<code>,å› æ­¤ï¼Œä¸ä¼šåœ¨æ‰¾ä¸‹é¢çš„è§„åˆ™åŒ¹é…äº†ã€‚å¦‚æœå¸Œæœ›</code>telnet 10.0.0.148 3306 <code>è¿é€šï¼Œå¯ä»¥å§ACCEPTè§„åˆ™ä¸­çš„-Aæ”¹ä¸º-Iï¼Œå³ </code>iptables -I INPUT -p tcp &ndash;dport 3306 -j ACCEPT` æŠŠå…è®¸è§„åˆ™æ”¾äºINPUTé“¾ç¬¬ä¸€è¡Œç”Ÿæ•ˆ</p>
<p>==é»˜è®¤è§„åˆ™æ˜¯æ‰€æœ‰çš„è§„åˆ™æ‰§è¡Œå®Œæ‰ä¼šæ‰§è¡Œçš„==ã€‚</p>
<h4 id="14--iptablesè¡¨tableså’Œé“¾chains">1.4  iptablesè¡¨ï¼ˆtablesï¼‰å’Œé“¾ï¼ˆchainsï¼‰</h4>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œiptablesæ ¹æ®åŠŸèƒ½å’Œè¡¨çš„å®šä¹‰åˆ’åˆ†åŒ…å«ä¸‰ä¸ªè¡¨ï¼Œfilter nat mangleï¼Œå…¶æ¯ä¸ªè¡¨æœ‰åŒ…å«ä¸åŒçš„æ“ä½œé“¾ï¼ˆchainsï¼‰ã€‚</p>
<p><strong>ä¸‹é¢çš„è¡¨æ ¼å±•ç¤ºäº†è¡¨å’Œé“¾çš„å¯¹åº”å…³ç³»</strong></p>
<div style="text-align:center">
<table>
       <tr   >
        <td style="text-align:center; " rowspan="2" bgcolor='#aaa9a9'><strong>è¡¨</strong></td>
        <td  style="text-align:center; " colspan="5" bgcolor='#aaa9a9' ><strong>é“¾ï¼ˆchainsï¼‰</strong></td>
    </tr>
     <tr>
        <td height="30px" width="100px">INPUT</td>
       <td height="30px" width="130px">FORWARD</td>
       <td height="30px" width="130px">OUTPUT</td>
       <td height="30px" width="130px">PREROUTING</td>
       <td height="30px" width="130px">POSTROUTING</td>
    </tr>
    <tr>
      <td height="30px" width="80px">Filter</td>
      <td height="30px" width="50px" style="background:#2E8B57"></td>
      <td height="30px" width="50px" style="background:#2E8B57"></td>
      <td height="30px" width="50px" style="background:#2E8B57"></td>
      <td height="30px" width="50px" style="background:#A9A9A9"></td>
      <td height="30px" width="50px" style="background:#A9A9A9"></td>
  </tr>
    <tr>
      <td height="30px" width="50px">NAT</td>
      <td height="30px" width="50px" style="background:#A9A9A9" ></td>
      <td height="30px" width="50px" style="background:#A9A9A9" ></td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
    </tr>
      <tr>
       <td height="30px" width="50px">Mangle</td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
      <td height="30px" width="50px" style="background:#2E8B57" ></td>
    </tr>
      <tr>
       <td height="30px" width="30px" colspan="6" >æ³¨ï¼šç»¿è‰²è¡¨ç¤ºæœ‰ï¼Œ ç°è‰²è¡¨ç¤ºæ— </td>
    </tr>
</table>  
</div>  
**æç¤ºï¼šæ‰€æœ‰é“¾åè¦å¤§å†™**
<table align='center' style="border:1px solid #fff;">
   <tr  align='center' style="border:1px solid #fff;" >
       <td height="50px" width="100px" style="text-align:center;" ><strong>è¡¨å</strong></td>
        <td  style="text-align:center; "><strong>ä½œç”¨</strong></td>
    </tr>
     <tr>
       <tr  >
        <td style="text-align:center; ">filter</td>
        <td  >å¼ºè°ƒä¸»è¦å’Œä¸»æœºè‡ªèº«æœ‰å…³ï¼ŒçœŸæ­£è´Ÿè´£ä¸»æœºé˜²ç«å¢™åŠŸèƒ½çš„ï¼ˆè¿‡æ»¤æµå…¥æµå‡ºä¸»æœºçš„æ•°æ®åŒ…ï¼‰ã€‚filterè¡¨æ˜¯iptablesé»˜è®¤ä½¿ç”¨çš„è¡¨ã€‚è¿™ä¸ªè¡¨å®šä¹‰äº†ä¸‰ä¸ªé“¾ï¼ˆchainsï¼‰ã€‚<strong>ä¼ä¸šå·¥ä½œåœºæ™¯ï¼šä¸»æœºé˜²ç«å¢™ã€‚</strong></td>
    </tr>
     <tr>
        <td height="50px" width="50px" style="text-align:center; " >nat</td>
       <td  height="50px">è´Ÿè´£ç½‘ç»œåœ°å€è½¬æ¢ï¼Œå³æ¥æºä¸ç›®çš„IPåœ°å€å’Œportçš„è½¬æ¢ã€‚åº”ç”¨ï¼šå’Œä¸»æœºæœ¬èº«æ— å…³ã€‚<strong>ä¸€èˆ¬ç”¨äºå±€åŸŸç½‘å…±äº«ä¸Šç½‘æˆ–è€…ç‰¹æ®Šçš„ç«¯å£è½¬æ¢æœåŠ¡ç›¸å…³ã€‚</strong><br><br>
NATåŠŸèƒ½ä¸€èˆ¬ä¼ä¸šå·¥ä½œåœºæ™¯<br>
1. ç”¨äºåšä¼ä¸šè·¯ç”±ï¼ˆzebraï¼‰æˆ–ç½‘å…³ï¼ˆiptablesï¼‰ï¼Œå…±äº«ä¸Šç½‘ï¼ˆPOSTROUTINGï¼‰<br>
2. åšå†…éƒ¨å¤–éƒ¨IPåœ°å€ä¸€å¯¹ä¸€æ˜ å°„ï¼ˆdmzï¼‰ï¼Œç¡¬ä»¶é˜²ç«å¢™æ˜ å°„IPåˆ°å†…éƒ¨æœåŠ¡å™¨ï¼ŒftpæœåŠ¡ï¼Œï¼ˆPREROUTINGï¼‰<br>
3. webï¼Œå•ä¸ªç«¯å£çš„æ˜ å°„ï¼Œç›´æ¥æ˜ å°„80ç«¯å£ï¼ˆPREROUTINGï¼‰ã€‚è¿™ä¸ªè¡¨ç¤ºå®šä¹‰äº†ä¸‰ä¸ªé“¾ï¼ˆchainsï¼‰ï¼ŒnatåŠŸèƒ½å°±ç›¸å½“äºç½‘ç»œçš„aclæ§åˆ¶ã€‚å’Œç½‘ç»œäº¤æ¢æœºaclç±»ä¼¼ã€‚</td>
    </tr>
    <tr>
        <td height="50px" width="50px" style="text-align:center; ">Mangle</td>
       <td  height="50px">ä¸»è¦è´Ÿè´£ä¿®æ”¹æ•°æ®åŒ…ä¸­ç‰¹æ®Šçš„è·¯ç”±æ ‡è®°ï¼Œå¦‚TTLï¼ŒTOSï¼ŒNARKç­‰ã€‚è¿™ä¸ªè¡¨å®šä¹‰äº†5ä¸ªé“¾</td>
    </tr>
</table>  
<table align='center' style="border:1px solid #fff;">
   <tr  align='center' style="border:1px solid #fff;" >
       <td height="50px" width="150px" style="text-align:center; " ><strong>é“¾å</strong></td>
        <td  style="text-align:center; "><strong>ä½œç”¨</strong></td>
    </tr>
     <tr>
       <tr  >
        <td style="text-align:center; " height="50px" width="50px" >INPUT</td>
        <td  >è´Ÿè´£è¿‡æ»¤æ‰€æœ‰ç›®æ ‡åœ°å€æ˜¯æœ¬æœºåœ°å€çš„æ•°æ®åŒ…ã€‚é€šä¿—çš„è®²ï¼Œå°±æ˜¯è¿‡æ»¤è¿›å…¥ä¸»æœºçš„æ•°æ®åŒ…</td>
    </tr>
     <tr>
        <td  style="text-align:center; " >FORWAED</td>
       <td >è´Ÿè´£è½¬å‘æµç»ä¸»æœºçš„æ•°æ®åŒ…ã€‚èµ·è½¬å‘çš„ä½œç”¨ï¼Œå’ŒNATå…³ç³»å¾ˆå¤§ï¼Œåé¢ä¼šè¯¦ç»†è®²LVS NATæ¨¡å¼ã€‚</td>
    </tr>
    <tr>
        <td style="text-align:center; ">PREROUTING</td>
       <td >åœ¨<strong>æ•°æ®åŒ…åˆ°è¾¾é˜²ç«å¢™æ—¶è¿›è¡Œè·¯ç”±åˆ¤æ–­ä¹‹å‰æ‰§è¡Œçš„è§„åˆ™</strong>ï¼Œä½œç”¨æ˜¯æ”¹å˜æ•°æ®åŒ…çš„ç›®çš„åœ°å€ã€ç›®çš„ç«¯å£ç­‰ã€‚ï¼ˆé€šä¿—æ¯”å–»ï¼Œå°±æ˜¯æ”¶ä¿¡æ—¶ï¼Œæ ¹æ®è§„åˆ™é‡å†™æ”¶ä»¶äººçš„åœ°å€ï¼Œè¿™çœ‹ä¸Šå»å¾ˆä¸åœ°é“å•Šï¼ï¼‰
ä¾‹å¦‚ï¼šæŠŠå…¬ç½‘IPï¼š124.42.60.113æ˜ å°„åˆ°å±…äºç©åˆ†10.0.0.19æœåŠ¡å™¨ä¸Šã€‚å¦‚æœæ˜¯webæœåŠ¡ï¼Œå¯ä»¥æŠŠ80ç«¯è½¬ä¸ºå±€åŸŸç½‘çš„æœåŠ¡å™¨ä¸Š9000ç«¯å£ã€‚</td>
    </tr>
   <tr>
        <td style="text-align:center; ">POSTROUTING</td>
       <td >åœ¨æ•°æ®åŒ…ç¦»å¼€é˜²ç«å¢™æ—¶è¿›è¡Œè·¯ç”±åˆ¤æ–­ä¹‹åæ‰§è¡Œçš„è§„åˆ™ï¼Œä½œç”¨æ”¹å˜æ•°æ®åŒ…çš„æºåœ°å€ã€æºç«¯å£ç­‰ã€‚ï¼ˆé€šä¿—æ¯”å–»ï¼Œå°±æ˜¯å¯„ä¿¡æ—¶ï¼Œå†™å¥½å‘ä»¶äººçš„åœ°å€ï¼Œè¦è®©äººå®¶å›ä¿¡æ—¶èƒ½åæœ‰åœ°å€å¯å›ã€‚ï¼‰ä¾‹å¦‚ï¼šæˆ‘ä»¬åœ¨ç°åœ¨çš„ç¬”è®°æœ¬å’Œè™šæ‹Ÿæœºéƒ½æ˜¯10.0.0.0/24ï¼Œå°±æ˜¯æ¥šç‹çš„æ—¶å€™è¢«æˆ‘ä»¬ä¼ä¸šè·¯ç”±å™¨æŠŠæºåœ°å€æ”¹æˆäº†å…¬ç½‘åœ°å€äº†ã€‚<strong>ç”Ÿäº§åº”ç”¨ï¼šå±€åŸŸç½‘å…±äº«ä¸Šç½‘ã€‚</strong></td>
    </tr>
</table>  
<p>ç”±äºè¿™ä¸ªè¡¨ä¸ç‰¹æ®Šæ ‡è®°ç›¸å…³ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°è¿™ä¸ªmangleè¡¨ï¼Œè¿™é‡Œå°±ä¸åšè¯¦ç»†ä»‹ç»äº†ã€‚ç»™åˆå­¦è€…çš„å»ºè®®ï¼šæ–°æ‰‹å­¦ä¹ æ—¶æœ€å¥½æŠ“ä½ä¸€ä¸ªä¸»çº¿å‘å‰å­¦ï¼Œèƒ½å¤Ÿè·‘é€šè·¯å°±å¥½ï¼Œä¸ä¸€å®šè¦é¢é¢ä¿±åˆ°ï¼Œä¸ç„¶å¾ˆå®¹æ˜“é™·è¿›å»ï¼Œè€Œè‹¦æ¼ï¼Œç”šè‡³å¤±å»å­¦ä¹ çš„å…´è¶£</p>
<h4 id="15--iptablesè¡¨å’Œé“¾çš„æµç¨‹å›¾">1.5  iptablesè¡¨å’Œé“¾çš„æµç¨‹å›¾</h4>
<p>ä¸‹é¢è¿™å¼ å›¾æ¸…æ™°çš„æç»˜äº†netfilterå¯¹åŒ…çš„å¤„ç†æµç¨‹</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221025001126693.png" alt="image-20221025001126693" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><strong>ä¸ºäº†æ›´å¥½çš„å­¦ä¹ å°†ä¸Šå›¾ç®€åŒ–ä¸ºå¦‚ä¸‹</strong></p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221025002458322.png" alt="image-20221025002458322" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<center><strong>å›¾1-1 iptablesç®€åŒ–æµç¨‹å›¾</strong></center>
å¼ºè°ƒï¼šä¸Šå›¾å¯ä»¥çœ‹ä½œåœ°é“1 2å·çº¿æ¥
<p>1å·çº¿ï¼šä¸»è¦æ˜¯NATåŠŸèƒ½ï¼Œ</p>
<p>â€‹	<strong>ä¼ä¸šæ¡ˆä¾‹</strong>ï¼š</p>
<p>â€‹		1. å±€åŸŸç½‘ä¸Šç½‘å…±äº«ï¼ˆè·¯ç”±å’Œç½‘å…³ï¼‰ï¼Œä½¿ç”¨NATçš„POSTROUTINGé“¾</p>
<p>â€‹		2. å¤–éƒ¨IPå’Œç«¯å£æ˜ å°„ä¸ºå†…éƒ¨IPå’Œç«¯å£ï¼ˆDMZåŠŸèƒ½ï¼‰ï¼Œä½¿ç”¨NATçš„PREROUTINGé“¾ã€‚</p>
<p>2å·çº¿ï¼šä¸»è¦æ˜¯FILTERåŠŸèƒ½ï¼Œå³é˜²ç«å¢™åŠŸèƒ½ FILTER INPUT FORWARD</p>
<p>â€‹	<strong>ä¼ä¸šæ¡ˆä¾‹</strong>ï¼š</p>
<p>â€‹		ä¸»è¦åº”ç”¨å°±æ˜¯ä¸»æœºæœåŠ¡å™¨é˜²ç«å¢™ï¼Œä½¿ç”¨FILTERçš„INPUTé“¾</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ch2 iptableså‘½ä»¤å¸®åŠ©ä¿¡æ¯</title>
      <link>https://www.oomkill.com/2016/10/ch2-iptables-command/</link>
      <pubDate>Sat, 22 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/10/ch2-iptables-command/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="2-iptableså‘½ä»¤å¸®åŠ©ä¿¡æ¯">2 iptableså‘½ä»¤å¸®åŠ©ä¿¡æ¯</h2>
<p>æœ‰é—®é¢˜æŸ¥å¸®åŠ©ï¼Œä¸‹é¢æ˜¯å¾ˆå…¨çš„å¸®åŠ©ä¿¡æ¯ï¼ˆå¿…é¡»æ‹¿ä¸‹å®ƒï¼‰</p>
<pre><code class="language-bash">$ iptables -h
</code></pre>
<pre><code class="language-bash">$ iptables -nL
# INPUTé“¾ 	ACCEPTé»˜è®¤å…è®¸å†³ç­–              
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0           state NEW tcp dpt:22 
REJECT     all  --  0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited 

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
REJECT     all  --  0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited 

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination  
</code></pre>
<h3 id="21-å¯åŠ¨å’ŒæŸ¥çœ‹iptablesçŠ¶æ€">2.1 å¯åŠ¨å’ŒæŸ¥çœ‹iptablesçŠ¶æ€</h3>
<pre><code class="language-bash">/etc/init.d/iptables start
systemctl start iptables
</code></pre>
<blockquote>
<p><strong>å®ä¾‹æ¼”ç¤º1</strong>ï¼š</p>
</blockquote>
<pre><code class="language-bash">$ /etc/init.d/iptables status
è¡¨æ ¼ï¼šfilter
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1 ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
2ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0           
num  target     prot opt source               destination         
$ iptables -nL
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
</code></pre>
<hr>
<p><strong>æç¤ºï¼šå¦‚æœé‡åˆ°ä¸‹é¢çš„æ— æ³•å¯åŠ¨IPTABLESçš„æƒ…å†µ</strong></p>
<hr>
<pre><code class="language-bash">$ /etc/init.d/iptables start
$ /etc/init.d/iptables start
$ /etc/init.d/iptables status
Firewall is stopped
</code></pre>
<hr>
<p><strong>è§£å†³ï¼šsetup -&gt; Firewall Configuration -&gt; enable</strong></p>
<hr>
<p><strong>Iptablesé»˜è®¤åŠ è½½çš„å†…æ ¸æ¨¡å—</strong></p>
<pre><code class="language-bash">$ lsmod|egrep &quot;nat|filter&quot;   
iptable_filter          2793  1 
ip_tables              17831  1 iptable_filter
</code></pre>
<p><strong>åŠ è½½å¦‚ä¸‹æ¨¡å—åˆ°linuxå†…æ ¸</strong></p>
<pre><code class="language-bash">modprobe ip_tables \
modprobe iptable_filter \
modprobe iptable_nat \
modprobe ip_conntrack \
modprobe ip_conntrack_ftp \
modprobe ip_nat_ftp \
modprobe ipt_state
</code></pre>
<h3 id="22-iptableså‚æ•°">2.2 iptableså‚æ•°</h3>
<table>
<thead>
<tr>
<th><strong>å‚æ•°é€‰é¡¹</strong></th>
<th><strong>æ³¨é‡Šè¯´æ˜</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>-n <em>num</em></td>
<td>æ•°å­—</td>
</tr>
<tr>
<td>-L</td>
<td>åˆ—è¡¨</td>
</tr>
<tr>
<td>-F</td>
<td>æ¸…é™¤æ‰€æœ‰è§„åˆ™ï¼Œä¸ä¼šå¤„ç†é»˜è®¤çš„è§„åˆ™</td>
</tr>
<tr>
<td>-X</td>
<td>åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰çš„é“¾</td>
</tr>
<tr>
<td>-Z</td>
<td>é“¾çš„è®¡æ•°å™¨æ¸…é›¶</td>
</tr>
<tr>
<td>-t</td>
<td>æŒ‡å®šè¡¨</td>
</tr>
<tr>
<td>-A</td>
<td>æ·»åŠ åè®®</td>
</tr>
<tr>
<td>-p</td>
<td>åè®®ï¼ˆall tcp udp Icmpï¼‰é»˜è®¤ä¸ºall</td>
</tr>
<tr>
<td>&ndash;dport</td>
<td>ç›®çš„ç«¯å£</td>
</tr>
<tr>
<td>&ndash;sport</td>
<td>æºç«¯å£</td>
</tr>
<tr>
<td>-j</td>
<td>å¤„ç†çš„è¡Œä¸ºï¼ˆACCEPTæ¥å— DROPä¸¢å¼ƒ REJECTæ‹’ç»ï¼‰</td>
</tr>
<tr>
<td>-D</td>
<td>åˆ é™¤è§„åˆ™</td>
</tr>
<tr>
<td>-A</td>
<td>æ·»åŠ è§„åˆ™åˆ°æŒ‡å®šé“¾çš„ç»“å°¾</td>
</tr>
<tr>
<td>-I</td>
<td>æ·»åŠ è§„åˆ™åˆ°æŒ‡å®šé“¾çš„å¼€å¤´</td>
</tr>
<tr>
<td>-s</td>
<td>æŒ‡å®šæºåœ°å€</td>
</tr>
<tr>
<td>&ndash;line-numbers</td>
<td>æ˜¾ç¤ºåºå·</td>
</tr>
<tr>
<td>-i <em>&lt;ç½‘ç»œæ¥å£&gt;</em></td>
<td>æŒ‡å®šæ•°æ®åŒ…è¿›å…¥æœ¬æœºçš„ç½‘ç»œæ¥å£ã€‚</td>
</tr>
<tr>
<td>-o <em>&lt;ç½‘ç»œæ¥å£&gt;</em></td>
<td>æŒ‡å®šæ•°æ®åŒ…è¦ç¦»å¼€æœ¬æœºæ‰€ä½¿ç”¨çš„ç½‘ç»œæ¥å£ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="23-æ¸…é™¤é»˜è®¤è§„åˆ™">2.3 æ¸…é™¤é»˜è®¤è§„åˆ™</h3>
<ul>
<li><code>iptables -F</code> æ¸…é™¤æ‰€æœ‰è§„åˆ™ï¼Œä¸ä¼šå¤„ç†é»˜è®¤çš„è§„åˆ™</li>
<li><code>iptables -X</code> åˆ é™¤ç”¨æˆ·è‡ªå®šä¹‰çš„é“¾</li>
<li><code>iptables -Z</code> é“¾çš„è®¡æ•°å™¨æ¸…é›¶</li>
</ul>
<p><strong>å®ä¾‹æ¼”ç¤º2</strong>ï¼š</p>
<pre><code class="language-bash">iptables -F == iptables --flush
iptables -X == iptables --delete-chain
iptables -Z
</code></pre>
<blockquote>
<p><strong>ç¦æ­¢è§„åˆ™</strong></p>
</blockquote>
<p><strong>1.ç¦æ­¢sshç«¯å£</strong></p>
<p>(1) æ‰¾å‡ºå½“å‰æœºå™¨SSHç«¯å£</p>
<pre><code class="language-bash">$ netstat -lntup|grep ssh
tcp     0      0 192.168.1.5:52113       0.0.0.0:*         LISTEN      1053/sshd 
</code></pre>
<p>(2) ç¦æ­¢æ‰å½“å‰SSHç«¯å£ï¼Œè¿™é‡Œæ˜¯52113</p>
<pre><code class="language-bash">iptables -t [table] -[AD] chain rule-specification [options]
</code></pre>
<p><strong>å…·ä½“å‘½ä»¤</strong></p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --dport 52113 -j DROP
iptables -tfilter -A INPUT -p tcp --dport 52113 -j DROP	
</code></pre>
<p>æ³¨ï¼š</p>
<pre><code class="language-txt">1.  iptablesé»˜è®¤ç”¨çš„å°±æ˜¯filterè¡¨ï¼Œå› æ­¤ï¼Œä»¥ä¸Šä¸¤æ¡å‘½ä»¤ç­‰ä»·ã€‚
2.  å…¶ä¸­INPUT DROPè¦å¤§å†™
3.  --jump  -j target target for ruleï¼ˆmay load target extensionï¼‰åŸºæœ¬å¤„ç†è¡Œä¸ºï¼šACCEPTï¼ˆæ¥å—ï¼‰ã€DROPï¼ˆä¸¢å¼ƒï¼‰ã€REJECTï¼ˆæ‹’ç»ï¼‰ã€‚æ¯”è¾ƒï¼šDROPå¥½äºREJECTï¼ˆä¸è¦ç»™rejectï¼Œæ‹’ç»ä¼šç»™å¯¹æ–¹ä¿¡æ¯ï¼Œé€æ¼ä¿¡æ¯äº†ï¼‰
</code></pre>
<p>å‘½ä»¤è¡Œæ‰§è¡Œçš„è§„åˆ™ï¼Œä»…ä»…åœ¨å†…å­˜é‡Œä¸´æ—¶ç”Ÿæ•ˆã€‚</p>
<pre><code class="language-bash">$ iptables -A INPUT -p tcp --dport 52113 -j DROP 
$ 
ÃÃ…ÂºÃ…ÂµÃ†Â³Â¬ÃŠÂ±ÃŠ
</code></pre>
<p>æ‰“å°çƒï¼šå¦‚æœå¯¹æ–¹å‘Šè¯‰ä½ ä¸å»ï¼ŒREJECTï¼ˆæ‹’ç»ï¼‰ï¼Œå¦‚æœå¯¹æ–¹æ²¡ååº”ï¼ŒDROPï¼ˆä¸¢å¼ƒï¼‰ã€‚</p>
<p>(3) æ¢å¤åˆšæ‰æ–­æ‰çš„SSHè¿æ¥</p>
<pre><code class="language-txt">1.  å»æœºæˆ¿é‡å¯ç³»ç»Ÿæˆ–è€…ç™»é™†æœåŠ¡å™¨åˆ é™¤åˆšæ‰çš„ç¦æ­¢è§„åˆ™ã€‚
2.  è®©æœºæˆ¿äººå‘˜é‡å¯æœåŠ¡å™¨æˆ–è®©æœºæˆ¿äººå‘˜æ‹¿ç”¨æˆ·å¯†ç ç™»é™†è¿›å»ã€‚
3.  é€šè¿‡æœåŠ¡å™¨çš„è¿œç¨‹ç®¡ç†å¡ç®¡ç†ï¼ˆæ¨èï¼‰ã€‚
4.  å…ˆå†™ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯5åˆ†é’Ÿå°±åœæ­¢é˜²ç«å¢™ã€‚
5.  æµ‹è¯•ç¯å¢ƒæµ‹è¯•å·ï¼Œå†™æˆè„šæœ¬ï¼Œæ‰¹é‡æ‰§è¡Œã€‚
</code></pre>
<p>æˆ‘ä»¬æ¢å¤çš„åŠæ³•ï¼Œç™»é™†è™šæ‹Ÿç»ˆç«¯é¡µé¢åˆ é™¤æ‰åˆšæ‰çš„è§„åˆ™ã€‚å½“ç„¶ä¹Ÿå¯æ‰§è¡Œiptables -Fï¼Œ iptables stopç­‰ã€‚
ç»ƒä¹ ï¼šç¦æ­¢ç”¨æˆ·è®¿é—®80ç«¯å£æˆ–3306ç«¯å£ï¼š</p>
<pre><code class="language-bash">iptables -t filter -A INPUT -p tcp --dport 80 -j DROP
$ telnet 192.168.1.5 80
Trying 192.168.1.5...
Connected to 192.168.1.5.
Escape character is '^]'.
^CConnection closed by foreign host.
$ telnet 192.168.1.5 80
Trying 192.168.1.5...

$ iptables -nL
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpt:80 
</code></pre>
<p>ä½¿ç”¨-Iå’Œ-Açš„é¡ºåºï¼Œé˜²ç«å¢™çš„è¿‡æ»¤æ ¹æ®è§„åˆ™é¡ºåºçš„ã€‚</p>
<ul>
<li>
<p><code>-A</code> æ˜¯æ·»åŠ è§„åˆ™åˆ°æŒ‡å®šé“¾çš„ç»“å°¾ï¼Œæœ€åä¸€æ¡ã€‚</p>
</li>
<li>
<p><code>-I</code> æ˜¯æ·»åŠ è§„åˆ™åˆ°æŒ‡å®šé“¾çš„ç»“å°¾ï¼Œç¬¬ä¸€æ¡ã€‚</p>
</li>
</ul>
<pre><code class="language-bash">$ iptables -nL
Chain INPUT (policy ACCEPT)
target     prot opt source               destination   
</code></pre>
<pre><code class="language-bash">$ iptables -A INPUT -p tcp -s 192.168.1.1 --dport 80 -j DROP
$ iptables -nL
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  192.168.1.1          0.0.0.0/0           tcp dpt:80 
</code></pre>
<p><strong>æŸ¥çœ‹è§„åˆ™åºå·</strong>ï¼š</p>
<pre><code class="language-bash">iptables -L -n --line-numbers
$ iptables -L -n --line-numbers                             
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    DROP       tcp  --  192.168.1.1          0.0.0.0/0           tcp dpt:80 
2    DROP       tcp  --  192.168.1.2          0.0.0.0/0           tcp dpt:80 
Chain FORWARD (policy ACCEPT)

</code></pre>
<p>æŒ‡å®šä½ç½®æ’å…¥è§„åˆ™ï¼šæ’å…¥åˆ°ç¬¬äºŒè¡Œ</p>
<pre><code class="language-bash">$ iptables -I INPUT 2 -p tcp -s 192.168.1.3 --dport 80 -j DROP 
$ iptables -L -n --line-numbers                               
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    DROP       tcp  --  192.168.1.1          0.0.0.0/0           tcp dpt:80 
2    DROP       tcp  --  192.168.1.3          0.0.0.0/0           tcp dpt:80 
3    DROP       tcp  --  192.168.1.2          0.0.0.0/0           tcp dpt:80 
Chain FORWARD (policy ACCEPT)
</code></pre>
<p>é€šè¿‡åºå·åˆ é™¤è§„åˆ™ï¼Œåˆ é™¤ä¸Šè¿°ç¬¬2æ¡è§„åˆ™</p>
<pre><code class="language-bash">$ iptables -D INPUT 2 == delete from iptables where id=2
$ iptables -L -n --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    DROP       tcp  --  192.168.1.1          0.0.0.0/0           tcp dpt:80 
2    DROP       tcp  --  192.168.1.2          0.0.0.0/0           tcp dpt:80 
Chain FORWARD (policy ACCEPT)
</code></pre>
<p><strong>å°ç»“ï¼šæ€»ç»“åˆ é™¤è§„åˆ™çš„æ–¹æ³•</strong>ï¼š</p>
<pre><code>1.   iptables -D INPUT -P tcp --dport 8080 -J DROP
2.   iptables -F åˆ é™¤æ‰€æœ‰è§„åˆ™
3.   /etc/init.d/iptables restart ï¼ˆç”¨iptableså‘½ä»¤è¡Œé…ç½®çš„å‘½ä»¤éƒ½æ˜¯ä¸´æ—¶ç”Ÿæ•ˆï¼‰
4.   iptables -D INPUT åºåˆ—å·
</code></pre>
<p><strong>åŸºäºå®¢æˆ·ç«¯æºåœ°å€ç½‘æ®µæ§åˆ¶ï¼Œç¦æ­¢10.0.0.0ç½‘æ®µè¿å…¥</strong></p>
<pre><code class="language-bash">iptables -t filter -A INPUT -i eth0 -s 10.0.0.0/24 -J DROP
iptables -A INPUT -i eth0 -s 10.0.0.0/24 -J DROP
</code></pre>
<p>æ³¨ï¼šiptablesé»˜è®¤ç”¨çš„å°±æ˜¯filterè¡¨ï¼Œå› æ­¤ä»¥ä¸Šä¸¤æ¡å‘½ä»¤ç­‰ä»·ã€‚
æ‰§è¡Œä»¥ä¸Šå‘½ä»¤å¯ä»¥å‘ç°ï¼Œæˆ‘è¿™é‡Œå·²ç»æ— æ³•è¿œç¨‹è¿æ¥äº†ã€‚
ç™»é™†è™šæ‹Ÿæœºï¼Œåˆ é™¤åˆšæ‰ç¦æ­¢çš„æ¥æºåœ°å€ä¸º10ç½‘æ®µçš„å‘½ä»¤ã€‚
<code>iptables -D INPUT -i eth0 -s 10.0.0.0/24 -J DROP</code> (å®Œæ•´ç­–ç•¥è§„åˆ™åˆ é™¤)
<code>iptables -D INPUT 1</code>ï¼ˆæ ¹æ®ç­–ç•¥åœ¨é“¾ä¸­çš„åºå·åˆ ï¼Œæ¯æ¡é“¾éƒ½æ˜¯å„è‡ªä»1ç¼–å·ï¼‰ã€‚</p>
<pre><code class="language-bash">$ iptables -nL --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    DROP       tcp  --  192.168.1.5          0.0.0.0/0           tcp dpt:80 
2    DROP       tcp  --  192.168.1.4          0.0.0.0/0           tcp dpt:80 
3    DROP       tcp  --  192.168.1.2          0.0.0.0/0           tcp dpt:80 

Chain FORWARD (policy ACCEPT)
n      
$ iptables -D INPUT 1
$ iptables -nL --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    DROP       tcp  --  192.168.1.4          0.0.0.0/0           tcp dpt:80 
2    DROP       tcp  --  192.168.1.2          0.0.0.0/0           tcp dpt:80 

Chain FORWARD (policy ACCEPT)   
</code></pre>
<blockquote>
<p><strong>è¿˜å¯ä»¥é€šè¿‡â€œï¼â€æ¥å–å</strong></p>
</blockquote>
<pre><code class="language-bash"># åªæœ‰ 192.168.1.1æ‰å¯è®¿é—®80ç«¯å£ ï¼æ”¾åœ¨é€‰é¡¹çš„å‰é¢è€Œä¸æ˜¯å‚æ•°çš„å‰é¢
iptables -I INPUT -p tcp ! -s 192.168.1.1 --dport 80 -j DROP
</code></pre>
<p>æµ‹è¯•é…ç½®æ‹’ç»è§„åˆ™ä¹Ÿæ˜¯åŒ¹é…ï¼šä¸‹é¢çš„æµ‹è¯•æœ‰ä¸¤ä¸ªè¦ç‚¹ï¼šéçš„ä½œç”¨ï¼ŒåŒ¹é…æ‹’ç»ä¹Ÿæ˜¯åŒ¹é…ã€‚</p>
<p>centos5ç‰ˆæœ¬</p>
<pre><code class="language-bash">iptables -I INPUT -p tcp -s ! 192.168.1.1 --dport 80 -j DROP
</code></pre>
<p>centos6.4é«˜ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-bash">$ iptables -t filter -A INPUT -i eth0 -s ! 10.0.0.115 -j DROP
Using intrapositioned negation (`--option ! this`) is deprecated in favor of extrapositioned (`! --option this`).
# è§£å†³æ–¹æ¡ˆï¼š iptables -t filter -A INPUT -i eth0 -s ! 10.0.0.115 -j DROP
</code></pre>
<blockquote>
<p><strong>æµ‹è¯•éâ€ï¼â€œ</strong></p>
</blockquote>
<p>1.æºåœ°å€ä¸æ˜¯10.0.0.101å•ä¸ªIPçš„ç¦æ­¢é“¾æ¥</p>
<pre><code>iptables -t filter -I INPUT -i eth0 ! -s 10.0.0.101 -j DROP
iptables -A INPUT -p all -i eth0 ! -s 10.0.0.106 -j DROP # p(udp tcp icmp all)
# ä¸è®©ä¸»æœºpingé€š
iptables -t filter -I INPUT -p icmp --icmp-type 8 -i eth0 -s ! 192.168.2.83 -j DROP

# ssh æ–­å¼€é“¾æ¥
$ iptables -t filter -I INPUT -i eth0 ! -s 192.168.2.83 -j DROP
$ 
ÃÃ…ÂºÃ…ÂµÃ†Â³Â¬ÃŠÂ±ÃŠ
# ping ä¸é€š
C:\Users\Company&gt;ping 192.168.2.83
æ­£åœ¨ Ping 192.168.2.83 å…·æœ‰ 32 å­—èŠ‚çš„æ•°æ®:
è¯·æ±‚è¶…æ—¶ã€‚
è¯·æ±‚è¶…æ—¶ã€‚
è¯·æ±‚è¶…æ—¶ã€‚
192.168.2.83 çš„ Ping ç»Ÿè®¡ä¿¡æ¯:
æ•°æ®åŒ…: å·²å‘é€ = 4ï¼Œå·²æ¥æ”¶ = 0ï¼Œä¸¢å¤± = 4 (100% ä¸¢å¤±)ï¼Œ
</code></pre>
<p>2.åŸåœ°å€ä¸æ˜¯192.168.2.0/24çš„ç½‘æ®µç¦æ­¢è¿æ¥</p>
<pre><code class="language-bash"> iptables -t filter -I INPUT -i eth0 -s ! 192.168.2.0/24 -j DROP  ==  
 iptables -t filter -I INPUT -i eth0 -s 192.168.2.0/24 -j ACCECT # å·¥ä½œåœºæ™¯
</code></pre>
<p>ç¬¬ä¸€èŠ‚è®²äº†linuxä¼˜åŒ–ï¼Œæ›´æ”¹rootå’Œå’Œsshç«¯å£</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --dport 52113 ! -s 192.168.2.0/24 -J DROP
</code></pre>
<p>åœ¨é»˜è®¤è§„åˆ™ä¸ºå…è®¸çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°å¯ä»¥å°å µsshè®¿é—®ã€‚</p>
<blockquote>
<p><strong>ä¼ä¸šå·¥ä½œä¸­è§£å†³è¿™ä¸ªé—®é¢˜</strong>ï¼š</p>
</blockquote>
<pre><code>1.  vpnæœåŠ¡ï¼ˆæ‹¨å·æ‹¨åˆ°VPNä¸Šï¼Œç„¶åä»¥VPNçš„å†…ç½‘åœ°å€åŒºè®¿é—®å†…éƒ¨çš„æœºå™¨åœ°å€ï¼‰ã€‚
2.  å‰ç«¯å¯¹å¤–æä¾›æœåŠ¡å™¨çš„æœºå™¨SSHç«¯å£éƒ½åšç¦æ­¢å¤–éƒ¨IPè®¿é—®é™åˆ¶ï¼Œå¯ä»¥å¼€å¯åç«¯æˆ–è€…ä¸å¯¹å¤–æä¾›æœåŠ¡çš„æœºå™¨ï¼Œä¿ç•™SSHæœåŠ¡ï¼ˆæ›´æ”¹rootå’ŒSSHç«¯å£ï¼‰ã€‚ç„¶åï¼Œæˆ‘ä»¬å¹³æ—¶å°±å…ˆè¿æ¥æ­¤æœºå™¨æ²¡åœ¨å»è¿å…¶ä»–æœºå™¨ã€‚
3.  æµé‡ç‰¹åˆ«å¤§çš„å¤–ç½‘æœºå™¨ä¸è¦å¼€é˜²ç«å¢™ï¼Œä¼šå½±å“æ€§èƒ½ï¼Œè´­ä¹°ç¡¬ä»¶é˜²ç«å¢™ã€‚
</code></pre>
<p>å°æ‰3306ç«¯å£</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --dorp 3306 -j DROP
</code></pre>
<p>åŒ¹é…æŒ‡å®šçš„åè®®</p>
<pre><code class="language-bash">iptables -A INPUT -P tcp 		# å¦‚æœä¸æŒ‡å®š-pï¼Œé»˜è®¤å°±æ˜¯all
</code></pre>
<p>åŒ¹é…æŒ‡å®šåè®®å¤–çš„æ‰€æœ‰åè®®</p>
<pre><code class="language-bash">iptables -A INPUT -p ! tcp
iptables -I INPUT ! -p tcp -s 192.168.2.83 -j DROP
</code></pre>
<p>åŒ¹é…ç½‘æ®µ</p>
<pre><code class="language-bash">iptables -A INPUT -s 10.0.0.0/24
iptables -A INPUT ! -s 10.0.0.0/24
</code></pre>
<p>åŒ¹é…å•ä¸€ç«¯å£</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp ! --sport 22
iptables -A INPUT -p tcp ! --dport 22 -s 10.0.0.20 -j DROP
</code></pre>
<p>åŒ¹é…ç«¯å£èŒƒå›´</p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --sport 22:80
iptables -I INPUT -p tcp --dport 21,22,23,24 # é”™è¯¯è¯­æ³•
iptables -I INPUT -p tcp -m multiport --dport 18:80 -j DROP
iptables -I INPUT -p tcp --dport 21:23 -j DROP # æœ€ä½³
</code></pre>
<blockquote>
<p><strong>å®ä¾‹1ï¼šæµ‹è¯•åŒ¹é…ç«¯å£èŒƒå›´</strong></p>
</blockquote>
<pre><code class="language-bash">iptables -F
$ iptables -t filter -A INPUT -p tcp --dport 20:100 -j DROP
C:\Users\Company&gt;telnet 192.168.2.83 80
æ­£åœ¨è¿æ¥192.168.2.83...æ— æ³•æ‰“å¼€åˆ°ä¸»æœºçš„è¿æ¥ã€‚ åœ¨ç«¯å£ 80: è¿æ¥å¤±è´¥
$ iptables -nL
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0           tcp dpts:20:100 
</code></pre>
<p>æµ‹è¯•ç»“æœ</p>
<ol>
<li>ssh52113ç«¯å£ç»ˆç«¯ç›´æ¥æ–­æ‰</li>
<li>telnetè¿æ¥80ä¸é€š</li>
</ol>
<pre><code class="language-bash">$ iptables -t filter -A INPUT -p tcp --dport 50000:60000 -j DROP     
$ 
ÃÃ…ÂºÃ…ÂµÃ†Â³Â¬ÃŠÂ±ÃŠ
</code></pre>
<blockquote>
<p><strong>å®ä¾‹2:åˆ—ä¸¾ç«¯å£</strong></p>
</blockquote>
<pre><code class="language-bash">$ iptables -t filter -A INPUT -p tcp -m multiport --dport 80,90,100 -j DROP
$ iptables -nL
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
DROP       tcp  --  0.0.0.0/0            0.0.0.0/0           multiport dports 80,90,100 
</code></pre>
<p>æµ‹è¯•ç»“æœï¼štelnetè¿æ¥80ä¸é€š</p>
<pre><code class="language-bash">$ telnet 192.168.1.5 80
æ­£åœ¨è¿æ¥192.168.1.5...æ— æ³•æ‰“å¼€åˆ°ä¸»æœºçš„è¿æ¥ã€‚ åœ¨ç«¯å£ 80: è¿æ¥å¤±è´¥
</code></pre>
<blockquote>
<p><strong>åŒ¹é…ICMCç±»å‹</strong></p>
</blockquote>
<p><code>iptables -A INPUT -p icmp --icmp-type 8</code></p>
<p>ä¾‹ï¼š<code>iptables -A INPUT -p icmp --icmp-type 8 -j DROP</code></p>
<pre><code class="language-bash">iptables -A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
 	iptables -A FORWARD -s 192.168.1.0/24 -p icmp -m icmp --icmp-type any -j ACCEPT
# åœ¨å·¥ä½œä¸­é»˜è®¤æ˜¯æ‹’ç»çŠ¶æ€ï¼Œç”¨ä»€ä¹ˆå¼€ä»€ä¹ˆï¼Œåªæœ‰å†…ç½‘å…è®¸ping
</code></pre>
<blockquote>
<p><strong>åŒ¹é…æŒ‡å®šçš„ç½‘ç»œæ¥å£</strong></p>
</blockquote>
<pre><code class="language-bash">iptables -A INPUT -i eth0
iptables -A FORWARD -o eth0
</code></pre>
<p><strong>è®°å¿†æ–¹æ³•</strong>ï¼š</p>
<p>in-interface -i input name</p>
<p>in-interface -o output name</p>
<p><strong>åŒ¹é…ç½‘ç»œçŠ¶æ€</strong></p>
<ul>
<li>
<p>-m state &ndash;state</p>
</li>
<li>
<p>NEWï¼šå·²ç»æˆ–å°†å¯åŠ¨æ´—å‘¢è¿æ¥</p>
</li>
<li>
<p>ESTABLISHEDï¼šå·²ç»å»ºç«‹çš„è¿æ¥</p>
</li>
<li>
<p>RELATEDï¼šæ­£åœ¨å¯åŠ¨çš„æ–°è¿æ¥</p>
</li>
<li>
<p>INVALIDï¼šéæ³•æˆ–æ— æ³•è¯†åˆ«çš„</p>
</li>
<li>
<p>FTPæœåŠ¡æ˜¯ç‰¹æ®Šçš„ï¼Œéœ€è¦é…çŠ¶æ€è¿æ¥ã€‚</p>
</li>
</ul>
<p>å…è®¸å…³è”çš„çŠ¶æ€åŒ…é€šè¿‡ï¼ˆwebæœåŠ¡ä¸è¦ä½¿ç”¨ftpï¼‰</p>
<pre><code class="language-bash">iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
</code></pre>
<p>æ¯”å–»ï¼šçœ‹ç”µå½±å‡ºå»WCæˆ–è€…æ¥ä¸ªç”µè¯ï¼Œå›æ¥ä¹Ÿå¾—å…è®¸è¿›å»ã€‚</p>
<p>é™åˆ¶æŒ‡å®šæ—¶é—´åŒ…çš„å…è®¸é€šè¿‡æ•°é‡åŠå¹¶å‘æ•° <code>-m limit --limit n/{second/minute/hour/day}</code></p>
<p><strong>æŒ‡å®šæ—¶é—´å†…çš„è¯·æ±‚é€Ÿç‡â€œnâ€ä¸ºé€Ÿç‡ï¼Œåé¢ä¸ºæ—¶é—´åˆ†åˆ«ä¸ºï¼šç§’æ—¶åˆ†</strong></p>
<p><code>--limit-burst [n]</code>: åœ¨åŒä¸€æ—¶é—´å†…å…è®¸é€šè¿‡çš„è¯·æ±‚â€œnâ€ä¸ºæ•°å­—ï¼Œä¸æŒ‡å®šé»˜è®¤ä¸º5</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ch3 iptablesé…ç½®é˜²ç«å¢™</title>
      <link>https://www.oomkill.com/2016/10/ch3-iptables-configuration/</link>
      <pubDate>Sat, 22 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/10/ch3-iptables-configuration/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>ç”Ÿäº§ç¯å¢ƒé…ç½®ä¸»æœºé˜²ç«å¢™æœ‰ä¸¤ç§æ¨¡å¼ï¼š</p>
<p>é€›å…¬å›­åŠçœ‹ç”µå½±ä¸¤ç§æ¨¡å¼ï¼š</p>
<p>é€›å…¬å›­ï¼šé»˜è®¤éšä¾¿å‡ºè¿›ï¼Œå¯¹éæ³•çš„åˆ†å­è¿›è¡Œæ‹’ç»ã€‚ä¼ä¸šåº”ç”¨ï¼šä¼ä¸šé…ç½®ä¸Šç½‘ç½‘å…³è·¯ç”±ã€‚</p>
<p>çœ‹ç”µå½±ï¼šé»˜è®¤æ²¡æœ‰ç¥¨è¿›ä¸å»ã€‚èŠ±é’±ä¹°ç¥¨æ‰èƒ½çœ‹ç”µå½±ã€‚ä¼ä¸šåº”ç”¨ï¼šæœåŠ¡å™¨ä¸»æœºé˜²ç«å¢™ã€‚</p>
<p>å¾ˆæ˜¾ç„¶ï¼šç¬¬äºŒç§æ›´ä¸¥æ ¼ï¼Œæ›´å®‰å…¨ã€‚</p>
<p>é€›å…¬å›­åŠçœ‹ç”µå½±ä¸¤ç§æ¨¡å¼æœ¬äº‹å°±æ˜¯é˜²ç«å¢™çš„é»˜è®¤è§„åˆ™æ˜¯å…è®¸è¿˜æ˜¯æ‹’ç»ã€‚</p>
<p><strong>1.æ¸…ç†å½“å‰æ‰€æœ‰è§„åˆ™å’Œè®¡æ•°å™¨</strong></p>
<pre><code class="language-bash">iptables -F
iptables -Z
iptables -X
</code></pre>
<p><strong>2.é…ç½®å…è®¸SSHç™»é™†ç«¯å£è¿›å…¥</strong></p>
<pre><code class="language-bash">iptables -A INPUT -p tcp --dport 52113 -j ACCEPT
iptables -A INPUT -p tcp -s 192.168.1.0/30 -j ACCEPT
</code></pre>
<hr>
<p>æç¤ºï¼šæ­¤æ­¥éª¤æ˜¯ä¸ºäº†é˜²æ­¢æ‰§è¡Œä¸‹é¢çš„æ­¥éª¤ï¼ŒæŠŠè‡ªå·±å…³åœ¨å¤–é¢ï¼Œé™¤éä½ åœ¨æœ¬åœ°å¤„ç†ï¼Œè¿™éƒ¨å¯ä»¥ä¸åšã€‚</p>
<hr>
<p><strong>3.è®¾ç½®å…è®¸æœ¬æœºloé€šè®¯è§„åˆ™</strong></p>
<pre><code class="language-bash">iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT # outputåŠ ä¸åŠ éƒ½è¡Œï¼Œåœ¨å·¥ä½œç¯å¢ƒä¸Šæ˜¯åŠ çš„
</code></pre>
<p><strong>4.è®¾ç½®é»˜è®¤çš„é˜²ç«å¢™ç¦æ­¢å’Œå…è®¸è§„åˆ™</strong></p>
<pre><code class="language-bash"> iptables -P INPUT DROP
 iptables -P FORWARD DROP
 iptables -P OUTPUT ACCEPT
</code></pre>
<p>ä¸€èˆ¬æƒ…å†µä¸‹OUTPUTæˆ‘ä»¬ä¸è¦dropï¼Œåƒç”µå½±é™¢ä¸€æ ·ï¼Œç”µå½±å·²ç»çœ‹å®Œäº†ï¼Œä¸­é—´ä¸æƒ³çœ‹å°±å›å®¶äº†ï¼Œä½ ä¸å¯èƒ½è¯´ä¸è¡Œä¸èƒ½èµ°ï¼Œæ‰€ä»¥ä¸€èˆ¬å‡ºå»æ²¡äººç®¡ï¼Œè¿›æ¥æ‰æ”¶ç¥¨ï¼ŒOUTPUTä¸€èˆ¬ä¸è®¾ç½®ï¼Œä½†æ˜¯ä¸è®¾ç½®ä¹Ÿæœ‰é£é™©ï¼Œä¼ä¸šæµé‡æš´æ¶¨ï¼Œç”±äºæœåŠ¡å™¨ä¸­ç—…æ¯’å¤–å‘æµé‡ã€‚</p>
<p><strong>æŸ¥çœ‹ç»“æœ</strong></p>
<pre><code class="language-bash">$ iptables -nL
Chain INPUT (policy DROP)
target     prot opt source               destination         
ACCEPT     tcp  --  192.168.1.0/27       0.0.0.0/0           tcp dpt:52113 
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           

Chain FORWARD (policy DROP)
target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0 
</code></pre>
<p><strong>5.å¼€å¯ç½‘æ®µä¿¡ä»»</strong></p>
<p>å…è®¸IDC LAN/WANå’ŒåŠå…¬ç½‘ipçš„è®¿é—®ï¼ŒåŠå¯¹å¤–åˆä½œæœºæ„è®¿é—®</p>
<p>åŠå…¬å®¤å›ºå®šIPæ®µï¼ŒIDCæœºæˆ¿å†…ç½‘ç½‘æ®µï¼Œå…¶ä»–æœºæˆ¿å†…ç½‘ç½‘æ®µï¼ŒIDCæœºæˆ¿å¤–ç½‘ç½‘æ®µ</p>
<p>ä¾‹ï¼š</p>
<pre><code>iptables -A INPUT -p all -s 192.168.1.0/27 -j ACCEPT
</code></pre>
<hr>
<p><strong>å®‰å…¨æç¤º</strong>ï¼šè¦ç»†åŒ–åˆ°æ©ç æœ€å°ï¼Œç§Ÿç”¨é˜¿é‡Œäº‘æ”»å‡»åŒç½‘æ®µæ¡ˆä¾‹</p>
<hr>
<p><strong>6.å…è®¸icmpç±»å‹åè®®é€šè¿‡</strong></p>
<pre><code class="language-bash">iptables -A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
</code></pre>
<hr>
<p>æ³¨ï¼š å¦‚æœä¸æƒ³å¼€ï¼Œå°±ä¸æ‰§è¡Œæ­¤è¡Œå‘½ä»¤ã€‚å¦‚æœå¯¹å†…ç½‘å¼€ï¼Œå¯¹å¤–ä¸å¼€å°±ç”¨ä¸‹é¢æ–¹å¼ã€‚</p>
<hr>
<pre><code class="language-bash">iptables -A INPUT -p icmp -s 10.0.0.0/24 -m icmp --icmp-type any -j ACCEPT
</code></pre>
<p><strong>8.å…è®¸å…³è”çš„çŠ¶æ€åŒ…é€šè¿‡ï¼ˆwebæœåŠ¡ä¸è¦ä½¿ç”¨FTPï¼‰</strong></p>
<p>é€šè¿‡å…¶ä»–æœåŠ¡å™¨æ‰«ææˆ‘ä»¬é…ç½®çš„é˜²ç«å¢™ï¼š</p>
<pre><code class="language-bash">$  nmap 192.168.1.5 -p 1-65535 # æ—¶é—´å¾ˆé•¿
Starting Nmap 5.51 ( http://nmap.org ) at 2016-10-31 01:24 CST
Nmap scan report for 192.168.1.5
Host is up (0.00024s latency).
Not shown: 65533 filtered ports
PORT      STATE SERVICE
80/tcp    open  http
52113/tcp open  unknown
MAC Address: 00:0C:29:BE:2D:75 (VMware)

Nmap done: 1 IP address (1 host up) scanned in 117.86 seconds
</code></pre>
<p><em>åœ¨å‘½ä»¤è¡Œæ“ä½œçš„æ¯ä¸€æ¡å‘½ä»¤éƒ½æ˜¯åœ¨å†…å­˜é‡Œ ï¼Œæ²¡æœ‰å†™å…¥ç£ç›˜é‡Œï¼Œé‡å¯æœåŠ¡å°±ä¸¢äº†</em></p>
<p>åœ¨ä¸Šé¢çš„å‘½ä»¤è¡Œé…ç½®ä¸­æ‰€æœ‰çš„å‘½ä»¤ç»“æœä»…ä»…å­˜åœ¨æ”¾äºå†…å­˜ä¸­ï¼Œé‡å¯æœåŠ¡å°±ä¼šä¸¢å¤±ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ä¿å­˜æˆé…ç½®æ–‡ä»¶ã€‚
æ³•ä¸€ï¼š</p>
<pre><code class="language-sh">$ /etc/init.d/iptables save
iptablesï¼šå°†é˜²ç«å¢™è§„åˆ™ä¿å­˜åˆ° /etc/sysconfig/iptablesï¼š[ç¡®å®š]
$ cat /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7 on Tue Nov 15 02:50:43 2016
*filter
:INPUT DROP [133073:5855518]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [202:14432]
-A INPUT -s 192.168.1.0/27 -p tcp -m tcp --dport 52113 -j ACCEPT 
-A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT 
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT 
-A OUTPUT -o lo -j ACCEPT 
COMMIT
# Completed on Tue Nov 15 02:50:43 2016
</code></pre>
<p>æ³•äºŒï¼š</p>
<pre><code class="language-shell">$ iptables-save &gt;/etc/sysconfig/iptables
</code></pre>
<hr>
<blockquote>
<p><font color=#fe0101 size=2>æç¤ºï¼š<code>/etc/sysconfig/iptables</code>ä¸ºiptablesçš„é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„</font></p>
<p><font color=#fe0101 size=2>æç¤ºï¼šç¬¬ä¸€æ¬¡ä¿å­˜å¯ä»¥è¦†ç›–ï¼Œä»¥åä¿å­˜åªèƒ½è¿½åŠ </font></p>
</blockquote>
<hr>
]]></content:encoded>
    </item>
    
    <item>
      <title>ch4 ç”Ÿäº§ç¯å¢ƒå¦‚ä½•ç»´æŠ¤iptables</title>
      <link>https://www.oomkill.com/2016/10/ch4-iptables-p/</link>
      <pubDate>Sat, 22 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/10/ch4-iptables-p/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>ç”Ÿäº§ä¸­ï¼Œä¸€èˆ¬ç¬¬ä¸€æ¬¡æ·»åŠ è§„åˆ™å‘½ä»¤è¡Œæˆ–è€…è„šæœ¬åŠ å…¥ç„¶åä¸€æ¬¡æ€§ä¿å­˜æˆæ–‡ä»¶ï¼Œç„¶åå¯ä»¥æ”¹é…ç½®æ–‡ä»¶ç®¡ç†ï¼š</p>
<pre><code class="language-bash">$  cat /etc/sysconfig/iptables
# Generated by iptables-save v1.4.7 on Wed Nov 23 09:18:12 2016
*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [115:13341]
-A INPUT -p tcp -m tcp --dport 52113 -j ACCEPT 
COMMIT
# Completed on Wed Nov 23 09:18:12 2016
</code></pre>
<p>ç”Ÿäº§ç»´æŠ¤ï¼š</p>
<p>â‘´ ç¡®å®šè§„åˆ™</p>
<pre><code class="language-sh">vim /etc/sysconfig/iptables
# åŠ å…¥æƒ³è¦çš„è§„åˆ™ï¼šä¾‹å¦‚ï¼š
-A INPUT -p tcp -m tcp --dport 873 -j ACCEPT
/etc/init.d/iptables reload
# æˆ–è€…ä¿®æ”¹é…ç½®çš„åŒæ—¶å‘½ä»¤è¡Œå†æ‰§è¡Œï¼Œä¹Ÿæ˜¯æ°¸ä¹…ç”Ÿæ•ˆ
</code></pre>
<p>â‘µ  å‘½ä»¤è¡Œè¯•é”™ï¼Œæ²¡é—®é¢˜äº†ï¼Œç„¶åæ”¾é…ç½®æ–‡ä»¶ã€‚è¿™æ—¶ä¸éœ€è¦é‡å¯äº†ã€‚</p>
<p>å°IPï¼Œç¬¬ä¸€è¡Œå°ã€‚10.0.0.115 è¿™ä¸ªæœºå™¨æ”»å‡»æˆ‘ä»¬æœåŠ¡å™¨æˆ–è€…åœ¨BBSé‡Œå‘åƒåœ¾å¸–å­ã€‚</p>
<p>æ‰‹å·¥å°IPï¼š</p>
<pre><code class="language-sh">iptables -I INPUT -s 10.0.0.115 -j DROP # èŒƒå›´å¤§ï¼Œå¤–éƒ¨æ”»å‡»è€…ã€‚
iptables -I INPUT -p tcp -s 10.0.0.106 --dport 80 -j DROP # ç»†ï¼ŒèŒƒå›´å° å†…éƒ¨
</code></pre>
<p>è‡ªåŠ¨å°IPï¼šåˆ†æwebæˆ–åº”ç”¨æ—¥å¿—æˆ–è€…ç½‘ç»œè¿æ¥çŠ¶æ€å°æ‰åƒåœ¾IP</p>
<p>è¯¦è§ï¼šshellç¬”è®°</p>
<pre><code class="language-sh">#!/bin/sh

IPT=/sbin/iptables
# remove any existing rules
$IPT -F
$IPT -X
$IPT -Z
#setting default firewall policy
$IP

#setting forloopback interface
$IPT -A INPUT -i lo -j ACCEPT
$IPT -A OUTPUT -o lo -j ACCEPT

# source address spoofing and other bad addresses
$IPT -A INPUT -i eth0 -s 192.168.2.0/24 -j DROP
$IPT -A INPUT -i eth0 -s 0.0.0.0/8 -j DROP

#prevent all stealth scans and tcp state flags
$IPT -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
#All of the bits are cleared
$IPT -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
$IPT -A INPUT -p tcp --tcp-flags ALL,FIN,URG,PSH -j DROP

#SYN and RST are both set
$IPT -A INPUT -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
#SYN and FIN are both set
$IPT -A INPUT -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP

# FIN is the only bit set ,whitout the expected accompanying ACK
$IPT -A INPUT -p tcp --tcp-flags ACK,FIN FIN -j DROP
# PSH is the only bit set ,whitout the expected accompanying ACK
$IPT -A INPUT -p tcp --tcp-flags ACK,PSH PSH -j DROP
# URG is the only bit set ,whitout the expected accompanying ACK
$IPT -A INPUT -p tcp --tcp-flags ACK,URG URG -j DROP

#setting access rules
#one,ip access rules,allow, all the ips of
$IPT -A INPUT -s 10.0.10.0/24 -p tcp --dport 5666 -j ACCEPT
$IPT -A INPUT -s 10.0.0.0/24 -p tcp --dport 5666 -j ACCEPT
#db
$IPT -A INPUT -s 10.0.0.0/24 -p tcp --dport 3306 -j ACCEPT
$IPT -A INPUT -s 10.0.0.0/24 -p tcp --dport 3307 -j ACCEPT
#ssh difference from other servers here
$IPT -A INPUT -s 10.0.0.0/24 -p tcp --dport 52113 -j ACCEPT
$IPT -A INPUT -s 10.0.0.0/24 -p tcp --dport 22 -j ACCEPT
#http
$IPT -A INPUT -p tcp --dport 80 -j ACCEPT
#snmp
$IPT -A INPUT -s 10.0.0.0/24 -p UDP --dport 161 -j ACCEPT
#rsync
$IPT -A INPUT -s 10.0.0.0/24 -p tcp --dport 873 -j ACCEPT
$IPT -A INPUT -s 10.0.10.0/24 -p tcp --dport 873 -j ACCEPT
#icmp
$IPT -A INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
#others RELATED
$IPT -A INPUT  -m state --state ESTABLISHED,RELATED -j ACCEPT
$IPT -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
#setting default firewall rules
$IPT -P OUTPUT ACCEPT
$IPT --policy FORWARD DROP
$IPT --policy INPUT DROP
</code></pre>
<p>æŠ€å·§ï¼šå…·å¤‡å¤–ç½‘IPçš„æœåŠ¡å™¨ä¸Šä¸å¯¹å¤–çš„æœåŠ¡æœ€å¥½è¦åšæºåœ°å€é™åˆ¶ã€‚</p>
<p>Â Â Â Â å¯¹å¤–æä¾›æœåŠ¡ï¼Œä¸èƒ½åšæºåœ°å€é™åˆ¶ï¼Œä¾‹å¦‚ï¼š80ç«¯å£ã€‚</p>
<p><font style="background:#bafe01;" size=2>é—®é¢˜ï¼šä¼ä¸šç¡¬ä»¶é˜²ç«å¢™å’ŒIPTABLESé˜²ç«å¢™æ˜¯å¦è¦åŒæ—¶ç”¨ã€‚</font></p>
<p>è§£å†³ï¼šå¯ä»¥åŒæ—¶ç”¨ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<p>Â Â Â Â ä¼ä¸šç¡¬ä»¶é˜²ç«å¢™ä¸€èˆ¬æ”¾åœ¨ç½‘å…³ä½ç½®ï¼Œç›¸å½“äºå¤§å¦çš„ä¿å®‰ã€‚</p>
<p>Â Â Â Â ä½†æ˜¯ï¼Œæ¥¼é“é‡Œçš„æ¯ä¸ªå±‹å­è¿˜æ˜¯éœ€è¦æœ‰äººæˆ–è€…é”é—¨çš„ï¼ˆiptablesï¼‰</p>
<p><font style="background:#bafe01;" size=2>é—®é¢˜ï¼šIDCæœºæˆ¿éƒ¨ç½²äº†ç¡¬ä»¶é˜²ç«å¢™ï¼Œæˆ‘ä»¬çš„æœåŠ¡å™¨å¯ä»¥ä¸å¼€é˜²ç«å¢™å—ï¼Ÿ</font></p>
<p>â€‹	è§£ç­”ï¼šç»å¯¹ä¸å¯ä»¥ï¼å¤§å¦æœ‰ä¿å®‰ï¼Œä½ çš„åŠå…¬å®¤å°±ä¸é”é—¨ä¹ˆï¼Ÿ</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ch5 é…ç½®ç½‘å…³åŠæœåŠ¡å™¨åœ°å€æ˜ å°„</title>
      <link>https://www.oomkill.com/2016/10/ch5-iptables-nat/</link>
      <pubDate>Sat, 22 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/10/ch5-iptables-nat/</guid>
      <description></description>
      <content:encoded><![CDATA[<h3 id="1-åŠå…¬å®¤è·¯ç”±ç½‘å…³æ¶æ„å›¾">1 åŠå…¬å®¤è·¯ç”±ç½‘å…³æ¶æ„å›¾</h3>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221025002730248.png" alt="image-20221025002730248" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>å¯¹åº”å®é™…ä¼ä¸šåŠå…¬ä¸Šç½‘åœºæ™¯é€»è¾‘å›¾</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed/img/image-20221025002851351.png" alt="image-20221025002851351" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<h3 id="2å®éªŒç¯å¢ƒé…ç½®éœ€æ±‚å‰æœŸå‡†å¤‡">2.å®éªŒç¯å¢ƒé…ç½®éœ€æ±‚å‰æœŸå‡†å¤‡</h3>
<h4 id="21-æœåŠ¡å™¨ç½‘å…³béœ€è¦å‡†å¤‡å¦‚ä¸‹æ¡ä»¶">2.1 æœåŠ¡å™¨ç½‘å…³Béœ€è¦å‡†å¤‡å¦‚ä¸‹æ¡ä»¶</h4>
<blockquote>
<blockquote>
<ol>
<li>ç‰©ç†æ¡ä»¶æ˜¯å…·å¤‡ä¸Šç½‘å¡ï¼Œå»ºè®®eth0å¤–ç½‘åœ°å€ï¼ˆè¿™é‡Œæ˜¯192.168.1.5,gw 192.168.1.2ï¼‰ï¼Œech1å†…ç½‘åœ°å€ï¼ˆè¿™é‡Œæ˜¯172.168.1.10ï¼Œ<font style="background:#bafe01;" size=2>å†…ç½‘å¡ä¸é…GW</font >ã€‚</li>
<li>ç¡®ä¿æœåŠ¡å™¨ç½‘å…³Bè¦å¯ä»¥ä¸Šç½‘ï¼ˆBä¸Šç½‘æ‰èƒ½ä»£ç†åˆ«çš„æœºå™¨ä¸Šç½‘ï¼‰ã€‚å¯ä»¥é€šè¿‡ping baidu.comæˆ–å¤–ç½‘IPæµ‹è¯•ã€‚</li>
<li>å†…æ ¸æ–‡ä»¶/etc/sysctl.confé‡Œå¼€å¯è½¬å‘åŠŸèƒ½ã€‚åœ¨æœåŠ¡å™¨ç½‘å…³B192.168.1.5æœºå™¨ä¸Šå¼€å¯è·¯ç”±è½¬å‘åŠŸèƒ½ã€‚ç¼–è¾‘/etc/sysctl.confä¿®æ”¹å†…å®¹ä¸ºnet.ipv4.ip_forward = 1ï¼Œç„¶åæ‰§è¡Œsysctl -pä½¿ä¿®æ”¹ç”Ÿæ•ˆ</li>
<li>iptablesçš„filterè¡¨çš„FORWARDé“¾å…è®¸è½¬å‘</li>
<li>ä¸è¦filteré˜²ç«å¢™åŠŸèƒ½ï¼Œå…±äº«ä¸Šç½‘ï¼Œå› æ­¤æœ€å¥½æš‚åœé˜²ç«å¢™æµ‹è¯•/etc/init.d/tables stop</li>
</ol>
</blockquote>
</blockquote>
<h4 id="22-åŠ è½½iptableså†…æ ¸æ¨¡å—">2.2 åŠ è½½iptableså†…æ ¸æ¨¡å—</h4>
<p>é…ç½®ç½‘å…³éœ€è¦iptablesçš„natè¡¨ï¼ŒPREROUTINGï¼ŒPOSTROUTINGã€‚</p>
<p><em><strong>(1)è½½å…¥iptableså†…æ ¸æ¨¡å—ï¼Œæ‰§è¡Œå¹¶æ”¾å…¥rc.local</strong></em></p>
<pre><code class="language-bash">modprobe ip_tables \
modprobe iptable_filter \
modprobe iptable_nat \
modprobe ip_conntrack \
modprobe ip_conntrack_ftp \
modprobe ip_nat_ftp \
modprobe ipt_state
</code></pre>
<pre><code class="language-bash">$ lsmod|egrep ^ip 
iptable_nat             6051  0 
iptable_filter          2793  0 
</code></pre>
<h4 id="23-å±€åŸŸç½‘çš„æœºå™¨">2.3 å±€åŸŸç½‘çš„æœºå™¨ï¼š</h4>
<blockquote>
<blockquote>
<ol>
<li>å±€åŸŸç½‘çš„æœºå™¨æœ‰ä¸€å—ç½‘å¡å³å¯ï¼Œç¡®ä¿å±€åŸŸç½‘çš„æœºå™¨Cï¼Œé»˜è®¤ç½‘å…³è¿™åªäº†ç½‘å…³æœåŠ¡å™¨Bçš„eth1å†…ç½‘å¡IPï¼ˆ172.168l.1.10ï¼‰ã€‚æŠŠä¸»æœºCçš„gatewayè®¾ç½®ä¸ºBçš„å†…ç½‘å¡192çš„ç½‘å¡ipå³172.168l.1.10ã€‚</li>
<li>æ£€æŸ¥æ‰‹æ®µï¼š</li>
<li>åˆ†åˆ«pingç½‘å…³æœåŠ¡å™¨Bçš„å†…å¤–ç½‘å¡IPï¼Œéƒ½åº”è¯¥æ˜¯é€šçš„å°±å¯¹äº†.</li>
<li>å‡ºå…¬ç½‘æ£€æŸ¥é™¤äº†PINGç½‘ç«™åŸŸåå¤–ï¼Œä¹Ÿè¦pingä¸‹å¤–ç½‘ipï¼Œæ’é™¤DNSæ•…éšœã€‚ä¸é€š</li>
<li>ping 10.0.0.254ç½‘å…³ä¹Ÿæ˜¯ä¸é€šçš„ã€‚</li>
</ol>
</blockquote>
</blockquote>
<p>å¦‚ä¸Šï¼Œè¯·å‡†å¤‡ä¸¤å°è™šæ‹ŸæœºBå’ŒCï¼Œå…¶ä¸­Bè¦æœ‰åŒç½‘å¡ã€‚Bçš„å†…ç½‘å¡çš„ç½‘æ®µå’ŒCçš„ç½‘æ®µä¸€æ ·ã€‚</p>
<p><em><strong>ç½‘å…³Bï¼šå‡è®¾192.168.1.0/24ä¸ºå¤–éƒ¨IPï¼Œ172.168.1.0/24ä¸ºå†…éƒ¨IP</strong></em></p>
<p>eth0:192.168.1.5   IPADDR=192.168.1.5</p>
<p>gw:192.168.1.2	GATEWAY=192.168.1.2</p>
<p>eth1 	eth1:172.168.1.10</p>
<p><font style="background:#bafe01;" size=2>gwï¼šä¸é…</font></p>
<p>å†…éƒ¨æœåŠ¡å™¨Cï¼š</p>
<p>eth0ï¼š172.168.1.11 	IPADDR=172.168.1.11</p>
<p>gwï¼š172.168.1.10ï¼ˆç½‘å…³Bçš„å†…ç½‘å¡IPï¼‰		GATEWAY=172.168.1.10</p>
<p>å‡†å¤‡ç»“æœï¼š</p>
<p><strong>Bç½‘å…³æœåŠ¡å™¨é…ç½®</strong></p>
<pre><code class="language-bash">$ ifconfig
eth0      Link encap:Ethernet  HWaddr 00:0C:29:31:E5:AF  
          inet addr:192.168.1.4  Bcast:192.168.1.255  Mask:255.255.255.0
 		......
eth1      Link encap:Ethernet  HWaddr 00:0C:29:31:E5:B9  
          inet addr:172.168.1.10  Bcast:172.168.1.255  Mask:255.255.255.0
# è·¯ç”±
$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
172.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth1
169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     1003   0        0 eth1
0.0.0.0         192.168.1.2     0.0.0.0         UG    0      0        0 eth0
</code></pre>
<p><strong>Cä¸ºå†…ç½‘PCæˆ–è€…æœåŠ¡å™¨</strong></p>
<pre><code class="language-bash">$ ifconfig
eth0      Link encap:Ethernet  HWaddr 00:0C:29:BE:2D:75  
          inet addr:172.168.1.11  Bcast:172.168.1.255  Mask:255.255.255.0
....
$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
172.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0
0.0.0.0         172.168.1.10    0.0.0.0         UG    0      0        0 eth0
</code></pre>
<h3 id="3-å…ˆåšä¸€äº›æµ‹è¯•è®°å½•">3 å…ˆåšä¸€äº›æµ‹è¯•è®°å½•</h3>
<p>1.ç™»é™†Cä¸»æœº172.168.1.11çœ‹æ˜¯å¦èƒ½è®¿é—®å¤–éƒ¨é¡µé¢ï¼ˆé…å¥½DNSï¼‰ã€‚å¦‚ping <a href="https://www.baidu.com" target="_blank"
   rel="noopener nofollow noreferrer" >www.baidu.com</a>ã€‚æ­£ç¡®ç»“æœï¼šå½“å‰æƒ…å†µä¸é€š lampä¸º10 lnmpä¸º11</p>
<pre><code class="language-bash">$ ping www.baidu.com
^C
$ ping 61.105.221.1
PING 61.105.221.1 (61.105.221.1) 56(84) bytes of data.
</code></pre>
<p>Â Â Â 2.åœ¨ç¬”è®°æœ¬ä¸Šåˆ†åˆ«æµ‹è¯•telnet 172.168.1.10 22çœ‹æ˜¯å¦èƒ½è¿é€šã€ç»“æœ:å½“å‰æƒ…å†µé€šã€‚</p>
<pre><code class="language-bash">$ telnet 172.168.1.10 80
Trying 172.168.1.10...
Connected to 172.168.1.10.
Escape character is '^]'.	
$  telnet 172.168.1.10 80
Trying 172.168.1.10...
Connected to 172.168.1.10.
Escape character is '^]'
</code></pre>
<ol start="3">
<li>åœ¨ç¬”è®°æœ¬ä¸Šåˆ†åˆ«æµ‹è¯•ping 172.168.1.11çœ‹æ˜¯å¦èƒ½è¿é€šã€‚ç»“æœå½“å‰æƒ…å†µé€šã€‚</li>
<li>æµ‹è¯•ç™»é™†172.168.1.10çœ‹æ˜¯å¦èƒ½è®¿é—®å¤–éƒ¨é¡µé¢ã€‚å¦‚ping <a href="https://www.baidu.com" target="_blank"
   rel="noopener nofollow noreferrer" >www.baidu.com</a>ç»“æœå½“å‰æƒ…å†µé€šã€‚</li>
<li>åœ¨ç¬”è®°æœ¬ä¸Šåˆ†åˆ«æµ‹è¯•telnet Cä¸»æœº 172.168.1.11 22 ç»“æœå½“å‰æƒ…å†µä¸é€šã€‚</li>
<li>åœ¨ç¬”è®°æœ¬ä¸Šåˆ†åˆ«æµ‹è¯•ping 172.168.1.11çœ‹æ˜¯å¦èƒ½è¿é€šã€‚ç»“æœå½“å‰æƒ…å†µä¸é€šã€‚</li>
</ol>
<h3 id="4-æ ¹æ®é€»è¾‘å›¾å®ç°å¦‚ä¸‹è¦æ±‚">4 æ ¹æ®é€»è¾‘å›¾å®ç°å¦‚ä¸‹è¦æ±‚</h3>
<h4 id="41-å±€åŸŸç½‘å…±äº«ä¸Šç½‘é¡¹ç›®æ¡ˆä¾‹">4.1 å±€åŸŸç½‘å…±äº«ä¸Šç½‘é¡¹ç›®æ¡ˆä¾‹</h4>
<p>1.å®ç°cå¯ç»è¿‡bï¼Œé€šè¿‡Aä¸Šå› ç‰¹ç½‘ã€‚
è§£ç­”ï¼šæç¤º2:æ³¨æ„ä¸»æœºé˜²ç«å¢™åŠŸèƒ½çš„å½±å“ï¼Œå¯ä»¥å°è¯•åœ¨GWä¸Šå…ˆ/etc/init.d/iptables stopååœ¨åŠ å‘½ä»¤</p>
<p>2.å®é™…å¤„ç†çš„å±€åŸŸç½‘å…±äº«ä¸Šç½‘NATå‘½ä»¤
å±€åŸŸç½‘å…±äº«çš„ä¸¤æ¡å‘½ä»¤æ–¹æ³•ï¼š</p>
<p><em><strong>æ–¹æ³•1ï¼šé€‚åˆäºæœ‰å›ºå®šipå¤–ç½‘åœ°å€çš„</strong>ï¼š</em></p>
<pre><code class="language-bash">iptables -t nat -A POSTROUTING -s 172.168.1.0/24 -o eth0 -j SNAT --to-source 192.168.1.4
</code></pre>
<blockquote>
<ol>
<li>-s 172.168.1.0/24åŠå…¬å®¤æˆ–IDCã€å†…ç½‘ç½‘æ®µã€‚</li>
<li>-o eth0 ä¸ºç½‘å…³çš„å¤–ç½‘å¡æ¥å£ã€‚</li>
<li>-j SNAT &ndash;to-source 192.168.1.4æ˜¯ç½‘å…³å¤–ç½‘å¡IPåœ°å€ã€‚</li>
</ol>
</blockquote>
<p><strong>æ–¹æ³•2ï¼šé€‚åˆå˜åŒ–å¤–ç½‘åœ°å€ï¼ˆADSLï¼‰</strong></p>
<pre><code class="language-bash">iptables -t nat -A POSTROUTING -s 172.168.1.0/24 -j MASQUERADE
</code></pre>
<p>æµ‹è¯•ç»“æœ</p>
<pre><code class="language-bash">$ ping www.baidu.com
PING www.a.shifen.com (58.217.200.112) 56(84) bytes of data.
64 bytes from 58.217.200.112: icmp_seq=1 ttl=127 time=32.1 ms

$ iptables -t nat -nL
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination         

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination         
SNAT       all  --  172.168.1.0/24       0.0.0.0/0           to:192.168.1.4 
</code></pre>
<p><strong>ä¸ºä»€ä¹ˆè¦ç”¨POSTROUTINGï¼Ÿ</strong></p>
<p>ä¼ä¸šå…±äº«ä¸Šç½‘ï¼š</p>
<p>1.åŠå…¬ç½‘å…±äº«ä¸Šç½‘ï¼ˆç½‘å…³è¦æœ‰å¤–ç½‘IPï¼Œå¦åˆ™ç”¨è·¯ç”±ï¼ˆzebraï¼‰ï¼‰</p>
<p>2.IDCå†…ç½‘æœºå™¨ä¸Šç½‘</p>
<p><em><strong>ä¼ä¸šä¸Šç½‘åˆ°åº•éœ€è¦ä¸éœ€è¦linuxç½‘å…³ï¼Ÿ</strong></em></p>
<p>è§£ç­”ï¼š</p>
<ol>
<li>å¦‚æœä¼ä¸šé‡Œæœ‰ä¼ä¸šçº§è·¯ç”±å™¨çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¸éœ€è¦ä¸Šç½‘ç½‘å…³ã€‚ä½¿ç”¨ç½‘å…³åªæ˜¯è§£å†³è·¯ç”±å™¨æ— æ³•è§£å†³çš„éœ€æ±‚ï¼ˆä¾‹å¦‚ï¼šä¸Šç½‘è¡Œä¸ºï¼ŒIPåŠç«¯å£çš„æ˜ å°„ï¼Œç½‘å…³æ€æ¯’ï¼‰ã€‚</li>
<li>IDCæœºæˆ¿ï¼Œå¤§å¦æœ‰å›ºå®šIPçš„å®½å¸¦ï¼Œç›´æ¥ç”¨ç½‘å…³è§£å†³ä¸Šç½‘åŠæ§åˆ¶é—®é¢˜ã€‚</li>
</ol>
<h4 id="42-æŠŠå¤–éƒ¨ipåœ°å€åŠç«¯å£æ˜ å°„åˆ°å†…éƒ¨æœåŠ¡å™¨åœ°å€åŠç«¯å£å’Œè´¡çŒ®ä¸Šç½‘ç¯å¢ƒä¸€æ ·">4.2 æŠŠå¤–éƒ¨IPåœ°å€åŠç«¯å£æ˜ å°„åˆ°å†…éƒ¨æœåŠ¡å™¨åœ°å€åŠç«¯å£ï¼ˆå’Œè´¡çŒ®ä¸Šç½‘ç¯å¢ƒä¸€æ ·ï¼‰</h4>
<p>åœ¨10æ®µä¸»æœºå¯ä»¥é€šè¿‡è®¿é—®192.168.1.4:80ï¼Œå³å¯è®¿é—®åˆ°192.168.1.8:9000 æä¾›çš„webæœåŠ¡ã€‚ä¹Ÿå¯SSHï¼ˆ192.168.1.4:222 &ndash;&gt; 192.168.1.8:52113ï¼‰&lt;== PREROUTING</p>
<p><strong>Cé…ç½®WEBæœåŠ¡å™¨</strong></p>
<p>è§£ç­”ï¼š</p>
<p>â‘´ åœ¨172.168.1.10å¼€å¯httpæœåŠ¡ç›‘å¬9000ç«¯å£ï¼Œç„¶ååœ¨ç½‘å…³æœåŠ¡å™¨Bå¯ä»¥è®¿é—®</p>
<p>â‘µ å…·ä½“è½¬æ¢å‘½ä»¤ï¼š</p>
<pre><code class="language-bash">iptables -t nat -A PREROUTING -d 192.168.1.5 -p tcp --dport 9000 -j DNAT --to-destination 172.168.1.11:80
# DNATï¼šç›®çš„åœ°å€è½¬æ¢ï¼Œå°†å°†æœ¬åœ°å†…éƒ¨çš„åœ°å€æ˜ å°„åˆ°äº’è”ç½‘åœ°å€
</code></pre>
<p><strong>æµ‹è¯•ç»“æœ</strong></p>
<p><em>æ¸…ç©ºNATè¡¨çš„è§„åˆ™ã€‚</em></p>
<pre><code class="language-bash">iptables -t nat -F
</code></pre>
<p>è¿™ä¸ªæ—¶å€™è®¿é—®83çš„9000ç«¯å£æ˜¯ä¸èƒ½è®¿é—®çš„</p>
<pre><code class="language-bash">iptables -t nat -A PREROUTING -d 192.168.2.83 -p tcp --dport 9000 -j DNAT --to-destination 172.168.1.11:80
</code></pre>
<p>è¿™é‡Œçœ‹åˆ°è®¿é—®192.168.1.5çš„9000ç«¯å£å°±ä¼šæ˜ å°„åˆ°å†…ç½‘172.168.1.11çš„80ä¸Šã€‚</p>
<h4 id="sshè½¬å‘å®éªŒ">sshè½¬å‘å®éªŒ</h4>
<pre><code class="language-bash"># ç½‘å…³A IP 192.168.2.83 å†…ç½‘IP 172.168.1.10
$ ifconfig
eth0      Link encap:Ethernet  HWaddr 00:0C:29:AF:21:4F  
          inet addr:192.168.2.83  Bcast:192.168.2.255  Mask:255.255.255.0
eth1      Link encap:Ethernet  HWaddr 00:50:56:20:37:C2  
          inet addr:172.168.1.10  Bcast:172.168.1.255  Mask:255.255.255.0
# åœ¨ç½‘å…³ä¸Šè®¾ç½®è½¬å‘
iptables -t nat -I PREROUTING  -p tcp -m tcp --dport 9020 -j DNAT --to-destination 172.168.1.11:52113
# ç”¨å¤–ç½‘è®¿é—®ç½‘å…³å¤–ç½‘IP
$ ssh -p 9020 192.168.2.83
.....
root@192.168.2.83's password: 
Last login: Mon Dec 12 22:24:58 2016 from 192.168.2.84
$ ifconfig
          inet addr:172.168.1.11  Bcast:172.168.1.255  Mask:255.255.255.0
</code></pre>
<p>å¼ºè°ƒï¼šæœ‰ä¸ªç½‘å‹è¯´ç½‘å…³æœåŠ¡éœ€è¦å¼€å¯80æœåŠ¡ï¼Œä½†ä¸éœ€è¦å¯¹å¤–æœåŠ¡ï¼Ÿ</p>
<p>æµ‹è¯•ç»“æœï¼šç½‘å…³å¼€å¯httpd:80åã€‚</p>
<p>æ­¤æ—¶ï¼Œæ¥è‡ª80ç«¯å£çš„è¯·æ±‚è½¬å‘ä¾ç„¶ä¼šè½¬å‘åˆ°åç«¯çš„æœåŠ¡å™¨ã€‚ä½†æ˜¯iptables natè§„åˆ™åˆ é™¤åï¼Œæ­¤æ—¶å°±åˆ°è¾¾äº†httpæœåŠ¡çš„80ç«¯å£æ‰€ä»¥æ˜¾ç¤ºçš„æ˜¯é»˜è®¤é¡µé¢ã€‚</p>
<p><strong>ä¼ä¸šåº”ç”¨åœºæ™¯</strong>ï¼š</p>
<ol>
<li>æŠŠè®¿é—®å¤–ç½‘IPåŠè¯»ç ”å£çš„è¯·æ±‚æ˜ å°„åˆ°å†…ç½‘æŸä¸ªæœåŠ¡å™¨åŠç«¯å£ï¼ˆä¼ä¸šå†…éƒ¨ï¼‰ã€‚</li>
<li>ç¡¬ä»¶é˜²ç«å¢™ï¼ŒæŠŠè®¿é—®LVS/nginxå¤–ç½‘VIPåŠ80ç«¯å£çš„è¯·æ±‚æ˜ å°„åˆ°IDCè´Ÿè½½å‡è¡¡å™¨å†…éƒ¨IPåŠç«¯å£ä¸Šï¼ˆIDCæœºæˆ¿çš„æ“ä½œï¼‰</li>
</ol>
<p><strong>iptablesä¼ä¸šå¸¸ç”¨æ¡ˆä¾‹</strong>ï¼š</p>
<ol>
<li>lnuxä¸»æœºé˜²ç«å¢™ï¼ˆè¡¨FILTER INPUTé“¾ï¼‰</li>
<li>å±€åŸŸç½‘æœºå™¨å…±äº«ä¸Šç½‘ï¼ˆè¡¨ï¼šNAT POSTROUTINGé“¾ï¼‰</li>
</ol>
<pre><code class="language-bash">iptables -t nat -A POSTROUTING -s 172.168.1.0/24 -o eth0 -j SNAT --to-source 192.168.1.5
</code></pre>
<ol start="3">
<li>å¤–éƒ¨åœ°å€å’Œç«¯å£ï¼Œæ˜ å°„ä¸ºå†…éƒ¨åœ°å€å’Œç«¯å£ï¼ˆè¡¨ï¼šNAT PREROUTINGï¼‰</li>
</ol>
<pre><code class="language-bash">iptables -t nat -A PREROUTING -d 192.168.1.5 -p tcp --dport 80 -j DNAT --to-destination 172.168.1.11:9000
</code></pre>
<h4 id="43-å®ç°192æ®µå¤–ç½‘ipå’Œ172æ®µå†…ç½‘ipä¸€å¯¹ä¸€æ˜ å°„">4.3 å®ç°192æ®µå¤–ç½‘IPå’Œ172æ®µå†…ç½‘IPä¸€å¯¹ä¸€æ˜ å°„</h4>
<p>ç½‘å…³IPï¼šeth0:192.168.1.5 ech1:172.168.1.10</p>
<p>é¦–å…ˆåœ¨è·¯ç”±ç½‘å…³ä¸Šç»‘å®šæ¥å£å¤–ç½‘ipï¼Œå¯ä»¥æ˜¯åˆ«åçš„æ–¹å¼ã€‚</p>
<pre><code class="language-bash"># è®¿é—®å¤–ç½‘IPå°±æ˜ å°„åˆ°0.8
-A PREROUTING -d 124.42.34.112 -j DNAT --to-destination 10.0.0.8
# å‡ºç½‘æ—¶å€™æ”¹å›å»
-A POSTROUTING -s 10.0.0.8 -j SNAT --to-destination 124.42.34.112
# å½“å±€åŸŸç½‘ä½¿ç”¨å¤–ç½‘IPè®¿é—®è¿™å°æœºå™¨ï¼Œä¼šå‡ºç°é—®é¢˜ï¼Œåªè¦æ˜¯å±€åŸŸç½‘è®¿é—®è¿™ä¸ªåœ°å€ï¼Œå†²å®šå‘åˆ°ç½‘å…³ï¼Œé˜²æ­¢å¯èƒ½ç¯è·¯
-A POSTROUTING -s 10.0.0.0/255.255.240.0 -d 124.42.34.112 -j SNAT --to-source 10.0.0.254
</code></pre>
<h4 id="44-å®ç°192æ®µæœºå™¨å’Œ10æ®µæœºå™¨äº’ç›¸è®¿é—®">4.4 å®ç°192æ®µæœºå™¨å’Œ10æ®µæœºå™¨äº’ç›¸è®¿é—®</h4>
<p><a href="http://v.youku.com/v_show/id_XNTAyMjAwMzI0.html" target="_blank"
   rel="noopener nofollow noreferrer" >http://v.youku.com/v_show/id_XNTAyMjAwMzI0.html</a></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ch6 iptablesç”Ÿäº§åº”ç”¨åœºæ™¯</title>
      <link>https://www.oomkill.com/2016/10/ch6-iptables-application/</link>
      <pubDate>Sat, 22 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/10/ch6-iptables-application/</guid>
      <description></description>
      <content:encoded><![CDATA[<blockquote>
<p>1ã€å±€åŸŸç½‘å…±äº«ä¸Šç½‘ï¼ˆé€‚åˆåšä¼ä¸šå†…éƒ¨å±€åŸŸç½‘ä¸Šç½‘ç½‘å…³ï¼Œä»¥åŠIDCæœºæˆ¿å†…ç½‘çš„ä¸Šç½‘ç½‘å…³ nat POSTROUTINGï¼‰</p>
</blockquote>
<blockquote>
<p>2ã€æœåŠ¡å™¨é˜²ç«å¢™åŠŸèƒ½ï¼ˆé€‚åˆIDCæœºæˆ¿å…·æœ‰å¤–ç½‘IPæœåŠ¡å™¨ï¼Œä¸»è¦æ˜¯filter INPUTçš„æ§åˆ¶ï¼‰</p>
</blockquote>
<blockquote>
<p>3ã€æŠŠå¤–éƒ¨IPåŠç«¯å£æ˜ å°„åˆ°å±€åŸŸç½‘å†…éƒ¨ï¼ˆå¯ä»¥ä¸€å¯¹ä¸€IPæ˜ å°„ï¼Œä¹Ÿå¯é’ˆå¯¹æŸä¸€ä¸ªç«¯å£æ˜ å°„ã€‚ï¼‰</p>
<p>ä¹Ÿå¯èƒ½æ˜¯IDCæŠŠç½‘ç«™çš„å¤–ç½‘VIPçº§ç½‘ç«™ç«¯å£æ˜ å°„åˆ°è´Ÿè½½å‡è¡¡å™¨ä¸Šï¼ˆç¡¬ä»¶é˜²ç«å¢™ï¼‰ï¼ˆNAT PREROUTINGï¼‰</p>
</blockquote>
<blockquote>
<p>4ã€åŠå…¬è·¯ç”±å™¨+ç½‘å…³åŠŸèƒ½ï¼ˆzebraè·¯ç”±+iptablesè¿‡æ»¤åŠNAT+squidæ­£å‘é€æ˜ä»£ç†80+ntop/iftop/iptafæµé‡æŸ¥çœ‹+tc/cbqæµé‡æ§åˆ¶é™é€Ÿï¼‰ã€‚</p>
</blockquote>
<blockquote>
<p>5ã€é‚®ä»¶çš„ç½‘å…³ã€‚</p>
</blockquote>
<p><font style="background:#bafe01;" size=2>é—®é¢˜2ï¼šçš„ç”Ÿäº§ç¯å¢ƒåº”ç”¨ï¼šç”¨äºæ²¡æœ‰å¤–ç½‘åœ°å€çš„å†…ç½‘æœåŠ¡å™¨ï¼Œæ˜ å°„ä¸ºå…¬ç½‘IPåå¯¹å¤–æä¾›æœåŠ¡ï¼Œä¹ŸåŒ…æ‹¬ç«¯å£çš„æ˜ å°„</font></p>
<p><font style="background:#bafe01;" size=2>é—®é¢˜3ï¼šIPä¸€å¯¹ä¸€æ˜ å°„</font>
ç”¨äºæ²¡æœ‰å¤–ç½‘åœ°å€çš„å†…ç½‘æœåŠ¡å™¨ï¼Œæ˜ å°„ä¸ºå…¬ç½‘IPåå¯¹å¤–æä¾›æœåŠ¡ï¼Œä¾‹å¦‚ï¼šftpæœåŠ¡è¦ä¸€å¯¹ä¸€IPæ˜ å°„ã€‚</p>
<p>å…±äº«ä¸Šç½‘å°IPçš„æ–¹æ³•ï¼š</p>
<pre><code class="language-bash">/sbin/iptables -I FROWAED -s 10.0.0.26 -jã€€DROP
/sbin/iptables ${deal} FROWARD -m mac --mac -source ${strIpMac} -j DROP
</code></pre>
<h4 id="æ˜ å°„å¤šä¸ªå¤–ç½‘ipä¸Šç½‘">æ˜ å°„å¤šä¸ªå¤–ç½‘IPä¸Šç½‘</h4>
<pre><code class="language-bash">iptables -t nat -A POSTROUTING -s 10.0.1.0/255.255.240.0 -o eth0 -j SNAT --to-source 124.42.60.11-124.42.60.16
iptables -t nat -A POSTROUTING -s 172.168.1.0/255.255.255.0 -o eth0 -j SNAT --to=source 124.42.60.60-124.42.60.63
</code></pre>
<p>é—®é¢˜ï¼šå…¬å¸å†…ç½‘ä¸»æœºå¤šçš„æ—¶å€™ï¼Œè®¿é—®ç½‘ç«™å®¹æ˜“è¢«å°ã€‚</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>ch7 å…³äºiptablesçš„å†…æ ¸å‚æ•°</title>
      <link>https://www.oomkill.com/2016/10/ch7-iptables-kernel-parameter/</link>
      <pubDate>Sat, 22 Oct 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/10/ch7-iptables-kernel-parameter/</guid>
      <description></description>
      <content:encoded><![CDATA[<p>è°ƒæ•´å†…æ ¸å‚æ•°æ–‡ä»¶/etc/sysctl.confï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒçš„æŸä¸ªæœåŠ¡å™¨çš„é…ç½®ï¼š</p>
<pre><code class="language-bash"># è¡¨ç¤ºå¦‚æœå¥—æ¥å­—ç”±æœ¬ç«¯è¦æ±‚å…³é—­ï¼Œè¿™ä¸ªæª€æ ‘å†³å®šäº†ä»–ä¿æŒåœ¨FIN-WAIT-2çŠ¶æ€çš„æ—¶é—´ã€‚
net.ipv4.tcp_fin_timeout = 2
# è¡¨ç¤ºå¼€å¯é‡ç”¨ã€‚å…è®¸å°†TIME-WAIT socketsé‡æ–°ç”¨äºæ–°çš„TCPè¿æ¥ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­ã€‚
net.ipv4.tcp_tw_reuse = 1
# è¡¨ç¤ºå¼€å¯TCPè¿æ¥ä¸­TIME-WAIT socketçš„å¿«é€Ÿæ”¶å›ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­
net.ipv4.tcp_tw_recycle = 1
æç¤ºï¼šä»¥ä¸Šä¸¤ä¸ªå‚æ•°ä¸ºäº†é˜²æ­¢ç”Ÿäº§ç¯å¢ƒä¸‹ time_waitè¿‡å¤šè®¾ç½®çš„ã€‚
############################################################
# è¡¨ç¤ºå¼€å¯SYN Cookieã€‚å½“å‡ºç°SYNç­‰å¸¦é˜Ÿåˆ—æº¢å‡ºæ—¶ï¼Œå¯åŠ¨cookieæ¥å¤„ç†ï¼Œå¯é˜²èŒƒå°‘é‡SYNæ”»å‡»ï¼Œé»˜è®¤ä¸º0è¡¨ç¤ºå…³é—­
net.ipv4.tcp_syncookies = 1
# è¡¨ç¤ºå½“keepaliveèµ·ç”¨çš„æ—¶å€™ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ã€‚ç¼ºçœæ˜¯ä¸¤å°æ—¶ï¼Œæ”¹ä¸º20åˆ†é’Ÿ å•ä½ç§’
net.ipv4.tcp_keepalive_time = 1200
# è¡¨ç¤ºå¯¹ç”¨å‘å¤–è¿æ¥çš„ç«¯å£èŒƒå›´ã€‚ç¼ºçœæƒ…å†µä¸‹å¾ˆå°ã€‚
net.ipv4.ip_local_port_range = 4000  65000
# è¡¨ç¤ºSYNé˜Ÿåˆ—çš„é•¿åº¦ï¼Œé»˜è®¤ä¸º1024ï¼ŒåŠ å¤§é˜Ÿåˆ—é•¿åº¦ä¸º8192ï¼Œå¯å®¹çº³æ›´è¿‡ç­‰å¾…è¿æ¥çš„ç½‘ç»œè¿æ¥æ•°ã€‚
net.ipv4.tcp_max_syn_backlog = 16384
# è¡¨ç¤ºç³»ç»ŸåŒæ—¶ä¿æŒTIME_WAITå¥—æ¥å­—çš„æœ€å¤§æ•°é‡ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼ŒTIME_WAITå¥—æ¥å­—å°†ç«‹åˆ»è¢«æ¸…æ¥šå¹¶æ‰“å°è­¦å‘Šä¿¡æ¯ã€‚é»˜è®¤ä¸º180000ï¼Œå¯¹äºApache Nginxç­‰æœåŠ¡å™¨æ¥è¯´å¯ä»¥è°ƒä½ä¸€ç‚¹ï¼Œå¦‚ï¼šæ”¹ä¸º5000-30000ï¼Œä¸åŒä¸šåŠ¡çš„æœåŠ¡å™¨ä¹Ÿå¯ä»¥ç»™å¤§ä¸€ç‚¹ï¼Œæ¯”å¦‚LVSï¼Œsquid
ä»¥ä¸Šå‡ è¡Œçš„å‚æ•°å¯ä»¥å¾ˆå¥½çš„å‡å°‘TIME_WAITå¥—æ¥å­—æ•°é‡ï¼Œä½†å¯¹äºsquidæ•ˆæœå´ä¸å¤§ã€‚
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.route.gc_timeout = 100
net.ipv4.tcp_syn_retries = 1
net.ipv4.tcp_synack_retries = 1
# ä»¥ä¸‹å‚æ•°æ˜¯å¯¹iptablesé˜²ç«å¢™çš„ä¼˜åŒ–ï¼Œé˜²ç«å¢™ä¸ä¼šå¼€æç¤ºï¼Œå¯ä»¥å¿½ç•¥ä¸ç†ã€‚
net.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_tcp_timeout_established = 180
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
</code></pre>
<p>dmesgé‡Œé¢æ˜¾ç¤º <code>ip_contrack:table full</code>ï¼Œ``dropping packet.` çš„é”™è¯¯æç¤ºï¼Œå¦‚ä½•è§£å†³?</p>
<p>è¿™æœ‰ä¸¤ä¸ªå¯èƒ½ï¼Œä¸€ä¸ªæ˜¯æ‰“å¼€çš„ç«¯å£å¤ªå°‘è‡³ä¸å¤Ÿç”¨ï¼Œä¿®æ”¹ip_conntrackæ–‡ä»¶ä¸º1024 65535ã€‚</p>
<p>è¿˜æœ‰ä¸€ä¸ªåŸå› æ˜¯naté“¾æ¥çœŸçš„è¾¾åˆ°65535äº†ã€‚æ­¤æ—¶å°±æŠŠNATæ˜ å°„è¡¨ä¿æŒæ—¶é—´è®¾ç½®çŸ­ä¸€äº›ã€‚</p>
<p><strong>å¼ºè°ƒ</strong>ï¼šå¦‚æœå¹¶å‘æ¯”è¾ƒå¤§ï¼Œæˆ–è€…æ—¥PVå¤šçš„æƒ…å†µä¸‹ï¼Œå¼€å¯é˜²ç«å¢™è¦æ³¨æ„ï¼Œå¾ˆå¯èƒ½å¯¼è‡´ç½‘ç«™è®¿é—®ç¼“æ…¢ã€‚</p>
<p>å¤§å¹¶å‘ï¼ˆå¹¶å‘1ä¸‡ï¼ŒPVæ—¥3000ä¸‡ï¼‰è¦ä¹ˆè´­ä¹°ç¡¬ä»¶é˜²ç«å¢™ï¼Œè¦ä¹ˆä¸å¼€iptablesé˜²ç«å¢™ã€‚</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>SSHæœåŠ¡è¯¦è§£</title>
      <link>https://www.oomkill.com/2016/08/ssh-service/</link>
      <pubDate>Fri, 05 Aug 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/08/ssh-service/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯-ssh-">ä»€ä¹ˆæ˜¯ SSH ï¼Ÿ</h2>
<p>SSHå…¨ç§°(<font color="#f8070d" size=3><strong>S</strong></font>ecure<font color="#f8070d" size=3><strong>SH</strong></font>ell)æ˜¯ä¸€ç§ç½‘ç»œåè®®ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯éå¸¸å®‰å…¨çš„shellï¼Œä¸»è¦ç”¨äºè®¡ç®—æœºé—´åŠ å¯†ä¼ è¾“ã€‚æ—©æœŸï¼Œäº’è”ç½‘é€šä¿¡éƒ½æ˜¯åŸºäºæ˜æ–‡é€šä¿¡ï¼Œä¸€æ—¦è¢«æˆªè·ï¼Œå†…å®¹å°±æš´éœ²æ— é—ã€‚1995å¹´ï¼ŒèŠ¬å…°å­¦è€…Tatu Ylonenè®¾è®¡äº†SSHåè®®ï¼Œå°†ç™»å½•ä¿¡æ¯å…¨éƒ¨åŠ å¯†ï¼Œæˆä¸ºäº’è”ç½‘å®‰å…¨çš„ä¸€ä¸ªåŸºæœ¬è§£å†³æ–¹æ¡ˆï¼Œè¿…é€Ÿåœ¨å…¨ä¸–ç•Œè·å¾—æ¨å¹¿ï¼Œç›®å‰å·²ç»æˆä¸ºLinuxç³»ç»Ÿçš„æ ‡å‡†é…ç½®ã€‚</p>
<p>SSHæœåŠ¡æ˜¯ç”±OpenSSHæœåŠ¡ç«¯è½¯ä»¶OpenSSHå’Œå®¢æˆ·ç«¯ï¼ˆå¸¸è§çš„ç”±SSHï¼ŒSecureCRTï¼ŒXshellï¼Œputtyï¼‰ç»„æˆï¼Œé»˜è®¤ä½¿ç”¨<font color="#f8070d" size=3><strong>22</strong></font>ç«¯å£æä¾›æœåŠ¡ï¼Œæœ‰ä¸¤ä¸ªä¸å…¼å®¹çš„sshåè®®ç‰ˆæœ¬ï¼Œåˆ†åˆ«ä¸º1.xå’Œ2.xã€‚</p>
<p>SSHåè®®ç›®å‰æœ‰SSH1å’ŒSSH2ä¸¤ä¸ªä¸»æµç‰ˆæœ¬ï¼ŒSSH2åè®®å…¼å®¹SSH1ï¼Œå¼ºçƒˆå»ºè®®ä½¿ç”¨SSH2ç‰ˆæœ¬ã€‚ç›®å‰å®ç°SSH1å’ŒSSH2åè®®çš„ä¸»è¦è½¯ä»¶æœ‰OpenSSH å’ŒSSH Communications Security Corporationã€€å…¬å¸çš„SSH Communications è½¯ä»¶ã€‚å‰è€…æ˜¯OpenBSDç»„ç»‡å¼€å‘çš„ä¸€æ¬¾å…è´¹çš„SSHè½¯ä»¶ï¼Œåè€…æ˜¯å•†ä¸šè½¯ä»¶ï¼Œå› æ­¤åœ¨linuxã€FreeBSDã€OpenBSD ã€NetBSDç­‰å…è´¹ç±»UNIXç³»ç»Ÿç§ï¼Œé€šå¸¸éƒ½ä½¿ç”¨OpenSSHä½œä¸ºSSHåè®®çš„å®ç°è½¯ä»¶ã€‚</p>
<pre><code class="language-sh">$ rpm -qa openssh openssl
openssl-1.0.1e-30.el6.x86_64
openssh-5.3p1-104.el6.x86_64
</code></pre>
<blockquote>
<p><strong>SSH1.x</strong></p>
</blockquote>
<p>æ¯å°sshæœåŠ¡å™¨ä¸»æœºéƒ½å¯ä»¥ä½¿ç”¨rsaåŠ å¯†æ–¹å¼æ¥äº§ç”Ÿä¸€ä¸ª1024bitçš„RSAKeyï¼Œè¿™ä¸ªRSAçš„åŠ å¯†æ–¹å¼å°±æ˜¯ç”¨æ¥äº§ç”Ÿå…¬é’¥ä¸ç§é’¥çš„ç®—æ³•ä¹‹ä¸€ï¼ŒSSH1.xçš„æ•´ä¸ªè”æœºåŠ å¯†æ­¥éª¤å¦‚ä¸‹ï¼š
å½“SSHæœåŠ¡å¯åŠ¨æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª768-bitçš„ä¸´æ—¶å…¬é’¥ï¼ˆsshd_configé…ç½®æ–‡ä»¶ä¸­ServerKeyBits 768ï¼‰å­˜æ”¾åœ¨serverä¸­</p>
<pre><code class="language-sh"># centos5ä¸º768 centos6ä¸º1024
$ grep ServerKey /etc/ssh/sshd_config 
#ServerKeyBits 1024
</code></pre>
<p>å½“å®¢æˆ·ç«¯è”æœºè¯·æ±‚ä¼ é€è¿‡æ¥æ—¶ï¼ŒæœåŠ¡å™¨å°±ä¼šå°†è¿™ä¸ª768-bitçš„å…¬é’¥ä¼ ç»™å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¼šå°†æ­¤å…¬é’¥ä¸å…ˆå‰å­˜å‚¨çš„å…¬é’¥è¿›è¡Œå¯¹æ¯”ï¼Œçœ‹æ˜¯å¦ä¸€è‡´ã€‚åˆ¤æ–­æ ‡å‡†æ˜¯æœåŠ¡å™¨ç«¯è”æœºç”¨æˆ·ç›®å½•ä¸‹~/.ssh/know_hostsæ–‡ä»¶çš„å†…å®¹ï¼ˆlinuxå®¢æˆ·ç«¯ï¼‰</p>
<pre><code class="language-sh">$ ssh -p22 lamp@192.168.65.62
$ ll .ssh/known_hosts 
-rw-r--r--. 1 root root 395 Jun 16 13:15 .ssh/known_hosts
</code></pre>
<p>windows SecureCRTå›¾ç¤º
åœ¨å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿™ä¸ª768-bitçš„Server Keyåï¼Œå®¢æˆ·ç«¯æœ¬åœ°ä¹Ÿä¼šäº§ç”Ÿä¸€ä¸ª256bitçš„ç§é’¥ï¼ˆprivate keyæˆ–host keyï¼‰ï¼Œå¹¶ä¸”ä»¥åŠ å¯†çš„æ–¹å¼ï¼ˆå…·ä½“çš„åŠ å¯†ç®—æ³•ç”±å®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨æä¾›çš„æ‰€æœ‰å¯ç”¨ç®—æ³•ä¸­é€‰æ‹©ï¼Œé»˜è®¤ä¸º3DESç®—æ³•ï¼‰ï¼Œå°†Server keyä¸host</p>
<h2 id="sshd_configé…ç½®æ–‡ä»¶è¯¦è§£">SSHD_CONFIGé…ç½®æ–‡ä»¶è¯¦è§£</h2>
<table>
<thead>
<tr>
<th>å‚æ•°é€‰é¡¹</th>
<th>æ³¨é‡Šè¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Port <em>Num</em></td>
<td>æŒ‡å®šsshdæœåŠ¡å™¨ä¾¦å¬ç«¯å£numã€‚å°†numæ”¹æˆéæ ‡å‡†ç«¯å£å¯ä»¥æé«˜å®‰å…¨æ€§ã€‚é»˜è®¤ç«¯å£ä¸º22ã€‚</td>
</tr>
<tr>
<td>Protocol 1|2|2,1</td>
<td>æŒ‡å®š sshd æ”¯æŒçš„SSHåè®®çš„ç‰ˆæœ¬å·ã€‚<code>'1'</code>å’Œ<code>'2'</code>è¡¨ç¤ºä»…ä»…æ”¯æŒSSH-1å’ŒSSH-2åè®®ã€‚<code>&quot;2,1&quot;</code>è¡¨ç¤ºåŒæ—¶æ”¯æŒSSH-1å’ŒSSH-2åè®®ã€‚</td>
</tr>
<tr>
<td>PubkeyAuthentication</td>
<td>æ˜¯å¦å…è®¸å…¬é’¥è®¤è¯ã€‚ä»…å¯ä»¥ç”¨äºSSH-2ã€‚é»˜è®¤å€¼ä¸º<font color="#f8070d" size=3><code>&quot;yes&quot;</code></font>ã€‚</td>
</tr>
<tr>
<td>ListenAddress 0.0.0.0</td>
<td>ç›‘å¬çš„IPï¼Œé»˜è®¤ç›‘å¬æ‰€æœ‰åœ°å€ï¼ˆå¯æŒ‡å®šå¤šä¸ªç›‘å¬çš„åœ°å€ï¼‰ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š<br>ListenAddress<br>  host | IPv4_addr | IPv6_addr<br>  ListenAddress host | IPv4_addr:port<br> ListenAddress [host|IPv6_addr]:port<br>ä¸¾ä¾‹è¯´æ˜ï¼šå¦‚æœæ‚¨æœ‰ä¸¤ä¸ª IPï¼Œåˆ†åˆ«æ˜¯ 192.168.0.100 åŠ 192.168.2.20 ï¼Œé‚£ä¹ˆåªæƒ³è¦å¼€æ”¾ 192.168.0.100 æ—¶ï¼Œå°±å¯ä»¥å†™å¦‚åŒä¸‹é¢çš„æ ·å¼ï¼šListenAddress 192.168.0.100åªç›‘å¬æ¥è‡ª 192.168.0.100 è¿™ä¸ª IP çš„SSHè”æœºã€‚</td>
</tr>
<tr>
<td>HostKey /etc/ssh/ssh_host_key</td>
<td>SSH version 1 ä½¿ç”¨çš„ç§é’¥</td>
</tr>
<tr>
<td>HostKey /etc/ssh/ssh_host_rsa_key</td>
<td>SSH version 2 ä½¿ç”¨çš„ RSA ç§é’¥</td>
</tr>
<tr>
<td>HostKey /etc/ssh/ssh_host_dsa_key</td>
<td>SSH version 2 ä½¿ç”¨çš„ DSA ç§é’¥</td>
</tr>
<tr>
<td>KeyRegenerationInterval 1h</td>
<td>ç”±å‰é¢è”æœºçš„è¯´æ˜å¯ä»¥çŸ¥é“ï¼Œ version 1 ä¼šä½¿ç”¨ server çš„ Public Key ï¼Œé‚£ä¹ˆå¦‚æœè¿™ä¸ª Public Key è¢«å·çš„è¯ï¼Œå²‚ä¸å®Œè›‹ï¼Ÿæ‰€ä»¥éœ€è¦æ¯éš”ä¸€æ®µæ—¶é—´æ¥é‡æ–°å»ºç«‹ä¸€æ¬¡ï¼è¿™é‡Œçš„æ—¶é—´ä¸ºç§’ï¼</td>
</tr>
<tr>
<td>ServerKeyBits 768</td>
<td>å®šä¹‰æœåŠ¡å™¨å¯†åŒ™çš„ä½æ•°ï¼Œcentos5 768ï¼Œcentos6 1024</td>
</tr>
<tr>
<td>SyslogFacility</td>
<td>æŒ‡å®š sshd(8) å°†æ—¥å¿—æ¶ˆæ¯é€šè¿‡å“ªä¸ªæ—¥å¿—å­ç³»ç»Ÿ(facility)å‘é€ã€‚æœ‰æ•ˆå€¼æ˜¯ï¼šDAEMON, USER, AUTH(é»˜è®¤), LOCAL0, LOCAL1, LOCAL2, LOCAL3, LOCAL4, LOCAL5, LOCAL6, LOCAL7</td>
</tr>
<tr>
<td>LogLevel</td>
<td>æŒ‡å®š sshd(8) çš„æ—¥å¿—ç­‰çº§(è¯¦ç»†ç¨‹åº¦)ã€‚å¯ç”¨å€¼å¦‚ä¸‹ï¼šQUIET, FATAL, ERROR, INFO(é»˜è®¤), VERBOSE, DEBUG, DEBUG1, DEBUG2, DEBUG3<br>DEBUG ä¸ DEBUG1 ç­‰ä»·ï¼›DEBUG2 å’Œ DEBUG3 åˆ™åˆ†åˆ«æŒ‡å®šäº†æ›´è¯¦ç»†ã€æ›´ç½—å—¦çš„æ—¥å¿—è¾“å‡ºã€‚<br><font color="#0215cd" size=3>æ³¨ï¼šæ¯” DEBUG æ›´è¯¦ç»†çš„æ—¥å¿—å¯èƒ½ä¼šæ³„æ¼ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯ï¼Œå› æ­¤åå¯¹ä½¿ç”¨ã€‚<font></td>
</tr>
<tr>
<td>LoginGraceTime 2m</td>
<td>å½“ä½¿ç”¨è€…è¿ä¸Š SSH server ä¹‹åï¼Œä¼šå‡ºç°è¾“å…¥å¯†ç çš„ç”»é¢ï¼Œåœ¨è¯¥ç”»é¢ä¸­ï¼Œåœ¨å¤šä¹…æ—¶é—´å†…æ²¡æœ‰æˆåŠŸè¿ä¸Š SSH server ï¼Œå°±æ–­çº¿ï¼æ—¶é—´ä¸ºé»˜è®¤ä¸ºç§’ï¼Œå¯åŠ æ—¶é—´æ ‡å¿—m,h</td>
</tr>
<tr>
<td>PermitRootLogin</td>
<td>æ˜¯å¦å…è®¸ root ç™»å½•ã€‚å¯ç”¨å€¼å¦‚ä¸‹ï¼š<br>&ldquo;yes&rdquo;(é»˜è®¤) è¡¨ç¤ºå…è®¸ã€‚&ldquo;no&quot;è¡¨ç¤ºç¦æ­¢ã€‚<br>&ldquo;without-password&quot;è¡¨ç¤ºç¦æ­¢ä½¿ç”¨å¯†ç è®¤è¯ç™»å½•ã€‚<br>&ldquo;forced-commands-only&quot;è¡¨ç¤ºåªæœ‰åœ¨æŒ‡å®šäº† command é€‰é¡¹çš„æƒ…å†µä¸‹æ‰å…è®¸ä½¿ç”¨å…¬é’¥è®¤è¯ç™»å½•ã€‚åŒæ—¶å…¶å®ƒè®¤è¯æ–¹æ³•å…¨éƒ¨è¢«ç¦æ­¢ã€‚è¿™ä¸ªå€¼å¸¸ç”¨äºåšè¿œç¨‹å¤‡ä»½ä¹‹ç±»çš„äº‹æƒ…ã€‚</td>
</tr>
<tr>
<td>StrictModes</td>
<td>æŒ‡å®šæ˜¯å¦è¦æ±‚ sshd åœ¨æ¥å—è¿æ¥è¯·æ±‚å‰å¯¹ç”¨æˆ·ä¸»ç›®å½•å’Œç›¸å…³çš„é…ç½®æ–‡ä»¶è¿›è¡Œå®¿ä¸»å’Œæƒé™æ£€æŸ¥ã€‚å¼ºçƒˆå»ºè®®ä½¿ç”¨é»˜è®¤å€¼&quot;yes&quot;æ¥é¢„é˜²å¯èƒ½å‡ºç°çš„ä½çº§é”™è¯¯ã€‚</td>
</tr>
<tr>
<td>MaxAuthTries</td>
<td>æŒ‡å®šæ¯ä¸ªè¿æ¥æœ€å¤§å…è®¸çš„è®¤è¯æ¬¡æ•°ã€‚é»˜è®¤å€¼æ˜¯ 6 ã€‚å¦‚æœå¤±è´¥è®¤è¯çš„æ¬¡æ•°è¶…è¿‡è¿™ä¸ªæ•°å€¼çš„ä¸€åŠï¼Œè¿æ¥å°†è¢«å¼ºåˆ¶æ–­å¼€ï¼Œä¸”ä¼šç”Ÿæˆé¢å¤–çš„å¤±è´¥æ—¥å¿—æ¶ˆæ¯ã€‚</td>
</tr>
<tr>
<td>PubkeyAuthentication</td>
<td>æ˜¯å¦å…è®¸å…¬é’¥è®¤è¯ã€‚ä»…å¯ä»¥ç”¨äºSSH-2ã€‚é»˜è®¤å€¼ä¸º<font color="#f8070d" size=3><code>&quot;yes&quot;</code></font>ã€‚</td>
</tr>
<tr>
<td>AuthorizedKeysFile</td>
<td>å­˜æ”¾è¯¥ç”¨æˆ·å¯ä»¥ç”¨æ¥ç™»å½•çš„ RSA/DSA å…¬é’¥ã€‚è¯¥æŒ‡ä»¤ä¸­å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æ ¹æ®è¿æ¥æ—¶çš„å®é™…æƒ…å†µè¿›è¡Œå±•å¼€çš„ç¬¦å·ï¼š<br><em><strong>%% è¡¨ç¤º&rsquo;%&rsquo;</strong></em><br><em><strong>%h è¡¨ç¤ºç”¨æˆ·çš„ä¸»ç›®å½•</strong></em><br><em><strong>%u è¡¨ç¤ºè¯¥ç”¨æˆ·çš„ç”¨æˆ·å</strong></em>ã€‚<br>ç»è¿‡æ‰©å±•ä¹‹åçš„å€¼å¿…é¡»è¦ä¹ˆæ˜¯ç»å¯¹è·¯å¾„ï¼Œè¦ä¹ˆæ˜¯ç›¸å¯¹äºç”¨æˆ·ä¸»ç›®å½•çš„ç›¸å¯¹è·¯å¾„ã€‚é»˜è®¤å€¼æ˜¯<font color="#f8070d" size=3><code>&quot;.ssh/authorized_keys&quot;</code></font>ã€‚</td>
</tr>
<tr>
<td>IgnoreRhosts</td>
<td>æ˜¯å¦åœ¨ RhostsRSAAuthentication æˆ– HostbasedAuthentication è¿‡ç¨‹ä¸­å¿½ç•¥ .rhosts å’Œ .shosts æ–‡ä»¶ã€‚ä¸è¿‡ /etc/hosts.equiv å’Œ /etc/shosts.equiv ä»å°†è¢«ä½¿ç”¨ã€‚æ¨èè®¾ä¸ºé»˜è®¤å€¼<font color="#f8070d" size=3><code>&quot;yes&quot;</code></font></td>
</tr>
<tr>
<td>IgnoreUserKnownHosts</td>
<td>æ˜¯å¦åœ¨ RhostsRSAAuthentication æˆ– HostbasedAuthentication è¿‡ç¨‹ä¸­å¿½ç•¥ç”¨æˆ·çš„ ~/.ssh/known_hosts æ–‡ä»¶ã€‚<br>é»˜è®¤å€¼æ˜¯<font color="#f8070d" size=3><code>&quot;no&quot;</code></font>ã€‚ä¸ºäº†æé«˜å®‰å…¨æ€§ï¼Œå¯ä»¥è®¾ä¸º<font color="#f8070d" size=3><code>&quot;yes&quot;</code></font>ã€‚</td>
</tr>
<tr>
<td>PasswordAuthentication</td>
<td>æ˜¯å¦å…è®¸ä½¿ç”¨åŸºäºå¯†ç çš„è®¤è¯ã€‚é»˜è®¤ä¸º<font color="#f8070d" size=3><code>&quot;yes&quot;</code></font>ã€‚</td>
</tr>
<tr>
<td>PermitEmptyPasswords</td>
<td>æ˜¯å¦å…è®¸å¯†ç ä¸ºç©ºçš„ç”¨æˆ·è¿œç¨‹ç™»å½•ã€‚é»˜è®¤ä¸º<font color="#f8070d" size=3><code>&quot;no&quot;</code></font>ã€‚</td>
</tr>
<tr>
<td>UseDNS</td>
<td>æŒ‡å®š sshdæ˜¯å¦åº”è¯¥å¯¹è¿œç¨‹ä¸»æœºåè¿›è¡Œåå‘è§£æï¼Œä»¥æ£€æŸ¥æ­¤ä¸»æœºåæ˜¯å¦ä¸å…¶IPåœ°å€çœŸå®å¯¹åº”ã€‚é»˜è®¤å€¼ä¸º<font color="#f8070d" size=3><code>&quot;yes&quot;</code></font>ã€‚ã€‚</td>
</tr>
<tr>
<td>PidFile</td>
<td>æŒ‡å®šåœ¨å“ªä¸ªæ–‡ä»¶ä¸­å­˜æ”¾SSHå®ˆæŠ¤è¿›ç¨‹çš„è¿›ç¨‹å·ï¼Œé»˜è®¤ä¸º<font color="#f8070d" size=3><code>/var/run/sshd.pid</code></font>ã€‚æ–‡ä»¶ã€‚</td>
</tr>
<tr>
<td>MaxStartups</td>
<td>æœ€å¤§å…è®¸ä¿æŒå¤šå°‘ä¸ªæœªè®¤è¯çš„è¿æ¥ã€‚é»˜è®¤å€¼æ˜¯ 10 ã€‚åˆ°è¾¾é™åˆ¶åï¼Œå°†ä¸å†æ¥å—æ–°è¿æ¥ï¼Œé™¤éå…ˆå‰çš„è¿æ¥è®¤è¯æˆåŠŸæˆ–è¶…å‡º LoginGraceTime çš„é™åˆ¶ã€‚</td>
</tr>
</tbody>
</table>
<h2 id="sshæœåŠ¡çš„è®¤è¯ç±»å‹">SSHæœåŠ¡çš„è®¤è¯ç±»å‹</h2>
<p>ä»sshå®¢æˆ·ç«¯æ¥çœ‹ï¼ŒSSHæœåŠ¡ä¸»è¦æä¾›ä¸¤ç§çº§åˆ«çš„å®‰å…¨éªŒè¯ï¼Œå…·ä½“çº§åˆ«å¦‚ä¸‹ï¼š</p>
<h3 id="åŸºäºå£ä»¤çš„å®‰å…¨éªŒè¯">åŸºäºå£ä»¤çš„å®‰å…¨éªŒè¯</h3>
<p>åŸºäºå£ä»¤çš„å®‰å…¨éªŒè¯æ˜¯å¤§å®¶ä¸€ç›´ç”¨çš„ï¼Œåªè¦çŸ¥é“æœåŠ¡å™¨çš„SSHè¿æ¥è´¦å·å’Œå£ä»¤ï¼ˆå¯¹åº”çš„æœåŠ¡å™¨IPä¸å¼€æ”¾çš„SSHç«¯å£ï¼Œé»˜è®¤22ï¼‰ï¼Œå°±å¯ä»¥é€šè¿‡sshå®¢æˆ·ç«¯ç™»é™†åˆ°è¿™å°è¿œç¨‹ä¸»æœºã€‚æ­¤æ—¶è”æœºè¿‡ç¨‹ä¸­æ‰€æœ‰ä¼ è¾“çš„æ•°æ®éƒ½æ˜¯åŠ å¯†çš„ã€‚</p>
<blockquote>
<p><strong>å£ä»¤éªŒè¯æµ‹è¯•</strong></p>
</blockquote>
<pre><code class="language-sh">$ ssh -p52113 root@192.168.252.61

  The authenticity of host '[192.168.252.61]:52113 ([192.168.252.61]:52113)' can't be established.
RSA key fingerprint is 38:68:34:4e:09:c0:75:18:be:72:17:20:2c:95:0a:e6.
Are you sure you want to continue connecting (yes/no)? yes 
Warning: Permanently added '[192.168.252.61]:52113' (RSA) to the list of known hosts.
root@192.168.252.61's password: 
Last login: Thu May 11 21:37:33 2017 from 192.168.252.1
$   
</code></pre>
<h3 id="åŸºäºç§˜é’¥çš„å®‰å…¨éªŒè¯">åŸºäºç§˜é’¥çš„å®‰å…¨éªŒè¯</h3>
<p>åŸºäºç§˜é’¥çš„å®‰å…¨éªŒè¯æ–¹å¼æ˜¯æŒ‡ï¼Œéœ€è¦ä¾é ç§˜é’¥ã€‚ä¹Ÿå°±æ˜¯å¿…é¡»å®ç°å»ºç«‹ä¸€å¯¹ç§˜é’¥å¯¹ï¼Œç„¶åå§<font style="background:#ffff00;" size=3>å…¬ç”¨ç§˜é’¥<font color="#f8070d" size=3>ï¼ˆpublic keyï¼‰</font>æ”¾åœ¨éœ€è¦è®¿é—®çš„ç›®æ ‡æœåŠ¡å™¨ä¸Š</font>ï¼Œå¦å¤–ï¼Œè¿˜éœ€è¦æŠŠ<font style="background:#ffff00;" size=3>ç§é’¥<font color="#f8070d" size=3>ï¼ˆprivate keyï¼‰</font>æ”¾åˆ°SSHå®¢æˆ·ç«¯æˆ–å¯¹åº”çš„å®¢æˆ·ç«¯æœåŠ¡å™¨ä¸Š</font>ã€‚</p>
<p>æ­¤æ—¶ï¼Œå¦‚æœæƒ³è¦è¿æ¥åˆ°è¿™ä¸ªå¸¦æœ‰å…¬ç”¨ç§˜é’¥çš„SSHæœåŠ¡å™¨ï¼Œå®¢æˆ·ç«¯SSHè½¯ä»¶æˆ–å®¢æˆ·ç«¯æœåŠ¡å™¨å°±ä¼šå‘SSHæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œè¯·æ±‚ç”¨è”æœºçš„ç”¨æˆ·ç§˜é’¥è¿›è¡Œå®‰å…¨éªŒè¯ã€‚SSHæœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œä¼šå…ˆåœ¨è¯¥SSHæœåŠ¡å™¨ä¸Šè¿æ¥çš„ç”¨æˆ·çš„å®¶ç›®å½•ä¸‹å¯»æ‰¾äº‹å…ˆæ”¾ä¸Šå»çš„å¯¹åº”ç”¨æˆ·çš„å…¬å…±å¯†é’¥ï¼Œç„¶åæŠŠå®ƒå’Œè¿æ¥çš„SSHå®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„å…¬ç”¨å¯†é’¥è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœä¸¤ä¸ªå¯†é’¥ä¸€è‡´ï¼ŒSSHæœåŠ¡å™¨å°±ç”¨å…¬ç”¨å¯†é’¥åŠ å¯†â€œè´¨è¯¢â€ï¼ˆchallengeï¼‰å¹¶æŠŠä»–å‘é€ç»™SSHå®¢æˆ·ç«¯ã€‚</p>
<p>SSHå®¢æˆ·ç«¯æ”¶åˆ°â€œè´¨è¯¢â€ä¹‹åå°±å¯ä»¥ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†ï¼Œå†æŠŠå‘é€ç»™SSHæœåŠ¡å™¨ã€‚ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œéœ€è¦ä½¿ç”¨è”æœºç”¨æˆ·çš„å¯†é’¥æ–‡ä»¶ã€‚ä¸ç¬¬ä¸€ç§åŸºäºå£ä»¤éªŒè¯çš„æ–¹å¼ç›¸æ¯”ï¼Œç¬¬äºŒç§æ–¹å¼<font style="background:#ffff00;" size=3>ä¸éœ€è¦åœ¨ç½‘ç»œä¸Šä¼ é€å£ä»¤å¯†ç </font>ï¼Œæ‰€ä»¥å®‰å…¨æ€§æ›´é«˜äº†ï¼Œè¿™æ—¶æˆ‘ä»¬ä¹Ÿè¦æ³¨æ„ä¿æŠ¤æˆ‘ä»¬çš„å¯†é’¥æ–‡ä»¶ã€‚ç‰¹åˆ«æ˜¯ç§é’¥æ–‡ä»¶ï¼Œä¸€æ—¦è¢«é»‘å®¢è·å–ï¼Œå±é™©å°±å¤§äº†ã€‚</p>
<p>åŸºäºå¯†é’¥çš„å®‰å…¨è®¤è¯ä¹Ÿæœ‰windowså®¢æˆ·ç«¯ä¸linuxå®¢æˆ·ç«¯çš„åŒºåˆ«</p>
<h2 id="windowsä¸‹ä½¿ç”¨ç§˜é’¥æ–¹å¼ç™»é™†linux">WINDOWSä¸‹ä½¿ç”¨ç§˜é’¥æ–¹å¼ç™»é™†linux</h2>
<blockquote>
<p><strong>æ–¹æ³•ä¸€ï¼šåœ¨linuxæœåŠ¡å™¨ä¸Šç”Ÿæˆå¯†é’¥å¯¹</strong></p>
</blockquote>
<pre><code class="language-sh">$ ssh-keygen -t dsa
Generating public/private dsa key pair.
# è¾“å…¥æ–‡ä»¶ä¸­è¦ä¿å­˜çš„key
Enter file in which to save the key (/root/.ssh/id_dsa): zhangsan
# è¾“å…¥ä¸€ä¸ªè¦è§£å¯†çš„å¯†ç ï¼Œç©ºä¸ºæ— å¯†ç 
Enter passphrase (empty for no passphrase): 
# å†æ¬¡è¾“å…¥å¯†ç ï¼Œç©ºä¸ºæ— å¯†ç 
Enter same passphrase again: 
# èº«ä»½è¯æ˜ä»¥ä¿å­˜è‡³zhangsanè¿™ä¸ªæ–‡ä»¶
Your identification has been saved in zhangsan.
# å…¬é’¥ä»¥ä¿å­˜ä¸ºzhangsan.pubè¿™ä¸ªæ–‡ä»¶
Your public key has been saved in zhangsan.pub.
# lampä¸»æœºçš„rootç”¨æˆ·çš„keyçš„æŒ‡çº¹ä¸ºé‚£äº›
The key fingerprint is:
10:d2:e8:03:30:4b:c9:8b:76:97:d0:6e:09:52:f7:06 root@lamp
The key's randomart image is:
+--[ DSA 1024]----+
|+oo.oE.          	|
|.*.ooo+.         	|
|o oo+ +o         	|
|.o .o*..         	|
|. . o.  S        	|
|                 	|
|                 	|
|                 	|
|                 	|
+-----------------+

$ ls
known_hosts  zhangsan  zhangsan.pub
# åœ¨æœåŠ¡å™¨ä¸Šå°†å…¬é’¥é‡å‘½å,åå­—é”™è¯¯å°†éªŒè¯ä¸æˆåŠŸ

$ mv id_dsa.pub authorized_keys
# æŸ¥çœ‹æ˜¯å¦é‡å‘½åæˆåŠŸ

$ ll
-rw-r--r--. 1 root root 599 Jun 17 03:23 authorized_keys
-rw-------. 1 root root 668 Jun 17 03:23 id_dsa
# ä¿®æ”¹å…¬é’¥æƒé™

$ chmod 600 authorized_keys 
# æŸ¥çœ‹å…¬é’¥æƒé™æ˜¯å¦ä¿®æ”¹æˆåŠŸ

$ ll
-rw-------. 1 root root 599 Jun 17 03:23 authorized_keys
-rw-------. 1 root root 668 Jun 17 03:23 id_dsa  
</code></pre>
<p>ä½¿ç”¨SecureCRTå°†ç§é’¥è½¬æ¢ä¸ºopenSSHæ ¼å¼çš„ç§é’¥</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233019524.png" alt="image-20221214233019524" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>é€‰æ‹©ä¹‹å‰ä¸‹è½½çš„ç§é’¥çš„è·¯å¾„</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233039966.png" alt="image-20221214233039966" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>å¦‚æœæ²¡è¾“å…¥å¯†ç åˆ™æ— è¿™ä¸€æ­¥</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233124937.png" alt="image-20221214233124937" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233209994.png" alt="image-20221214233209994" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>æµ‹è¯•è¿‡ç¨‹</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233231147.png" alt="image-20221214233231147" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233248106.png" alt="image-20221214233248106" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<blockquote>
<p><strong>æ–¹æ³•äºŒï¼šä½¿ç”¨SecureCRTåˆ›å»ºç§˜é’¥å¯¹</strong></p>
</blockquote>
<ol>
<li><strong>é€‰æ‹©å½“å‰è¦ç”Ÿæˆçš„ç§˜é’¥çª—å£ï¼Œç„¶åç‚¹å‡»â€œå·¥å…·â€ä¸­çš„åˆ›å»ºå…¬é’¥é€‰é¡¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233337089.png" alt="image-20221214233337089" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="2">
<li><strong>ç§˜é’¥ç”Ÿæˆå‘å¯¼é€‰æ‹©ä¸‹ä¸€æ­¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233355827.png" alt="image-20221214233355827" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="3">
<li><strong>ç§˜é’¥ç±»å‹é€‰æ‹©DSAæˆ–RSAï¼Œç„¶åç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233415756.png" alt="image-20221214233415756" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233427261.png" alt="image-20221214233427261" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="4">
<li><strong>ç”Ÿæˆç§˜é’¥é•¿åº¦ï¼Œä¿æŒé»˜è®¤å³å¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233507874.png" alt="image-20221214233507874" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="5">
<li><strong>ç§˜é’¥ç”Ÿæˆè¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233520164.png" alt="image-20221214233520164" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="6">
<li><strong>ç§˜é’¥ç”Ÿæˆåé€‰æ‹©ä¸‹ä¸€æ­¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233539086.png" alt="image-20221214233539086" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="7">
<li><strong>ç§˜é’¥ç”Ÿæˆåï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ï¼Œé€‰æ‹©ç§˜é’¥çš„ç§é’¥ä¿å­˜çš„è·¯å¾„å’Œï¼Œç„¶åç‚¹å‡»å®Œæˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233550840.png" alt="image-20221214233550840" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="8">
<li><strong>ç‚¹å‡»å®Œæˆåï¼Œå¼¹å‡ºæ˜¯å¦ä½¿ç”¨æ­¤ç§˜é’¥ä¸ºå…¨å±€å…¬é’¥ï¼Œä»¥ä¸ªäººä¹ æƒ¯é€‰æ‹©æ˜¯æˆ–å¦ï¼Œè¿™é‡Œé€‰æ‹©å¦ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</strong>ï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233610803.png" alt="image-20221214233610803" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<ol start="9">
<li><strong>å°†SecureCRTç”Ÿæˆçš„å…¬é’¥ä¸Šä¼ åˆ°linuxæœåŠ¡å™¨ä¸Š</strong></li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233646475.png" alt="image-20221214233646475" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<pre><code class="language-sh"># åˆ›å»ºå…¬é’¥å­˜æ”¾ç›®å½•
$ mkdir .ssh

# ä¿®æ”¹.sshç›®å½•çš„æƒé™
$ chmod 700 .ssh/

# æŸ¥çœ‹ssh2å…¼å®¹æ ¼å¼è½¬æ¢æˆopensshçš„æ ¼å¼ç»“æœ
$ ssh-keygen -i -f Identity.pub  
ssh-dss AAAAB3NzaC1kc3MAAACBAIJLJsIZJ0G/RKBnWQ04uRfqnv3Vkm8iusrI3Bm784lP64kn/IVZnC/2wcs6xjwjuGFt8GgNVKty+
s5/jf4uMBse7Ju3alIv42iOmS5+qeztb3Yio1r0rEjLcEdFZVEW3dbVsYX3ufwvBa9GhPum4q3eYwY7TziKR9ub2UJZTqVzAAAAFQDSfk
HVhjW7J80YBBI2PdqVcRfZ3wAAAIBwmHcLm+BVCcMmpKfYzl+W1/79Cd7vSbeFMW+linn82Li/RcVnWF47hxeKwOwJ/O2UJ879cW1xPUG
nJUNfEvHJs93rn3zthlbwLCmyH8Ugp2pF38DgyydbU6Xs/6lyiUc14WlzvL3QqO1H+QBX/18ZgXsZjoxakd86pz329r9wTgAAAIAVakBN
8DtSRZqPLeaXDhevg3texOTlmDsmhmqBcAOmH6VnzP1VB0E8DhTB8/MWJChSJalslyEzaa1PhBNwZEn3SmG6vWe+CXSuEtHBXbVBQHsDb
xois6L+oqkL86PA7JdzTDSfiZKoGOks5f37Qb+CREnhyYcXJIjPZTE/0aIsdA==

# å°†ssh2å…¼å®¹æ ¼å¼è½¬æ¢æˆopensslçš„æ ¼å¼ç»“æœ
$ ssh-keygen -i -f Identity.pub &gt;&gt;.ssh/authorized_keys

# ä¿®æ”¹å…¬é’¥çš„æƒé™
$ chmod 600 .ssh/authorized_keys 

# æŸ¥çœ‹æƒé™æ˜¯å¦ä¿®æ”¹æˆåŠŸ
$ ll .ssh/
-rw-------. 1 root root 589 Jun 17 04:37 authorized_keys  
</code></pre>
<ol start="10">
<li><strong>æµ‹è¯•ç»“æœ</strong>
æ–°å»ºå¿«é€Ÿé“¾æ¥ï¼Œåœ¨é‰´æƒä¸­é€‰æ‹©å…¬é’¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ol>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233705203.png" alt="image-20221214233705203" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233722816.png" alt="image-20221214233722816" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>å¦‚æœè®¾ç½®äº†é€šè¡ŒçŸ­è¯­ï¼Œå°±ä¼šå‡ºç°ä»¥ä¸‹æ¡†</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233734945.png" alt="image-20221214233734945" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214233756074.png" alt="image-20221214233756074" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p><a href="http://blog.51cto.com/phenixikki/1546669" target="_blank"
   rel="noopener nofollow noreferrer" >è£¸å¥”çš„åæœï¼ä¸€æ¬¡sshè¢«ç¯¡æ”¹çš„å…¥ä¾µäº‹ä»¶</a></p>
<p>æ‰«æç«¯å£å®ä¾‹ï¼šç‰¤ç‰›é˜µè§£å†³sshå®‰å…¨é—®é¢˜</p>
<pre><code class="language-sh">$ nmap 192.168.65.62 -p1-65535
Starting Nmap 5.51 ( http://nmap.org ) at 2016-06-17 05:11 CST
Nmap scan report for 192.168.65.62
Host is up (0.0000040s latency).
Not shown: 65532 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
3306/tcp open  mysql

Nmap done: 1 IP address (1 host up) scanned in 0.79 seconds  
</code></pre>
]]></content:encoded>
    </item>
    
    <item>
      <title>ä½¿ç”¨SSHåè®®æ¥ä¼ è¾“æ–‡ä»¶</title>
      <link>https://www.oomkill.com/2016/07/scp/</link>
      <pubDate>Sun, 24 Jul 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/07/scp/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="sshå®¢æˆ·ç«¯é™„å¸¦çš„è¿œç¨‹æ‹·è´scpå‘½ä»¤">SSHå®¢æˆ·ç«¯é™„å¸¦çš„è¿œç¨‹æ‹·è´scpå‘½ä»¤</h2>
<p>Â Â Â Â scpæ˜¯åŠ å¯† çš„è¿œç¨‹æ‹·è´ï¼Œå¯ä»¥æŠŠæ•°æ®ä»ä¸€å°æœºå™¨æ¨é€åˆ°å¦ä¸€å°æœºå™¨ï¼Œä¹Ÿå¯ä»¥ä»å…¶ä»–æœåŠ¡å™¨æŠŠæ•°æ®æ‹‰å›åˆ°æœ¬åœ°æ‰§è¡Œå‘½ä»¤çš„æœåŠ¡å™¨ï¼Œä½†æ˜¯ï¼Œæ¯æ¬¡éƒ½æ˜¯å…¨é‡æ‹·è´ï¼ˆrsyncå¢é‡æ‹·è´ï¼‰ï¼Œå› æ­¤æ•ˆç‡ä¸é«˜ã€‚
scpçš„åŸºæœ¬è¯­æ³•ä½¿ç”¨
secure copy ï¼ˆremote file copy ï¼‰</p>
<table>
<thead>
<tr>
<th>å‚æ•°é€‰é¡¹</th>
<th>æ³¨é‡Šè¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-p</td>
<td>æ‹·è´å‰åä¿æŒæ–‡ä»¶æˆ–ç›®å½•å±æ€§</td>
</tr>
<tr>
<td>-P</td>
<td>ï¼ˆå¤§å†™ï¼‰	æ¥ç«¯å£ï¼Œé»˜è®¤22ç«¯å£æ—¶å¯çœç•¥</td>
</tr>
<tr>
<td>-r</td>
<td>æ‹·è´ç›®å½•</td>
</tr>
<tr>
<td>-l</td>
<td>é™åˆ¶é€Ÿåº¦</td>
</tr>
</tbody>
</table>
<p>æ¨ï¼šscp -Pport æº ç›®æ ‡(user@host_ip):/path</p>
<pre><code class="language-sh">$ touch {a..f}.txt
$ ls
a.txt  
b.txt  
c.txt  
d.txt  
e.txt  
f.txt

$ scp -P22 a.txt root@192.168.65.62:/
root@192.168.65.62's password: 
a.txt                       100%    0     0.0KB/s   00:00

$   ls /
app  
a.txt
</code></pre>
<p>æ‹‰ï¼šscp -Pport æº(user@host_ip):/path ç›®æ ‡</p>
<pre><code class="language-sh">$   ll /
total 98
app  a.txt
$ ls

$ scp -P22 root@192.168.65.62:/a.txt ./
-rw-r--r--. 1 root root 0 Jun 16 18:20 a.txt
root@192.168.65.62's password: 
a.txt             100%    0     0.0KB/s   00:00    
$ ls
a.txt
</code></pre>
<p>æ‹·è´ç›®å½•</p>
<pre><code class="language-sh">$ touch {a..g}.txt
$ ls
 a.txt  b.txt  c.txt  d.txt  e.txt  f.txt  g.txt
$ scp -P22 -r /test1 root@192.168.65.62:/
root@192.168.65.62's password: 
c.txt                                       100%    0     0.0KB/s   00:00    
b.txt                                       100%    0     0.0KB/s   00:00    
g.txt                                       100%    0     0.0KB/s   00:00    
e.txt                                       100%    0     0.0KB/s   00:00    
a.txt                                       100%    0     0.0KB/s   00:00    
d.txt                                       100%    0     0.0KB/s   00:00    
f.txt                                       100%    0     0.0KB/s   00:00    
$ l
$ ll /
drwxr-xr-x.   2 root root  4096 Jun 17 06:52 test1
</code></pre>
<h2 id="sshæœåŠ¡é™„å¸¦sftpåŠŸèƒ½æœåŠ¡">SSHæœåŠ¡é™„å¸¦sftpåŠŸèƒ½æœåŠ¡</h2>
<p>å®‰å…¨çš„FTPçš„åŠŸèƒ½ï¼Œå³é€šè¿‡sshåŠ å¯†æ•°æ®åè¿›è¡Œä¼ è¾“</p>
<h3 id="linux-ftpå®¢æˆ·ç«¯è¿æ¥sftpæœåŠ¡å™¨æ–¹æ³•">Linux FTPå®¢æˆ·ç«¯è¿æ¥sftpæœåŠ¡å™¨æ–¹æ³•</h3>
<p>linuxå®¢æˆ·ç«¯è¿æ¥ sftp user@ip å¦‚æœç«¯å£ä¸º52113åˆ™ç™»é™†å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">$ sftp -oPort=22 root@192.168.65.62
Connecting to 192.168.65.62...
root@192.168.65.62's password:
# sftpé»˜è®¤çš„ç›®å½•ä¸ºç”¨æˆ·å®¶ç›®å½•
sftp&gt; ls -l
Identity.pub
anaconda-ks.cfg
install.log
install.log.syslog

# ä¸Šä¼ ï¼Œé»˜è®¤ä¸Šä¼ åˆ°å¯¹æ–¹å®¶ç›®å½•
sftp&gt; put /test/1
Uploading /test/1 to /root/1
/test/1                       100%    0     0.0KB/s   00:00
$ ll
-rw-r--r--. 1 root root     0 Jun 17 08:43 1

sftp&gt; ls -l
1
Identity.pub
anaconda-ks.cfg
install.log
install.log.syslog
# sftpä¸æ”¯æŒtabé”®
sftp&gt; cat 1
Invalid command.

# ä¸‹è½½ï¼Œé»˜è®¤ä¸‹è½½åˆ°ç”¨æˆ·å®¶ç›®å½•
sftp&gt; get install.log
Fetching /root/install.log to install.log
/root/install.log                                100%   21KB  21.2KB/s   00:00    
# sftpå¹¶ä¸é”å®šç›®å½•ï¼Œå¯ä»¥è‡ªè¡Œé€‰æ‹©æ–‡ä»¶ä¸Šä¼ 
# æŠŠ/etc/passwdä»å®¢æˆ·ç«¯æœ¬åœ°ä¼ åˆ°sftpæœåŠ¡ç«¯æŒ‡å®šç›®å½•/æ ¹ä¸‹
sftp&gt; put /etc/passwd /
Uploading /etc/passwd to /passwd
/etc/passwd                     100% 1202     1.2KB/s   00:00    
# lnmpé•¿ä¼ è‡ªsftpæœåŠ¡å™¨ä¸Šçš„passwdæ–‡ä»¶
$ ll /
-rw-r--r--.   1 root root  1202 Jun 17 08:51 passwd
# sftpä¸èƒ½ä¸‹è½½/ä¸Šä¼ ç›®å½•
sftp&gt; get asdc
Fetching /root/asdc to asdc
Cannot download non-regular file: /root/asdc
</code></pre>
<p>å°ç»“ï¼š</p>
<ol>
<li><code>sftp -oPort=22 root@1.1.1.1</code></li>
<li>ä¸Šä¼ putåŠ å®¢æˆ·ç«¯æœ¬åœ°è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šè·¯å¾„ä¸Šä¼ ï¼Œput /etc/hosts(å®¢æˆ·ç«¯ç›®å½•) /tmpï¼ˆæœåŠ¡å™¨ç›®å½•ï¼‰</li>
<li>ä¸‹è½½ç›´æ¥getæœåŠ¡ç«¯çš„å†…å®¹ï¼Œä¸‹è½½åˆ°æœ¬åœ°çš„å½“å‰ç›®å½•</li>
</ol>
<h3 id="windowså®¢æˆ·ç«¯è¿æ¥sftpæ–¹æ³•">windowså®¢æˆ·ç«¯è¿æ¥sftpæ–¹æ³•</h3>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214234154054.png" alt="image-20221214234154054" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<p>è¿™æ—¶æ˜¯windowsè¿æ¥çš„lnmpè€Œå’Œlampæ— å…³ï¼Œç›¸å½“äºrz szä¸Šä¼ ä¸‹è½½çš„åŠŸèƒ½</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214234207465.png" alt="image-20221214234207465" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
<pre><code class="language-sh"># ä¸Šä¼ ï¼Œè·¯å¾„è¦åŠ åŒå¼•å·
sftp&gt; put &quot;D:\vmware-0.log&quot;
Uploading vmware-0.log to /root/vmware-0.log
  100% 193KB    193KB/s 00:00:00     
D:/vmware-0.log: 197820 bytes transferred in 0 seconds (193 KB/s)
sftp&gt; ls
anaconda-ks.cfg       install.log           install.log.syslog
vmware-0.log
</code></pre>
<p>ä¸‹è½½</p>
<pre><code class="language-sh">sftp&gt; get install.log
Downloading install.log from /root/install.log
  100% 21KB     21KB/s 00:00:00     
/root/install.log: 21682 bytes transferred in 0 seconds (21 KB/s)

sftp&gt; get install.log &quot;D:\&quot;
Downloading install.log from /root/install.log
get: D:/: ç³»ç»Ÿæ‰¾ä¸åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚ 
  100% 21KB     21KB/s 00:00:00     
/root/install.log: 21682 bytes transferred in 0 seconds (21 KB/s)
</code></pre>
<p>ä¸‹è½½çš„ç›®å½•æ˜¯CRTè®¾ç½®çš„ç›®å½•ï¼Œæ³¨æ„è®¾ç½®åéœ€è¦é‡æ–°å¯åŠ¨è½¯ä»¶</p>
<p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/CylonChau/imgbed//img/image-20221214234228671.png" alt="image-20221214234228671" onerror="this.onerror=null;this.src='/placeholder.svg';this.className='pe-image-placeholder'" /></p>
]]></content:encoded>
    </item>
    
    <item>
      <title>expectä½¿ç”¨æ¡ˆä¾‹</title>
      <link>https://www.oomkill.com/2016/07/expect/</link>
      <pubDate>Sat, 23 Jul 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/07/expect/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯expect">ä»€ä¹ˆæ˜¯Expect</h2>
<p>Expentæ˜¯åŸºäºtclçš„ç›¸å¯¹ç®€å•çš„ä¸€ä¸ªå…è´¹çš„è„šæœ¬ç¼–ç¨‹å·¥å…·è¯­è¨€ï¼Œç”¨æ¥å®ç°è‡ªåŠ¨å’Œäº¤äº’ä»»åŠ¡ç¨‹åºè¿›è¡Œé€šä¿¡ï¼Œæ— éœ€äººçš„æ‰‹å·¥å¹²é¢„ã€‚æ¯”å¦‚SSHã€FTPç­‰ï¼Œè¿™äº›ç¨‹åºæ­£å¸¸æƒ…å†µéƒ½éœ€è¦æ‰‹å·¥ä¸å®ƒä»¬è¿›è¡Œäº¤äº’ï¼Œè€Œä½¿ç”¨Expectå°±å¯ä»¥æ¨¡æ‹Ÿäººæ‰‹å·¥äº¤äº’çš„è¿‡ç¨‹ï¼Œå®ç°è‡ªåŠ¨çš„å’Œè¿œç¨‹çš„ç¨‹åºäº¤äº’ï¼Œä»è€Œè¾¾åˆ°è‡ªåŠ¨åŒ–è¿ç»´çš„ç›®çš„ã€‚</p>
<h2 id="expectç¨‹åºå·¥ä½œæµç¨‹">Expectç¨‹åºå·¥ä½œæµç¨‹</h2>
<p>Expectçš„å·¥ä½œæµç¨‹å¯ä»¥ç†è§£ä¸ºï¼Œspawnå¯åŠ¨è¿›ç¨‹ ==&gt; expectæœŸå¾…å…³é”®å­— ==&gt; sendå‘è¿›ç¨‹å‘é€å­—ç¬¦ ==&gt; é€€å‡ºç»“æŸã€‚</p>
<h2 id="å®‰è£…expectè½¯ä»¶">å®‰è£…Expectè½¯ä»¶</h2>
<p>é¦–å…ˆï¼Œé…ç½®å¥½yumå®‰è£…æºï¼Œå¹¶ä¸”ç¡®ä¿æœºå™¨å¯ä»¥ä¸Šç½‘ï¼Œç„¶åæ‰§è¡Œ<font color="#f8070d" size=3><code>yum install expect -y</code></font>å³å¯å®‰è£…Expectè½¯ä»¶ã€‚</p>
<p>å®‰è£…å®ŒåæŸ¥çœ‹ç»“æœï¼š</p>
<pre><code class="language-sh">$ rpm -qa|grep expect
expect-5.44.1.15-5.el6_4.x86_64
</code></pre>
<h2 id="å…ˆçœ‹ä¸€ä¸ªexpectå°å®ä¾‹">å…ˆçœ‹ä¸€ä¸ªExpectå°å®ä¾‹</h2>
<p>é¦–å…ˆå‡†å¤‡3å°è™šæ‹Ÿæœºï¼š</p>
<pre><code class="language-sh">192.168.252.60 client
192.168.252.62 client
192.168.252.63 client
192.168.252.64 server
</code></pre>
<p>å†æ‰§è¡Œä¸‹é¢ä¾‹å­å‰ï¼Œæˆ‘ä»¬å…ˆæ‰‹å·¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</p>
<pre><code class="language-sh">ssh -p52113 root@192.168.252.64 ifconfig
</code></pre>
<p>æ‰§è¡Œç»“æœï¼š</p>
<pre><code class="language-sh">$ ssh -p52113 root@192.168.252.64 ifconfig
root@192.168.252.64's password: 
</code></pre>
<blockquote>
<blockquote>
<p><strong>Expect ä¾‹å­è„šæœ¬å†…å®¹</strong>ï¼š</p>
</blockquote>
</blockquote>
<pre><code class="language-sh">#!/usr/bin/expect
spawn ssh -p52113 root@192.168.252.62 /sbin/ifconfig eth0
set timeout 60
expect &quot;*password:&quot;
send &quot;111111\n&quot;
expect eof
exit
</code></pre>
<blockquote>
<p><strong>æ‰§è¡Œç»“æœ</strong>ï¼šé—®é¢˜ï¼š</p>
</blockquote>
<pre><code class="language-sh">$ ./a.exp  
spawn ssh -p52113 root@192.168.252.62 /sbin/ifconfig eth0
root@192.168.252.62's password: 
eth0      Link encap:Ethernet  HWaddr 00:0C:29:C3:48:CB  
          inet addr:192.168.252.62  Bcast:192.168.252.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fec3:48cb/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:3027 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1632 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:268416 (262.1 KiB)  TX bytes:175473 (171.3 KiB)
</code></pre>
<blockquote>
<p><strong>é—®é¢˜</strong>ï¼š</p>
</blockquote>
<pre><code class="language-sh">$ ./a.exp 
./a.exp: line 8: spawn: command not found
couldn't read file &quot;*password:&quot;: no such file or directory
./a.exp: line 11: send: command not found
couldn't read file &quot;eof&quot;: no such file or directory
</code></pre>
<p>åŸå› ï¼š</p>
<ul>
<li>å«æœ‰expectçš„è„šæœ¬ä¸èƒ½ç”¨bashæ‰§è¡Œï¼Œbashæ— æ³•è§£æã€‚æ·»åŠ å¯æ‰§è¡Œæƒé™åï¼Œç›´æ¥./your_scriptå³å¯</li>
<li>è¿™ä¸ªä»£ç æ˜¯expectçš„ä»£ç ï¼Œä¸ç”±bashè§£é‡Šã€‚</li>
<li>spawnå¯ä»¥çœ‹ä½œexpectè„šæœ¬çš„å†…éƒ¨å‡½æ•°ã€‚è¦ç¬¬ä¸€è¡Œæ”¹æˆ #!/usr/bin/expect</li>
</ul>
<h2 id="expectè¯­æ³•">Expectè¯­æ³•</h2>
<p>Expectä¸­çš„å‘½ä»¤æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†äº†ï¼Œå‘½ä»¤çš„ä½¿ç”¨è¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">å‘½ä»¤ [é€‰é¡¹] å‚æ•°
</code></pre>
<h3 id="spawn">spawn</h3>
<p>spawnå‘½ä»¤æ˜¯Expectçš„åˆå§‹å‘½ä»¤ï¼Œå®ƒç”¨äºå¯åŠ¨ä¸€ä¸ªè¿›ç¨‹ï¼Œä¹‹åæ‰€æœ‰expectæ“ä½œéƒ½åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­è¿›è¡Œï¼Œå¦‚æœæ²¡æœ‰spawnè¯­å¥ï¼Œæ•´ä¸ªexpectå°±æ— æ³•æ‰§è¡Œäº†ï¼Œspawnä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">spawn ssh root@192.168.252.62
</code></pre>
<p>åœ¨spawnå‘½ä»¤åé¢ç›´æ¥åŠ ä¸Šè¦å¯åŠ¨çš„è¿›ç¨‹ã€å‘½ä»¤ç­‰ä¿¡æ¯ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œspawnè¿˜æ”¯æŒå…¶ä»–é€‰é¡¹å¦‚ï¼š</p>
<ul>
<li>-open		å¯åŠ¨æ–‡ä»¶è¿›ç¨‹ï¼Œå…·ä½“è¯´æ˜çœç•¥ã€‚</li>
<li>-ignore		å¿½ç•¥æŸäº›ä¿¡å·ï¼Œå…·ä½“è¯´æ˜çœç•¥ã€‚</li>
</ul>
<h3 id="expect">expect</h3>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">expect  è¡¨è¾¾å¼  åŠ¨ä½œ  è¡¨è¾¾å¼  åŠ¨ä½œ
</code></pre>
<p>expectå‘½ä»¤ç”¨äºç­‰å€™ä¸€ä¸ªç›¸åŒ¹é…å†…å®¹çš„è¾“å‡ºï¼Œä¸€æ—¦åŒ¹é…ä¸Šå°±æ‰§è¡Œexpectåé¢çš„åŠ¨ä½œæˆ–å‘½ä»¤ã€‚è¿™ä¸ªå‘½ä»¤æ¥å—å‡ ä¸ªç‰¹æœ‰çš„å‚æ•°ï¼Œç”¨çš„æœ€å¤šçš„å°±æ˜¯-reï¼Œè¡¨ç¤ºä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼åŒ¹é…ï¼Œä½¿ç”¨èµ·æ¥å°±åƒè¿™æ ·ï¼š</p>
<pre><code class="language-sh">spawn  ssh  root@192.168.252.64
expect  &quot;password:&quot; {send &quot;111111\r&quot;}
</code></pre>
<p>ä»ä¸Šé¢çš„ä¾‹å­å¯ä»¥çœ‹å‡ºï¼Œexpectæ˜¯ä¾é™„ä¸spawnå‘½ä»¤çš„ï¼Œå½“æ‰§è¡Œsshå‘½ä»¤åï¼Œexpectå°±åŒ¹é…å‘½ä»¤æ‰§è¡Œåçš„å…³é”®å­—ï¼šâ€œpasswordï¼šâ€ï¼Œå¦‚æœåŒ¹é…åˆ°å…³é”®å­—å°±ä¼šæ‰§è¡Œåé¢åŒ…å«åœ¨â€œ{}â€ä¸­çš„sendæˆ–exp_sendåŠ¨ä½œï¼ŒåŒ¹é…çš„åŠ¨ä½œå¯ä»¥æ”¾åœ¨äºŒè¡Œï¼Œè¿™æ ·å°±ä¸éœ€è¦ä½¿ç”¨â€œ{}â€äº†ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼Œå®é™…å®Œæˆçš„åŠŸèƒ½ä¸ä¸Šé¢æ˜¯ä¸€æ ·çš„ï¼š</p>
<pre><code class="language-sh">spawn  ssh  root@192.168.252.64
expect  &quot;password:&quot; 
send &quot;111111\r&quot;
</code></pre>
<p>expectå‘½ä»¤è¿˜æœ‰ä¸€ç§ç”¨æ³•ï¼Œä»–å¯ä»¥åœ¨ä¸€ä¸ªexpectåŒ¹é…ä¸­å¤šæ¬¡åŒ¹é…å…³é”®å­—ï¼Œå¹¶ç»™å‡ºå¤„ç†åŠ¨ä½œï¼Œåªéœ€è¦å°†å…³é”®å­—æ”¾åœ¨ä¸€ä¸ªå¤§æ‹¬å·ä¸­å°±å¯ä»¥äº†ï¼Œå½“ç„¶è¿˜è¦æœ‰exp_continueã€‚</p>
<pre><code class="language-sh">spawn ssh root@192.168.252.64
expect {
    &quot;yes/no&quot;		{ exp_send &quot;yes\r&quot;; exp_continue }
   &quot;*password:&quot;	{ exp_send &quot;111111\r&quot; }
}
</code></pre>
<h3 id="exp_sendå’Œsend">exp_sendå’Œsend</h3>
<p>åœ¨ä¸Šé¢çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°exp_sendå‘½ä»¤çš„ä½¿ç”¨ï¼Œ<font color="#f8070d" size=3><code>exp_send</code></font>å‘½ä»¤æ˜¯<font color="#f8070d" size=3><code>expect</code></font>ä¸­çš„åŠ¨ä½œå‘½ä»¤ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªå®ŒæˆåŒæ ·å·¥ä½œçš„åŒèƒï¼šsendï¼Œexp_sendå‘½ä»¤å¯ä»¥å‘é€ä¸€äº›ç‰¹æ®Šç¬¦å·ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†\rï¼ˆå›è½¦ï¼‰ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„æ¯”å¦‚ï¼š\nã€\tç­‰ç­‰ï¼Œè¿™äº›éƒ½ä¸TCLä¸­çš„ç‰¹æ®Šç¬¦å·ç›¸åŒã€‚</p>
<pre><code class="language-sh">spawn ssh root@192.168.252.64
expect {
  &quot;yes/no&quot;		{ exp_send &quot;yes\r&quot;; exp_continue }
  &quot;*password:&quot;	{ exp_send &quot;111111\r&quot; }
}
</code></pre>
<p>sendå‘½ä»¤æœ‰å‡ ä¸ªå¯ç”¨å‚æ•°ï¼š</p>
<ul>
<li>-i åˆ¶å®šspawn_idï¼Œè¿™ä¸ªå‚æ•°ç”¨æ¥å‘ä¸åŒspawn_idçš„è¿›ç¨‹å‘é€å‘½ä»¤ï¼Œæ˜¯è¿›è¡Œå¤šç¨‹åºæ§åˆ¶çš„å…³é”®å‚æ•°ã€‚</li>
<li>-s sä»£è¡¨slowlyï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶å‘é€çš„é€Ÿåº¦ï¼Œè¿™ä¸ªå‚æ•°ä½¿ç”¨çš„æ—¶å€™è¦ä¸expectä¸­çš„å˜é‡send_slowç›¸å…³è”ã€‚</li>
</ul>
<h3 id="exp_continue">exp_continue</h3>
<p>è¿™ä¸ªå‘½ä»¤ä¸€èˆ¬ç”¨åœ¨åŠ¨ä½œä¸­ï¼Œå®ƒè¢«ä½¿ç”¨çš„æ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œçœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<pre><code class="language-sh">#!/usr/bin/expect
spawn ssh root@192.168.252.64 /sbin/ifconfig eth0
set timeout 60
expect {
    -timeout 1
    &quot;yes/no&quot;		{ exp_send &quot;yes\r&quot;; exp_continue }
    &quot;*password:&quot;	{ exp_send &quot;111111\r&quot; }
    timeout 		{ puts  &quot;expect was timeout by oldboy.&quot;;  return}
}
expect eof
exit
</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯ä»¥å‘ç°exp_continueå‘½ä»¤çš„ä½¿ç”¨æ–¹æ³•ï¼Œé¦–å…ˆå®ƒè¦å¤„äºä¸€ä¸ªexpectå‘½ä»¤ä¸­ï¼Œç„¶åå®ƒå±äºä¸€ç§åŠ¨ä½œå‘½ä»¤ï¼Œå®Œæˆçš„å·¥ä½œå°±æ˜¯ä»å¤´å¼€å§‹éå†ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼ŒåŒ¹é…ç¬¬ä¸€ä¸ªå…³é”®å­—ä»¥åå°±ä¼šç»§ç»­åŒ¹é…ç¬¬äºŒä¸ªå…³é”®å­—ï¼Œä½†æœ‰äº†è¿™ä¸ªå‘½ä»¤åï¼ŒåŒ¹é…ç¬¬ä¸€ä¸ªå…³é”®å­—ä»¥åï¼Œç¬¬äºŒæ¬¡åŒ¹é…ä»ç„¶ä»ç¬¬ä¸€ä¸ªå…³é”®å­—å¼€å§‹ã€‚</p>
<h3 id="send_user">send_user</h3>
<p>send_userå‘½ä»¤ç”¨æ¥æŠŠåé¢çš„å‚æ•°è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºä¸­å»ï¼Œé»˜è®¤çš„sendã€exp_sendå‘½ä»¤éƒ½æ˜¯å°†å‚æ•°è¾“å‡ºåˆ°ç¨‹åºä¸­å»çš„ï¼Œç”¨èµ·æ¥å°±åƒè¿™æ ·ï¼š</p>
<pre><code class="language-sh">send_user &quot;please input password:&quot;
</code></pre>
<p>è¿™ä¸ªè¯­å¥å°±å¯ä»¥åœ¨æ ‡å‡†è¾“å‡ºä¸­æ‰“å°Please input passwordï¼šå­—ç¬¦äº†ã€‚</p>
<pre><code class="language-sh">#!/usr/bin/expect
if { $argc != 2 } {
send_user &quot;usage: expect scp-expect.exp file host dir\n&quot;
exit
}

#define var
set file [lindex $argv 0]
set host [lindex $argv 1]
set password &quot;111111&quot;
#spawn scp /etc/hosts root@10.0.0.142:/etc/hosts
spawn ssh-copy-id -i $file &quot;-p 52113 root@$host&quot;

expect {
    &quot;yes/no&quot;    {send &quot;yes\r&quot;;exp_continue}
    &quot;*password&quot; {send &quot;$password\r&quot;}
}

expect eof

exit -onexit {
send_user &quot;Oldboy say good bye to you!\n&quot;
}

#script usage
#expect oldboy-6.exp file host dir
#example
#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts
</code></pre>
<h3 id="exit">exit</h3>
<p>exitå‘½ä»¤åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯ç›´æ¥é€€å‡ºè„šæœ¬ï¼Œä½†æ˜¯ä½ å¯ä»¥åˆ©ç”¨è¿™ä¸ªå‘½ä»¤å¯¹è„šæœ¬åšä¸€äº›æ‰«å°¾å·¥ä½œï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="language-sh">exit -onexit {
    exec  rm  $tmpfile
    send_user &quot;Good bye\n&quot;
}
</code></pre>
<pre><code class="language-sh">#!/usr/bin/expect
if { $argc != 2 } {
	send_user &quot;usage: expect scp-expect.exp file host dir\n&quot;
	exit
}

#define var
set file [lindex $argv 0]
set host [lindex $argv 1]
set password &quot;111111&quot;
#spawn scp /etc/hosts root@10.0.0.142:/etc/hosts
spawn ssh-copy-id -i $file &quot;-p 52113 root@$host&quot;

expect {
 	&quot;yes/no&quot;    {send &quot;yes\r&quot;;exp_continue}
 	&quot;*password&quot; {send &quot;$password\r&quot;}
}

expect eof

exit -onexit {
 	send_user &quot;Oldboy say good bye to you!\n&quot;
}

#script usage
#expect oldboy-6.exp file host dir
#example
#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts
</code></pre>
<h2 id="exceptå˜é‡">Exceptå˜é‡</h2>
<p>expectä¸­æœ‰å¾ˆå¤šæœ‰ç”¨çš„å˜é‡ï¼Œå®ƒä»¬ä½¿ç”¨æ–¹æ³•ä¸TCLè¯­è¨€ä¸­çš„å˜é‡ç›¸åŒï¼Œæ¯”å¦‚ï¼š
set  å˜é‡å  å˜é‡å   	# è®¾ç½®å˜é‡çš„æ–¹æ³•
set  $å˜é‡å  		  	# è¯»å–å˜é‡çš„æ–¹æ³•</p>
<pre><code class="language-sh">#define var
set file [lindex $argv 0]
set file [lindex $argv 1]
set file [lindex $argv 2]
set password &quot;123456&quot;
</code></pre>
<h2 id="expectå…³é”®å­—">Expectå…³é”®å­—</h2>
<p>expectä¸­çš„ç‰¹æ®Šå…³é”®å­—ç”¨äºåŒ¹é…è¿‡ç¨‹ï¼Œä»£è¡¨æŸäº›ç‰¹æ®Šå«ä¹‰æˆ–çŠ¶æ€ï¼Œä¸€èˆ¬ç”¨äºexpectæ—å‘½ä»¤ä¸­ä¸èƒ½åœ¨å¤–é¢å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºäº‹ä»¶ï¼Œä½¿ç”¨ä¸Šç±»ä¼¼äº<code>expect eof {}</code></p>
<h3 id="eof">eof</h3>
<p>eof (end-of-file)å…³é”®å­—ç”¨äºåŒ¹é… ç»“æŸç¬¦ï¼Œæ¯”å¦‚æ–‡ä»¶çš„ç»“æŸç¬¦ã€FTPä¼ è¾“åœæ­¢ç­‰æƒ…å†µï¼Œåœ¨è¿™ä¸ªå…³é”®å­—åè·Ÿä¸ŠåŠ¨ä½œæ¥åšè¿›ä¸€æ­¥çš„æ§åˆ¶ï¼Œç‰¹åˆ«æ˜¯FTPäº¤äº’æ“ä½œæ–¹é¢ï¼Œå®ƒçš„åŠ¨ä½œå¾ˆå¤§ã€‚ç”¨ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹ï¼š</p>
<pre><code class="language-sh">spawn ftp anonymous@10.11.105.110
expect {
  &quot;password:&quot;  {exp_send &quot;who Iâ€™m I&quot;}
   eof {ftp connect close}
}
interact { }
</code></pre>
<h3 id="timeout">timeout</h3>
<p>timeoutæ˜¯expectä¸­çš„ä¸€ä¸ªé‡è¦å˜é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…¨å±€æ€§çš„æ—¶é—´æ§åˆ¶å¼€å…³ï¼Œä½ å¯ä»¥é€šè¿‡ä¸ºè¿™ä¸ªå˜é‡èµ‹å€¼æ¥è§„å®šæ•´ä¸ªexpectæ“ä½œæ—¶é—´ï¼Œæ³¨æ„è¿™ä¸ªå˜é‡æ˜¯æœåŠ¡äºexpectå…¨å±€çš„ï¼Œå®ƒä¸ä¼šçº ç¼ äºæŸä¸€æ¡å‘½ä»¤ï¼Œå³ä½¿å‘½ä»¤æ²¡æœ‰ä»»ä½•é”™è¯¯ï¼Œåˆ°æ—¶è§ä»ç„¶ä¼šæ¿€æ´»è¿™ä¸ªå˜é‡ï¼Œä½†è¿™ä¸ªæ—¶é—´åˆ°è¾¾ä»¥åé™¤äº†æ¿€æ´»ä¸€ä¸ªå¼€å…³ä¹‹å¤–ä¸ä¼šåšå…¶ä»–çš„äº‹æƒ…ï¼Œå¦‚ä½•å¤„ç†æ˜¯è„šæœ¬ç¼–å†™äººå‘˜çš„äº‹æƒ…ï¼Œçœ‹çœ‹å®ƒçš„å®é™…ä½¿ç”¨æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">set timeout 60
spawn ssh root@192.168.2.1
expect &quot;password:&quot;  {send &quot;word\r&quot;}
expect timeout  { puts &quot;Expect was timeout&quot;; return }
</code></pre>
<p>ä¸Šé¢çš„å¤„ç†ä¸­ï¼Œé¦–å…ˆå°†timeoutå˜é‡è®¾ç½®ä¸º60ç§’ï¼Œå½“å‡ºç°é—®é¢˜çš„æ—¶å€™ç¨‹åºå¯èƒ½ä¼šåœæ­¢ä¸‹æ¥ï¼Œåªè¦åˆ°60ç§’ã€‚å°±ä¼šæ¿€æ´»ä¸‹é¢çš„timeoutåŠ¨ä½œï¼Œè¿™é‡Œæˆ‘ä»¬æ‰“å°ä¸€ä¸ªä¿¡æ¯å¹¶ä¸”åœæ­¢äº†è„šæ­¥çš„è¿è¡Œ&ndash;ä½ å¯ä»¥åšæ›´å¤šå…¶ä»–çš„äº‹æƒ…ï¼Œçœ‹è‡ªå·±çš„æ„æ€ã€‚</p>
<p>åœ¨å¦ä¸€ç§expectæ ¼å¼ä¸­ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ç§è®¾ç½®timeoutå˜é‡çš„æ–¹æ³•ï¼Œçœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>
<pre><code class="language-sh">spawn ssh root@192.168.1.1
expect {
    -timeout 60
    -re &quot;password:&quot; {exp_send &quot;word\r&quot;}
    -re &quot;TopsecOS#&quot; {  }
    timeout { puts &quot;Expect was timeout&quot;; return }
    -re &quot;TopsecOS#&quot; {  }
    timeout  { puts &quot;Expecr was timeout&quot;; return }
}
</code></pre>
<h2 id="ç”Ÿäº§åœºæ™¯expectå®æˆ˜">ç”Ÿäº§åœºæ™¯Expectå®æˆ˜</h2>
<pre><code class="language-sh">$ cat fenfa.exp
#!/usr/bin/expect
if { $argc != 3 } {
         send_user &quot;usage: expect scp-expect.exp file host dir\n&quot;
         exit
}

#define var
set file [lindex $argv 0]
set host [lindex $argv 1]
set dir  [lindex $argv 2]
set password &quot;111111&quot;
spawn scp -P 52113 -p $file root@$host:$dir
#spawn ssh-copy-id -i $file &quot;-p 52113 root@$host&quot;

expect {
    &quot;yes/no&quot;    {send &quot;yes\r&quot;;exp_continue}
    &quot;*password&quot; {send &quot;$password\r&quot;}
}

expect eof

exit -onexit {
    send_user &quot;Oldboy say good bye to you!\n&quot;
}

#script usage
#expect oldboy-6.exp file host dir
#example
#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts
</code></pre>
<h3 id="å®æˆ˜1ä½¿ç”¨expectå®ç°æ‰¹é‡åˆ†å‘etchostsæ–‡ä»¶">å®æˆ˜1ï¼šä½¿ç”¨expectå®ç°æ‰¹é‡åˆ†å‘/etc/hostsæ–‡ä»¶</h3>
<pre><code class="language-sh">$ cat hosts.sh 
#!/bin/sh
. /etc/init.d/functions
for ip in 192.168.252.60 192.168.252.64  192.168.252.62
do
expect fenfa.exp /etc/hosts/ $ip ~/ &gt;/dev/null 2&gt;&amp;1
if [ $? -eq 0 ];then
    action &quot;$ip&quot; /bin/true
else 
    action &quot;$ip&quot; /bin/false
fi
done
</code></pre>
<p>å¦‚æœipå¾ˆå¤šå†™å¾ªç¯åˆ—è¡¨</p>
<pre><code class="language-sh">for ip in `cat ip_list`
</code></pre>
<p>æµ‹è¯•ç»“æœï¼š</p>
<pre><code class="language-sh">$ sh hosts.sh   
192.168.252.60                                             [ç¡®å®š]
192.168.252.64                                             [ç¡®å®š]
192.168.252.62                                             [ç¡®å®š]
</code></pre>
<h3 id="å®æˆ˜2ä½¿ç”¨expectæ‰¹é‡åˆ†å‘sshå¯†é’¥æ–‡ä»¶">å®æˆ˜2ï¼šä½¿ç”¨expectæ‰¹é‡åˆ†å‘SSHå¯†é’¥æ–‡ä»¶</h3>
<p>é¦–å…ˆå‡†å¤‡4å°æœºå™¨ï¼š</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>hostname-</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.252.60</td>
<td>lamp_client</td>
</tr>
<tr>
<td>192.168.252.62</td>
<td>rsync_client</td>
</tr>
<tr>
<td>192.168.252.63</td>
<td>nfs_server</td>
</tr>
<tr>
<td>192.168.252.64</td>
<td>mysql_client</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>1 åœ¨serverç«¯åˆ›å»ºå…¬é’¥ä¸ç§é’¥</strong></p>
</blockquote>
<pre><code class="language-sh">$ ssh-keygen -t dsa
Generating public/private dsa key pair.
Enter file in which to save the key (/root/.ssh/id_dsa): 
Created directory '/root/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_dsa.
Your public key has been saved in /root/.ssh/id_dsa.pub.
The key fingerprint is:
85:c5:f0:88:31:ed:a6:e6:9f:54:61:1e:68:ee:b2:c7 root@server-nfs
The key's randomart image is:
+--[ DSA 1024]----+
|      o..o.      |
|       +.*.      |
|      ..= *      |
|       oo+ o     |
|       oS o      |
|      o. .       |
|     o..o        |
|      .+E.       |
|      .oo        |
+-----------------+
</code></pre>
<blockquote>
<p><strong>2 æŸ¥çœ‹å¯†é’¥</strong></p>
</blockquote>
<pre><code class="language-sh">$ ll ~/.ssh/
id_dsa
id_dsa.pub
</code></pre>
<blockquote>
<p><strong>3 å†™æ‰¹é‡æ‹·è´è„šæœ¬</strong></p>
</blockquote>
<pre><code class="language-sh">#!/usr/bin/expect
if { $argc != 2 } {
    send_user &quot;usage: expect scp-expect.exp file host dir\n&quot;
    exit
}
#define var
set file [lindex $argv 0]
set host [lindex $argv 1]
set password &quot;111111&quot;
#spawn scp /etc/hosts root@10.0.0.142:/etc/hosts
spawn ssh-copy-id -i $file &quot;-p 52113 root@$host&quot;
expect {
     &quot;yes/no&quot;    {send &quot;yes\r&quot;;exp_continue}
     &quot;*password&quot; {send &quot;$password\r&quot;}
}

expect eof

exit -onexit {
     send_user &quot;Oldboy say good bye to you!\n&quot;
}

#script usage
#expect oldboy-6.exp file host dir
#example
#./oldboy-6.exp /etc/hosts 10.0.0.179 /etc/hosts
</code></pre>
<pre><code class="language-sh">$ ll ~/.ssh/
authorized_keys

$ ll ~/.ssh/
id_dsa
id_dsa.pub
known_hosts

$ ll ~/.ssh/
authorized_keys

$ ll ~/.ssh/
authorized_keys
</code></pre>
<pre><code class="language-sh">$ ssh -p52113 root@192.168.252.60 ifconfig
eth0      Link encap:Ethernet  HWaddr 00:0C:29:A7:DB:43  
          inet addr:192.168.252.60  Bcast:192.168.252.255  Mask:255.255.255.0
          inet6 addr: fe80::20c:29ff:fea7:db43/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:1187 errors:0 dropped:0 overruns:0 frame:0
          TX packets:792 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:105294 (102.8 KiB)  TX bytes:73135 (71.4 KiB)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:40 errors:0 dropped:0 overruns:0 frame:0
          TX packets:40 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:3520 (3.4 KiB)  TX bytes:3520 (3.4 KiB)
</code></pre>
<p>å¤§åŠŸå‘Šæˆã€‚</p>
<p><strong><font color="#0215cd" size=2> ç‰¹åˆ«æç¤º</font></strong>ï¼šå¦‚æœæ˜¯ç¦æ­¢äº†ROOTè¿œç¨‹è¿æ¥ï¼Œé‚£ä¹ˆå°±ä½¿ç”¨æ™®é€šç”¨æˆ·åŠ sudoçš„æ–¹å¼ç»“åˆåœ¨expectå¤§é‡åˆ†å‘ã€‚æœ‰çš„åŒå­¦ä»¬é—®ï¼Œæ—¢ç„¶åšå¯†é’¥è®¤è¯äº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦expectåˆ†å‘å‘¢ã€‚åœ¨åšè®¤è¯æœŸé—´ï¼Œç¬¬ä¸€æ¬¡çš„å¯†é’¥åˆ†å‘ï¼Œå¦‚æœæœºå™¨æ•°é‡å¤šï¼Œæ¯”å¦‚1000å°ï¼Œå°±å¯ä»¥expectåˆ†å‘ï¼Œæ¯”ssh-copy-idæ–¹å¼æˆ–httpçš„æ–¹å¼éƒ½ä¼šå¥½ä¸€ç‚¹ã€‚</p>
<p>å½“ç„¶ä»ä¾‹ä¸€å¯ä»¥çœ‹å‡ºæ¥ï¼Œå³ä½¿ä¸ç”¨å¯†é’¥è®¤è¯ï¼Œexpectä¾ç„¶å¯ä»¥å®ç°åˆ†å‘æ•°æ®åŠæ–‡ä»¶åŠæ‰¹é‡ç®¡ç†éƒ¨ç½²æœåŠ¡ã€‚</p>
]]></content:encoded>
    </item>
    
    <item>
      <title>LinuxæœåŠ¡ç®¡ç† - systemd</title>
      <link>https://www.oomkill.com/2016/04/systemd/</link>
      <pubDate>Thu, 21 Apr 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/04/systemd/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="å…³äºlinuxæœåŠ¡ç®¡ç†">å…³äºLinuxæœåŠ¡ç®¡ç†</h2>
<p>Linuxç³»ç»Ÿä»å¯åŠ¨åˆ°æä¾›æœåŠ¡çš„è¿‡ç¨‹æ˜¯è¿™æ ·ï¼Œå…ˆæ˜¯æœºå™¨åŠ ç”µï¼Œç„¶åé€šè¿‡MBRæˆ–è€…UEFIåŠ è½½GRUBï¼Œå†å¯åŠ¨å†…æ ¸ï¼Œå†…æ ¸å¯åŠ¨æœåŠ¡ï¼Œç„¶åå¼€å§‹å¯¹å¤–æœåŠ¡ã€‚
SysV init UpStart systemdä¸»è¦æ˜¯è§£å†³æœåŠ¡å¼•å¯¼ç®¡ç†çš„é—®é¢˜ã€‚</p>
<ul>
<li>CentOS 5ï¼šSysV init</li>
<li>CentOS 6ï¼šUpstart</li>
<li>CentOS 7ï¼šSystemd <a href="http://www.linuxidc.com/Linux/2015-04/115937.htm" target="_blank"
   rel="noopener nofollow noreferrer" >http://www.linuxidc.com/Linux/2015-04/115937.htm</a></li>
</ul>
<h3 id="11-sysv-initçš„ä¼˜ç¼ºç‚¹">1.1 SysV initçš„ä¼˜ç¼ºç‚¹</h3>
<p>SysV initæ˜¯æœ€æ—©çš„è§£å†³æ–¹æ¡ˆï¼Œä¾é åˆ’åˆ†ä¸åŒçš„è¿è¡Œçº§åˆ«ï¼Œå¯åŠ¨ä¸åŒçš„æœåŠ¡é›†ï¼ŒæœåŠ¡ä¾é è„šæœ¬æ§åˆ¶ï¼Œå¹¶ä¸”æ˜¯é¡ºåºæ‰§è¡Œçš„ã€‚</p>
<p>SysV initæ–¹æ¡ˆçš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>1.åŸç†ç®€å•ï¼Œæ˜“äºç†è§£ï¼›</li>
<li>2.ä¾é shellè„šæœ¬æ§åˆ¶ï¼Œç¼–å†™æœåŠ¡è„šæœ¬é—¨æ§›æ¯”è¾ƒä½ã€‚</li>
</ul>
<p>ç¼ºç‚¹æ˜¯ï¼š</p>
<ul>
<li>1.æœåŠ¡é¡ºåºå¯åŠ¨ï¼Œå¯åŠ¨è¿‡ç¨‹æ¯”è¾ƒæ…¢ã€‚</li>
<li>2.ä¸èƒ½åšåˆ°æ ¹æ®éœ€è¦æ¥å¯åŠ¨æœåŠ¡ï¼Œæ¯”å¦‚é€šå¸¸å¸Œæœ›æ’å…¥Uç›˜çš„æ—¶å€™ï¼Œå†å¯åŠ¨USBæ§åˆ¶çš„æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½çš„èŠ‚çœç³»ç»Ÿèµ„æºã€‚</li>
</ul>
<h3 id="12-upstartçš„æ”¹è¿›">1.2 UpStartçš„æ”¹è¿›</h3>
<p>ä¸ºäº†è§£å†³ç³»ç»ŸæœåŠ¡çš„å³æ’å³ç”¨ï¼ŒUpStartåº”è¿è€Œç”Ÿï¼Œåœ¨CentOS6ç³»ç»Ÿä¸­ï¼ŒSysV initå’ŒUpStartæ˜¯å¹¶å­˜çš„ï¼ŒUpStartä¸»è¦è§£å†³äº†æœåŠ¡çš„å³æ’å³ç”¨ã€‚æœåŠ¡é¡ºåºå¯åŠ¨æ…¢çš„é—®é¢˜ï¼ŒUpStartçš„è§£å†³åŠæ³•æ˜¯æŠŠç›¸å…³çš„æœåŠ¡åˆ†ç»„ï¼Œç»„å†…çš„æœåŠ¡æ˜¯é¡ºåºå¯åŠ¨ï¼Œç»„ä¹‹é—´æ˜¯å¹¶è¡Œå¯åŠ¨ã€‚</p>
<h3 id="13-systemdçš„è¯ç”Ÿ">1.3 systemdçš„è¯ç”Ÿ</h3>
<p>SysV initæœåŠ¡å¯åŠ¨æ…¢ï¼Œåœ¨ä»¥å‰å¹¶ä¸æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œå°¤å…¶æ˜¯Linuxç³»ç»Ÿä»¥å‰ä¸»è¦æ˜¯åœ¨æœåŠ¡å™¨ç³»ç»Ÿä¸Šï¼Œå¸¸å¹´ä¹Ÿéš¾å¾—é‡å¯ä¸€æ¬¡ã€‚æœ‰çš„æœåŠ¡å™¨å…‰ç¡¬ä»¶æ£€æµ‹éƒ½éœ€è¦5åˆ†é’Ÿä»¥ä¸Šï¼Œç›¸å¯¹æ¥è¯´ç³»ç»Ÿå¯åŠ¨å·²ç»å¾ˆå¿«äº†ã€‚</p>
<p>ä½†æ˜¯éšç€ç§»åŠ¨äº’è”ç½‘çš„åˆ°æ¥ï¼ŒSysV initæœåŠ¡å¯åŠ¨æ…¢çš„é—®é¢˜æ˜¾å¾—è¶Šæ¥è¶Šçªå‡ºï¼Œè®¸å¤šç§»åŠ¨è®¾å¤‡éƒ½æ˜¯åŸºäºLinuxå†…æ ¸ï¼Œæ¯”å¦‚å®‰å“ã€‚ç§»åŠ¨è®¾å¤‡å¯åŠ¨æ¯”è¾ƒé¢‘ç¹ï¼Œæ¯æ¬¡å¯åŠ¨éƒ½è¦ç­‰å¾…æœåŠ¡é¡ºåºå¯åŠ¨ï¼Œæ˜¾ç„¶éš¾ä»¥æ¥å—ï¼Œsystemdå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è¯ç”Ÿçš„ã€‚</p>
<p><strong>systemdçš„è®¾è®¡æ€è·¯æ˜¯</strong>ï¼š</p>
<ul>
<li>å°½å¯èƒ½çš„å¿«é€Ÿå¯åŠ¨æœåŠ¡ã€‚</li>
<li>å°½å¯èƒ½çš„å‡å°‘ç³»ç»Ÿèµ„æºå ç”¨ã€‚</li>
</ul>
<h3 id="14-ä¸ºä»€ä¹ˆsystemdèƒ½åšåˆ°å¯åŠ¨å¾ˆå¿«">1.4 ä¸ºä»€ä¹ˆsystemdèƒ½åšåˆ°å¯åŠ¨å¾ˆå¿«</h3>
<p>systemdä½¿ç”¨å¹¶è¡Œçš„æ–¹æ³•å¯åŠ¨æœåŠ¡ï¼Œä¸åƒSysV initæ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¤§å¤§èŠ‚çœäº†ç³»ç»Ÿå¯åŠ¨æ—¶é—´ã€‚</p>
<p>ä½¿ç”¨å¹¶è¡Œå¯åŠ¨ï¼Œæœ€å¤§çš„éš¾ç‚¹æ˜¯è¦è§£å†³æœåŠ¡ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œsystemdçš„è§£å†³åŠæ³•æ˜¯ä½¿ç”¨ç±»ä¼¼ç¼“å†²æ± çš„åŠæ³•ã€‚æ¯”å¦‚å¯¹TCPæœ‰ä¾èµ–çš„æœåŠ¡ï¼Œåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šæ£€æŸ¥ä¾èµ–æœåŠ¡çš„TCPç«¯å£ï¼Œsystemdä¼šæŠŠå¯¹TCPç«¯å£çš„è¯·æ±‚å…ˆç¼“å­˜èµ·æ¥ï¼Œå½“ä¾èµ–çš„æœåŠ¡å™¨å¯åŠ¨ä¹‹åï¼Œåœ¨å°†è¯·æ±‚ä¼ é€’ç»™æœåŠ¡ï¼Œä½¿ä¸¤ä¸ªæœåŠ¡é€šè®¯ã€‚åŒæ ·çš„è¿›ç¨‹é—´é€šè®¯çš„D-BUSä¹Ÿæ˜¯è¿™æ ·çš„åŸç†ï¼Œç›®å½•æŒ‚è½½åˆ™æ˜¯å…ˆè®©æœåŠ¡ä»¥ä¸ºç›®å½•è¢«æŒ‚è½½äº†ï¼Œåˆ°çœŸæ­£è®¿é—®ç›®å½•çš„æ—¶å€™ï¼Œæ‰å»çœŸæ­£æ“ä½œã€‚</p>
<h2 id="systemdçš„ç‰¹æ€§">systemdçš„ç‰¹æ€§</h2>
<p><strong>systemdè§£å†³äº†é‚£äº›é—®é¢˜ï¼Ÿ</strong></p>
<ul>
<li>æŒ‰éœ€å¯åŠ¨æœåŠ¡ï¼Œå‡å°‘ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼›</li>
<li>å°½å¯èƒ½å¹¶è¡Œå¯åŠ¨è¿›ç¨‹ï¼Œå‡å°‘ç³»ç»Ÿå¯åŠ¨ç­‰å¾…æ—¶é—´ï¼›</li>
<li>æä¾›ä¸€ä¸ªä¸€è‡´çš„é…ç½®ç¯å¢ƒï¼Œä¸å…‰æ˜¯æœåŠ¡é…ç½®ï¼›</li>
<li>æä¾›æœåŠ¡çŠ¶æ€å¿«ç…§ï¼Œå¯ä»¥æ¢å¤ç‰¹å®šç‚¹çš„æœåŠ¡çŠ¶æ€ã€‚</li>
</ul>
<h2 id="centos-7çš„systemdç‰¹æ€§">CentOS 7çš„systemdç‰¹æ€§</h2>
<h3 id="31-å¥—æ¥å­—æœåŠ¡ä¿æŒæ¿€æ´»åŠŸèƒ½">3.1 å¥—æ¥å­—æœåŠ¡ä¿æŒæ¿€æ´»åŠŸèƒ½</h3>
<p>åœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™ï¼Œsystemdä¸ºæ‰€æœ‰æ”¯æŒå¥—æ¥å­—æ¿€æ´»åŠŸèƒ½çš„æœåŠ¡åˆ›å»ºç›‘å¬ç«¯å£ï¼Œå½“æœåŠ¡å¯åŠ¨åï¼Œå°±å°†å¥—æ¥å­—ä¼ ç»™è¿™äº›æœåŠ¡ã€‚è¿™ç§æ–¹å¼ä¸ä»…å¯ä»¥å…è®¸æœåŠ¡åœ¨å¯åŠ¨çš„æ—¶å€™å¹³è¡Œå¯åŠ¨ï¼Œä¹Ÿå¯ä»¥ä¿è¯åœ¨æœåŠ¡é‡å¯æœŸé—´ï¼Œè¯•å›¾è¿æ¥æœåŠ¡çš„è¯·æ±‚ï¼Œä¸ä¼šä¸¢å¤±ã€‚å¯¹æœåŠ¡ç«¯å£çš„è¯·æ±‚è¢«ä¿ç•™ï¼Œå¹¶ä¸”å­˜æ”¾åˆ°é˜Ÿåˆ—ä¸­ã€‚</p>
<h3 id="32-è¿›ç¨‹é—´é€šè®¯ä¿æŒæ¿€æ´»åŠŸèƒ½">3.2 è¿›ç¨‹é—´é€šè®¯ä¿æŒæ¿€æ´»åŠŸèƒ½</h3>
<p>å½“æœ‰å®¢æˆ·ç«¯åº”ç”¨ç¬¬ä¸€æ¬¡é€šè¿‡D-Busæ–¹å¼è¯·æ±‚è¿›ç¨‹é—´é€šè®¯æ—¶ï¼Œsystemdä¼šç«‹å³å¯åŠ¨å¯¹åº”çš„æœåŠ¡ã€‚systemdä¾æ®D-Busçš„é…ç½®æ–‡ä»¶ä½¿ç”¨è¿›ç¨‹é—´é€šè®¯ä¿æŒæ¿€æ´»åŠŸèƒ½ã€‚</p>
<h3 id="33-è®¾å¤‡ä¿æŒæ¿€æ´»åŠŸèƒ½">3.3 è®¾å¤‡ä¿æŒæ¿€æ´»åŠŸèƒ½</h3>
<p>å½“ç‰¹å®šçš„ç¡¬ä»¶æ’å…¥æ—¶ï¼Œsystemdå¯åŠ¨å¯¹åº”çš„ç¡¬ä»¶æœåŠ¡æ”¯æŒã€‚systemdä¾æ®ç¡¬ä»¶æœåŠ¡å•å…ƒé…ç½®æ–‡ä»¶ä¿æŒç¡¬ä»¶éšæ—¶è¢«æ¿€æ´»ã€‚</p>
<h3 id="34-æ–‡ä»¶è·¯å¾„ä¿æŒæ¿€æ´»åŠŸèƒ½">3.4 æ–‡ä»¶è·¯å¾„ä¿æŒæ¿€æ´»åŠŸèƒ½</h3>
<p>å½“ç‰¹å®šçš„æ–‡ä»¶æˆ–è€…è·¯å¾„çŠ¶æ€å‘ç”Ÿæ”¹å˜çš„æ—¶å€™ï¼Œsystemdä¼šæ¿€æ´»å¯¹åº”çš„æœåŠ¡ã€‚systemdä¾æ®è·¯å¾„æœåŠ¡å•å…ƒé…ç½®æ–‡ä»¶ä¿è¯æœåŠ¡è¢«æ¿€æ´»ã€‚</p>
<h3 id="35-ç³»ç»ŸçŠ¶æ€å¿«ç…§">3.5 ç³»ç»ŸçŠ¶æ€å¿«ç…§</h3>
<p>systemdå¯ä»¥ä¸´æ—¶ä¿å­˜å½“å‰æ‰€æœ‰çš„å•å…ƒé…ç½®æ–‡ä»¶ï¼Œæˆ–è€…ä»å‰ä¸€ä¸ªå¿«ç…§ä¸­æ¢å¤å•å…ƒé…ç½®æ–‡ä»¶ã€‚ä¸ºäº†ä¿å­˜å½“å‰ç³»ç»ŸæœåŠ¡çŠ¶æ€ï¼Œsystemdå¯ä»¥åŠ¨æ€çš„ç”Ÿæˆå•å…ƒæ–‡ä»¶å¿«ç…§ã€‚</p>
<h3 id="36-æŒ‚è½½å’Œè‡ªåŠ¨æŒ‚è½½ç‚¹ç®¡ç†">3.6 æŒ‚è½½å’Œè‡ªåŠ¨æŒ‚è½½ç‚¹ç®¡ç†</h3>
<p>systemdç›‘æ§å’Œç®¡ç†æŒ‚è½½å’Œè‡ªåŠ¨æŒ‚è½½ç‚¹ï¼Œå¹¶æ ¹æ®æŒ‚è½½ç‚¹çš„å•å…ƒé…ç½®æ–‡ä»¶è¿›è¡ŒæŒ‚è½½ã€‚</p>
<h3 id="37-é—ªç”µå¹¶è¡Œå¯åŠ¨">3.7 é—ªç”µå¹¶è¡Œå¯åŠ¨</h3>
<p>å› ä¸ºä½¿ç”¨å¥—æ¥å­—ä¿æŒæ¿€æ´»åŠŸèƒ½ï¼Œsystemdå¯ä»¥å¹¶è¡Œçš„å¯åŠ¨æ‰€ä»¥å¥—æ¥å­—ç›‘å¬æœåŠ¡ï¼Œå¤§å¤§å‡å°‘ç³»ç»Ÿå¯åŠ¨æ—¶é—´ã€‚</p>
<h3 id="38-å•å…ƒé€»è¾‘æ¨¡æ‹Ÿæ£€æŸ¥">3.8 å•å…ƒé€»è¾‘æ¨¡æ‹Ÿæ£€æŸ¥</h3>
<p>å½“æ¿€æ´»æˆ–è€…å…³é—­ä¸€ä¸ªå•å…ƒï¼Œsystemdä¼šè®¡ç®—ä¾èµ–è¡Œï¼Œäº§ç”Ÿä¸€ä¸ªä¸´æ—¶çš„æ¨¡æ‹Ÿæ£€æŸ¥ï¼Œå¹¶ä¸”æ ¡éªŒä¸€ç›´æ€§ã€‚å¦‚æœä¸ä¸€è‡´ï¼Œsystemdä¼šå°è¯•è‡ªåŠ¨ä¿®æ­£ï¼Œå¹¶ä¸”ç§»é™¤æŠ¥é”™çš„ä¸é‡è¦çš„ä»»åŠ¡ã€‚</p>
<h3 id="39-å’Œsysv-initå‘åå…¼å®¹">3.9 å’ŒSysV initå‘åå…¼å®¹</h3>
<p>systemdå®Œå…¨æ”¯æŒSysV init Linuxæ ‡å‡†çš„åŸºç¡€æ ¸å¿ƒè§„èŒƒè„šæœ¬ï¼Œè¿™æ ·çš„è„šæœ¬æ˜“äºå‡çº§åˆ°systemdæœåŠ¡å•å…ƒã€‚</p>
<h2 id="æ ¸å¿ƒæ¦‚å¿µunit">æ ¸å¿ƒæ¦‚å¿µ:unit</h2>
<h3 id="41-ä»€ä¹ˆæ˜¯å•å…ƒ">4.1 ä»€ä¹ˆæ˜¯å•å…ƒ</h3>
<p>åœ¨RHEL7ä¹‹å‰ï¼ŒæœåŠ¡ç®¡ç†æ˜¯åˆ†å¸ƒå¼çš„è¢«SysV initæˆ–UpStarté€šè¿‡ <font color="#f8070d" size=3><code>/etc/rc.d/init.d</code></font> ä¸‹çš„è„šæœ¬ç®¡ç†ã€‚è¿™äº›è„šæœ¬æ˜¯ç»å…¸çš„Bashè„šæœ¬ï¼Œå…è®¸ç®¡ç†å‘˜æ§åˆ¶æœåŠ¡çš„çŠ¶æ€ã€‚åœ¨RHEL7ä¸­ï¼Œè¿™äº›è„šæœ¬è¢«æœåŠ¡å•å…ƒæ–‡ä»¶æ›¿æ¢ã€‚</p>
<p>åœ¨systemdä¸­ï¼ŒæœåŠ¡ã€æŒ‚è½½ç­‰èµ„æºç»Ÿä¸€è¢«ç§°ä¸ºå•å…ƒï¼Œæ‰€ä»¥systemdä¸­æœ‰è®¸å¤šå•å…ƒç±»å‹ï¼ŒæœåŠ¡å•å…ƒæ–‡ä»¶çš„æ‰©å±•åæ˜¯.serviceï¼ŒåŒè„šæœ¬çš„åŠŸèƒ½ç›¸ä¼¼ã€‚ä¾‹å¦‚æœ‰æŸ¥çœ‹ã€å¯åŠ¨ã€åœæ­¢ã€é‡å¯ã€å¯ç”¨æˆ–è€…ç¦æ­¢æœåŠ¡çš„å‚æ•°ã€‚</p>
<p>é…ç½®æ–‡ä»¶è¿›è¡Œæ ‡è¯†å’Œé…ç½®ï¼šæ–‡ä»¶ä¸­ä¸»è¦åŒ…å«äº†ç³»ç»ŸæœåŠ¡ã€ç›‘å¬socketã€ä¿å­˜çš„ç³»ç»Ÿå¿«ç…§åŠå…¶ä»–ä¸initç›¸å…³çš„ä¿¡æ¯ã€‚</p>
<p><strong>systemdå•å…ƒæ–‡ä»¶æ”¾ç½®ä½ç½®</strong>ï¼š</p>
<pre><code class="language-sh">/usr/lib/systemd/system/systemd		# é»˜è®¤å•å…ƒæ–‡ä»¶å®‰è£…ç›®å½•
/run/systemd/system					      # å•å…ƒè¿è¡Œæ—¶åˆ›å»ºï¼Œè¿™ä¸ªç›®å½•ä¼˜å…ˆäºå®‰è£…ç›®å½•
/etc/systemd/system					      # ç³»ç»Ÿç®¡ç†å‘˜åˆ›å»ºå’Œç®¡ç†çš„å•å…ƒç›®å½•ï¼Œä¼˜å…ˆçº§æœ€é«˜ã€‚
</code></pre>
<h3 id="42-unitç±»å‹">4.2 Unitç±»å‹</h3>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>è¯¦è§£-</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸ºserviceï¼Œç”¨äºå®šä¹‰ç³»ç»ŸæœåŠ¡ã€‚</td>
</tr>
<tr>
<td>Target unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.targetï¼Œç”¨äºæ¨¡æ‹Ÿå®ç°â€œè¿è¡Œçº§åˆ«â€</td>
</tr>
<tr>
<td>Device unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.deviceï¼Œç”¨äºå®šä¹‰å†…æ ¸è¯†åˆ«çš„è®¾å¤‡ã€‚</td>
</tr>
<tr>
<td>Mount unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.mountï¼Œå®šä¹‰æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹</td>
</tr>
<tr>
<td>Socket unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.socketï¼Œç”¨äºè¡¨ç¤ºè¿›ç¨‹é—´é€šä¿¡ç”¨çš„socketæ–‡ä»¶</td>
</tr>
<tr>
<td>Snapshot unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.sanpshotï¼Œç®¡ç†ç³»ç»Ÿå¿«ç…§</td>
</tr>
<tr>
<td>Swap unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.swapï¼Œç”¨äºè¡¨ç¤ºswapè®¾å¤‡</td>
</tr>
<tr>
<td>Automount unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.automountï¼Œæ–‡ä»¶ç³»ç»Ÿçš„è‡ªåŠ¨æŒ‚è½½ç‚¹</td>
</tr>
<tr>
<td>Path unit</td>
<td>æ–‡ä»¶æ‰©å±•åä¸º.pathï¼Œç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶æˆ–ç›®å½•</td>
</tr>
</tbody>
</table>
<p><code>.service</code> ä¸æœåŠ¡å¯¹åº”çš„åç¼€åä¸ºserviceçš„unitã€æ–‡ä»¶ï¼Œæ— éœ€æ‰§è¡Œæƒé™ï¼Œä»…ä»…ä¸ºsystemdçš„é…ç½®æ–‡ä»¶ã€‚å½“systemdæ¢æµ‹åˆ°æœ‰è¿›ç¨‹è®¿é—®æ—¶ï¼ŒæŒ‰éœ€æ¿€æ´»è¿™ä¸ªæœåŠ¡çš„æœºåˆ¶ï¼Œä»»ä½•ä¾èµ–ä¸è¿™ä¸ªæœåŠ¡çš„å…¶ä»–æœåŠ¡æƒ³å¯åŠ¨çš„è¯ï¼Œ</p>
<p>æœåŠ¡çš„å¹¶è¡Œå¯åŠ¨ï¼š</p>
<p><code>.device</code> åœ¨æŸä¸ªç¡¬ä»¶è®¾å¤‡è¢«æ¿€æ´»æˆ–å˜å¾—å¯ç”¨æ—¶ï¼Œä»è€Œæ¿€æ´»æœåŠ¡</p>
<p><code>.path</code>ï¼šæŸä¸ªæ–‡ä»¶è·¯å¾„å˜å¾—å¯ç”¨æˆ–é‡Œé¢æœ‰æ–‡ä»¶æ—¶ï¼ˆæ–‡ä»¶å‘ç”Ÿå˜åŠ¨ï¼‰æ¿€æ´»æŸä¸ªæœåŠ¡</p>
<p><strong>ç³»ç»Ÿå¿«ç…§</strong>ï¼š</p>
<p>systemdèƒ½å°†æ‰€æœ‰unitå½“å‰çŠ¶æ€ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼ˆä¸´æ—¶ä¿å­˜åˆ°ä¸€ä¸ªæŒä¹…è®¾å¤‡ä¸Šï¼‰ã€‚å¯åŠ¨æ—¶ï¼Œå¯ä»ä¿å­˜çš„å¿«ç…§å¼€å§‹ç»§ç»­å‘åè¿è¡Œã€‚ å¿…è¦æ—¶èƒ½è‡ªåŠ¨è½½å…¥ã€‚</p>
<p><strong>å‘åå…¼å®¹</strong>ï¼š</p>
<p>sysV initè„šæœ¬ã€‚ï¼ˆèƒ½å¤Ÿå…¼å®¹ startã€stop restart statusè‡³å°‘è¿™4ä¸ªæœåŠ¡è„šæœ¬ï¼‰ä»¥å‰å¯åŠ¨æœåŠ¡çš„è„šæœ¬æ”¾åˆ°centos7é‡Œç›´æ¥å¯ä»¥ç”¨ã€‚</p>
<h2 id="centos-7çš„systemdå‘åå…¼å®¹">CentOS 7çš„systemdå‘åå…¼å®¹</h2>
<p>systemdè¢«è®¾è®¡æˆå°½å¯èƒ½å‘åå…¼å®¹SysV initå’ŒUpstartï¼Œä¸‹é¢æ˜¯ä¸€äº›ç‰¹åˆ«è¦æ³¨æ„çš„å’Œä¹‹å‰ä¸»è¦ç‰ˆæœ¬çš„RHELä¸å†å…¼å®¹çš„éƒ¨åˆ†ã€‚</p>
<h3 id="51-systemdå¯¹è¿è¡Œçº§åˆ«æ”¯æŒæœ‰é™">5.1 systemdå¯¹è¿è¡Œçº§åˆ«æ”¯æŒæœ‰é™</h3>
<p>ä¸ºäº†ä¿å­˜å…¼å®¹ï¼Œsystemdæä¾›æœ‰é™targetå•å…ƒï¼Œâ€œæ¨¡æ‹Ÿâ€ä¸€äº›è¿è¡Œçº§åˆ«ï¼Œä¹Ÿå¯ä»¥è¢«æ—©æœŸçš„åˆ†å¸ƒå¼çš„è¿è¡Œçº§åˆ«å‘½ä»¤æ”¯æŒã€‚ä¸æ˜¯æ‰€æœ‰çš„targetéƒ½å¯ä»¥è¢«æ˜ å°„åˆ°è¿è¡Œçº§åˆ«ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨runlevelå‘½ä»¤æœ‰å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªä¸ºNçš„ä¸çŸ¥é“çš„è¿è¡Œçº§åˆ«ï¼Œæ‰€ä»¥æ¨èå°½é‡é¿å…åœ¨RHEL7ä¸­ä½¿ç”¨runlevelå‘½ä»¤ã€‚</p>
<h3 id="52-systemdä¸æ”¯æŒåƒinitè„šæœ¬é‚£æ ·çš„ä¸ªæ€§åŒ–å‘½ä»¤">5.2 systemdä¸æ”¯æŒåƒinitè„šæœ¬é‚£æ ·çš„ä¸ªæ€§åŒ–å‘½ä»¤ã€‚</h3>
<p>é™¤äº†ä¸€äº›æ ‡å‡†å‘½ä»¤å‚æ•°ä¾‹å¦‚ï¼šstartã€stopã€statusï¼ŒSysV initè„šæœ¬å¯ä»¥æ ¹æ®éœ€è¦æ”¯æŒæƒ³è¦çš„ä»»ä½•å‚æ•°ï¼Œé€šè¿‡å‚æ•°æä¾›é™„åŠ çš„åŠŸèƒ½ï¼Œå› ä¸ºSysV initçš„æœåŠ¡å™¨è„šæœ¬å®é™…ä¸Šå°±æ˜¯shellè„šæœ¬ï¼Œå‘½ä»¤å‚æ•°å®é™…ä¸Šå°±æ˜¯shellå­å‡½æ•°ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼ŒRHEL6çš„iptablesæœåŠ¡è„šæœ¬å¯ä»¥æ‰§è¡Œpanicå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥è®©ç³»ç»Ÿç«‹å³è¿›å…¥ç´§æ€¥æ¨¡å¼ï¼Œä¸¢å¼ƒæ‰€æœ‰çš„è¿›å…¥å’Œå‘å‡ºçš„æ•°æ®åŒ…ã€‚ä½†æ˜¯ç±»ä¼¼è¿™æ ·çš„å‘½ä»¤è¡Œå‚æ•°åœ¨systemdä¸­æ˜¯ä¸æ”¯æŒçš„ï¼Œsystemdåªæ”¯æŒåœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°ã€‚</p>
<h3 id="53-systemdä¸æ”¯æŒå’Œæ²¡æœ‰ä»systemdå¯åŠ¨çš„æœåŠ¡é€šè®¯">5.3 systemdä¸æ”¯æŒå’Œæ²¡æœ‰ä»systemdå¯åŠ¨çš„æœåŠ¡é€šè®¯ã€‚</h3>
<p>å½“systemdå¯åŠ¨æœåŠ¡çš„æ—¶å€™ï¼Œä»–ä¿å­˜è¿›ç¨‹çš„ä¸»IDä»¥ä¾¿äºè¿½è¸ªï¼Œsystemctlå·¥å…·ä½¿ç”¨è¿›ç¨‹PIDæŸ¥è¯¢å’Œç®¡ç†æœåŠ¡ã€‚ç›¸åçš„ï¼Œå¦‚æœç”¨æˆ·ä»å‘½ä»¤è¡Œå¯åŠ¨ç‰¹å®šçš„æœåŠ¡ï¼Œsystemctlå‘½ä»¤æ˜¯æ²¡æœ‰åŠæ³•åˆ¤æ–­è¿™ä¸ªæœåŠ¡çš„çŠ¶æ€æ˜¯å¯åŠ¨è¿˜æ˜¯è¿è¡Œçš„ã€‚</p>
<h3 id="54-systemdå¯ä»¥åªåœæ­¢è¿è¡Œçš„æœåŠ¡">5.4 systemdå¯ä»¥åªåœæ­¢è¿è¡Œçš„æœåŠ¡</h3>
<p>åœ¨RHEL6åŠä¹‹å‰çš„ç‰ˆæœ¬ï¼Œå½“å…³é—­ç³»ç»Ÿçš„ç¨‹åºå¯åŠ¨ä¹‹åï¼ŒRHEL6çš„ç³»ç»Ÿä¼šæ‰§è¡Œ/etc/rc0.d/ä¸‹æ‰€æœ‰æœåŠ¡è„šæœ¬çš„å…³é—­æ“ä½œï¼Œä¸ç®¡æœåŠ¡æ˜¯å¤„äºè¿è¡Œæˆ–è€…æ ¹æœ¬æ²¡æœ‰è¿è¡Œçš„çŠ¶æ€ã€‚è€Œsystemdå¯ä»¥åšåˆ°åªå…³é—­åœ¨è¿è¡Œçš„æœåŠ¡ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§èŠ‚çœå…³æœºçš„æ—¶é—´ã€‚</p>
<h3 id="55-ä¸èƒ½ä»æ ‡å‡†è¾“å‡ºè®¾å¤‡è¯»åˆ°ç³»ç»ŸæœåŠ¡ä¿¡æ¯">5.5 ä¸èƒ½ä»æ ‡å‡†è¾“å‡ºè®¾å¤‡è¯»åˆ°ç³»ç»ŸæœåŠ¡ä¿¡æ¯ã€‚</h3>
<p>systemdå¯åŠ¨æœåŠ¡çš„æ—¶å€™ï¼Œå°†æ ‡å‡†è¾“å‡ºä¿¡æ¯å®šå‘åˆ°/dev/nullï¼Œä»¥å…æ‰“æ‰°ç”¨æˆ·ã€‚</p>
<h3 id="56-systemdä¸ç»§æ‰¿ä»»ä½•ä¸Šä¸‹æ–‡ç¯å¢ƒ">5.6 systemdä¸ç»§æ‰¿ä»»ä½•ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚</h3>
<p>systemdä¸ç»§æ‰¿ä»»ä½•ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå¦‚ç”¨æˆ·æˆ–è€…ä¼šè¯çš„HOMEæˆ–è€…PATHçš„ç¯å¢ƒå˜é‡ã€‚æ¯ä¸ªæœåŠ¡å¾—åˆ°çš„æ˜¯å¹²å‡€çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚</p>
<h3 id="57-sysv-initè„šæœ¬ä¾èµ–æ€§">5.7 SysV initè„šæœ¬ä¾èµ–æ€§</h3>
<p>å½“systemdå¯åŠ¨SysV initè„šæœ¬ï¼Œsystemdåœ¨è¿è¡Œçš„æ—¶å€™ï¼Œä»LinuxStandardBase(LSB)Linuxæ ‡å‡†åº“å¤´æ–‡ä»¶è¯»å–æœåŠ¡çš„ä¾èµ–ä¿¡æ¯å¹¶ç»§æ‰¿ã€‚</p>
<h3 id="58-è¶…æ—¶æœºåˆ¶">5.8 è¶…æ—¶æœºåˆ¶</h3>
<p>ä¸ºäº†é˜²æ­¢ç³»ç»Ÿè¢«å¡ä½ï¼Œæ‰€æœ‰çš„æœåŠ¡æœ‰5åˆ†é’Ÿçš„è¶…æ—¶æœºåˆ¶ã€‚</p>
<h2 id="systemdæœåŠ¡ç®¡ç†">systemdæœåŠ¡ç®¡ç†</h2>
<p>ä½¿ç”¨systemclå‘½ä»¤å¯ä»¥æ§åˆ¶æœåŠ¡ï¼Œserviceå‘½ä»¤å’Œchkconfigå‘½ä»¤ä¾ç„¶å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯ä¸»è¦æ˜¯å‡ºäºå…¼å®¹çš„åŸå› ï¼Œåº”è¯¥å°½é‡é¿å…ä½¿ç”¨serviceå‘½ä»¤å’Œchkconfigå‘½ä»¤ã€‚</p>
<p>ä½¿ç”¨systemctlå‘½ä»¤çš„æ—¶å€™ï¼ŒæœåŠ¡åå­—çš„æ‰©å±•åå¯ä»¥å†™å…¨ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-sh">systemctl stop httpd.service
</code></pre>
<p>ä¹Ÿå¯ä»¥å¿½ç•¥ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-sh">systemctl stop httpd
</code></pre>
<h3 id="61-å¸¸ç”¨å‘½ä»¤">6.1 å¸¸ç”¨å‘½ä»¤</h3>
<h3 id="62-æœåŠ¡ç®¡ç†">6.2 æœåŠ¡ç®¡ç†</h3>
<table>
<thead>
<tr>
<th>è¯´æ˜</th>
<th>å‘½ä»¤</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯åŠ¨æœåŠ¡</td>
<td>service name start ==	systemctl start name.service</td>
</tr>
<tr>
<td>åœæ­¢æœåŠ¡</td>
<td>service name stop	== systemctl stop name.service</td>
</tr>
<tr>
<td>é‡å¯æœåŠ¡</td>
<td>service name restart	== systemctl restart name.service</td>
</tr>
<tr>
<td>æŸ¥çœ‹æœåŠ¡çŠ¶æ€</td>
<td>service name status == systemctl status name.service</td>
</tr>
<tr>
<td>æ¡ä»¶å¼é‡å¯</td>
<td>service name condrestart == systemctl try-restart name.service</td>
</tr>
<tr>
<td>é‡è½½æˆ–é‡å¯æœåŠ¡</td>
<td>systemctl reload-or-restart name.service</td>
</tr>
<tr>
<td>é‡è½½æˆ–æ¡ä»¶å¼é‡å¯</td>
<td>systemctl reload-or-try-restart name.service</td>
</tr>
<tr>
<td>ç¦æ­¢è®¾å®šä¸ºå¼€æœºè‡ªå¯åŠ¨</td>
<td>systemctl mask name.service</td>
</tr>
<tr>
<td>å–æ¶ˆè®¾å®šä¸ºå¼€æœºè‡ªå¯åŠ¨</td>
<td>systemctl unmask name.service</td>
</tr>
<tr>
<td>æŸ¥çœ‹æœåŠ¡å½“å‰æ¿€æ´»ä¸å¦çš„çŠ¶æ€</td>
<td>systemctl is-active name.service</td>
</tr>
<tr>
<td>å…è®¸æœåŠ¡å¼€æœºå¯åŠ¨</td>
<td>systemctl enable name.service</td>
</tr>
<tr>
<td>ç¦æ­¢æœåŠ¡å¼€æœºå¯åŠ¨</td>
<td>systemclt disable name.service</td>
</tr>
<tr>
<td>çº§åˆ«åˆ‡æ¢</td>
<td>systemctl list-units &ndash;type target</td>
</tr>
<tr>
<td>è·å–é»˜è®¤è¿è¡Œçº§åˆ«</td>
<td>systemctl get-default</td>
</tr>
<tr>
<td>ä¿®æ”¹é»˜è®¤çº§åˆ«</td>
<td>systemctl set-default name.service</td>
</tr>
<tr>
<td>åˆ‡æ¢è‡³ç´§æ€¥æ•‘æ´æ¨¡å¼</td>
<td>systemctl rescue</td>
</tr>
<tr>
<td>åˆ‡æ¢è‡³emergencyæ¨¡å¼</td>
<td>systemctl emergency</td>
</tr>
<tr>
<td>å…³æœº</td>
<td>systemctl halt systemctl poweroff</td>
</tr>
<tr>
<td>é‡å¯</td>
<td>systemctl reboot</td>
</tr>
<tr>
<td>æŒ‚èµ·</td>
<td>systemctl suspend</td>
</tr>
<tr>
<td>å¿«ç…§</td>
<td>systemctl hibernate</td>
</tr>
<tr>
<td>å¿«ç…§å¹¶æŒ‚èµ·</td>
<td>systemctl hybrid-sleep</td>
</tr>
</tbody>
</table>
<h3 id="63-æŸ¥çœ‹æœåŠ¡è¯¦ç»†ä¿¡æ¯">6.3 æŸ¥çœ‹æœåŠ¡è¯¦ç»†ä¿¡æ¯</h3>
<p>æŸ¥çœ‹æ‰€æœ‰å·²æ¿€æ´»çš„æœåŠ¡ã€‚é»˜è®¤åªåˆ—å‡ºå¤„äºæ¿€æ´»çŠ¶æ€çš„æœåŠ¡ï¼Œå¦‚æœå¸Œæœ›çœ‹åˆ°æ‰€æœ‰çš„æœåŠ¡ï¼Œä½¿ç”¨&ndash;allæˆ–-aå‚æ•°ï¼š</p>
<pre><code class="language-sh">systemctl list-units --type service
</code></pre>
<p>æŸ¥çœ‹æ‰€æœ‰çš„æœåŠ¡</p>
<pre><code class="language-sh">systemctl list-units --type service --all
</code></pre>
<p>æ£€æŸ¥æœåŠ¡å¼€æœºå¯åŠ¨çŠ¶æ€</p>
<pre><code class="language-sh">systemctl status name.service
systemctl is-enabled name.service
</code></pre>
<p>åˆ—å‡ºæ‰€æœ‰æœåŠ¡å¹¶ä¸”æ£€æŸ¥æ˜¯å¦å¼€æœºå¯åŠ¨</p>
<pre><code class="language-sh">systemctl list-unit-files --type service
</code></pre>
<p>é€‰é¡¹é‡æ–°åŠ è½½æ‰€ä»¥å•å…ƒæ–‡ä»¶å¹¶é‡æ–°åˆ›å»ºä¾èµ–ä¹¦ï¼Œåœ¨éœ€è¦ç«‹å³åº”ç”¨å•å…ƒæ–‡ä»¶æ”¹å˜çš„æ—¶å€™ä½¿ç”¨ã€‚å¦å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨init qçš„å‘½ä»¤è¾¾åˆ°åŒæ ·çš„ç›®çš„ã€‚è¿˜æœ‰ï¼Œå¦‚æœä¿®æ”¹çš„æ˜¯ä¸€ä¸ªæ­£åœ¨è¿è¡ŒæœåŠ¡çš„å•å…ƒæ–‡ä»¶ï¼ŒæœåŠ¡éœ€è¦è¢«é‡å¯ä¸‹ï¼š</p>
<pre><code class="language-sh">systemct lrestart name.service
systemctl daemon-reload
</code></pre>
<p>æŸ¥çœ‹æœåŠ¡ä¾èµ–å…³ç³»</p>
<pre><code class="language-sh">systemctl list-dependencies
</code></pre>
<h2 id="systemd-target">systemd target</h2>
<p>åœ¨RHEL7ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä½¿ç”¨è¿è¡Œçº§åˆ«ä»£è¡¨ç‰¹å®šçš„æ“ä½œæ¨¡å¼ã€‚è¿è¡Œçº§åˆ«è¢«å®šä¹‰ä¸ºä¸ƒä¸ªçº§åˆ«ï¼Œç”¨æ•°å­—0åˆ°6è¡¨ç¤ºï¼Œæ¯ä¸ªçº§åˆ«å¯ä»¥å¯åŠ¨ç‰¹å®šçš„ä¸€äº›æœåŠ¡ã€‚RHEL7ä½¿ç”¨targetæ›¿æ¢è¿è¡ŒåŸºæœ¬ã€‚</p>
<p>systemd targetä½¿ç”¨targetå•å…ƒæ–‡ä»¶æè¿°ï¼Œtargetå•ä½æ–‡ä»¶æ‰©å±•åæ˜¯.targetï¼Œtargetå•å…ƒæ–‡ä»¶çš„å”¯ä¸€ç›®æ ‡æ˜¯å°†å…¶ä»–systemdå•å…ƒæ–‡ä»¶é€šè¿‡ä¸€è¿ä¸²çš„ä¾èµ–å…³ç³»ç»„ç»‡åœ¨ä¸€èµ·ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œgraphical.targetå•å…ƒï¼Œç”¨äºå¯åŠ¨ä¸€ä¸ªå›¾å½¢ä¼šè¯ï¼Œsystemdä¼šå¯åŠ¨åƒGNOMEæ˜¾ç¤ºç®¡ç†(gdm.service)ã€å¸å·æœåŠ¡ï¼ˆaxxounts-daemonï¼‰è¿™æ ·çš„æœåŠ¡ï¼Œå¹¶ä¸”ä¼šæ¿€æ´»multi-user.targetå•å…ƒã€‚ç›¸ä¼¼çš„multi-user.targetå•å…ƒï¼Œä¼šå¯åŠ¨å¿…ä¸å¯å°‘NetworkManager.serviceã€dbus.serviceæœåŠ¡ï¼Œå¹¶æ¿€æ´»basic.targetå•å…ƒã€‚</p>
<p>RHEL7é¢„å®šä¹‰äº†ä¸€äº›targetå’Œä¹‹å‰çš„è¿è¡Œçº§åˆ«æˆ–å¤šæˆ–å°‘æœ‰äº›ä¸åŒã€‚ä¸ºäº†å…¼å®¹ï¼Œsystemdä¹Ÿæä¾›ä¸€äº›targetæ˜ å°„ä¸ºSysV initçš„è¿è¡Œçº§åˆ«ï¼Œå…·ä½“çš„å¯¹åº”ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ä»£ç </th>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>runlevel0.target,poweroff.targe</td>
<td>å…³é—­ç³»ç»Ÿã€‚</td>
</tr>
<tr>
<td>1</td>
<td>runlevel1.target,rescue.target</td>
<td>è¿›å…¥æ•‘æ´æ¨¡å¼ã€‚</td>
</tr>
<tr>
<td>2</td>
<td>runlevel2.target,multi-user.target</td>
<td>è¿›å…¥éå›¾å½¢ç•Œé¢çš„å¤šç”¨æˆ·æ–¹å¼ã€‚</td>
</tr>
<tr>
<td>3</td>
<td>runlevel3.target,multi-user.target</td>
<td>è¿›å…¥éå›¾å½¢ç•Œé¢çš„å¤šç”¨æˆ·æ–¹å¼ã€‚</td>
</tr>
<tr>
<td>4</td>
<td>runlevel4.target,multi-user.target</td>
<td>è¿›å…¥éå›¾å½¢ç•Œé¢çš„å¤šç”¨æˆ·æ–¹å¼ã€‚</td>
</tr>
<tr>
<td>5</td>
<td>runlevel5.target,graphical.target</td>
<td>è¿›å…¥å›¾å½¢ç•Œé¢çš„å¤šç”¨æˆ·æ–¹å¼ã€‚</td>
</tr>
<tr>
<td>6</td>
<td>runlevel6.target,reboot.target</td>
<td>é‡å¯ç³»ç»Ÿã€‚</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<hr>
<p>æ³¨ï¼šå¯¹äºsystemdæ¥è¯´ 234æ²¡æœ‰åŒºåˆ«</p>
<hr>
<h3 id="71-targetç®¡ç†">7.1 targetç®¡ç†</h3>
<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ç›®å‰å¯ç”¨çš„targetï¼š</p>
<pre><code class="language-sh">systemctl list-units --type target
</code></pre>
<p>æ”¹å˜å½“å‰çš„è¿è¡ŒåŸºæœ¬ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-sh">systemctl isolate name.target
systemctl isolate rescue.target
$ runlevel 
1 3
</code></pre>
<h3 id="72-ä¿®æ”¹é»˜è®¤çš„è¿è¡Œçº§åˆ«">7.2 ä¿®æ”¹é»˜è®¤çš„è¿è¡Œçº§åˆ«</h3>
<p>ä½¿ç”¨systemctl get-defaultå‘½ä»¤å¾—åˆ°é»˜è®¤çš„è¿è¡Œçº§åˆ«ï¼š</p>
<pre><code class="language-sh">$ systemctl get-default 
multi-user.target
</code></pre>
<p>ä½¿ç”¨systemctl set-default name.targetä¿®æ”¹é»˜è®¤çš„è¿è¡Œçº§åˆ«ï¼š</p>
<pre><code class="language-sh">systemctl set-default graphical.target 
# å¯ä»¥çœ‹åˆ°ã€‚é»˜è®¤çº§åˆ«å°±æ˜¯æ“ä½œå¦‚ä¸‹ä¸¤æ­¥éª¤
rm '/etc/systemd/system/default.target'
ln-s'/usr/lib/systemd/system/graphical.target''/etc/systemd/system/default.target'
</code></pre>
<p>ä½¿ç”¨ Target çš„æ—¶å€™ï¼Œsystemctl list-dependencieså‘½ä»¤å’Œsystemctl isolateå‘½ä»¤ä¹Ÿå¾ˆæœ‰ç”¨ã€‚
æŸ¥çœ‹ multi-user.target åŒ…å«çš„æ‰€æœ‰æœåŠ¡</p>
<pre><code class="language-sh">systemctl list-dependencies multi-user.target
</code></pre>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå¸¸ç”¨çš„ Target æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯multi-user.targetï¼Œè¡¨ç¤ºå¤šç”¨æˆ·å‘½ä»¤è¡ŒçŠ¶æ€ï¼›å¦ä¸€ä¸ªæ˜¯graphical.targetï¼Œè¡¨ç¤ºå›¾å½¢ç”¨æˆ·çŠ¶æ€ï¼Œå®ƒä¾èµ–äºmulti-user.targetã€‚å®˜æ–¹æ–‡æ¡£æœ‰ä¸€å¼ éå¸¸æ¸…æ™°çš„ Target ä¾èµ–å…³ç³»å›¾ã€‚</p>
<h3 id="73-target-çš„é…ç½®æ–‡ä»¶">7.3 Target çš„é…ç½®æ–‡ä»¶</h3>
<p>Target ä¹Ÿæœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚</p>
<pre><code class="language-sh">[Unit]
Description=Multi-User System
Documentation=man:systemd.special(7)
Requires=basic.target		# Requireså­—æ®µï¼šè¦æ±‚basic.targetä¸€èµ·è¿è¡Œã€‚

# å†²çªå­—æ®µã€‚å¦‚æœrescue.serviceæˆ–rescue.targetæ­£åœ¨è¿è¡Œï¼Œmulti-user.targetå°±ä¸èƒ½è¿è¡Œï¼Œåä¹‹äº¦ç„¶ã€‚
Conflicts=rescue.service rescue.target

# è¡¨ç¤ºmulti-user.targetåœ¨basic.target ã€ rescue.serviceã€ rescue.targetä¹‹åå¯åŠ¨ï¼Œå¦‚æœå®ƒä»¬æœ‰å¯åŠ¨çš„è¯ã€‚
After=basic.target rescue.service rescue.target

# å…è®¸ä½¿ç”¨systemctl isolateå‘½ä»¤åˆ‡æ¢åˆ°multi-user.targetã€‚
AllowIsolate=yes
</code></pre>
<p>æ³¨æ„ï¼ŒTarget é…ç½®æ–‡ä»¶é‡Œé¢æ²¡æœ‰å¯åŠ¨å‘½ä»¤ã€‚</p>
<h3 id="74-æ•‘æ´æ¨¡å¼å’Œç´§æ€¥æ¨¡å¼">7.4 æ•‘æ´æ¨¡å¼å’Œç´§æ€¥æ¨¡å¼</h3>
<p>ä½¿ç”¨è¿›å…¥æ•‘æ´æ¨¡å¼ï¼Œå¦‚æœè¿æ•‘æ´æ¨¡å¼éƒ½è¿›å…¥ä¸äº†ï¼Œå¯ä»¥è¿›å…¥ç´§æ€¥æ¨¡å¼ï¼š</p>
<pre><code class="language-sh">systemctl rescue 	  # æ•‘æ´æ¨¡å¼ï¼ˆè¿›å…¥æ•‘æ´æ¨¡å¼ï¼Œå¦‚æœè¿æ•‘æ´æ¨¡å¼éƒ½è¿›å…¥ä¸äº†ï¼Œå¯ä»¥è¿›å…¥ç´§æ€¥æ¨¡å¼ï¼‰
systtmctl emergency # ç´§æ€¥æ¨¡å¼
</code></pre>
<p>ç´§æ€¥æ¨¡å¼è¿›å…¥æœ€å°çš„ç³»ç»Ÿç¯å¢ƒï¼Œä»¥ä¾¿äºä¿®å¤ç³»ç»Ÿã€‚ç´§æ€¥æ¨¡å¼æ ¹ç›®å½•ä»¥åªè¯»æ–¹å¼æŒ‚è½½ï¼Œä¸æ¿€æ´»ç½‘ç»œï¼Œåªå¯åŠ¨å¾ˆå°‘çš„æœåŠ¡ï¼Œè¿›å…¥ç´§æ€¥æ¨¡å¼éœ€è¦rootå¯†ç ã€‚</p>
<h2 id="å…³é—­æš‚åœä¼‘çœ ç³»ç»Ÿ">å…³é—­ã€æš‚åœã€ä¼‘çœ ç³»ç»Ÿ</h2>
<p>RHEL7ä¸­ï¼Œä½¿ç”¨systemctlæ›¿æ¢ä¸€äº›åˆ—çš„ç”µæºç®¡ç†å‘½ä»¤ï¼ŒåŸæœ‰çš„å‘½ä»¤ä¾æ—§å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯å»ºè®®å°½é‡ä¸ç”¨ä½¿ç”¨ã€‚systemctlå’Œè¿™äº›å‘½ä»¤çš„å¯¹åº”å…³ç³»ä¸ºï¼š</p>
<table>
<thead>
<tr>
<th>è¯´æ˜</th>
<th>SysV/Upstart</th>
<th>system</th>
</tr>
</thead>
<tbody>
<tr>
<td>åœæ­¢ç³»ç»Ÿï¼ˆå…³æœºï¼‰</td>
<td>halt</td>
<td>systemctl hatl</td>
</tr>
<tr>
<td>å…³é—­ç³»ç»Ÿï¼Œå…³é—­ç³»ç»Ÿç”µæº</td>
<td>poweroff</td>
<td>systemctl poweroff</td>
</tr>
<tr>
<td>é‡å¯ç³»ç»Ÿ</td>
<td>reboot</td>
<td>systemctl reboot</td>
</tr>
<tr>
<td>æš‚åœç³»ç»Ÿ</td>
<td>pm-suspend</td>
<td>systemctl suspend</td>
</tr>
<tr>
<td>ä¼‘çœ ç³»ç»Ÿ</td>
<td>pm-hibernate</td>
<td>systemct lhibernate</td>
</tr>
<tr>
<td>æš‚åœå¹¶ä¼‘çœ ç³»ç»Ÿ</td>
<td>pm-suspend-hybrid</td>
<td>systemctl hybrid-sleep</td>
</tr>
</tbody>
</table>
<h2 id="é€šè¿‡systemdç®¡ç†è¿œç¨‹ç³»ç»Ÿ">é€šè¿‡systemdç®¡ç†è¿œç¨‹ç³»ç»Ÿ</h2>
<p>ä¸å…‰æ˜¯å¯ä»¥ç®¡ç†æœ¬åœ°ç³»ç»Ÿï¼Œsystemdè¿˜å¯ä»¥æ§åˆ¶è¿œç¨‹ç³»ç»Ÿï¼Œç®¡ç†è¿œç¨‹ç³»ç»Ÿä¸»è¦æ˜¯é€šè¿‡SSHåè®®ï¼Œåªæœ‰ç¡®è®¤å¯ä»¥è¿æ¥è¿œç¨‹ç³»ç»Ÿçš„SSHï¼Œåœ¨systemctlå‘½ä»¤åé¢æ·»åŠ -Hæˆ–è€…&ndash;hostå‚æ•°ï¼ŒåŠ ä¸Šè¿œç¨‹ç³»ç»Ÿçš„ipæˆ–è€…ä¸»æœºåå°±å¯ä»¥ã€‚</p>
<h2 id="åˆ›å»ºå’Œä¿®æ”¹systemdå•å…ƒæ–‡ä»¶">åˆ›å»ºå’Œä¿®æ”¹systemdå•å…ƒæ–‡ä»¶</h2>
<h3 id="101-å•å…ƒæ–‡ä»¶æ¦‚è¿°">10.1 å•å…ƒæ–‡ä»¶æ¦‚è¿°</h3>
<p>ä¸€ä¸ªæœåŠ¡æ€ä¹ˆå¯åŠ¨ï¼Œå®Œå…¨ç”±å®ƒçš„é…ç½®æ–‡ä»¶å†³å®šã€‚ä¸‹é¢å°±æ¥çœ‹ï¼Œé…ç½®æ–‡ä»¶æœ‰äº›ä»€ä¹ˆå†…å®¹ã€‚</p>
<p>é…ç½®æ–‡ä»¶ä¸»è¦æ”¾åœ¨/usr/lib/systemd/systemç›®å½•ï¼Œä¹Ÿå¯èƒ½åœ¨/etc/systemd/systemç›®å½•ã€‚æ‰¾åˆ°é…ç½®æ–‡ä»¶ä»¥åï¼Œä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å³å¯ã€‚</p>
<p>ä¸‹é¢ä»¥sshd.serviceæ–‡ä»¶ä¸ºä¾‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯åŠ¨ä¸€ä¸ª SSH æœåŠ¡å™¨ï¼Œä¾›å…¶ä»–ç”¨æˆ·ä»¥ SSH æ–¹å¼ç™»å½•ã€‚</p>
<pre><code class="language-sh">[Unit]
Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.service
Wants=sshd-keygen.service

[Service]
EnvironmentFile=/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D $OPTIONS
ExecReload=/bin/kill -HUP $MAINPID
Type=simple
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
</code></pre>
<pre><code class="language-sh">$ systemctl status rsyncd
rsyncd.service - fast remote file copy program daemon
   Loaded: loaded (/usr/lib/systemd/system/rsyncd.service; disabled) 
   # loaded æœåŠ¡å·²ç»è¢«åŠ è½½ï¼Œæ˜¾ç¤ºå•å…ƒæ–‡ä»¶ç»å¯¹è·¯å¾„ï¼Œæ ‡å¿—å•å…ƒæ–‡ä»¶å¯ç”¨ã€‚
   # disabledè¡¨ç¤ºå¼€æœºä¸å…è®¸å¯åŠ¨StatusæœåŠ¡çš„é™„ä»¶ä¿¡æ¯ã€‚
   Active: active (running) since å›› 2017-01-26 21:59:41 CST; 5min ago
   # activeè¡¨ç¤ºå½“å‰çŠ¶æ€  ä»ä»€ä¹ˆæ—¶é—´è¢«æ¿€æ´»
 Main PID: 1360 (rsync) # main pid ä¸è¿›ç¨‹åå­—ä¸€è‡´çš„PIDï¼Œä¸»è¿›ç¨‹PIDã€‚è¿›ç¨‹å¯èƒ½æœ‰å¤šä¸ªè¿›ç¨‹å¯èƒ½æœ‰ä¸€ç»„
   CGroup: /system.slice/rsyncd.service
           â””â”€1360 /usr/bin/rsync --daemon --no-detach
# cgroupè¡¨ç¤ºèµ„æºç»„ï¼Œå¯åŠ¨å‘½ä»¤æ˜¯/usr/bin/rsync --daemon --no-detach
1æœˆ 26 21:59:41 lnmp systemd[1]: Starting fast remote file copy program daemon...
1æœˆ 26 21:59:41 lnmp systemd[1]: Started fast remote file copy program daemon.

$ systemctl status rsyncd
rsyncd.service - fast remote file copy program daemon
   Loaded: loaded (/usr/lib/systemd/system/rsyncd.service; disabled)
   Active: inactive (dead)/
</code></pre>
<p>ä¸Šé¢çš„è¾“å‡ºç»“æœå«ä¹‰å¦‚ä¸‹:&quot;&quot;</p>
<ul>
<li>Loadedè¡Œï¼šé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œæ˜¯å¦è®¾ä¸ºå¼€æœºå¯åŠ¨</li>
<li>Activeè¡Œï¼šè¡¨ç¤ºæ­£åœ¨è¿è¡Œ</li>
<li>Main PIDè¡Œï¼šä¸»è¿›ç¨‹ID</li>
<li>Statusè¡Œï¼šç”±åº”ç”¨æœ¬èº«ï¼ˆè¿™é‡Œæ˜¯ httpd ï¼‰æä¾›çš„è½¯ä»¶å½“å‰çŠ¶æ€</li>
<li>Cgroupå—ï¼šåº”ç”¨çš„æ‰€æœ‰å­è¿›ç¨‹</li>
<li>æ—¥å¿—å—ï¼šåº”ç”¨çš„æ—¥å¿—</li>
</ul>
<h3 id="102-ç†è§£å•å…ƒæ–‡ä»¶ç»“æ„">10.2 ç†è§£å•å…ƒæ–‡ä»¶ç»“æ„</h3>
<h3 id="103-å•å…ƒæ–‡ä»¶æ¦‚è¿°">10.3 å•å…ƒæ–‡ä»¶æ¦‚è¿°</h3>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé…ç½®æ–‡ä»¶åˆ†æˆå‡ ä¸ªåŒºå—ï¼Œæ¯ä¸ªåŒºå—åŒ…å«è‹¥å¹²æ¡é”®å€¼å¯¹ã€‚
å…¸å‹çš„å•å…ƒæ–‡ä»¶åŒ…å«ä¸‰èŠ‚ï¼š</p>
<ul>
<li>
<p><strong>[Unit]</strong>ï¼šåŒ…å«ä¸ä¾èµ–å•å…ƒç±»å‹çš„ä¸€èˆ¬é€‰é¡¹ï¼Œè¿™äº›é€‰å‹æä¾›å•å…ƒæè¿°ï¼ŒçŸ¥é“å•å…ƒè¡Œä¸ºï¼Œé…ç½®å•å…ƒå’Œå…¶ä»–å•å…ƒçš„ä¾èµ–æ€§ã€‚</p>
</li>
<li>
<p><strong>[unittype]</strong>ï¼šå¦‚æœå•å…ƒæœ‰ç‰¹å®šçš„ç±»å‹æŒ‡ä»¤ï¼Œåœ¨unittypeèŠ‚è¿™äº›æŒ‡ä»¤è¢«ç»„ç»‡åœ¨ä¸€èµ·ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒæœåŠ¡å•å…ƒæ–‡ä»¶åŒ…å«[Service]èŠ‚ï¼Œé‡Œé¢æœ‰ç»å¸¸ä½¿ç”¨çš„æœåŠ¡é…ç½®ã€‚</p>
</li>
<li>
<p><strong>[Install]</strong>ï¼šåŒ…å«systemctl enableæˆ–è€…disableçš„å‘½ä»¤å®‰è£…ä¿¡æ¯ã€‚</p>
</li>
</ul>
<h4 id="1031-unitèŠ‚é€‰é¡¹">10.3.1 [Unit]èŠ‚é€‰é¡¹</h4>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>Description</td>
<td>å­—æ®µç»™å‡ºå½“å‰æœåŠ¡çš„ç®€å•æè¿°</td>
</tr>
<tr>
<td>Documentation</td>
<td>ç»™å‡ºæ–‡æ¡£ä½ç½®ã€‚</td>
</tr>
<tr>
<td></td>
<td>å¯åŠ¨é¡ºåº <strong><font color="#0215cd" size=2> æ³¨æ„:Afterå’ŒBeforeå­—æ®µåªæ¶‰åŠå¯åŠ¨é¡ºåºï¼Œä¸æ¶‰åŠä¾èµ–å…³ç³»</font></strong></td>
</tr>
<tr>
<td>After</td>
<td>è¡¨ç¤ºsshd.serviceåº”è¯¥åœ¨network.target sshd-keygen.serviceä¹‹åå¯åŠ¨ã€‚</td>
</tr>
<tr>
<td>Before</td>
<td>å®šä¹‰sshd.serviceåº”è¯¥åœ¨å“ªäº›æœåŠ¡ä¹‹å‰å¯åŠ¨ã€‚</td>
</tr>
<tr>
<td></td>
<td>ä¸¾ä¾‹æ¥è¯´ï¼ŒæŸ Web åº”ç”¨éœ€è¦ postgresql æ•°æ®åº“å‚¨å­˜æ•°æ®ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå®ƒåªå®šä¹‰è¦åœ¨ postgresql ä¹‹åå¯åŠ¨ï¼Œè€Œæ²¡æœ‰å®šä¹‰ä¾èµ– postgresql ã€‚ä¸Šçº¿åï¼Œç”±äºæŸç§åŸå› ï¼Œpostgresql éœ€è¦é‡æ–°å¯åŠ¨ï¼Œåœ¨åœæ­¢æœåŠ¡æœŸé—´ï¼Œè¯¥ Web åº”ç”¨å°±ä¼šæ— æ³•å»ºç«‹æ•°æ®åº“è¿æ¥ã€‚</td>
</tr>
<tr>
<td></td>
<td><strong><font color="#0215cd" size=2> è®¾ç½®ä¾èµ–å…³ç³»ï¼Œéœ€è¦ä½¿ç”¨Wantså­—æ®µå’ŒRequireså­—æ®µã€‚</font></strong></td>
</tr>
<tr>
<td>Wants</td>
<td>è¡¨ç¤ºsshd.serviceä¸sshd-keygen.serviceä¹‹é—´å­˜åœ¨<font style="background:#ffff00;" size=2> &ldquo;å¼±ä¾èµ–&rdquo; </font>å…³ç³»ï¼Œå³å¦‚æœ&quot;sshd-keygen.service&quot;å¯åŠ¨å¤±è´¥æˆ–åœæ­¢è¿è¡Œï¼Œä¸å½±å“sshd.serviceç»§ç»­æ‰§è¡Œã€‚</td>
</tr>
<tr>
<td>Requires</td>
<td>è¡¨ç¤º<font style="background:#ffff00;" size=2> &ldquo;å¼ºä¾èµ–&rdquo; </font>å…³ç³»ï¼Œå³å¦‚æœè¯¥æœåŠ¡å¯åŠ¨å¤±è´¥æˆ–å¼‚å¸¸é€€å‡ºï¼Œé‚£ä¹ˆsshd.serviceä¹Ÿå¿…é¡»é€€å‡ºã€‚</td>
</tr>
<tr>
<td></td>
<td><strong><font color="#0215cd" size=2>æ³¨æ„ï¼ŒWantså­—æ®µä¸Requireså­—æ®µåªæ¶‰åŠä¾èµ–å…³ç³»ï¼Œä¸å¯åŠ¨é¡ºåºæ— å…³ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯åŒæ—¶å¯åŠ¨çš„ã€‚</font></strong></td>
</tr>
</tbody>
</table>
<h4 id="1032-service-åŒºå—å¯åŠ¨è¡Œä¸º">10.3.2 [Service] åŒºå—ï¼šå¯åŠ¨è¡Œä¸º</h4>
<p>Â ServiceåŒºå—å®šä¹‰å¦‚ä½•å¯åŠ¨å½“å‰æœåŠ¡ã€‚</p>
<blockquote>
<p><strong>å¯åŠ¨å‘½ä»¤</strong></p>
</blockquote>
<p>Â è®¸å¤šè½¯ä»¶éƒ½æœ‰è‡ªå·±çš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥ç”¨EnvironmentFileå­—æ®µè¯»å–ã€‚</p>
<pre><code>  EnvironmentFileå­—æ®µï¼šæŒ‡å®šå½“å‰æœåŠ¡çš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å†…éƒ¨çš„key=valueé”®å€¼å¯¹ï¼Œå¯ä»¥ç”¨$keyçš„å½¢å¼ï¼Œåœ¨å½“å‰é…ç½®æ–‡ä»¶ä¸­è·å–ã€‚
</code></pre>
<p>Â ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œsshd çš„ç¯å¢ƒå‚æ•°æ–‡ä»¶æ˜¯<font color="#f8070d" size=3><code>/etc/sysconfig/sshd</code></font>ã€‚</p>
<p>Â é…ç½®æ–‡ä»¶é‡Œé¢æœ€é‡è¦çš„å­—æ®µæ˜¯ExecStartã€‚</p>
<pre><code>  ExecStartï¼šå®šä¹‰å¯åŠ¨è¿›ç¨‹æ—¶æ‰§è¡Œçš„å‘½ä»¤ã€‚
</code></pre>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯åŠ¨sshdï¼Œæ‰§è¡Œçš„å‘½ä»¤æ˜¯<font color="#f8070d" size=3><code>/usr/sbin/sshd -D $OPTIONS</code></font>ï¼Œå…¶ä¸­çš„å˜é‡$OPTIONSå°±æ¥è‡ªEnvironmentFileå­—æ®µæŒ‡å®šçš„ç¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚</p>
<p>ä¸ä¹‹ä½œç”¨ç›¸ä¼¼çš„ï¼Œè¿˜æœ‰å¦‚ä¸‹è¿™äº›å­—æ®µï¼š</p>
<table>
<thead>
<tr>
<th>é€‰é¡¹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>ExecStart</td>
<td>æŒ‡å®šå¯åŠ¨å•å…ƒçš„å‘½ä»¤æˆ–è€…è„šæœ¬ï¼ŒExecStartPreå’ŒExecStartPostèŠ‚æŒ‡å®šåœ¨ExecStartä¹‹å‰æˆ–è€…ä¹‹åç”¨æˆ·è‡ªå®šä¹‰æ‰§è¡Œçš„è„šæœ¬ã€‚Type=oneshotå…è®¸æŒ‡å®šå¤šä¸ªå¸Œæœ›é¡ºåºæ‰§è¡Œçš„ç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ã€‚</td>
</tr>
<tr>
<td>ExecStop</td>
<td>æŒ‡å®šå•å…ƒåœæ­¢æ—¶æ‰§è¡Œçš„å‘½ä»¤æˆ–è€…è„šæœ¬ã€‚</td>
</tr>
<tr>
<td>ExecReload</td>
<td>æŒ‡å®šå•å…ƒé‡æ–°åŠ è½½æ˜¯æ‰§è¡Œçš„å‘½ä»¤æˆ–è€…è„šæœ¬ã€‚</td>
</tr>
<tr>
<td>ExecStartPre</td>
<td>å¯åŠ¨æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤</td>
</tr>
<tr>
<td>ExecStartPost</td>
<td>å¯åŠ¨æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤</td>
</tr>
<tr>
<td>ExecStopPost</td>
<td>åœæ­¢æœåŠ¡ä¹‹åæ‰§è¡Œçš„å‘½ä»¤</td>
</tr>
<tr>
<td>Restart</td>
<td>è¿™ä¸ªé€‰é¡¹å¦‚æœè¢«å…è®¸ï¼ŒæœåŠ¡é‡å¯çš„æ—¶å€™è¿›ç¨‹ä¼šé€€å‡ºï¼Œä¼šé€šè¿‡systemctlå‘½ä»¤æ‰§è¡Œæ¸…é™¤å¹¶é‡å¯çš„æ“ä½œã€‚</td>
</tr>
<tr>
<td>RemainAfterExit</td>
<td>å¦‚æœè®¾ç½®è¿™ä¸ªé€‰æ‹©ä¸ºçœŸï¼ŒæœåŠ¡ä¼šè¢«è®¤ä¸ºæ˜¯åœ¨æ¿€æ´»çŠ¶æ€ï¼Œå³ä½¿æ‰€ä»¥çš„è¿›ç¨‹å·²ç»é€€å‡ºï¼Œé»˜è®¤çš„å€¼ä¸ºå‡ï¼Œè¿™ä¸ªé€‰é¡¹åªæœ‰åœ¨Type=oneshotæ—¶éœ€è¦è¢«é…ç½®ã€‚</td>
</tr>
</tbody>
</table>
<p>è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p>
<pre><code class="language-sh">[Service]
ExecStart=/bin/echo execstart1
ExecStart=
ExecStart=/bin/echo execstart2
ExecStartPost=/bin/echo 1
ExecStartPost=/bin/echo 2
</code></pre>
<p>ä¸Šé¢è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œç¬¬äºŒè¡ŒExecStartè®¾ä¸ºç©ºå€¼ï¼Œç­‰äºå–æ¶ˆäº†ç¬¬ä¸€è¡Œçš„è®¾ç½®ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹ã€‚</p>
<pre><code class="language-sh">$ systemctl start test 
$ systemctl status test
test.service - test daemon
   Loaded: loaded (/usr/lib/systemd/system/test.service; disabled)
   Active: inactive (dead)

1æœˆ 30 07:11:16 lnmp systemd[1]: Starting test daemon...
1æœˆ 30 07:11:16 lnmp systemd[1]: Started test daemon.
1æœˆ 30 07:11:16 lnmp echo[1822]: test1_start
1æœˆ 30 07:11:16 lnmp echo[1824]: test1_stop
</code></pre>
<p>æ‰€æœ‰çš„å¯åŠ¨è®¾ç½®ä¹‹å‰ï¼Œéƒ½å¯ä»¥åŠ ä¸Šä¸€ä¸ªè¿è¯å·ï¼ˆ-ï¼‰ï¼Œè¡¨ç¤º<font style="background:#ffff00;" size=2>&ldquo;æŠ‘åˆ¶é”™è¯¯&rdquo;</font>ï¼Œå³å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œä¸å½±å“å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œã€‚æ¯”å¦‚ï¼Œ<font color="#f8070d" size=3><code>EnvironmentFile=-/etc/sysconfig/sshd</code></font>ï¼ˆæ³¨æ„ç­‰å·åé¢çš„é‚£ä¸ªè¿è¯å·ï¼‰ï¼Œå°±è¡¨ç¤ºå³ä½¿/etc/sysconfig/sshd æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚</p>
<blockquote>
<p><strong>å¯åŠ¨ç±»å‹</strong></p>
</blockquote>
<p>Typeå­—æ®µå®šä¹‰å¯åŠ¨ç±»å‹ã€‚å®ƒå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ã€‚</p>
<table>
<thead>
<tr>
<th>é€‰é¡¹å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>simple</td>
<td>é»˜è®¤å€¼ï¼ŒExecStartå­—æ®µå¯åŠ¨çš„è¿›ç¨‹ä¸ºä¸»è¿›ç¨‹</td>
</tr>
<tr>
<td>forking</td>
<td>è¿›ç¨‹ä½œä¸ºæœåŠ¡ä¸»è¿›ç¨‹çš„ä¸€ä¸ªå­è¿›ç¨‹å¯åŠ¨ï¼Œçˆ¶è¿›ç¨‹åœ¨å®Œå…¨å¯åŠ¨ä¹‹åé€€å‡ºã€‚</td>
</tr>
<tr>
<td>oneshot</td>
<td>ç±»ä¼¼äºsimpleï¼Œä½†åªæ‰§è¡Œä¸€æ¬¡ï¼Œè¿›ç¨‹åœ¨å¯åŠ¨å•å…ƒä¹‹åéšä¹‹é€€å‡ºã€‚</td>
</tr>
<tr>
<td>dbus</td>
<td>ç±»ä¼¼äºsimpleï¼Œä½†éšç€å•å…ƒå¯åŠ¨ååªæœ‰ä¸»è¿›ç¨‹å¾—åˆ°D-BUSåå­—ã€‚</td>
</tr>
<tr>
<td>notify</td>
<td>ç±»ä¼¼äºsimpleï¼Œå¯åŠ¨ç»“æŸåä¼šå‘å‡ºé€šçŸ¥ä¿¡å·ï¼Œç„¶å Systemd å†å¯åŠ¨å…¶ä»–æœåŠ¡</td>
</tr>
<tr>
<td>idle</td>
<td>ç±»ä¼¼äºsimpleï¼Œä½†æ˜¯è¦ç­‰åˆ°å…¶ä»–ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ‰ä¼šå¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸€ç§ä½¿ç”¨åœºåˆæ˜¯ä¸ºè®©è¯¥æœåŠ¡çš„è¾“å‡ºï¼Œä¸ä¸å…¶ä»–æœåŠ¡çš„è¾“å‡ºç›¸æ··åˆ</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªoneshotçš„ä¾‹å­ï¼Œç¬”è®°æœ¬ç”µè„‘å¯åŠ¨æ—¶ï¼Œè¦æŠŠè§¦æ‘¸æ¿å…³æ‰ï¼Œé…ç½®æ–‡ä»¶å¯ä»¥è¿™æ ·å†™ã€‚</p>
<pre><code class="language-sh">[Unit]
Description=Switch-off Touchpad

[Service]
Type=oneshot
ExecStart=/usr/bin/touchpad-off

[Install]
WantedBy=multi-user.target
</code></pre>
<p>ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ç±»å‹è®¾ä¸ºoneshotï¼Œå°±è¡¨æ˜è¿™ä¸ªæœåŠ¡åªè¦è¿è¡Œä¸€æ¬¡å°±å¤Ÿäº†ï¼Œä¸éœ€è¦é•¿æœŸè¿è¡Œã€‚</p>
<p>å¦‚æœå…³é—­ä»¥åï¼Œå°†æ¥æŸä¸ªæ—¶å€™è¿˜æƒ³æ‰“å¼€ï¼Œé…ç½®æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹ã€‚</p>
<pre><code class="language-sh">[Unit]
Description=Switch-off Touchpad

[Service]
Type=oneshot
ExecStart=/usr/bin/touchpad-off start
ExecStop=/usr/bin/touchpad-off stop
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
</code></pre>
<p>ä¸Šé¢é…ç½®æ–‡ä»¶ä¸­ï¼ŒRemainAfterExitå­—æ®µè®¾ä¸ºyesï¼Œè¡¨ç¤ºè¿›ç¨‹é€€å‡ºä»¥åï¼ŒæœåŠ¡ä»ç„¶ä¿æŒæ‰§è¡Œã€‚è¿™æ ·çš„è¯ï¼Œä¸€æ—¦ä½¿ç”¨systemctl stopå‘½ä»¤åœæ­¢æœåŠ¡ï¼ŒExecStopæŒ‡å®šçš„å‘½ä»¤å°±ä¼šæ‰§è¡Œï¼Œä»è€Œé‡æ–°å¼€å¯è§¦æ‘¸æ¿ã€‚</p>
<blockquote>
<p><strong>é‡å¯è¡Œä¸º</strong></p>
</blockquote>
<p>Â ServiceåŒºå—æœ‰ä¸€äº›å­—æ®µï¼Œå®šä¹‰äº†é‡å¯è¡Œä¸ºã€‚</p>
<pre><code class="language-sh">  KillModeå­—æ®µï¼šå®šä¹‰ Systemd å¦‚ä½•åœæ­¢ sshd æœåŠ¡ã€‚
</code></pre>
<p>ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°†KillModeè®¾ä¸ºprocessï¼Œè¡¨ç¤ºåªåœæ­¢ä¸»è¿›ç¨‹ï¼Œä¸åœæ­¢ä»»ä½•sshd å­è¿›ç¨‹ï¼Œå³å­è¿›ç¨‹æ‰“å¼€çš„ SSH session ä»ç„¶ä¿æŒè¿æ¥ã€‚è¿™ä¸ªè®¾ç½®ä¸å¤ªå¸¸è§ï¼Œä½†å¯¹sshdå¾ˆé‡è¦ï¼Œå¦åˆ™ä½ åœæ­¢æœåŠ¡çš„æ—¶å€™ï¼Œä¼šè¿è‡ªå·±æ‰“å¼€çš„SSH sessionä¸€èµ·æ€æ‰ã€‚</p>
<p>KillModeå­—æ®µå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>é€‰é¡¹å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>control-group</td>
<td>ï¼ˆé»˜è®¤å€¼ï¼‰	å½“å‰æ§åˆ¶ç»„é‡Œé¢çš„æ‰€æœ‰å­è¿›ç¨‹ï¼Œéƒ½ä¼šè¢«æ€æ‰</td>
</tr>
<tr>
<td>process</td>
<td>åªæ€ä¸»è¿›ç¨‹</td>
</tr>
<tr>
<td>mixed</td>
<td>ä¸»è¿›ç¨‹å°†æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå­è¿›ç¨‹æ”¶åˆ° SIGKILL ä¿¡å·</td>
</tr>
<tr>
<td>none</td>
<td>æ²¡æœ‰è¿›ç¨‹ä¼šè¢«æ€æ‰ï¼Œåªæ˜¯æ‰§è¡ŒæœåŠ¡çš„ stop å‘½ä»¤ã€‚</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>Restartå­—æ®µã€‚</strong></p>
</blockquote>
<p>Â Restartå­—æ®µï¼šå®šä¹‰äº† sshd é€€å‡ºåï¼ŒSystemd çš„é‡å¯æ–¹å¼ã€‚</p>
<p>ä¸Šé¢çš„ä¾‹å­ä¸­ï¼ŒRestartè®¾ä¸ºon-failureï¼Œè¡¨ç¤ºä»»ä½•æ„å¤–çš„å¤±è´¥ï¼Œå°±å°†é‡å¯sshdã€‚å¦‚æœ sshd æ­£å¸¸åœæ­¢ï¼ˆæ¯”å¦‚æ‰§è¡Œsystemctl stopå‘½ä»¤ï¼‰ï¼Œå®ƒå°±ä¸ä¼šé‡å¯ã€‚</p>
<p>Restartå­—æ®µå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ã€‚</p>
<table>
<thead>
<tr>
<th>é€‰é¡¹å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>no</td>
<td>é»˜è®¤å€¼ï¼›é€€å‡ºåä¸ä¼šé‡å¯</td>
</tr>
<tr>
<td>on-success</td>
<td>åªæœ‰æ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç ä¸º0ï¼‰ï¼Œæ‰ä¼šé‡å¯</td>
</tr>
<tr>
<td>on-failure</td>
<td>éæ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç é0ï¼‰ï¼ŒåŒ…æ‹¬è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯</td>
</tr>
<tr>
<td>on-abnormal</td>
<td>åªæœ‰è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯</td>
</tr>
<tr>
<td>on-abort</td>
<td>åªæœ‰åœ¨æ”¶åˆ°æ²¡æœ‰æ•æ‰åˆ°çš„ä¿¡å·ç»ˆæ­¢æ—¶ï¼Œæ‰ä¼šé‡å¯</td>
</tr>
<tr>
<td>on-watchdog</td>
<td>è¶…æ—¶é€€å‡ºï¼Œæ‰ä¼šé‡å¯</td>
</tr>
<tr>
<td>always</td>
<td>ä¸ç®¡æ˜¯ä»€ä¹ˆé€€å‡ºåŸå› ï¼Œæ€»æ˜¯é‡å¯</td>
</tr>
</tbody>
</table>
<p>Â å¯¹äºå®ˆæŠ¤è¿›ç¨‹ï¼Œæ¨èè®¾ä¸ºon-failureã€‚å¯¹äºé‚£äº›å…è®¸å‘ç”Ÿé”™è¯¯é€€å‡ºçš„æœåŠ¡ï¼Œå¯ä»¥è®¾ä¸ºon-abnormalã€‚</p>
<blockquote>
<p><strong>RestartSecå­—æ®µã€‚</strong></p>
</blockquote>
<p>Â RestartSecå­—æ®µï¼šè¡¨ç¤º Systemd é‡å¯æœåŠ¡ä¹‹å‰ï¼Œéœ€è¦ç­‰å¾…çš„ç§’æ•°ã€‚ä¸Šé¢çš„ä¾‹å­è®¾ä¸ºç­‰å¾…42ç§’ã€‚</p>
<h5 id="10.2.3">[Install] åŒºå—
&nbsp;è¯´æ˜ï¼šInstallåŒºå—ï¼Œå®šä¹‰å¦‚ä½•å®‰è£…è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå³æ€æ ·åšåˆ°å¼€æœºå¯åŠ¨ã€‚
WantedByå­—æ®µï¼šè¡¨ç¤ºè¯¥æœåŠ¡æ‰€åœ¨çš„ Targetã€‚
<p>Targetçš„å«ä¹‰æ˜¯æœåŠ¡ç»„ï¼Œè¡¨ç¤ºä¸€ç»„æœåŠ¡ã€‚WantedBy=multi-user.targetæŒ‡çš„æ˜¯ï¼Œsshd æ‰€åœ¨çš„ Target æ˜¯multi-user.targetã€‚</p>
<p>è¿™ä¸ªè®¾ç½®éå¸¸é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œsystemctl enable sshd.serviceå‘½ä»¤æ—¶ï¼Œsshd.serviceçš„ä¸€ä¸ªç¬¦å·é“¾æ¥ï¼Œå°±ä¼šæ”¾åœ¨/etc/systemd/systemç›®å½•ä¸‹é¢çš„multi-user.target.wantså­ç›®å½•ä¹‹ä¸­ã€‚</p>
<p>Systemd æœ‰é»˜è®¤çš„å¯åŠ¨ Targetã€‚</p>
<pre><code class="language-sh">$ systemctl get-default
multi-user.target
</code></pre>
<p>ä¸Šé¢çš„ç»“æœè¡¨ç¤ºï¼Œé»˜è®¤çš„å¯åŠ¨ Target æ˜¯multi-user.targetã€‚åœ¨è¿™ä¸ªç»„é‡Œçš„æ‰€æœ‰æœåŠ¡ï¼Œéƒ½å°†å¼€æœºå¯åŠ¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆsystemctl enableå‘½ä»¤èƒ½è®¾ç½®å¼€æœºå¯åŠ¨çš„åŸå› ã€‚</p>
<blockquote>
<p><strong>ä¿®æ”¹é…ç½®æ–‡ä»¶åé‡å¯</strong></p>
</blockquote>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶ä»¥åï¼Œéœ€è¦é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç„¶åé‡æ–°å¯åŠ¨ç›¸å…³æœåŠ¡ã€‚</p>
<pre><code class="language-sh"># é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
systemctl daemon-reload
</code></pre>
<h3 id="104-ä¸€ä¸ªpostfixæœåŠ¡çš„ä¾‹å­">10.4 ä¸€ä¸ªpostfixæœåŠ¡çš„ä¾‹å­ï¼š</h3>
<p>å•å…ƒæ–‡ä»¶ä½äº<font color="#f8070d" size=3><code>/usr/lib/systemd/system/postifix.service</code></font>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-sh">[Unit] 
Description=PostfixMailTransportAgent 
After=syslog.targetnetwork.target 
Conflicts=sendmail.serviceexim.service 

[Service] 
Type=forking 
PIDFile=/var/spool/postfix/pid/master.pid 
EnvironmentFile=-/etc/sysconfig/network
ExecStartPre=-/usr/libexec/postfix/aliasesdb
ExecStartPre=-/usr/libexec/postfix/chroot-update
ExecStart=/usr/sbin/postfixstart
ExecReload=/usr/sbin/postfixreload
ExecStop=/usr/sbin/postfixstop

[Install] 
WantedBy=multi-user.target
</code></pre>
<h4 id="105-åˆ›å»ºè‡ªå®šä¹‰çš„å•å…ƒæ–‡ä»¶">10.5 åˆ›å»ºè‡ªå®šä¹‰çš„å•å…ƒæ–‡ä»¶</h4>
<p>ä»¥ä¸‹å‡ ç§åœºæ™¯éœ€è¦è‡ªå®šä¹‰å•å…ƒæ–‡ä»¶ï¼š</p>
<ul>
<li>å¸Œæœ›è‡ªå·±åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹ï¼›</li>
<li>ä¸ºç°æœ‰çš„æœåŠ¡åˆ›å»ºç¬¬äºŒä¸ªå®ä¾‹ï¼›</li>
<li>å¼•å…¥SysV initè„šæœ¬ã€‚</li>
</ul>
<p>å¦å¤–ä¸€æ–¹é¢ï¼Œæœ‰æ—¶å€™éœ€è¦ä¿®æ”¹å·²æœ‰çš„å•å…ƒæ–‡ä»¶ã€‚ä¸‹é¢ä»‹ç»åˆ›å»ºå•å…ƒæ–‡ä»¶çš„æ­¥éª¤ï¼š</p>
<blockquote>
<ol>
<li>å‡†å¤‡è‡ªå®šä¹‰æœåŠ¡çš„æ‰§è¡Œæ–‡ä»¶ã€‚</li>
</ol>
</blockquote>
<p>å¯æ‰§è¡Œæ–‡ä»¶å¯ä»¥æ˜¯è„šæœ¬ï¼Œä¹Ÿå¯ä»¥æ˜¯è½¯ä»¶æä¾›è€…çš„çš„ç¨‹åºï¼Œå¦‚æœéœ€è¦ï¼Œä¸ºè‡ªå®šä¹‰æœåŠ¡çš„ä¸»è¿›ç¨‹å‡†å¤‡ä¸€ä¸ªPIDæ–‡ä»¶ï¼Œä¸€ä¿è¯PIDä¿æŒä¸å˜ã€‚å¦å¤–è¿˜å¯èƒ½éœ€è¦çš„é…ç½®ç¯å¢ƒå˜é‡çš„è„šæœ¬ï¼Œç¡®ä¿æ‰€ä»¥è„šæœ¬éƒ½æœ‰å¯æ‰§è¡Œå±æ€§å¹¶ä¸”ä¸éœ€è¦äº¤äº’ã€‚</p>
<blockquote>
<p>2.åœ¨<font color="#f8070d" size=3><code>/etc/systemd/system/</code></font>ç›®å½•åˆ›å»ºå•å…ƒæ–‡ä»¶ï¼Œå¹¶ä¸”ä¿è¯åªèƒ½è¢«rootç”¨æˆ·ç¼–è¾‘</p>
</blockquote>
<pre><code class="language-sh">touch /etc/systemd/system/mariadb.service
chmod 644 /etc/systemd/system/mariadb.service
</code></pre>
<hr>
<p><strong><font color="#f8070d" size=3>æ³¨ï¼šæ–‡ä»¶ä¸éœ€è¦æ‰§è¡Œæƒé™</font>ã€‚</strong></p>
<hr>
<blockquote>
<ol start="3">
<li>æ‰“å¼€name.serviceæ–‡ä»¶ï¼Œæ·»åŠ æœåŠ¡é…ç½®ï¼Œå„ç§å˜é‡å¦‚ä½•é…ç½®è§†æ‰€æ·»åŠ çš„æœåŠ¡ç±»å‹è€Œå®šï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾èµ–ç½‘ç»œæœåŠ¡çš„é…ç½®ä¾‹å­ï¼š</li>
</ol>
</blockquote>
<pre><code class="language-sh">[Unit] 
Description=mariadb multi demo 3306
After=network.target

[Service] 
ExecStart=/data/3306/mysql start
ExecReload=/data/3306/mysql restart
ExecStop=/data/3306/mysql stop
Type=forking
PIDFile=/data/3306/mysqld.pid

[Install] 
WantedBy=multi-user.target
</code></pre>
<blockquote>
<p>4.é€šçŸ¥systemdæœ‰ä¸ªæ–°æœåŠ¡æ·»åŠ ï¼š</p>
</blockquote>
<pre><code class="language-sh">systemctl daemon-reload 
systemctl start name.service
</code></pre>
<h4 id="10.5">10.5 åˆ›å»ºç¬¬äºŒä¸ªsshdæœåŠ¡çš„ä¾‹å­
<blockquote>
<p><strong>1.æ‹·è´sshd_configæ–‡ä»¶</strong></p>
</blockquote>
<pre><code class="language-sh">cp /etc/ssh/sshd{,-second}_config
# {,second} ç­‰äº å’Œsecond ï¼Œç±»ä¼¼ä¸ {a,c}çš„ç”¨æ³•
</code></pre>
<blockquote>
<p><strong>2.ç¼–è¾‘sshd-second_configæ–‡ä»¶ï¼Œæ·»åŠ 22220çš„ç«¯å£ï¼Œå’ŒPIDæ–‡ä»¶</strong>ï¼š</p>
</blockquote>
<pre><code>Port 22220 
PidFile /var/run/sshd-second.pid
</code></pre>
<p>å¦‚æœè¿˜éœ€è¦ä¿®æ”¹å…¶ä»–å‚æ•°ï¼Œè¯·é˜…è¯»å¸®åŠ©ã€‚</p>
<blockquote>
<p><strong>3.æ‹·è´å•å…ƒæ–‡ä»¶</strong>ï¼š</p>
</blockquote>
<pre><code class="language-sh"> cp /usr/lib/systemd/system/sshd{,-second}.service
</code></pre>
<blockquote>
<p><strong>4.ç¼–è¾‘å•å…ƒæ–‡ä»¶sshd-second.service</strong></p>
</blockquote>
<pre><code class="language-sh">[Unit] 
Description=OpenSSH server second instance daemon 
After=syslog.target network.targe tauditd.service sshd.service 

[Service] 
EnvironmentFile=/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D -f /etc/ssh/sshd-second_config $OPTIONS 
ExecReload=/bin/kill -HUP $MAINPID 
KillMode=process 
Restart=on-failure 
RestartSec=42s 

[Install] 
WantedBy=multi-user.target
</code></pre>
<blockquote>
<p><strong>5.å¦‚æœä½¿ç”¨SELinuxï¼Œæ·»åŠ tcpç«¯å£ï¼Œè´Ÿè´£ç¬¬äºŒsshdæœåŠ¡çš„ç«¯å£å°±ä¼šè¢«æ‹’ç»ç»‘å®š</strong>ï¼š</p>
</blockquote>
<pre><code class="language-sh">semanage port -a -tssh_port_t -p tcp22220
</code></pre>
<blockquote>
<blockquote>
<p><strong>6.è®¾ç½®å¼€æœºå¯åŠ¨å¹¶æµ‹è¯•</strong>ï¼š</p>
</blockquote>
</blockquote>
<pre><code class="language-sh">systemctl enable sshd-second.service 
ssh -p 22220 user@server
</code></pre>
<h4 id="106-ä¿®æ”¹å·²ç»å­˜åœ¨çš„å•å…ƒæ–‡ä»¶">10.6 ä¿®æ”¹å·²ç»å­˜åœ¨çš„å•å…ƒæ–‡ä»¶</h4>
<p>systemd unité…ç½®æ–‡ä»¶é»˜è®¤ä¿å­˜åœ¨/usr/lib/systemd/system/ç›®å½•ï¼Œä¸å»ºè®®ç›´æ¥ä¿®æ”¹è¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œè‡ªå®šä¹‰çš„æ–‡ä»¶åœ¨/etc/systemd/system/ç›®å½•ä¸‹ï¼Œå¦‚æœæœ‰æ‰©å±•çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ¡ˆï¼š</p>
<p>åˆ›å»ºä¸€ä¸ªç›®å½•/etc/systemd/system/unit.d/ï¼Œè¿™ä¸ªæ˜¯æœ€æ¨èçš„ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒåˆå§‹çš„å•å…ƒæ–‡ä»¶ï¼Œé€šè¿‡é™„ä»¶é…ç½®æ–‡ä»¶æ¥æ‰©å±•é»˜è®¤çš„é…ç½®ï¼Œå¯¹é»˜è®¤å•å…ƒæ–‡ä»¶çš„å‡çº§ä¼šè¢«è‡ªåŠ¨å‡çº§å’Œåº”ç”¨ã€‚</p>
<p>ä»/usr/lib/systemd/system/æ‹·è´ä¸€ä»½åŸå§‹é…ç½®æ–‡ä»¶åˆ°/etc/systemd/system/ï¼Œç„¶åä¿®æ”¹ã€‚å¤åˆ¶çš„ç‰ˆæœ¬ä¼šè¦†ç›–åŸå§‹é…ç½®ï¼Œè¿™ç§æ–¹å¼ä¸èƒ½å¢åŠ é™„ä»¶çš„é…ç½®åŒ…ï¼Œç”¨äºä¸éœ€è¦é™„åŠ åŠŸèƒ½çš„åœºæ™¯ã€‚</p>
<p>å¦‚æœéœ€è¦æ¢å¤åˆ°é»˜è®¤çš„é…ç½®æ–‡ä»¶ï¼Œåªéœ€è¦åˆ é™¤/etc/systemd/system/ä¸‹çš„é…ç½®æ–‡ä»¶å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦é‡å¯æœºå™¨ã€‚</p>
<h2 id="reference">Reference</h2>
<blockquote>
<p>[CentOS7/RHEL7 systemdè¯¦è§£](CentOS7/RHEL7 systemdè¯¦è§£)</p>
<p><a href="http://www.jinbuguo.com/systemd/systemd.index.html" target="_blank"
   rel="noopener nofollow noreferrer" >systemd.index ä¸­æ–‡æ‰‹å†Œ</a></p>
<p><a href="https://web.archive.org/web/20230204201903/https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html" target="_blank"
   rel="noopener nofollow noreferrer" >Systemd å…¥é—¨æ•™ç¨‹ï¼šå®æˆ˜ç¯‡</a></p>
</blockquote>
]]></content:encoded>
    </item>
    
    <item>
      <title>Linuxæ—¥å¿—ç®¡ç† - syslog</title>
      <link>https://www.oomkill.com/2016/04/syslog/</link>
      <pubDate>Thu, 21 Apr 2016 00:00:00 +0000</pubDate>
      
      <guid>https://www.oomkill.com/2016/04/syslog/</guid>
      <description></description>
      <content:encoded><![CDATA[<h2 id="rsyslogä»‹ç»">rsyslogä»‹ç»</h2>
<p>syslogå®ˆæŠ¤è¿›ç¨‹ï¼Œå†…éƒ¨æœ‰ä¸¤ä¸ªè¿›ç¨‹ï¼Œsyslogdä¸»è¦è´Ÿè´£ç”¨æˆ·ç©ºé—´çš„ç”¨æˆ·è¿›ç¨‹è®°å½•æ—¥å¿—ï¼›klogè´Ÿè´£å†…æ ¸æ‰€å‘ç”Ÿçš„å„ç§æ—¶é—´è®°å½•æ—¥å¿—ã€‚ä¸¤è€…åˆå¹¶åå½¢æˆsyslogã€‚</p>
<p>rsyslogæ˜¯syslogä¸‹ä¸€ä»£å‡çº§äº§å“ï¼Œä¾ç„¶æœ‰syslogd klogdæä¾›æœåŠ¡ã€‚</p>
<p>rsyslogå¯ä»¥å¼€é€šè¿œç¨‹æœºåˆ¶ç›‘å¬åœ¨æŸä¸ªå¥—æ¥å­—ä¸Šï¼Œå…¶ä»–ä»»ä½•ä¸»æœºæ‰€äº§ç”Ÿçš„æ—¥å¿—ä¿¡æ¯ç”±æœ¬æœºçš„rsyslogæ”¶é›†èµ·æ¥ï¼Œæ”¶é›†å®Œåä¸è´Ÿè´£è®°å½•ï¼Œè€Œæ˜¯å»ºç«‹ä¸€ä¸ªtcpæˆ–udpè¿æ¥å‘é€ç»™ä¸“é—¨çš„æ—¥å¿—æœåŠ¡å™¨ï¼Œç”±ä¸“é—¨çš„æ—¥å¿—æœåŠ¡å™¨è´Ÿè´£è®°å½•ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯æ˜æ–‡çš„ã€‚</p>
<h3 id="rsyslogç‰¹æ€§">rsyslogç‰¹æ€§</h3>
<ol>
<li>å¤šçº¿ç¨‹ã€‚</li>
<li>æ”¯æŒUDP,TCPåè®®ï¼ŒåŸºäºssl tlsåŠ å¯†å®Œæˆè¿œç¨‹æ—¥å¿—ä¼ è¾“ã€‚æ”¯æŒRELPåè®®</li>
<li>å®ç°å°†æ—¥å¿—å­˜å‚¨åˆ°MySQL PGSQLç­‰å…³ç³»å‹æ•°æ®åº“ä¸­ã€‚</li>
<li>å¼ºå¤§çš„è¿‡æ»¤å™¨ï¼Œå¯å®ç°è¿‡æ»¤æ—¥å¿—ä¿¡æ¯ä¸­ä»»ä½•éƒ¨åˆ†ï¼Œæ”¯æŒè‡ªå®šä¹‰è¾“å‡ºæ ¼å¼ã€‚</li>
</ol>
<h2 id="æ—¥å¿—æ ¼å¼">æ—¥å¿—æ ¼å¼</h2>
<p>äº‹ä»¶äº§ç”Ÿçš„äº‹ä»¶  ä¸»æœº  è¿›ç¨‹pid  äº‹ä»¶</p>
<pre><code class="language-bash">Jun  6 23:36:58 Lamp-02 NET[1838]: /etc/sysconfig/network-scripts/ifup-post: updated /etc/resolv.conf
Jun  6 23:46:15 Lamp-02 yum[1963]: Updated: mysql-libs-5.1.73-8.el6_8.x86_64
Jun  6 23:46:16 Lamp-02 yum[1963]: Installed: mysql-5.1.73-8.el6_8.x86_64
</code></pre>
<p>æœ‰äº›æ—¥å¿—è®°å½•äºŒè¿›åˆ¶æ—¥å¿— <code>/var/log/wtmp /var/log/btmp</code></p>
<p>lastï¼š<code>/var/log/wtmp</code> å½“å‰ç³»ç»Ÿä¸­æˆåŠŸç™»é™†çš„æ—¥å¿—</p>
<p>lastbï¼š<code>/var/log/btmp</code> å½“å‰ç³»ç»Ÿä¸­å¤±è´¥çš„ç™»é™†å°è¯•</p>
<p>lastlogï¼šæ˜¾ç¤ºå½“å‰ç³»ç»Ÿæ¯ä¸€ä¸ªç”¨æˆ·æœ€è¿‘ä¸€æ¬¡ç™»é™†æ—¶é—´</p>
<h3 id="æ—¥å¿—ç­‰çº§">æ—¥å¿—ç­‰çº§</h3>
<p>æ—¥å¿—çº§åˆ«ï¼šäº‹ä»¶çš„å…³é”®æ€§ç¨‹åº¦</p>
<p>lev	|è¯´æ˜</p>
<table>
<thead>
<tr>
<th>lev</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>none</td>
<td>ä¸è®°å½•</td>
</tr>
<tr>
<td>debug</td>
<td>è°ƒè¯•ä¿¡æ¯</td>
</tr>
<tr>
<td>info</td>
<td>æ­£å¸¸ä¿¡æ¯ï¼Œä»…æ˜¯ä¸€äº›åŸºæœ¬ä¿¡æ¯è¯´æ˜</td>
</tr>
<tr>
<td>notice</td>
<td>æ¯”infoè¿˜éœ€è¦æ³¨æ„çš„ä¸€äº›ä¿¡æ¯å†…å®¹</td>
</tr>
<tr>
<td>warning,warn</td>
<td>è­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½æœ‰äº›é—®é¢˜ï¼Œä½†æ˜¯è¿˜ä¸è‡³äºå½±å“åˆ°æŸä¸ªæœåŠ¡è¿ä½œçš„ä¿¡æ¯</td>
</tr>
<tr>
<td>err,error</td>
<td>ä¸€äº›é‡å¤§çš„é”™è¯¯ä¿¡æ¯</td>
</tr>
<tr>
<td>crit</td>
<td>ä¸´ç•ŒçŠ¶æ€ï¼Œæ¯”errorè¿˜è¦ä¸¥é‡çš„é”™è¯¯ä¿¡æ¯ï¼Œæ©™è‰²è­¦æŠ¥</td>
</tr>
<tr>
<td>alert</td>
<td>çº¢è‰²è­¦æŠ¥ï¼Œå·²ç»å¾ˆæœ‰é—®é¢˜çš„ç­‰çº§ï¼Œæ¯”critè¿˜è¦ä¸¥é‡</td>
</tr>
<tr>
<td>emerg,panic</td>
<td>ç–¼ç—›ç­‰çº§ï¼Œæ„æŒ‡ç³»ç»Ÿå·²ç»è¦å®•æœºçš„çŠ¶æ€ï¼å¾ˆä¸¥é‡çš„é”™è¯¯ä¿¡æ¯</td>
</tr>
</tbody>
</table>
<h3 id="è®¾æ–½ç±»å‹">è®¾æ–½ç±»å‹</h3>
<p>facilityï¼šæŠŠæŸä¸€ç±»å…·æœ‰ç›¸åŒç‰¹æ€§çš„ç”±å„ä¸ªåº”ç”¨ç¨‹åºæ‰€äº§ç”Ÿçš„æ—¥å¿—æ•°æ®æµå½’ç±»åˆ°ç”¨ä¸€ä¸ªæ•°æ®æ”¶é›†ç®¡é“ä¸­ï¼Œè¿™ä¸ªæ”¶é›†ç®¡é“ç§°ä¹‹ä¸ºfacilityã€‚</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth(authpriv)</td>
<td>ä¸è®¤è¯æœ‰å…³çš„æœºåˆ¶ï¼Œä¾‹å¦‚login ssh suç­‰éœ€è¦è´¦å·å¯†ç </td>
</tr>
<tr>
<td>cron</td>
<td>ä¾‹è¡Œæ€§å·¥ä½œè°ƒåº¦cron/atç­‰ç”Ÿæˆä¿¡æ¯æ—¥å¿—çš„åœ°æ–¹</td>
</tr>
<tr>
<td>daemon</td>
<td>ä¸å„ä¸ªdaemonæœ‰å…³çš„ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td>kern</td>
<td>å†…æ ¸äº§ç”Ÿä¿¡æ¯åœ°æ–¹</td>
</tr>
<tr>
<td>lpr</td>
<td>æ‰“å°ç›¸å…³ä¿¡æ¯</td>
</tr>
<tr>
<td>mail</td>
<td>é‚®ä»¶æ”¶å‘æœ‰å…³çš„ä¿¡æ¯</td>
</tr>
<tr>
<td>news</td>
<td>æ–°é—»ç»„æœåŠ¡å™¨æœ‰å…³ä¿¡æ¯</td>
</tr>
<tr>
<td>syslog</td>
<td>è‡ªèº«äº§ç”Ÿæ—¥å¿—</td>
</tr>
<tr>
<td>user</td>
<td>ç”¨æˆ·</td>
</tr>
<tr>
<td>security</td>
<td>ä¸å®‰å…¨ç›¸å…³ä¿¡æ¯</td>
</tr>
<tr>
<td>local0-local7</td>
<td>ç”¨æˆ·è‡ªå®šä¹‰8ä¸ªè®¾ç½®</td>
</tr>
</tbody>
</table>
<h3 id="é€šé…æœºåˆ¶">é€šé…æœºåˆ¶</h3>
<table>
<thead>
<tr>
<th>é€šé…ç¬¦</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>.</td>
<td>ä»£è¡¨ã€æ¯”åé¢è¿˜è¦é«˜çš„ç­‰çº§ï¼ˆå«è¯¥ç­‰çº§ï¼‰éƒ½è¢«è®°å½•ä¸‹æ¥ã€‘ ä¾‹å¦‚ï¼šmail.infoä»£è¡¨åªè¦æ˜¯mailä¿¡æ¯ï¼Œè€Œä¸”è¯¥ä¿¡æ¯ç­‰çº§é«˜äºinfoï¼ˆå«infoï¼‰æ—¶ï¼Œå°±ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚</td>
</tr>
<tr>
<td>.=</td>
<td>ä»£è¡¨æ‰€éœ€è¦çš„ç­‰çº§å°±æ˜¯åé¢æ¥çš„ç­‰çº§è€Œå·²ï¼Œå…¶ä»–çš„ä¸è¦ã€‚ä¾‹å¦‚ï¼šmain.=infoä»£è¡¨çš„åªè¦æ˜¯mailä¿¡æ¯ï¼Œè€Œä¸”è¯¥ä¿¡æ¯ç­‰äºinfoçº§åˆ«ï¼Œå°±ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚</td>
</tr>
<tr>
<td>.!</td>
<td>ä»£è¡¨ä¸ç­‰äºï¼ˆå–åï¼‰ï¼Œäº¦æ˜¯é™¤äº†è¯¥ç­‰çº§å¤–çš„å…¶ä»–ç­‰çº§éƒ½è®°å½•ã€‚</td>
</tr>
<tr>
<td>*</td>
<td>æ‰€æœ‰ï¼›ä¾‹å¦‚ï¼š*.infoä»£è¡¨æ‰€æœ‰è®¾æ–½çš„infoçº§åˆ«</td>
</tr>
<tr>
<td>none</td>
<td>ä¸è®°å½•</td>
</tr>
</tbody>
</table>
<h3 id="æ—¥å¿—çš„è¾“å‡ºä½ç½®">æ—¥å¿—çš„è¾“å‡ºä½ç½®</h3>
<table>
<thead>
<tr>
<th>ä½ç½®</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ–‡ä»¶</td>
<td>/var/log/messages</td>
</tr>
<tr>
<td>æ‰“å°æœºæˆ–å…¶ä»–è®¾å¤‡</td>
<td>/dev/lp0è¿™ä¸ªæ‰“å°æœºè£…ç½®</td>
</tr>
<tr>
<td>ä½¿ç”¨è€…åç§°</td>
<td>æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œ*ä»£è¡¨ç›®å‰åœ¨çº¿æ‰€æœ‰çš„äºº</td>
</tr>
<tr>
<td>è¿œç¨‹ä¸»æœº</td>
<td>@10.0.0.2 è¿œç¨‹æ—¥å¿—æœåŠ¡å™¨ï¼Œ@ä»£è¡¨udpåè®®ï¼Œ@@ä»£è¡¨tcpåè®®</td>
</tr>
<tr>
<td>ç®¡é“</td>
<td>|command</td>
</tr>
</tbody>
</table>
<pre><code class="language-bash">$ rpm -ql rsyslog
/etc/logrotate.d/syslog
/etc/pki/rsyslog
/etc/rsyslog.conf &lt;==é…ç½®æ–‡ä»¶
/etc/rsyslog.d
/etc/sysconfig/rsyslog
/usr/bin/rsyslog-recover-qi.pl
/usr/lib/systemd/system/rsyslog.service &lt;==å•å…ƒæ–‡ä»¶
/usr/lib64/rsyslog
/usr/lib64/rsyslog/imdiag.so &lt;==æ”¶é›†æ—¥å¿—æ¥å—æ—¥å¿—æµè¾“å…¥æ—¶çš„è¾“å…¥è¿‡æ»¤å·¥å…·
/usr/lib64/rsyslog/omjournal.so &lt;==
/var/lib/rsyslog
</code></pre>
<h2 id="rsyslogé…ç½®æ–‡ä»¶è¯¦è§£">rsyslogé…ç½®æ–‡ä»¶è¯¦è§£</h2>
<p>rsyslogé…ç½®æ–‡ä»¶åˆ†ä¸º3ä¸ªæ¨¡å—ï¼Œ<font style="background:#fee904;" size=3> æ¯æ®µçš„é…ç½®å¿…é¡»ä¸¥æ ¼å†™åœ¨#### xxx ####ä½ç½®å†…</font></p>
<pre><code class="language-bash">$ grep '##' /etc/rsyslog.conf
#### MODULES ####   #&lt;==åŠ è½½çš„æ¨¡å—
#### GLOBAL DIRECTIVES ####  #&lt;==å®šä¹‰æ—¥å¿—æ ¼å¼é»˜è®¤æ¨¡æ¿
#### RULES ####  #&lt;==è½¬å‘è§„åˆ™
# ### begin forwarding rule ###
# ### end of the forwarding rule ###
</code></pre>
<h3 id="å¸¸ç”¨å‚æ•°">å¸¸ç”¨å‚æ•°</h3>
<pre><code class="language-bash">$ModLoad imklog #&lt;==åŠ è½½æ¨¡å—
mail.*  -/var/log/maillog #&lt;==å°†mailæ‰€æœ‰ç±»å‹çš„æ—¥å¿—å¼‚æ­¥å†™å…¥maillogæ–‡ä»¶ä¸­
</code></pre>
<h2 id="rsyslogæ¡ˆä¾‹">rsyslogæ¡ˆä¾‹</h2>
<h3 id="è®¾ç½®sshæ—¥å¿—ä¸ºå…¶ä»–è®¾æ–½">è®¾ç½®sshæ—¥å¿—ä¸ºå…¶ä»–è®¾æ–½</h3>
<h4 id="ä¿®æ”¹sshé…ç½®æ–‡ä»¶">ä¿®æ”¹sshé…ç½®æ–‡ä»¶</h4>
<pre><code class="language-bash">#SyslogFacility AUTHPRIV
SyslogFacility local1
</code></pre>
<h4 id="ä¿®æ”¹rsyslogé…ç½®æ–‡ä»¶">ä¿®æ”¹rsyslogé…ç½®æ–‡ä»¶</h4>
<p>å°†sshæ—¥å¿—å†™å…¥åˆ°ssh.logä¸­</p>
<pre><code class="language-bash">local1.*    -/var/log/ssh.log
</code></pre>
<p>ä½¿ç”¨sshç™»é™†æŸ¥çœ‹æ—¥å¿—ç”Ÿæˆç»“æœ</p>
<pre><code class="language-bash">$ cat /var/log/ssh.log
Jun  7 00:15:17 Lamp-02 sshd[2966]: Accepted password for root from 192.168.2.1 port 57670 ssh2
</code></pre>
<h3 id="å°†æ—¥å¿—è®°å½•åˆ°è¿œç¨‹æœåŠ¡å™¨">å°†æ—¥å¿—è®°å½•åˆ°è¿œç¨‹æœåŠ¡å™¨</h3>
<p>åœ¨å®¢æˆ·ç«¯é…ç½®</p>
<pre><code class="language-bash">*.info;mail.none;authpriv.none;cron.none;local0.none;          @192.168.2.82
</code></pre>
<p>æœåŠ¡ç«¯å¼€å¯é…ç½®</p>
<pre><code class="language-bash">$ModLoad imudp
$UDPServerRun 514
</code></pre>
<p>æŸ¥çœ‹æœåŠ¡ç«¯çš„æ—¥å¿—è®°å½•æƒ…å†µ</p>
<pre><code class="language-bash">$ cat /var/log/messages
Jun  2 05:47:59 lnmp yum[128171]: Updated: httpd-tools-2.4.6-45.el7.centos.4.x86_64
Jun  2 05:48:03 lnmp yum[128171]: Updated: httpd-2.4.6-45.el7.centos.4.x86_64
Jun  2 05:48:03 lnmp systemd: Reloading.
Jun  2 05:48:04 lnmp systemd: Configuration file /usr/lib/systemd/system/auditd.service is marked world-inaccessible. This has no effect as configuration data is accessible via APIs without restrictions. Proceeding anyway.
</code></pre>
<h3 id="åŸºäºmysqlå­˜å‚¨æ—¥å¿—">åŸºäºMySQLå­˜å‚¨æ—¥å¿—</h3>
<p>å°†æ—¥å¿—å­˜å‚¨åˆ°æ•°æ®åº“ä¸­éœ€è¦åŠ è½½ç›¸å¯¹åº”çš„æ¨¡å—</p>
<pre><code class="language-bash">rsyslog.x86_64                5.8.10-10.el6_6 base
rsyslog-gnutls.x86_64        	5.8.10-10.el6_6 base
rsyslog-gssapi.x86_64        	5.8.10-10.el6_6 base
rsyslog-mysql.x86_64         	5.8.10-10.el6_6 base
rsyslog-pgsql.x86_64          5.8.10-10.el6_6 base
rsyslog-relp.x86_64           5.8.10-10.el6_6 base
rsyslog-snmp.x86_64           5.8.10-10.el6_6 base
...
</code></pre>
<h4 id="å®‰è£…rsyslogç¨‹åºåŒ…">å®‰è£…rsyslogç¨‹åºåŒ…</h4>
<pre><code class="language-bash">$ rpm -ql rsyslog-mysql
/lib64/rsyslog/ommysql.so
/usr/share/doc/rsyslog-mysql-5.8.10
/usr/share/doc/rsyslog-mysql-5.8.10/createDB.sql
</code></pre>
<h4 id="é…ç½®æœåŠ¡å™¨ç«¯å‚æ•°">é…ç½®æœåŠ¡å™¨ç«¯å‚æ•°</h4>
<pre><code class="language-bash">$Modload ommysql
*.info;mail.none;authpriv.none;cron.none :ommysql:localhost,Syslog,syslog,111
</code></pre>
<h4 id="å¯¼å…¥æ•°æ®åº“å¹¶æˆæƒ">å¯¼å…¥æ•°æ®åº“å¹¶æˆæƒ</h4>
<pre><code class="language-sql">mysql &lt; /usr/share/doc/rsyslog-mysql-5.8.10/createDB.sql
grant all privileges on syslog.* to syslog@'localhost' identified by '111';
</code></pre>
<p>æŸ¥çœ‹ç»“æœ</p>
<pre><code class="language-sql">mysql&gt; select count(*) from systemevents;
+----------+
| count(*) |
+----------+
|        3 |
+----------+
1 row in set (0.00 sec)
</code></pre>
<h4 id="å®‰è£…loganalyzer">å®‰è£…loganalyzer</h4>
<p>ä¸‹è½½ <a href="http://loganalyzer.adiscon.com/downloads/" target="_blank"
   rel="noopener nofollow noreferrer" >loganalyzer</a></p>
<pre><code class="language-bash">sh configure.sh
sh secure.sh
chmod 666 config.php
</code></pre>
]]></content:encoded>
    </item>
    
  </channel>
</rss>
