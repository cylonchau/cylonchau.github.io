<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>网络名称空间 | Cylon's Collection</title>
<meta name=keywords content="namespace,network,网络名称空间"><meta name=description content="linux namespace namespace是Linux内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。该功能通过为一组资源和进程具有相同的名称空间而起作用，但是这些名称空间引用了不同的资源。资源可能存在于多个空间中。
Linux namespaces 是对全局系统资源的一种封装隔离，使得处于不同 namespace 的进程拥有独立的全局系统资源，改变一个namespace中的系统资源只会影响当前 namespace 里的进程，对其他 namespace 中的进程没有影响。
每一个进程在其对应的 /proc/[pid]/ns 下都有其 namespace 信息
查看当前进程的namespace ll /proc/$$/ns
bash 1 2 3 4 5 6 7 8 9 10 cgroup -> cgroup:[4026531835] cgroup的根目录 ipc -> ipc:[4026531839] 信号量 mnt -> mnt:[4026531840] 文件系统挂载点 net -> net:[4026531992] 网络设备、网络栈、端口 pid -> pid:[4026531836] 进程编号 pid_for_children -> pid:[4026531836] time -> time:[4026531834] time_for_children -> time:[4026531834] user -> user:[4026531837] 用户和用户组 uts -> uts:[4026531838] 主机名和NIS域名 linux的网络名称空间 linux network namespace 是network namespace 是 linux 内核提供的功能，在实现网络虚拟化中起重要作用，每个网络名称空间中有独立的网络协议栈，如路由表、iptables、端口等。在network namespace可以创建多个隔离的网络空间，它们有独自的网络栈信息。在运行的时候仿佛自己就在独立的网络中。"><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2021/01/netspace/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2021/01/netspace/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><meta property="og:title" content="网络名称空间"><meta property="og:description" content="linux namespace namespace是Linux内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。该功能通过为一组资源和进程具有相同的名称空间而起作用，但是这些名称空间引用了不同的资源。资源可能存在于多个空间中。
Linux namespaces 是对全局系统资源的一种封装隔离，使得处于不同 namespace 的进程拥有独立的全局系统资源，改变一个namespace中的系统资源只会影响当前 namespace 里的进程，对其他 namespace 中的进程没有影响。
每一个进程在其对应的 /proc/[pid]/ns 下都有其 namespace 信息
查看当前进程的namespace ll /proc/$$/ns
bash 1 2 3 4 5 6 7 8 9 10 cgroup -> cgroup:[4026531835] cgroup的根目录 ipc -> ipc:[4026531839] 信号量 mnt -> mnt:[4026531840] 文件系统挂载点 net -> net:[4026531992] 网络设备、网络栈、端口 pid -> pid:[4026531836] 进程编号 pid_for_children -> pid:[4026531836] time -> time:[4026531834] time_for_children -> time:[4026531834] user -> user:[4026531837] 用户和用户组 uts -> uts:[4026531838] 主机名和NIS域名 linux的网络名称空间 linux network namespace 是network namespace 是 linux 内核提供的功能，在实现网络虚拟化中起重要作用，每个网络名称空间中有独立的网络协议栈，如路由表、iptables、端口等。在network namespace可以创建多个隔离的网络空间，它们有独自的网络栈信息。在运行的时候仿佛自己就在独立的网络中。"><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2021/01/netspace/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-01-02T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-22T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="网络名称空间"><meta name=twitter:description content="linux namespace namespace是Linux内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。该功能通过为一组资源和进程具有相同的名称空间而起作用，但是这些名称空间引用了不同的资源。资源可能存在于多个空间中。
Linux namespaces 是对全局系统资源的一种封装隔离，使得处于不同 namespace 的进程拥有独立的全局系统资源，改变一个namespace中的系统资源只会影响当前 namespace 里的进程，对其他 namespace 中的进程没有影响。
每一个进程在其对应的 /proc/[pid]/ns 下都有其 namespace 信息
查看当前进程的namespace ll /proc/$$/ns
bash 1 2 3 4 5 6 7 8 9 10 cgroup -> cgroup:[4026531835] cgroup的根目录 ipc -> ipc:[4026531839] 信号量 mnt -> mnt:[4026531840] 文件系统挂载点 net -> net:[4026531992] 网络设备、网络栈、端口 pid -> pid:[4026531836] 进程编号 pid_for_children -> pid:[4026531836] time -> time:[4026531834] time_for_children -> time:[4026531834] user -> user:[4026531837] 用户和用户组 uts -> uts:[4026531838] 主机名和NIS域名 linux的网络名称空间 linux network namespace 是network namespace 是 linux 内核提供的功能，在实现网络虚拟化中起重要作用，每个网络名称空间中有独立的网络协议栈，如路由表、iptables、端口等。在network namespace可以创建多个隔离的网络空间，它们有独自的网络栈信息。在运行的时候仿佛自己就在独立的网络中。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"网络名称空间","item":"https://www.oomkill.com/2021/01/netspace/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"网络名称空间","name":"网络名称空间","description":"linux namespace namespace是Linux内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。该功能通过为一组资源和进程具有相同的名称空间而起作用，但是这些名称空间引用了不同的资源。资源可能存在于多个空间中。\nLinux namespaces 是对全局系统资源的一种封装隔离，使得处于不同 namespace 的进程拥有独立的全局系统资源，改变一个namespace中的系统资源只会影响当前 namespace 里的进程，对其他 namespace 中的进程没有影响。\n每一个进程在其对应的 /proc/[pid]/ns 下都有其 namespace 信息\n查看当前进程的namespace ll /proc/$$/ns\nbash 1 2 3 4 5 6 7 8 9 10 cgroup -\u0026gt; cgroup:[4026531835] cgroup的根目录 ipc -\u0026gt; ipc:[4026531839] 信号量 mnt -\u0026gt; mnt:[4026531840] 文件系统挂载点 net -\u0026gt; net:[4026531992] 网络设备、网络栈、端口 pid -\u0026gt; pid:[4026531836] 进程编号 pid_for_children -\u0026gt; pid:[4026531836] time -\u0026gt; time:[4026531834] time_for_children -\u0026gt; time:[4026531834] user -\u0026gt; user:[4026531837] 用户和用户组 uts -\u0026gt; uts:[4026531838] 主机名和NIS域名 linux的网络名称空间 linux network namespace 是network namespace 是 linux 内核提供的功能，在实现网络虚拟化中起重要作用，每个网络名称空间中有独立的网络协议栈，如路由表、iptables、端口等。在network namespace可以创建多个隔离的网络空间，它们有独自的网络栈信息。在运行的时候仿佛自己就在独立的网络中。","keywords":["namespace","network","网络名称空间"],"articleBody":"linux namespace namespace是Linux内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。该功能通过为一组资源和进程具有相同的名称空间而起作用，但是这些名称空间引用了不同的资源。资源可能存在于多个空间中。\nLinux namespaces 是对全局系统资源的一种封装隔离，使得处于不同 namespace 的进程拥有独立的全局系统资源，改变一个namespace中的系统资源只会影响当前 namespace 里的进程，对其他 namespace 中的进程没有影响。\n每一个进程在其对应的 /proc/[pid]/ns 下都有其 namespace 信息\n查看当前进程的namespace ll /proc/$$/ns\nbash 1 2 3 4 5 6 7 8 9 10 cgroup -\u003e cgroup:[4026531835] cgroup的根目录 ipc -\u003e ipc:[4026531839] 信号量 mnt -\u003e mnt:[4026531840] 文件系统挂载点 net -\u003e net:[4026531992] 网络设备、网络栈、端口 pid -\u003e pid:[4026531836] 进程编号 pid_for_children -\u003e pid:[4026531836] time -\u003e time:[4026531834] time_for_children -\u003e time:[4026531834] user -\u003e user:[4026531837] 用户和用户组 uts -\u003e uts:[4026531838] 主机名和NIS域名 linux的网络名称空间 linux network namespace 是network namespace 是 linux 内核提供的功能，在实现网络虚拟化中起重要作用，每个网络名称空间中有独立的网络协议栈，如路由表、iptables、端口等。在network namespace可以创建多个隔离的网络空间，它们有独自的网络栈信息。在运行的时候仿佛自己就在独立的网络中。\nlinux网络管理命令ip ip命令是Linux管理网络的工具，他对路由、地址、链路、namespace等的管理。\nip命令的使用说明：\nip netns list 查看网络命名空间\nip netns add net2 创建一个网络命名空间\nip link add $name link eth0 type ipvlan mode l2 在当前名称空间创建一个类型为ipvlan l2模式的接口，将该接口关联至父接口eth0上。\nip link set $name netns $nsName 将接口加入到对应网络名称空间内\nip netns exec $nsName $cmd 在对应的网络名称空间内运行命令\nip link add $p1-name type veth peer name $p2-name 创建一个网卡对\nethtool -S $interface_name 查看网卡对对应关系，通过index获得另外一端\n虚拟以太网对 VETH Pair VETH virtual-ethernet 虚拟以太网对，是网络交换机中的虚拟接口，在linux名称空间中，vEth可以充当名称空间之间的隧道，通过建立一个网桥链接到另一个名称空间中的物理设备，所有设备始终以互连对的形式创建。\n实验：使在不同网络名称空间下的vEth互通 实验实现：创建两个名称空间net1和net2，以及一对VETH设备，并将其分配veth1给namespacenet1 和veth2namespace net2。这两个名称空间与此VETH对相连。分配一对IP地址，使两个名称空间之间ping通。\n开启linuxip转发功能\ntext 1 echo 1 \u003e /proc/sys/net/ipv4/ip_forward 创建两个名称空间\ntext 1 2 ip netns add net1 ip netns add net2 创建两个虚拟网卡对\ntext 1 2 ip link a veth0 type veth peer name br-veth0 ip link a veth1 type veth peer name br-veth1 创建一个网桥\ntext 1 2 3 ip link add bridge1 type bridge # 启动设备 ip link set bridge1 up 将虚拟网卡对的一段链接至网桥上\ntext 1 2 3 4 5 ip link set br-veth0 master bridge1 ip link set br-veth1 master bridge1 ip link set br-veth1 up ip link set br-veth0 up 虚拟网桥另外一端关联至对应名称空间内\ntext 1 2 3 4 5 6 7 8 ip link set veth0 netns net1 ip link set veth1 netns net2 ip netns exec net1 ip addr add 192.168.0.1/24 dev veth0 ip netns exec net2 ip addr add 192.168.0.2/24 dev veth1 ip netns exec net1 ip link set veth0 up ip netns exec net2 ip link set veth1 up 此时可以通过网桥对这两个网络进行互相ping通，不同网段的需要手动添加相应的路由表规则。而ping自己的地址不通，原因是因为lo设备未启动。\ntext 1 ip netns exec net2 ip link set lo up OVS ipip mode IPIP是RFC 2003中定义的IP over IP隧道。IPIP隧道标头如下所示：\n实验：实现一个IPIP隧道 ipip 模式需要内核模块 ipip.ko 使用命令查看内核是否加载IPIP模块lsmod | grep ipip ；使用命令modprobe ipip 加载\n实验效果，如下图，在两个名称空间内创建一个 tun 设备，然后将该 tun 设备绑定为一个 ipip 隧道。\n创建名称空间及虚拟网卡对\ntext 1 2 3 4 5 6 7 8 ip netns add net1 ip netns add net2 ip link a veth0 type veth peer name br-veth0 ip link a veth1 type veth peer name br-veth1 ip link set veth0 netns net1 ip link set veth1 netns net2 给虚拟网卡对的一端配置地址\ntext 1 2 3 4 5 ip addr add 192.168.10.1/24 dev br-veth0 ip addr add 192.168.20.1/24 dev br-veth1 ip netns exec net1 ip link set veth0 up ip netns exec net2 ip link set veth1 up 在两个名称空间内分别创建一个ipip tunnel\ntext 1 2 3 4 5 6 7 8 netns exec net2 ip tunnel add tun1 mode ipip remote 192.168.10.2 local 192.168.20.2 netns exec net1 ip tunnel add tun1 mode ipip remote 192.168.20.2 local 192.168.10.2 ip netns exec net1 ip link set tun1 up ip netns exec net2 ip link set tun1 up ip netns exec net1 ip addr add 192.168.100.10 peer 192.168.200.10 dev tun1 ip netns exec net2 ip addr add 192.168.200.10 peer 192.168.100.10 dev tun1 这个命令是在对应网络名称空间内创建隧道设备tun1，并设置隧道模式为 ipip，然后还需要设置隧道端点，用 remote 和 local 表示，这是隧道外层 IP，对应设置 隧道内层 IP，用 ip addr xx peer xx 配置。\n分析ipip tunnel过程。\n首先 ping 命令构建一个 ICMP 请求包，ICMP 包封装在 IP 包中，源目的 IP 地址分别为 tun1(192.168.200.10) 和 tun2(192.168.100.10) 的地址。 由于 tun1 和 tun2 不在同一网段，所以会查路由表，当通过 ip tunnel 命令建立 ipip 隧道之后，会自动生成一条路由，如下，表明去往目的地 192.168.100.10 的路由直接从 tun1 出去。 bash 1 2 3 4 5 6 $ ip netns exec net2 route -n Kernel IP routing table Destination Gateway Genmask Flags Metric Ref Use Iface 192.168.10.0 192.168.20.1 255.255.255.0 UG 0 0 0 veth1 192.168.20.0 0.0.0.0 255.255.255.0 U 0 0 0 veth1 192.168.100.10 0.0.0.0 255.255.255.255 UH 0 0 0 tun1 由于配置了隧道端点，数据包出了 tun1，到达 veth1，根据 ipip 隧道的配置，会封装上一层新的 IP 报头，源目的 IP 地址分别为 veth2(192.168.20.2) 和 veth1(192.168.10.2)。 veth2和 veth1不在一个网段，因为手动添加的路由表，发现去往 192.168.10.0 网段从 192.168.20.1 veth2虚拟网卡对另外一端 br-veth2出。 因为Linux 打开了 ip_forward，类似于路由器功能，192.168.10.0 和 192.168.20.1 为直连路由，直接有路由器转发。完成了net2到net1的过程。 数据包到达 net1 的 veth1，解封装数据包，发现内层 IP 报文的目的 IP 地址是 192.168.100.10，这正是自己配置的 ipip 隧道的 tun1(192.168.100.10) 地址，于是将报文转交 tun1(192.168.100.10)。 ICMP报文是双向的，故，相通的步骤还要返回到tun1(192.168.200.10) 。 通过抓包工具查看数据包的详细内容\n","wordCount":"625","inLanguage":"zh","datePublished":"2021-01-02T00:00:00Z","dateModified":"2023-03-22T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2021/01/netspace/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">网络名称空间</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2021-01-02</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>625 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>3 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/network/>#Network</a></ul>&nbsp;·&nbsp;<span id=busuanzi_container_page_pv>本文阅读量 <span id=busuanzi_value_page_pv></span> 次</span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#linux-namespace aria-label="linux namespace">linux namespace</a><li><a href=#linux%e7%9a%84%e7%bd%91%e7%bb%9c%e5%90%8d%e7%a7%b0%e7%a9%ba%e9%97%b4 aria-label=linux的网络名称空间>linux的网络名称空间</a><ul><li><a href=#linux%e7%bd%91%e7%bb%9c%e7%ae%a1%e7%90%86%e5%91%bd%e4%bb%a4ip aria-label=linux网络管理命令ip>linux网络管理命令ip</a></ul><li><a href=#%e8%99%9a%e6%8b%9f%e4%bb%a5%e5%a4%aa%e7%bd%91%e5%af%b9-veth-pair aria-label="虚拟以太网对 VETH Pair">虚拟以太网对 VETH Pair</a><ul><li><a href=#%e5%ae%9e%e9%aa%8c%e4%bd%bf%e5%9c%a8%e4%b8%8d%e5%90%8c%e7%bd%91%e7%bb%9c%e5%90%8d%e7%a7%b0%e7%a9%ba%e9%97%b4%e4%b8%8b%e7%9a%84veth%e4%ba%92%e9%80%9a aria-label=实验：使在不同网络名称空间下的vEth互通>实验：使在不同网络名称空间下的vEth互通</a></ul><li><a href=#ovs aria-label=OVS>OVS</a><li><a href=#ipip-mode aria-label="ipip mode">ipip mode</a><li><a href=#%e5%ae%9e%e9%aa%8c%e5%ae%9e%e7%8e%b0%e4%b8%80%e4%b8%aaipip%e9%9a%a7%e9%81%93 aria-label=实验：实现一个IPIP隧道>实验：实现一个IPIP隧道</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=linux-namespace>linux namespace<a hidden class=anchor aria-hidden=true href=#linux-namespace>#</a></h2><p><strong>namespace</strong>是Linux内核的一项功能，该功能对内核资源进行分区，以使一组<a href=https://en.wikipedia.org/wiki/Process_%28computing%29 target=_blank rel="noopener nofollow noreferrer">进程</a>看到一组资源，而另一组进程看到另一组资源。该功能通过为一组资源和进程具有相同的名称空间而起作用，但是这些名称空间引用了不同的资源。资源可能存在于多个空间中。</p><p>Linux namespaces 是对全局系统资源的一种封装隔离，使得处于不同 namespace 的进程拥有独立的全局系统资源，改变一个namespace中的系统资源只会影响当前 namespace 里的进程，对其他 namespace 中的进程没有影响。</p><p>每一个进程在其对应的 <code>/proc/[pid]/ns</code> 下都有其 namespace 信息</p><p>查看当前进程的namespace <code>ll /proc/$$/ns</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cgroup -&gt; cgroup:<span class=o>[</span>4026531835<span class=o>]</span> cgroup的根目录
</span></span><span class=line><span class=cl>ipc -&gt; ipc:<span class=o>[</span>4026531839<span class=o>]</span> 信号量
</span></span><span class=line><span class=cl>mnt -&gt; mnt:<span class=o>[</span>4026531840<span class=o>]</span> 文件系统挂载点
</span></span><span class=line><span class=cl>net -&gt; net:<span class=o>[</span>4026531992<span class=o>]</span> 网络设备、网络栈、端口
</span></span><span class=line><span class=cl>pid -&gt; pid:<span class=o>[</span>4026531836<span class=o>]</span> 进程编号
</span></span><span class=line><span class=cl>pid_for_children -&gt; pid:<span class=o>[</span>4026531836<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=nb>time</span> -&gt; time:<span class=o>[</span>4026531834<span class=o>]</span>
</span></span><span class=line><span class=cl>time_for_children -&gt; time:<span class=o>[</span>4026531834<span class=o>]</span>
</span></span><span class=line><span class=cl>user -&gt; user:<span class=o>[</span>4026531837<span class=o>]</span> 用户和用户组
</span></span><span class=line><span class=cl>uts -&gt; uts:<span class=o>[</span>4026531838<span class=o>]</span> 主机名和NIS域名</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=linux的网络名称空间>linux的网络名称空间<a hidden class=anchor aria-hidden=true href=#linux的网络名称空间>#</a></h2><p>linux network namespace 是network namespace 是 linux 内核提供的功能，在实现网络虚拟化中起重要作用，每个网络名称空间中有独立的网络协议栈，如路由表、iptables、端口等。在network namespace可以创建多个隔离的网络空间，它们有独自的网络栈信息。在运行的时候仿佛自己就在独立的网络中。</p><h3 id=linux网络管理命令ip>linux网络管理命令ip<a hidden class=anchor aria-hidden=true href=#linux网络管理命令ip>#</a></h3><p>ip命令是Linux管理网络的工具，他对路由、地址、链路、namespace等的管理。</p><p>ip命令的使用说明：</p><ul><li><p><code>ip netns list</code> 查看网络命名空间</p></li><li><p><code>ip netns add net2</code> 创建一个网络命名空间</p></li><li><p><code>ip link add $name link eth0 type ipvlan mode l2</code> 在当前名称空间创建一个类型为ipvlan l2模式的接口，将该接口关联至父接口eth0上。</p></li><li><p><code>ip link set $name netns $nsName</code> 将接口加入到对应网络名称空间内</p></li><li><p><code>ip netns exec $nsName $cmd</code> 在对应的网络名称空间内运行命令</p></li><li><p><code>ip link add $p1-name type veth peer name $p2-name</code> 创建一个网卡对</p></li><li><p><code>ethtool -S $interface_name</code> 查看网卡对对应关系，通过index获得另外一端</p></li></ul><h2 id=虚拟以太网对-veth-pair>虚拟以太网对 VETH Pair<a hidden class=anchor aria-hidden=true href=#虚拟以太网对-veth-pair>#</a></h2><p>VETH virtual-ethernet 虚拟以太网对，是网络交换机中的虚拟接口，在linux名称空间中，vEth可以充当名称空间之间的隧道，通过建立一个网桥链接到另一个名称空间中的物理设备，所有设备始终以互连对的形式创建。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174025232.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174025232.png#center alt=image-20221025174025232 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h3 id=实验使在不同网络名称空间下的veth互通>实验：使在不同网络名称空间下的vEth互通<a hidden class=anchor aria-hidden=true href=#实验使在不同网络名称空间下的veth互通>#</a></h3><p>实验实现：创建两个名称空间<code>net1</code>和<code>net2</code>，以及一对VETH设备，并将其分配<code>veth1</code>给namespace<code>net1</code> 和<code>veth2</code>namespace <code>net2</code>。这两个名称空间与此VETH对相连。分配一对IP地址，使两个名称空间之间ping通。</p><p>开启linuxip转发功能</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span></span></code></pre></td></tr></table></div></div></div></div><p>创建两个名称空间</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip netns add net1
</span></span><span class=line><span class=cl>ip netns add net2</span></span></code></pre></td></tr></table></div></div></div></div><p>创建两个虚拟网卡对</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip link a veth0 type veth peer name br-veth0
</span></span><span class=line><span class=cl>ip link a veth1 type veth peer name br-veth1</span></span></code></pre></td></tr></table></div></div></div></div><p>创建一个网桥</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip link add bridge1 type bridge
</span></span><span class=line><span class=cl># 启动设备
</span></span><span class=line><span class=cl>ip link set bridge1 up</span></span></code></pre></td></tr></table></div></div></div></div><p>将虚拟网卡对的一段链接至网桥上</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip link set br-veth0 master bridge1
</span></span><span class=line><span class=cl>ip link set br-veth1 master bridge1
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>ip link set br-veth1 up
</span></span><span class=line><span class=cl>ip link set br-veth0 up</span></span></code></pre></td></tr></table></div></div></div></div><p>虚拟网桥另外一端关联至对应名称空间内</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip link set veth0 netns net1
</span></span><span class=line><span class=cl>ip link set veth1 netns net2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns exec net1 ip addr add 192.168.0.1/24 dev veth0
</span></span><span class=line><span class=cl>ip netns exec net2 ip addr add 192.168.0.2/24 dev veth1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns exec net1 ip link set veth0 up
</span></span><span class=line><span class=cl>ip netns exec net2 ip link set veth1 up</span></span></code></pre></td></tr></table></div></div></div></div><p>此时可以通过网桥对这两个网络进行互相ping通，不同网段的需要手动添加相应的路由表规则。而ping自己的地址不通，原因是因为lo设备未启动。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip netns exec net2 ip link set lo up</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=ovs>OVS<a hidden class=anchor aria-hidden=true href=#ovs>#</a></h2><h2 id=ipip-mode>ipip mode<a hidden class=anchor aria-hidden=true href=#ipip-mode>#</a></h2><p>IPIP是<a href=https://tools.ietf.org/html/rfc2003 target=_blank rel="noopener nofollow noreferrer">RFC 2003中</a>定义的IP over IP隧道。IPIP隧道标头如下所示：</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174038429.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174038429.png#center alt=image-20221025174038429 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h2 id=实验实现一个ipip隧道>实验：实现一个IPIP隧道<a hidden class=anchor aria-hidden=true href=#实验实现一个ipip隧道>#</a></h2><p><code>ipip</code> 模式需要内核模块 <code>ipip.ko</code> 使用命令查看内核是否加载IPIP模块<code>lsmod | grep ipip</code> ；使用命令<code>modprobe ipip</code> 加载</p><p>实验效果，如下图，在两个名称空间内创建一个 tun 设备，然后将该 tun 设备绑定为一个 <code>ipip</code> 隧道。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174049463.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174049463.png#center alt=image-20221025174049463 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>创建名称空间及虚拟网卡对</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip netns add net1
</span></span><span class=line><span class=cl>ip netns add net2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link a veth0 type veth peer name br-veth0
</span></span><span class=line><span class=cl>ip link a veth1 type veth peer name br-veth1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip link set veth0 netns net1
</span></span><span class=line><span class=cl>ip link set veth1 netns net2</span></span></code></pre></td></tr></table></div></div></div></div><p>给虚拟网卡对的一端配置地址</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>ip addr add 192.168.10.1/24 dev br-veth0
</span></span><span class=line><span class=cl>ip addr add 192.168.20.1/24 dev br-veth1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns exec net1 ip link set veth0 up
</span></span><span class=line><span class=cl>ip netns exec net2 ip link set veth1 up</span></span></code></pre></td></tr></table></div></div></div></div><p>在两个名称空间内分别创建一个ipip tunnel</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>netns exec net2 ip tunnel add tun1 mode ipip remote 192.168.10.2 local 192.168.20.2
</span></span><span class=line><span class=cl>netns exec net1 ip tunnel add tun1 mode ipip remote 192.168.20.2 local 192.168.10.2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns exec net1 ip link set tun1 up
</span></span><span class=line><span class=cl>ip netns exec net2 ip link set tun1 up
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip netns exec net1 ip addr add 192.168.100.10 peer 192.168.200.10 dev tun1
</span></span><span class=line><span class=cl>ip netns exec net2 ip addr add 192.168.200.10 peer 192.168.100.10 dev tun1</span></span></code></pre></td></tr></table></div></div></div></div><p>这个命令是在对应网络名称空间内创建隧道设备tun1，并设置隧道模式为 <code>ipip</code>，然后还需要设置隧道端点，用 <code>remote</code> 和 <code>local</code> 表示，这是<strong>隧道外层 IP</strong>，对应设置 <strong>隧道内层 IP</strong>，用 <code>ip addr xx peer xx</code> 配置。</p><p>分析ipip tunnel过程。</p><ol><li>首先 ping 命令构建一个 ICMP 请求包，ICMP 包封装在 IP 包中，源目的 IP 地址分别为 <code>tun1(192.168.200.10)</code> 和 <code>tun2(192.168.100.10)</code> 的地址。</li><li>由于 tun1 和 tun2 不在同一网段，所以会查路由表，当通过 <code>ip tunnel</code> 命令建立 <code>ipip</code> 隧道之后，会自动生成一条路由，如下，表明去往目的地 <code>192.168.100.10</code> 的路由直接从 tun1 出去。</li></ol><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>bash</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ip netns <span class=nb>exec</span> net2 route -n
</span></span><span class=line><span class=cl>Kernel IP routing table
</span></span><span class=line><span class=cl>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span class=line><span class=cl>192.168.10.0    192.168.20.1    255.255.255.0   UG    <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> veth1
</span></span><span class=line><span class=cl>192.168.20.0    0.0.0.0         255.255.255.0   U     <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> veth1
</span></span><span class=line><span class=cl>192.168.100.10  0.0.0.0         255.255.255.255 UH    <span class=m>0</span>      <span class=m>0</span>        <span class=m>0</span> tun1</span></span></code></pre></td></tr></table></div></div></div></div><ol start=3><li>由于配置了隧道端点，数据包出了 tun1，到达 veth1，根据 <code>ipip</code> 隧道的配置，会封装上一层新的 IP 报头，源目的 IP 地址分别为 <code>veth2(192.168.20.2)</code> 和 <code>veth1(192.168.10.2)</code>。</li><li>veth2和 veth1不在一个网段，因为手动添加的路由表，发现去往 <code>192.168.10.0</code> 网段从 <code>192.168.20.1</code> veth2虚拟网卡对另外一端 br-veth2出。</li><li>因为Linux 打开了 <code>ip_forward</code>，类似于路由器功能，<code>192.168.10.0</code> 和 <code>192.168.20.1</code> 为直连路由，直接有路由器转发。完成了net2到net1的过程。</li><li>数据包到达 net1 的 veth1，解封装数据包，发现内层 IP 报文的目的 IP 地址是 <code>192.168.100.10</code>，这正是自己配置的 <code>ipip</code> 隧道的 <code>tun1(192.168.100.10)</code> 地址，于是将报文转交 <code>tun1(192.168.100.10)</code>。</li><li>ICMP报文是双向的，故，相通的步骤还要返回到<code>tun1(192.168.200.10)</code> 。</li></ol><blockquote><p><strong>通过抓包工具查看数据包的详细内容</strong></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174102350.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174102350.png#center alt=image-20221025174102350 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174126074.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20221025174126074.png#center alt=image-20221025174126074 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：网络名称空间</p><p>文章链接：<a href=https://www.oomkill.com/2021/01/netspace/ target=_blank>https://www.oomkill.com/2021/01/netspace/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2021/01/dynamic-routing-ospf/><span>动态路由 - OSPF</span></a></li><li><a href=/2021/01/experiment-vlan/><span>网络实验 - VLAN</span></a></li><li><a href=/2021/01/experiment-vxlan/><span>网络实验 - VxLAN</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/network/>Network</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2021/01/dynamic-routing-ospf/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>动态路由 - OSPF</span>
</a><a class=next href=https://www.oomkill.com/2021/01/experiment-vlan/><span class=title></span>
<span>网络实验 - VLAN&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/netspace","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span><div class=busuanzi-footer style="font-family:helvetica neue,Helvetica,Arial,sans-serif;text-align:center;padding:4px 0;color:#999"><span id=busuanzi_container_site_pv style=margin-right:8px;font-size:.85em>本站总访问量<span id=busuanzi_value_site_pv style=font-weight:500>0</span>次
</span><span id=busuanzi_container_site_uv style=font-size:.85em>本站访客数<span id=busuanzi_value_site_uv style=font-weight:500>0</span>人次</span></div></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>