<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>kube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡ | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop"><meta name=description content="Scheduler Scheduler æ˜¯æ•´ä¸ª kube-scheduler çš„ä¸€ä¸ª structureï¼Œæä¾›äº† kube-scheduler è¿è¡Œæ‰€éœ€çš„ç»„ä»¶ã€‚
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cacheæ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œä¼šç¼“å­˜podçš„ä¿¡æ¯ï¼Œä½œä¸ºschedulerè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ“ä½œæ˜¯åŸºäºPodè¿›è¡Œå¢åŠ  Cache internalcache.Cache // Extenders ç®—æ˜¯è°ƒåº¦æ¡†æ¶ä¸­æä¾›çš„è°ƒåº¦æ’ä»¶ï¼Œä¼šå½±å“kubernetesä¸­çš„è°ƒåº¦ç­–ç•¥ Extenders []framework.Extender // NextPod ä½œä¸ºä¸€ä¸ªå‡½æ•°æä¾›ï¼Œä¼šé˜»å¡è·å–ä¸‹ä¸€ä¸ªke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework."><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/07/ch20-schedule-workflow/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/07/ch20-schedule-workflow/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="kube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡"><meta property="og:description" content="Scheduler Scheduler æ˜¯æ•´ä¸ª kube-scheduler çš„ä¸€ä¸ª structureï¼Œæä¾›äº† kube-scheduler è¿è¡Œæ‰€éœ€çš„ç»„ä»¶ã€‚
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cacheæ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œä¼šç¼“å­˜podçš„ä¿¡æ¯ï¼Œä½œä¸ºschedulerè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ“ä½œæ˜¯åŸºäºPodè¿›è¡Œå¢åŠ  Cache internalcache.Cache // Extenders ç®—æ˜¯è°ƒåº¦æ¡†æ¶ä¸­æä¾›çš„è°ƒåº¦æ’ä»¶ï¼Œä¼šå½±å“kubernetesä¸­çš„è°ƒåº¦ç­–ç•¥ Extenders []framework.Extender // NextPod ä½œä¸ºä¸€ä¸ªå‡½æ•°æä¾›ï¼Œä¼šé˜»å¡è·å–ä¸‹ä¸€ä¸ªke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework."><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/07/ch20-schedule-workflow/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-21T00:00:00+00:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="kube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡"><meta name=twitter:description content="Scheduler Scheduler æ˜¯æ•´ä¸ª kube-scheduler çš„ä¸€ä¸ª structureï¼Œæä¾›äº† kube-scheduler è¿è¡Œæ‰€éœ€çš„ç»„ä»¶ã€‚
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cacheæ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œä¼šç¼“å­˜podçš„ä¿¡æ¯ï¼Œä½œä¸ºschedulerè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ“ä½œæ˜¯åŸºäºPodè¿›è¡Œå¢åŠ  Cache internalcache.Cache // Extenders ç®—æ˜¯è°ƒåº¦æ¡†æ¶ä¸­æä¾›çš„è°ƒåº¦æ’ä»¶ï¼Œä¼šå½±å“kubernetesä¸­çš„è°ƒåº¦ç­–ç•¥ Extenders []framework.Extender // NextPod ä½œä¸ºä¸€ä¸ªå‡½æ•°æä¾›ï¼Œä¼šé˜»å¡è·å–ä¸‹ä¸€ä¸ªke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"kube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡","item":"https://www.oomkill.com/2022/07/ch20-schedule-workflow/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"kube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡","name":"kube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡","description":"Scheduler Scheduler æ˜¯æ•´ä¸ª kube-scheduler çš„ä¸€ä¸ª structureï¼Œæä¾›äº† kube-scheduler è¿è¡Œæ‰€éœ€çš„ç»„ä»¶ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cacheæ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œä¼šç¼“å­˜podçš„ä¿¡æ¯ï¼Œä½œä¸ºschedulerè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ“ä½œæ˜¯åŸºäºPodè¿›è¡Œå¢åŠ  Cache internalcache.Cache // Extenders ç®—æ˜¯è°ƒåº¦æ¡†æ¶ä¸­æä¾›çš„è°ƒåº¦æ’ä»¶ï¼Œä¼šå½±å“kubernetesä¸­çš„è°ƒåº¦ç­–ç•¥ Extenders []framework.Extender // NextPod ä½œä¸ºä¸€ä¸ªå‡½æ•°æä¾›ï¼Œä¼šé˜»å¡è·å–ä¸‹ä¸€ä¸ªke\u0026#39;diao\u0026#39;du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework.","keywords":["kubernetes","develop"],"articleBody":"Scheduler Scheduler æ˜¯æ•´ä¸ª kube-scheduler çš„ä¸€ä¸ª structureï¼Œæä¾›äº† kube-scheduler è¿è¡Œæ‰€éœ€çš„ç»„ä»¶ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 type Scheduler struct { // Cacheæ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œä¼šç¼“å­˜podçš„ä¿¡æ¯ï¼Œä½œä¸ºschedulerè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ“ä½œæ˜¯åŸºäºPodè¿›è¡Œå¢åŠ  Cache internalcache.Cache // Extenders ç®—æ˜¯è°ƒåº¦æ¡†æ¶ä¸­æä¾›çš„è°ƒåº¦æ’ä»¶ï¼Œä¼šå½±å“kubernetesä¸­çš„è°ƒåº¦ç­–ç•¥ Extenders []framework.Extender // NextPod ä½œä¸ºä¸€ä¸ªå‡½æ•°æä¾›ï¼Œä¼šé˜»å¡è·å–ä¸‹ä¸€ä¸ªke'diao'du NextPod func() *framework.QueuedPodInfo // Error is called if there is an error. It is passed the pod in // question, and the error Error func(*framework.QueuedPodInfo, error) // SchedulePod å°è¯•å°†ç»™å‡ºçš„podè°ƒåº¦åˆ°Nodeã€‚ SchedulePod func(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (ScheduleResult, error) // å…³é—­schedulerçš„ä¿¡å· StopEverything \u003c-chan struct{} // SchedulingQueueä¿å­˜è¦è°ƒåº¦çš„Pod SchedulingQueue internalqueue.SchedulingQueue // Profilesä¸­æ˜¯å¤šä¸ªè°ƒåº¦æ¡†æ¶ Profiles profile.Map client clientset.Interface nodeInfoSnapshot *internalcache.Snapshot percentageOfNodesToScore int32 nextStartNodeIndex int } ä½œä¸ºå®é™…æ‰§è¡Œçš„ä¸¤ä¸ªæ ¸å¿ƒï¼ŒSchedulingQueue ï¼Œä¸ scheduleOne å°†ä¼šåˆ†æåˆ°è¿™ä¸¤ä¸ª\nSchedulingQueue åœ¨çŸ¥é“ kube-scheduler åˆå§‹åŒ–è¿‡ç¨‹åï¼Œéœ€è¦å¯¹ kube-scheduler çš„æ•´ä¸ª structure å’Œ workflow è¿›è¡Œåˆ†æ\nåœ¨ Run ä¸­ï¼Œè¿è¡Œçš„æ˜¯ ä¸€ä¸ª SchedulingQueue ä¸ ä¸€ä¸ª scheduleOne ï¼Œä»ç»“æ„ä¸Šçœ‹æ˜¯å±äº Scheduler\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (sched *Scheduler) Run(ctx context.Context) { sched.SchedulingQueue.Run() // We need to start scheduleOne loop in a dedicated goroutine, // because scheduleOne function hangs on getting the next item // from the SchedulingQueue. // If there are no new pods to schedule, it will be hanging there // and if done in this goroutine it will be blocking closing // SchedulingQueue, in effect causing a deadlock on shutdown. go wait.UntilWithContext(ctx, sched.scheduleOne, 0) \u003c-ctx.Done() sched.SchedulingQueue.Close() } SchedulingQueue æ˜¯ä¸€ä¸ªé˜Ÿåˆ—çš„æŠ½è±¡ï¼Œç”¨äºå­˜å‚¨ç­‰å¾…è°ƒåº¦çš„Podã€‚è¯¥æ¥å£éµå¾ªç±»ä¼¼äº cache.FIFO å’Œ cache.Heap çš„æ¨¡å¼ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 type SchedulingQueue interface { framework.PodNominator Add(pod *v1.Pod) error // Activate moves the given pods to activeQ iff they're in unschedulablePods or backoffQ. // The passed-in pods are originally compiled from plugins that want to activate Pods, // by injecting the pods through a reserved CycleState struct (PodsToActivate). Activate(pods map[string]*v1.Pod) // å°†ä¸å¯è°ƒåº¦çš„Podé‡å…¥åˆ°é˜Ÿåˆ—ä¸­ AddUnschedulableIfNotPresent(pod *framework.QueuedPodInfo, podSchedulingCycle int64) error // SchedulingCycle returns the current number of scheduling cycle which is // cached by scheduling queue. Normally, incrementing this number whenever // a pod is popped (e.g. called Pop()) is enough. SchedulingCycle() int64 // Popä¼šå¼¹å‡ºä¸€ä¸ªpodï¼Œå¹¶ä»headä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­åˆ é™¤ Pop() (*framework.QueuedPodInfo, error) Update(oldPod, newPod *v1.Pod) error Delete(pod *v1.Pod) error MoveAllToActiveOrBackoffQueue(event framework.ClusterEvent, preCheck PreEnqueueCheck) AssignedPodAdded(pod *v1.Pod) AssignedPodUpdated(pod *v1.Pod) PendingPods() []*v1.Pod // Close closes the SchedulingQueue so that the goroutine which is // waiting to pop items can exit gracefully. Close() // Run starts the goroutines managing the queue. Run() } è€Œ PriorityQueue æ˜¯ SchedulingQueue çš„å®ç°ï¼Œè¯¥éƒ¨åˆ†çš„æ ¸å¿ƒæ„æˆæ˜¯ä¸¤ä¸ªå­é˜Ÿåˆ—ä¸ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå³ activeQã€backoffQ å’Œ unschedulablePods\nactiveQï¼šæ˜¯ä¸€ä¸ª heap ç±»å‹çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ˜¯ sheduler ä»ä¸­è·å¾—ä¼˜å…ˆçº§æœ€é«˜çš„Podè¿›è¡Œè°ƒåº¦ backoffQï¼šä¹Ÿæ˜¯ä¸€ä¸ª heap ç±»å‹çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå­˜æ”¾çš„æ˜¯ä¸å¯è°ƒåº¦çš„Pod unschedulablePods ï¼šä¿å­˜ç¡®å®šä¸å¯è¢«è°ƒåº¦çš„Pod GO 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 type SchedulingQueue interface { framework.PodNominator Add(pod *v1.Pod) error // Activate moves the given pods to activeQ iff they're in unschedulablePods or backoffQ. // The passed-in pods are originally compiled from plugins that want to activate Pods, // by injecting the pods through a reserved CycleState struct (PodsToActivate). Activate(pods map[string]*v1.Pod) // AddUnschedulableIfNotPresent adds an unschedulable pod back to scheduling queue. // The podSchedulingCycle represents the current scheduling cycle number which can be // returned by calling SchedulingCycle(). AddUnschedulableIfNotPresent(pod *framework.QueuedPodInfo, podSchedulingCycle int64) error // SchedulingCycle returns the current number of scheduling cycle which is // cached by scheduling queue. Normally, incrementing this number whenever // a pod is popped (e.g. called Pop()) is enough. SchedulingCycle() int64 // Pop removes the head of the queue and returns it. It blocks if the // queue is empty and waits until a new item is added to the queue. Pop() (*framework.QueuedPodInfo, error) Update(oldPod, newPod *v1.Pod) error Delete(pod *v1.Pod) error MoveAllToActiveOrBackoffQueue(event framework.ClusterEvent, preCheck PreEnqueueCheck) AssignedPodAdded(pod *v1.Pod) AssignedPodUpdated(pod *v1.Pod) PendingPods() []*v1.Pod // Close closes the SchedulingQueue so that the goroutine which is // waiting to pop items can exit gracefully. Close() // Run starts the goroutines managing the queue. Run() } åœ¨New scheduler æ—¶å¯ä»¥çœ‹åˆ°ä¼šåˆå§‹åŒ–è¿™ä¸ªqueue\ngo 1 2 3 4 5 6 7 8 9 10 podQueue := internalqueue.NewSchedulingQueue( // å®ç°podå¯¹æ¯”çš„ä¸€ä¸ªå‡½æ•°å³less profiles[options.profiles[0].SchedulerName].QueueSortFunc(), informerFactory, internalqueue.WithPodInitialBackoffDuration(time.Duration(options.podInitialBackoffSeconds)*time.Second), internalqueue.WithPodMaxBackoffDuration(time.Duration(options.podMaxBackoffSeconds)*time.Second), internalqueue.WithPodNominator(nominator), internalqueue.WithClusterEventMap(clusterEventMap), internalqueue.WithPodMaxInUnschedulablePodsDuration(options.podMaxInUnschedulablePodsDuration), ) è€Œ NewSchedulingQueue åˆ™æ˜¯åˆå§‹åŒ–è¿™ä¸ª PriorityQueue\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 // NewSchedulingQueue initializes a priority queue as a new scheduling queue. func NewSchedulingQueue( lessFn framework.LessFunc, informerFactory informers.SharedInformerFactory, opts ...Option) SchedulingQueue { return NewPriorityQueue(lessFn, informerFactory, opts...) } // NewPriorityQueue creates a PriorityQueue object. func NewPriorityQueue( lessFn framework.LessFunc, informerFactory informers.SharedInformerFactory, opts ...Option, ) *PriorityQueue { options := defaultPriorityQueueOptions for _, opt := range opts { opt(\u0026options) } // è¿™ä¸ªå°±æ˜¯ lesså‡½æ•°ï¼Œä½œä¸ºæ‰“åˆ†çš„ä¸€éƒ¨åˆ† comp := func(podInfo1, podInfo2 interface{}) bool { pInfo1 := podInfo1.(*framework.QueuedPodInfo) pInfo2 := podInfo2.(*framework.QueuedPodInfo) return lessFn(pInfo1, pInfo2) } if options.podNominator == nil { options.podNominator = NewPodNominator(informerFactory.Core().V1().Pods().Lister()) } pq := \u0026PriorityQueue{ PodNominator: options.podNominator, clock: options.clock, stop: make(chan struct{}), podInitialBackoffDuration: options.podInitialBackoffDuration, podMaxBackoffDuration: options.podMaxBackoffDuration, podMaxInUnschedulablePodsDuration: options.podMaxInUnschedulablePodsDuration, activeQ: heap.NewWithRecorder(podInfoKeyFunc, comp, metrics.NewActivePodsRecorder()), unschedulablePods: newUnschedulablePods(metrics.NewUnschedulablePodsRecorder()), moveRequestCycle: -1, clusterEventMap: options.clusterEventMap, } pq.cond.L = \u0026pq.lock pq.podBackoffQ = heap.NewWithRecorder(podInfoKeyFunc, pq.podsCompareBackoffCompleted, metrics.NewBackoffPodsRecorder()) pq.nsLister = informerFactory.Core().V1().Namespaces().Lister() return pq } äº†è§£äº†Queueçš„ç»“æ„ï¼Œå°±éœ€è¦çŸ¥é“ å…¥é˜Ÿåˆ—ä¸å‡ºé˜Ÿåˆ—æ˜¯åœ¨å“ªé‡Œæ“ä½œçš„ã€‚åœ¨åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦æ³¨å†Œä¸€ä¸ª addEventHandlerFuncs è¿™ä¸ªæ—¶å€™ï¼Œä¼šæ³¨å…¥ä¸‰ä¸ªåŠ¨ä½œå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯controllerä¸­çš„æ¦‚å¿µï¼›è€Œåœ¨AddFuncä¸­å¯ä»¥çœ‹åˆ°ä¼šå…¥é˜Ÿåˆ—ã€‚\næ³¨å…¥æ˜¯å¯¹ Pod çš„informeræ³¨å…¥çš„ï¼Œæ³¨å…¥çš„å‡½æ•° addPodToSchedulingQueue å°±æ˜¯å…¥æ ˆ\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 Handler: cache.ResourceEventHandlerFuncs{ AddFunc: sched.addPodToSchedulingQueue, UpdateFunc: sched.updatePodInSchedulingQueue, DeleteFunc: sched.deletePodFromSchedulingQueue, }, func (sched *Scheduler) addPodToSchedulingQueue(obj interface{}) { pod := obj.(*v1.Pod) klog.V(3).InfoS(\"Add event for unscheduled pod\", \"pod\", klog.KObj(pod)) if err := sched.SchedulingQueue.Add(pod); err != nil { utilruntime.HandleError(fmt.Errorf(\"unable to queue %T: %v\", obj, err)) } } è€Œè¿™ä¸ª SchedulingQueue çš„å®ç°å°±æ˜¯ PriorityQueue ï¼Œè€ŒAddä¸­åˆ™å¯¹ activeQè¿›è¡Œçš„æ“ä½œ\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func (p *PriorityQueue) Add(pod *v1.Pod) error { p.lock.Lock() defer p.lock.Unlock() // æ ¼å¼åŒ–å…¥æ ˆæ•°æ®ï¼ŒåŒ…å«podinfoï¼Œé‡Œä¼šåŒ…å«v1.Pod // åˆå§‹åŒ–çš„æ—¶é—´ï¼Œåˆ›å»ºçš„æ—¶é—´ï¼Œä»¥åŠä¸èƒ½è¢«è°ƒåº¦æ—¶çš„è®°å½•å…¶pluginçš„åç§° pInfo := p.newQueuedPodInfo(pod) // å…¥æ ˆ if err := p.activeQ.Add(pInfo); err != nil { klog.ErrorS(err, \"Error adding pod to the active queue\", \"pod\", klog.KObj(pod)) return err } if p.unschedulablePods.get(pod) != nil { klog.ErrorS(nil, \"Error: pod is already in the unschedulable queue\", \"pod\", klog.KObj(pod)) p.unschedulablePods.delete(pod) } // Delete pod from backoffQ if it is backing off if err := p.podBackoffQ.Delete(pInfo); err == nil { klog.ErrorS(nil, \"Error: pod is already in the podBackoff queue\", \"pod\", klog.KObj(pod)) } metrics.SchedulerQueueIncomingPods.WithLabelValues(\"active\", PodAdd).Inc() p.PodNominator.AddNominatedPod(pInfo.PodInfo, nil) p.cond.Broadcast() return nil } åœ¨ä¸Šé¢çœ‹ scheduler ç»“æ„æ—¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª nextPodçš„ï¼ŒnextPodå°±æ˜¯ä»é˜Ÿåˆ—ä¸­å¼¹å‡ºä¸€ä¸ªpodï¼Œè¿™ä¸ªåœ¨scheduler æ—¶ä¼šä¼ å…¥ MakeNextPodFunc å°±æ˜¯è¿™ä¸ª nextpod\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func MakeNextPodFunc(queue SchedulingQueue) func() *framework.QueuedPodInfo { return func() *framework.QueuedPodInfo { podInfo, err := queue.Pop() if err == nil { klog.V(4).InfoS(\"About to try and schedule pod\", \"pod\", klog.KObj(podInfo.Pod)) for plugin := range podInfo.UnschedulablePlugins { metrics.UnschedulableReason(plugin, podInfo.Pod.Spec.SchedulerName).Dec() } return podInfo } klog.ErrorS(err, \"Error while retrieving next pod from scheduling queue\") return nil } } è€Œè¿™ä¸ª queue.Pop() å¯¹åº”çš„å°±æ˜¯ PriorityQueue çš„ Pop() ï¼Œåœ¨è¿™é‡Œä¼šå°†ä½œä¸º activeQ çš„æ¶ˆè´¹ç«¯\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (p *PriorityQueue) Pop() (*framework.QueuedPodInfo, error) { p.lock.Lock() defer p.lock.Unlock() for p.activeQ.Len() == 0 { // When the queue is empty, invocation of Pop() is blocked until new item is enqueued. // When Close() is called, the p.closed is set and the condition is broadcast, // which causes this loop to continue and return from the Pop(). if p.closed { return nil, fmt.Errorf(queueClosed) } p.cond.Wait() } obj, err := p.activeQ.Pop() if err != nil { return nil, err } pInfo := obj.(*framework.QueuedPodInfo) pInfo.Attempts++ p.schedulingCycle++ return pInfo, nil } åœ¨ä¸Šé¢å…¥å£éƒ¨åˆ†ä¹Ÿçœ‹åˆ°äº†ï¼ŒscheduleOne å’Œ schedulerï¼ŒscheduleOne å°±æ˜¯å»æ¶ˆè´¹ä¸€ä¸ªPodï¼Œä»–ä¼šè°ƒç”¨ NextPodï¼ŒNextPodå°±æ˜¯åœ¨åˆå§‹åŒ–ä¼ å…¥çš„ MakeNextPodFunc ï¼Œè‡³æ­¤å›åˆ°å¯¹åº”çš„ Popæ¥åšæ¶ˆè´¹ã€‚\nschedulerOneæ˜¯ä¸ºä¸€ä¸ªPodåšè°ƒåº¦çš„æµç¨‹ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (sched *Scheduler) scheduleOne(ctx context.Context) { podInfo := sched.NextPod() // pod could be nil when schedulerQueue is closed if podInfo == nil || podInfo.Pod == nil { return } pod := podInfo.Pod fwk, err := sched.frameworkForPod(pod) if err != nil { // This shouldn't happen, because we only accept for scheduling the pods // which specify a scheduler name that matches one of the profiles. klog.ErrorS(err, \"Error occurred\") return } if sched.skipPodSchedule(fwk, pod) { return } ... è°ƒåº¦ä¸Šä¸‹æ–‡ å½“äº†è§£äº†schedulerç»“æ„åï¼Œä¸‹é¢åˆ†æä¸‹è°ƒåº¦ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹ã€‚çœ‹çœ‹æ‰©å±•ç‚¹æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™ä¸ªæ—¶å€™åˆéœ€è¦æåˆ°å®˜ç½‘çš„è°ƒåº¦ä¸Šä¸‹æ–‡çš„å›¾ã€‚\nå›¾1ï¼šPodçš„è°ƒåº¦ä¸Šä¸‹æ–‡ Sourceï¼šhttps://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework è€Œ scheduler å¯¹äºè°ƒåº¦ä¸Šä¸‹æ–‡æ¥å°±æ˜¯è¿™ä¸ª scheduleOne ï¼Œä¸‹é¢å°±æ˜¯çœ‹è¿™ä¸ªè°ƒåº¦ä¸Šä¸‹æ–‡\nSort Sort æ’ä»¶æä¾›äº†æ’åºåŠŸèƒ½ï¼Œç”¨äºå¯¹åœ¨è°ƒåº¦é˜Ÿåˆ—ä¸­å¾…å¤„ç† Pod è¿›è¡Œæ’åºã€‚ä¸€æ¬¡åªèƒ½å¯ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ’åºã€‚\nåœ¨è¿›å…¥ scheduleOne åï¼ŒNextPod ä» activeQ ä¸­é˜Ÿåˆ—ä¸­å¾—åˆ°ä¸€ä¸ªPodï¼Œç„¶åçš„ frameworkForPod ä¼šåšæ‰“åˆ†çš„åŠ¨ä½œå°±æ˜¯è°ƒåº¦ä¸Šä¸‹æ–‡çš„ç¬¬ä¸€ä¸ªæ‰©å±•ç‚¹ sort\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func (sched *Scheduler) scheduleOne(ctx context.Context) { podInfo := sched.NextPod() // pod could be nil when schedulerQueue is closed if podInfo == nil || podInfo.Pod == nil { return } pod := podInfo.Pod fwk, err := sched.frameworkForPod(pod) ... func (sched *Scheduler) frameworkForPod(pod *v1.Pod) (framework.Framework, error) { // è·å–æŒ‡å®šçš„profile fwk, ok := sched.Profiles[pod.Spec.SchedulerName] if !ok { return nil, fmt.Errorf(\"profile not found for scheduler name %q\", pod.Spec.SchedulerName) } return fwk, nil } å›é¡¾ï¼Œå› ä¸ºåœ¨New scheduleræ—¶ä¼šåˆå§‹åŒ–è¿™ä¸ª sort å‡½æ•°\ngo 1 2 3 4 5 6 7 8 9 podQueue := internalqueue.NewSchedulingQueue( profiles[options.profiles[0].SchedulerName].QueueSortFunc(), informerFactory, internalqueue.WithPodInitialBackoffDuration(time.Duration(options.podInitialBackoffSeconds)*time.Second), internalqueue.WithPodMaxBackoffDuration(time.Duration(options.podMaxBackoffSeconds)*time.Second), internalqueue.WithPodNominator(nominator), internalqueue.WithClusterEventMap(clusterEventMap), internalqueue.WithPodMaxInUnschedulablePodsDuration(options.podMaxInUnschedulablePodsDuration), ) preFilter preFilterä½œä¸ºç¬¬ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œæ˜¯ç”¨äºåœ¨è¿‡æ»¤ä¹‹å‰é¢„å¤„ç†æˆ–æ£€æŸ¥ Pod æˆ–é›†ç¾¤çš„ç›¸å…³ä¿¡æ¯ã€‚è¿™é‡Œä¼šç»ˆæ­¢è°ƒåº¦\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 func (sched *Scheduler) scheduleOne(ctx context.Context) { podInfo := sched.NextPod() // pod could be nil when schedulerQueue is closed if podInfo == nil || podInfo.Pod == nil { return } pod := podInfo.Pod fwk, err := sched.frameworkForPod(pod) if err != nil { // This shouldn't happen, because we only accept for scheduling the pods // which specify a scheduler name that matches one of the profiles. klog.ErrorS(err, \"Error occurred\") return } if sched.skipPodSchedule(fwk, pod) { return } klog.V(3).InfoS(\"Attempting to schedule pod\", \"pod\", klog.KObj(pod)) // Synchronously attempt to find a fit for the pod. start := time.Now() state := framework.NewCycleState() state.SetRecordPluginMetrics(rand.Intn(100) \u003c pluginMetricsSamplePercent) // Initialize an empty podsToActivate struct, which will be filled up by plugins or stay empty. podsToActivate := framework.NewPodsToActivate() state.Write(framework.PodsToActivateKey, podsToActivate) schedulingCycleCtx, cancel := context.WithCancel(ctx) defer cancel() // è¿™é‡Œå°†è¿›å…¥prefilter scheduleResult, err := sched.SchedulePod(schedulingCycleCtx, fwk, state, pod) schedulePod å°è¯•å°†ç»™å®šçš„ pod è°ƒåº¦åˆ°èŠ‚ç‚¹åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹ä¹‹ä¸€ã€‚å¦‚æœæˆåŠŸï¼Œå®ƒå°†è¿”å›èŠ‚ç‚¹çš„åç§°ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (sched *Scheduler) schedulePod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (result ScheduleResult, err error) { trace := utiltrace.New(\"Scheduling\", utiltrace.Field{Key: \"namespace\", Value: pod.Namespace}, utiltrace.Field{Key: \"name\", Value: pod.Name}) defer trace.LogIfLong(100 * time.Millisecond) // ç”¨äºå°†cacheæ›´æ–°ä¸ºå½“å‰å†…å®¹ if err := sched.Cache.UpdateSnapshot(sched.nodeInfoSnapshot); err != nil { return result, err } trace.Step(\"Snapshotting scheduler cache and node infos done\") if sched.nodeInfoSnapshot.NumNodes() == 0 { return result, ErrNoNodesAvailable } // æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„podæ—¶ï¼Œä¼šæ‰§è¡Œæ‰©å±•ç‚¹ feasibleNodes, diagnosis, err := sched.findNodesThatFitPod(ctx, fwk, state, pod) ... findNodesThatFitPod ä¼šæ‰§è¡Œå¯¹åº”çš„è¿‡æ»¤æ’ä»¶æ¥æ‰¾åˆ°æœ€é€‚åˆçš„Nodeï¼ŒåŒ…æ‹¬å¤‡æ³¨ï¼Œä»¥åŠæ–¹æ³•åéƒ½å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè¿è¡Œçš„æ’ä»¶ğŸ˜ğŸ˜ï¼Œåé¢ä¼šåˆ†æç®—æ³•å†…å®¹ï¼Œåªå¯¹workflowå­¦ä¹ ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 func (sched *Scheduler) findNodesThatFitPod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) ([]*v1.Node, framework.Diagnosis, error) { diagnosis := framework.Diagnosis{ NodeToStatusMap: make(framework.NodeToStatusMap), UnschedulablePlugins: sets.NewString(), } // Run \"prefilter\" plugins. preRes, s := fwk.RunPreFilterPlugins(ctx, state, pod) allNodes, err := sched.nodeInfoSnapshot.NodeInfos().List() if err != nil { return nil, diagnosis, err } if !s.IsSuccess() { if !s.IsUnschedulable() { return nil, diagnosis, s.AsError() } // All nodes will have the same status. Some non trivial refactoring is // needed to avoid this copy. for _, n := range allNodes { diagnosis.NodeToStatusMap[n.Node().Name] = s } // Status satisfying IsUnschedulable() gets injected into diagnosis.UnschedulablePlugins. if s.FailedPlugin() != \"\" { diagnosis.UnschedulablePlugins.Insert(s.FailedPlugin()) } return nil, diagnosis, nil } // \"NominatedNodeName\" can potentially be set in a previous scheduling cycle as a result of preemption. // This node is likely the only candidate that will fit the pod, and hence we try it first before iterating over all nodes. if len(pod.Status.NominatedNodeName) \u003e 0 { feasibleNodes, err := sched.evaluateNominatedNode(ctx, pod, fwk, state, diagnosis) if err != nil { klog.ErrorS(err, \"Evaluation failed on nominated node\", \"pod\", klog.KObj(pod), \"node\", pod.Status.NominatedNodeName) } // Nominated node passes all the filters, scheduler is good to assign this node to the pod. if len(feasibleNodes) != 0 { return feasibleNodes, diagnosis, nil } } nodes := allNodes if !preRes.AllNodes() { nodes = make([]*framework.NodeInfo, 0, len(preRes.NodeNames)) for n := range preRes.NodeNames { nInfo, err := sched.nodeInfoSnapshot.NodeInfos().Get(n) if err != nil { return nil, diagnosis, err } nodes = append(nodes, nInfo) } } feasibleNodes, err := sched.findNodesThatPassFilters(ctx, fwk, state, pod, diagnosis, nodes) if err != nil { return nil, diagnosis, err } feasibleNodes, err = findNodesThatPassExtenders(sched.Extenders, pod, feasibleNodes, diagnosis.NodeToStatusMap) if err != nil { return nil, diagnosis, err } return feasibleNodes, diagnosis, nil } filter filteræ’ä»¶ç›¸å½“äºè°ƒåº¦ä¸Šä¸‹æ–‡ä¸­çš„ Predicatesï¼Œç”¨äºæ’é™¤ä¸èƒ½è¿è¡Œ Pod çš„èŠ‚ç‚¹ã€‚Filter ä¼šæŒ‰é…ç½®çš„é¡ºåºè¿›è¡Œè°ƒç”¨ã€‚å¦‚æœæœ‰ä¸€ä¸ªfilterå°†èŠ‚ç‚¹æ ‡è®°ä½ä¸å¯ç”¨ï¼Œåˆ™å°† Pod æ ‡è®°ä¸ºä¸å¯è°ƒåº¦ï¼ˆå³ä¸ä¼šå‘ä¸‹æ‰§è¡Œï¼‰ã€‚\nå¯¹äºä»£ç ä¸­æ¥è®²ï¼Œfilterè¿˜æ˜¯å¤„äº findNodesThatFitPod å‡½æ•°ä¸­ï¼ŒfindNodesThatPassFilters å°±æ˜¯è·å–åˆ° FNï¼Œå³å¯è¡ŒèŠ‚ç‚¹ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ filter æ‰©å±•ç‚¹\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (sched *Scheduler) findNodesThatFitPod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) ([]*v1.Node, framework.Diagnosis, error) { ... feasibleNodes, err := sched.findNodesThatPassFilters(ctx, fwk, state, pod, diagnosis, nodes) if err != nil { return nil, diagnosis, err } feasibleNodes, err = findNodesThatPassExtenders(sched.Extenders, pod, feasibleNodes, diagnosis.NodeToStatusMap) if err != nil { return nil, diagnosis, err } return feasibleNodes, diagnosis, nil } Postfilter å½“æ²¡æœ‰ä¸º pod æ‰¾åˆ°FNæ—¶ï¼Œè¯¥æ’ä»¶ä¼šæŒ‰ç…§é…ç½®çš„é¡ºåºè¿›è¡Œè°ƒç”¨ã€‚å¦‚æœä»»ä½•postFilteræ’ä»¶å°† Pod æ ‡è®°ä¸ºschedulableï¼Œåˆ™ä¸ä¼šè°ƒç”¨å…¶ä½™æ’ä»¶ã€‚å³ filter æˆåŠŸåä¸ä¼šè¿›è¡Œè¿™æ­¥éª¤ï¼Œé‚£æˆ‘ä»¬æ¥éªŒè¯ä¸‹è¿™é‡ŒæŠŠğŸ˜Š\nè¿˜æ˜¯åœ¨ scheduleOne ä¸­ï¼Œå½“æˆ‘ä»¬è¿è¡Œçš„ SchedulePod å®Œæˆåï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œè¿™æ—¶ä¼šè¿”å›ä¸€ä¸ªerrï¼Œè€Œ postfilter ä¼šæ ¹æ®è¿™ä¸ª errè¿›è¡Œé€‰æ‹©æ‰§è¡Œæˆ–ä¸æ‰§è¡Œï¼Œç¬¦åˆå®˜æ–¹ç»™å‡ºçš„è¯´æ³•ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 scheduleResult, err := sched.SchedulePod(schedulingCycleCtx, fwk, state, pod) if err != nil { // SchedulePod() may have failed because the pod would not fit on any host, so we try to // preempt, with the expectation that the next time the pod is tried for scheduling it // will fit due to the preemption. It is also possible that a different pod will schedule // into the resources that were preempted, but this is harmless. var nominatingInfo *framework.NominatingInfo if fitError, ok := err.(*framework.FitError); ok { if !fwk.HasPostFilterPlugins() { klog.V(3).InfoS(\"No PostFilter plugins are registered, so no preemption will be performed\") } else { // Run PostFilter plugins to try to make the pod schedulable in a future scheduling cycle. result, status := fwk.RunPostFilterPlugins(ctx, state, pod, fitError.Diagnosis.NodeToStatusMap) if status.Code() == framework.Error { klog.ErrorS(nil, \"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } else { fitError.Diagnosis.PostFilterMsg = status.Message() klog.V(5).InfoS(\"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } if result != nil { nominatingInfo = result.NominatingInfo } } // Pod did not fit anywhere, so it is counted as a failure. If preemption // succeeds, the pod should get counted as a success the next time we try to // schedule it. (hopefully) metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else if err == ErrNoNodesAvailable { nominatingInfo = clearNominatedNode // No nodes available is counted as unschedulable rather than an error. metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else { nominatingInfo = clearNominatedNode klog.ErrorS(err, \"Error selecting node for pod\", \"pod\", klog.KObj(pod)) metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) } sched.handleSchedulingFailure(ctx, fwk, podInfo, err, v1.PodReasonUnschedulable, nominatingInfo) return } PreScore,Score å¯ç”¨äºè¿›è¡Œé¢„Scoreå·¥ä½œï¼Œä½œä¸ºé€šçŸ¥æ€§çš„æ‰©å±•ç‚¹ï¼Œä¼šåœ¨åœ¨filterå®Œä¹‹åç›´æ¥ä¼šå…³è” preScore æ’ä»¶è¿›è¡Œç»§ç»­å·¥ä½œï¼Œè€Œä¸æ˜¯è¿”å›ï¼Œå¦‚æœé…ç½®çš„è¿™äº›æ’ä»¶æœ‰ä»»ä½•ä¸€ä¸ªè¿”å›å¤±è´¥ï¼Œåˆ™Podå°†è¢«æ‹’ç»ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 func (sched *Scheduler) schedulePod(ctx context.Context, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod) (result ScheduleResult, err error) { trace := utiltrace.New(\"Scheduling\", utiltrace.Field{Key: \"namespace\", Value: pod.Namespace}, utiltrace.Field{Key: \"name\", Value: pod.Name}) defer trace.LogIfLong(100 * time.Millisecond) if err := sched.Cache.UpdateSnapshot(sched.nodeInfoSnapshot); err != nil { return result, err } trace.Step(\"Snapshotting scheduler cache and node infos done\") if sched.nodeInfoSnapshot.NumNodes() == 0 { return result, ErrNoNodesAvailable } feasibleNodes, diagnosis, err := sched.findNodesThatFitPod(ctx, fwk, state, pod) if err != nil { return result, err } trace.Step(\"Computing predicates done\") if len(feasibleNodes) == 0 { return result, \u0026framework.FitError{ Pod: pod, NumAllNodes: sched.nodeInfoSnapshot.NumNodes(), Diagnosis: diagnosis, } } // When only one node after predicate, just use it. if len(feasibleNodes) == 1 { return ScheduleResult{ SuggestedHost: feasibleNodes[0].Name, EvaluatedNodes: 1 + len(diagnosis.NodeToStatusMap), FeasibleNodes: 1, }, nil } // è¿™é‡Œä¼šå®Œæˆprescoreï¼Œscore priorityList, err := prioritizeNodes(ctx, sched.Extenders, fwk, state, pod, feasibleNodes) if err != nil { return result, err } host, err := selectHost(priorityList) trace.Step(\"Prioritizing done\") return ScheduleResult{ SuggestedHost: host, EvaluatedNodes: len(feasibleNodes) + len(diagnosis.NodeToStatusMap), FeasibleNodes: len(feasibleNodes), }, err } priorityNodes ä¼šé€šè¿‡é…ç½®çš„æ’ä»¶ç»™Nodeæ‰“åˆ†ï¼Œå¹¶è¿”å›æ¯ä¸ªNodeçš„åˆ†æ•°ï¼Œå°†æ¯ä¸ªæ’ä»¶æ‰“åˆ†ç»“æœè®¡ç®—æ€»å’Œè·å¾—Nodeçš„åˆ†æ•°ï¼Œæœ€åè·å¾—èŠ‚ç‚¹çš„åŠ æƒæ€»åˆ†æ•°ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 func prioritizeNodes( ctx context.Context, extenders []framework.Extender, fwk framework.Framework, state *framework.CycleState, pod *v1.Pod, nodes []*v1.Node, ) (framework.NodeScoreList, error) { // If no priority configs are provided, then all nodes will have a score of one. // This is required to generate the priority list in the required format if len(extenders) == 0 \u0026\u0026 !fwk.HasScorePlugins() { result := make(framework.NodeScoreList, 0, len(nodes)) for i := range nodes { result = append(result, framework.NodeScore{ Name: nodes[i].Name, Score: 1, }) } return result, nil } // Run PreScore plugins. preScoreStatus := fwk.RunPreScorePlugins(ctx, state, pod, nodes) if !preScoreStatus.IsSuccess() { return nil, preScoreStatus.AsError() } // Run the Score plugins. scoresMap, scoreStatus := fwk.RunScorePlugins(ctx, state, pod, nodes) if !scoreStatus.IsSuccess() { return nil, scoreStatus.AsError() } // Additional details logged at level 10 if enabled. klogV := klog.V(10) if klogV.Enabled() { for plugin, nodeScoreList := range scoresMap { for _, nodeScore := range nodeScoreList { klogV.InfoS(\"Plugin scored node for pod\", \"pod\", klog.KObj(pod), \"plugin\", plugin, \"node\", nodeScore.Name, \"score\", nodeScore.Score) } } } // Summarize all scores. result := make(framework.NodeScoreList, 0, len(nodes)) for i := range nodes { result = append(result, framework.NodeScore{Name: nodes[i].Name, Score: 0}) for j := range scoresMap { result[i].Score += scoresMap[j][i].Score } } if len(extenders) != 0 \u0026\u0026 nodes != nil { var mu sync.Mutex var wg sync.WaitGroup combinedScores := make(map[string]int64, len(nodes)) for i := range extenders { if !extenders[i].IsInterested(pod) { continue } wg.Add(1) go func(extIndex int) { metrics.SchedulerGoroutines.WithLabelValues(metrics.PrioritizingExtender).Inc() defer func() { metrics.SchedulerGoroutines.WithLabelValues(metrics.PrioritizingExtender).Dec() wg.Done() }() prioritizedList, weight, err := extenders[extIndex].Prioritize(pod, nodes) if err != nil { // Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities klog.V(5).InfoS(\"Failed to run extender's priority function. No score given by this extender.\", \"error\", err, \"pod\", klog.KObj(pod), \"extender\", extenders[extIndex].Name()) return } mu.Lock() for i := range *prioritizedList { host, score := (*prioritizedList)[i].Host, (*prioritizedList)[i].Score if klogV.Enabled() { klogV.InfoS(\"Extender scored node for pod\", \"pod\", klog.KObj(pod), \"extender\", extenders[extIndex].Name(), \"node\", host, \"score\", score) } combinedScores[host] += score * weight } mu.Unlock() }(i) } // wait for all go routines to finish wg.Wait() for i := range result { // MaxExtenderPriority may diverge from the max priority used in the scheduler and defined by MaxNodeScore, // therefore we need to scale the score returned by extenders to the score range used by the scheduler. result[i].Score += combinedScores[result[i].Name] * (framework.MaxNodeScore / extenderv1.MaxExtenderPriority) } } if klogV.Enabled() { for i := range result { klogV.InfoS(\"Calculated node's final score for pod\", \"pod\", klog.KObj(pod), \"node\", result[i].Name, \"score\", result[i].Score) } } return result, nil } Reserve Reserve å› ä¸ºç»‘å®šäº‹ä»¶æ—¶å¼‚æ­¥å‘ç”Ÿçš„ï¼Œè¯¥æ’ä»¶æ˜¯ä¸ºäº†é¿å…Podåœ¨ç»‘å®šåˆ°èŠ‚ç‚¹å‰æ—¶ï¼Œè°ƒåº¦åˆ°æ–°çš„Podï¼Œä½¿èŠ‚ç‚¹ä½¿ç”¨èµ„æºè¶…è¿‡å¯ç”¨èµ„æºæƒ…å†µã€‚å¦‚æœåç»­é˜¶æ®µå‘ç”Ÿé”™è¯¯æˆ–å¤±è´¥ï¼Œå°†è§¦å‘ UnReserve å›æ»šï¼ˆé€šçŸ¥æ€§æ‰©å±•ç‚¹ï¼‰ã€‚è¿™ä¹Ÿæ˜¯ä½œä¸ºè°ƒåº¦å‘¨æœŸä¸­æœ€åä¸€ä¸ªçŠ¶æ€ï¼Œè¦ä¹ˆæˆåŠŸåˆ° postBind ï¼Œè¦ä¹ˆå¤±è´¥è§¦å‘ UnReserveã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 // Run the Reserve method of reserve plugins. if sts := fwk.RunReservePluginsReserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost); !sts.IsSuccess() { // å½“å¤„ç†ä¸æˆåŠŸæ—¶ metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) // è§¦å‘ un-reserve æ¥æ¸…ç†ç›¸å…³Podçš„çŠ¶æ€ fwk.RunReservePluginsUnreserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"Scheduler cache ForgetPod failed\") } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, sts.AsError(), SchedulerError, clearNominatedNode) return } permit Permit æ’ä»¶å¯ä»¥é˜»æ­¢æˆ–å»¶è¿Ÿ Pod çš„ç»‘å®š\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // Run \"permit\" plugins. runPermitStatus := fwk.RunPermitPlugins(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if !runPermitStatus.IsWait() \u0026\u0026 !runPermitStatus.IsSuccess() { var reason string if runPermitStatus.IsUnschedulable() { metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = v1.PodReasonUnschedulable } else { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = SchedulerError } // åªè¦å…¶ä¸­ä¸€ä¸ªæ’ä»¶è¿”å›çš„çŠ¶æ€ä¸æ˜¯ success æˆ–è€… wait fwk.RunReservePluginsUnreserve(schedulingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) // ä»cacheä¸­å¿˜æ‰pod if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"Scheduler cache ForgetPod failed\") } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, runPermitStatus.AsError(), reason, clearNominatedNode) return } Binding Cycle åœ¨é€‰æ‹©å¥½ FN ååˆ™åšä¸€ä¸ªå‡è®¾ç»‘å®šï¼Œå¹¶æ›´æ–°åˆ°cacheä¸­ï¼Œæ¥ä¸‹æ¥å›å»æ‰§è¡ŒçœŸæ­£çš„bindæ“ä½œï¼Œä¹Ÿå°±æ˜¯ binding cycle\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 func (sched *Scheduler) scheduleOne(ctx context.Context) { ... ... // binding cycle æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œï¼Œè¿™é‡Œè¡¨ç°å°±æ˜¯goåç¨‹ go func() { bindingCycleCtx, cancel := context.WithCancel(ctx) defer cancel() metrics.SchedulerGoroutines.WithLabelValues(metrics.Binding).Inc() defer metrics.SchedulerGoroutines.WithLabelValues(metrics.Binding).Dec() // è¿è¡ŒWaitOnPermitæ’ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™ï¼ŒunReserveå›æ»š waitOnPermitStatus := fwk.WaitOnPermit(bindingCycleCtx, assumedPod) if !waitOnPermitStatus.IsSuccess() { var reason string if waitOnPermitStatus.IsUnschedulable() { metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = v1.PodReasonUnschedulable } else { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) reason = SchedulerError } // trigger un-reserve plugins to clean up state associated with the reserved Pod fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"scheduler cache ForgetPod failed\") } else { // \"Forget\"ing an assumed Pod in binding cycle should be treated as a PodDelete event, // as the assumed Pod had occupied a certain amount of resources in scheduler cache. // TODO(#103853): de-duplicate the logic. // Avoid moving the assumed Pod itself as it's always Unschedulable. // It's intentional to \"defer\" this operation; otherwise MoveAllToActiveOrBackoffQueue() would // update `q.moveRequest` and thus move the assumed pod to backoffQ anyways. defer sched.SchedulingQueue.MoveAllToActiveOrBackoffQueue(internalqueue.AssignedPodDelete, func(pod *v1.Pod) bool { return assumedPod.UID != pod.UID }) } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, waitOnPermitStatus.AsError(), reason, clearNominatedNode) return } // è¿è¡ŒPrebind æ’ä»¶ preBindStatus := fwk.RunPreBindPlugins(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if !preBindStatus.IsSuccess() { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) // trigger un-reserve plugins to clean up state associated with the reserved Pod fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if forgetErr := sched.Cache.ForgetPod(assumedPod); forgetErr != nil { klog.ErrorS(forgetErr, \"scheduler cache ForgetPod failed\") } else { // \"Forget\"ing an assumed Pod in binding cycle should be treated as a PodDelete event, // as the assumed Pod had occupied a certain amount of resources in scheduler cache. // TODO(#103853): de-duplicate the logic. sched.SchedulingQueue.MoveAllToActiveOrBackoffQueue(internalqueue.AssignedPodDelete, nil) } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, preBindStatus.AsError(), SchedulerError, clearNominatedNode) return } // bindæ˜¯çœŸæ­£çš„ç»‘å®šæ“ä½œ err := sched.bind(bindingCycleCtx, fwk, assumedPod, scheduleResult.SuggestedHost, state) if err != nil { metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) // å¦‚æœå¤±è´¥äº†å°±è§¦å‘ un-reserve plugins fwk.RunReservePluginsUnreserve(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) if err := sched.Cache.ForgetPod(assumedPod); err != nil { klog.ErrorS(err, \"scheduler cache ForgetPod failed\") } else { // \"Forget\"ing an assumed Pod in binding cycle should be treated as a PodDelete event, // as the assumed Pod had occupied a certain amount of resources in scheduler cache. // TODO(#103853): de-duplicate the logic. sched.SchedulingQueue.MoveAllToActiveOrBackoffQueue(internalqueue.AssignedPodDelete, nil) } sched.handleSchedulingFailure(ctx, fwk, assumedPodInfo, fmt.Errorf(\"binding rejected: %w\", err), SchedulerError, clearNominatedNode) return } // Calculating nodeResourceString can be heavy. Avoid it if klog verbosity is below 2. klog.V(2).InfoS(\"Successfully bound pod to node\", \"pod\", klog.KObj(pod), \"node\", scheduleResult.SuggestedHost, \"evaluatedNodes\", scheduleResult.EvaluatedNodes, \"feasibleNodes\", scheduleResult.FeasibleNodes) metrics.PodScheduled(fwk.ProfileName(), metrics.SinceInSeconds(start)) metrics.PodSchedulingAttempts.Observe(float64(podInfo.Attempts)) metrics.PodSchedulingDuration.WithLabelValues(getAttemptsLabel(podInfo)).Observe(metrics.SinceInSeconds(podInfo.InitialAttemptTimestamp)) // è¿è¡Œ \"postbind\" æ’ä»¶ // æ˜¯é€šçŸ¥æ€§çš„æ‰©å±•ç‚¹ï¼Œè¯¥æ’ä»¶åœ¨ç»‘å®š Pod åè°ƒç”¨ï¼Œå¯ç”¨äºæ¸…ç†ç›¸å…³èµ„æºï¼ˆï¼‰ã€‚ fwk.RunPostBindPlugins(bindingCycleCtx, state, assumedPod, scheduleResult.SuggestedHost) // At the end of a successful binding cycle, move up Pods if needed. if len(podsToActivate.Map) != 0 { sched.SchedulingQueue.Activate(podsToActivate.Map) // Unlike the logic in scheduling cycle, we don't bother deleting the entries // as `podsToActivate.Map` is no longer consumed. } }() } è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­çš„å¤±è´¥æµç¨‹ ä¸Šé¢è¯´åˆ°çš„éƒ½æ˜¯æ­£å¸¸çš„è¯·æ±‚ï¼Œä¸‹é¢ä¼šå¯¹å¤±è´¥çš„è¯·æ±‚æ˜¯å¦‚ä½•é‡è¯•çš„è¿›è¡Œåˆ†æï¼Œè€Œ scheduler ä¸­å…³äºå¤±è´¥å¤„ç†æ–¹é¢ç›¸å…³çš„å±æ€§ä¼šæ¶‰åŠåˆ°ä¸Šé¢ scheduler ç»“æ„ä¸­çš„ backoffQ ä¸ unschedulablePods backoffQï¼šä¹Ÿæ˜¯ä¸€ä¸ª heap ç±»å‹çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå­˜æ”¾çš„æ˜¯ä¸å¯è°ƒåº¦çš„Pod unschedulablePods ï¼šä¿å­˜ç¡®å®šä¸å¯è¢«è°ƒåº¦çš„Podï¼Œä¸€ä¸ªmapç±»å‹ backoffQ ä¸ unschedulablePods ä¼šåœ¨åˆå§‹åŒ– scheduler æ—¶åˆå§‹åŒ–ï¼Œ\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func NewPriorityQueue( lessFn framework.LessFunc, informerFactory informers.SharedInformerFactory, opts ...Option, ) *PriorityQueue { options := defaultPriorityQueueOptions for _, opt := range opts { opt(\u0026options) } comp := func(podInfo1, podInfo2 interface{}) bool { pInfo1 := podInfo1.(*framework.QueuedPodInfo) pInfo2 := podInfo2.(*framework.QueuedPodInfo) return lessFn(pInfo1, pInfo2) } if options.podNominator == nil { options.podNominator = NewPodNominator(informerFactory.Core().V1().Pods().Lister()) } pq := \u0026PriorityQueue{ PodNominator: options.podNominator, clock: options.clock, stop: make(chan struct{}), podInitialBackoffDuration: options.podInitialBackoffDuration, podMaxBackoffDuration: options.podMaxBackoffDuration, podMaxInUnschedulablePodsDuration: options.podMaxInUnschedulablePodsDuration, activeQ: heap.NewWithRecorder(podInfoKeyFunc, comp, metrics.NewActivePodsRecorder()), unschedulablePods: newUnschedulablePods(metrics.NewUnschedulablePodsRecorder()), moveRequestCycle: -1, clusterEventMap: options.clusterEventMap, } pq.cond.L = \u0026pq.lock // åˆå§‹åŒ–backoffQ // NewWithRecorderä½œä¸ºä¸€ä¸ªå¯é€‰çš„ metricRecorder çš„ Heap å¯¹è±¡ã€‚ // podInfoKeyFuncæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›é”™è¯¯ä¸å­—ç¬¦ä¸² // pq.podsCompareBackoffCompleted æ¯”è¾ƒä¸¤ä¸ªpodçš„å›é€€æ—¶é—´ï¼Œå¦‚æœç¬¬ä¸€ä¸ªåœ¨ç¬¬äºŒä¸ªä¹‹å‰ä¸ºtrueï¼Œ // åä¹‹ false pq.podBackoffQ = heap.NewWithRecorder(podInfoKeyFunc, pq.podsCompareBackoffCompleted, metrics.NewBackoffPodsRecorder()) pq.nsLister = informerFactory.Core().V1().Namespaces().Lister() return pq } å¯¹äºåˆå§‹åŒ– backoffQ ä¼šäº§ç”Ÿçš„ä¸¤ä¸ªå‡½æ•°ï¼ŒgetBackoffTime ä¸ calculateBackoffDuration\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // getBackoffTime returns the time that podInfo completes backoff func (p *PriorityQueue) getBackoffTime(podInfo *framework.QueuedPodInfo) time.Time { duration := p.calculateBackoffDuration(podInfo) backoffTime := podInfo.Timestamp.Add(duration) return backoffTime } // calculateBackoffDuration is a helper function for calculating the backoffDuration // based on the number of attempts the pod has made. func (p *PriorityQueue) calculateBackoffDuration(podInfo *framework.QueuedPodInfo) time.Duration { duration := p.podInitialBackoffDuration for i := 1; i \u003c podInfo.Attempts; i++ { // Use subtraction instead of addition or multiplication to avoid overflow. if duration \u003e p.podMaxBackoffDuration-duration { return p.podMaxBackoffDuration } duration += duration } return duration } å¯¹äºæ•´ä¸ªæ•…éšœé”™è¯¯ä¼šæŒ‰ç…§å¦‚ä¸‹æµç¨‹è¿›è¡Œï¼Œåœ¨åˆå§‹åŒ– scheduler ä¼šæ³¨å†Œä¸€ä¸ª Error å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç”¨ä½œå¯¹ä¸å¯è°ƒåº¦Podè¿›è¡Œå¤„ç†ï¼Œå®é™…ä¸Šè¢«æ³¨å†Œçš„å‡½æ•°æ˜¯ MakeDefaultErrorFuncã€‚è¿™ä¸ªå‡½æ•°å°†ä½œä¸º Error å‡½æ•°è¢«è°ƒç”¨ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 sched := newScheduler( schedulerCache, extenders, internalqueue.MakeNextPodFunc(podQueue), MakeDefaultErrorFunc(client, podLister, podQueue, schedulerCache), stopEverything, podQueue, profiles, client, snapshot, options.percentageOfNodesToScore, ) è€Œåœ¨ è°ƒåº¦å‘¨æœŸä¸­ï¼Œä¹Ÿå°±æ˜¯ scheduleOne å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªæ‰©å±•ç‚¹æ“ä½œå¤±è´¥åéƒ½ä¼šè°ƒç”¨ handleSchedulingFailure è€Œè¯¥å‡½æ•°ï¼Œä½¿ç”¨äº†æ³¨å†Œçš„ Error å‡½æ•°æ¥å¤„ç†Pod\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 func (sched *Scheduler) scheduleOne(ctx context.Context) { ... defer cancel() scheduleResult, err := sched.SchedulePod(schedulingCycleCtx, fwk, state, pod) if err != nil { var nominatingInfo *framework.NominatingInfo if fitError, ok := err.(*framework.FitError); ok { if !fwk.HasPostFilterPlugins() { klog.V(3).InfoS(\"No PostFilter plugins are registered, so no preemption will be performed\") } else { result, status := fwk.RunPostFilterPlugins(ctx, state, pod, fitError.Diagnosis.NodeToStatusMap) if status.Code() == framework.Error { klog.ErrorS(nil, \"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } else { fitError.Diagnosis.PostFilterMsg = status.Message() klog.V(5).InfoS(\"Status after running PostFilter plugins for pod\", \"pod\", klog.KObj(pod), \"status\", status) } if result != nil { nominatingInfo = result.NominatingInfo } } metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else if err == ErrNoNodesAvailable { nominatingInfo = clearNominatedNode // No nodes available is counted as unschedulable rather than an error. metrics.PodUnschedulable(fwk.ProfileName(), metrics.SinceInSeconds(start)) } else { nominatingInfo = clearNominatedNode klog.ErrorS(err, \"Error selecting node for pod\", \"pod\", klog.KObj(pod)) metrics.PodScheduleError(fwk.ProfileName(), metrics.SinceInSeconds(start)) } // å¤„ç†ä¸å¯è°ƒåº¦Pod sched.handleSchedulingFailure(ctx, fwk, podInfo, err, v1.PodReasonUnschedulable, nominatingInfo) return } æ¥åˆ°äº†æ³¨å†Œçš„ Error å‡½æ•° MakeDefaultErrorFunc\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 func MakeDefaultErrorFunc(client clientset.Interface, podLister corelisters.PodLister, podQueue internalqueue.SchedulingQueue, schedulerCache internalcache.Cache) func(*framework.QueuedPodInfo, error) { return func(podInfo *framework.QueuedPodInfo, err error) { pod := podInfo.Pod if err == ErrNoNodesAvailable { klog.V(2).InfoS(\"Unable to schedule pod; no nodes are registered to the cluster; waiting\", \"pod\", klog.KObj(pod)) } else if fitError, ok := err.(*framework.FitError); ok { // Inject UnschedulablePlugins to PodInfo, which will be used later for moving Pods between queues efficiently. podInfo.UnschedulablePlugins = fitError.Diagnosis.UnschedulablePlugins klog.V(2).InfoS(\"Unable to schedule pod; no fit; waiting\", \"pod\", klog.KObj(pod), \"err\", err) } else if apierrors.IsNotFound(err) { klog.V(2).InfoS(\"Unable to schedule pod, possibly due to node not found; waiting\", \"pod\", klog.KObj(pod), \"err\", err) if errStatus, ok := err.(apierrors.APIStatus); ok \u0026\u0026 errStatus.Status().Details.Kind == \"node\" { nodeName := errStatus.Status().Details.Name // when node is not found, We do not remove the node right away. Trying again to get // the node and if the node is still not found, then remove it from the scheduler cache. _, err := client.CoreV1().Nodes().Get(context.TODO(), nodeName, metav1.GetOptions{}) if err != nil \u0026\u0026 apierrors.IsNotFound(err) { node := v1.Node{ObjectMeta: metav1.ObjectMeta{Name: nodeName}} if err := schedulerCache.RemoveNode(\u0026node); err != nil { klog.V(4).InfoS(\"Node is not found; failed to remove it from the cache\", \"node\", node.Name) } } } } else { klog.ErrorS(err, \"Error scheduling pod; retrying\", \"pod\", klog.KObj(pod)) } // Check if the Pod exists in informer cache. cachedPod, err := podLister.Pods(pod.Namespace).Get(pod.Name) if err != nil { klog.InfoS(\"Pod doesn't exist in informer cache\", \"pod\", klog.KObj(pod), \"err\", err) return } // In the case of extender, the pod may have been bound successfully, but timed out returning its response to the scheduler. // It could result in the live version to carry .spec.nodeName, and that's inconsistent with the internal-queued version. if len(cachedPod.Spec.NodeName) != 0 { klog.InfoS(\"Pod has been assigned to node. Abort adding it back to queue.\", \"pod\", klog.KObj(pod), \"node\", cachedPod.Spec.NodeName) return } // As is from SharedInformer, we need to do a DeepCopy() here. podInfo.PodInfo = framework.NewPodInfo(cachedPod.DeepCopy()) // æ·»åŠ åˆ°unschedulableé˜Ÿåˆ—ä¸­ if err := podQueue.AddUnschedulableIfNotPresent(podInfo, podQueue.SchedulingCycle()); err != nil { klog.ErrorS(err, \"Error occurred\") } } } ä¸‹é¢æ¥åˆ° AddUnschedulableIfNotPresent ï¼Œè¿™ä¸ªä¹Ÿæ˜¯æ“ä½œ backoffQ å’Œ unschedulablePods çš„çœŸæ­£çš„åŠ¨ä½œ\nAddUnschedulableIfNotPresent å‡½æ•°ä¼šå§æ— æ³•è°ƒåº¦çš„ pod æ’å…¥é˜Ÿåˆ—ï¼Œé™¤éå®ƒå·²ç»åœ¨é˜Ÿåˆ—ä¸­ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒPriorityQueue å°†ä¸å¯è°ƒåº¦çš„ Pod æ”¾åœ¨ unschedulablePods ä¸­ã€‚ä½†å¦‚æœæœ€è¿‘æœ‰ move requestï¼Œåˆ™å°† pod æ”¾å…¥ podBackoffQ ä¸­ã€‚\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 func (p *PriorityQueue) AddUnschedulableIfNotPresent(pInfo *framework.QueuedPodInfo, podSchedulingCycle int64) error { p.lock.Lock() defer p.lock.Unlock() pod := pInfo.Pod // å¦‚æœå·²ç»å­˜åœ¨åˆ™ä¸æ·»åŠ  if p.unschedulablePods.get(pod) != nil { return fmt.Errorf(\"Pod %v is already present in unschedulable queue\", klog.KObj(pod)) } // æ£€æŸ¥æ˜¯å¦åœ¨activeQä¸­ if _, exists, _ := p.activeQ.Get(pInfo); exists { return fmt.Errorf(\"Pod %v is already present in the active queue\", klog.KObj(pod)) } // æ£€æŸ¥æ˜¯å¦åœ¨podBackoffQä¸­ if _, exists, _ := p.podBackoffQ.Get(pInfo); exists { return fmt.Errorf(\"Pod %v is already present in the backoff queue\", klog.KObj(pod)) } // åœ¨é‡æ–°æ·»åŠ æ—¶ï¼Œä¼šåˆ·æ–° Podæ—¶é—´ä¸ºæœ€æ–°æ“ä½œçš„æ—¶é—´ pInfo.Timestamp = p.clock.Now() for plugin := range pInfo.UnschedulablePlugins { metrics.UnschedulableReason(plugin, pInfo.Pod.Spec.SchedulerName).Inc() } // å¦‚æœæ¥å—åˆ°move requesté‚£ä¹ˆåˆ™æ”¾å…¥BackoffQ if p.moveRequestCycle \u003e= podSchedulingCycle { if err := p.podBackoffQ.Add(pInfo); err != nil { return fmt.Errorf(\"error adding pod %v to the backoff queue: %v\", pod.Name, err) } metrics.SchedulerQueueIncomingPods.WithLabelValues(\"backoff\", ScheduleAttemptFailure).Inc() } else { // å¦åˆ™å°†æ”¾å…¥åˆ° unschedulablePods p.unschedulablePods.addOrUpdate(pInfo) metrics.SchedulerQueueIncomingPods.WithLabelValues(\"unschedulable\", ScheduleAttemptFailure).Inc() } p.PodNominator.AddNominatedPod(pInfo.PodInfo, nil) return nil } åœ¨å¯åŠ¨ scheduler æ—¶ï¼Œä¼šå°†è¿™ä¸¤ä¸ªé˜Ÿåˆ—å¼‚æ­¥å¯ç”¨ä¸¤ä¸ªloopæ¥æ“ä½œé˜Ÿåˆ—ã€‚è¡¨ç°åœ¨ Run()\ngo 1 2 3 4 func (p *PriorityQueue) Run() { go wait.Until(p.flushBackoffQCompleted, 1.0*time.Second, p.stop) go wait.Until(p.flushUnschedulablePodsLeftover, 30*time.Second, p.stop) } å¯ä»¥çœ‹åˆ° flushBackoffQCompleted ä½œä¸º BackoffQ å®ç°ï¼›è€Œ flushUnschedulablePodsLeftover ä½œä¸º UnschedulablePods å®ç°ã€‚\nflushBackoffQCompleted æ˜¯ç”¨äºå°†æ‰€æœ‰å·²å®Œæˆå›é€€çš„ pod ä» backoffQ ç§»åˆ° activeQ ä¸­\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func (p *PriorityQueue) flushBackoffQCompleted() { p.lock.Lock() defer p.lock.Unlock() broadcast := false for { // è¿™å°±æ˜¯heapå®ç°çš„æ–¹æ³•ï¼Œçª¥è§†ä¸‹ï¼Œä½†ä¸å¼¹å‡º rawPodInfo := p.podBackoffQ.Peek() if rawPodInfo == nil { break } pod := rawPodInfo.(*framework.QueuedPodInfo).Pod boTime := p.getBackoffTime(rawPodInfo.(*framework.QueuedPodInfo)) if boTime.After(p.clock.Now()) { break } _, err := p.podBackoffQ.Pop() // å¼¹å‡ºä¸€ä¸ª if err != nil { klog.ErrorS(err, \"Unable to pop pod from backoff queue despite backoff completion\", \"pod\", klog.KObj(pod)) break } p.activeQ.Add(rawPodInfo) // æ”¾å…¥åˆ°æ´»åŠ¨é˜Ÿåˆ—ä¸­ metrics.SchedulerQueueIncomingPods.WithLabelValues(\"active\", BackoffComplete).Inc() broadcast = true } if broadcast { p.cond.Broadcast() } } flushUnschedulablePodsLeftover å‡½æ•°ç”¨äºå°†åœ¨ unschedulablePods ä¸­çš„å­˜æ”¾æ—¶é—´è¶…è¿‡ podMaxInUnschedulablePodsDuration å€¼çš„ pod ç§»åŠ¨åˆ° backoffQ æˆ– activeQ ä¸­ã€‚\npodMaxInUnschedulablePodsDuration ä¼šæ ¹æ®é…ç½®ä¼ å…¥ï¼Œå½“æ²¡æœ‰ä¼ å…¥ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº† Deprecated é‚£ä¹ˆä¼šä¸º5åˆ†é’Ÿã€‚\ngo 1 2 3 4 5 6 7 8 func NewOptions() *Options { o := \u0026Options{ SecureServing: apiserveroptions.NewSecureServingOptions().WithLoopback(), Authentication: apiserveroptions.NewDelegatingAuthenticationOptions(), Authorization: apiserveroptions.NewDelegatingAuthorizationOptions(), Deprecated: \u0026DeprecatedOptions{ PodMaxInUnschedulablePodsDuration: 5 * time.Minute, }, å¯¹äº flushUnschedulablePodsLeftover å°±æ˜¯åšä¸€ä¸ªæ—¶é—´å¯¹æ¯”ï¼Œç„¶åæ·»åŠ åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func (p *PriorityQueue) flushUnschedulablePodsLeftover() { p.lock.Lock() defer p.lock.Unlock() var podsToMove []*framework.QueuedPodInfo currentTime := p.clock.Now() for _, pInfo := range p.unschedulablePods.podInfoMap { lastScheduleTime := pInfo.Timestamp if currentTime.Sub(lastScheduleTime) \u003e p.podMaxInUnschedulablePodsDuration { podsToMove = append(podsToMove, pInfo) } } if len(podsToMove) \u003e 0 { p.movePodsToActiveOrBackoffQueue(podsToMove, UnschedulableTimeout) } } æ€»ç»“è°ƒåº¦ä¸Šä¸‹æ–‡æµç¨‹ åœ¨æ„å»ºä¸€ä¸ª scheduler æ—¶ç»å†å¦‚ä¸‹æ­¥éª¤ï¼š å‡†å¤‡cacheï¼Œinformerï¼Œqueueï¼Œé”™è¯¯å¤„ç†å‡½æ•°ç­‰ æ·»åŠ äº‹ä»¶å‡½æ•°ï¼Œä¼šç›‘å¬èµ„æºï¼ˆå¦‚Podï¼‰ï¼Œå½“æœ‰å˜åŠ¨åˆ™è§¦å‘å¯¹åº”äº‹ä»¶å‡½æ•°ï¼Œè¿™æ˜¯å…¥ç«™ activeQ æ„å»ºå®Œæˆåä¼š runï¼Œrunæ—¶ä¼šrunä¸€ä¸ª SchedulingQueueï¼Œè¿™ä¸ªæ˜¯ä½œä¸ºä¸å¯è°ƒåº¦é˜Ÿåˆ— BackoffQ UnschedulablePods ä¸å¯è°ƒåº¦é˜Ÿåˆ—ä¼šæ ¹æ®æ³¨å†Œæ—¶å®šæœŸæ¶ˆè´¹é˜Ÿåˆ—ä¸­Podå°†å…¶æ·»åŠ åˆ° activeQ ä¸­ å¯åŠ¨ä¸€ä¸ª scheduleOne çš„loopï¼Œè¿™ä¸ªæ˜¯è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„æ‰©å±•ç‚¹çš„æ‰§è¡Œï¼Œä¹Ÿæ˜¯ activeQ çš„æ¶ˆè´¹ç«¯ scheduleOne è·å– pod æ‰§è¡Œå„ä¸ªæ‰©å±•ç‚¹ï¼Œå¦‚æœå‡ºé”™åˆ™ Error å‡½æ•° MakeDefaultErrorFunc å°†å…¶æ·»åŠ åˆ°ä¸å¯è°ƒåº¦é˜Ÿåˆ—ä¸­ å›åˆ°ä¸å¯è°ƒåº¦é˜Ÿåˆ—ä¸­æ¶ˆè´¹éƒ¨åˆ† Reference [1] kubernetes scheduler extender\n","wordCount":"5322","inLanguage":"zh","datePublished":"2022-07-21T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/07/ch20-schedule-workflow/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>å½’æ¡£</span></a></li><li><a href=https://www.oomkill.com/tags><span>æ ‡ç­¾</span></a></li><li><a href=https://www.oomkill.com/search><span>æœç´¢</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>å…³äº</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">kube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-07-21</span></span>&nbsp;Â·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>5322 å­—</span></span>&nbsp;Â·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>25 åˆ†é’Ÿ</span></span>
<span class=pe-post-meta-item>&nbsp;Â·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#scheduler aria-label=Scheduler>Scheduler</a><li><a href=#schedulingqueue aria-label=SchedulingQueue>SchedulingQueue</a><li><a href=#%e8%b0%83%e5%ba%a6%e4%b8%8a%e4%b8%8b%e6%96%87 aria-label=è°ƒåº¦ä¸Šä¸‹æ–‡>è°ƒåº¦ä¸Šä¸‹æ–‡</a><ul><li><a href=#sort aria-label=Sort>Sort</a><li><a href=#prefilter aria-label=preFilter>preFilter</a><li><a href=#filter aria-label=filter>filter</a><li><a href=#postfilter aria-label=Postfilter>Postfilter</a><li><a href=#prescorescore aria-label=PreScore,Score>PreScore,Score</a><li><a href=#reserve aria-label=Reserve>Reserve</a><li><a href=#permit aria-label=permit>permit</a><li><a href=#binding-cycle aria-label="Binding Cycle">Binding Cycle</a></ul><li><a href=#%e8%b0%83%e5%ba%a6%e4%b8%8a%e4%b8%8b%e6%96%87%e4%b8%ad%e7%9a%84%e5%a4%b1%e8%b4%a5%e6%b5%81%e7%a8%8b aria-label=è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­çš„å¤±è´¥æµç¨‹>è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­çš„å¤±è´¥æµç¨‹</a><li><a href=#%e6%80%bb%e7%bb%93%e8%b0%83%e5%ba%a6%e4%b8%8a%e4%b8%8b%e6%96%87%e6%b5%81%e7%a8%8b aria-label=æ€»ç»“è°ƒåº¦ä¸Šä¸‹æ–‡æµç¨‹>æ€»ç»“è°ƒåº¦ä¸Šä¸‹æ–‡æµç¨‹</a><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=scheduler>Scheduler<a hidden class=anchor aria-hidden=true href=#scheduler>#</a></h2><p><a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/scheduler.go#L64-L102 target=_blank rel="noopener nofollow noreferrer">Scheduler</a> æ˜¯æ•´ä¸ª <code>kube-scheduler</code> çš„ä¸€ä¸ª structureï¼Œæä¾›äº† <code>kube-scheduler</code> è¿è¡Œæ‰€éœ€çš„ç»„ä»¶ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Scheduler</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Cacheæ˜¯ä¸€ä¸ªæŠ½è±¡ï¼Œä¼šç¼“å­˜podçš„ä¿¡æ¯ï¼Œä½œä¸ºschedulerè¿›è¡ŒæŸ¥æ‰¾ï¼Œæ“ä½œæ˜¯åŸºäºPodè¿›è¡Œå¢åŠ 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Cache</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nx>Cache</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Extenders ç®—æ˜¯è°ƒåº¦æ¡†æ¶ä¸­æä¾›çš„è°ƒåº¦æ’ä»¶ï¼Œä¼šå½±å“kubernetesä¸­çš„è°ƒåº¦ç­–ç•¥
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Extenders</span> <span class=p>[]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Extender</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// NextPod ä½œä¸ºä¸€ä¸ªå‡½æ•°æä¾›ï¼Œä¼šé˜»å¡è·å–ä¸‹ä¸€ä¸ªke&#39;diao&#39;du
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>NextPod</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Error is called if there is an error. It is passed the pod in
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// question, and the error
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Error</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulePod å°è¯•å°†ç»™å‡ºçš„podè°ƒåº¦åˆ°Nodeã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>SchedulePod</span> <span class=kd>func</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>ScheduleResult</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// å…³é—­schedulerçš„ä¿¡å·
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>StopEverything</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulingQueueä¿å­˜è¦è°ƒåº¦çš„Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>SchedulingQueue</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nx>SchedulingQueue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Profilesä¸­æ˜¯å¤šä¸ªè°ƒåº¦æ¡†æ¶
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Profiles</span> <span class=nx>profile</span><span class=p>.</span><span class=nx>Map</span>
</span></span><span class=line><span class=cl>	<span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodeInfoSnapshot</span> <span class=o>*</span><span class=nx>internalcache</span><span class=p>.</span><span class=nx>Snapshot</span>
</span></span><span class=line><span class=cl>	<span class=nx>percentageOfNodesToScore</span> <span class=kt>int32</span>
</span></span><span class=line><span class=cl>	<span class=nx>nextStartNodeIndex</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>ä½œä¸ºå®é™…æ‰§è¡Œçš„ä¸¤ä¸ªæ ¸å¿ƒï¼Œ<code>SchedulingQueue</code> ï¼Œä¸ <code>scheduleOne</code> å°†ä¼šåˆ†æåˆ°è¿™ä¸¤ä¸ª</p><h2 id=schedulingqueue>SchedulingQueue<a hidden class=anchor aria-hidden=true href=#schedulingqueue>#</a></h2><p>åœ¨çŸ¥é“ <code>kube-scheduler</code> åˆå§‹åŒ–è¿‡ç¨‹åï¼Œéœ€è¦å¯¹ <code>kube-scheduler</code> çš„æ•´ä¸ª <em>structure</em> å’Œ <em>workflow</em> è¿›è¡Œåˆ†æ</p><p>åœ¨ <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/scheduler.go#L336-L340 target=_blank rel="noopener nofollow noreferrer">Run</a> ä¸­ï¼Œè¿è¡Œçš„æ˜¯ ä¸€ä¸ª <code>SchedulingQueue</code> ä¸ ä¸€ä¸ª <code>scheduleOne</code> ï¼Œä»ç»“æ„ä¸Šçœ‹æ˜¯å±äº <em>Scheduler</em></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// We need to start scheduleOne loop in a dedicated goroutine,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// because scheduleOne function hangs on getting the next item
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// from the SchedulingQueue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If there are no new pods to schedule, it will be hanging there
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// and if done in this goroutine it will be blocking closing
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// SchedulingQueue, in effect causing a deadlock on shutdown.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>UntilWithContext</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>scheduleOne</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>ctx</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L81-L110 target=_blank rel="noopener nofollow noreferrer">SchedulingQueue</a> æ˜¯ä¸€ä¸ªé˜Ÿåˆ—çš„æŠ½è±¡ï¼Œç”¨äºå­˜å‚¨ç­‰å¾…è°ƒåº¦çš„Podã€‚è¯¥æ¥å£éµå¾ªç±»ä¼¼äº cache.FIFO å’Œ cache.Heap çš„æ¨¡å¼ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SchedulingQueue</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>framework</span><span class=p>.</span><span class=nx>PodNominator</span>
</span></span><span class=line><span class=cl>	<span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Activate moves the given pods to activeQ iff they&#39;re in unschedulablePods or backoffQ.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The passed-in pods are originally compiled from plugins that want to activate Pods,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by injecting the pods through a reserved CycleState struct (PodsToActivate).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Activate</span><span class=p>(</span><span class=nx>pods</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// å°†ä¸å¯è°ƒåº¦çš„Podé‡å…¥åˆ°é˜Ÿåˆ—ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>podSchedulingCycle</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulingCycle returns the current number of scheduling cycle which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// cached by scheduling queue. Normally, incrementing this number whenever
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a pod is popped (e.g. called Pop()) is enough.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>SchedulingCycle</span><span class=p>()</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Popä¼šå¼¹å‡ºä¸€ä¸ªpodï¼Œå¹¶ä»headä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­åˆ é™¤
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Update</span><span class=p>(</span><span class=nx>oldPod</span><span class=p>,</span> <span class=nx>newPod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Delete</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>event</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ClusterEvent</span><span class=p>,</span> <span class=nx>preCheck</span> <span class=nx>PreEnqueueCheck</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodAdded</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodUpdated</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>PendingPods</span><span class=p>()</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Close closes the SchedulingQueue so that the goroutine which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// waiting to pop items can exit gracefully.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Run starts the goroutines managing the queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>è€Œ <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L134-L175 target=_blank rel="noopener nofollow noreferrer">PriorityQueue</a> æ˜¯ <code>SchedulingQueue</code> çš„å®ç°ï¼Œè¯¥éƒ¨åˆ†çš„æ ¸å¿ƒæ„æˆæ˜¯ä¸¤ä¸ªå­é˜Ÿåˆ—ä¸ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå³ <code>activeQ</code>ã€<code>backoffQ</code> å’Œ <code>unschedulablePods</code></p><ul><li><code>activeQ</code>ï¼šæ˜¯ä¸€ä¸ª <em>heap</em> ç±»å‹çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ˜¯ <em>sheduler</em> ä»ä¸­è·å¾—ä¼˜å…ˆçº§æœ€é«˜çš„Podè¿›è¡Œè°ƒåº¦</li><li><code>backoffQ</code>ï¼šä¹Ÿæ˜¯ä¸€ä¸ª <em>heap</em> ç±»å‹çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå­˜æ”¾çš„æ˜¯ä¸å¯è°ƒåº¦çš„Pod</li><li><code>unschedulablePods </code>ï¼šä¿å­˜ç¡®å®šä¸å¯è¢«è°ƒåº¦çš„Pod</li></ul><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>GO</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-GO data-lang=GO><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SchedulingQueue</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>framework</span><span class=p>.</span><span class=nx>PodNominator</span>
</span></span><span class=line><span class=cl>	<span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Activate moves the given pods to activeQ iff they&#39;re in unschedulablePods or backoffQ.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The passed-in pods are originally compiled from plugins that want to activate Pods,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// by injecting the pods through a reserved CycleState struct (PodsToActivate).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Activate</span><span class=p>(</span><span class=nx>pods</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// AddUnschedulableIfNotPresent adds an unschedulable pod back to scheduling queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The podSchedulingCycle represents the current scheduling cycle number which can be
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// returned by calling SchedulingCycle().
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>podSchedulingCycle</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=c1>// SchedulingCycle returns the current number of scheduling cycle which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// cached by scheduling queue. Normally, incrementing this number whenever
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a pod is popped (e.g. called Pop()) is enough.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>SchedulingCycle</span><span class=p>()</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Pop removes the head of the queue and returns it. It blocks if the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// queue is empty and waits until a new item is added to the queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Update</span><span class=p>(</span><span class=nx>oldPod</span><span class=p>,</span> <span class=nx>newPod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Delete</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>event</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>ClusterEvent</span><span class=p>,</span> <span class=nx>preCheck</span> <span class=nx>PreEnqueueCheck</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodAdded</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>AssignedPodUpdated</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>PendingPods</span><span class=p>()</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Close closes the SchedulingQueue so that the goroutine which is
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// waiting to pop items can exit gracefully.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Run starts the goroutines managing the queue.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Run</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>åœ¨New <em>scheduler</em> æ—¶å¯ä»¥çœ‹åˆ°ä¼šåˆå§‹åŒ–è¿™ä¸ªqueue</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>podQueue</span> <span class=o>:=</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å®ç°podå¯¹æ¯”çš„ä¸€ä¸ªå‡½æ•°å³less
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>profiles</span><span class=p>[</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>SchedulerName</span><span class=p>].</span><span class=nf>QueueSortFunc</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>informerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodInitialBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxInUnschedulablePodsDuration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>è€Œ <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L252-L289 target=_blank rel="noopener nofollow noreferrer">NewSchedulingQueue</a> åˆ™æ˜¯åˆå§‹åŒ–è¿™ä¸ª PriorityQueue</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewSchedulingQueue initializes a priority queue as a new scheduling queue.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lessFn</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>LessFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>)</span> <span class=nx>SchedulingQueue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>NewPriorityQueue</span><span class=p>(</span><span class=nx>lessFn</span><span class=p>,</span> <span class=nx>informerFactory</span><span class=p>,</span> <span class=nx>opts</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// NewPriorityQueue creates a PriorityQueue object.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewPriorityQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lessFn</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>LessFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>PriorityQueue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>options</span> <span class=o>:=</span> <span class=nx>defaultPriorityQueueOptions</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>opt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>opt</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// è¿™ä¸ªå°±æ˜¯ lesså‡½æ•°ï¼Œä½œä¸ºæ‰“åˆ†çš„ä¸€éƒ¨åˆ†
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>comp</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>podInfo1</span><span class=p>,</span> <span class=nx>podInfo2</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo1</span> <span class=o>:=</span> <span class=nx>podInfo1</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo2</span> <span class=o>:=</span> <span class=nx>podInfo2</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nf>lessFn</span><span class=p>(</span><span class=nx>pInfo1</span><span class=p>,</span> <span class=nx>pInfo2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=p>=</span> <span class=nf>NewPodNominator</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>PriorityQueue</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>PodNominator</span><span class=p>:</span>                      <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clock</span><span class=p>:</span>                             <span class=nx>options</span><span class=p>.</span><span class=nx>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>stop</span><span class=p>:</span>                              <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInitialBackoffDuration</span><span class=p>:</span>         <span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxBackoffDuration</span><span class=p>:</span>             <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>:</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>activeQ</span><span class=p>:</span>                           <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>comp</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewActivePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>unschedulablePods</span><span class=p>:</span>                 <span class=nf>newUnschedulablePods</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>NewUnschedulablePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>moveRequestCycle</span><span class=p>:</span>                  <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clusterEventMap</span><span class=p>:</span>                   <span class=nx>options</span><span class=p>.</span><span class=nx>clusterEventMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>pq</span><span class=p>.</span><span class=nx>lock</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>podBackoffQ</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>pq</span><span class=p>.</span><span class=nx>podsCompareBackoffCompleted</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewBackoffPodsRecorder</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>nsLister</span> <span class=p>=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Namespaces</span><span class=p>().</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pq</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>äº†è§£äº†Queueçš„ç»“æ„ï¼Œå°±éœ€è¦çŸ¥é“ å…¥é˜Ÿåˆ—ä¸å‡ºé˜Ÿåˆ—æ˜¯åœ¨å“ªé‡Œæ“ä½œçš„ã€‚åœ¨åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦æ³¨å†Œä¸€ä¸ª <code>addEventHandlerFuncs</code> è¿™ä¸ªæ—¶å€™ï¼Œä¼šæ³¨å…¥ä¸‰ä¸ªåŠ¨ä½œå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯controllerä¸­çš„æ¦‚å¿µï¼›è€Œåœ¨AddFuncä¸­å¯ä»¥çœ‹åˆ°ä¼šå…¥é˜Ÿåˆ—ã€‚</p><p>æ³¨å…¥æ˜¯å¯¹ Pod çš„<a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/eventhandlers.go#L302-L305 target=_blank rel="noopener nofollow noreferrer">informer</a>æ³¨å…¥çš„ï¼Œæ³¨å…¥çš„å‡½æ•° <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/eventhandlers.go#L114-L120 target=_blank rel="noopener nofollow noreferrer">addPodToSchedulingQueue</a> å°±æ˜¯å…¥æ ˆ</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>Handler</span><span class=p>:</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>sched</span><span class=p>.</span><span class=nx>addPodToSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>updatePodInSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>deletePodFromSchedulingQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>addPodToSchedulingQueue</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Add event for unscheduled pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to queue %T: %v&#34;</span><span class=p>,</span> <span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>è€Œè¿™ä¸ª <code>SchedulingQueue</code> çš„å®ç°å°±æ˜¯ <code>PriorityQueue</code> ï¼Œè€ŒAddä¸­åˆ™å¯¹ activeQè¿›è¡Œçš„æ“ä½œ</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ ¼å¼åŒ–å…¥æ ˆæ•°æ®ï¼ŒåŒ…å«podinfoï¼Œé‡Œä¼šåŒ…å«v1.Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// åˆå§‹åŒ–çš„æ—¶é—´ï¼Œåˆ›å»ºçš„æ—¶é—´ï¼Œä»¥åŠä¸èƒ½è¢«è°ƒåº¦æ—¶çš„è®°å½•å…¶pluginçš„åç§°
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>newQueuedPodInfo</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å…¥æ ˆ
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error adding pod to the active queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Error: pod is already in the unschedulable queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nb>delete</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Delete pod from backoffQ if it is backing off
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Delete</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Error: pod is already in the podBackoff queue&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;active&#34;</span><span class=p>,</span> <span class=nx>PodAdd</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>PodNominator</span><span class=p>.</span><span class=nf>AddNominatedPod</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>.</span><span class=nx>PodInfo</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>åœ¨ä¸Šé¢çœ‹ <em>scheduler</em> ç»“æ„æ—¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ª nextPodçš„ï¼ŒnextPodå°±æ˜¯ä»é˜Ÿåˆ—ä¸­å¼¹å‡ºä¸€ä¸ªpodï¼Œè¿™ä¸ªåœ¨<em>scheduler</em> æ—¶ä¼šä¼ å…¥ <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L952-L965 target=_blank rel="noopener nofollow noreferrer">MakeNextPodFunc</a> å°±æ˜¯è¿™ä¸ª nextpod</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>MakeNextPodFunc</span><span class=p>(</span><span class=nx>queue</span> <span class=nx>SchedulingQueue</span><span class=p>)</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>()</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>queue</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;About to try and schedule pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>plugin</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nf>UnschedulableReason</span><span class=p>(</span><span class=nx>plugin</span><span class=p>,</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>).</span><span class=nf>Dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>podInfo</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error while retrieving next pod from scheduling queue&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>è€Œè¿™ä¸ª <code>queue.Pop()</code> å¯¹åº”çš„å°±æ˜¯ <code>PriorityQueue</code> çš„ <a href=https://github.com/kubernetes/kubernetes/blob/140c27533044e9e00f800d3ad0517540e3e4ecad/pkg/scheduler/internal/queue/scheduling_queue.go#L483-L503 target=_blank rel="noopener nofollow noreferrer">Pop()</a> ï¼Œåœ¨è¿™é‡Œä¼šå°†ä½œä¸º activeQ çš„æ¶ˆè´¹ç«¯</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Pop</span><span class=p>()</span> <span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>for</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Len</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// When the queue is empty, invocation of Pop() is blocked until new item is enqueued.
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// When Close() is called, the p.closed is set and the condition is broadcast,
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// which causes this loop to continue and return from the Pop().
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>closed</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>         <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>queueClosed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span>
</span></span><span class=line><span class=cl>   <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span>
</span></span><span class=line><span class=cl>   <span class=nx>pInfo</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>   <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=o>++</span>
</span></span><span class=line><span class=cl>   <span class=nx>p</span><span class=p>.</span><span class=nx>schedulingCycle</span><span class=o>++</span>
</span></span><span class=line><span class=cl>   <span class=k>return</span> <span class=nx>pInfo</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>åœ¨ä¸Šé¢å…¥å£éƒ¨åˆ†ä¹Ÿçœ‹åˆ°äº†ï¼ŒscheduleOne å’Œ schedulerï¼ŒscheduleOne å°±æ˜¯å»æ¶ˆè´¹ä¸€ä¸ªPodï¼Œä»–ä¼šè°ƒç”¨ NextPodï¼ŒNextPodå°±æ˜¯åœ¨åˆå§‹åŒ–ä¼ å…¥çš„ <code>MakeNextPodFunc</code> ï¼Œè‡³æ­¤å›åˆ°å¯¹åº”çš„ Popæ¥åšæ¶ˆè´¹ã€‚</p><p>schedulerOneæ˜¯ä¸ºä¸€ä¸ªPodåšè°ƒåº¦çš„æµç¨‹ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podInfo</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>NextPod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pod could be nil when schedulerQueue is closed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// This shouldn&#39;t happen, because we only accept for scheduling the pods
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// which specify a scheduler name that matches one of the profiles.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>skipPodSchedule</span><span class=p>(</span><span class=nx>fwk</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=è°ƒåº¦ä¸Šä¸‹æ–‡>è°ƒåº¦ä¸Šä¸‹æ–‡<a hidden class=anchor aria-hidden=true href=#è°ƒåº¦ä¸Šä¸‹æ–‡>#</a></h2><p>å½“äº†è§£äº†schedulerç»“æ„åï¼Œä¸‹é¢åˆ†æä¸‹è°ƒåº¦ä¸Šä¸‹æ–‡çš„è¿‡ç¨‹ã€‚çœ‹çœ‹æ‰©å±•ç‚¹æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚è¿™ä¸ªæ—¶å€™åˆéœ€è¦æåˆ°å®˜ç½‘çš„è°ƒåº¦ä¸Šä¸‹æ–‡çš„å›¾ã€‚</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/scheduling-framework-extensions.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/scheduling-framework-extensions.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center class=podsc>å›¾1ï¼šPodçš„è°ƒåº¦ä¸Šä¸‹æ–‡</center><center><em>Sourceï¼š</em>https://kubernetes.io/docs/concepts/scheduling-eviction/scheduling-framework</center><p>è€Œ <em>scheduler</em> å¯¹äºè°ƒåº¦ä¸Šä¸‹æ–‡æ¥å°±æ˜¯è¿™ä¸ª <code>scheduleOne </code>ï¼Œä¸‹é¢å°±æ˜¯çœ‹è¿™ä¸ªè°ƒåº¦ä¸Šä¸‹æ–‡</p><h3 id=sort>Sort<a hidden class=anchor aria-hidden=true href=#sort>#</a></h3><p><code>Sort</code> æ’ä»¶æä¾›äº†æ’åºåŠŸèƒ½ï¼Œç”¨äºå¯¹åœ¨è°ƒåº¦é˜Ÿåˆ—ä¸­å¾…å¤„ç† Pod è¿›è¡Œæ’åºã€‚ä¸€æ¬¡åªèƒ½å¯ç”¨ä¸€ä¸ªé˜Ÿåˆ—æ’åºã€‚</p><p>åœ¨è¿›å…¥ <code>scheduleOne</code> åï¼Œ<code>NextPod</code> ä» <code>activeQ</code> ä¸­é˜Ÿåˆ—ä¸­å¾—åˆ°ä¸€ä¸ªPodï¼Œç„¶åçš„ <code>frameworkForPod</code> ä¼šåšæ‰“åˆ†çš„åŠ¨ä½œå°±æ˜¯è°ƒåº¦ä¸Šä¸‹æ–‡çš„ç¬¬ä¸€ä¸ªæ‰©å±•ç‚¹ <code>sort</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podInfo</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>NextPod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pod could be nil when schedulerQueue is closed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è·å–æŒ‡å®šçš„profile
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Profiles</span><span class=p>[</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;profile not found for scheduler name %q&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>fwk</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>å›é¡¾ï¼Œå› ä¸ºåœ¨New scheduleræ—¶ä¼šåˆå§‹åŒ–è¿™ä¸ª sort å‡½æ•°</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>podQueue</span> <span class=o>:=</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>NewSchedulingQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>profiles</span><span class=p>[</span><span class=nx>options</span><span class=p>.</span><span class=nx>profiles</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>SchedulerName</span><span class=p>].</span><span class=nf>QueueSortFunc</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>informerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodInitialBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxBackoffDuration</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nf>Duration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffSeconds</span><span class=p>)</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodNominator</span><span class=p>(</span><span class=nx>nominator</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithClusterEventMap</span><span class=p>(</span><span class=nx>clusterEventMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>WithPodMaxInUnschedulablePodsDuration</span><span class=p>(</span><span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>),</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=prefilter>preFilter<a hidden class=anchor aria-hidden=true href=#prefilter>#</a></h3><p>preFilterä½œä¸ºç¬¬ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œæ˜¯ç”¨äºåœ¨è¿‡æ»¤ä¹‹å‰é¢„å¤„ç†æˆ–æ£€æŸ¥ Pod æˆ–é›†ç¾¤çš„ç›¸å…³ä¿¡æ¯ã€‚è¿™é‡Œä¼šç»ˆæ­¢è°ƒåº¦</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>podInfo</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>NextPod</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// pod could be nil when schedulerQueue is closed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>podInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>frameworkForPod</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// This shouldn&#39;t happen, because we only accept for scheduling the pods
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// which specify a scheduler name that matches one of the profiles.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>skipPodSchedule</span><span class=p>(</span><span class=nx>fwk</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Attempting to schedule pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Synchronously attempt to find a fit for the pod.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>start</span> <span class=o>:=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewCycleState</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span><span class=p>.</span><span class=nf>SetRecordPluginMetrics</span><span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Intn</span><span class=p>(</span><span class=mi>100</span><span class=p>)</span> <span class=p>&lt;</span> <span class=nx>pluginMetricsSamplePercent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Initialize an empty podsToActivate struct, which will be filled up by plugins or stay empty.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podsToActivate</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewPodsToActivate</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span><span class=p>.</span><span class=nf>Write</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>PodsToActivateKey</span><span class=p>,</span> <span class=nx>podsToActivate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è¿™é‡Œå°†è¿›å…¥prefilter
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L311-L360 target=_blank rel="noopener nofollow noreferrer">schedulePod</a> å°è¯•å°†ç»™å®šçš„ pod è°ƒåº¦åˆ°èŠ‚ç‚¹åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹ä¹‹ä¸€ã€‚å¦‚æœæˆåŠŸï¼Œå®ƒå°†è¿”å›èŠ‚ç‚¹çš„åç§°ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>schedulePod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>ScheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span> <span class=o>:=</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Scheduling&#34;</span><span class=p>,</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;namespace&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// ç”¨äºå°†cacheæ›´æ–°ä¸ºå½“å‰å†…å®¹
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>UpdateSnapshot</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Snapshotting scheduler cache and node infos done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>ErrNoNodesAvailable</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„podæ—¶ï¼Œä¼šæ‰§è¡Œæ‰©å±•ç‚¹
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=o>...</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L364-L426 target=_blank rel="noopener nofollow noreferrer">findNodesThatFitPod</a> ä¼šæ‰§è¡Œå¯¹åº”çš„è¿‡æ»¤æ’ä»¶æ¥æ‰¾åˆ°æœ€é€‚åˆçš„Nodeï¼ŒåŒ…æ‹¬å¤‡æ³¨ï¼Œä»¥åŠæ–¹æ³•åéƒ½å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œè¿è¡Œçš„æ’ä»¶ğŸ˜ğŸ˜ï¼Œåé¢ä¼šåˆ†æç®—æ³•å†…å®¹ï¼Œåªå¯¹workflowå­¦ä¹ ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>diagnosis</span> <span class=o>:=</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>NodeToStatusMap</span><span class=p>:</span>      <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>UnschedulablePlugins</span><span class=p>:</span> <span class=nx>sets</span><span class=p>.</span><span class=nf>NewString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run &#34;prefilter&#34; plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>preRes</span><span class=p>,</span> <span class=nx>s</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>allNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>s</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// All nodes will have the same status. Some non trivial refactoring is
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// needed to avoid this copy.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>n</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>allNodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>[</span><span class=nx>n</span><span class=p>.</span><span class=nf>Node</span><span class=p>().</span><span class=nx>Name</span><span class=p>]</span> <span class=p>=</span> <span class=nx>s</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Status satisfying IsUnschedulable() gets injected into diagnosis.UnschedulablePlugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nf>FailedPlugin</span><span class=p>()</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>diagnosis</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nf>FailedPlugin</span><span class=p>())</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// &#34;NominatedNodeName&#34; can potentially be set in a previous scheduling cycle as a result of preemption.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This node is likely the only candidate that will fit the pod, and hence we try it first before iterating over all nodes.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>NominatedNodeName</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>evaluateNominatedNode</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Evaluation failed on nominated node&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Status</span><span class=p>.</span><span class=nx>NominatedNodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Nominated node passes all the filters, scheduler is good to assign this node to the pod.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>nodes</span> <span class=o>:=</span> <span class=nx>allNodes</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>preRes</span><span class=p>.</span><span class=nf>AllNodes</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>nodes</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeInfo</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>preRes</span><span class=p>.</span><span class=nx>NodeNames</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>n</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>preRes</span><span class=p>.</span><span class=nx>NodeNames</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NodeInfos</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>nodes</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>nodes</span><span class=p>,</span> <span class=nx>nInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatPassFilters</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>findNodesThatPassExtenders</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=filter>filter<a hidden class=anchor aria-hidden=true href=#filter>#</a></h3><p>filteræ’ä»¶ç›¸å½“äº<em>è°ƒåº¦ä¸Šä¸‹æ–‡</em>ä¸­çš„ <code>Predicates</code>ï¼Œç”¨äºæ’é™¤ä¸èƒ½è¿è¡Œ Pod çš„èŠ‚ç‚¹ã€‚Filter ä¼šæŒ‰é…ç½®çš„é¡ºåºè¿›è¡Œè°ƒç”¨ã€‚å¦‚æœæœ‰ä¸€ä¸ªfilterå°†èŠ‚ç‚¹æ ‡è®°ä½ä¸å¯ç”¨ï¼Œåˆ™å°† Pod æ ‡è®°ä¸ºä¸å¯è°ƒåº¦ï¼ˆå³ä¸ä¼šå‘ä¸‹æ‰§è¡Œï¼‰ã€‚</p><p>å¯¹äºä»£ç ä¸­æ¥è®²ï¼Œfilterè¿˜æ˜¯å¤„äº <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L364-L426 target=_blank rel="noopener nofollow noreferrer">findNodesThatFitPod</a> å‡½æ•°ä¸­ï¼Œ<code>findNodesThatPassFilters</code> å°±æ˜¯è·å–åˆ° FNï¼Œå³å¯è¡ŒèŠ‚ç‚¹ï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ <em>filter</em> æ‰©å±•ç‚¹</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>([]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatPassFilters</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nf>findNodesThatPassExtenders</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=postfilter>Postfilter<a hidden class=anchor aria-hidden=true href=#postfilter>#</a></h3><p>å½“æ²¡æœ‰ä¸º pod æ‰¾åˆ°<em>FN</em>æ—¶ï¼Œè¯¥æ’ä»¶ä¼šæŒ‰ç…§é…ç½®çš„é¡ºåºè¿›è¡Œè°ƒç”¨ã€‚å¦‚æœä»»ä½•<code>postFilter</code>æ’ä»¶å°† Pod æ ‡è®°ä¸º<em>schedulable</em>ï¼Œåˆ™ä¸ä¼šè°ƒç”¨å…¶ä½™æ’ä»¶ã€‚å³ <code>filter</code> æˆåŠŸåä¸ä¼šè¿›è¡Œè¿™æ­¥éª¤ï¼Œé‚£æˆ‘ä»¬æ¥éªŒè¯ä¸‹è¿™é‡ŒæŠŠğŸ˜Š</p><p>è¿˜æ˜¯åœ¨ scheduleOne ä¸­ï¼Œå½“æˆ‘ä»¬è¿è¡Œçš„ SchedulePod å®Œæˆåï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ï¼Œè¿™æ—¶ä¼šè¿”å›ä¸€ä¸ªerrï¼Œè€Œ <code>postfilter</code> ä¼šæ ¹æ®è¿™ä¸ª errè¿›è¡Œé€‰æ‹©æ‰§è¡Œæˆ–ä¸æ‰§è¡Œï¼Œç¬¦åˆå®˜æ–¹ç»™å‡ºçš„è¯´æ³•ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// SchedulePod() may have failed because the pod would not fit on any host, so we try to
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// preempt, with the expectation that the next time the pod is tried for scheduling it
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// will fit due to the preemption. It is also possible that a different pod will schedule
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// into the resources that were preempted, but this is harmless.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=kd>var</span> <span class=nx>nominatingInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>fitError</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasPostFilterPlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;No PostFilter plugins are registered, so no preemption will be performed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Run PostFilter plugins to try to make the pod schedulable in a future scheduling cycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>result</span><span class=p>,</span> <span class=nx>status</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Code</span><span class=p>()</span> <span class=o>==</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>PostFilterMsg</span> <span class=p>=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Message</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>result</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Pod did not fit anywhere, so it is counted as a failure. If preemption
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// succeeds, the pod should get counted as a success the next time we try to
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// schedule it. (hopefully)
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ErrNoNodesAvailable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=c1>// No nodes available is counted as unschedulable rather than an error.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error selecting node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>podInfo</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span><span class=p>,</span> <span class=nx>nominatingInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=prescorescore>PreScore,Score<a hidden class=anchor aria-hidden=true href=#prescorescore>#</a></h3><p>å¯ç”¨äºè¿›è¡Œé¢„Scoreå·¥ä½œï¼Œä½œä¸ºé€šçŸ¥æ€§çš„æ‰©å±•ç‚¹ï¼Œä¼šåœ¨åœ¨filterå®Œä¹‹åç›´æ¥ä¼šå…³è” preScore æ’ä»¶è¿›è¡Œç»§ç»­å·¥ä½œï¼Œè€Œä¸æ˜¯è¿”å›ï¼Œå¦‚æœé…ç½®çš„è¿™äº›æ’ä»¶æœ‰ä»»ä½•ä¸€ä¸ªè¿”å›å¤±è´¥ï¼Œåˆ™Podå°†è¢«æ‹’ç»ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>schedulePod</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span> <span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span> <span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=p>(</span><span class=nx>result</span> <span class=nx>ScheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span> <span class=o>:=</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Scheduling&#34;</span><span class=p>,</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;namespace&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>},</span> <span class=nx>utiltrace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>UpdateSnapshot</span><span class=p>(</span><span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Snapshotting scheduler cache and node infos done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>ErrNoNodesAvailable</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>feasibleNodes</span><span class=p>,</span> <span class=nx>diagnosis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>findNodesThatFitPod</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Computing predicates done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Pod</span><span class=p>:</span>         <span class=nx>pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>NumAllNodes</span><span class=p>:</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>nodeInfoSnapshot</span><span class=p>.</span><span class=nf>NumNodes</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>			<span class=nx>Diagnosis</span><span class=p>:</span>   <span class=nx>diagnosis</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// When only one node after predicate, just use it.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>ScheduleResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>SuggestedHost</span><span class=p>:</span>  <span class=nx>feasibleNodes</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>EvaluatedNodes</span><span class=p>:</span> <span class=mi>1</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>			<span class=nx>FeasibleNodes</span><span class=p>:</span>  <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// è¿™é‡Œä¼šå®Œæˆprescoreï¼Œscore
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>priorityList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>prioritizeNodes</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Extenders</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>feasibleNodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>host</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>selectHost</span><span class=p>(</span><span class=nx>priorityList</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>trace</span><span class=p>.</span><span class=nf>Step</span><span class=p>(</span><span class=s>&#34;Prioritizing done&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ScheduleResult</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>SuggestedHost</span><span class=p>:</span>  <span class=nx>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>EvaluatedNodes</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		<span class=nx>FeasibleNodes</span><span class=p>:</span>  <span class=nb>len</span><span class=p>(</span><span class=nx>feasibleNodes</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L605-L705 target=_blank rel="noopener nofollow noreferrer">priorityNodes</a> ä¼šé€šè¿‡é…ç½®çš„æ’ä»¶ç»™Nodeæ‰“åˆ†ï¼Œå¹¶è¿”å›æ¯ä¸ªNodeçš„åˆ†æ•°ï¼Œå°†æ¯ä¸ªæ’ä»¶æ‰“åˆ†ç»“æœè®¡ç®—æ€»å’Œè·å¾—Nodeçš„åˆ†æ•°ï¼Œæœ€åè·å¾—èŠ‚ç‚¹çš„åŠ æƒæ€»åˆ†æ•°ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>prioritizeNodes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>extenders</span> <span class=p>[]</span><span class=nx>framework</span><span class=p>.</span><span class=nx>Extender</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>fwk</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Framework</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>state</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>CycleState</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>nodes</span> <span class=p>[]</span><span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// If no priority configs are provided, then all nodes will have a score of one.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is required to generate the priority list in the required format
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>extenders</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasScorePlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScore</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Name</span><span class=p>:</span>  <span class=nx>nodes</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Score</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run PreScore plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>preScoreStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreScorePlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>preScoreStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>preScoreStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Run the Score plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>scoresMap</span><span class=p>,</span> <span class=nx>scoreStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunScorePlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>scoreStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>scoreStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Additional details logged at level 10 if enabled.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>klogV</span> <span class=o>:=</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>klogV</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>plugin</span><span class=p>,</span> <span class=nx>nodeScoreList</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scoresMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>nodeScore</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodeScoreList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klogV</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Plugin scored node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;plugin&#34;</span><span class=p>,</span> <span class=nx>plugin</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>nodeScore</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;score&#34;</span><span class=p>,</span> <span class=nx>nodeScore</span><span class=p>.</span><span class=nx>Score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Summarize all scores.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>result</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScoreList</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>nodes</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>result</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>result</span><span class=p>,</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>NodeScore</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>nodes</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>Score</span><span class=p>:</span> <span class=mi>0</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>j</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>scoresMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=o>+=</span> <span class=nx>scoresMap</span><span class=p>[</span><span class=nx>j</span><span class=p>][</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>extenders</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nx>nodes</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>mu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>wg</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>WaitGroup</span>
</span></span><span class=line><span class=cl>		<span class=nx>combinedScores</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>int64</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>nodes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>extenders</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>extenders</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nf>IsInterested</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>wg</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>extIndex</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>PrioritizingExtender</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>defer</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>PrioritizingExtender</span><span class=p>).</span><span class=nf>Dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nx>wg</span><span class=p>.</span><span class=nf>Done</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=p>}()</span>
</span></span><span class=line><span class=cl>				<span class=nx>prioritizedList</span><span class=p>,</span> <span class=nx>weight</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>extenders</span><span class=p>[</span><span class=nx>extIndex</span><span class=p>].</span><span class=nf>Prioritize</span><span class=p>(</span><span class=nx>pod</span><span class=p>,</span> <span class=nx>nodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// Prioritization errors from extender can be ignored, let k8s/other extenders determine the priorities
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Failed to run extender&#39;s priority function. No score given by this extender.&#34;</span><span class=p>,</span> <span class=s>&#34;error&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;extender&#34;</span><span class=p>,</span> <span class=nx>extenders</span><span class=p>[</span><span class=nx>extIndex</span><span class=p>].</span><span class=nf>Name</span><span class=p>())</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=o>*</span><span class=nx>prioritizedList</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>host</span><span class=p>,</span> <span class=nx>score</span> <span class=o>:=</span> <span class=p>(</span><span class=o>*</span><span class=nx>prioritizedList</span><span class=p>)[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Host</span><span class=p>,</span> <span class=p>(</span><span class=o>*</span><span class=nx>prioritizedList</span><span class=p>)[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>klogV</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klogV</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Extender scored node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;extender&#34;</span><span class=p>,</span> <span class=nx>extenders</span><span class=p>[</span><span class=nx>extIndex</span><span class=p>].</span><span class=nf>Name</span><span class=p>(),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>host</span><span class=p>,</span> <span class=s>&#34;score&#34;</span><span class=p>,</span> <span class=nx>score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=nx>combinedScores</span><span class=p>[</span><span class=nx>host</span><span class=p>]</span> <span class=o>+=</span> <span class=nx>score</span> <span class=o>*</span> <span class=nx>weight</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}(</span><span class=nx>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// wait for all go routines to finish
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// MaxExtenderPriority may diverge from the max priority used in the scheduler and defined by MaxNodeScore,
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// therefore we need to scale the score returned by extenders to the score range used by the scheduler.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span> <span class=o>+=</span> <span class=nx>combinedScores</span><span class=p>[</span><span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>]</span> <span class=o>*</span> <span class=p>(</span><span class=nx>framework</span><span class=p>.</span><span class=nx>MaxNodeScore</span> <span class=o>/</span> <span class=nx>extenderv1</span><span class=p>.</span><span class=nx>MaxExtenderPriority</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>klogV</span><span class=p>.</span><span class=nf>Enabled</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>result</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klogV</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Calculated node&#39;s final score for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Name</span><span class=p>,</span> <span class=s>&#34;score&#34;</span><span class=p>,</span> <span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>Score</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>result</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=reserve>Reserve<a hidden class=anchor aria-hidden=true href=#reserve>#</a></h3><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L153-L163 target=_blank rel="noopener nofollow noreferrer">Reserve</a> å› ä¸ºç»‘å®šäº‹ä»¶æ—¶å¼‚æ­¥å‘ç”Ÿçš„ï¼Œè¯¥æ’ä»¶æ˜¯ä¸ºäº†é¿å…Podåœ¨ç»‘å®šåˆ°èŠ‚ç‚¹å‰æ—¶ï¼Œè°ƒåº¦åˆ°æ–°çš„Podï¼Œä½¿èŠ‚ç‚¹ä½¿ç”¨èµ„æºè¶…è¿‡å¯ç”¨èµ„æºæƒ…å†µã€‚å¦‚æœåç»­é˜¶æ®µå‘ç”Ÿé”™è¯¯æˆ–å¤±è´¥ï¼Œå°†è§¦å‘ <code>UnReserve</code> å›æ»šï¼ˆé€šçŸ¥æ€§æ‰©å±•ç‚¹ï¼‰ã€‚è¿™ä¹Ÿæ˜¯ä½œä¸ºè°ƒåº¦å‘¨æœŸä¸­æœ€åä¸€ä¸ªçŠ¶æ€ï¼Œè¦ä¹ˆæˆåŠŸåˆ° <code>postBind</code> ï¼Œè¦ä¹ˆå¤±è´¥è§¦å‘ <code>UnReserve</code>ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// Run the Reserve method of reserve plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>if</span> <span class=nx>sts</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsReserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>);</span> <span class=p>!</span><span class=nx>sts</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span> <span class=c1>// å½“å¤„ç†ä¸æˆåŠŸæ—¶
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=c1>// è§¦å‘ un-reserve æ¥æ¸…ç†ç›¸å…³Podçš„çŠ¶æ€
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;Scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>sts</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>SchedulerError</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=permit>permit<a hidden class=anchor aria-hidden=true href=#permit>#</a></h3><p><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L165-L183 target=_blank rel="noopener nofollow noreferrer">Permit</a> æ’ä»¶å¯ä»¥é˜»æ­¢æˆ–å»¶è¿Ÿ Pod çš„ç»‘å®š</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl>	<span class=c1>// Run &#34;permit&#34; plugins.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>runPermitStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPermitPlugins</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>IsWait</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>reason</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>reason</span> <span class=p>=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>reason</span> <span class=p>=</span> <span class=nx>SchedulerError</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// åªè¦å…¶ä¸­ä¸€ä¸ªæ’ä»¶è¿”å›çš„çŠ¶æ€ä¸æ˜¯ success æˆ–è€… wait
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ä»cacheä¸­å¿˜æ‰pod
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;Scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>runPermitStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=binding-cycle>Binding Cycle<a hidden class=anchor aria-hidden=true href=#binding-cycle>#</a></h3><p>åœ¨é€‰æ‹©å¥½ <em>FN</em> ååˆ™åšä¸€ä¸ªå‡è®¾ç»‘å®šï¼Œå¹¶æ›´æ–°åˆ°cacheä¸­ï¼Œæ¥ä¸‹æ¥å›å»æ‰§è¡ŒçœŸæ­£çš„bindæ“ä½œï¼Œä¹Ÿå°±æ˜¯ <code>binding cycle</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>    <span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=c1>// binding cycle æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œï¼Œè¿™é‡Œè¡¨ç°å°±æ˜¯goåç¨‹
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithCancel</span><span class=p>(</span><span class=nx>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>Binding</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerGoroutines</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nx>Binding</span><span class=p>).</span><span class=nf>Dec</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// è¿è¡ŒWaitOnPermitæ’ä»¶ï¼Œå¦‚æœå¤±è´¥åˆ™ï¼ŒunReserveå›æ»š
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>waitOnPermitStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>WaitOnPermit</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>waitOnPermitStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=kd>var</span> <span class=nx>reason</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>waitOnPermitStatus</span><span class=p>.</span><span class=nf>IsUnschedulable</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=nx>reason</span> <span class=p>=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>				<span class=nx>reason</span> <span class=p>=</span> <span class=nx>SchedulerError</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// trigger un-reserve plugins to clean up state associated with the reserved Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// &#34;Forget&#34;ing an assumed Pod in binding cycle should be treated as a PodDelete event,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// as the assumed Pod had occupied a certain amount of resources in scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// TODO(#103853): de-duplicate the logic.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// Avoid moving the assumed Pod itself as it&#39;s always Unschedulable.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// It&#39;s intentional to &#34;defer&#34; this operation; otherwise MoveAllToActiveOrBackoffQueue() would
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// update `q.moveRequest` and thus move the assumed pod to backoffQ anyways.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>defer</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>internalqueue</span><span class=p>.</span><span class=nx>AssignedPodDelete</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>pod</span> <span class=o>*</span><span class=nx>v1</span><span class=p>.</span><span class=nx>Pod</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>return</span> <span class=nx>assumedPod</span><span class=p>.</span><span class=nx>UID</span> <span class=o>!=</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>UID</span>
</span></span><span class=line><span class=cl>				<span class=p>})</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>waitOnPermitStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>reason</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// è¿è¡ŒPrebind æ’ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>preBindStatus</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPreBindPlugins</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>preBindStatus</span><span class=p>.</span><span class=nf>IsSuccess</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=c1>// trigger un-reserve plugins to clean up state associated with the reserved Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>forgetErr</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>forgetErr</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>forgetErr</span><span class=p>,</span> <span class=s>&#34;scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// &#34;Forget&#34;ing an assumed Pod in binding cycle should be treated as a PodDelete event,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// as the assumed Pod had occupied a certain amount of resources in scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// TODO(#103853): de-duplicate the logic.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>internalqueue</span><span class=p>.</span><span class=nx>AssignedPodDelete</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>preBindStatus</span><span class=p>.</span><span class=nf>AsError</span><span class=p>(),</span> <span class=nx>SchedulerError</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// bindæ˜¯çœŸæ­£çš„ç»‘å®šæ“ä½œ
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>bind</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>,</span> <span class=nx>state</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=c1>// å¦‚æœå¤±è´¥äº†å°±è§¦å‘ un-reserve plugins 
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunReservePluginsUnreserve</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nx>Cache</span><span class=p>.</span><span class=nf>ForgetPod</span><span class=p>(</span><span class=nx>assumedPod</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;scheduler cache ForgetPod failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// &#34;Forget&#34;ing an assumed Pod in binding cycle should be treated as a PodDelete event,
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// as the assumed Pod had occupied a certain amount of resources in scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// TODO(#103853): de-duplicate the logic.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>MoveAllToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>internalqueue</span><span class=p>.</span><span class=nx>AssignedPodDelete</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>assumedPodInfo</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;binding rejected: %w&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>),</span> <span class=nx>SchedulerError</span><span class=p>,</span> <span class=nx>clearNominatedNode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Calculating nodeResourceString can be heavy. Avoid it if klog verbosity is below 2.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Successfully bound pod to node&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>,</span> <span class=s>&#34;evaluatedNodes&#34;</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>EvaluatedNodes</span><span class=p>,</span> <span class=s>&#34;feasibleNodes&#34;</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>FeasibleNodes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduled</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>PodSchedulingAttempts</span><span class=p>.</span><span class=nf>Observe</span><span class=p>(</span><span class=nb>float64</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>PodSchedulingDuration</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=nf>getAttemptsLabel</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>)).</span><span class=nf>Observe</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>.</span><span class=nx>InitialAttemptTimestamp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// è¿è¡Œ &#34;postbind&#34; æ’ä»¶
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// æ˜¯é€šçŸ¥æ€§çš„æ‰©å±•ç‚¹ï¼Œè¯¥æ’ä»¶åœ¨ç»‘å®š Pod åè°ƒç”¨ï¼Œå¯ç”¨äºæ¸…ç†ç›¸å…³èµ„æºï¼ˆï¼‰ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostBindPlugins</span><span class=p>(</span><span class=nx>bindingCycleCtx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>assumedPod</span><span class=p>,</span> <span class=nx>scheduleResult</span><span class=p>.</span><span class=nx>SuggestedHost</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// At the end of a successful binding cycle, move up Pods if needed.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>podsToActivate</span><span class=p>.</span><span class=nx>Map</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>sched</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>.</span><span class=nf>Activate</span><span class=p>(</span><span class=nx>podsToActivate</span><span class=p>.</span><span class=nx>Map</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Unlike the logic in scheduling cycle, we don&#39;t bother deleting the entries
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// as `podsToActivate.Map` is no longer consumed.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­çš„å¤±è´¥æµç¨‹>è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­çš„å¤±è´¥æµç¨‹<a hidden class=anchor aria-hidden=true href=#è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­çš„å¤±è´¥æµç¨‹>#</a></h2><p>ä¸Šé¢è¯´åˆ°çš„éƒ½æ˜¯æ­£å¸¸çš„è¯·æ±‚ï¼Œä¸‹é¢ä¼šå¯¹å¤±è´¥çš„è¯·æ±‚æ˜¯å¦‚ä½•é‡è¯•çš„è¿›è¡Œåˆ†æï¼Œè€Œ <em>scheduler</em> ä¸­å…³äºå¤±è´¥å¤„ç†æ–¹é¢ç›¸å…³çš„å±æ€§ä¼šæ¶‰åŠåˆ°ä¸Šé¢ <em>scheduler</em> ç»“æ„ä¸­çš„ <code>backoffQ</code> ä¸ <code>unschedulablePods</code></p><ul><li><code>backoffQ</code>ï¼šä¹Ÿæ˜¯ä¸€ä¸ª <em>heap</em> ç±»å‹çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå­˜æ”¾çš„æ˜¯ä¸å¯è°ƒåº¦çš„Pod</li><li><code>unschedulablePods </code>ï¼šä¿å­˜ç¡®å®šä¸å¯è¢«è°ƒåº¦çš„Podï¼Œä¸€ä¸ªmapç±»å‹</li></ul><p>backoffQ ä¸ unschedulablePods ä¼šåœ¨åˆå§‹åŒ– <em>scheduler</em> æ—¶åˆå§‹åŒ–ï¼Œ</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewPriorityQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=nx>lessFn</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>LessFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>informerFactory</span> <span class=nx>informers</span><span class=p>.</span><span class=nx>SharedInformerFactory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>opts</span> <span class=o>...</span><span class=nx>Option</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span><span class=nx>PriorityQueue</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>options</span> <span class=o>:=</span> <span class=nx>defaultPriorityQueueOptions</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>opt</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>opts</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>opt</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>comp</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>(</span><span class=nx>podInfo1</span><span class=p>,</span> <span class=nx>podInfo2</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo1</span> <span class=o>:=</span> <span class=nx>podInfo1</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>pInfo2</span> <span class=o>:=</span> <span class=nx>podInfo2</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nf>lessFn</span><span class=p>(</span><span class=nx>pInfo1</span><span class=p>,</span> <span class=nx>pInfo2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span> <span class=p>=</span> <span class=nf>NewPodNominator</span><span class=p>(</span><span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>().</span><span class=nf>Lister</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>PriorityQueue</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>PodNominator</span><span class=p>:</span>                      <span class=nx>options</span><span class=p>.</span><span class=nx>podNominator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clock</span><span class=p>:</span>                             <span class=nx>options</span><span class=p>.</span><span class=nx>clock</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>stop</span><span class=p>:</span>                              <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>podInitialBackoffDuration</span><span class=p>:</span>         <span class=nx>options</span><span class=p>.</span><span class=nx>podInitialBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxBackoffDuration</span><span class=p>:</span>             <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>:</span> <span class=nx>options</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>activeQ</span><span class=p>:</span>                           <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>comp</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewActivePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>unschedulablePods</span><span class=p>:</span>                 <span class=nf>newUnschedulablePods</span><span class=p>(</span><span class=nx>metrics</span><span class=p>.</span><span class=nf>NewUnschedulablePodsRecorder</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>moveRequestCycle</span><span class=p>:</span>                  <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>clusterEventMap</span><span class=p>:</span>                   <span class=nx>options</span><span class=p>.</span><span class=nx>clusterEventMap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>pq</span><span class=p>.</span><span class=nx>lock</span>
</span></span><span class=line><span class=cl>    <span class=c1>// åˆå§‹åŒ–backoffQ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// NewWithRecorderä½œä¸ºä¸€ä¸ªå¯é€‰çš„ metricRecorder çš„ Heap å¯¹è±¡ã€‚
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// podInfoKeyFuncæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›é”™è¯¯ä¸å­—ç¬¦ä¸²
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// pq.podsCompareBackoffCompleted æ¯”è¾ƒä¸¤ä¸ªpodçš„å›é€€æ—¶é—´ï¼Œå¦‚æœç¬¬ä¸€ä¸ªåœ¨ç¬¬äºŒä¸ªä¹‹å‰ä¸ºtrueï¼Œ
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// åä¹‹ false
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pq</span><span class=p>.</span><span class=nx>podBackoffQ</span> <span class=p>=</span> <span class=nx>heap</span><span class=p>.</span><span class=nf>NewWithRecorder</span><span class=p>(</span><span class=nx>podInfoKeyFunc</span><span class=p>,</span> <span class=nx>pq</span><span class=p>.</span><span class=nx>podsCompareBackoffCompleted</span><span class=p>,</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>NewBackoffPodsRecorder</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>pq</span><span class=p>.</span><span class=nx>nsLister</span> <span class=p>=</span> <span class=nx>informerFactory</span><span class=p>.</span><span class=nf>Core</span><span class=p>().</span><span class=nf>V1</span><span class=p>().</span><span class=nf>Namespaces</span><span class=p>().</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>pq</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>å¯¹äºåˆå§‹åŒ– backoffQ ä¼šäº§ç”Ÿçš„ä¸¤ä¸ªå‡½æ•°ï¼Œ<a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L757-L761 target=_blank rel="noopener nofollow noreferrer">getBackoffTime</a> ä¸ <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L765-L775 target=_blank rel="noopener nofollow noreferrer">calculateBackoffDuration</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// getBackoffTime returns the time that podInfo completes backoff
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>getBackoffTime</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>duration</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>calculateBackoffDuration</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>backoffTime</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>backoffTime</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// calculateBackoffDuration is a helper function for calculating the backoffDuration
</span></span></span><span class=line><span class=cl><span class=c1>// based on the number of attempts the pod has made.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>calculateBackoffDuration</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>)</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>duration</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podInitialBackoffDuration</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Attempts</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Use subtraction instead of addition or multiplication to avoid overflow.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>duration</span> <span class=p>&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span><span class=o>-</span><span class=nx>duration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxBackoffDuration</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>duration</span> <span class=o>+=</span> <span class=nx>duration</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>duration</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>å¯¹äºæ•´ä¸ªæ•…éšœé”™è¯¯ä¼šæŒ‰ç…§å¦‚ä¸‹æµç¨‹è¿›è¡Œï¼Œåœ¨åˆå§‹åŒ– <em>scheduler</em> ä¼šæ³¨å†Œä¸€ä¸ª Error å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ç”¨ä½œå¯¹ä¸å¯è°ƒåº¦Podè¿›è¡Œå¤„ç†ï¼Œå®é™…ä¸Šè¢«æ³¨å†Œçš„å‡½æ•°æ˜¯ MakeDefaultErrorFuncã€‚è¿™ä¸ªå‡½æ•°å°†ä½œä¸º Error å‡½æ•°è¢«è°ƒç”¨ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>sched</span> <span class=o>:=</span> <span class=nf>newScheduler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>schedulerCache</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>extenders</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>internalqueue</span><span class=p>.</span><span class=nf>MakeNextPodFunc</span><span class=p>(</span><span class=nx>podQueue</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nf>MakeDefaultErrorFunc</span><span class=p>(</span><span class=nx>client</span><span class=p>,</span> <span class=nx>podLister</span><span class=p>,</span> <span class=nx>podQueue</span><span class=p>,</span> <span class=nx>schedulerCache</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>stopEverything</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>podQueue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>profiles</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>snapshot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>options</span><span class=p>.</span><span class=nx>percentageOfNodesToScore</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>è€Œåœ¨ è°ƒåº¦å‘¨æœŸä¸­ï¼Œä¹Ÿå°±æ˜¯ <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L66-L132 target=_blank rel="noopener nofollow noreferrer">scheduleOne</a> å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªæ‰©å±•ç‚¹æ“ä½œå¤±è´¥åéƒ½ä¼šè°ƒç”¨ <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/schedule_one.go#L812-L834 target=_blank rel="noopener nofollow noreferrer">handleSchedulingFailure</a> è€Œè¯¥å‡½æ•°ï¼Œä½¿ç”¨äº†æ³¨å†Œçš„ <em>Error</em> å‡½æ•°æ¥å¤„ç†Pod</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>sched</span> <span class=o>*</span><span class=nx>Scheduler</span><span class=p>)</span> <span class=nf>scheduleOne</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>scheduleResult</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>sched</span><span class=p>.</span><span class=nf>SchedulePod</span><span class=p>(</span><span class=nx>schedulingCycleCtx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>nominatingInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>fitError</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>HasPostFilterPlugins</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;No PostFilter plugins are registered, so no preemption will be performed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			
</span></span><span class=line><span class=cl>				<span class=nx>result</span><span class=p>,</span> <span class=nx>status</span> <span class=o>:=</span> <span class=nx>fwk</span><span class=p>.</span><span class=nf>RunPostFilterPlugins</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>state</span><span class=p>,</span> <span class=nx>pod</span><span class=p>,</span> <span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>NodeToStatusMap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Code</span><span class=p>()</span> <span class=o>==</span> <span class=nx>framework</span><span class=p>.</span><span class=nx>Error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=kc>nil</span><span class=p>,</span> <span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>PostFilterMsg</span> <span class=p>=</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Message</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>5</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Status after running PostFilter plugins for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;status&#34;</span><span class=p>,</span> <span class=nx>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>result</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>NominatingInfo</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ErrNoNodesAvailable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=c1>// No nodes available is counted as unschedulable rather than an error.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodUnschedulable</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>nominatingInfo</span> <span class=p>=</span> <span class=nx>clearNominatedNode</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error selecting node for pod&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=nx>metrics</span><span class=p>.</span><span class=nf>PodScheduleError</span><span class=p>(</span><span class=nx>fwk</span><span class=p>.</span><span class=nf>ProfileName</span><span class=p>(),</span> <span class=nx>metrics</span><span class=p>.</span><span class=nf>SinceInSeconds</span><span class=p>(</span><span class=nx>start</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¤„ç†ä¸å¯è°ƒåº¦Pod
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>sched</span><span class=p>.</span><span class=nf>handleSchedulingFailure</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=nx>fwk</span><span class=p>,</span> <span class=nx>podInfo</span><span class=p>,</span> <span class=nx>err</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>PodReasonUnschedulable</span><span class=p>,</span> <span class=nx>nominatingInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>æ¥åˆ°äº†æ³¨å†Œçš„ <em>Error</em> å‡½æ•° <code>MakeDefaultErrorFunc</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>MakeDefaultErrorFunc</span><span class=p>(</span><span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>podLister</span> <span class=nx>corelisters</span><span class=p>.</span><span class=nx>PodLister</span><span class=p>,</span> <span class=nx>podQueue</span> <span class=nx>internalqueue</span><span class=p>.</span><span class=nx>SchedulingQueue</span><span class=p>,</span> <span class=nx>schedulerCache</span> <span class=nx>internalcache</span><span class=p>.</span><span class=nx>Cache</span><span class=p>)</span> <span class=kd>func</span><span class=p>(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>(</span><span class=nx>podInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>podInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>ErrNoNodesAvailable</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Unable to schedule pod; no nodes are registered to the cluster; waiting&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>fitError</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>FitError</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Inject UnschedulablePlugins to PodInfo, which will be used later for moving Pods between queues efficiently.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>podInfo</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span> <span class=p>=</span> <span class=nx>fitError</span><span class=p>.</span><span class=nx>Diagnosis</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Unable to schedule pod; no fit; waiting&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>apierrors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Unable to schedule pod, possibly due to node not found; waiting&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>errStatus</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>err</span><span class=p>.(</span><span class=nx>apierrors</span><span class=p>.</span><span class=nx>APIStatus</span><span class=p>);</span> <span class=nx>ok</span> <span class=o>&amp;&amp;</span> <span class=nx>errStatus</span><span class=p>.</span><span class=nf>Status</span><span class=p>().</span><span class=nx>Details</span><span class=p>.</span><span class=nx>Kind</span> <span class=o>==</span> <span class=s>&#34;node&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>nodeName</span> <span class=o>:=</span> <span class=nx>errStatus</span><span class=p>.</span><span class=nf>Status</span><span class=p>().</span><span class=nx>Details</span><span class=p>.</span><span class=nx>Name</span>
</span></span><span class=line><span class=cl>				<span class=c1>// when node is not found, We do not remove the node right away. Trying again to get
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// the node and if the node is still not found, then remove it from the scheduler cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>client</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>Nodes</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>nodeName</span><span class=p>,</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>GetOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>apierrors</span><span class=p>.</span><span class=nf>IsNotFound</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>node</span> <span class=o>:=</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>Node</span><span class=p>{</span><span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>nodeName</span><span class=p>}}</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>schedulerCache</span><span class=p>.</span><span class=nf>RemoveNode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>node</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Node is not found; failed to remove it from the cache&#34;</span><span class=p>,</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error scheduling pod; retrying&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Check if the Pod exists in informer cache.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>cachedPod</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>podLister</span><span class=p>.</span><span class=nf>Pods</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Namespace</span><span class=p>).</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Pod doesn&#39;t exist in informer cache&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;err&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// In the case of extender, the pod may have been bound successfully, but timed out returning its response to the scheduler.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// It could result in the live version to carry .spec.nodeName, and that&#39;s inconsistent with the internal-queued version.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>cachedPod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>InfoS</span><span class=p>(</span><span class=s>&#34;Pod has been assigned to node. Abort adding it back to queue.&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>),</span> <span class=s>&#34;node&#34;</span><span class=p>,</span> <span class=nx>cachedPod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>NodeName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// As &lt;cachedPod&gt; is from SharedInformer, we need to do a DeepCopy() here.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>podInfo</span><span class=p>.</span><span class=nx>PodInfo</span> <span class=p>=</span> <span class=nx>framework</span><span class=p>.</span><span class=nf>NewPodInfo</span><span class=p>(</span><span class=nx>cachedPod</span><span class=p>.</span><span class=nf>DeepCopy</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=c1>// æ·»åŠ åˆ°unschedulableé˜Ÿåˆ—ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>podQueue</span><span class=p>.</span><span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>podInfo</span><span class=p>,</span> <span class=nx>podQueue</span><span class=p>.</span><span class=nf>SchedulingCycle</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Error occurred&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>ä¸‹é¢æ¥åˆ° <code>AddUnschedulableIfNotPresent</code> ï¼Œè¿™ä¸ªä¹Ÿæ˜¯æ“ä½œ <code>backoffQ</code> å’Œ <code>unschedulablePods </code>çš„çœŸæ­£çš„åŠ¨ä½œ</p><p><code>AddUnschedulableIfNotPresent</code> å‡½æ•°ä¼šå§æ— æ³•è°ƒåº¦çš„ pod æ’å…¥é˜Ÿåˆ—ï¼Œé™¤éå®ƒå·²ç»åœ¨é˜Ÿåˆ—ä¸­ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œ<code>PriorityQueue</code> å°†ä¸å¯è°ƒåº¦çš„ Pod æ”¾åœ¨ <code>unschedulablePods</code> ä¸­ã€‚ä½†å¦‚æœæœ€è¿‘æœ‰ move requestï¼Œåˆ™å°† pod æ”¾å…¥ <code>podBackoffQ</code> ä¸­ã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>AddUnschedulableIfNotPresent</span><span class=p>(</span><span class=nx>pInfo</span> <span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>,</span> <span class=nx>podSchedulingCycle</span> <span class=kt>int64</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœå·²ç»å­˜åœ¨åˆ™ä¸æ·»åŠ 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>get</span><span class=p>(</span><span class=nx>pod</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in unschedulable queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// æ£€æŸ¥æ˜¯å¦åœ¨activeQä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in the active queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// æ£€æŸ¥æ˜¯å¦åœ¨podBackoffQä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exists</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Get</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;Pod %v is already present in the backoff queue&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// åœ¨é‡æ–°æ·»åŠ æ—¶ï¼Œä¼šåˆ·æ–° Podæ—¶é—´ä¸ºæœ€æ–°æ“ä½œçš„æ—¶é—´
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>pInfo</span><span class=p>.</span><span class=nx>Timestamp</span> <span class=p>=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>plugin</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>UnschedulablePlugins</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nf>UnschedulableReason</span><span class=p>(</span><span class=nx>plugin</span><span class=p>,</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Pod</span><span class=p>.</span><span class=nx>Spec</span><span class=p>.</span><span class=nx>SchedulerName</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// å¦‚æœæ¥å—åˆ°move requesté‚£ä¹ˆåˆ™æ”¾å…¥BackoffQ
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>p</span><span class=p>.</span><span class=nx>moveRequestCycle</span> <span class=o>&gt;=</span> <span class=nx>podSchedulingCycle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;error adding pod %v to the backoff queue: %v&#34;</span><span class=p>,</span> <span class=nx>pod</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;backoff&#34;</span><span class=p>,</span> <span class=nx>ScheduleAttemptFailure</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// å¦åˆ™å°†æ”¾å…¥åˆ° unschedulablePods
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nf>addOrUpdate</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;unschedulable&#34;</span><span class=p>,</span> <span class=nx>ScheduleAttemptFailure</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>PodNominator</span><span class=p>.</span><span class=nf>AddNominatedPod</span><span class=p>(</span><span class=nx>pInfo</span><span class=p>.</span><span class=nx>PodInfo</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>åœ¨å¯åŠ¨ <em>scheduler</em> æ—¶ï¼Œä¼šå°†è¿™ä¸¤ä¸ªé˜Ÿåˆ—å¼‚æ­¥å¯ç”¨ä¸¤ä¸ªloopæ¥æ“ä½œé˜Ÿåˆ—ã€‚è¡¨ç°åœ¨ <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L292-L295 target=_blank rel="noopener nofollow noreferrer">Run()</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>Run</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>flushBackoffQCompleted</span><span class=p>,</span> <span class=mf>1.0</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>flushUnschedulablePodsLeftover</span><span class=p>,</span> <span class=mi>30</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>p</span><span class=p>.</span><span class=nx>stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>å¯ä»¥çœ‹åˆ° <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L431-L458 target=_blank rel="noopener nofollow noreferrer">flushBackoffQCompleted</a> ä½œä¸º <code>BackoffQ</code> å®ç°ï¼›è€Œ <a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/pkg/scheduler/internal/queue/scheduling_queue.go#L462-L478 target=_blank rel="noopener nofollow noreferrer">flushUnschedulablePodsLeftover</a> ä½œä¸º <code>UnschedulablePods</code> å®ç°ã€‚</p><p><code>flushBackoffQCompleted</code> æ˜¯ç”¨äºå°†æ‰€æœ‰å·²å®Œæˆå›é€€çš„ pod ä» <code>backoffQ</code> ç§»åˆ° <code>activeQ</code> ä¸­</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>flushBackoffQCompleted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>broadcast</span> <span class=o>:=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span> <span class=c1>// è¿™å°±æ˜¯heapå®ç°çš„æ–¹æ³•ï¼Œçª¥è§†ä¸‹ï¼Œä½†ä¸å¼¹å‡º
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>rawPodInfo</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Peek</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>rawPodInfo</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>pod</span> <span class=o>:=</span> <span class=nx>rawPodInfo</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>).</span><span class=nx>Pod</span>
</span></span><span class=line><span class=cl>		<span class=nx>boTime</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nf>getBackoffTime</span><span class=p>(</span><span class=nx>rawPodInfo</span><span class=p>.(</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>boTime</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podBackoffQ</span><span class=p>.</span><span class=nf>Pop</span><span class=p>()</span> <span class=c1>// å¼¹å‡ºä¸€ä¸ª
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>ErrorS</span><span class=p>(</span><span class=nx>err</span><span class=p>,</span> <span class=s>&#34;Unable to pop pod from backoff queue despite backoff completion&#34;</span><span class=p>,</span> <span class=s>&#34;pod&#34;</span><span class=p>,</span> <span class=nx>klog</span><span class=p>.</span><span class=nf>KObj</span><span class=p>(</span><span class=nx>pod</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>activeQ</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>rawPodInfo</span><span class=p>)</span> <span class=c1>// æ”¾å…¥åˆ°æ´»åŠ¨é˜Ÿåˆ—ä¸­
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>metrics</span><span class=p>.</span><span class=nx>SchedulerQueueIncomingPods</span><span class=p>.</span><span class=nf>WithLabelValues</span><span class=p>(</span><span class=s>&#34;active&#34;</span><span class=p>,</span> <span class=nx>BackoffComplete</span><span class=p>).</span><span class=nf>Inc</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>broadcast</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>broadcast</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>flushUnschedulablePodsLeftover </code>å‡½æ•°ç”¨äºå°†åœ¨ <code>unschedulablePods</code> ä¸­çš„å­˜æ”¾æ—¶é—´è¶…è¿‡ <code>podMaxInUnschedulablePodsDuration</code> å€¼çš„ pod ç§»åŠ¨åˆ° <code>backoffQ</code> æˆ– <code>activeQ</code> ä¸­ã€‚</p><p><code>podMaxInUnschedulablePodsDuration</code> ä¼šæ ¹æ®é…ç½®ä¼ å…¥ï¼Œå½“æ²¡æœ‰ä¼ å…¥ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº† <em><a href=https://github.com/kubernetes/kubernetes/blob/32c483ea6ee90a3a81f382563c91034470af8a4a/cmd/kube-scheduler/app/options/options.go#L77-L84 target=_blank rel="noopener nofollow noreferrer">Deprecated</a></em> é‚£ä¹ˆä¼šä¸º5åˆ†é’Ÿã€‚</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewOptions</span><span class=p>()</span> <span class=o>*</span><span class=nx>Options</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>o</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Options</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>SecureServing</span><span class=p>:</span>  <span class=nx>apiserveroptions</span><span class=p>.</span><span class=nf>NewSecureServingOptions</span><span class=p>().</span><span class=nf>WithLoopback</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Authentication</span><span class=p>:</span> <span class=nx>apiserveroptions</span><span class=p>.</span><span class=nf>NewDelegatingAuthenticationOptions</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Authorization</span><span class=p>:</span>  <span class=nx>apiserveroptions</span><span class=p>.</span><span class=nf>NewDelegatingAuthorizationOptions</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>		<span class=nx>Deprecated</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>DeprecatedOptions</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>PodMaxInUnschedulablePodsDuration</span><span class=p>:</span> <span class=mi>5</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span></span></span></code></pre></td></tr></table></div></div></div></div><p>å¯¹äº <code>flushUnschedulablePodsLeftover </code>å°±æ˜¯åšä¸€ä¸ªæ—¶é—´å¯¹æ¯”ï¼Œç„¶åæ·»åŠ åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>PriorityQueue</span><span class=p>)</span> <span class=nf>flushUnschedulablePodsLeftover</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>p</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>podsToMove</span> <span class=p>[]</span><span class=o>*</span><span class=nx>framework</span><span class=p>.</span><span class=nx>QueuedPodInfo</span>
</span></span><span class=line><span class=cl>	<span class=nx>currentTime</span> <span class=o>:=</span> <span class=nx>p</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>pInfo</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>p</span><span class=p>.</span><span class=nx>unschedulablePods</span><span class=p>.</span><span class=nx>podInfoMap</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>lastScheduleTime</span> <span class=o>:=</span> <span class=nx>pInfo</span><span class=p>.</span><span class=nx>Timestamp</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>currentTime</span><span class=p>.</span><span class=nf>Sub</span><span class=p>(</span><span class=nx>lastScheduleTime</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nx>p</span><span class=p>.</span><span class=nx>podMaxInUnschedulablePodsDuration</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>podsToMove</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>,</span> <span class=nx>pInfo</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>p</span><span class=p>.</span><span class=nf>movePodsToActiveOrBackoffQueue</span><span class=p>(</span><span class=nx>podsToMove</span><span class=p>,</span> <span class=nx>UnschedulableTimeout</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=æ€»ç»“è°ƒåº¦ä¸Šä¸‹æ–‡æµç¨‹>æ€»ç»“è°ƒåº¦ä¸Šä¸‹æ–‡æµç¨‹<a hidden class=anchor aria-hidden=true href=#æ€»ç»“è°ƒåº¦ä¸Šä¸‹æ–‡æµç¨‹>#</a></h2><ul><li>åœ¨æ„å»ºä¸€ä¸ª <em>scheduler</em> æ—¶ç»å†å¦‚ä¸‹æ­¥éª¤ï¼š<ul><li>å‡†å¤‡cacheï¼Œinformerï¼Œqueueï¼Œé”™è¯¯å¤„ç†å‡½æ•°ç­‰</li><li>æ·»åŠ äº‹ä»¶å‡½æ•°ï¼Œä¼šç›‘å¬èµ„æºï¼ˆå¦‚Podï¼‰ï¼Œå½“æœ‰å˜åŠ¨åˆ™è§¦å‘å¯¹åº”äº‹ä»¶å‡½æ•°ï¼Œè¿™æ˜¯å…¥ç«™ <code>activeQ</code></li></ul></li><li>æ„å»ºå®Œæˆåä¼š runï¼Œrunæ—¶ä¼šrunä¸€ä¸ª <code>SchedulingQueue</code>ï¼Œè¿™ä¸ªæ˜¯ä½œä¸ºä¸å¯è°ƒåº¦é˜Ÿåˆ—<ul><li><code>BackoffQ</code></li><li><code>UnschedulablePods</code></li><li>ä¸å¯è°ƒåº¦é˜Ÿåˆ—ä¼šæ ¹æ®æ³¨å†Œæ—¶å®šæœŸæ¶ˆè´¹é˜Ÿåˆ—ä¸­Podå°†å…¶æ·»åŠ åˆ° <code>activeQ</code> ä¸­</li></ul></li><li>å¯åŠ¨ä¸€ä¸ª <code>scheduleOne</code> çš„loopï¼Œè¿™ä¸ªæ˜¯è°ƒåº¦ä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„æ‰©å±•ç‚¹çš„æ‰§è¡Œï¼Œä¹Ÿæ˜¯ <code>activeQ</code> çš„æ¶ˆè´¹ç«¯<ul><li><code>scheduleOne</code> è·å– pod</li><li>æ‰§è¡Œå„ä¸ªæ‰©å±•ç‚¹ï¼Œå¦‚æœå‡ºé”™åˆ™ <em>Error</em> å‡½æ•° <code>MakeDefaultErrorFunc</code> å°†å…¶æ·»åŠ åˆ°ä¸å¯è°ƒåº¦é˜Ÿåˆ—ä¸­</li><li>å›åˆ°ä¸å¯è°ƒåº¦é˜Ÿåˆ—ä¸­æ¶ˆè´¹éƒ¨åˆ†</li></ul></li></ul><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><blockquote><p><sup id=1>[1]</sup> <a href=https://www.sobyte.net/post/2022-02/kubernetes-scheduling-framework-and-extender/ target=_blank rel="noopener nofollow noreferrer">kubernetes scheduler extender</a></p></blockquote></div><div class=pe-copyright><hr><blockquote><p>æœ¬æ–‡ä¸ºåŸåˆ›å†…å®¹ï¼Œç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ã€‚å¦‚éœ€è½¬è½½ï¼Œè¯·åœ¨æ–‡ç« ä¸­å£°æ˜æœ¬æ–‡æ ‡é¢˜åŠé“¾æ¥ã€‚</p><p>æ–‡ç« æ ‡é¢˜ï¼škube-schedulerçš„è°ƒåº¦ä¸Šä¸‹æ–‡</p><p>æ–‡ç« é“¾æ¥ï¼š<a href=https://www.oomkill.com/2022/07/ch20-schedule-workflow/ target=_blank>https://www.oomkill.com/2022/07/ch20-schedule-workflow/</a></p><p>è®¸å¯åè®®ï¼š<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>ç›¸å…³é˜…è¯»</h3><ul class=relatedContent><li><a href=/2022/07/ch16-scheduler/><span>kubernetesçš„å†³ç­–ç»„ä»¶ - kube-scheduleråŸç†åˆ†æ</span></a></li><li><a href=/2022/07/ch33-admission-webhook/><span>æ·±å…¥ç†è§£Kubernetes 4A - Admission Controlæºç è§£æ</span></a></li><li><a href=/2022/06/ch27-leader-election/><span>æºç åˆ†æKubernetes HAæœºåˆ¶ - leader election</span></a></li><li><a href=/2022/06/ch15-controller-runtime/><span>æºç åˆ†æKubernetes controllerç»„ä»¶ - controller-runtime</span></a></li><li><a href=/2022/06/ch04-apiserver-aggregation/><span>æ‰©å±•Kubernetes APIçš„å¦ä¸€ç§æ–¹å¼ - APIServer aggregation</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/07/ch21-scheduling-algorithm/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>å¦‚ä½•ç†è§£kubernetesè°ƒåº¦æ¡†æ¶ä¸æ’ä»¶ï¼Ÿ</span>
</a><a class=next href=https://www.oomkill.com/2022/07/ch16-scheduler/><span class=title></span>
<span>kubernetesçš„å†³ç­–ç»„ä»¶ - kube-scheduleråŸç†åˆ†æ&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch20 Schedule workflow","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>