<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Kubernetes组件核心 - client-go | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop,client-go"><meta name=description content='Prepare Introduction 从2016年8月起，Kubernetes官方提取了与Kubernetes相关的核心源代码，形成了一个独立的项目，即client-go，作为官方提供的go客户端。Kubernetes的部分代码也是基于这个项目的。
client-go 是kubernetes中广义的客户端基础库，在Kubernetes各个组件中或多或少都有使用其功能。。也就是说，client-go可以在kubernetes集群中添加、删除和查询资源对象（包括deployment、service、pod、ns等）。
在了解client-go前，还需要掌握一些概念
在客户端验证 API 使用证书和使用令牌，来验证客户端 kubernetes集群的访问模式 使用证书和令牌来验证客户端 在访问apiserver时，会对访问者进行鉴权，因为是https请求，在请求时是需要ca的，也可以使用 -k 使用insecure模式
text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 $ curl --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.4:6443/version \{ "major": "1", "minor": "18+", "gitVersion": "v1.18.20-dirty", "gitCommit": "1f3e19b7beb1cc0110255668c4238ed63dadb7ad", "gitTreeState": "dirty", "buildDate": "2022-05-17T12:45:14Z", "goVersion": "go1.16.15", "compiler": "gc", "platform": "linux/amd64" } $ curl -k https://10.'><meta name=author content="cylon"><link rel=canonical href=https://www.oomkill.com/2022/05/ch06-client-go/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://www.oomkill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.oomkill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.oomkill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://www.oomkill.com/favicon.ico><link rel=mask-icon href=https://www.oomkill.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://www.oomkill.com/2022/05/ch06-client-go/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="Kubernetes组件核心 - client-go"><meta property="og:description" content='Prepare Introduction 从2016年8月起，Kubernetes官方提取了与Kubernetes相关的核心源代码，形成了一个独立的项目，即client-go，作为官方提供的go客户端。Kubernetes的部分代码也是基于这个项目的。
client-go 是kubernetes中广义的客户端基础库，在Kubernetes各个组件中或多或少都有使用其功能。。也就是说，client-go可以在kubernetes集群中添加、删除和查询资源对象（包括deployment、service、pod、ns等）。
在了解client-go前，还需要掌握一些概念
在客户端验证 API 使用证书和使用令牌，来验证客户端 kubernetes集群的访问模式 使用证书和令牌来验证客户端 在访问apiserver时，会对访问者进行鉴权，因为是https请求，在请求时是需要ca的，也可以使用 -k 使用insecure模式
text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 $ curl --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.4:6443/version \{ "major": "1", "minor": "18+", "gitVersion": "v1.18.20-dirty", "gitCommit": "1f3e19b7beb1cc0110255668c4238ed63dadb7ad", "gitTreeState": "dirty", "buildDate": "2022-05-17T12:45:14Z", "goVersion": "go1.16.15", "compiler": "gc", "platform": "linux/amd64" } $ curl -k https://10.'><meta property="og:type" content="article"><meta property="og:url" content="https://www.oomkill.com/2022/05/ch06-client-go/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-18T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes组件核心 - client-go"><meta name=twitter:description content='Prepare Introduction 从2016年8月起，Kubernetes官方提取了与Kubernetes相关的核心源代码，形成了一个独立的项目，即client-go，作为官方提供的go客户端。Kubernetes的部分代码也是基于这个项目的。
client-go 是kubernetes中广义的客户端基础库，在Kubernetes各个组件中或多或少都有使用其功能。。也就是说，client-go可以在kubernetes集群中添加、删除和查询资源对象（包括deployment、service、pod、ns等）。
在了解client-go前，还需要掌握一些概念
在客户端验证 API 使用证书和使用令牌，来验证客户端 kubernetes集群的访问模式 使用证书和令牌来验证客户端 在访问apiserver时，会对访问者进行鉴权，因为是https请求，在请求时是需要ca的，也可以使用 -k 使用insecure模式
text 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 $ curl --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.4:6443/version \{ "major": "1", "minor": "18+", "gitVersion": "v1.18.20-dirty", "gitCommit": "1f3e19b7beb1cc0110255668c4238ed63dadb7ad", "gitTreeState": "dirty", "buildDate": "2022-05-17T12:45:14Z", "goVersion": "go1.16.15", "compiler": "gc", "platform": "linux/amd64" } $ curl -k https://10.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.oomkill.com/posts/"},{"@type":"ListItem","position":2,"name":"Kubernetes组件核心 - client-go","item":"https://www.oomkill.com/2022/05/ch06-client-go/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes组件核心 - client-go","name":"Kubernetes组件核心 - client-go","description":"Prepare Introduction 从2016年8月起，Kubernetes官方提取了与Kubernetes相关的核心源代码，形成了一个独立的项目，即client-go，作为官方提供的go客户端。Kubernetes的部分代码也是基于这个项目的。\nclient-go 是kubernetes中广义的客户端基础库，在Kubernetes各个组件中或多或少都有使用其功能。。也就是说，client-go可以在kubernetes集群中添加、删除和查询资源对象（包括deployment、service、pod、ns等）。\n在了解client-go前，还需要掌握一些概念\n在客户端验证 API 使用证书和使用令牌，来验证客户端 kubernetes集群的访问模式 使用证书和令牌来验证客户端 在访问apiserver时，会对访问者进行鉴权，因为是https请求，在请求时是需要ca的，也可以使用 -k 使用insecure模式\ntext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 $ curl --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.4:6443/version \\{ \u0026#34;major\u0026#34;: \u0026#34;1\u0026#34;, \u0026#34;minor\u0026#34;: \u0026#34;18+\u0026#34;, \u0026#34;gitVersion\u0026#34;: \u0026#34;v1.18.20-dirty\u0026#34;, \u0026#34;gitCommit\u0026#34;: \u0026#34;1f3e19b7beb1cc0110255668c4238ed63dadb7ad\u0026#34;, \u0026#34;gitTreeState\u0026#34;: \u0026#34;dirty\u0026#34;, \u0026#34;buildDate\u0026#34;: \u0026#34;2022-05-17T12:45:14Z\u0026#34;, \u0026#34;goVersion\u0026#34;: \u0026#34;go1.16.15\u0026#34;, \u0026#34;compiler\u0026#34;: \u0026#34;gc\u0026#34;, \u0026#34;platform\u0026#34;: \u0026#34;linux/amd64\u0026#34; } $ curl -k https://10.","keywords":["kubernetes","develop","client-go"],"articleBody":"Prepare Introduction 从2016年8月起，Kubernetes官方提取了与Kubernetes相关的核心源代码，形成了一个独立的项目，即client-go，作为官方提供的go客户端。Kubernetes的部分代码也是基于这个项目的。\nclient-go 是kubernetes中广义的客户端基础库，在Kubernetes各个组件中或多或少都有使用其功能。。也就是说，client-go可以在kubernetes集群中添加、删除和查询资源对象（包括deployment、service、pod、ns等）。\n在了解client-go前，还需要掌握一些概念\n在客户端验证 API 使用证书和使用令牌，来验证客户端 kubernetes集群的访问模式 使用证书和令牌来验证客户端 在访问apiserver时，会对访问者进行鉴权，因为是https请求，在请求时是需要ca的，也可以使用 -k 使用insecure模式\ntext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 $ curl --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.4:6443/version \\{ \"major\": \"1\", \"minor\": \"18+\", \"gitVersion\": \"v1.18.20-dirty\", \"gitCommit\": \"1f3e19b7beb1cc0110255668c4238ed63dadb7ad\", \"gitTreeState\": \"dirty\", \"buildDate\": \"2022-05-17T12:45:14Z\", \"goVersion\": \"go1.16.15\", \"compiler\": \"gc\", \"platform\": \"linux/amd64\" } $ curl -k https://10.0.0.4:6443/api/v1/namespace/default/pods/netbox { \"kind\": \"Status\", \"apiVersion\": \"v1\", \"metadata\": { }, \"status\": \"Failure\", \"message\": \"namespace \\\"default\\\" is forbidden: User \\\"system:anonymous\\\" cannot get resource \\\"namespace/pods\\\" in API group \\\"\\\" at the cluster scope\", \"reason\": \"Forbidden\", \"details\": { \"name\": \"default\", \"kind\": \"namespace\" }, \"code\": 403 } 从错误中可以看出，该请求已通过身份验证，用户是 system:anonymous，但该用户未授权列出对应的资源。而上述请求只是忽略 curl 的https请求需要做的验证，而Kubernetes也有对应验证的机制，这个时候需要提供额外的身份信息来获得所需的访问权限。Kubernetes支持多种身份认证机制，ssl证书也是其中一种。\n注：在Kubernetes中没有表示用户的资源。即kubernetes集群中，无法添加和创建。但由集群提供的有效证书的用户都视为允许的用户。Kubernetes从证书中的使用者CN和使用者可选名称中获得用户；然后，RBAC 判断用户是否有权限操作资源。从 Kubernetes1.4 开始，支持用户组，即证书中的O\n可以使用 curl 的 --cert 和 --key 指定用户的证书\ntext 1 2 3 4 curl --cacert /etc/kubernetes/pki/ca.crt \\ --cert /etc/kubernetes/pki/apiserver-kubelet-client.crt \\ --key /etc/kubernetes/pki/apiserver-ubelet-client.key \\ https://10.0.0.4:6443/api/v1/namespaces/default/pods/netbox 使用serviceaccount验证客户端身份 使用一个serviceaccount JWT，获取一个SA的方式如下\ntext 1 2 3 4 5 6 7 kubectl get secrets \\ $(kubectl get serviceaccounts/default -o jsonpath='{.secrets[0].name}') -o jsonpath='{.data.token}' \\ | base64 --decode JWT=$(kubectl get secrets \\ $(kubectl get serviceaccounts/default -o jsonpath='{.secrets[0].name}') -o jsonpath='{.data.token}' \\ | base64 --decode) 使用secret来访问API\ntext 1 2 3 curl --cacert /etc/kubernetes/pki/ca.crt \\ --header \"Authorization: Bearer $JWT\" \\ https://10.0.0.4:6443/apis/apps/v1/namespaces/default/deployments Pod内部调用Kubernetes API kubernete会将Kubernetes API地址通过环境变量提供给 Pod，可以通过命令看到\ntext 1 2 3 4 5 6 7 8 9 $ env|grep -i kuber KUBERNETES_SERVICE_PORT=443 KUBERNETES_PORT=tcp://192.168.0.1:443 KUBERNETES_PORT_443_TCP_ADDR=192.168.0.1 KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_PORT_443_TCP=tcp://192.168.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_SERVICE_HOST=192.168.0.1 并且还会在将 Kubernetes CA和SA等信息放置在目录 /var/run/secrets/kubernetes.io/serviceaccount/，通过这些就可以从Pod内部访问API\ntext 1 2 3 cd /var/run/secrets/kubernetes.io/serviceaccount/ curl --cacert ca.crt --header \"Authorization: Bearer $(cat token)\" https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT/api/v1/namespaces/default/pods/netbox client-go 关于client-go的模块 k8s.io/api 与Pods、ConfigMaps、Secrets和其他Kubernetes 对象所对应的数据结构都在，k8s.io/api，此包几乎没有算法，仅仅是数据机构，该模块有多达上千个用于描述Kubernetes中资源API的结构；通常被client，server，controller等其他的组件使用。\nk8s.io/apimachinery 根据该库的描述文件可知，这个库是Server和Client中使用的Kubernetes API共享依赖库，也是kubernetes中更低一级的通用的数据结构。在我们构建自定义资源时，不需要为自定义结构创建属性，如 Kind, apiVersion，name…，这些都是库 apimachinery 所提供的功能。\n如，在包 k8s.io/apimachinery/pkg/apis/meta 定义了两个结构 TypeMeta 和 ObjectMeta；将这这两个结构嵌入自定义的结构中，可以以通用的方式兼容对象，如Kubernetes中的资源 Deplyment 也是这么完成的\n通过图来了解Kubernetes的资源如何实现的\r如在 k8s.io/apimachinery/pkg/runtime/interfaces.go 中定义了 interface，这个类为在schema中注册的API都需要实现这个结构\ngo 1 2 3 4 type Object interface { GetObjectKind() schema.ObjectKind DeepCopyObject() Object } 非结构化数据 非结构化数据 Unstructured 是指在kubernete中允许将没有注册为Kubernetes API的对象，作为Json对象的方式进行操作，如，使用非结构化 Kubernetes 对象\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 desired := \u0026unstructured.Unstructured{ Object: map[string]interface{}{ \"apiVersion\": \"v1\", \"kind\": \"ConfigMap\", \"metadata\": map[string]interface{}{ \"namespace\": namespace, \"generateName\": \"crud-dynamic-simple-\", }, \"data\": map[string]interface{}{ \"foo\": \"bar\", }, }, } 非结构化数据的转换 在 k8s.io/apimachinery/pkg/runtime.UnstructuredConverter 中，也提供了将非结构化数据转换为Kubernetes API注册过的结构，参考如何将非结构化对象转换为Kubernetes Object。\ninstall client-go 如何选择 client-go 的版本\n​\t对于不同的kubernetes版本使用标签 v0.x.y 来表示对应的客户端版本。具体对应参考 client-go 。\n​\t例如使用的kubernetes版本为 v1.18.20 则使用对应的标签 v0.x.y 来替换符合当前版本的客户端库。例如：\ntext 1 go get k8s.io/client-go@v0.18.10 官网中给出了client-go的兼容性矩阵，可以很明了的看出如何选择适用于自己kubernetes版本的对应的client-go\n✓ 表示 该版本的 client-go 与对应的 kubernetes版本功能完全一致 + client-go 具有 kubernetes apiserver中不具备的功能。 - Kubernetes apiserver 具有client-go 无法使用的功。 一般情况下，除了对应的版本号完全一致外，其他都存在 功能的+-。\nclient-go 目录介绍 client-go的每一个目录都是一个go package\nkubernetes 包含与Kubernetes API所通信的客户端集 discovery 用于发现kube-apiserver所支持的api dynamic 包含了一个动态客户端，该客户端能够对kube-apiserver任意的API进行操作。 transport 提供了用于设置认证和启动链接的功能 tools/cache: 一些 low-level controller与一些数据结构如fifo，reflector等 structure of client-go RestClient：是最基础的基础架构，其作用是将是使用了http包进行封装成RESTClient。位于rest 目录，RESTClient封装了资源URL的通用格式，例如Get()、Put()、Post() Delete()。是与Kubernetes API的访问行为提供的基于RESTful方法进行交互基础架构。\n同时支持Json 与 protobuf 支持所有的原生资源和CRD ClientSet：Clientset基于RestClient进行封装对 Resource 与 version 管理集合；如何创建\nDiscoverySet：RestClient进行封装，可动态发现 kube-apiserver 所支持的 GVR（Group Version Resource）；如何创建，这种类型是一种非映射至clientset的客户端\nDynamicClient：基于RestClient，包含动态的客户端，可以对Kubernetes所支持的 API对象进行操作，包括CRD；如何创建\n仅支持json\nfakeClient， client-go 实现的mock对象，主要用于单元测试。\n以上client-go所提供的客户端，仅可使用kubeconfig进行连接。\n什么是clientset clientset代表了kubernetes中所有的资源类型，这里不包含CRD的资源，如：\ncore extensions batch … client-go使用 DynamicClient客户端\n与 ClientSet 的区别是，可以对任意 Kubernetes 资源进行 RESTful 操作。同样提供管理的方法\n最大的不同，ClientSet 需要预先实现每种 Resource 和 Version 的操作，内部的数据都是结构化数据（已知数据结构）；DynamicClient 内部实现了 Unstructured，用于处理非结构化的数据（无法提前预知的数据结构），这是其可以处理 CRD 自定义资源的关键。\ndynamicClient 实现流程\n通过 NewForConfig 实例化 conf 为 DynamicInterface客户端\nDynamicInterface 客户端中，实现了一个Resource 方法即为实现了Interface接口\ndynamicClient 实现了非结构化数据类型与rest client，可以通过其方法将Resource 由rest从apiserver中获得api对象，runtime.DeafultUnstructuredConverter.FromUnstructrued 转为对应的类型。\n注意：GVR 中资源类型 resource为复数。kind:Pod 即为 Pods\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 package main import ( \"context\" \"flag\" \"fmt\" \"os\" v1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/apimachinery/pkg/runtime/schema\" \"k8s.io/client-go/dynamic\" \"k8s.io/client-go/kubernetes\" \"k8s.io/client-go/rest\" \"k8s.io/client-go/tools/clientcmd\" \"k8s.io/client-go/util/homedir\" ) func main() { var ( k8sconfig *string //使用kubeconfig配置文件进行集群权限认证 restConfig *rest.Config err error ) if home := homedir.HomeDir(); home != \"\" { k8sconfig = flag.String(\"kubeconfig\", fmt.Sprintf(\"%s/.kube/config\", home), \"kubernetes auth config\") } k8sconfig = k8sconfig flag.Parse() if _, err := os.Stat(*k8sconfig); err != nil { panic(err) } if restConfig, err = rest.InClusterConfig(); err != nil { // 这里是从masterUrl 或者 kubeconfig传入集群的信息，两者选一 restConfig, err = clientcmd.BuildConfigFromFlags(\"\", *k8sconfig) if err != nil { panic(err) } } // 创建客户端类型 // NewForConfig creates a new dynamic client or returns an error. // dynamic.NewForConfig(restConfig) // NewForConfig creates a new Clientset for the given config // kubernetes.NewForConfig(restConfig) // NewDiscoveryClientForConfig creates a new DiscoveryClient for the given config. //clientset, err := discovery.NewDiscoveryClientForConfig(restConfig) dynamicset, err := dynamic.NewForConfig(restConfig) // 这里遵循的是 kubernetes Rest API，如Pod是 // /api/v1/namespaces/{namespace}/pods // /apis/apps/v1/namespaces/{namespace}/deployments // 遵循GVR格式填写 podList, err := dynamicset.Resource(schema.GroupVersionResource{ Group: \"\", Version: \"v1\", Resource: \"pods\", }).Namespace(\"default\").List(context.TODO(), v1.ListOptions{}) if err != nil { panic(err) } daemonsetList, err := dynamicset.Resource(schema.GroupVersionResource{ Group: \"apps\", Version: \"v1\", Resource: \"daemonsets\", }).Namespace(\"kube-system\").List(context.TODO(), v1.ListOptions{}) if err != nil { panic(err) } for _, row := range podList.Items { fmt.Println(row.GetName()) } for _, row := range daemonsetList.Items { fmt.Println(row.GetName()) } // clientset mode clientset, err := kubernetes.NewForConfig(restConfig) podIns, err := clientset.CoreV1().Pods(\"default\").List(context.TODO(), v1.ListOptions{}) for _, row := range podIns.Items { fmt.Println(row.GetName()) } } Extension\n一些client-go使用\nInformer informer是client-go提供的 Listwatcher 接口，主要作为 Controller构成的组件，在Kubernetes中， Controller的一个重要作用是观察对象的期望状态 spec 和实际状态 statue 。为了观察对象的状态，Controller需要向 Apiserver发送请求；但是通常情况下，频繁向Apiserver发出请求的会增加etcd的压力，为了解决这类问题，client-go 一个缓存，通过缓存，控制器可以不必发出大量请求，并且只关心对象的事件。也就是 informer。\n从本质上来讲，informer是使用kubernetes API观察其变化，来维护状态的缓存，称为 indexer；并通过对应事件函数通知客户端信息的变化，informer为一系列组件，通过这些组件来实现的这些功能。\nReflector：与 apiserver交互的组件 Delta FIFO：一个特殊的队列，Reflector将状态的变化存储在里面 indexer：本地存储，与etcd保持一致，减轻API Server与etcd的压力 Processor：监听处理器，通过将监听到的事件发送给对应的监听函数 Controller：从队列中对整个数据的编排处理的过程 informer的工作模式 首先通过List从Kubernetes API中获取资源所有对象并同时缓存，然后通过Watch机制监控资源。这样，通过informer与缓存，就可以直接和informer交互，而不用每次都和Kubernetes API交互。\n另外，informer 还提供了事件的处理机制，以便 Controller 或其他应用程序根据回调钩子函数等处理特定的业务逻辑。因为Informer可以通过List/Watch机制监控所有资源的所有事件，只要在Informer中添加ResourceEventHandler实例的回调函数，如：onadd(obj interface {}), onupdate (oldobj, newobj interface {})和OnDelete( obj interface {}) 可以实现处理资源的创建、更新和删除。 在Kubernetes中，各种控制器都使用了Informer。\n分析informer的流程 通过代码 k8s.io/client-go/informers/apps/v1/deployment.go 可以看出，在每个控制器下，都实现了一个 Informer 和 Lister ，Lister就是indexer；\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 type SharedInformer interface { // 添加一个事件处理函数，使用informer默认的resync period AddEventHandler(handler ResourceEventHandler) // 将事件处理函数注册到 share informer，将resyncPeriod作为参数传入 AddEventHandlerWithResyncPeriod(handler ResourceEventHandler, resyncPeriod time.Duration) // 从本地缓存获取的信息作为infomer的返回 GetStore() Store // 已弃用 GetController() Controller // 运行一个informer，当stopCh停止时，informer也被关闭 Run(stopCh \u003c-chan struct{}) // HasSynced returns true if the shared informer's store has been // informed by at least one full LIST of the authoritative state // of the informer's object collection. This is unrelated to \"resync\". HasSynced() bool // LastSyncResourceVersion is the resource version observed when last synced with the underlying store. The value returned is not synchronized with access to the underlying store and is not thread-safe. LastSyncResourceVersion() string } 而 Shared Informer 对所有的API组提供一个shared informer\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // SharedInformerFactory provides shared informers for resources in all known // API group versions. type SharedInformerFactory interface { internalinterfaces.SharedInformerFactory ForResource(resource schema.GroupVersionResource) (GenericInformer, error) WaitForCacheSync(stopCh \u003c-chan struct{}) map[reflect.Type]bool Admissionregistration() admissionregistration.Interface Apps() apps.Interface Auditregistration() auditregistration.Interface Autoscaling() autoscaling.Interface Batch() batch.Interface Certificates() certificates.Interface Coordination() coordination.Interface Core() core.Interface Discovery() discovery.Interface Events() events.Interface Extensions() extensions.Interface Flowcontrol() flowcontrol.Interface Networking() networking.Interface Node() node.Interface Policy() policy.Interface Rbac() rbac.Interface Scheduling() scheduling.Interface Settings() settings.Interface Storage() storage.Interface } 可以看到在 k8s.io/client-go/informers/apps/v1/deployment.go 实现了这个interface\ngo 1 2 3 4 type DeploymentInformer interface { Informer() cache.SharedIndexInformer Lister() v1.DeploymentLister } 而在对应的 deployment controller中会调用这个Informer 实现对状态的监听；``\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 // NewDeploymentController creates a new DeploymentController. // appsinformers.DeploymentInformer就是client-go 中的 /apps/v1/deployment实现的informer func NewDeploymentController(dInformer appsinformers.DeploymentInformer, rsInformer appsinformers.ReplicaSetInformer, podInformer coreinformers.PodInformer, client clientset.Interface) (*DeploymentController, error) { eventBroadcaster := record.NewBroadcaster() eventBroadcaster.StartLogging(klog.Infof) eventBroadcaster.StartRecordingToSink(\u0026v1core.EventSinkImpl{Interface: client.CoreV1().Events(\"\")}) if client != nil \u0026\u0026 client.CoreV1().RESTClient().GetRateLimiter() != nil { if err := ratelimiter.RegisterMetricAndTrackRateLimiterUsage(\"deployment_controller\", client.CoreV1().RESTClient().GetRateLimiter()); err != nil { return nil, err } } dc := \u0026DeploymentController{ client: client, eventRecorder: eventBroadcaster.NewRecorder(scheme.Scheme, v1.EventSource{Component: \"deployment-controller\"}), queue: workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), \"deployment\"), } dc.rsControl = controller.RealRSControl{ KubeClient: client, Recorder: dc.eventRecorder, } dInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: dc.addDeployment, UpdateFunc: dc.updateDeployment, // This will enter the sync loop and no-op, because the deployment has been deleted from the store. DeleteFunc: dc.deleteDeployment, }) rsInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: dc.addReplicaSet, UpdateFunc: dc.updateReplicaSet, DeleteFunc: dc.deleteReplicaSet, }) podInformer.Informer().AddEventHandler(cache.ResourceEventHandlerFuncs{ DeleteFunc: dc.deletePod, }) dc.syncHandler = dc.syncDeployment dc.enqueueDeployment = dc.enqueue dc.dLister = dInformer.Lister() dc.rsLister = rsInformer.Lister() dc.podLister = podInformer.Lister() dc.dListerSynced = dInformer.Informer().HasSynced dc.rsListerSynced = rsInformer.Informer().HasSynced dc.podListerSynced = podInformer.Informer().HasSynced return dc, nil } Reflector reflector是client-go中负责监听 Kubernetes API 的组件，也是整个机制中的生产者，负责将 watch到的数据将其放入 watchHandler 中的delta FIFO队列中。也就是吧etcd的数据反射为 delta fifo的数据\n在代码 k8s.io/client-go/tools/cache/reflector.go 中定义了 Reflector 对象\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 type Reflector struct { // reflector的名称，默认为一个 file:line的格式 name string // 期待的类型名称，这里只做展示用， // 如果提供，是一个expectedGVK字符串类型，否则是expectedType字符串类型 expectedTypeName string // 期待放置在存储中的类型，如果是一个非格式化数据，那么其 APIVersion与Kind也必须为正确的格式 expectedType reflect.Type // GVK 存储中的对象，是GVK格式 expectedGVK *schema.GroupVersionKind // 同步数据的存储 store Store // 这个是reflector的一个核心，提供了 List和Watch功能 listerWatcher ListerWatcher // backoff manages backoff of ListWatch backoffManager wait.BackoffManager resyncPeriod time.Duration ShouldResync func() bool // clock allows tests to manipulate time clock clock.Clock paginatedResult bool // 最后资源的版本号 lastSyncResourceVersion string // 当 lastSyncResourceVersion 过期或者版本太大，这个值将为 true isLastSyncResourceVersionUnavailable bool // 读写锁，对lastSyncResourceVersion的读写操作的保护 lastSyncResourceVersionMutex sync.RWMutex // WatchListPageSize is the requested chunk size of initial and resync watch lists. // scalability problems. // 是初始化时，或者重新同步时的块大小。如果没有设置，将为任意的旧数据 // 因为是提供了分页功能，RV=0则为默认的页面大小 // WatchListPageSize int64 } 而 方法 NewReflector() 给用户提供了一个初始化 Reflector的接口\n在 cotroller.go 中会初始化一个 relector\ngo 1 2 3 4 5 6 7 8 9 10 11 12 func (c *controller) Run(stopCh \u003c-chan struct{}) { defer utilruntime.HandleCrash() go func() { \u003c-stopCh c.config.Queue.Close() }() r := NewReflector( c.config.ListerWatcher, c.config.ObjectType, c.config.Queue, c.config.FullResyncPeriod, ) Reflector下有三个可对用户提供的方法，Run(), ListAndWatch() , LastSyncResourceVersion()\nRun() 是对Reflector的运行，也就是对 ListAndWatch() ；\ngo 1 2 3 4 5 6 7 8 9 func (r *Reflector) Run(stopCh \u003c-chan struct{}) { klog.V(2).Infof(\"Starting reflector %s (%s) from %s\", r.expectedTypeName, r.resyncPeriod, r.name) wait.BackoffUntil(func() { if err := r.ListAndWatch(stopCh); err != nil { utilruntime.HandleError(err) } }, r.backoffManager, true, stopCh) klog.V(2).Infof(\"Stopping reflector %s (%s) from %s\", r.expectedTypeName, r.resyncPeriod, r.name) } 而 ListAndWatch() 则是实际上真实的对Reflector业务的执行\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 // 前面一些都是对信息的初始化与日志输出 func (r *Reflector) ListAndWatch(stopCh \u003c-chan struct{}) error { klog.V(3).Infof(\"Listing and watching %v from %s\", r.expectedTypeName, r.name) var resourceVersion string options := metav1.ListOptions{ResourceVersion: r.relistResourceVersion()} // 分页功能 if err := func() error { initTrace := trace.New(\"Reflector ListAndWatch\", trace.Field{\"name\", r.name}) defer initTrace.LogIfLong(10 * time.Second) var list runtime.Object var paginatedResult bool var err error listCh := make(chan struct{}, 1) panicCh := make(chan interface{}, 1) go func() { .... // 清理和重新同步的一些 resyncerrc := make(chan error, 1) cancelCh := make(chan struct{}) defer close(cancelCh) go func() { ... }() for { // give the stopCh a chance to stop the loop, even in case of continue statements further down on errors select { case \u003c-stopCh: return nil default: } timeoutSeconds := int64(minWatchTimeout.Seconds() * (rand.Float64() + 1.0)) options = metav1.ListOptions{ ResourceVersion: resourceVersion, // 为了避免watch的挂起设置一个超时 // 仅在工作窗口期，处理任何时间 TimeoutSeconds: \u0026timeoutSeconds, // To reduce load on kube-apiserver on watch restarts, you may enable watch bookmarks. // Reflector doesn't assume bookmarks are returned at all (if the server do not support // watch bookmarks, it will ignore this field). AllowWatchBookmarks: true, } start := r.clock.Now() // 开始监听 w, err := r.listerWatcher.Watch(options) if err != nil { switch { case isExpiredError(err): // 没有设置 LastSyncResourceVersionExpired 也就是过期，会保持与返回数据相同的 // 首次会先将RV列出 klog.V(4).Infof(\"%s: watch of %v closed with: %v\", r.name, r.expectedTypeName, err) case err == io.EOF: // 通常为watch关闭 case err == io.ErrUnexpectedEOF: klog.V(1).Infof(\"%s: Watch for %v closed with unexpected EOF: %v\", r.name, r.expectedTypeName, err) default: utilruntime.HandleError(fmt.Errorf(\"%s: Failed to watch %v: %v\", r.name, r.expectedTypeName, err)) } // 如果出现 connection refuse，通常与apisserver通讯失败，这个时候会重新发送请求 if utilnet.IsConnectionRefused(err) { time.Sleep(time.Second) continue } return nil } if err := r.watchHandler(start, w, \u0026resourceVersion, resyncerrc, stopCh); err != nil { if err != errorStopRequested { switch { case isExpiredError(err): // 同上步骤的功能 klog.V(4).Infof(\"%s: watch of %v closed with: %v\", r.name, r.expectedTypeName, err) default: klog.Warningf(\"%s: watch of %v ended with: %v\", r.name, r.expectedTypeName, err) } } return nil } } } 那么在实现时，如 deploymentinformer,会实现 Listfunc和 watchfunc，这其实就是clientset中的操作方法，也是就list与watch\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func NewFilteredDeploymentInformer(client kubernetes.Interface, namespace string, resyncPeriod time.Duration, indexers cache.Indexers, tweakListOptions internalinterfaces.TweakListOptionsFunc) cache.SharedIndexInformer { return cache.NewSharedIndexInformer( \u0026cache.ListWatch{ ListFunc: func(options metav1.ListOptions) (runtime.Object, error) { if tweakListOptions != nil { tweakListOptions(\u0026options) } return client.AppsV1().Deployments(namespace).List(context.TODO(), options) }, WatchFunc: func(options metav1.ListOptions) (watch.Interface, error) { if tweakListOptions != nil { tweakListOptions(\u0026options) } return client.AppsV1().Deployments(namespace).Watch(context.TODO(), options) }, }, \u0026appsv1.Deployment{}, resyncPeriod, indexers, ) } tools/cache/controller.go 是存储controller的配置及实现。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 type Config struct { Queue // 对象的队列，必须为DeltaFIFO ListerWatcher // 这里能够监视并列出对象的一些信息，这个对象接受process函数的弹出 // Something that can process a popped Deltas. Process ProcessFunc // 处理Delta的弹出 // 对象类型，这个controller期待的处理类型，其apiServer与kind必须正确，即，GVR必须正确 ObjectType runtime.Object // FullResyncPeriod是每次重新同步的时间间隔 FullResyncPeriod time.Duration // type ShouldResyncFunc func() bool // 返回值nil或true，则表示reflector继续同步 ShouldResync ShouldResyncFunc RetryOnError bool // 标志位，true时，在process()返回错误时重新排列对象 // Called whenever the ListAndWatch drops the connection with an error. // 断开连接是出现错误调用这个函数处理 WatchErrorHandler WatchErrorHandler // WatchListPageSize is the requested chunk size of initial and relist watch lists. WatchListPageSize int64 } 实现这个接口\ngo 1 2 3 4 5 6 type controller struct { config Config reflector *Reflector reflectorMutex sync.RWMutex clock clock.Clock } New() 为给定controller 配置的设置，即为上面的config struct，用来初始化controller对象\nNewInformer() ：返回一个store（保存数据的最终接口）和一个用于store的controller，同时提供事件的通知(crud)等\nNewIndexerInformer()：返回一个索引与一个用于索引填充的控制器\n控制器的run()的功能实现\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func (c *controller) Run(stopCh \u003c-chan struct{}) { defer utilruntime.HandleCrash() // 延迟销毁 go func() { // 信号处理，用于线程管理 \u003c-stopCh c.config.Queue.Close() }() r := NewReflector( // 初始化Reflector c.config.ListerWatcher, // ls c.config.ObjectType, c.config.Queue, c.config.FullResyncPeriod, ) r.ShouldResync = c.config.ShouldResync // 配置是否应该继续同步 r.WatchListPageSize = c.config.WatchListPageSize r.clock = c.clock if c.config.WatchErrorHandler != nil { // 断开连接错误处理 r.watchErrorHandler = c.config.WatchErrorHandler } c.reflectorMutex.Lock() c.reflector = r c.reflectorMutex.Unlock() var wg wait.Group wg.StartWithChannel(stopCh, r.Run) // 这里是真正的运行。 // processLoop() 是DeltaFIFO的消费者方法 wait.Until(c.processLoop, time.Second, stopCh) // 消费队列的数据 wg.Wait() } 总结 在controller的初始化时就初始化了Reflector， controller.Run里面Reflector是结构体初始化时的Reflector，主要作用是watch指定的资源，并且将变化同步到本地的store中。\nReflector接着执行ListAndWatch函数，ListAndWatch第一次会列出所有的对象，并获取资源对象的版本号，然后watch资源对象的版本号来查看是否有被变更。首先会将资源版本号设置为0，list()可能会导致本地的缓存相对于etcd里面的内容存在延迟，Reflector会通过watch的方法将延迟的部分补充上，使得本地缓存数据与etcd的数据保持一致。\ncontroller.Run函数还会调用processLoop函数，processLoop通过调用HandleDeltas，再调用distribute，processorListener.add最终将不同更新类型的对象加入processorListener的channel中，供processorListener.Run使用。\nDelta FIFO 通过下图可以看出，Delta FIFO 是位于Reflector中的一个FIFO队列，那么 Delta FIFO 究竟是什么，让我们来进一步深剖。\n图源于：https://miro.medium.com/max/700/1*iI8uFsPRBY5m_g_WW4huMQ.png\r在代码中的注释可以看到一些信息，根据信息可以总结出\nDelta FIFO 是一个生产者-消费者的队列，生产者是 Reflector，消费者是 Pop() 与传统的FIFO有两点不同 Delta FIFO Delta FIFO也是实现了 Queue以及一些其他 interface 的类，\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 type DeltaFIFO struct { lock sync.RWMutex // 一个读写锁，保证线程安全 cond sync.Cond items map[string]Deltas // 存放的类型是一个key[string] =》 value[Delta] 类型的数据 queue []string // 用于存储item的key，是一个fifo populated bool // populated 是用来标记首次被加入的数据是否被变动 initialPopulationCount int // 首次调用 replace() 的数量 keyFunc KeyFunc knownObjects KeyListerGetter // 这里为indexer closed bool // 代表已关闭 closedLock sync.Mutex emitDeltaTypeReplaced bool // 表示事件的类型，true为 replace(), false 为 sync() } 那么delta的类型是，也就是说通常情况下，Delta为一个 string[runtime.object] 的对象\ngo 1 2 3 4 type Delta struct { Type DeltaType // 这就是一个string Object interface{} // 之前API部分有了解到，API的类型大致为两类，runtime.Object和非结构化数据 } apimachinery/pkg/runtime/interfaces.go\n那么此时，已经明白了Delta FIFO的结构，为一个Delta的队列，整个结构如下\n第一步创建一个Delta FIFO 现在版本中，对创建Delta FIFO是通过函数 NewDeltaFIFOWithOptions()\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func NewDeltaFIFOWithOptions(opts DeltaFIFOOptions) *DeltaFIFO { if opts.KeyFunction == nil { opts.KeyFunction = MetaNamespaceKeyFunc // 默认的计算key的方法 } f := \u0026DeltaFIFO{ items: map[string]Deltas{}, queue: []string{}, keyFunc: opts.KeyFunction, knownObjects: opts.KnownObjects, emitDeltaTypeReplaced: opts.EmitDeltaTypeReplaced, } f.cond.L = \u0026f.lock return f } queueActionLocked，Delta FIFO添加操作 这里说下之前说道的，在追加时的操作 queueActionLocked ，如add update delete实际上走的都是这里\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func (f *DeltaFIFO) queueActionLocked(actionType DeltaType, obj interface{}) error { id, err := f.KeyOf(obj) // 计算key if err != nil { return KeyError{obj, err} } // 把新数据添加到DeltaFIFO中，Detal就是 动作为key，对象为值 // item是DeltaFIFO中维护的一个 map[string]Deltas newDeltas := append(f.items[id], Delta{actionType, obj}) newDeltas = dedupDeltas(newDeltas) // 去重，去重我们前面讨论过了 if len(newDeltas) \u003e 0 { if _, exists := f.items[id]; !exists { f.queue = append(f.queue, id) } // 不存在则添加 f.items[id] = newDeltas f.cond.Broadcast() } else { delete(f.items, id) // 这里走不到，因为添加更新等操作用newDelta是1 // 源码中也说要忽略这里 } return nil } 在FIFO继承的Stroe的方法中，如，Add, Update等都是需要去重的，去重的操作是通过对比最后一个和倒数第二个值\ngo 1 2 3 4 5 6 7 8 9 func (f *DeltaFIFO) queueActionLocked(actionType DeltaType, obj interface{}) error { id, err := f.KeyOf(obj) if err != nil { return KeyError{obj, err} } newDeltas := append(f.items[id], Delta{actionType, obj}) newDeltas = dedupDeltas(newDeltas) ... 在函数 dedupDeltas() 中实现的这个\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // re-listing and watching can deliver the same update multiple times in any order. This will combine the most recent two deltas if they are the same. func dedupDeltas(deltas Deltas) Deltas { n := len(deltas) if n \u003c 2 { return deltas } a := \u0026deltas[n-1] // 如 [1,2,3,4] a=4 b := \u0026deltas[n-2] // b=3,这里两个值其实为事件 if out := isDup(a, b); out != nil { d := append(Deltas{}, deltas[:n-2]...) return append(d, *out) } return deltas } 如果b对象的类型是 DeletedFinalStateUnknown 也会认为是一个旧对象被删除，这里在去重时也只是对删除的操作进行去重。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // tools/cache/delta_fifo.go func isDup(a, b *Delta) *Delta { if out := isDeletionDup(a, b); out != nil { return out } // TODO: Detect other duplicate situations? Are there any? return nil } // keep the one with the most information if both are deletions. func isDeletionDup(a, b *Delta) *Delta { if b.Type != Deleted || a.Type != Deleted { return nil } // Do more sophisticated checks, or is this sufficient? if _, ok := b.Object.(DeletedFinalStateUnknown); ok { return a } return b } 为什么需要去重？什么情况下需合并\n代码中开发者给我们留了一个TODO\nTODO: is there anything other than deletions that need deduping?\n取决于Detal FIFO 生产-消费延迟 当在一个资源的创建时，其状态会频繁的更新，如 Creating，Runinng等，这个时候会出现大量写入FIFO中的数据，但是在消费端可能之前的并未消费完。 在上面那种情况下，以及Kubernetes 声明式 API 的设计，其实多余的根本不关注，只需要最后一个动作如Running，这种情况下，多个内容可以合并为一个步骤 然而在代码中，去重仅仅是在Delete状态生效，显然这不可用；那么结合这些得到： 在一个工作时间窗口内，如果对于删除操作来说发生多次，与发生一次实际上没什么区别，可以去重 但在更新于新增操作时，实际上在对于声明式 API 的设计个人感觉是完全可以做到去重操作。 同一个时间窗口内多次操作，如更新，实际上Kubernetes应该只关注最终状态而不是命令式？ Compute Key 上面大概对一些Detal FIFO的逻辑进行了分析，那么对于Detal FIFO如何去计算，也就是说 MetaNamespaceKeyFunc ，这个是默认的KeyFunc，作用是计算Detals中的唯一key。\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 func MetaNamespaceKeyFunc(obj interface{}) (string, error) { if key, ok := obj.(ExplicitKey); ok { // 显示声明的则为这个值 return string(key), nil } meta, err := meta.Accessor(obj) // 那么使用Accessor,每一个资源都会实现这个Accessor if err != nil { return \"\", fmt.Errorf(\"object has no meta: %v\", err) } if len(meta.GetNamespace()) \u003e 0 { return meta.GetNamespace() + \"/\" + meta.GetName(), nil } return meta.GetName(), nil } ObjectMetaAccessor 每个Kubernetes资源都会实现这个对象，如Deployment\ngo 1 2 3 4 5 6 7 8 9 10 11 12 // accessor interface type ObjectMetaAccessor interface { GetObjectMeta() Object } // 会被ObjectMeta所实现 func (obj *ObjectMeta) GetObjectMeta() Object { return obj } // 而每一个资源都会继承这个 ObjectMeta，如 ClusterRole type ClusterRole struct { metav1.TypeMeta `json:\",inline\"` metav1.ObjectMeta `json:\"metadata,omitempty\"protobuf:\"bytes,1,opt,name=metadata\"` 那么这个Deltas的key则为集群类型的是资源本身的名字，namespace范围的则为 meta.GetNamespace() + \"/\" + meta.GetName()，可以在上面代码中看到，这样就可以给Detal生成了一个唯一的key\nkeyof，用于计算对象的key go 1 2 3 4 5 6 7 8 9 10 11 12 func (f *DeltaFIFO) KeyOf(obj interface{}) (string, error) { if d, ok := obj.(Deltas); ok { if len(d) == 0 { // 长度为0的时候是一个初始的类型 return \"\", KeyError{obj, ErrZeroLengthDeltasObject} } obj = d.Newest().Object // 用最新的一个对象，如果为空则是nil } if d, ok := obj.(DeletedFinalStateUnknown); ok { return d.Key, nil // 到了这里，之前提到过，是一个过期的值将会被删除 } return f.keyFunc(obj) // 调用具体的key计算函数 } Indexer indexer 在整个 client-go 架构中提供了一个具有线程安全的数据存储的对象存储功能；对于Indexer这里会分析下对应的架构及使用方法。\nclient-go/tools/cache/index.go 中可以看到 indexer是一个实现了Store 的一个interface\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type Indexer interface { // 继承了store，拥有store的所有方法 Store // 返回indexname的obj的交集 Index(indexName string, obj interface{}) ([]interface{}, error) // 通过对 indexName，indexedValue与之相匹配的集合 IndexKeys(indexName, indexedValue string) ([]string, error) // 给定一个indexName 返回所有的indexed ListIndexFuncValues(indexName string) []string // 通过indexname，返回与indexedvalue相关的 obj ByIndex(indexName, indexedValue string) ([]interface{}, error) // 返回所有的indexer GetIndexers() Indexers AddIndexers(newIndexers Indexers) error } 实际上对他的实现是一个 cache，cache是一个KeyFunc与ThreadSafeStore实现的indexer，有名称可知具有线程安全的功能\ngo 1 2 3 4 type cache struct { cacheStorage ThreadSafeStore keyFunc KeyFunc } 既然index继承了Store那么，也就是 ThreadSafeStore 必然实现了Store，这是一个基础保证\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 type ThreadSafeStore interface { Add(key string, obj interface{}) Update(key string, obj interface{}) Delete(key string) Get(key string) (item interface{}, exists bool) List() []interface{} ListKeys() []string Replace(map[string]interface{}, string) Index(indexName string, obj interface{}) ([]interface{}, error) IndexKeys(indexName, indexKey string) ([]string, error) ListIndexFuncValues(name string) []string ByIndex(indexName, indexKey string) ([]interface{}, error) GetIndexers() Indexers AddIndexers(newIndexers Indexers) error Resync() error // Resync is a no-op and is deprecated } // KeyFunc是一个生成key的函数，给一个对象，返回一个key值 type KeyFunc func(obj interface{}) (string, error) 那么这个indexer structure可以通过图来很直观的看出来\ncache的结构 cache中会出现三种数据结构，也可以成为三种名词，为 Index , Indexers , Indices\ngo 1 2 3 type Index map[string]sets.String type Indexers map[string]IndexFunc type Indices map[string]Index 可以看出：\nIndex 映射到对象，sets.String 也是在API中定义的数据类型 [string]Struct{}， Indexers 是这个 Index 的 IndexFunc , 是一个如何计算Index的keyname的函数 Indices 通过Index 名词拿到对应的对象 这个名词的概念如下，通过图来了解会更加清晰\n从创建开始 创建一个cache有两种方式，一种是指定indexer，一种是默认indexer\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // NewStore returns a Store implemented simply with a map and a lock. func NewStore(keyFunc KeyFunc) Store { return \u0026cache{ cacheStorage: NewThreadSafeStore(Indexers{}, Indices{}), keyFunc: keyFunc, } } // NewIndexer returns an Indexer implemented simply with a map and a lock. func NewIndexer(keyFunc KeyFunc, indexers Indexers) Indexer { return \u0026cache{ cacheStorage: NewThreadSafeStore(indexers, Indices{}), keyFunc: keyFunc, } } 更新操作 在indexer中的更新操作（诸如 add , update ），实际上操作的是 updateIndices， 通过在代码可以看出\ntools/cache/thread_safe_store.go 的 77行起，那么就来看下 updateIndices() 具体做了什么\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func (c *threadSafeMap) updateIndices(oldObj interface{}, newObj interface{}, key string) { // 在操作时，如果有旧对象，需要先删除 if oldObj != nil { c.deleteFromIndices(oldObj, key) } // 先对整个indexer遍历，拿到index name与 index function for name, indexFunc := range c.indexers { // 通过index function，计算出对象的indexed name indexValues, err := indexFunc(newObj) if err != nil { panic(fmt.Errorf(\"unable to calculate an index entry for key %q on index %q: %v\", key, name, err)) } // 接下来通过遍历的index name 拿到这个index的对象 index := c.indices[name] if index == nil { // 确认这个index是否存在， index = Index{} // 如果不存在将一个Index{}初始化 c.indices[name] = index } // 通过计算出的indexed name来拿到对应的 set of object for _, indexValue := range indexValues { set := index[indexValue] if set == nil { // 如果这个set不存在，则初始化这个set set = sets.String{} index[indexValue] = set } set.Insert(key) // 然后将key插入set中 } } } 那么通过上面可以了解到了 updateIndices 的逻辑，那么通过对更新函数分析来看看他具体做了什么？这里是add函数，通过一段代码模拟操作来熟悉结构\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 testIndexer := \"testIndexer\" testIndex := \"testIndex\" indexers := cache.Indexers{ testIndexer: func(obj interface{}) (strings []string, e error) { indexes := []string{testIndex} // index的名词 return indexes, nil }, } indices := cache.Indices{} store := cache.NewThreadSafeStore(indexers, indices) fmt.Printf(\"%#v\\n\", store.GetIndexers()) store.Add(\"retain\", \"pod--1\") store.Add(\"delete\", \"pod--2\") store.Update(\"retain\", \"pod-3\") //lists := store.Update(\"retain\", \"pod-3\") lists := store.List() for _, item := range lists { fmt.Println(item) } 这里是对add操作以及对updateIndices() 进行操作\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 // threadSafe.go func (c *threadSafeMap) Add(key string, obj interface{}) { c.lock.Lock() defer c.lock.Unlock() oldObject := c.items[key] // 这个item就是存储object的地方, 为空 c.items[key] = obj // 这里已经添加了新的值 c.updateIndices(oldObject, obj, key) // 转至updateIndices } // updateIndices func (c *threadSafeMap) updateIndices(oldObj interface{}, newObj interface{}, key string) { // 就当是新创建的，这里是空的忽略 if oldObj != nil { c.deleteFromIndices(oldObj, key) } // 这个时候拿到的就是 name=testKey function=testIndexer for name, indexFunc := range c.indexers { // 通过testIndexer对testKey计算出的结果是 []string{testIndexer} indexValues, err := indexFunc(newObj) if err != nil { panic(fmt.Errorf(\"unable to calculate an index entry for key %q on index %q: %v\", key, name, err)) } index := c.indices[name] if index == nil { index = Index{} // 因为假设为空了，故到这里c.indices[testIndexer]= Index{} c.indices[name] = index } for _, indexValue := range indexValues { // indexValue=testIndexer // set := c.index[name] = c.indices[testIndexer]Index{} set := index[indexValue] if set == nil { set = sets.String{} index[indexValue] = set } set.Insert(key) // 到这里就为set=indices[testIndexer]Index{} } } } 总结一下，到这里，可以很明显的看出来，indexer中的三个概念是什么了，前面如果没有看明白话\nIndex：通过indexer计算出key的名称，值为对应obj的一个集合，可以理解为索引的数据结构 比如说 Pod:{\"nginx-pod1\": v1.Pod{Name:Nginx}} Indexers ：这个很简单，就是，对于Index中如何计算每个key的名称；可以理解为分词器，索引的过程 Indices 通过Index 名词拿到对应的对象，是Index的集合；是将原始数据Item做了一个索引，可以理解为做索引的具体字段 比如说 Indices[\"Pod\"]{\"nginx-pod1\": v1.Pod{Name:Nginx}, \"nginx-pod2\": v1.Pod{Name:Nginx}} Items：实际上存储的在Indices中的set.String{key:value} ，中的 key=value 例如：Item:{\"nginx-pod1\": v1.Pod{Name:Nginx}, \"coredns-depoyment\": App.Deployment{Name:coredns}} 删除操作 对于删除操作，在最新版本中是使用了 updateIndices 就是 add update delete全都是相同的方法操作，对于旧版包含1.19- 是单独的一个操作\ntext 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // v1.2+ func (c *threadSafeMap) Delete(key string) { c.lock.Lock() defer c.lock.Unlock() if obj, exists := c.items[key]; exists { c.updateIndices(obj, nil, key) delete(c.items, key) } } // v1.19- func (c *threadSafeMap) Delete(key string) { c.lock.Lock() defer c.lock.Unlock() if obj, exists := c.items[key]; exists { c.deleteFromIndices(obj, key) delete(c.items, key) } } indexer使用 上面了解了indexer概念，可以通过写代码来尝试使用一些indexer\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 package main import ( \"fmt\" appsV1 \"k8s.io/api/apps/v1\" metav1 \"k8s.io/apimachinery/pkg/apis/meta/v1\" \"k8s.io/client-go/tools/cache\" ) func main() { indexers := cache.Indexers{ \"getDeplyment\": func(obj interface{}) (strings []string, e error) { d, ok := obj.(*appsV1.Deployment) if !ok { return []string{}, nil } return []string{d.Name}, nil }, \"getDaemonset\": func(obj interface{}) (strings []string, e error) { d, ok := obj.(*appsV1.DaemonSet) if !ok { return []string{}, nil } return []string{d.Name}, nil }, } // 第一个参数是计算set内的key的名称 就是map[string]sets.String的这个strings的名称/namespace/resorcename // 第二个参数是计算index即外部的key的名称 indexer := cache.NewIndexer(cache.MetaNamespaceKeyFunc, indexers) deployment := \u0026appsV1.Deployment{ ObjectMeta: metav1.ObjectMeta{ Name: \"nginx-deplyment\", Namespace: \"test\", }, } daemonset := \u0026appsV1.DaemonSet{ ObjectMeta: metav1.ObjectMeta{ Name: \"firewall-daemonset\", Namespace: \"test\", }, } daemonset2 := \u0026appsV1.DaemonSet{ ObjectMeta: metav1.ObjectMeta{ Name: \"etcd-daemonset\", Namespace: \"default\", }, } indexer.Add(deployment) indexer.Add(daemonset) indexer.Add(daemonset2) // 第一个参数是索引器 // 第二个参数是所引起做索引的字段 lists, _ := indexer.ByIndex(\"getDaemonset\", \"etcd-daemonset\") for _, item := range lists { switch item.(type) { case *appsV1.Deployment: fmt.Println(item.(*appsV1.Deployment).Name) case *appsV1.DaemonSet: fmt.Println(item.(*appsV1.DaemonSet).Name) } } } Reference go types Kubernetes API Reference Docs ","wordCount":"4011","inLanguage":"zh","datePublished":"2022-05-22T00:00:00Z","dateModified":"2023-03-18T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.oomkill.com/2022/05/ch06-client-go/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"https://www.oomkill.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.oomkill.com/><img src=https://www.oomkill.com/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.oomkill.com/archives><span>归档</span></a></li><li><a href=https://www.oomkill.com/tags><span>标签</span></a></li><li><a href=https://www.oomkill.com/search><span>搜索</span></a></li><li><a href=https://www.oomkill.com/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Kubernetes组件核心 - client-go</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2022-05-22</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>4011 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>19 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=https://www.oomkill.com/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=https://www.oomkill.com/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#prepare aria-label=Prepare>Prepare</a><ul><li><a href=#introduction aria-label=Introduction>Introduction</a><li><a href=#%e4%bd%bf%e7%94%a8%e8%af%81%e4%b9%a6%e5%92%8c%e4%bb%a4%e7%89%8c%e6%9d%a5%e9%aa%8c%e8%af%81%e5%ae%a2%e6%88%b7%e7%ab%af aria-label=使用证书和令牌来验证客户端>使用证书和令牌来验证客户端</a><li><a href=#%e4%bd%bf%e7%94%a8serviceaccount%e9%aa%8c%e8%af%81%e5%ae%a2%e6%88%b7%e7%ab%af%e8%ba%ab%e4%bb%bd aria-label=使用serviceaccount验证客户端身份>使用serviceaccount验证客户端身份</a><li><a href=#pod%e5%86%85%e9%83%a8%e8%b0%83%e7%94%a8kubernetes-api aria-label="Pod内部调用Kubernetes API">Pod内部调用Kubernetes API</a></ul><li><a href=#client-go aria-label=client-go>client-go</a><ul><li><a href=#%e5%85%b3%e4%ba%8eclient-go%e7%9a%84%e6%a8%a1%e5%9d%97 aria-label=关于client-go的模块>关于client-go的模块</a><ul><li><a href=#k8sioapi aria-label=k8s.io/api>k8s.io/api</a><li><a href=#k8sioapimachinery aria-label=k8s.io/apimachinery>k8s.io/apimachinery</a><li><a href=#%e9%9d%9e%e7%bb%93%e6%9e%84%e5%8c%96%e6%95%b0%e6%8d%ae aria-label=非结构化数据>非结构化数据</a><li><a href=#%e9%9d%9e%e7%bb%93%e6%9e%84%e5%8c%96%e6%95%b0%e6%8d%ae%e7%9a%84%e8%bd%ac%e6%8d%a2 aria-label=非结构化数据的转换>非结构化数据的转换</a></ul><li><a href=#install-client-go aria-label="install client-go">install client-go</a><li><a href=#client-go-%e7%9b%ae%e5%bd%95%e4%bb%8b%e7%bb%8d aria-label="client-go 目录介绍">client-go 目录介绍</a><li><a href=#structure-of-client-go aria-label="structure of client-go">structure of client-go</a><li><a href=#%e4%bb%80%e4%b9%88%e6%98%afclientset aria-label=什么是clientset>什么是clientset</a><li><a href=#client-go%e4%bd%bf%e7%94%a8 aria-label=client-go使用>client-go使用</a></ul><li><a href=#informer aria-label=Informer>Informer</a><ul><li><a href=#informer%e7%9a%84%e5%b7%a5%e4%bd%9c%e6%a8%a1%e5%bc%8f aria-label=informer的工作模式>informer的工作模式</a><li><a href=#%e5%88%86%e6%9e%90informer%e7%9a%84%e6%b5%81%e7%a8%8b aria-label=分析informer的流程>分析informer的流程</a></ul><li><a href=#reflector aria-label=Reflector>Reflector</a><ul><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a></ul><li><a href=#delta-fifo aria-label="Delta FIFO">Delta FIFO</a><ul><li><a href=#%e7%ac%ac%e4%b8%80%e6%ad%a5%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aadelta-fifo aria-label="第一步创建一个Delta FIFO">第一步创建一个Delta FIFO</a><li><a href=#queueactionlockeddelta-fifo%e6%b7%bb%e5%8a%a0%e6%93%8d%e4%bd%9c aria-label="queueActionLocked，Delta FIFO添加操作">queueActionLocked，Delta FIFO添加操作</a><li><a href=#compute-key aria-label="Compute Key">Compute Key</a><li><a href=#keyof%e7%94%a8%e4%ba%8e%e8%ae%a1%e7%ae%97%e5%af%b9%e8%b1%a1%e7%9a%84key aria-label=keyof，用于计算对象的key>keyof，用于计算对象的key</a></ul><li><a href=#indexer aria-label=Indexer>Indexer</a><ul><li><a href=#cache%e7%9a%84%e7%bb%93%e6%9e%84 aria-label=cache的结构>cache的结构</a><li><a href=#%e4%bb%8e%e5%88%9b%e5%bb%ba%e5%bc%80%e5%a7%8b aria-label=从创建开始>从创建开始</a><li><a href=#%e6%9b%b4%e6%96%b0%e6%93%8d%e4%bd%9c aria-label=更新操作>更新操作</a><li><a href=#%e5%88%a0%e9%99%a4%e6%93%8d%e4%bd%9c aria-label=删除操作>删除操作</a><li><a href=#indexer%e4%bd%bf%e7%94%a8 aria-label=indexer使用>indexer使用</a></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=prepare>Prepare<a hidden class=anchor aria-hidden=true href=#prepare>#</a></h2><h3 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h3><p>从2016年8月起，Kubernetes官方提取了与Kubernetes相关的核心源代码，形成了一个独立的项目，即<code>client-go</code>，作为官方提供的go客户端。Kubernetes的部分代码也是基于这个项目的。</p><p><code>client-go</code> 是kubernetes中广义的客户端基础库，在Kubernetes各个组件中或多或少都有使用其功能。。也就是说，<code>client-go</code>可以在kubernetes集群中添加、删除和查询资源对象（包括deployment、service、pod、ns等）。</p><p>在了解client-go前，还需要掌握一些概念</p><ul><li>在客户端验证 API</li><li>使用证书和使用令牌，来验证客户端</li><li>kubernetes集群的访问模式</li></ul><h3 id=使用证书和令牌来验证客户端>使用证书和令牌来验证客户端<a hidden class=anchor aria-hidden=true href=#使用证书和令牌来验证客户端>#</a></h3><p>在访问apiserver时，会对访问者进行鉴权，因为是https请求，在请求时是需要ca的，也可以使用 -k 使用insecure模式</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ curl --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.4:6443/version
</span></span><span class=line><span class=cl>\{
</span></span><span class=line><span class=cl>  &#34;major&#34;: &#34;1&#34;,
</span></span><span class=line><span class=cl>  &#34;minor&#34;: &#34;18+&#34;,
</span></span><span class=line><span class=cl>  &#34;gitVersion&#34;: &#34;v1.18.20-dirty&#34;,
</span></span><span class=line><span class=cl>  &#34;gitCommit&#34;: &#34;1f3e19b7beb1cc0110255668c4238ed63dadb7ad&#34;,
</span></span><span class=line><span class=cl>  &#34;gitTreeState&#34;: &#34;dirty&#34;,
</span></span><span class=line><span class=cl>  &#34;buildDate&#34;: &#34;2022-05-17T12:45:14Z&#34;,
</span></span><span class=line><span class=cl>  &#34;goVersion&#34;: &#34;go1.16.15&#34;,
</span></span><span class=line><span class=cl>  &#34;compiler&#34;: &#34;gc&#34;,
</span></span><span class=line><span class=cl>  &#34;platform&#34;: &#34;linux/amd64&#34;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ curl -k https://10.0.0.4:6443/api/v1/namespace/default/pods/netbox
</span></span><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;kind&#34;: &#34;Status&#34;,
</span></span><span class=line><span class=cl>  &#34;apiVersion&#34;: &#34;v1&#34;,
</span></span><span class=line><span class=cl>  &#34;metadata&#34;: {
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  },
</span></span><span class=line><span class=cl>  &#34;status&#34;: &#34;Failure&#34;,
</span></span><span class=line><span class=cl>  &#34;message&#34;: &#34;namespace \&#34;default\&#34; is forbidden: User \&#34;system:anonymous\&#34; cannot get resource \&#34;namespace/pods\&#34; in API group \&#34;\&#34; at the cluster scope&#34;,
</span></span><span class=line><span class=cl>  &#34;reason&#34;: &#34;Forbidden&#34;,
</span></span><span class=line><span class=cl>  &#34;details&#34;: {
</span></span><span class=line><span class=cl>    &#34;name&#34;: &#34;default&#34;,
</span></span><span class=line><span class=cl>    &#34;kind&#34;: &#34;namespace&#34;
</span></span><span class=line><span class=cl>  },
</span></span><span class=line><span class=cl>  &#34;code&#34;: 403
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div></div></div><p>从错误中可以看出，该请求已通过身份验证，用户是 <code>system:anonymous</code>，但该用户未授权列出对应的资源。而上述请求只是忽略 curl 的https请求需要做的验证，而Kubernetes也有对应验证的机制，这个时候需要提供额外的身份信息来获得所需的访问权限。<a href=https://kubernetes.io/docs/reference/access-authn-authz/authentication/ target=_blank rel="noopener nofollow noreferrer">Kubernetes支持多种身份认证机制</a>，ssl证书也是其中一种。</p><blockquote><p>注：在Kubernetes中没有表示用户的资源。即kubernetes集群中，无法添加和创建。但由集群提供的有效证书的用户都视为允许的用户。Kubernetes从证书中的使用者CN和使用者可选名称中获得<strong>用户</strong>；然后，RBAC 判断用户是否有权限操作资源。从 Kubernetes1.4 开始，支持<strong>用户组</strong>，即证书中的O</p></blockquote><p>可以使用 curl 的 <code>--cert</code> 和 <code>--key</code> 指定用户的证书</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>curl --cacert /etc/kubernetes/pki/ca.crt  \
</span></span><span class=line><span class=cl>	--cert /etc/kubernetes/pki/apiserver-kubelet-client.crt \
</span></span><span class=line><span class=cl>	--key /etc/kubernetes/pki/apiserver-ubelet-client.key \
</span></span><span class=line><span class=cl>	https://10.0.0.4:6443/api/v1/namespaces/default/pods/netbox</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=使用serviceaccount验证客户端身份>使用serviceaccount验证客户端身份<a hidden class=anchor aria-hidden=true href=#使用serviceaccount验证客户端身份>#</a></h3><p>使用一个serviceaccount JWT，获取一个SA的方式如下</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>kubectl get secrets \
</span></span><span class=line><span class=cl>$(kubectl get serviceaccounts/default -o jsonpath=&#39;{.secrets[0].name}&#39;)  -o jsonpath=&#39;{.data.token}&#39; \
</span></span><span class=line><span class=cl>| base64 --decode
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>JWT=$(kubectl get secrets \
</span></span><span class=line><span class=cl>$(kubectl get serviceaccounts/default -o jsonpath=&#39;{.secrets[0].name}&#39;)  -o jsonpath=&#39;{.data.token}&#39; \
</span></span><span class=line><span class=cl>| base64 --decode)</span></span></code></pre></td></tr></table></div></div></div></div><p>使用secret来访问API</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>curl --cacert /etc/kubernetes/pki/ca.crt \
</span></span><span class=line><span class=cl>	--header &#34;Authorization: Bearer $JWT&#34; \
</span></span><span class=line><span class=cl>	https://10.0.0.4:6443/apis/apps/v1/namespaces/default/deployments</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=pod内部调用kubernetes-api>Pod内部调用Kubernetes API<a hidden class=anchor aria-hidden=true href=#pod内部调用kubernetes-api>#</a></h3><p>kubernete会将Kubernetes API地址通过环境变量提供给 Pod，可以通过命令看到</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>$ env|grep -i kuber
</span></span><span class=line><span class=cl>KUBERNETES_SERVICE_PORT=443
</span></span><span class=line><span class=cl>KUBERNETES_PORT=tcp://192.168.0.1:443
</span></span><span class=line><span class=cl>KUBERNETES_PORT_443_TCP_ADDR=192.168.0.1
</span></span><span class=line><span class=cl>KUBERNETES_PORT_443_TCP_PORT=443
</span></span><span class=line><span class=cl>KUBERNETES_PORT_443_TCP_PROTO=tcp
</span></span><span class=line><span class=cl>KUBERNETES_PORT_443_TCP=tcp://192.168.0.1:443
</span></span><span class=line><span class=cl>KUBERNETES_SERVICE_PORT_HTTPS=443
</span></span><span class=line><span class=cl>KUBERNETES_SERVICE_HOST=192.168.0.1</span></span></code></pre></td></tr></table></div></div></div></div><p>并且还会在将 Kubernetes CA和SA等信息放置在目录 <code>/var/run/secrets/kubernetes.io/serviceaccount/</code>，通过这些就可以从Pod内部访问API</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>cd /var/run/secrets/kubernetes.io/serviceaccount/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>curl --cacert ca.crt --header &#34;Authorization: Bearer $(cat token)&#34; https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_SERVICE_PORT/api/v1/namespaces/default/pods/netbox</span></span></code></pre></td></tr></table></div></div></div></div><h2 id=client-go>client-go<a hidden class=anchor aria-hidden=true href=#client-go>#</a></h2><h3 id=关于client-go的模块>关于client-go的模块<a hidden class=anchor aria-hidden=true href=#关于client-go的模块>#</a></h3><h4 id=k8sioapi>k8s.io/api<a hidden class=anchor aria-hidden=true href=#k8sioapi>#</a></h4><p>与Pods、ConfigMaps、Secrets和其他Kubernetes 对象所对应的数据结构都在，<a href=https://github.com/kubernetes/api target=_blank rel="noopener nofollow noreferrer"><code>k8s.io/api</code></a>，此包几乎没有算法，仅仅是数据机构，该模块有多达上千个用于描述Kubernetes中资源API的结构；通常被client，server，controller等其他的组件使用。</p><h4 id=k8sioapimachinery>k8s.io/apimachinery<a hidden class=anchor aria-hidden=true href=#k8sioapimachinery>#</a></h4><p>根据该库的<a href=https://github.com/kubernetes/apimachinery/tree/3d7c63b4de4fdee1917284129969901d4777facc#purpose target=_blank rel="noopener nofollow noreferrer">描述文件</a>可知，这个库是Server和Client中使用的Kubernetes API共享依赖库，也是kubernetes中更低一级的通用的数据结构。在我们构建自定义资源时，不需要为自定义结构创建属性，如 <code>Kind</code>, <code>apiVersion</code>，<code>name</code>&mldr;，这些都是库 <code>apimachinery</code> 所提供的功能。</p><p>如，在包 <code>k8s.io/apimachinery/pkg/apis/meta </code>定义了两个结构 <code>TypeMeta</code> 和 <code>ObjectMeta</code>；将这这两个结构嵌入自定义的结构中，可以以通用的方式兼容对象，如Kubernetes中的资源 <code>Deplyment</code> 也是这么完成的</p><center>通过图来了解Kubernetes的资源如何实现的</center><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220523211835602.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220523211835602.png#center alt=image-20220523211835602 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>如在 <code>k8s.io/apimachinery/pkg/runtime/interfaces.go</code> 中定义了 interface，这个类为在schema中注册的API都需要实现这个结构</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Object</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>GetObjectKind</span><span class=p>()</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>ObjectKind</span>
</span></span><span class=line><span class=cl>	<span class=nf>DeepCopyObject</span><span class=p>()</span> <span class=nx>Object</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220519162127427.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220519162127427.png#center alt=image-20220519162127427 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h4 id=非结构化数据>非结构化数据<a hidden class=anchor aria-hidden=true href=#非结构化数据>#</a></h4><p>非结构化数据 <code>Unstructured </code>是指在kubernete中允许将没有注册为Kubernetes API的对象，作为Json对象的方式进行操作，如，<a href=https://github.com/iximiuz/client-go-examples/blob/5b220c4572d65ea8bf0ad68e369e015902e7521c/crud-dynamic-simple/main.go#L36 target=_blank rel="noopener nofollow noreferrer">使用非结构化 Kubernetes 对象</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>desired</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>unstructured</span><span class=p>.</span><span class=nx>Unstructured</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Object</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;apiVersion&#34;</span><span class=p>:</span> <span class=s>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;kind&#34;</span><span class=p>:</span>       <span class=s>&#34;ConfigMap&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;metadata&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;namespace&#34;</span><span class=p>:</span>    <span class=nx>namespace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;generateName&#34;</span><span class=p>:</span> <span class=s>&#34;crud-dynamic-simple-&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;data&#34;</span><span class=p>:</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;foo&#34;</span><span class=p>:</span> <span class=s>&#34;bar&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h4 id=非结构化数据的转换>非结构化数据的转换<a hidden class=anchor aria-hidden=true href=#非结构化数据的转换>#</a></h4><p>在 <code>k8s.io/apimachinery/pkg/runtime.UnstructuredConverter</code> 中，也提供了将非结构化数据转换为Kubernetes API注册过的结构，参考如何将<a href=https://github.com/iximiuz/client-go-examples/tree/main/convert-unstructured-typed target=_blank rel="noopener nofollow noreferrer">非结构化对象转换为Kubernetes Object</a>。</p><h3 id=install-client-go>install client-go<a hidden class=anchor aria-hidden=true href=#install-client-go>#</a></h3><p><strong>如何选择 <code>client-go</code> 的版本</strong></p><p>​ 对于不同的kubernetes版本使用标签 <code>v0.x.y</code> 来表示对应的客户端版本。具体对应参考 <a href=https://github.com/kubernetes/client-go#compatibility-matrix target=_blank rel="noopener nofollow noreferrer">client-go</a> 。</p><p>​ 例如使用的kubernetes版本为 <code>v1.18.20</code> 则使用对应的标签 <code>v0.x.y</code> 来替换符合当前版本的客户端库。例如：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>go get k8s.io/client-go@v0.18.10</span></span></code></pre></td></tr></table></div></div></div></div><p>官网中给出了<code>client-go</code>的兼容性矩阵，可以很明了的看出如何选择适用于自己kubernetes版本的对应的client-go</p><ul><li><code>✓</code> 表示 该版本的 <code>client-go</code> 与对应的 kubernetes版本功能完全一致</li><li><code>+</code> <code>client-go</code> 具有 kubernetes apiserver中不具备的功能。</li><li><code>-</code> Kubernetes apiserver 具有<code>client-go</code> 无法使用的功。</li></ul><p>一般情况下，除了对应的版本号完全一致外，其他都存在 功能的<code>+-</code>。</p><h3 id=client-go-目录介绍>client-go 目录介绍<a hidden class=anchor aria-hidden=true href=#client-go-目录介绍>#</a></h3><p>client-go的每一个目录都是一个go package</p><ul><li><code>kubernetes</code> 包含与Kubernetes API所通信的客户端集</li><li><code>discovery</code> 用于发现kube-apiserver所支持的api</li><li><code>dynamic</code> 包含了一个动态客户端，该客户端能够对kube-apiserver任意的API进行操作。</li><li><code>transport</code> 提供了用于设置认证和启动链接的功能</li><li><code>tools/cache</code>: 一些 low-level controller与一些数据结构如fifo，reflector等</li></ul><h3 id=structure-of-client-go>structure of client-go<a hidden class=anchor aria-hidden=true href=#structure-of-client-go>#</a></h3><ul><li><p><code>RestClient</code>：是最基础的基础架构，其作用是将是使用了http包进行封装成RESTClient。位于<code>rest</code> 目录，RESTClient封装了资源URL的通用格式，例如<code>Get()</code>、<code>Put()</code>、<code>Post()</code> <code>Delete()</code>。是与Kubernetes API的访问行为提供的基于RESTful方法进行交互基础架构。</p><ul><li>同时支持Json 与 protobuf</li><li>支持所有的原生资源和CRD</li></ul></li><li><p><code>ClientSet</code>：Clientset基于RestClient进行封装对 Resource 与 version 管理集合；<a href=https://pkg.go.dev/k8s.io/client-go@v0.24.0/kubernetes#NewForConfig target=_blank rel="noopener nofollow noreferrer">如何创建</a></p></li><li><p><code>DiscoverySet</code>：RestClient进行封装，可动态发现 kube-apiserver 所支持的 GVR（Group Version Resource）；<a href=https://pkg.go.dev/k8s.io/client-go@v0.24.0/discovery#NewDiscoveryClient target=_blank rel="noopener nofollow noreferrer">如何创建</a>，这种类型是一种非映射至clientset的客户端</p></li><li><p><code>DynamicClient</code>：基于RestClient，包含动态的客户端，可以对Kubernetes所支持的 API对象进行操作，包括CRD；<a href=https://pkg.go.dev/k8s.io/client-go@v0.24.0/dynamic#NewForConfig target=_blank rel="noopener nofollow noreferrer">如何创建</a></p></li><li><p>仅支持json</p></li><li><p><code>fakeClient</code>， <code>client-go</code> 实现的mock对象，主要用于单元测试。</p></li></ul><p>以上client-go所提供的客户端，仅可使用kubeconfig进行连接。</p><h3 id=什么是clientset>什么是clientset<a hidden class=anchor aria-hidden=true href=#什么是clientset>#</a></h3><p>clientset代表了kubernetes中所有的资源类型，这里不包含CRD的资源，如：</p><ul><li><code>core</code></li><li><code>extensions</code></li><li><code>batch</code></li><li>&mldr;</li></ul><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220518185246688.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220518185246688.png#center alt=image-20220518185246688 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h3 id=client-go使用>client-go使用<a hidden class=anchor aria-hidden=true href=#client-go使用>#</a></h3><p><strong>DynamicClient客户端</strong></p><ul><li><p>与 ClientSet 的区别是，可以对任意 Kubernetes 资源进行 RESTful 操作。同样提供管理的方法</p></li><li><p>最大的不同，ClientSet 需要预先实现每种 Resource 和 Version 的操作，内部的数据都是结构化数据（已知数据结构）；DynamicClient 内部实现了 Unstructured，用于处理非结构化的数据（无法提前预知的数据结构），这是其可以处理 CRD 自定义资源的关键。</p></li></ul><p><strong>dynamicClient 实现流程</strong></p><ul><li><p>通过 NewForConfig 实例化 conf 为 DynamicInterface客户端</p></li><li><p><code>DynamicInterface </code>客户端中，实现了一个<code>Resource</code> 方法即为实现了<code>Interface</code>接口</p></li><li><p><code>dynamicClient</code> 实现了非结构化数据类型与rest client，可以通过其方法将<code>Resource</code> 由rest从apiserver中获得api对象，<code>runtime.DeafultUnstructuredConverter.FromUnstructrued</code> 转为对应的类型。</p></li></ul><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220522223023430.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220522223023430.png#center alt=image-20220522223023430 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><hr><p>注意：<code>GVR </code>中资源类型 resource为复数。<code>kind:Pod</code> 即为 <code>Pods</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;flag&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;os&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>v1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/dynamic&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/kubernetes&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/rest&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/util/homedir&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>k8sconfig</span>  <span class=o>*</span><span class=kt>string</span> <span class=c1>//使用kubeconfig配置文件进行集群权限认证
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>restConfig</span> <span class=o>*</span><span class=nx>rest</span><span class=p>.</span><span class=nx>Config</span>
</span></span><span class=line><span class=cl>		<span class=nx>err</span>        <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>home</span> <span class=o>:=</span> <span class=nx>homedir</span><span class=p>.</span><span class=nf>HomeDir</span><span class=p>();</span> <span class=nx>home</span> <span class=o>!=</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>k8sconfig</span> <span class=p>=</span> <span class=nx>flag</span><span class=p>.</span><span class=nf>String</span><span class=p>(</span><span class=s>&#34;kubeconfig&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;%s/.kube/config&#34;</span><span class=p>,</span> <span class=nx>home</span><span class=p>),</span> <span class=s>&#34;kubernetes auth config&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>k8sconfig</span> <span class=p>=</span> <span class=nx>k8sconfig</span>
</span></span><span class=line><span class=cl>	<span class=nx>flag</span><span class=p>.</span><span class=nf>Parse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Stat</span><span class=p>(</span><span class=o>*</span><span class=nx>k8sconfig</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>restConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>rest</span><span class=p>.</span><span class=nf>InClusterConfig</span><span class=p>();</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 这里是从masterUrl 或者 kubeconfig传入集群的信息，两者选一
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>restConfig</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>clientcmd</span><span class=p>.</span><span class=nf>BuildConfigFromFlags</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span> <span class=o>*</span><span class=nx>k8sconfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 创建客户端类型
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// NewForConfig creates a new dynamic client or returns an error.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// dynamic.NewForConfig(restConfig)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// NewForConfig creates a new Clientset for the given config
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// kubernetes.NewForConfig(restConfig)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// NewDiscoveryClientForConfig creates a new DiscoveryClient for the given config.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//clientset, err := discovery.NewDiscoveryClientForConfig(restConfig)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dynamicset</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dynamic</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>restConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 这里遵循的是 kubernetes Rest API，如Pod是
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// /api/v1/namespaces/{namespace}/pods
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// /apis/apps/v1/namespaces/{namespace}/deployments
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 遵循GVR格式填写
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>podList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dynamicset</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Group</span><span class=p>:</span>    <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Version</span><span class=p>:</span>  <span class=s>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Resource</span><span class=p>:</span> <span class=s>&#34;pods&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}).</span><span class=nf>Namespace</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>daemonsetList</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dynamicset</span><span class=p>.</span><span class=nf>Resource</span><span class=p>(</span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>Group</span><span class=p>:</span>    <span class=s>&#34;apps&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Version</span><span class=p>:</span>  <span class=s>&#34;v1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Resource</span><span class=p>:</span> <span class=s>&#34;daemonsets&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}).</span><span class=nf>Namespace</span><span class=p>(</span><span class=s>&#34;kube-system&#34;</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>row</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podList</span><span class=p>.</span><span class=nx>Items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>row</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>row</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>daemonsetList</span><span class=p>.</span><span class=nx>Items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>row</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// clientset mode
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>clientset</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nf>NewForConfig</span><span class=p>(</span><span class=nx>restConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>podIns</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>clientset</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>Pods</span><span class=p>(</span><span class=s>&#34;default&#34;</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>row</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>podIns</span><span class=p>.</span><span class=nx>Items</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>row</span><span class=p>.</span><span class=nf>GetName</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><blockquote><p>Extension</p><p><a href=http://yuezhizizhang.github.io/kubernetes/kubectl/client-go/2020/05/13/kubectl-client-go-part-2.html target=_blank rel="noopener nofollow noreferrer">一些client-go使用</a></p></blockquote><h2 id=informer>Informer<a hidden class=anchor aria-hidden=true href=#informer>#</a></h2><p>informer是client-go提供的 <strong>Listwatcher</strong> 接口，主要作为 Controller构成的组件，在Kubernetes中， Controller的一个重要作用是观察对象的期望状态 <code>spec</code> 和实际状态 <code>statue</code> 。<strong>为了观察对象的状态，Controller需要向 Apiserver发送请求</strong>；但是通常情况下，频繁向Apiserver发出请求的会增加etcd的压力，为了解决这类问题，<code>client-go</code> 一个缓存，通过缓存，控制器可以不必发出大量请求，并且只关心对象的事件。也就是 informer。</p><p>从本质上来讲，informer是使用kubernetes API观察其变化，来维护状态的缓存，称为 <code>indexer</code>；并通过对应事件函数通知客户端信息的变化，informer为一系列组件，通过这些组件来实现的这些功能。</p><ul><li>Reflector：与 apiserver交互的组件</li><li>Delta FIFO：一个特殊的队列，Reflector将状态的变化存储在里面</li><li>indexer：本地存储，与etcd保持一致，减轻API Server与etcd的压力</li><li>Processor：监听处理器，通过将监听到的事件发送给对应的监听函数</li><li>Controller：从队列中对整个数据的编排处理的过程</li></ul><h3 id=informer的工作模式>informer的工作模式<a hidden class=anchor aria-hidden=true href=#informer的工作模式>#</a></h3><p>首先通过<code>List</code>从Kubernetes API中获取资源所有对象并同时缓存，然后通过<code>Watch</code>机制监控资源。这样，通过informer与缓存，就可以直接和informer交互，而不用每次都和Kubernetes API交互。</p><p>另外，<code>informer</code> 还提供了事件的处理机制，以便 Controller 或其他应用程序根据回调钩子函数等处理特定的业务逻辑。因为<code>Informer</code>可以通过<code>List/Watch</code>机制监控所有资源的所有事件，只要在<code>Informer</code>中添加<code>ResourceEventHandler</code>实例的回调函数，如：<code>onadd(obj interface {})</code>, <code>onupdate (oldobj, newobj interface {})</code>和<code>OnDelete( obj interface {})</code> 可以实现处理资源的创建、更新和删除。 在Kubernetes中，各种控制器都使用了Informer。</p><h3 id=分析informer的流程>分析informer的流程<a hidden class=anchor aria-hidden=true href=#分析informer的流程>#</a></h3><p>通过代码 <a href=https://github.com/kubernetes/client-go/blob/master/informers/apps/v1/deployment.go target=_blank rel="noopener nofollow noreferrer">k8s.io/client-go/informers/apps/v1/deployment.go</a> 可以看出，在每个控制器下，都实现了一个 <code>Informer</code> 和 <code>Lister</code> ，Lister就是indexer；</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>SharedInformer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 添加一个事件处理函数，使用informer默认的resync period
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>ResourceEventHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将事件处理函数注册到 share informer，将resyncPeriod作为参数传入
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>AddEventHandlerWithResyncPeriod</span><span class=p>(</span><span class=nx>handler</span> <span class=nx>ResourceEventHandler</span><span class=p>,</span> <span class=nx>resyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 从本地缓存获取的信息作为infomer的返回
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>GetStore</span><span class=p>()</span> <span class=nx>Store</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 已弃用
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>GetController</span><span class=p>()</span> <span class=nx>Controller</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 运行一个informer，当stopCh停止时，informer也被关闭
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=c1>// HasSynced returns true if the shared informer&#39;s store has been
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// informed by at least one full LIST of the authoritative state
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// of the informer&#39;s object collection.  This is unrelated to &#34;resync&#34;.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>HasSynced</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// LastSyncResourceVersion is the resource version observed when last synced with the underlying store. The value returned is not synchronized with access to the underlying store and is not thread-safe.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>LastSyncResourceVersion</span><span class=p>()</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 Shared Informer 对所有的API组提供一个shared informer</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// SharedInformerFactory provides shared informers for resources in all known
</span></span></span><span class=line><span class=cl><span class=c1>// API group versions.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>SharedInformerFactory</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>internalinterfaces</span><span class=p>.</span><span class=nx>SharedInformerFactory</span>
</span></span><span class=line><span class=cl>	<span class=nf>ForResource</span><span class=p>(</span><span class=nx>resource</span> <span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionResource</span><span class=p>)</span> <span class=p>(</span><span class=nx>GenericInformer</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>WaitForCacheSync</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=kd>map</span><span class=p>[</span><span class=nx>reflect</span><span class=p>.</span><span class=nx>Type</span><span class=p>]</span><span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nf>Admissionregistration</span><span class=p>()</span> <span class=nx>admissionregistration</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Apps</span><span class=p>()</span> <span class=nx>apps</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Auditregistration</span><span class=p>()</span> <span class=nx>auditregistration</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Autoscaling</span><span class=p>()</span> <span class=nx>autoscaling</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Batch</span><span class=p>()</span> <span class=nx>batch</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Certificates</span><span class=p>()</span> <span class=nx>certificates</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Coordination</span><span class=p>()</span> <span class=nx>coordination</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Core</span><span class=p>()</span> <span class=nx>core</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Discovery</span><span class=p>()</span> <span class=nx>discovery</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Events</span><span class=p>()</span> <span class=nx>events</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Extensions</span><span class=p>()</span> <span class=nx>extensions</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Flowcontrol</span><span class=p>()</span> <span class=nx>flowcontrol</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Networking</span><span class=p>()</span> <span class=nx>networking</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Node</span><span class=p>()</span> <span class=nx>node</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Policy</span><span class=p>()</span> <span class=nx>policy</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Rbac</span><span class=p>()</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Scheduling</span><span class=p>()</span> <span class=nx>scheduling</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Settings</span><span class=p>()</span> <span class=nx>settings</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>	<span class=nf>Storage</span><span class=p>()</span> <span class=nx>storage</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看到在 <a href=https://github.com/kubernetes/kubernetes/blob/v1.9.0/staging/src/k8s.io/client-go/informers/apps/v1/deployment.go target=_blank rel="noopener nofollow noreferrer">k8s.io/client-go/informers/apps/v1/deployment.go</a> 实现了这个interface</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DeploymentInformer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>Informer</span><span class=p>()</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>SharedIndexInformer</span>
</span></span><span class=line><span class=cl>   <span class=nf>Lister</span><span class=p>()</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>DeploymentLister</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而在对应的 deployment controller中会调用这个<code>Informer</code> 实现对状态的监听；``</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewDeploymentController creates a new DeploymentController.
</span></span></span><span class=line><span class=cl><span class=c1>//  appsinformers.DeploymentInformer就是client-go 中的 /apps/v1/deployment实现的informer
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewDeploymentController</span><span class=p>(</span><span class=nx>dInformer</span> <span class=nx>appsinformers</span><span class=p>.</span><span class=nx>DeploymentInformer</span><span class=p>,</span> <span class=nx>rsInformer</span> <span class=nx>appsinformers</span><span class=p>.</span><span class=nx>ReplicaSetInformer</span><span class=p>,</span> <span class=nx>podInformer</span> <span class=nx>coreinformers</span><span class=p>.</span><span class=nx>PodInformer</span><span class=p>,</span> <span class=nx>client</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>DeploymentController</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventBroadcaster</span> <span class=o>:=</span> <span class=nx>record</span><span class=p>.</span><span class=nf>NewBroadcaster</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventBroadcaster</span><span class=p>.</span><span class=nf>StartLogging</span><span class=p>(</span><span class=nx>klog</span><span class=p>.</span><span class=nx>Infof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>eventBroadcaster</span><span class=p>.</span><span class=nf>StartRecordingToSink</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>v1core</span><span class=p>.</span><span class=nx>EventSinkImpl</span><span class=p>{</span><span class=nx>Interface</span><span class=p>:</span> <span class=nx>client</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>Events</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>client</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>&amp;&amp;</span> <span class=nx>client</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>RESTClient</span><span class=p>().</span><span class=nf>GetRateLimiter</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>ratelimiter</span><span class=p>.</span><span class=nf>RegisterMetricAndTrackRateLimiterUsage</span><span class=p>(</span><span class=s>&#34;deployment_controller&#34;</span><span class=p>,</span> <span class=nx>client</span><span class=p>.</span><span class=nf>CoreV1</span><span class=p>().</span><span class=nf>RESTClient</span><span class=p>().</span><span class=nf>GetRateLimiter</span><span class=p>());</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>DeploymentController</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>client</span><span class=p>:</span>        <span class=nx>client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>eventRecorder</span><span class=p>:</span> <span class=nx>eventBroadcaster</span><span class=p>.</span><span class=nf>NewRecorder</span><span class=p>(</span><span class=nx>scheme</span><span class=p>.</span><span class=nx>Scheme</span><span class=p>,</span> <span class=nx>v1</span><span class=p>.</span><span class=nx>EventSource</span><span class=p>{</span><span class=nx>Component</span><span class=p>:</span> <span class=s>&#34;deployment-controller&#34;</span><span class=p>}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>queue</span><span class=p>:</span>         <span class=nx>workqueue</span><span class=p>.</span><span class=nf>NewNamedRateLimitingQueue</span><span class=p>(</span><span class=nx>workqueue</span><span class=p>.</span><span class=nf>DefaultControllerRateLimiter</span><span class=p>(),</span> <span class=s>&#34;deployment&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>rsControl</span> <span class=p>=</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>RealRSControl</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>KubeClient</span><span class=p>:</span> <span class=nx>client</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>Recorder</span><span class=p>:</span>   <span class=nx>dc</span><span class=p>.</span><span class=nx>eventRecorder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>dInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>dc</span><span class=p>.</span><span class=nx>addDeployment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>dc</span><span class=p>.</span><span class=nx>updateDeployment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=c1>// This will enter the sync loop and no-op, because the deployment has been deleted from the store.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>dc</span><span class=p>.</span><span class=nx>deleteDeployment</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>rsInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>AddFunc</span><span class=p>:</span>    <span class=nx>dc</span><span class=p>.</span><span class=nx>addReplicaSet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>UpdateFunc</span><span class=p>:</span> <span class=nx>dc</span><span class=p>.</span><span class=nx>updateReplicaSet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>dc</span><span class=p>.</span><span class=nx>deleteReplicaSet</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>podInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nf>AddEventHandler</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>ResourceEventHandlerFuncs</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>DeleteFunc</span><span class=p>:</span> <span class=nx>dc</span><span class=p>.</span><span class=nx>deletePod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>syncHandler</span> <span class=p>=</span> <span class=nx>dc</span><span class=p>.</span><span class=nx>syncDeployment</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>enqueueDeployment</span> <span class=p>=</span> <span class=nx>dc</span><span class=p>.</span><span class=nx>enqueue</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>dLister</span> <span class=p>=</span> <span class=nx>dInformer</span><span class=p>.</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>rsLister</span> <span class=p>=</span> <span class=nx>rsInformer</span><span class=p>.</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>podLister</span> <span class=p>=</span> <span class=nx>podInformer</span><span class=p>.</span><span class=nf>Lister</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>dListerSynced</span> <span class=p>=</span> <span class=nx>dInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nx>HasSynced</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>rsListerSynced</span> <span class=p>=</span> <span class=nx>rsInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nx>HasSynced</span>
</span></span><span class=line><span class=cl>	<span class=nx>dc</span><span class=p>.</span><span class=nx>podListerSynced</span> <span class=p>=</span> <span class=nx>podInformer</span><span class=p>.</span><span class=nf>Informer</span><span class=p>().</span><span class=nx>HasSynced</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>dc</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=reflector>Reflector<a hidden class=anchor aria-hidden=true href=#reflector>#</a></h2><p>reflector是client-go中负责监听 Kubernetes API 的组件，也是整个机制中的生产者，负责将 watch到的数据将其放入 <code>watchHandler</code> 中的delta FIFO队列中。也就是吧etcd的数据反射为 delta fifo的数据</p><p>在代码 <a href=https://github.com/kubernetes/kubernetes/blob/v1.9.0/staging/src/k8s.io/client-go/tools/cache/reflector.go target=_blank rel="noopener nofollow noreferrer">k8s.io/client-go/tools/cache/reflector.go</a> 中定义了 Reflector 对象</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Reflector</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// reflector的名称，默认为一个 file:line的格式
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>name</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 期待的类型名称，这里只做展示用，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 如果提供，是一个expectedGVK字符串类型，否则是expectedType字符串类型
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>expectedTypeName</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 期待放置在存储中的类型，如果是一个非格式化数据，那么其 APIVersion与Kind也必须为正确的格式
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>expectedType</span> <span class=nx>reflect</span><span class=p>.</span><span class=nx>Type</span>
</span></span><span class=line><span class=cl>    <span class=c1>// GVK 存储中的对象，是GVK格式
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>expectedGVK</span> <span class=o>*</span><span class=nx>schema</span><span class=p>.</span><span class=nx>GroupVersionKind</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 同步数据的存储
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>store</span> <span class=nx>Store</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 这个是reflector的一个核心，提供了 List和Watch功能
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>listerWatcher</span> <span class=nx>ListerWatcher</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// backoff manages backoff of ListWatch
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>backoffManager</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>BackoffManager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>resyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nx>ShouldResync</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// clock allows tests to manipulate time
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>clock</span> <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>	<span class=nx>paginatedResult</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 最后资源的版本号
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lastSyncResourceVersion</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当 lastSyncResourceVersion 过期或者版本太大，这个值将为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>isLastSyncResourceVersionUnavailable</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 读写锁，对lastSyncResourceVersion的读写操作的保护
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lastSyncResourceVersionMutex</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>	<span class=c1>// WatchListPageSize is the requested chunk size of initial and resync watch lists.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// scalability problems.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 是初始化时，或者重新同步时的块大小。如果没有设置，将为任意的旧数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 因为是提供了分页功能，RV=0则为默认的页面大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>WatchListPageSize</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 方法 <code>NewReflector()</code> 给用户提供了一个初始化 Reflector的接口</p><p>在 cotroller.go 中会初始化一个 relector</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>controller</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>&lt;-</span><span class=nx>stopCh</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Queue</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nf>NewReflector</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ListerWatcher</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ObjectType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Queue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>FullResyncPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Reflector下有三个可对用户提供的方法，<code>Run()</code>, <code>ListAndWatch()</code> , <code>LastSyncResourceVersion()</code></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220519222729807.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220519222729807.png#center alt=image-20220519222729807 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p><code>Run()</code> 是对Reflector的运行，也就是对 <code>ListAndWatch()</code> ；</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>Reflector</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Starting reflector %s (%s) from %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>resyncPeriod</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>wait</span><span class=p>.</span><span class=nf>BackoffUntil</span><span class=p>(</span><span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>ListAndWatch</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>},</span> <span class=nx>r</span><span class=p>.</span><span class=nx>backoffManager</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Stopping reflector %s (%s) from %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>resyncPeriod</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>而 <code>ListAndWatch()</code> 则是实际上真实的对Reflector业务的执行</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 前面一些都是对信息的初始化与日志输出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>Reflector</span><span class=p>)</span> <span class=nf>ListAndWatch</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>3</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Listing and watching %v from %s&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>resourceVersion</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>options</span> <span class=o>:=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{</span><span class=nx>ResourceVersion</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nf>relistResourceVersion</span><span class=p>()}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 分页功能
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=kd>func</span><span class=p>()</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>initTrace</span> <span class=o>:=</span> <span class=nx>trace</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=s>&#34;Reflector ListAndWatch&#34;</span><span class=p>,</span> <span class=nx>trace</span><span class=p>.</span><span class=nx>Field</span><span class=p>{</span><span class=s>&#34;name&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nx>initTrace</span><span class=p>.</span><span class=nf>LogIfLong</span><span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>list</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>paginatedResult</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>		<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>		<span class=nx>listCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{},</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>panicCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>interface</span><span class=p>{},</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=o>...</span><span class=p>.</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 清理和重新同步的一些
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>resyncerrc</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>error</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>cancelCh</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nb>close</span><span class=p>(</span><span class=nx>cancelCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=o>...</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// give the stopCh a chance to stop the loop, even in case of continue statements further down on errors
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>stopCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>timeoutSeconds</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>minWatchTimeout</span><span class=p>.</span><span class=nf>Seconds</span><span class=p>()</span> <span class=o>*</span> <span class=p>(</span><span class=nx>rand</span><span class=p>.</span><span class=nf>Float64</span><span class=p>()</span> <span class=o>+</span> <span class=mf>1.0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nx>options</span> <span class=p>=</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ResourceVersion</span><span class=p>:</span> <span class=nx>resourceVersion</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 为了避免watch的挂起设置一个超时
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 仅在工作窗口期，处理任何时间
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>TimeoutSeconds</span><span class=p>:</span> <span class=o>&amp;</span><span class=nx>timeoutSeconds</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=c1>// To reduce load on kube-apiserver on watch restarts, you may enable watch bookmarks.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// Reflector doesn&#39;t assume bookmarks are returned at all (if the server do not support
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// watch bookmarks, it will ignore this field).
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>AllowWatchBookmarks</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>start</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>clock</span><span class=p>.</span><span class=nf>Now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 开始监听
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>w</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>listerWatcher</span><span class=p>.</span><span class=nf>Watch</span><span class=p>(</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nf>isExpiredError</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 没有设置 LastSyncResourceVersionExpired 也就是过期，会保持与返回数据相同的
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=c1>// 首次会先将RV列出
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: watch of %v closed with: %v&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>case</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=c1>// 通常为watch关闭
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>case</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>ErrUnexpectedEOF</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: Watch for %v closed with unexpected EOF: %v&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>				<span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleError</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;%s: Failed to watch %v: %v&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 如果出现 connection refuse，通常与apisserver通讯失败，这个时候会重新发送请求
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=nx>utilnet</span><span class=p>.</span><span class=nf>IsConnectionRefused</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>continue</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>watchHandler</span><span class=p>(</span><span class=nx>start</span><span class=p>,</span> <span class=nx>w</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>resourceVersion</span><span class=p>,</span> <span class=nx>resyncerrc</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=nx>errorStopRequested</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>switch</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>case</span> <span class=nf>isExpiredError</span><span class=p>(</span><span class=nx>err</span><span class=p>):</span>
</span></span><span class=line><span class=cl>					<span class=c1>// 同上步骤的功能
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>4</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;%s: watch of %v closed with: %v&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>default</span><span class=p>:</span>
</span></span><span class=line><span class=cl>					<span class=nx>klog</span><span class=p>.</span><span class=nf>Warningf</span><span class=p>(</span><span class=s>&#34;%s: watch of %v ended with: %v&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>expectedTypeName</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>那么在实现时，如 deploymentinformer,会实现 Listfunc和 watchfunc，这其实就是clientset中的操作方法，也是就list与watch</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewFilteredDeploymentInformer</span><span class=p>(</span><span class=nx>client</span> <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=nx>namespace</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>resyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span><span class=p>,</span> <span class=nx>indexers</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>Indexers</span><span class=p>,</span> <span class=nx>tweakListOptions</span> <span class=nx>internalinterfaces</span><span class=p>.</span><span class=nx>TweakListOptionsFunc</span><span class=p>)</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>SharedIndexInformer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewSharedIndexInformer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=nx>cache</span><span class=p>.</span><span class=nx>ListWatch</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ListFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>options</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>)</span> <span class=p>(</span><span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>tweakListOptions</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>tweakListOptions</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>client</span><span class=p>.</span><span class=nf>AppsV1</span><span class=p>().</span><span class=nf>Deployments</span><span class=p>(</span><span class=nx>namespace</span><span class=p>).</span><span class=nf>List</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>			<span class=nx>WatchFunc</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>options</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ListOptions</span><span class=p>)</span> <span class=p>(</span><span class=nx>watch</span><span class=p>.</span><span class=nx>Interface</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>tweakListOptions</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>tweakListOptions</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>client</span><span class=p>.</span><span class=nf>AppsV1</span><span class=p>().</span><span class=nf>Deployments</span><span class=p>(</span><span class=nx>namespace</span><span class=p>).</span><span class=nf>Watch</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>TODO</span><span class=p>(),</span> <span class=nx>options</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=o>&amp;</span><span class=nx>appsv1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>resyncPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>indexers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>tools/cache/controller.go</code> 是存储controller的配置及实现。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Config</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Queue</span> <span class=c1>// 对象的队列，必须为DeltaFIFO
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ListerWatcher</span> <span class=c1>// 这里能够监视并列出对象的一些信息，这个对象接受process函数的弹出
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Something that can process a popped Deltas.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Process</span> <span class=nx>ProcessFunc</span> <span class=c1>// 处理Delta的弹出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 对象类型，这个controller期待的处理类型，其apiServer与kind必须正确，即，GVR必须正确
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ObjectType</span> <span class=nx>runtime</span><span class=p>.</span><span class=nx>Object</span>
</span></span><span class=line><span class=cl>        <span class=c1>// FullResyncPeriod是每次重新同步的时间间隔
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>FullResyncPeriod</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Duration</span>
</span></span><span class=line><span class=cl>        <span class=c1>// type ShouldResyncFunc func() bool
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 返回值nil或true，则表示reflector继续同步
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ShouldResync</span> <span class=nx>ShouldResyncFunc</span>
</span></span><span class=line><span class=cl>    <span class=nx>RetryOnError</span> <span class=kt>bool</span> <span class=c1>// 标志位，true时，在process()返回错误时重新排列对象
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Called whenever the ListAndWatch drops the connection with an error.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 断开连接是出现错误调用这个函数处理
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>WatchErrorHandler</span> <span class=nx>WatchErrorHandler</span>
</span></span><span class=line><span class=cl>	<span class=c1>// WatchListPageSize is the requested chunk size of initial and relist watch lists.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>WatchListPageSize</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>实现这个接口</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>controller</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>config</span>         <span class=nx>Config</span>
</span></span><span class=line><span class=cl>	<span class=nx>reflector</span>      <span class=o>*</span><span class=nx>Reflector</span>
</span></span><span class=line><span class=cl>	<span class=nx>reflectorMutex</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>clock</span>          <span class=nx>clock</span><span class=p>.</span><span class=nx>Clock</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>New()</code> 为给定controller 配置的设置，即为上面的config struct，用来初始化controller对象</p><p><code>NewInformer()</code> ：返回一个store（保存数据的最终接口）和一个用于store的controller，同时提供事件的通知(crud)等</p><p><code>NewIndexerInformer()</code>：返回一个索引与一个用于索引填充的控制器</p><p>控制器的run()的功能实现</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>controller</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>utilruntime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span> <span class=c1>// 延迟销毁
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>  <span class=c1>// 信号处理，用于线程管理
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>&lt;-</span><span class=nx>stopCh</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Queue</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span> 
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nf>NewReflector</span><span class=p>(</span>  <span class=c1>// 初始化Reflector
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ListerWatcher</span><span class=p>,</span> <span class=c1>// ls
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ObjectType</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>Queue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>FullResyncPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>ShouldResync</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>ShouldResync</span> <span class=c1>// 配置是否应该继续同步
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>r</span><span class=p>.</span><span class=nx>WatchListPageSize</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>WatchListPageSize</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span><span class=p>.</span><span class=nx>clock</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>clock</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>WatchErrorHandler</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=c1>// 断开连接错误处理
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>r</span><span class=p>.</span><span class=nx>watchErrorHandler</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>config</span><span class=p>.</span><span class=nx>WatchErrorHandler</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>reflectorMutex</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>reflector</span> <span class=p>=</span> <span class=nx>r</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>reflectorMutex</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>wg</span> <span class=nx>wait</span><span class=p>.</span><span class=nx>Group</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>wg</span><span class=p>.</span><span class=nf>StartWithChannel</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Run</span><span class=p>)</span> <span class=c1>// 这里是真正的运行。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// processLoop() 是DeltaFIFO的消费者方法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>c</span><span class=p>.</span><span class=nx>processLoop</span><span class=p>,</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span> <span class=c1>// 消费队列的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>wg</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h3><p>在controller的初始化时就初始化了Reflector， controller.Run里面Reflector是结构体初始化时的Reflector，主要作用是watch指定的资源，并且将变化同步到本地的<code>store</code>中。</p><p>Reflector接着执行ListAndWatch函数，ListAndWatch第一次会列出所有的对象，并获取资源对象的版本号，然后watch资源对象的版本号来查看是否有被变更。首先会将资源版本号设置为0，<code>list()</code>可能会导致本地的缓存相对于etcd里面的内容存在延迟，<code>Reflector</code>会通过<code>watch</code>的方法将延迟的部分补充上，使得本地缓存数据与etcd的数据保持一致。</p><p><code>controller.Run</code>函数还会调用processLoop函数，processLoop通过调用HandleDeltas，再调用distribute，processorListener.add最终将不同更新类型的对象加入<code>processorListener</code>的channel中，供processorListener.Run使用。</p><h2 id=delta-fifo>Delta FIFO<a hidden class=anchor aria-hidden=true href=#delta-fifo>#</a></h2><p>通过下图可以看出，<code>Delta FIFO</code> 是位于Reflector中的一个FIFO队列，那么 <code>Delta FIFO</code> 究竟是什么，让我们来进一步深剖。</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1iI8uFsPRBY5m_g_WW4huMQ.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/1iI8uFsPRBY5m_g_WW4huMQ.png#center alt=img onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图源于：https://miro.medium.com/max/700/1*iI8uFsPRBY5m_g_WW4huMQ.png</center><p>在代码中的注释可以看到一些信息，根据信息可以总结出</p><ul><li>Delta FIFO 是一个生产者-消费者的队列，生产者是 <code>Reflector</code>，消费者是 <code>Pop()</code></li><li>与传统的FIFO有两点不同<ul><li>Delta FIFO</li></ul></li></ul><p>Delta FIFO也是实现了 Queue以及一些其他 interface 的类，</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520174110756.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520174110756.png#center alt=image-20220520174110756 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>DeltaFIFO</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>lock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>  <span class=c1>// 一个读写锁，保证线程安全
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cond</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>
</span></span><span class=line><span class=cl>	<span class=nx>items</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Deltas</span> <span class=c1>// 存放的类型是一个key[string] =》 value[Delta] 类型的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>queue</span> <span class=p>[]</span><span class=kt>string</span>  <span class=c1>// 用于存储item的key，是一个fifo
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>populated</span> <span class=kt>bool</span> <span class=c1>// populated 是用来标记首次被加入的数据是否被变动
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>initialPopulationCount</span> <span class=kt>int</span> <span class=c1>// 首次调用 replace() 的数量
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>keyFunc</span> <span class=nx>KeyFunc</span>
</span></span><span class=line><span class=cl>	<span class=nx>knownObjects</span> <span class=nx>KeyListerGetter</span> <span class=c1>// 这里为indexer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>closed</span>     <span class=kt>bool</span>       <span class=c1>// 代表已关闭
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>closedLock</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl>    <span class=nx>emitDeltaTypeReplaced</span> <span class=kt>bool</span> <span class=c1>// 表示事件的类型，true为 replace(), false 为 sync()
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>那么delta的类型是，也就是说通常情况下，Delta为一个 <code>string[runtime.object]</code> 的对象</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Delta</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Type</span>   <span class=nx>DeltaType</span> <span class=c1>// 这就是一个string
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Object</span> <span class=kd>interface</span><span class=p>{}</span> <span class=c1>// 之前API部分有了解到，API的类型大致为两类，runtime.Object和非结构化数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><a href=k8s.io/>apimachinery/pkg/runtime/interfaces.go</a></p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520182830431.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520182830431.png#center alt=image-20220520182830431 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><p>那么此时，已经明白了Delta FIFO的结构，为一个Delta的队列，整个结构如下</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520191654098.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520191654098.png#center alt=image-20220520191654098 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h3 id=第一步创建一个delta-fifo>第一步创建一个Delta FIFO<a hidden class=anchor aria-hidden=true href=#第一步创建一个delta-fifo>#</a></h3><p>现在版本中，对创建Delta FIFO是通过函数 <code>NewDeltaFIFOWithOptions()</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>NewDeltaFIFOWithOptions</span><span class=p>(</span><span class=nx>opts</span> <span class=nx>DeltaFIFOOptions</span><span class=p>)</span> <span class=o>*</span><span class=nx>DeltaFIFO</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>KeyFunction</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>opts</span><span class=p>.</span><span class=nx>KeyFunction</span> <span class=p>=</span> <span class=nx>MetaNamespaceKeyFunc</span> <span class=c1>// 默认的计算key的方法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>DeltaFIFO</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>items</span><span class=p>:</span>        <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Deltas</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>queue</span><span class=p>:</span>        <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>keyFunc</span><span class=p>:</span>      <span class=nx>opts</span><span class=p>.</span><span class=nx>KeyFunction</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>knownObjects</span><span class=p>:</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>KnownObjects</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=nx>emitDeltaTypeReplaced</span><span class=p>:</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>EmitDeltaTypeReplaced</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>f</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nx>L</span> <span class=p>=</span> <span class=o>&amp;</span><span class=nx>f</span><span class=p>.</span><span class=nx>lock</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>f</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=queueactionlockeddelta-fifo添加操作>queueActionLocked，Delta FIFO添加操作<a hidden class=anchor aria-hidden=true href=#queueactionlockeddelta-fifo添加操作>#</a></h3><p>这里说下之前说道的，在追加时的操作 <code>queueActionLocked</code> ，如add update delete实际上走的都是这里</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>DeltaFIFO</span><span class=p>)</span> <span class=nf>queueActionLocked</span><span class=p>(</span><span class=nx>actionType</span> <span class=nx>DeltaType</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>KeyOf</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=c1>// 计算key
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>KeyError</span><span class=p>{</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 把新数据添加到DeltaFIFO中，Detal就是 动作为key，对象为值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// item是DeltaFIFO中维护的一个 map[string]Deltas
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>newDeltas</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>id</span><span class=p>],</span> <span class=nx>Delta</span><span class=p>{</span><span class=nx>actionType</span><span class=p>,</span> <span class=nx>obj</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>newDeltas</span> <span class=p>=</span> <span class=nf>dedupDeltas</span><span class=p>(</span><span class=nx>newDeltas</span><span class=p>)</span> <span class=c1>// 去重，去重我们前面讨论过了
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>newDeltas</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>exists</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>id</span><span class=p>];</span> <span class=p>!</span><span class=nx>exists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>f</span><span class=p>.</span><span class=nx>queue</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>queue</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=c1>// 不存在则添加
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>id</span><span class=p>]</span> <span class=p>=</span> <span class=nx>newDeltas</span>
</span></span><span class=line><span class=cl>		<span class=nx>f</span><span class=p>.</span><span class=nx>cond</span><span class=p>.</span><span class=nf>Broadcast</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>delete</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>,</span> <span class=nx>id</span><span class=p>)</span> <span class=c1>// 这里走不到，因为添加更新等操作用newDelta是1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 源码中也说要忽略这里
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在FIFO继承的Stroe的方法中，如，Add, Update等都是需要去重的，去重的操作是通过对比最后一个和倒数第二个值</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520222611473.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220520222611473.png#center alt=image-20220520222611473 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>DeltaFIFO</span><span class=p>)</span> <span class=nf>queueActionLocked</span><span class=p>(</span><span class=nx>actionType</span> <span class=nx>DeltaType</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>id</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>f</span><span class=p>.</span><span class=nf>KeyOf</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>KeyError</span><span class=p>{</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>err</span><span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>newDeltas</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>f</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>id</span><span class=p>],</span> <span class=nx>Delta</span><span class=p>{</span><span class=nx>actionType</span><span class=p>,</span> <span class=nx>obj</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=nx>newDeltas</span> <span class=p>=</span> <span class=nf>dedupDeltas</span><span class=p>(</span><span class=nx>newDeltas</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div></div></div><p>在函数 <code>dedupDeltas()</code> 中实现的这个</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// re-listing and watching can deliver the same update multiple times in any
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>order</span><span class=p>.</span> <span class=nx>This</span> <span class=nx>will</span> <span class=nx>combine</span> <span class=nx>the</span> <span class=nx>most</span> <span class=nx>recent</span> <span class=nx>two</span> <span class=nx>deltas</span> <span class=k>if</span> <span class=nx>they</span> <span class=nx>are</span> <span class=nx>the</span> <span class=nx>same</span><span class=p>.</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>dedupDeltas</span><span class=p>(</span><span class=nx>deltas</span> <span class=nx>Deltas</span><span class=p>)</span> <span class=nx>Deltas</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>deltas</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>n</span> <span class=p>&lt;</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>deltas</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>a</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>deltas</span><span class=p>[</span><span class=nx>n</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=c1>// 如 [1,2,3,4] a=4
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>b</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>deltas</span><span class=p>[</span><span class=nx>n</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span> <span class=c1>// b=3,这里两个值其实为事件
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>out</span> <span class=o>:=</span> <span class=nf>isDup</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>);</span> <span class=nx>out</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>d</span> <span class=o>:=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>Deltas</span><span class=p>{},</span> <span class=nx>deltas</span><span class=p>[:</span><span class=nx>n</span><span class=o>-</span><span class=mi>2</span><span class=p>]</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nb>append</span><span class=p>(</span><span class=nx>d</span><span class=p>,</span> <span class=o>*</span><span class=nx>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>deltas</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>如果b对象的类型是 <code>DeletedFinalStateUnknown</code> 也会认为是一个旧对象被删除，这里在去重时也只是对删除的操作进行去重。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// tools/cache/delta_fifo.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>isDup</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=o>*</span><span class=nx>Delta</span><span class=p>)</span> <span class=o>*</span><span class=nx>Delta</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>out</span> <span class=o>:=</span> <span class=nf>isDeletionDup</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span><span class=p>);</span> <span class=nx>out</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>out</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// TODO: Detect other duplicate situations? Are there any?
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// keep the one with the most information if both are deletions.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>isDeletionDup</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=nx>b</span> <span class=o>*</span><span class=nx>Delta</span><span class=p>)</span> <span class=o>*</span><span class=nx>Delta</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>b</span><span class=p>.</span><span class=nx>Type</span> <span class=o>!=</span> <span class=nx>Deleted</span> <span class=o>||</span> <span class=nx>a</span><span class=p>.</span><span class=nx>Type</span> <span class=o>!=</span> <span class=nx>Deleted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Do more sophisticated checks, or is this sufficient?
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>b</span><span class=p>.</span><span class=nx>Object</span><span class=p>.(</span><span class=nx>DeletedFinalStateUnknown</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>a</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>b</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><strong>为什么需要去重？什么情况下需合并</strong></p><p>代码中开发者给我们留了一个TODO</p><blockquote><p>TODO: is there anything other than deletions that need deduping?</p></blockquote><ul><li>取决于Detal FIFO 生产-消费延迟<ul><li>当在一个资源的创建时，其状态会频繁的更新，如 Creating，Runinng等，这个时候会出现大量写入FIFO中的数据，但是在消费端可能之前的并未消费完。</li><li>在上面那种情况下，以及Kubernetes 声明式 API 的设计，其实多余的根本不关注，只需要最后一个动作如Running，这种情况下，多个内容可以合并为一个步骤</li></ul></li><li>然而在代码中，去重仅仅是在Delete状态生效，显然这不可用；那么结合这些得到：<ul><li>在一个工作时间窗口内，如果对于删除操作来说发生多次，与发生一次实际上没什么区别，可以去重</li><li>但在更新于新增操作时，实际上在对于声明式 API 的设计个人感觉是完全可以做到去重操作。<ul><li>同一个时间窗口内多次操作，如更新，实际上Kubernetes应该只关注最终状态而不是命令式？</li></ul></li></ul></li></ul><h3 id=compute-key>Compute Key<a hidden class=anchor aria-hidden=true href=#compute-key>#</a></h3><p>上面大概对一些Detal FIFO的逻辑进行了分析，那么对于Detal FIFO如何去计算，也就是说 <code>MetaNamespaceKeyFunc</code> ，这个是默认的KeyFunc，作用是计算Detals中的唯一key。</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>MetaNamespaceKeyFunc</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>ExplicitKey</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>  <span class=c1>// 显示声明的则为这个值
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span> <span class=nb>string</span><span class=p>(</span><span class=nx>key</span><span class=p>),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>meta</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>meta</span><span class=p>.</span><span class=nf>Accessor</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=c1>// 那么使用Accessor,每一个资源都会实现这个Accessor
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;object has no meta: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>meta</span><span class=p>.</span><span class=nf>GetNamespace</span><span class=p>())</span> <span class=p>&gt;</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>meta</span><span class=p>.</span><span class=nf>GetNamespace</span><span class=p>()</span> <span class=o>+</span> <span class=s>&#34;/&#34;</span> <span class=o>+</span> <span class=nx>meta</span><span class=p>.</span><span class=nf>GetName</span><span class=p>(),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>meta</span><span class=p>.</span><span class=nf>GetName</span><span class=p>(),</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p><code>ObjectMetaAccessor</code> 每个Kubernetes资源都会实现这个对象，如Deployment</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// accessor interface
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>ObjectMetaAccessor</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>GetObjectMeta</span><span class=p>()</span> <span class=nx>Object</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 会被ObjectMeta所实现
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>obj</span> <span class=o>*</span><span class=nx>ObjectMeta</span><span class=p>)</span> <span class=nf>GetObjectMeta</span><span class=p>()</span> <span class=nx>Object</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>obj</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 而每一个资源都会继承这个 ObjectMeta，如 ClusterRole
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ClusterRole</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>TypeMeta</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span> <span class=s>`json:&#34;metadata,omitempty&#34;protobuf:&#34;bytes,1,opt,name=metadata&#34;`</span></span></span></code></pre></td></tr></table></div></div></div></div><p>那么这个Deltas的key则为集群类型的是资源本身的名字，namespace范围的则为 <code>meta.GetNamespace() + "/" + meta.GetName()</code>，可以在上面代码中看到，这样就可以给Detal生成了一个唯一的key</p><h3 id=keyof用于计算对象的key>keyof，用于计算对象的key<a hidden class=anchor aria-hidden=true href=#keyof用于计算对象的key>#</a></h3><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>f</span> <span class=o>*</span><span class=nx>DeltaFIFO</span><span class=p>)</span> <span class=nf>KeyOf</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>d</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>Deltas</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>d</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span> <span class=c1>// 长度为0的时候是一个初始的类型
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=nx>KeyError</span><span class=p>{</span><span class=nx>obj</span><span class=p>,</span> <span class=nx>ErrZeroLengthDeltasObject</span><span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>obj</span> <span class=p>=</span> <span class=nx>d</span><span class=p>.</span><span class=nf>Newest</span><span class=p>().</span><span class=nx>Object</span> <span class=c1>// 用最新的一个对象，如果为空则是nil
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>d</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=nx>DeletedFinalStateUnknown</span><span class=p>);</span> <span class=nx>ok</span> <span class=p>{</span>  
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>d</span><span class=p>.</span><span class=nx>Key</span><span class=p>,</span> <span class=kc>nil</span> <span class=c1>// 到了这里，之前提到过，是一个过期的值将会被删除
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>f</span><span class=p>.</span><span class=nf>keyFunc</span><span class=p>(</span><span class=nx>obj</span><span class=p>)</span> <span class=c1>// 调用具体的key计算函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=indexer>Indexer<a hidden class=anchor aria-hidden=true href=#indexer>#</a></h2><p>indexer 在整个 client-go 架构中提供了一个具有线程安全的数据存储的对象存储功能；对于Indexer这里会分析下对应的架构及使用方法。</p><p><a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/index.go target=_blank rel="noopener nofollow noreferrer">client-go/tools/cache/index.go</a> 中可以看到 indexer是一个实现了<code>Store</code> 的一个interface</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Indexer</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 继承了store，拥有store的所有方法
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Store</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回indexname的obj的交集
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>Index</span><span class=p>(</span><span class=nx>indexName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 通过对 indexName，indexedValue与之相匹配的集合
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>IndexKeys</span><span class=p>(</span><span class=nx>indexName</span><span class=p>,</span> <span class=nx>indexedValue</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 给定一个indexName 返回所有的indexed
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>ListIndexFuncValues</span><span class=p>(</span><span class=nx>indexName</span> <span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 通过indexname，返回与indexedvalue相关的 obj
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>ByIndex</span><span class=p>(</span><span class=nx>indexName</span><span class=p>,</span> <span class=nx>indexedValue</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 返回所有的indexer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nf>GetIndexers</span><span class=p>()</span> <span class=nx>Indexers</span>
</span></span><span class=line><span class=cl>	<span class=nf>AddIndexers</span><span class=p>(</span><span class=nx>newIndexers</span> <span class=nx>Indexers</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>实际上对他的实现是一个 cache，cache是一个KeyFunc与ThreadSafeStore实现的indexer，有名称可知具有线程安全的功能</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>cache</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>cacheStorage</span> <span class=nx>ThreadSafeStore</span>
</span></span><span class=line><span class=cl>	<span class=nx>keyFunc</span> <span class=nx>KeyFunc</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>既然index继承了Store那么，也就是 <code>ThreadSafeStore</code> 必然实现了Store，这是一个基础保证</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ThreadSafeStore</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Add</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nf>Update</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>	<span class=nf>Delete</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Get</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>item</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>exists</span> <span class=kt>bool</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>List</span><span class=p>()</span> <span class=p>[]</span><span class=kd>interface</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nf>ListKeys</span><span class=p>()</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nf>Replace</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Index</span><span class=p>(</span><span class=nx>indexName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>IndexKeys</span><span class=p>(</span><span class=nx>indexName</span><span class=p>,</span> <span class=nx>indexKey</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>ListIndexFuncValues</span><span class=p>(</span><span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=p>[]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nf>ByIndex</span><span class=p>(</span><span class=nx>indexName</span><span class=p>,</span> <span class=nx>indexKey</span> <span class=kt>string</span><span class=p>)</span> <span class=p>([]</span><span class=kd>interface</span><span class=p>{},</span> <span class=kt>error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>GetIndexers</span><span class=p>()</span> <span class=nx>Indexers</span>
</span></span><span class=line><span class=cl>	<span class=nf>AddIndexers</span><span class=p>(</span><span class=nx>newIndexers</span> <span class=nx>Indexers</span><span class=p>)</span> <span class=kt>error</span>
</span></span><span class=line><span class=cl>	<span class=nf>Resync</span><span class=p>()</span> <span class=kt>error</span> <span class=c1>// Resync is a no-op and is deprecated
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// KeyFunc是一个生成key的函数，给一个对象，返回一个key值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>KeyFunc</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><p>那么这个indexer structure可以通过图来很直观的看出来</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220522003635661.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220522003635661.png#center alt=image-20220522003635661 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h3 id=cache的结构>cache的结构<a hidden class=anchor aria-hidden=true href=#cache的结构>#</a></h3><p>cache中会出现三种数据结构，也可以成为三种名词，为 <code>Index </code>, <code>Indexers</code> , <code>Indices</code></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Index</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>sets</span><span class=p>.</span><span class=nx>String</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Indexers</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>IndexFunc</span>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Indices</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=nx>Index</span></span></span></code></pre></td></tr></table></div></div></div></div><p>可以看出：</p><ul><li><code>Index</code> 映射到对象，<code>sets.String</code> 也是在API中定义的数据类型 <code>[string]Struct{}</code>，</li><li><code>Indexers</code> 是这个 <code>Index</code> 的 <code>IndexFunc</code> , 是一个如何计算Index的keyname的函数</li><li><code>Indices</code> 通过Index 名词拿到对应的对象</li></ul><p>这个名词的概念如下，通过图来了解会更加清晰</p><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220522172028443.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20220522172028443.png#center alt=image-20220522172028443 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><h3 id=从创建开始>从创建开始<a hidden class=anchor aria-hidden=true href=#从创建开始>#</a></h3><p>创建一个cache有两种方式，一种是指定indexer，一种是默认indexer</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// NewStore returns a Store implemented simply with a map and a lock.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewStore</span><span class=p>(</span><span class=nx>keyFunc</span> <span class=nx>KeyFunc</span><span class=p>)</span> <span class=nx>Store</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>cache</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cacheStorage</span><span class=p>:</span> <span class=nf>NewThreadSafeStore</span><span class=p>(</span><span class=nx>Indexers</span><span class=p>{},</span> <span class=nx>Indices</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>keyFunc</span><span class=p>:</span>      <span class=nx>keyFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// NewIndexer returns an Indexer implemented simply with a map and a lock.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=nf>NewIndexer</span><span class=p>(</span><span class=nx>keyFunc</span> <span class=nx>KeyFunc</span><span class=p>,</span> <span class=nx>indexers</span> <span class=nx>Indexers</span><span class=p>)</span> <span class=nx>Indexer</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>cache</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>cacheStorage</span><span class=p>:</span> <span class=nf>NewThreadSafeStore</span><span class=p>(</span><span class=nx>indexers</span><span class=p>,</span> <span class=nx>Indices</span><span class=p>{}),</span>
</span></span><span class=line><span class=cl>		<span class=nx>keyFunc</span><span class=p>:</span>      <span class=nx>keyFunc</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=更新操作>更新操作<a hidden class=anchor aria-hidden=true href=#更新操作>#</a></h3><p>在indexer中的更新操作（诸如 <code>add</code> , <code>update</code> ），实际上操作的是 <code>updateIndices</code>， 通过在代码可以看出</p><p><a href=https://github.com/kubernetes/client-go/blob/master/tools/cache/thread_safe_store.go target=_blank rel="noopener nofollow noreferrer">tools/cache/thread_safe_store.go</a> 的 77行起，那么就来看下 <code>updateIndices()</code> 具体做了什么</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>threadSafeMap</span><span class=p>)</span> <span class=nf>updateIndices</span><span class=p>(</span><span class=nx>oldObj</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 在操作时，如果有旧对象，需要先删除
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>oldObj</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>deleteFromIndices</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 先对整个indexer遍历，拿到index name与 index function
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>indexFunc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>c</span><span class=p>.</span><span class=nx>indexers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过index function，计算出对象的indexed name
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>indexValues</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>indexFunc</span><span class=p>(</span><span class=nx>newObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to calculate an index entry for key %q on index %q: %v&#34;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 接下来通过遍历的index name 拿到这个index的对象
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>index</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>indices</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>index</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span> <span class=c1>// 确认这个index是否存在，
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nx>index</span> <span class=p>=</span> <span class=nx>Index</span><span class=p>{}</span> <span class=c1>// 如果不存在将一个Index{}初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>c</span><span class=p>.</span><span class=nx>indices</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=p>=</span> <span class=nx>index</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 通过计算出的indexed name来拿到对应的 set of object
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>indexValue</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>indexValues</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>set</span> <span class=o>:=</span> <span class=nx>index</span><span class=p>[</span><span class=nx>indexValue</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>set</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 如果这个set不存在，则初始化这个set
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>set</span> <span class=p>=</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>				<span class=nx>index</span><span class=p>[</span><span class=nx>indexValue</span><span class=p>]</span> <span class=p>=</span> <span class=nx>set</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>set</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=c1>// 然后将key插入set中
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>那么通过上面可以了解到了 <code>updateIndices</code> 的逻辑，那么通过对更新函数分析来看看他具体做了什么？这里是add函数，通过一段代码模拟操作来熟悉结构</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>testIndexer</span> <span class=o>:=</span> <span class=s>&#34;testIndexer&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>testIndex</span> <span class=o>:=</span> <span class=s>&#34;testIndex&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>indexers</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>Indexers</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>testIndexer</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>strings</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>e</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>indexes</span> <span class=o>:=</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>testIndex</span><span class=p>}</span> <span class=c1>// index的名词
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>indexes</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>indices</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>Indices</span><span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=nx>store</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewThreadSafeStore</span><span class=p>(</span><span class=nx>indexers</span><span class=p>,</span> <span class=nx>indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%#v\n&#34;</span><span class=p>,</span> <span class=nx>store</span><span class=p>.</span><span class=nf>GetIndexers</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>store</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=s>&#34;retain&#34;</span><span class=p>,</span> <span class=s>&#34;pod--1&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>store</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=s>&#34;delete&#34;</span><span class=p>,</span> <span class=s>&#34;pod--2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>store</span><span class=p>.</span><span class=nf>Update</span><span class=p>(</span><span class=s>&#34;retain&#34;</span><span class=p>,</span> <span class=s>&#34;pod-3&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>//lists := store.Update(&#34;retain&#34;, &#34;pod-3&#34;)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>lists</span> <span class=o>:=</span> <span class=nx>store</span><span class=p>.</span><span class=nf>List</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>item</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>item</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>这里是对add操作以及对<code>updateIndices()</code> 进行操作</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// threadSafe.go
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>threadSafeMap</span><span class=p>)</span> <span class=nf>Add</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>c</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>oldObject</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=c1>// 这个item就是存储object的地方, 为空
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>c</span><span class=p>.</span><span class=nx>items</span><span class=p>[</span><span class=nx>key</span><span class=p>]</span> <span class=p>=</span> <span class=nx>obj</span> <span class=c1>// 这里已经添加了新的值
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>c</span><span class=p>.</span><span class=nf>updateIndices</span><span class=p>(</span><span class=nx>oldObject</span><span class=p>,</span> <span class=nx>obj</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span> <span class=c1>// 转至updateIndices
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// updateIndices
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>func</span> <span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>threadSafeMap</span><span class=p>)</span> <span class=nf>updateIndices</span><span class=p>(</span><span class=nx>oldObj</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>newObj</span> <span class=kd>interface</span><span class=p>{},</span> <span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 就当是新创建的，这里是空的忽略
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>oldObj</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>c</span><span class=p>.</span><span class=nf>deleteFromIndices</span><span class=p>(</span><span class=nx>oldObj</span><span class=p>,</span> <span class=nx>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这个时候拿到的就是 name=testKey function=testIndexer
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>indexFunc</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>c</span><span class=p>.</span><span class=nx>indexers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 通过testIndexer对testKey计算出的结果是 []string{testIndexer}
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>indexValues</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nf>indexFunc</span><span class=p>(</span><span class=nx>newObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=s>&#34;unable to calculate an index entry for key %q on index %q: %v&#34;</span><span class=p>,</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>err</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>index</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nx>indices</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>index</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span> 
</span></span><span class=line><span class=cl>            <span class=nx>index</span> <span class=p>=</span> <span class=nx>Index</span><span class=p>{}</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// 因为假设为空了，故到这里c.indices[testIndexer]= Index{}
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>c</span><span class=p>.</span><span class=nx>indices</span><span class=p>[</span><span class=nx>name</span><span class=p>]</span> <span class=p>=</span> <span class=nx>index</span> 
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>indexValue</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>indexValues</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// indexValue=testIndexer
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// set := c.index[name] = c.indices[testIndexer]Index{}
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>set</span> <span class=o>:=</span> <span class=nx>index</span><span class=p>[</span><span class=nx>indexValue</span><span class=p>]</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>set</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>set</span> <span class=p>=</span> <span class=nx>sets</span><span class=p>.</span><span class=nx>String</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>				<span class=nx>index</span><span class=p>[</span><span class=nx>indexValue</span><span class=p>]</span> <span class=p>=</span> <span class=nx>set</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>set</span><span class=p>.</span><span class=nf>Insert</span><span class=p>(</span><span class=nx>key</span><span class=p>)</span> <span class=c1>// 到这里就为set=indices[testIndexer]Index{}
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>总结一下，到这里，可以很明显的看出来，indexer中的三个概念是什么了，前面如果没有看明白话</p><ul><li><code>Index</code>：通过indexer计算出key的名称，值为对应obj的一个集合，可以理解为索引的数据结构<ul><li>比如说 <code>Pod:{"nginx-pod1": v1.Pod{Name:Nginx}}</code></li></ul></li><li><code>Indexers</code> ：这个很简单，就是，对于Index中如何计算每个key的名称；可以理解为分词器，索引的过程</li><li><code>Indices</code> 通过Index 名词拿到对应的对象，是Index的集合；是将原始数据Item做了一个索引，可以理解为做索引的具体字段<ul><li>比如说 <code>Indices["Pod"]{"nginx-pod1": v1.Pod{Name:Nginx}, "nginx-pod2": v1.Pod{Name:Nginx}}</code></li></ul></li><li><code>Items</code>：实际上存储的在Indices中的<code>set.String{key:value}</code> ，中的 <code>key=value</code><ul><li>例如：<code>Item:{"nginx-pod1": v1.Pod{Name:Nginx}, "coredns-depoyment": App.Deployment{Name:coredns}}</code></li></ul></li></ul><h3 id=删除操作>删除操作<a hidden class=anchor aria-hidden=true href=#删除操作>#</a></h3><p>对于删除操作，在最新版本中是使用了 <code>updateIndices</code> 就是 add update delete全都是相同的方法操作，对于旧版包含1.19- 是单独的一个操作</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>// v1.2+
</span></span><span class=line><span class=cl>func (c *threadSafeMap) Delete(key string) {
</span></span><span class=line><span class=cl>	c.lock.Lock()
</span></span><span class=line><span class=cl>	defer c.lock.Unlock()
</span></span><span class=line><span class=cl>	if obj, exists := c.items[key]; exists {
</span></span><span class=line><span class=cl>		c.updateIndices(obj, nil, key)
</span></span><span class=line><span class=cl>		delete(c.items, key)
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>// v1.19-
</span></span><span class=line><span class=cl>func (c *threadSafeMap) Delete(key string) {
</span></span><span class=line><span class=cl>	c.lock.Lock()
</span></span><span class=line><span class=cl>	defer c.lock.Unlock()
</span></span><span class=line><span class=cl>	if obj, exists := c.items[key]; exists {
</span></span><span class=line><span class=cl>		c.deleteFromIndices(obj, key)
</span></span><span class=line><span class=cl>		delete(c.items, key)
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div></div></div></div><h3 id=indexer使用>indexer使用<a hidden class=anchor aria-hidden=true href=#indexer使用>#</a></h3><p>上面了解了indexer概念，可以通过写代码来尝试使用一些indexer</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>appsV1</span> <span class=s>&#34;k8s.io/api/apps/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=nx>metav1</span> <span class=s>&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;k8s.io/client-go/tools/cache&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>indexers</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>Indexers</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;getDeplyment&#34;</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>strings</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>e</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>d</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>d</span><span class=p>.</span><span class=nx>Name</span><span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>		<span class=s>&#34;getDaemonset&#34;</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>obj</span> <span class=kd>interface</span><span class=p>{})</span> <span class=p>(</span><span class=nx>strings</span> <span class=p>[]</span><span class=kt>string</span><span class=p>,</span> <span class=nx>e</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>d</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>obj</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>DaemonSet</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=nx>d</span><span class=p>.</span><span class=nx>Name</span><span class=p>},</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 第一个参数是计算set内的key的名称 就是map[string]sets.String的这个strings的名称/namespace/resorcename
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 第二个参数是计算index即外部的key的名称
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>indexer</span> <span class=o>:=</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewIndexer</span><span class=p>(</span><span class=nx>cache</span><span class=p>.</span><span class=nx>MetaNamespaceKeyFunc</span><span class=p>,</span> <span class=nx>indexers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>deployment</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=s>&#34;nginx-deplyment&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Namespace</span><span class=p>:</span> <span class=s>&#34;test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>daemonset</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>DaemonSet</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=s>&#34;firewall-daemonset&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Namespace</span><span class=p>:</span> <span class=s>&#34;test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>daemonset2</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>DaemonSet</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ObjectMeta</span><span class=p>:</span> <span class=nx>metav1</span><span class=p>.</span><span class=nx>ObjectMeta</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>Name</span><span class=p>:</span>      <span class=s>&#34;etcd-daemonset&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Namespace</span><span class=p>:</span> <span class=s>&#34;default&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>},</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>indexer</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>deployment</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>indexer</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>daemonset</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>indexer</span><span class=p>.</span><span class=nf>Add</span><span class=p>(</span><span class=nx>daemonset2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 第一个参数是索引器
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 第二个参数是所引起做索引的字段
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lists</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>indexer</span><span class=p>.</span><span class=nf>ByIndex</span><span class=p>(</span><span class=s>&#34;getDaemonset&#34;</span><span class=p>,</span> <span class=s>&#34;etcd-daemonset&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>item</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>lists</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>switch</span> <span class=nx>item</span><span class=p>.(</span><span class=kd>type</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>item</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>Deployment</span><span class=p>).</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>*</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>DaemonSet</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>item</span><span class=p>.(</span><span class=o>*</span><span class=nx>appsV1</span><span class=p>.</span><span class=nx>DaemonSet</span><span class=p>).</span><span class=nx>Name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><ul><li><a href=https://iximiuz.com/en/posts/kubernetes-api-go-types-and-common-machinery/ target=_blank rel="noopener nofollow noreferrer">go types</a></li><li><a href=https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/ target=_blank rel="noopener nofollow noreferrer">Kubernetes API Reference Docs</a></li></ul></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：Kubernetes组件核心 - client-go</p><p>文章链接：<a href=https://www.oomkill.com/2022/05/ch06-client-go/ target=_blank>https://www.oomkill.com/2022/05/ch06-client-go/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2022/05/ch02-kubernetes-api/><span>深入理解kubernetes API</span></a></li><li><a href=/2021/12/ch05-listwatch-mechanism/><span>理解kubernetes listwatch机制原理</span></a></li><li><a href=/2021/11/ch03-kubernetes-schema/><span>理解kubernetes schema</span></a></li><li><a href=/2021/11/ch01-k8s-perpare/><span>k8s开发环境准备 - 如何配置开发环境</span></a></li><li><a href=/2022/05/ch11-code-compile/><span>如何通过源码编译Kubernetes</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=https://www.oomkill.com/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=https://www.oomkill.com/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=https://www.oomkill.com/2022/05/ch08-informer/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>源码分析client-go架构 - 什么是informer</span>
</a><a class=next href=https://www.oomkill.com/2022/05/h3c-hcl-preparation/><span class=title></span>
<span>H3C Cloud与WSL2共存&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch06 client-go","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=https://www.oomkill.com/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>