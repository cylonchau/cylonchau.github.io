<!doctype html><html lang=zh dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>深入理解kubelet - VolumeManager源码解析 | Cylon's Collection</title><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP3JNCPR" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><meta name=keywords content="kubernetes,develop,kubelet,volume manager,kubelet挂载原理"><meta name=description content='Overview 阅读完本文，您当了解
Kubernetes 卷 CephFS 在 kubernetes 中的挂载 Kubelet VolumeManager 本文只是个人理解，如果有大佬觉得不是这样的可以留言一起讨论，参考源码版本为 1.18.20，与高版本相差不大
VolumeManager VolumeManager VM 是在 kubelet 启动时被初始化的一个异步进程，主要是维护 “Pod" 卷的两个状态，”desiredStateOfWorld“ 和 ”actualStateOfWorld“； 这两个状态用于将节点上的卷 “协调” 到所需的状态。
VM 实际上包含三个 “异步进程” (goroutine)，其中有一个 reconciler 就是用于协调与挂载的，下面就来阐述 VM 的挂载过程。
VM中的重要组件 actualStateOfWorld mountedPod desiredStateOfWorld VolumeToMount podToMount VM的组成 VM 的代码位于，由图可以看出，主要包含三个重要部分：
reconciler：协调器 populator：填充器 cache：包含 ”desiredStateOfWorld“ 和 ”actualStateOfWorld“ 图：VM的目录组成 在代码结构上，volumeManager 如下所示
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // volumeManager implements the VolumeManager interface type volumeManager struct { // DesiredStateOfWorldPopulator 用来与 API 服务器通信以获取 PV 和 PVC 对象的 API 客户端 kubeClient clientset.'><meta name=author content="cylon"><link rel=canonical href=http://localhost:1313/2023/08/ch29-volumemanager/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/favicon.ico><link rel=mask-icon href=http://localhost:1313/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=http://localhost:1313/2023/08/ch29-volumemanager/><noscript><style>#theme-toggle,#top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link crossorigin=anonymous href=/assets/css/pe.min.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/pe.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.staticfile.net/font-awesome/6.5.1/css/v4-shims.min.css><script defer src=https://cdn.staticfile.net/jquery/3.5.1/jquery.min.js></script><link rel=stylesheet href=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.css><script defer src=https://cdn.staticfile.net/fancybox/3.5.7/jquery.fancybox.min.js></script><script id=MathJax-script async src=https://cdn.staticfile.net/mathjax/3.2.2/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["$$","$$"]],inlineMath:[["\\$","\\$"]]}}</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-NP3JNCPR")</script><meta property="og:title" content="深入理解kubelet - VolumeManager源码解析"><meta property="og:description" content='Overview 阅读完本文，您当了解
Kubernetes 卷 CephFS 在 kubernetes 中的挂载 Kubelet VolumeManager 本文只是个人理解，如果有大佬觉得不是这样的可以留言一起讨论，参考源码版本为 1.18.20，与高版本相差不大
VolumeManager VolumeManager VM 是在 kubelet 启动时被初始化的一个异步进程，主要是维护 “Pod" 卷的两个状态，”desiredStateOfWorld“ 和 ”actualStateOfWorld“； 这两个状态用于将节点上的卷 “协调” 到所需的状态。
VM 实际上包含三个 “异步进程” (goroutine)，其中有一个 reconciler 就是用于协调与挂载的，下面就来阐述 VM 的挂载过程。
VM中的重要组件 actualStateOfWorld mountedPod desiredStateOfWorld VolumeToMount podToMount VM的组成 VM 的代码位于，由图可以看出，主要包含三个重要部分：
reconciler：协调器 populator：填充器 cache：包含 ”desiredStateOfWorld“ 和 ”actualStateOfWorld“ 图：VM的目录组成 在代码结构上，volumeManager 如下所示
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // volumeManager implements the VolumeManager interface type volumeManager struct { // DesiredStateOfWorldPopulator 用来与 API 服务器通信以获取 PV 和 PVC 对象的 API 客户端 kubeClient clientset.'><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/2023/08/ch29-volumemanager/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-20T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-24T23:00:36+08:00"><meta property="og:site_name" content="Cylon's Collection"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解kubelet - VolumeManager源码解析"><meta name=twitter:description content='Overview 阅读完本文，您当了解
Kubernetes 卷 CephFS 在 kubernetes 中的挂载 Kubelet VolumeManager 本文只是个人理解，如果有大佬觉得不是这样的可以留言一起讨论，参考源码版本为 1.18.20，与高版本相差不大
VolumeManager VolumeManager VM 是在 kubelet 启动时被初始化的一个异步进程，主要是维护 “Pod" 卷的两个状态，”desiredStateOfWorld“ 和 ”actualStateOfWorld“； 这两个状态用于将节点上的卷 “协调” 到所需的状态。
VM 实际上包含三个 “异步进程” (goroutine)，其中有一个 reconciler 就是用于协调与挂载的，下面就来阐述 VM 的挂载过程。
VM中的重要组件 actualStateOfWorld mountedPod desiredStateOfWorld VolumeToMount podToMount VM的组成 VM 的代码位于，由图可以看出，主要包含三个重要部分：
reconciler：协调器 populator：填充器 cache：包含 ”desiredStateOfWorld“ 和 ”actualStateOfWorld“ 图：VM的目录组成 在代码结构上，volumeManager 如下所示
go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // volumeManager implements the VolumeManager interface type volumeManager struct { // DesiredStateOfWorldPopulator 用来与 API 服务器通信以获取 PV 和 PVC 对象的 API 客户端 kubeClient clientset.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"深入理解kubelet - VolumeManager源码解析","item":"http://localhost:1313/2023/08/ch29-volumemanager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入理解kubelet - VolumeManager源码解析","name":"深入理解kubelet - VolumeManager源码解析","description":"Overview 阅读完本文，您当了解\nKubernetes 卷 CephFS 在 kubernetes 中的挂载 Kubelet VolumeManager 本文只是个人理解，如果有大佬觉得不是这样的可以留言一起讨论，参考源码版本为 1.18.20，与高版本相差不大\nVolumeManager VolumeManager VM 是在 kubelet 启动时被初始化的一个异步进程，主要是维护 “Pod\u0026quot; 卷的两个状态，”desiredStateOfWorld“ 和 ”actualStateOfWorld“； 这两个状态用于将节点上的卷 “协调” 到所需的状态。\nVM 实际上包含三个 “异步进程” (goroutine)，其中有一个 reconciler 就是用于协调与挂载的，下面就来阐述 VM 的挂载过程。\nVM中的重要组件 actualStateOfWorld mountedPod desiredStateOfWorld VolumeToMount podToMount VM的组成 VM 的代码位于，由图可以看出，主要包含三个重要部分：\nreconciler：协调器 populator：填充器 cache：包含 ”desiredStateOfWorld“ 和 ”actualStateOfWorld“ 图：VM的目录组成 在代码结构上，volumeManager 如下所示\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // volumeManager implements the VolumeManager interface type volumeManager struct { // DesiredStateOfWorldPopulator 用来与 API 服务器通信以获取 PV 和 PVC 对象的 API 客户端 kubeClient clientset.","keywords":["kubernetes","develop","kubelet","volume manager","kubelet挂载原理"],"articleBody":"Overview 阅读完本文，您当了解\nKubernetes 卷 CephFS 在 kubernetes 中的挂载 Kubelet VolumeManager 本文只是个人理解，如果有大佬觉得不是这样的可以留言一起讨论，参考源码版本为 1.18.20，与高版本相差不大\nVolumeManager VolumeManager VM 是在 kubelet 启动时被初始化的一个异步进程，主要是维护 “Pod\" 卷的两个状态，”desiredStateOfWorld“ 和 ”actualStateOfWorld“； 这两个状态用于将节点上的卷 “协调” 到所需的状态。\nVM 实际上包含三个 “异步进程” (goroutine)，其中有一个 reconciler 就是用于协调与挂载的，下面就来阐述 VM 的挂载过程。\nVM中的重要组件 actualStateOfWorld mountedPod desiredStateOfWorld VolumeToMount podToMount VM的组成 VM 的代码位于，由图可以看出，主要包含三个重要部分：\nreconciler：协调器 populator：填充器 cache：包含 ”desiredStateOfWorld“ 和 ”actualStateOfWorld“ 图：VM的目录组成 在代码结构上，volumeManager 如下所示\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 // volumeManager implements the VolumeManager interface type volumeManager struct { // DesiredStateOfWorldPopulator 用来与 API 服务器通信以获取 PV 和 PVC 对象的 API 客户端 kubeClient clientset.Interface // VolumePluginMgr 是用于访问 VolumePlugin 插件的 VolumePlugin 管理器。它必须预初始化。 volumePluginMgr *volume.VolumePluginMgr // desiredStateOfWorld 是一个数据结构，包含根据 VM 所需的状态：即应附加哪些卷以及 \"哪些pod” 正在引用这些卷。 // 使用 kubelet pod manager 根据 world populator 的所需状态填充数据结构。 desiredStateOfWorld cache.DesiredStateOfWorld // 与 desiredStateOfWorld 相似，是实际状态：即哪些卷被 attacted 到该 Node 以及 volume 被 mounted 到哪些 pod。 // 成功完成 reconciler attach,detach, mount, 和 unmount 操作后，将填充数据结构。 actualStateOfWorld cache.ActualStateOfWorld // operationExecutor 用于启动异步 attach,detach, mount, 和 unmount 操作。 operationExecutor operationexecutor.OperationExecutor // reconciler reconciler 运行异步周期性循环，通过使用操作执行器触发 attach,detach, mount, 和 unmount操作 // 来协调 desiredStateOfWorld 与 actualStateOfWorld。 reconciler reconciler.Reconciler // desiredStateOfWorldPopulator 运行异步周期性循环以使用 kubelet Pod Manager 填充desiredStateOfWorld。 desiredStateOfWorldPopulator populator.DesiredStateOfWorldPopulator // csiMigratedPluginManager keeps track of CSI migration status of plugins csiMigratedPluginManager csimigration.PluginManager // intreeToCSITranslator translates in-tree volume specs to CSI intreeToCSITranslator csimigration.InTreeToCSITranslator } VM的初始化 入口：“volumeManager”(vm) 的 初始化 操作发生在 kubelet Run 时被作为一个异步进程启动。 VM 初始化： 如代码1所示，VM在初始化阶段创建了两个 cache 对象 “desiredStateOfWorld”（dsw）和“actualStateOfWorld”（asw）以及一个 “operationExecutor”，用于启动异步的线程操作 attach,detach, mount, 和 unmount 如代码2所示：VM在初始化阶段还创建了 “desiredStateOfWorldPopulator” (dswp) 与 “reconciler” “reconciler” 通过使用上面的 “operationExecutor” 触发 attach,detach, mount 和 unmount来协调 dsw 与 asw 代码1\ngo 1 2 3 4 5 6 7 8 9 10 11 12 vm := \u0026volumeManager{ kubeClient: kubeClient, volumePluginMgr: volumePluginMgr, desiredStateOfWorld: cache.NewDesiredStateOfWorld(volumePluginMgr), actualStateOfWorld: cache.NewActualStateOfWorld(nodeName, volumePluginMgr), operationExecutor: operationexecutor.NewOperationExecutor(operationexecutor.NewOperationGenerator( kubeClient, volumePluginMgr, recorder, checkNodeCapabilitiesBeforeMount, blockVolumePathHandler)), } 代码2：\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 vm.intreeToCSITranslator = intreeToCSITranslator vm.csiMigratedPluginManager = csiMigratedPluginManager vm.desiredStateOfWorldPopulator = populator.NewDesiredStateOfWorldPopulator( kubeClient, desiredStateOfWorldPopulatorLoopSleepPeriod, desiredStateOfWorldPopulatorGetPodStatusRetryDuration, podManager, podStatusProvider, vm.desiredStateOfWorld, vm.actualStateOfWorld, kubeContainerRuntime, keepTerminatedPodVolumes, csiMigratedPluginManager, intreeToCSITranslator) vm.reconciler = reconciler.NewReconciler( kubeClient, controllerAttachDetachEnabled, reconcilerLoopSleepPeriod, waitForAttachTimeout, nodeName, vm.desiredStateOfWorld, vm.actualStateOfWorld, vm.desiredStateOfWorldPopulator.HasAddedPods, vm.operationExecutor, mounter, hostutil, volumePluginMgr, kubeletPodsDir) VM 的 Run VM 是在 Kubelet 启动时作为异步线程启动，如代码1所示\n如下面代码2所示，VM 在运行时会启动 三个 异步线程\n第一个调用是 第二个是调用 “dswp” 填充其的“ Run ”，这里主要做的操作是从 API 拿到 Pod 列表，根据对应条件来决定 attach,detach, mount, 和 unmount 第二个调用的是，reconciler 来协调应该安装的卷是否已安装以及应该卸载的卷是否已卸载。 第三个调用的是，volumePluginMgr，启用 CSI informer 代码1\ntext 1 2 // Start volume manager go kl.volumeManager.Run(kl.sourcesReady, wait.NeverStop) 代码2\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func (vm *volumeManager) Run(sourcesReady config.SourcesReady, stopCh \u003c-chan struct{}) { defer runtime.HandleCrash() go vm.desiredStateOfWorldPopulator.Run(sourcesReady, stopCh) klog.V(2).Infof(\"The desired_state_of_world populator starts\") klog.Infof(\"Starting Kubelet Volume Manager\") go vm.reconciler.Run(stopCh) metrics.Register(vm.actualStateOfWorld, vm.desiredStateOfWorld, vm.volumePluginMgr) if vm.kubeClient != nil { // start informer for CSIDriver vm.volumePluginMgr.Run(stopCh) } \u003c-stopCh klog.Infof(\"Shutting down Kubelet Volume Manager\") } VM 的调用流程 desiredStateOfWorldPopulator DesiredStateOfWorldPopulator 是一个周期 Loop，会定期循环遍历 Active Pod 列表，并确保每个 Pod 都处于所需状态（如果有卷，World state）。它还会验证 World cache 中处于所需状态的 pod 是否仍然存在，如果不存在，则会将其删除。\ndesiredStateOfWorldPopulator 结构包含两个方法，ReprocessPod 和 HasAddedPods；ReprocessPod 负责将 processedPods 中指定 pod 的值设置为false，强制重新处理它。这是在 Pod 更新时启用重新挂载卷所必需的。而 HasAddedPods 返回 填充器 是否已循环遍历 Active Pod 列表并将它们添加到 world cache 的所需状态。\n在期待填充器 desiredStateOfWorldPopulator 启动时，会运行一个 populatorLoop，这里主要负责运行两个函数，\nfindAndAddNewPods 负责迭代所有 pod，如果它们不存在添加到 desired state of world (desiredStateOfWorld) findAndRemoveDeletedPods 负责迭代 desiredStateOfWorld 下的所有 Pod，如果它们不再存在则将其删除 reconciler reconciler Run 的过程是通过一个 Loop 函数 reconciliationLoopFunc 完成的，正如下列 代码 所示\ngo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 func (rc *reconciler) Run(stopCh \u003c-chan struct{}) { wait.Until(rc.reconciliationLoopFunc(), rc.loopSleepDuration, stopCh) } func (rc *reconciler) reconciliationLoopFunc() func() { return func() { rc.reconcile() // Sync the state with the reality once after all existing pods are added to the desired state from all sources. // Otherwise, the reconstruct process may clean up pods' volumes that are still in use because // desired state of world does not contain a complete list of pods. if rc.populatorHasAddedPods() \u0026\u0026 !rc.StatesHasBeenSynced() { klog.Infof(\"Reconciler: start to sync state\") rc.sync() } } } func (rc *reconciler) reconcile() { // Unmounts are triggered before mounts so that a volume that was // referenced by a pod that was deleted and is now referenced by another // pod is unmounted from the first pod before being mounted to the new // pod. // 卸载会在挂载之前触发，以便已删除的 Pod 引用的卷现在被另一个 Pod 引用， // 然后再挂载到新 Pod 之前从第一个 Pod 中卸载。 rc.unmountVolumes() // Next we mount required volumes. This function could also trigger // attach if kubelet is responsible for attaching volumes. // If underlying PVC was resized while in-use then this function also handles volume // resizing. // 接下来我们安装所需的卷。如果 kubelet 负责附加卷， // 则此函数还可以触发附加。如果底层 PVC 在使用时调整了大小，则此函数还可以处理卷大小调整。 rc.mountAttachVolumes() // Ensure devices that should be detached/unmounted are detached/unmounted. // 确保应 detached/unmounted 的设备已完成 detached/unmounted。 rc.unmountDetachDevices() } Reconciler 是挂载部分最重要的角色，用于协调应该安装的卷是否已安装以及应该卸载的卷是否已卸载；对应的，实际上执行的为三个函数：“unmountVolumes”、“mountAttachVolumes” 和 “unmountDetachDevices”。\nmountAttachVolumes 首先，“mountAttachVolumes” 会调用 “dsw” (desiredStateOfWorld) 的函数 “GetVolumesToMount” 来检索所有 “volumesToMount” 并迭代它们，这里主要是为了确保 “volumes” 应完成了 “attached/mounted”\n接下来这个循环做的工作是，对于每个 Volume 和 Pod，都会检查该 Volume 或 Pod 是否存在于 “asw” 的 “attachedVolumes” 中。如果 Volume 不存在，则“asw”返回 “newVolumeNotAttachedError ”，否则它检查指定的 pod 是否存在并根据状态返回结果。这里存在 三个状态，返回也是根据这个状态返回。这里主要为了得到挂载路径和是否挂载\nVolumeMounted：表示 Volume 已挂载到 pod 的本地路径中\nVolumeMountUncertain：表示 Volume 可能会也可能不会安装在 Pod 的本地路径中\nVolumeNotMounted：表示 Volume 还未挂载到 pod 的本地路径中\n当“ asw” 返回 “ newVolumeNotAttachedError ” 时，“reconciler” 会检查 “controllerAttachDetachEnabled” 是否启用，或 “volumeToMount” 没有实现了对应插件，这里面如果其中任何一个为 true，“reconciler” 将调用 “operationExecutor” 来执行操作“ ，走到这里代表了 Volume 没有被 attach，或者没有实现 attacher，例如 cephfs 没有实现 attacher；或者是 kubelet 禁用了 attach [1] （默认是开启状态），将进入 “ VerifyControllerAttachedVolume ”\n在此期间，“operationExecutor” 生成一个名为 “verifyControllerAttachedVolumeFunc” 的函数来实际实现。在此函数中，如果 “volumeToMount” 的 “PluginIsAttachable” 为 false（没有实现），则假设其已经实现并标记 attached，标记出错时进行重试（这是一个函数用于后面的调用，这里只是定义）\n如果还没有将 Node attached 到 Volume 节点列表状态中，则返回错误进行重试（这是一个函数用于后面的调用，这里只是定义）\n上面两个步骤是为了组装这个操作，返回的是操作的内容，包含执行的函数，完成的hook等，最后运行这个函数并返回\n这是步骤3的另外一个分支，即 kubelet 启用了 ADController，并且实现了对应的 attcher，那么将执行附加操作\n拼接对象 执行函数 ”AttachVolume“ AttachVolume 如上面步骤一样，拼接出最后的执行的动作，进行执行操作（将 node 附加到 volume 之上） 步骤5 表示 3, 4 条件均不满足，也就是 Attached，目前状态为 ”未挂载“ 或者 ”已挂载“，将执行这个步骤，未挂载的进行挂载，已挂载的进行 remount\n在该分支中（也就是 步骤5 执行的）执行的是名为 “GenerateMountVolumeFunc“ 的函数，在此函数中，会获取 Plugin ，并通过 Plugin 创建出一个 volumeMounter，在通过 Plugin 获取一个 deviceMouter（能够挂载块设备的）；当然我们这里挂载的是 ”cephfs“ 所以没有 ”deviceMouter“ 这里不被执行。\n如果 ”deviceMounter“ 定义了，那么则执行这个 plugin 的 “MountDevice” 函数 如果没有定义，那么执行 volumeMounter 的 SetUp 进行挂载（因为不是块设备） 执行 SetUp 函数，通常 NFS, CephFS, HostPath，都实现了这个函数，那么就会通过这个函数挂载到 Node 对应的目录\n最后通过 Overlay2 文件系统附加到容器里\nReference [1] command-line-tools-reference kubelet\n[2] What happens when volumeManager in the kubelet starts?\n","wordCount":"945","inLanguage":"zh","datePublished":"2023-08-20T00:00:00Z","dateModified":"2023-08-24T23:00:36+08:00","author":{"@type":"Person","name":"cylon"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/2023/08/ch29-volumemanager/"},"publisher":{"@type":"Organization","name":"Cylon's Collection","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/><img src=http://localhost:1313/favicon.ico alt aria-label=logo height=20>Cylon's Collection</a><div class=logo-switches><button id=theme-toggle><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/archives><span>归档</span></a></li><li><a href=http://localhost:1313/tags><span>标签</span></a></li><li><a href=http://localhost:1313/search><span>搜索</span></a></li><li><a href=http://localhost:1313/about accesskey=/><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">深入理解kubelet - VolumeManager源码解析</h1><div class=post-meta><span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select:text"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select:text"/><line x1="16" y1="2" x2="16" y2="6" style="user-select:text"/><line x1="8" y1="2" x2="8" y2="6" style="user-select:text"/><line x1="3" y1="10" x2="21" y2="10" style="user-select:text"/></svg><span>2023-08-20</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text" style="user-select:text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z" style="user-select:text"/><polyline points="14 2 14 8 20 8" style="user-select:text"/><line x1="16" y1="13" x2="8" y2="13" style="user-select:text"/><line x1="16" y1="17" x2="8" y2="17" style="user-select:text"/><polyline points="10 9 9 9 8 9" style="user-select:text"/></svg><span>945 字</span></span>&nbsp;·&nbsp;<span class=pe-post-meta-item><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentcolor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><span>5 分钟</span></span>
<span class=pe-post-meta-item>&nbsp;·&nbsp;<svg t="1714036239378" fill="currentcolor" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="6659" width="256" height="256"><path d="M690 78.2c-18.6-18.8-49-19-67.8-.4s-19 49-.4 67.8l255.4 258.6c67.8 68.6 67.8 178.8.0 247.4L653.4 878.2c-18.6 18.8-18.4 49.2.4 67.8s49.2 18.4 67.8-.4l224-226.4c104.8-106 104.8-276.4.0-382.4L690 78.2zM485.4 101.4c-24-24-56.6-37.4-90.6-37.4H96C43 64 0 107 0 160v299c0 34 13.4 66.6 37.4 90.6l336 336c50 50 131 50 181 0l267-267c50-50 50-131 0-181l-336-336zM96 160h299c8.4.0 16.6 3.4 22.6 9.4l336 336c12.4 12.4 12.4 32.8.0 45.2l-267 267c-12.4 12.4-32.8 12.4-45.2.0l-336-336c-6-6-9.4-14.2-9.4-22.6V160zm192 128a64 64 0 10-128 0 64 64 0 10128 0z" p-id="6660"/></svg></span><ul class=pe-post-meta-item><a href=http://localhost:1313/tags/kubernetes-develop/>#Kubernetes Develop</a>
<a href=http://localhost:1313/tags/kubernetes/>#Kubernetes</a></ul></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details><summary><span class=details>目录</span></summary><div class=inner><ul><li><a href=#overview aria-label=Overview>Overview</a><li><a href=#volumemanager aria-label=VolumeManager>VolumeManager</a><ul><li><a href=#vm%e4%b8%ad%e7%9a%84%e9%87%8d%e8%a6%81%e7%bb%84%e4%bb%b6 aria-label=VM中的重要组件>VM中的重要组件</a><li><a href=#vm%e7%9a%84%e7%bb%84%e6%88%90 aria-label=VM的组成>VM的组成</a><li><a href=#vm%e7%9a%84%e5%88%9d%e5%a7%8b%e5%8c%96 aria-label=VM的初始化>VM的初始化</a><li><a href=#vm-%e7%9a%84-run aria-label="VM 的 Run">VM 的 Run</a><li><a href=#vm-%e7%9a%84%e8%b0%83%e7%94%a8%e6%b5%81%e7%a8%8b aria-label="VM 的调用流程">VM 的调用流程</a><ul><li><a href=#desiredstateofworldpopulator aria-label=desiredStateOfWorldPopulator>desiredStateOfWorldPopulator</a><li><a href=#reconciler aria-label=reconciler>reconciler</a><ul><li><a href=#mountattachvolumes aria-label=mountAttachVolumes>mountAttachVolumes</a></ul></ul></ul><li><a href=#reference aria-label=Reference>Reference</a></li></div></details></div></aside><script src=/js/pe-toc.min.445eb1bfc5e85dd13b9519fcc2a806522e9629b6224a2974052789ba00ab78af.js integrity="sha256-RF6xv8XoXdE7lRn8wqgGUi6WKbYiSil0BSeJugCreK8="></script><div class=post-content><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>阅读完本文，您当了解</p><ul><li>Kubernetes 卷</li><li>CephFS 在 kubernetes 中的挂载</li><li>Kubelet VolumeManager</li></ul><blockquote><p>本文只是个人理解，如果有大佬觉得不是这样的可以留言一起讨论，参考源码版本为 1.18.20，与高版本相差不大</p></blockquote><h2 id=volumemanager>VolumeManager<a hidden class=anchor aria-hidden=true href=#volumemanager>#</a></h2><p>VolumeManager VM 是在 kubelet 启动时被初始化的一个异步进程，主要是维护 “Pod" 卷的两个状态，”desiredStateOfWorld“ 和 ”actualStateOfWorld“； 这两个状态用于将节点上的卷 “协调” 到所需的状态。</p><p>VM 实际上包含三个 “异步进程” (goroutine)，其中有一个 reconciler 就是用于协调与挂载的，下面就来阐述 VM 的挂载过程。</p><h3 id=vm中的重要组件>VM中的重要组件<a hidden class=anchor aria-hidden=true href=#vm中的重要组件>#</a></h3><ul><li>actualStateOfWorld</li><li>mountedPod</li><li>desiredStateOfWorld</li><li>VolumeToMount</li><li>podToMount</li></ul><h3 id=vm的组成>VM的组成<a hidden class=anchor aria-hidden=true href=#vm的组成>#</a></h3><p>VM 的代码位于，由图可以看出，主要包含三个重要部分：</p><ul><li>reconciler：协调器</li><li>populator：填充器</li><li>cache：包含 ”desiredStateOfWorld“ 和 ”actualStateOfWorld“</li></ul><p><div class=pe-fancybox><a data-fancybox=gallery href=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230820221712742.png><img src=https://cdn.jsdelivr.net/gh/cylonchau/blogs@img/img/image-20230820221712742.png#center alt=image-20230820221712742 onerror='this.onerror=null,this.src="/placeholder.svg",this.className="pe-image-placeholder"'></a></div></p><center>图：VM的目录组成</center><p>在代码结构上，<a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/kubelet/volumemanager/volume_manager.go#L216-L257 target=_blank rel="noopener nofollow noreferrer">volumeManager</a> 如下所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// volumeManager implements the VolumeManager interface
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>volumeManager</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// DesiredStateOfWorldPopulator 用来与 API 服务器通信以获取 PV 和 PVC 对象的 API 客户端
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>kubeClient</span> <span class=nx>clientset</span><span class=p>.</span><span class=nx>Interface</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// VolumePluginMgr 是用于访问 VolumePlugin 插件的 VolumePlugin 管理器。它必须预初始化。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>volumePluginMgr</span> <span class=o>*</span><span class=nx>volume</span><span class=p>.</span><span class=nx>VolumePluginMgr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// desiredStateOfWorld 是一个数据结构，包含根据 VM 所需的状态：即应附加哪些卷以及 &#34;哪些pod” 正在引用这些卷。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 使用 kubelet pod manager 根据 world populator 的所需状态填充数据结构。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>desiredStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>DesiredStateOfWorld</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 与 desiredStateOfWorld 相似，是实际状态：即哪些卷被 attacted 到该 Node 以及 volume 被 mounted 到哪些 pod。
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 成功完成 reconciler attach,detach, mount, 和 unmount 操作后，将填充数据结构。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>actualStateOfWorld</span> <span class=nx>cache</span><span class=p>.</span><span class=nx>ActualStateOfWorld</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// operationExecutor 用于启动异步 attach,detach, mount, 和 unmount 操作。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>operationExecutor</span> <span class=nx>operationexecutor</span><span class=p>.</span><span class=nx>OperationExecutor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// reconciler reconciler 运行异步周期性循环，通过使用操作执行器触发 attach,detach, mount, 和 unmount操作
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 来协调 desiredStateOfWorld 与 actualStateOfWorld。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>reconciler</span> <span class=nx>reconciler</span><span class=p>.</span><span class=nx>Reconciler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// desiredStateOfWorldPopulator 运行异步周期性循环以使用 kubelet Pod Manager 填充desiredStateOfWorld。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>desiredStateOfWorldPopulator</span> <span class=nx>populator</span><span class=p>.</span><span class=nx>DesiredStateOfWorldPopulator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// csiMigratedPluginManager keeps track of CSI migration status of plugins
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>csiMigratedPluginManager</span> <span class=nx>csimigration</span><span class=p>.</span><span class=nx>PluginManager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// intreeToCSITranslator translates in-tree volume specs to CSI
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>intreeToCSITranslator</span> <span class=nx>csimigration</span><span class=p>.</span><span class=nx>InTreeToCSITranslator</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=vm的初始化>VM的初始化<a hidden class=anchor aria-hidden=true href=#vm的初始化>#</a></h3><ul><li>入口：“volumeManager”(vm) 的 <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/kubelet/kubelet.go#L1436 target=_blank rel="noopener nofollow noreferrer">初始化</a> 操作发生在 kubelet Run 时被作为一个异步进程启动。</li><li>VM 初始化：<ul><li>如代码1所示，VM在初始化阶段创建了两个 cache 对象 “desiredStateOfWorld”（dsw）和“actualStateOfWorld”（asw）以及一个 “operationExecutor”，用于启动异步的线程操作 attach,detach, mount, 和 unmount</li><li>如代码2所示：VM在初始化阶段还创建了 “desiredStateOfWorldPopulator” (dswp) 与 “reconciler”<ul><li>“reconciler” 通过使用上面的 “operationExecutor” 触发 attach,detach, mount 和 unmount来协调 dsw 与 asw</li></ul></li></ul></li></ul><p>代码1</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>vm</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>volumeManager</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeClient</span><span class=p>:</span>          <span class=nx>kubeClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumePluginMgr</span><span class=p>:</span>     <span class=nx>volumePluginMgr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>desiredStateOfWorld</span><span class=p>:</span> <span class=nx>cache</span><span class=p>.</span><span class=nf>NewDesiredStateOfWorld</span><span class=p>(</span><span class=nx>volumePluginMgr</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>actualStateOfWorld</span><span class=p>:</span>  <span class=nx>cache</span><span class=p>.</span><span class=nf>NewActualStateOfWorld</span><span class=p>(</span><span class=nx>nodeName</span><span class=p>,</span> <span class=nx>volumePluginMgr</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>operationExecutor</span><span class=p>:</span> <span class=nx>operationexecutor</span><span class=p>.</span><span class=nf>NewOperationExecutor</span><span class=p>(</span><span class=nx>operationexecutor</span><span class=p>.</span><span class=nf>NewOperationGenerator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>kubeClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>volumePluginMgr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>recorder</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>checkNodeCapabilitiesBeforeMount</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>blockVolumePathHandler</span><span class=p>)),</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>代码2：</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>vm</span><span class=p>.</span><span class=nx>intreeToCSITranslator</span> <span class=p>=</span> <span class=nx>intreeToCSITranslator</span>
</span></span><span class=line><span class=cl><span class=nx>vm</span><span class=p>.</span><span class=nx>csiMigratedPluginManager</span> <span class=p>=</span> <span class=nx>csiMigratedPluginManager</span>
</span></span><span class=line><span class=cl><span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span> <span class=p>=</span> <span class=nx>populator</span><span class=p>.</span><span class=nf>NewDesiredStateOfWorldPopulator</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>desiredStateOfWorldPopulatorLoopSleepPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>desiredStateOfWorldPopulatorGetPodStatusRetryDuration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>podManager</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>podStatusProvider</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeContainerRuntime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>keepTerminatedPodVolumes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>csiMigratedPluginManager</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>intreeToCSITranslator</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>vm</span><span class=p>.</span><span class=nx>reconciler</span> <span class=p>=</span> <span class=nx>reconciler</span><span class=p>.</span><span class=nf>NewReconciler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeClient</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>controllerAttachDetachEnabled</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>reconcilerLoopSleepPeriod</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>waitForAttachTimeout</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>nodeName</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>.</span><span class=nx>HasAddedPods</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>vm</span><span class=p>.</span><span class=nx>operationExecutor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>mounter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>hostutil</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>volumePluginMgr</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>kubeletPodsDir</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=vm-的-run>VM 的 Run<a hidden class=anchor aria-hidden=true href=#vm-的-run>#</a></h3><p>VM 是在 Kubelet 启动时作为异步线程启动，如代码1所示</p><p>如下面代码2所示，VM 在运行时会启动 <strong>三个</strong> 异步线程</p><ul><li>第一个调用是 第二个是调用 “dswp” 填充其的“ <a href=https://github.com/kubernetes/kubernetes/blob/v1.21.2/pkg/kubelet/volumemanager/volume_manager.go#L268 target=_blank rel="noopener nofollow noreferrer">Run</a> ”，这里主要做的操作是从 API 拿到 Pod 列表，根据对应条件来决定 attach,detach, mount, 和 unmount</li><li>第二个调用的是，reconciler 来协调应该安装的卷是否已安装以及应该卸载的卷是否已卸载。</li><li>第三个调用的是，volumePluginMgr，启用 CSI informer</li></ul><p><a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/kubelet/kubelet.go#L1435-L1436 target=_blank rel="noopener nofollow noreferrer">代码1</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>text</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>// Start volume manager
</span></span><span class=line><span class=cl>go kl.volumeManager.Run(kl.sourcesReady, wait.NeverStop)</span></span></code></pre></td></tr></table></div></div></div></div><p><a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/kubelet/volumemanager/volume_manager.go#L259-L277 target=_blank rel="noopener nofollow noreferrer">代码2</a></p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>vm</span> <span class=o>*</span><span class=nx>volumeManager</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>sourcesReady</span> <span class=nx>config</span><span class=p>.</span><span class=nx>SourcesReady</span><span class=p>,</span> <span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>runtime</span><span class=p>.</span><span class=nf>HandleCrash</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorldPopulator</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>sourcesReady</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>V</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;The desired_state_of_world populator starts&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Starting Kubelet Volume Manager&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>reconciler</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>metrics</span><span class=p>.</span><span class=nf>Register</span><span class=p>(</span><span class=nx>vm</span><span class=p>.</span><span class=nx>actualStateOfWorld</span><span class=p>,</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>desiredStateOfWorld</span><span class=p>,</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>vm</span><span class=p>.</span><span class=nx>kubeClient</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// start informer for CSIDriver
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>vm</span><span class=p>.</span><span class=nx>volumePluginMgr</span><span class=p>.</span><span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>stopCh</span>
</span></span><span class=line><span class=cl>	<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Shutting down Kubelet Volume Manager&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><h3 id=vm-的调用流程>VM 的调用流程<a hidden class=anchor aria-hidden=true href=#vm-的调用流程>#</a></h3><h4 id=desiredstateofworldpopulator>desiredStateOfWorldPopulator<a hidden class=anchor aria-hidden=true href=#desiredstateofworldpopulator>#</a></h4><p><code>DesiredStateOfWorldPopulator</code> 是一个周期 Loop，会定期循环遍历 Active Pod 列表，并确保每个 Pod 都处于所需状态（如果有卷，World state）。它还会验证 World cache 中处于所需状态的 pod 是否仍然存在，如果不存在，则会将其删除。</p><p>desiredStateOfWorldPopulator 结构包含两个方法，ReprocessPod 和 HasAddedPods；<strong><code>ReprocessPod</code></strong> 负责将 processedPods 中指定 pod 的值设置为false，强制重新处理它。这是在 Pod 更新时启用重新挂载卷所必需的。而 <strong><code>HasAddedPods</code></strong> 返回 填充器 是否已循环遍历 Active Pod 列表并将它们添加到 world cache 的所需状态。</p><p>在期待填充器 desiredStateOfWorldPopulator 启动时，会运行一个 populatorLoop，这里主要负责运行两个函数，</p><ul><li><code>findAndAddNewPods</code> 负责迭代所有 pod，如果它们不存在添加到 desired state of world (desiredStateOfWorld)</li><li><code>findAndRemoveDeletedPods</code> 负责迭代 <em><code>desiredStateOfWorld</code></em> 下的所有 Pod，如果它们不再存在则将其删除</li></ul><h4 id=reconciler>reconciler<a hidden class=anchor aria-hidden=true href=#reconciler>#</a></h4><p>reconciler Run 的过程是通过一个 Loop 函数 <code>reconciliationLoopFunc</code> 完成的，正如下列 <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/kubelet/volumemanager/reconciler/reconciler.go#L128-L179 target=_blank rel="noopener nofollow noreferrer">代码</a> 所示</p><div class="pe-code-block-wrap pe-code-details open scrollable"><div class="pe-code-block-header pe-code-details-summary"><div class=pe-code-block-header-left><i class="arrow fas fa-chevron-right fa-fw pe-code-details-icon" aria-hidden=true></i>
<span>go</span></div><div class=pe-code-block-header-center><span></span></div><div class=pe-code-block-header-right><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i>
<button class=pe-code-copy-button><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" class="pe-icon"><path fill="currentcolor" fill-rule="evenodd" d="M7 5a3 3 0 013-3h9a3 3 0 013 3v9a3 3 0 01-3 3h-2v2a3 3 0 01-3 3H5a3 3 0 01-3-3v-9a3 3 0 013-3h2zm2 2h5a3 3 0 013 3v5h2a1 1 0 001-1V5a1 1 0 00-1-1h-9A1 1 0 009 5zM5 9a1 1 0 00-1 1v9a1 1 0 001 1h9a1 1 0 001-1v-9a1 1 0 00-1-1z" clip-rule="evenodd"/></svg></button></div></div><div class="pe-code-details-content scrollable"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>Run</span><span class=p>(</span><span class=nx>stopCh</span> <span class=o>&lt;-</span><span class=kd>chan</span> <span class=kd>struct</span><span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>wait</span><span class=p>.</span><span class=nf>Until</span><span class=p>(</span><span class=nx>rc</span><span class=p>.</span><span class=nf>reconciliationLoopFunc</span><span class=p>(),</span> <span class=nx>rc</span><span class=p>.</span><span class=nx>loopSleepDuration</span><span class=p>,</span> <span class=nx>stopCh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>reconciliationLoopFunc</span><span class=p>()</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rc</span><span class=p>.</span><span class=nf>reconcile</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// Sync the state with the reality once after all existing pods are added to the desired state from all sources.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// Otherwise, the reconstruct process may clean up pods&#39; volumes that are still in use because
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// desired state of world does not contain a complete list of pods.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>rc</span><span class=p>.</span><span class=nf>populatorHasAddedPods</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=p>!</span><span class=nx>rc</span><span class=p>.</span><span class=nf>StatesHasBeenSynced</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>klog</span><span class=p>.</span><span class=nf>Infof</span><span class=p>(</span><span class=s>&#34;Reconciler: start to sync state&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>rc</span><span class=p>.</span><span class=nf>sync</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rc</span> <span class=o>*</span><span class=nx>reconciler</span><span class=p>)</span> <span class=nf>reconcile</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// Unmounts are triggered before mounts so that a volume that was
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// referenced by a pod that was deleted and is now referenced by another
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// pod is unmounted from the first pod before being mounted to the new
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// pod.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// 卸载会在挂载之前触发，以便已删除的 Pod 引用的卷现在被另一个 Pod 引用，
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// 然后再挂载到新 Pod 之前从第一个 Pod 中卸载。
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>rc</span><span class=p>.</span><span class=nf>unmountVolumes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Next we mount required volumes. This function could also trigger
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// attach if kubelet is responsible for attaching volumes.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// If underlying PVC was resized while in-use then this function also handles volume
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// resizing.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// 接下来我们安装所需的卷。如果 kubelet 负责附加卷，
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// 则此函数还可以触发附加。如果底层 PVC 在使用时调整了大小，则此函数还可以处理卷大小调整。
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>rc</span><span class=p>.</span><span class=nf>mountAttachVolumes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=c1>// Ensure devices that should be detached/unmounted are detached/unmounted.
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=c1>// 确保应 detached/unmounted 的设备已完成 detached/unmounted。
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nx>rc</span><span class=p>.</span><span class=nf>unmountDetachDevices</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></div></div><p>Reconciler <strong>是挂载部分最重要的角色</strong>，用于协调应该安装的卷是否已安装以及应该卸载的卷是否已卸载；对应的，实际上执行的为三个函数：“unmountVolumes”、“mountAttachVolumes” 和 “unmountDetachDevices”。</p><h5 id=mountattachvolumes>mountAttachVolumes<a hidden class=anchor aria-hidden=true href=#mountattachvolumes>#</a></h5><ol><li><p>首先，“<a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/kubelet/volumemanager/reconciler/reconciler.go#L202-L292 target=_blank rel="noopener nofollow noreferrer">mountAttachVolumes</a>” 会调用 “dsw” (desiredStateOfWorld) 的函数 “GetVolumesToMount” 来检索所有 “volumesToMount” 并迭代它们，这里主要是为了确保 “volumes” 应完成了 “attached/mounted”</p></li><li><p>接下来这个循环做的工作是，对于每个 Volume 和 Pod，都会检查该 Volume 或 Pod 是否存在于 “asw” 的 “attachedVolumes” 中。如果 Volume 不存在，则“asw”返回 “<a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/kubelet/volumemanager/cache/actual_state_of_world.go#L662 target=_blank rel="noopener nofollow noreferrer">newVolumeNotAttachedError</a> ”，否则它检查指定的 pod 是否存在并根据状态返回结果。这里存在 <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/util/operationexecutor/operation_executor.go#L400-L409 target=_blank rel="noopener nofollow noreferrer">三个状态</a>，返回也是根据这个状态返回。<strong>这里主要为了得到挂载路径和是否挂载</strong></p><ul><li><p>VolumeMounted：表示 Volume 已挂载到 pod 的本地路径中</p></li><li><p>VolumeMountUncertain：表示 Volume 可能会也可能不会安装在 Pod 的本地路径中</p></li><li><p>VolumeNotMounted：表示 Volume 还未挂载到 pod 的本地路径中</p></li></ul></li><li><p>当“ asw” 返回 “ <a href=https://github.com/kubernetes/kubernetes/blob/v1.21.2/pkg/kubelet/volumemanager/reconciler/reconciler.go#L207 target=_blank rel="noopener nofollow noreferrer">newVolumeNotAttachedError</a> ” 时，“reconciler” 会检查 “controllerAttachDetachEnabled” 是否启用，或 “<a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/util/operationexecutor/operation_executor.go#L336 target=_blank rel="noopener nofollow noreferrer">volumeToMount</a>” 没有实现了对应插件，这里面如果其中任何一个为 true，“reconciler” 将调用 “operationExecutor” 来执行操作“ ，走到这里代表了 Volume 没有被 attach，或者没有实现 attacher，例如 cephfs 没有实现 attacher；或者是 kubelet 禁用了 attach <sup><a href=#1>[1]</a></sup> （默认是开启状态），将进入 “ <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/util/operationexecutor/operation_executor.go#L909-L921 target=_blank rel="noopener nofollow noreferrer">VerifyControllerAttachedVolume</a> ”</p><ul><li><p>在此期间，“operationExecutor” 生成一个名为 “<a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/util/operationexecutor/operation_generator.go#L1278-L1352 target=_blank rel="noopener nofollow noreferrer">verifyControllerAttachedVolumeFunc</a>” 的函数来实际实现。在此函数中，如果 “volumeToMount” 的 “PluginIsAttachable” 为 <em>false</em>（没有实现），则假设其已经实现并标记 <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/util/operationexecutor/operation_generator.go#L1288C17-L1301 target=_blank rel="noopener nofollow noreferrer">attached</a>，标记出错时进行重试（这是一个函数用于后面的调用，这里只是定义）</p></li><li><p>如果还没有将 Node attached 到 Volume 节点列表状态中，则返回错误进行重试（这是一个函数用于后面的调用，这里只是定义）</p></li><li><p>上面两个步骤是为了组装这个操作，返回的是操作的内容，包含执行的函数，完成的hook等，最后运行这个函数并返回</p></li></ul></li><li><p>这是步骤3的另外一个分支，即 kubelet 启用了 ADController，并且实现了对应的 attcher，那么将执行附加操作</p><ul><li>拼接对象</li><li>执行函数 ”AttachVolume“</li><li>AttachVolume 如上面步骤一样，拼接出最后的执行的动作，进行执行操作（将 node 附加到 volume 之上）</li></ul></li><li><p><a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/util/operationexecutor/operation_executor.go#L798-L958 target=_blank rel="noopener nofollow noreferrer">步骤5</a> 表示 3, 4 条件均不满足，也就是 Attached，目前状态为 ”未挂载“ 或者 ”已挂载“，将执行这个步骤，未挂载的进行挂载，已挂载的进行 remount</p></li><li><p>在该分支中（也就是 <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/util/operationexecutor/operation_generator.go#L489-L694 target=_blank rel="noopener nofollow noreferrer">步骤5</a> 执行的）执行的是名为 “<a href=https://github.com/kubernetes/kubernetes/blob/v1.21.2/pkg/volume/util/operationexecutor/operation_generator.go#L500 target=_blank rel="noopener nofollow noreferrer">GenerateMountVolumeFunc</a>“ 的函数，在此函数中，会获取 Plugin ，并通过 Plugin 创建出一个 volumeMounter，在通过 Plugin 获取一个 deviceMouter（能够挂载块设备的）；当然我们这里挂载的是 ”cephfs“ 所以没有 ”deviceMouter“ 这里不被执行。</p><ul><li>如果 ”deviceMounter“ 定义了，那么则执行这个 plugin 的 &ldquo;MountDevice&rdquo; 函数</li><li>如果没有定义，那么执行 volumeMounter 的 SetUp 进行挂载（因为不是块设备）</li></ul></li><li><p>执行 SetUp 函数，通常 <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/nfs/nfs.go#L240-L242 target=_blank rel="noopener nofollow noreferrer">NFS</a>, <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/cephfs/cephfs.go#L223-L225 target=_blank rel="noopener nofollow noreferrer">CephFS</a>, <a href=https://github.com/kubernetes/kubernetes/blob/1f3e19b7beb1cc0110255668c4238ed63dadb7ad/pkg/volume/local/local.go#L472-L474 target=_blank rel="noopener nofollow noreferrer">HostPath</a>，都实现了这个函数，那么就会通过这个函数挂载到 Node 对应的目录</p></li><li><p>最后通过 Overlay2 文件系统附加到容器里</p></li></ol><h2 id=reference>Reference<a hidden class=anchor aria-hidden=true href=#reference>#</a></h2><p><sup id=1>[1]</sup> <a href=https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet/ target=_blank rel="noopener nofollow noreferrer"><em>command-line-tools-reference kubelet</em></a></p><p><sup id=2>[2]</sup> <a href=https://shuanglu1993.medium.com/what-happens-when-volumemanager-in-the-kubelet-starts-1fea623ac6ce target=_blank rel="noopener nofollow noreferrer"><em>What happens when volumeManager in the kubelet starts?</em></a></p></div><div class=pe-copyright><hr><blockquote><p>本文为原创内容，版权归作者所有。如需转载，请在文章中声明本文标题及链接。</p><p>文章标题：深入理解kubelet - VolumeManager源码解析</p><p>文章链接：<a href=http://localhost:1313/2023/08/ch29-volumemanager/ target=_blank>http://localhost:1313/2023/08/ch29-volumemanager/</a></p><p>许可协议：<a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></p></blockquote></div><div class=comments-separator></div><h3 class=relatedContentTitle>相关阅读</h3><ul class=relatedContent><li><a href=/2023/02/ch23-extend-kube-proxy/><span>深入理解Kubernetes service - 如何扩展现有的kube-proxy架构？</span></a></li><li><a href=/2022/08/ch22-custom-scheduler/><span>基于Prometheus的Kubernetes网络调度器</span></a></li><li><a href=/2022/07/ch21-scheduling-algorithm/><span>如何理解kubernetes调度框架与插件？</span></a></li><li><a href=/2022/07/ch20-schedule-workflow/><span>kube-scheduler的调度上下文</span></a></li><li><a href=/2022/07/ch16-scheduler/><span>kubernetes的决策组件 - kube-scheduler原理分析</span></a></li></ul><div class=comments-separator></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/kubernetes-develop/>Kubernetes Develop</a></li><li><a href=http://localhost:1313/tags/kubernetes/>Kubernetes</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/2023/09/6-1-ceph-rebalance/><span class=title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left" style="user-select:text"><line x1="19" y1="12" x2="5" y2="12" style="user-select:text"/><polyline points="12 19 5 12 12 5" style="user-select:text"/></polyline></svg>&nbsp;</span>
<span>Ceph重新平衡 - Rebalance</span>
</a><a class=next href=http://localhost:1313/2023/08/kubernetes-node-label-dashboard/><span class=title></span>
<span>记录kubernetes node label的面板实施&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right" style="user-select:text"><line x1="5" y1="12" x2="19" y2="12" style="user-select:text"/><polyline points="12 5 19 12 12 19" style="user-select:text"/></svg></span></a></nav></footer><div class=pe-comments-decoration><p class=pe-comments-title></p><p class=pe-comments-subtitle></p></div><div id=pe-comments></div><script src=/js/pe-go-comment.min.86a214102576ba5f9b7bdc29eed8d58dd56e34aef80b3c65c73ea9cc88443696.js integrity="sha256-hqIUECV2ul+be9wp7tjVjdVuNK74Czxlxz6pzIhENpY="></script><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="dark"?"dark":"light",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"cylonchau/cylonchau.github.io","data-repo-id":"R_kgDOIRlNSQ","data-category":"Announcements","data-category-id":"DIC_kwDOIRlNSc4CXy1U","data-mapping":"pathname","data-term":"posts/ch29 VolumeManager","data-strict":"0","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"top","data-theme":getStoredTheme(),"data-lang":"zh-TW","data-loading":"lazy",crossorigin:"anonymous",async:""},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#pe-comments").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Cylon's Collection</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> on
<a href=https://pages.github.com/ rel=noopener target=_blank>GitHub Pages</a> & Theme
        <a href=https://github.com/tofuwine/PaperMod-PE rel=noopener target=_blank>PaperMod-PE</a></span></footer><div class=pe-right-sidebar><a href=javascript:void(0); id=theme-toggle-float class=pe-float-btn><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</a><a href=#top class=pe-float-btn id=top-link><span id=pe-read-progress></span></a></div><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>